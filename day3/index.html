<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://pojeda.github.io/course-mlmd/day3/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Graph Neural Networks - ML/MD course</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_markdown_exec_pyodide.css" rel="stylesheet" />
        <link href="../assets/_markdown_exec_ansi.css" rel="stylesheet" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Graph Neural Networks";
        var mkdocs_page_input_path = "day3.md";
        var mkdocs_page_url = "/course-mlmd/day3/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../images/hpc2n-qmmm.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../day0/">Introduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 1</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../day1/">ML for Molecular Systems</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 2</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../day2/">Neural Networks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 3</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Graph Neural Networks</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#topics__covered">Topics Covered</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1__message__passing__neural__networks">1. Message Passing Neural Networks</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#core__concepts">Core Concepts</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#key__variants">Key Variants</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#applications__in__chemistry">Applications in Chemistry</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#limitations__and__challenges">Limitations and Challenges</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2__graph__attention__networks">2. Graph Attention Networks</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#motivation__and__intuition">Motivation and Intuition</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#attention__mechanism">Attention Mechanism</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#multi-head__attention">Multi-Head Attention</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#advantages__of__gats">Advantages of GATs</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#gat__variants__and__extensions">GAT Variants and Extensions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#practical__tips__for__using__gats">Practical Tips for Using GATs</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3__equivariant__networks__for__3d__structures">3. Equivariant Networks for 3D Structures</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#motivation__why__geometry__matters">Motivation: Why Geometry Matters</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#understanding__symmetries">Understanding Symmetries</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#schnet__continuous-filter__convolutional__neural__network">SchNet (Continuous-filter Convolutional Neural Network)</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#dimenet__directional__message__passing__neural__network">DimeNet (Directional Message Passing Neural Network)</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#painn__polarizable__atom__interaction__neural__network">PaiNN (Polarizable Atom Interaction Neural Network)</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#comparison__of__approaches">Comparison of Approaches</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4__protein-ligand__interaction__modeling">4. Protein-Ligand Interaction Modeling</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#the__drug__discovery__challenge">The Drug Discovery Challenge</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#problem__formulation">Problem Formulation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#representation__strategies">Representation Strategies</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#architecture__patterns">Architecture Patterns</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#key__considerations">Key Considerations</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#state-of-the-art__models">State-of-the-Art Models</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#practical__workflow">Practical Workflow</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#future__directions">Future Directions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#5__crystal__structures__for__materials__science">5. Crystal Structures for Materials Science</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#understanding__crystalline__materials">Understanding Crystalline Materials</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#crystal__representation">Crystal Representation</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#periodic__boundary__conditions">Periodic Boundary Conditions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#property__prediction__tasks">Property Prediction Tasks</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#specialized__architectures">Specialized Architectures</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#handling__periodicity__technical__details">Handling Periodicity: Technical Details</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#applications">Applications</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#challenges__and__future__directions">Challenges and Future Directions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#6__practical__building__a__gat__for__qm9__dataset">6. Practical: Building a GAT for QM9 Dataset</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#dataset__overview">Dataset Overview</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#implementation__steps">Implementation Steps</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#expected__results">Expected Results</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#extension__ideas">Extension Ideas</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#additional__resources">Additional Resources</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 4</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../day4/">Generative Models</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 5</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../day5/">Advanced Models</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../summary.md">Summary</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">ML/MD course</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Day 3</li>
      <li class="breadcrumb-item active">Graph Neural Networks</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="day__3__graph__neural__networks__and__geometric__deep__learning">Day 3: Graph Neural Networks and Geometric Deep Learning<a class="headerlink" href="#day__3__graph__neural__networks__and__geometric__deep__learning" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>Day 3 focuses on Graph Neural Networks (GNNs) and their applications in molecular and materials science. We&rsquo;ll explore how graphs can represent molecular structures and how specialized neural network architectures can learn from these representations while respecting physical symmetries and constraints.</p>
<h2 id="topics__covered">Topics Covered<a class="headerlink" href="#topics__covered" title="Permanent link">&para;</a></h2>
<h3 id="1__message__passing__neural__networks">1. Message Passing Neural Networks<a class="headerlink" href="#1__message__passing__neural__networks" title="Permanent link">&para;</a></h3>
<p>Message Passing Neural Networks (MPNNs) form the foundation of modern graph neural networks for molecular property prediction. They provide a unified framework for understanding how information flows through graph-structured data, making them particularly well-suited for molecular modeling where atoms and bonds naturally form graph structures.</p>
<h4 id="core__concepts">Core Concepts<a class="headerlink" href="#core__concepts" title="Permanent link">&para;</a></h4>
<p><strong>Graph Representation:</strong></p>
<p>In molecular graphs, the structure naturally maps to graph representations:
- <strong>Nodes</strong> represent atoms with rich feature vectors including:
  - Atomic number (element identity)
  - Formal charge and partial charge
  - Hybridization state (sp, sp2, sp3)
  - Number of hydrogen atoms
  - Aromaticity
  - Chirality
  - Atomic mass
  - Degree (number of connections)</p>
<ul>
<li><strong>Edges</strong> represent bonds with attributes such as:</li>
<li>Bond type (single, double, triple, aromatic)</li>
<li>Bond length/distance</li>
<li>Stereochemistry (cis/trans, E/Z)</li>
<li>Conjugation</li>
<li>
<p>Ring membership</p>
</li>
<li>
<p>The <strong>graph structure</strong> encodes molecular connectivity, preserving the topological relationships that determine chemical properties</p>
</li>
</ul>
<p><strong>Why Message Passing?</strong></p>
<p>The key insight behind MPNNs is that the properties of an atom in a molecule depend not just on the atom itself, but on its chemical environment. Message passing mimics how chemical effects propagate through molecular structures:
- Inductive effects travel through sigma bonds
- Resonance effects propagate through conjugated systems
- Steric effects depend on spatial arrangements of neighboring groups</p>
<p><strong>Message Passing Framework:</strong></p>
<p>The MPNN framework consists of three main phases that iterate to build increasingly sophisticated representations:</p>
<ol>
<li><strong>Message Phase</strong> (T iterations):
   <div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>m_v^(t+1) = Σ_{u∈N(v)} M_t(h_v^t, h_u^t, e_{uv})
</span></code></pre></div></li>
</ol>
<p>In this phase:
   - Each node v receives messages from its neighbors N(v)
   - The message function M_t is a learnable neural network that combines:
     - h_v^t: the current node&rsquo;s hidden state
     - h_u^t: each neighbor&rsquo;s hidden state
     - e_{uv}: edge features connecting the nodes
   - Messages are computed for all edges simultaneously
   - The superscript t indicates the iteration number</p>
<p><strong>Intuition</strong>: Think of this as each atom &ldquo;listening&rdquo; to what its bonded neighbors are telling it about their local chemical environment.</p>
<ol>
<li><strong>Update Phase</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>h_v^(t+1) = U_t(h_v^t, m_v^(t+1))
</span></code></pre></div></li>
</ol>
<p>In this phase:
   - Each node updates its representation using the aggregated messages
   - U_t is typically a GRU, LSTM, or feedforward network
   - The update combines the node&rsquo;s previous state with new information
   - This preserves information from earlier iterations while incorporating new context</p>
<p><strong>Intuition</strong>: After listening to neighbors, each atom updates its own representation to reflect what it learned about its environment.</p>
<ol>
<li><strong>Aggregation Within Messages</strong>:</li>
</ol>
<p>The summation in the message phase is just one choice. Other aggregation functions include:
   - <strong>Sum</strong>: <code>Σ_{u∈N(v)} M_t(...)</code>  - sensitive to neighborhood size
   - <strong>Mean</strong>: <code>(1/|N(v)|) Σ_{u∈N(v)} M_t(...)</code> - normalizes by degree
   - <strong>Max</strong>: <code>max_{u∈N(v)} M_t(...)</code> - captures strongest signal
   - <strong>Attention</strong>: <code>Σ_{u∈N(v)} α_{vu} M_t(...)</code> - learnable weights (GAT)</p>
<p><strong>Readout Phase:</strong></p>
<p>After T message passing steps, we have node-level representations h_v^T for each atom. To predict molecular properties, we need a graph-level representation:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>y = R({h_v^T | v ∈ G})
</span></code></pre></div>
<p>Common readout functions include:</p>
<ul>
<li><strong>Sum pooling</strong>: <code>R = Σ_v h_v^T</code></li>
<li>Captures total contributions from all atoms</li>
<li>Sensitive to molecule size</li>
<li>
<p>Good for extensive properties (like mass, number of electrons)</p>
</li>
<li>
<p><strong>Mean pooling</strong>: <code>R = (1/|V|) Σ_v h_v^T</code></p>
</li>
<li>Normalizes by number of atoms</li>
<li>Better for intensive properties (like density, stability per atom)</li>
<li>
<p>Size-invariant representation</p>
</li>
<li>
<p><strong>Max pooling</strong>: <code>R = max_v h_v^T</code> (element-wise)</p>
</li>
<li>Captures most significant features</li>
<li>
<p>Can miss important distributed information</p>
</li>
<li>
<p><strong>Set2Set</strong>: A learnable attention-based aggregation</p>
</li>
<li>Uses LSTM to iteratively attend to nodes</li>
<li>More expressive but computationally expensive</li>
<li>Can capture complex relationships between atoms</li>
</ul>
<p><strong>Depth and Receptive Fields:</strong></p>
<p>The number of message passing iterations T determines the receptive field:
- T=1: Each node sees only immediate neighbors (1-hop)
- T=2: Each node sees neighbors and neighbors-of-neighbors (2-hop)
- T=k: Each node sees all nodes within k bonds</p>
<p>For molecular graphs:
- Small molecules (QM9): T=3-5 is usually sufficient
- Proteins: T=5-10 may be needed for long-range interactions
- Trade-off: More iterations = larger receptive field but risk of over-smoothing</p>
<h4 id="key__variants">Key Variants<a class="headerlink" href="#key__variants" title="Permanent link">&para;</a></h4>
<p><strong>Graph Convolutional Networks (GCN):</strong></p>
<p>GCNs simplify message passing using a spectral approach:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>H^(t+1) = σ(D^(-1/2) Ã D^(-1/2) H^(t) W^(t))
</span></code></pre></div>
<p>Where:
- Ã = A + I (adjacency matrix with self-loops)
- D is the degree matrix
- This is equivalent to message passing with normalized averaging
- Very efficient for semi-supervised learning on large graphs
- Less flexible for edge features than general MPNNs</p>
<p><strong>Benefits for chemistry:</strong>
- Fast computation on molecular graphs
- Symmetric normalization prevents exploding/vanishing gradients
- Can be stacked deeply with residual connections</p>
<p><strong>Limitations:</strong>
- Doesn&rsquo;t naturally incorporate edge features
- Fixed aggregation (normalized sum)
- May struggle with distinguishing certain graph structures (limited expressivity)</p>
<p><strong>GraphSAGE (Sample and Aggregate):</strong></p>
<p>GraphSAGE introduces sampling for scalability:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>h_v^(t+1) = σ(W · CONCAT(h_v^t, AGG({h_u^t | u ∈ Sample(N(v))})))
</span></code></pre></div>
<p>Key innovations:
- <strong>Sampling</strong>: Instead of aggregating from all neighbors, sample a fixed number
- <strong>Multiple aggregators</strong>:
  - Mean: <code>AGG = (1/|S|) Σ_{u∈S} h_u</code>
  - LSTM: Process neighbors sequentially (requires ordering)
  - Pooling: <code>AGG = max(σ(W_pool h_u + b))</code>
- <strong>Concatenation</strong>: Explicitly preserves self-information</p>
<p><strong>Benefits for chemistry:</strong>
- Handles variable-sized neighborhoods efficiently
- Inductive learning: can generalize to new molecules not seen during training
- Scalable to very large molecular databases</p>
<p><strong>Neural Message Passing for Quantum Chemistry (MPNN):</strong></p>
<p>The original MPNN paper specialized the framework for molecules:</p>
<p><strong>Architecture:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>m_v^(t+1) = Σ_{u∈N(v)} M_t(h_v^t, h_u^t, e_{uv})
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>           = Σ_{u∈N(v)} A_t(e_{uv}) · h_u^t
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>h_v^(t+1) = U_t(h_v^t, m_v^(t+1))
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>           = GRU(h_v^t, m_v^(t+1))
</span></code></pre></div></p>
<p>Key design choices:
- <strong>Edge networks</strong>: A_t(e_{uv}) is a neural network that produces edge-specific matrices
  - Allows different bond types to transform neighbor information differently
  - Captures the idea that single/double/triple bonds transmit information differently</p>
<ul>
<li><strong>GRU updates</strong>: Using Gated Recurrent Units for the update function</li>
<li>Helps with gradient flow through multiple message passing steps</li>
<li>Gates control what information to keep vs. update</li>
<li>
<p>More stable than simple MLPs for deep message passing</p>
</li>
<li>
<p><strong>Virtual edges</strong>: Can add edges between non-bonded atoms within a distance cutoff</p>
</li>
<li>Captures through-space interactions</li>
<li>Important for conformational effects and weak interactions</li>
</ul>
<p><strong>Master equations:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a># Initialize
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>h_v^0 = embedding(x_v)  # x_v are input features
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a># Message passing
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>for t in range(T):
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    for each edge (v,u):
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        m_vu = EdgeNetwork(e_vu) @ h_u^t
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    m_v = Σ_u m_vu
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    h_v^(t+1) = GRU(h_v^t, m_v)
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a># Readout
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>h_G = Set2Set({h_v^T | v ∈ G})
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>y = MLP(h_G)
</span></code></pre></div></p>
<p><strong>Training considerations:</strong>
- Typically T=3-6 message passing steps
- Hidden dimensions: 64-256 depending on task complexity
- Batch normalization or layer normalization helps training stability
- Dropout between layers prevents overfitting</p>
<h4 id="applications__in__chemistry">Applications in Chemistry<a class="headerlink" href="#applications__in__chemistry" title="Permanent link">&para;</a></h4>
<p><strong>Molecular Property Prediction:</strong></p>
<p>MPNNs excel at predicting quantum mechanical and physical properties:</p>
<ol>
<li><strong>Quantum properties</strong> (QM9 dataset):</li>
<li>HOMO/LUMO energies (frontier orbitals)</li>
<li>Internal energy and enthalpy</li>
<li>Free energy and heat capacity</li>
<li>Electronic spatial extent</li>
<li>Zero-point vibrational energy</li>
<li>Atomization energy</li>
</ol>
<p><strong>Why MPNNs work</strong>: These properties depend on electronic structure, which is determined by how atoms and bonds are connected. Message passing naturally captures these structural effects.</p>
<ol>
<li><strong>Physical properties</strong>:</li>
<li>Solubility (important for drug absorption)</li>
<li>Melting/boiling points</li>
<li>Density and refractive index</li>
<li>Viscosity</li>
</ol>
<p><strong>Challenge</strong>: These properties can depend on 3D conformations, so incorporating geometry helps.</p>
<ol>
<li><strong>Biological activity</strong>:</li>
<li>Toxicity predictions (hERG, Ames, hepatotoxicity)</li>
<li>Binding affinity to target proteins</li>
<li>ADMET properties (Absorption, Distribution, Metabolism, Excretion, Toxicity)</li>
<li>Blood-brain barrier penetration</li>
</ol>
<p><strong>Application</strong>: Early-stage drug filtering, reducing costly experimental screening.</p>
<p><strong>Reaction Outcome Prediction:</strong></p>
<p>Given reactants and conditions, predict the major products:
- Graph of reactants → MPNN → Product distribution
- Can incorporate reaction conditions (temperature, solvent, catalysts) as global features
- Attention mechanisms can identify reactive sites</p>
<p><strong>Retrosynthesis Planning:</strong></p>
<p>Predict how to synthesize a target molecule:
- Target molecule → MPNN → Likely precursors
- Can be formulated as a translation problem (product graph → reactant graphs)
- Helps chemists find synthetic routes for complex molecules</p>
<p><strong>Drug Discovery and Virtual Screening:</strong></p>
<p>Screen millions of compounds against target proteins:
- Fast prediction once model is trained (~1000 molecules/second)
- Can be combined with active learning to guide experimental efforts
- Multi-task learning: predict multiple properties simultaneously
- Transfer learning: pre-train on large databases, fine-tune on specific targets</p>
<p><strong>De Novo Molecular Design:</strong></p>
<ul>
<li>Use MPNNs as discriminators or reward functions in generative models</li>
<li>Guide molecular generation toward desired properties</li>
<li>Combine with optimization algorithms (genetic algorithms, reinforcement learning)</li>
</ul>
<h4 id="limitations__and__challenges">Limitations and Challenges<a class="headerlink" href="#limitations__and__challenges" title="Permanent link">&para;</a></h4>
<p><strong>Over-smoothing</strong>: With many message passing steps, node representations become too similar
- <strong>Solution</strong>: Residual connections, jumping knowledge networks</p>
<p><strong>Limited expressivity</strong>: Some graphs are indistinguishable by message passing
- <strong>Solution</strong>: Add higher-order structural features, use more sophisticated aggregation</p>
<p><strong>Scalability</strong>: Large molecules or protein graphs can be computationally expensive
- <strong>Solution</strong>: Sampling (GraphSAGE), hierarchical approaches, graph coarsening</p>
<p><strong>3D structure</strong>: Basic MPNNs ignore 3D geometry
- <strong>Solution</strong>: Add distance as edge features, use equivariant networks (next sections)</p>
<hr />
<h3 id="2__graph__attention__networks">2. Graph Attention Networks<a class="headerlink" href="#2__graph__attention__networks" title="Permanent link">&para;</a></h3>
<p>Graph Attention Networks (GATs) introduce attention mechanisms to graph learning, allowing the model to learn which neighbors are most important for each node. This is a significant advancement over basic message passing, where all neighbors contribute equally to a node&rsquo;s update.</p>
<h4 id="motivation__and__intuition">Motivation and Intuition<a class="headerlink" href="#motivation__and__intuition" title="Permanent link">&para;</a></h4>
<p><strong>Why Attention for Graphs?</strong></p>
<p>In molecular contexts, not all bonds are equally important for determining a property:
- In a large molecule, a specific functional group might dominate reactivity
- Some atoms are in the &ldquo;core&rdquo; structure while others are in peripheral substituents
- Certain bonds participate in conjugation or resonance, making them more significant
- In protein-ligand binding, only residues near the binding site matter</p>
<p><strong>Analogy to NLP</strong>: Just as in language, where &ldquo;bank&rdquo; means different things in &ldquo;river bank&rdquo; vs &ldquo;savings bank&rdquo; depending on context, an atom&rsquo;s role depends on which neighbors are most relevant.</p>
<p>GATs allow the network to automatically learn these context-dependent importance weights.</p>
<h4 id="attention__mechanism">Attention Mechanism<a class="headerlink" href="#attention__mechanism" title="Permanent link">&para;</a></h4>
<p><strong>Core Idea:</strong></p>
<p>Unlike MPNNs that use fixed aggregation (sum, mean) or hand-crafted edge weights, GATs learn attention coefficients α_{ij} that adaptively weigh the importance of each neighbor j for node i.</p>
<p><strong>Mathematical Framework:</strong></p>
<p>The attention mechanism consists of three steps:</p>
<p><strong>Step 1: Compute Attention Logits</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>e_{ij} = LeakyReLU(a^T [W h_i || W h_j])
</span></code></pre></div></p>
<p>Breaking this down:
- <strong>W h_i</strong> and <strong>W h_j</strong>: First, transform node features through a shared weight matrix W
  - This projects features into a common space where comparisons are meaningful
  - Dimension: [d_in] → [d_out]</p>
<ul>
<li><strong>[W h_i || W h_j]</strong>: Concatenate transformed features of node i and neighbor j</li>
<li>Creates a pairwise feature vector</li>
<li>
<p>Dimension: [2 × d_out]</p>
</li>
<li>
<p><strong>a^T [&hellip;]</strong>: Apply learned attention vector a</p>
</li>
<li>Reduces to scalar attention logit e_{ij}</li>
<li>The attention vector a learns what feature combinations indicate importance</li>
<li>
<p>Dimension: [2 × d_out] → [1]</p>
</li>
<li>
<p><strong>LeakyReLU</strong>: Non-linearity with slope α for negative values (typically α=0.2)</p>
</li>
<li>Allows negative attention scores (before softmax)</li>
<li>Prevents dead neurons from ReLU saturation</li>
</ul>
<p><strong>Intuition</strong>: The attention logit e_{ij} measures how relevant neighbor j is to node i, based on their feature compatibility.</p>
<p><strong>Step 2: Normalize to Attention Coefficients</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>α_{ij} = softmax_j(e_{ij}) = exp(e_{ij}) / Σ_{k∈N(i)} exp(e_{ik})
</span></code></pre></div></p>
<ul>
<li><strong>Softmax normalization</strong>: Ensures attention weights sum to 1 over all neighbors</li>
<li><strong>Comparison</strong>: Only neighbors compete for attention (not all nodes in graph)</li>
<li><strong>Interpretation</strong>: α_{ij} ∈ (0, 1) represents the probability-like importance of neighbor j</li>
</ul>
<p><strong>Why softmax?</strong>
- Preserves differentiability (can backpropagate)
- Creates sharp distinctions (high e_{ij} → high α_{ij})
- Normalized weights prevent exploding values in aggregation</p>
<p><strong>Step 3: Aggregate with Attention Weights</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>h_i&#39; = σ(Σ_{j∈N(i)} α_{ij} W h_j)
</span></code></pre></div></p>
<ul>
<li><strong>Weighted sum</strong>: Each neighbor contributes proportionally to its attention weight</li>
<li><strong>W h_j</strong>: Uses the same transformation from step 1 (parameter sharing)</li>
<li><strong>σ</strong>: Activation function (typically ELU or ReLU)</li>
</ul>
<p><strong>Complete Forward Pass Example:</strong></p>
<p>For an atom with 3 neighbors:
1. Compute logits: e_{i1} = 0.8, e_{i2} = 0.3, e_{i3} = -0.2
2. Apply softmax: α_{i1} = 0.52, α_{i2} = 0.31, α_{i3} = 0.17
3. Aggregate: h_i&rsquo; = σ(0.52 × W h_1 + 0.31 × W h_2 + 0.17 × W h_3)</p>
<p><strong>Key Properties:</strong></p>
<ul>
<li><strong>Self-attention</strong>: Can include self-loops (i,i) so nodes attend to themselves</li>
<li><strong>Asymmetric</strong>: α_{ij} ≠ α_{ji} (attention from i→j differs from j→i)</li>
<li><strong>Local</strong>: Only attends to direct neighbors (preserves graph structure)</li>
<li><strong>Permutation invariant</strong>: Order of neighbors doesn&rsquo;t matter</li>
</ul>
<h4 id="multi-head__attention">Multi-Head Attention<a class="headerlink" href="#multi-head__attention" title="Permanent link">&para;</a></h4>
<p>To stabilize learning and capture different types of relationships simultaneously, GATs employ multiple independent attention mechanisms (heads).</p>
<p><strong>Multi-Head Aggregation (Hidden Layers):</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>h_i&#39; = ||_{k=1}^K σ(Σ_{j∈N(i)} α_{ij}^k W^k h_j)
</span></code></pre></div></p>
<p>Where:
- K = number of attention heads
- Each head k has its own parameters: W^k and a^k
- || denotes concatenation of head outputs
- Output dimension: K × d_out</p>
<p><strong>Why Multiple Heads?</strong></p>
<p>Different heads can learn complementary attention patterns:
- <strong>Head 1</strong>: Might focus on electronegative atoms (for polarity)
- <strong>Head 2</strong>: Might focus on aromatic neighbors (for conjugation)
- <strong>Head 3</strong>: Might focus on steric bulk (for size effects)
- <strong>Head 4</strong>: Might attend to formal charges</p>
<p><strong>Intuition from Chemistry</strong>: Just as a chemist considers multiple factors simultaneously (electronics, sterics, orbital interactions), multiple heads capture different aspects of molecular structure.</p>
<p><strong>Multi-Head Averaging (Output Layer):</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>h_i&#39; = σ((1/K) Σ_{k=1}^K Σ_{j∈N(i)} α_{ij}^k W^k h_j)
</span></code></pre></div></p>
<p>For the final layer, averaging instead of concatenation:
- Keeps output dimension consistent with target
- Ensembles the predictions from different heads
- More stable for final predictions</p>
<p><strong>Implementation Considerations:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Typical hyperparameters</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">num_heads</span> <span class="o">=</span> <span class="mi">4</span><span class="o">-</span><span class="mi">8</span>  <span class="c1"># More heads = more capacity but more parameters</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">hidden_dim</span> <span class="o">=</span> <span class="mi">64</span><span class="o">-</span><span class="mi">256</span>  <span class="c1"># Per-head dimension</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">-</span><span class="mf">0.3</span>  <span class="c1"># On attention coefficients (attention dropout)</span>
</span></code></pre></div>
<p><strong>Computational Complexity:</strong>
- Attention computation: O(|E| × d_out) - linear in edges
- Memory for attention: O(|E| × K) - stores attention per head
- Highly parallelizable (all attention coefficients computed independently)</p>
<h4 id="advantages__of__gats">Advantages of GATs<a class="headerlink" href="#advantages__of__gats" title="Permanent link">&para;</a></h4>
<p><strong>1. Adaptive Neighborhoods</strong></p>
<p>Unlike fixed aggregation:
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a># Fixed (GCN-style)
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>h_i&#39; = Σ_{j∈N(i)} (1/√(d_i × d_j)) W h_j  # predetermined weights
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a># Adaptive (GAT)
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>h_i&#39; = Σ_{j∈N(i)} α_{ij} W h_j  # learned weights
</span></code></pre></div></p>
<p><strong>Benefits:</strong>
- Automatically focuses on relevant neighbors
- Can ignore uninformative connections
- Adapts to different chemical contexts</p>
<p><strong>Example</strong>: In a drug molecule, GAT can learn to focus on:
- Pharmacophore groups (active parts)
- Hydrogen bond donors/acceptors
- Hydrophobic regions
While downweighting inert carbon chains.</p>
<p><strong>2. Interpretability</strong></p>
<p>Attention weights α_{ij} can be visualized and interpreted:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Extract attention weights</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">attention_weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_attention</span><span class="p">()</span>  <span class="c1"># shape: [num_edges, num_heads]</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># Visualize for a molecule</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="n">mol_graph</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">to_graph</span><span class="p">()</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="n">highlight_edges_by_weight</span><span class="p">(</span><span class="n">mol_graph</span><span class="p">,</span> <span class="n">attention_weights</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>What we can learn:</strong>
- Which atoms influence predictions most
- How information flows through the molecule
- Whether the model learned chemically meaningful patterns
- Debugging: Are attention patterns reasonable?</p>
<p><strong>Example insights:</strong>
- High attention on C=O bonds for carbonyl chemistry
- Focus on aromatic rings for π-stacking predictions
- Attention following conjugation pathways</p>
<p><strong>3. Parallelizability</strong></p>
<p>All attention coefficients for all edges can be computed in parallel:
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Pseudo-code</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">edge_features</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">edges</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">h</span><span class="p">[</span><span class="n">edges</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span>  <span class="c1"># All edges at once</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">attention_logits</span> <span class="o">=</span> <span class="n">attention_network</span><span class="p">(</span><span class="n">edge_features</span><span class="p">)</span>  <span class="c1"># Parallel</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">attention_weights</span> <span class="o">=</span> <span class="n">softmax_per_node</span><span class="p">(</span><span class="n">attention_logits</span><span class="p">)</span>  <span class="c1"># Parallel within neighbors</span>
</span></code></pre></div></p>
<p><strong>Speed advantages:</strong>
- GPU-friendly (matrix operations)
- Scales well to large molecules
- No sequential dependencies (unlike RNNs)</p>
<p><strong>4. Inductive Learning</strong></p>
<p>GATs can generalize to completely new graph structures:
- Train on small molecules, test on large ones
- Learn patterns that transfer across different molecular classes
- No fixed graph structure required during training</p>
<p>This is critical for:
- Generalizing to novel drug candidates
- Transfer learning across datasets
- Handling molecules with varying sizes</p>
<h4 id="gat__variants__and__extensions">GAT Variants and Extensions<a class="headerlink" href="#gat__variants__and__extensions" title="Permanent link">&para;</a></h4>
<p><strong>GATv2: More Expressive Attention</strong></p>
<p>Original GAT limitation: Attention is somewhat static
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a># GAT: Transform then attend
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>e_{ij} = a^T [W h_i || W h_j]  # a can only linearly combine features
</span></code></pre></div></p>
<p>GATv2 improvement: Dynamic attention
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a># GATv2: Attend then transform
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>e_{ij} = a^T LeakyReLU(W [h_i || h_j])  # Non-linearity before attention
</span></code></pre></div></p>
<p><strong>Why it&rsquo;s better:</strong>
- The non-linearity is applied AFTER concatenation
- Allows more complex attention functions
- Empirically: 10-30% better performance on many benchmarks
- Fixes theoretical expressivity limitations of original GAT</p>
<p><strong>When to use GATv2:</strong>
- Complex molecules with subtle structural differences
- When original GAT plateaus in performance
- Tasks requiring fine-grained attention distinctions</p>
<p><strong>Molecular GAT: Edge Features</strong></p>
<p>Challenge: Chemical bonds have important attributes (single/double/triple, stereochemistry) that basic GAT ignores.</p>
<p><strong>Solution</strong>: Incorporate edge features into attention</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>e_{ij} = a^T [W h_i || W h_j || E e_{ij}]
</span></code></pre></div>
<p>Where:
- e_{ij} = edge feature vector (bond type, distance, ring membership)
- E = edge embedding matrix
- Now attention depends on both node features AND edge features</p>
<p><strong>Applications:</strong>
- Distinguishing single vs double bonds
- Incorporating 3D distances
- Using bond order information
- Representing stereochemistry</p>
<p><strong>Example</strong>: In conjugated systems, π-bonds should have higher attention than σ-bonds:
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a># Single bond: e_{ij} = [1,0,0] → lower attention
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a># Double bond: e_{ij} = [0,1,0] → higher attention (for delocalization)
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a># Triple bond: e_{ij} = [0,0,1] → highest attention
</span></code></pre></div></p>
<p><strong>Graph Transformer Networks:</strong></p>
<p>Extension to full graph attention (not just neighbors):
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>α_{ij} for all pairs (i,j) in graph  # Not just edges
</span></code></pre></div></p>
<p><strong>Trade-offs:</strong>
- <strong>Pro</strong>: Can capture long-range interactions
- <strong>Pro</strong>: More flexible attention patterns
- <strong>Con</strong>: O(|V|²) complexity (vs O(|E|) for GAT)
- <strong>Con</strong>: May lose graph structural bias</p>
<p><strong>Use when:</strong> Long-range interactions matter (large molecules, proteins)</p>
<h4 id="practical__tips__for__using__gats">Practical Tips for Using GATs<a class="headerlink" href="#practical__tips__for__using__gats" title="Permanent link">&para;</a></h4>
<p><strong>Hyperparameter Selection:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># Good starting points</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span><span class="o">-</span><span class="mi">5</span>  <span class="c1"># Deeper than this risks over-smoothing</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">num_heads</span> <span class="o">=</span> <span class="mi">4</span><span class="o">-</span><span class="mi">8</span>  <span class="c1"># More heads for complex tasks</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">hidden_dim</span> <span class="o">=</span> <span class="mi">64</span><span class="o">-</span><span class="mi">128</span> <span class="n">per</span> <span class="n">head</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">-</span><span class="mf">0.3</span>  <span class="c1"># Higher dropout for small datasets</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># Adam optimizer</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="c1"># For QM9 dataset</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>    <span class="s1">&#39;num_layers&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>    <span class="s1">&#39;num_heads&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>    <span class="s1">&#39;hidden_dim&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="s1">&#39;dropout&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="s1">&#39;attention_dropout&#39;</span><span class="p">:</span> <span class="mf">0.1</span>  <span class="c1"># Separate dropout on attention weights</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Common Pitfalls:</strong></p>
<ol>
<li><strong>Forgetting self-loops</strong>: Add explicit (i,i) edges or include h_i in aggregation</li>
<li><strong>Over-smoothing</strong>: Too many layers → all nodes become similar</li>
<li><strong>Attention collapse</strong>: All attention goes to one neighbor (use attention dropout)</li>
<li><strong>Memory issues</strong>: K heads × L layers can use lots of GPU memory</li>
</ol>
<p><strong>Best Practices:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># 1. Add residual connections</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">h_i</span><span class="s1">&#39; = h_i + GAT(h_i)  # Prevents over-smoothing</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="c1"># 2. Use layer normalization</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="n">h_i</span><span class="s1">&#39; = LayerNorm(h_i + GAT(h_i))  # Stabilizes training</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="c1"># 3. Attention dropout</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="n">α_</span><span class="p">{</span><span class="n">ij</span><span class="p">}</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="n">softmax</span><span class="p">(</span><span class="n">e_</span><span class="p">{</span><span class="n">ij</span><span class="p">}))</span>  <span class="c1"># Regularizes attention</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="c1"># 4. Edge features when available</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="n">e_</span><span class="p">{</span><span class="n">ij</span><span class="p">}</span> <span class="o">=</span> <span class="p">[</span><span class="n">bond_type</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">ring_membership</span><span class="p">]</span>  <span class="c1"># Richer edges</span>
</span></code></pre></div>
<p><strong>Visualization Strategies:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># 1. Attention heatmaps</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">plot_attention_matrix</span><span class="p">(</span><span class="n">attention_weights</span><span class="p">,</span> <span class="n">molecule</span><span class="p">)</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="c1"># 2. Highlight important edges</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="n">highlight_edges_above_threshold</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">attention_weights</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="c1"># 3. Track attention across layers</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    <span class="n">visualize_attention_distribution</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">attention</span><span class="p">)</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="c1"># 4. Compare heads</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_heads</span><span class="p">):</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="n">visualize_attention_head</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">attention_weights</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="3__equivariant__networks__for__3d__structures">3. Equivariant Networks for 3D Structures<a class="headerlink" href="#3__equivariant__networks__for__3d__structures" title="Permanent link">&para;</a></h3>
<p>Geometric deep learning architectures respect the symmetries and geometric properties of 3D molecular structures, making them particularly powerful for computational chemistry and materials science. These networks go beyond simple graph connectivity to leverage the full 3D geometry of molecules.</p>
<h4 id="motivation__why__geometry__matters">Motivation: Why Geometry Matters<a class="headerlink" href="#motivation__why__geometry__matters" title="Permanent link">&para;</a></h4>
<p><strong>The 3D Problem:</strong></p>
<p>Traditional GNNs treat molecular graphs as topological structures, ignoring spatial arrangements:
- Two molecules with the same connectivity but different 3D shapes (stereoisomers) would be treated identically
- Bond angles and dihedral angles contain crucial information
- 3D distance-based interactions (van der Waals, electrostatics) are not captured
- Forces and other vector properties require 3D information</p>
<p><strong>Example</strong>: Consider two stereoisomers:
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>cis-2-butene:  H₃C-CH=CH-CH₃ (groups on same side)
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>trans-2-butene: H₃C-CH=CH-CH₃ (groups on opposite sides)
</span></code></pre></div>
These have:
- Identical graph connectivity
- Different 3D structures
- Different physical properties (melting point, boiling point, reactivity)</p>
<p>A topology-only GNN cannot distinguish them, but a geometry-aware network can.</p>
<h4 id="understanding__symmetries">Understanding Symmetries<a class="headerlink" href="#understanding__symmetries" title="Permanent link">&para;</a></h4>
<p><strong>Physical Symmetries in Molecular Systems:</strong></p>
<p>Molecular properties must respect fundamental physical symmetries:</p>
<ol>
<li><strong>Translation Invariance</strong>: 
   <div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>Property(molecule) = Property(molecule + translation vector)
</span></code></pre></div></li>
<li>Moving the entire molecule in space doesn&rsquo;t change its energy or properties</li>
<li>Only relative positions matter, not absolute coordinates</li>
<li>
<p>Mathematically: E(R + t) = E(R) for any translation t</p>
</li>
<li>
<p><strong>Rotation Invariance</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>Property(molecule) = Property(rotate(molecule, θ))
</span></code></pre></div></p>
</li>
<li>Rotating the molecule doesn&rsquo;t change scalar properties (energy, dipole magnitude)</li>
<li>Physical measurements don&rsquo;t depend on orientation in space</li>
<li>
<p>Mathematically: E(QR) = E(R) for any rotation matrix Q</p>
</li>
<li>
<p><strong>Permutation Invariance</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>Property(atoms[1,2,3,...]) = Property(atoms[permutation])
</span></code></pre></div></p>
</li>
<li>Labeling atoms 1,2,3 vs 3,1,2 shouldn&rsquo;t change properties</li>
<li>Physical reality has no preferred ordering</li>
<li>
<p>Node ordering is an artifact of representation</p>
</li>
<li>
<p><strong>Reflection (for some properties)</strong>:</p>
</li>
<li>Chiral molecules break reflection symmetry</li>
<li>Achiral molecules maintain E(R) = E(mirror(R))</li>
</ol>
<p><strong>Invariance vs Equivariance:</strong></p>
<ul>
<li><strong>Invariant</strong>: Output doesn&rsquo;t change under transformation</li>
<li>Example: Energy is rotation-invariant scalar</li>
<li>
<p>E(rotate(molecule)) = E(molecule)</p>
</li>
<li>
<p><strong>Equivariant</strong>: Output transforms consistently with input</p>
</li>
<li>Example: Forces are rotation-equivariant vectors</li>
<li>F(rotate(molecule)) = rotate(F(molecule))</li>
<li>If you rotate the molecule, forces rotate the same way</li>
</ul>
<p><strong>Why This Matters:</strong></p>
<p>Networks that violate these symmetries will:
- Learn to recognize rotated versions as different molecules (inefficient)
- Require much more training data to learn all orientations
- Fail to generalize to new orientations
- Predict unphysical results (energy changing with rotation)</p>
<p>Networks that respect symmetries:
- Are more data-efficient (one orientation teaches all)
- Generalize better to new configurations
- Satisfy physical laws by construction
- Often achieve better accuracy with fewer parameters</p>
<h4 id="schnet__continuous-filter__convolutional__neural__network">SchNet (Continuous-filter Convolutional Neural Network)<a class="headerlink" href="#schnet__continuous-filter__convolutional__neural__network" title="Permanent link">&para;</a></h4>
<p>SchNet pioneered the use of continuous convolutions for molecular modeling, treating molecules as continuous 3D objects rather than discrete graphs.</p>
<p><strong>Core Philosophy:</strong></p>
<p>Instead of learning fixed filters for discrete bond types, SchNet learns continuous functions that depend smoothly on interatomic distances. This mirrors physics: interactions depend on distance in a continuous way (not discrete jumps).</p>
<p><strong>Architecture Overview:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>Input: 
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>  - Atomic numbers Z = [Z₁, Z₂, ..., Z_N]
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>  - 3D coordinates R = [r₁, r₂, ..., r_N]
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>Output:
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>  - Molecular property (energy, HOMO, etc.)
</span></code></pre></div>
<p><strong>Step 1: Atomic Embeddings</strong></p>
<p>Each atom type is embedded into a feature space:
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>x_i^(0) = Embedding(Z_i)  # Lookup table: atomic number → d-dimensional vector
</span></code></pre></div></p>
<p>For example:
- Carbon (Z=6) → [0.12, -0.34, 0.56, &hellip;]
- Nitrogen (Z=7) → [0.08, -0.29, 0.61, &hellip;]
- Oxygen (Z=8) → [0.15, -0.41, 0.48, &hellip;]</p>
<p><strong>Step 2: Continuous Filter Generation</strong></p>
<p>The innovation of SchNet: filters are functions of distance, not learned for discrete bins.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a># Compute all pairwise distances
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>d_ij = ||r_i - r_j||  # Euclidean distance
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a># Expand distances using radial basis functions (RBFs)
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>e_ij = [exp(-(d_ij - μ_k)² / σ²) for k in range(K)]
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a># Generate filter weights from expanded distances
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>W_ij = MLP(e_ij)  # Neural network: ℝ^K → ℝ^(d×d)
</span></code></pre></div>
<p><strong>Radial Basis Functions (RBFs):</strong></p>
<p>RBFs create a smooth representation of distances:
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a># Example: Gaussian RBFs centered at different distances
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>μ = [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, ...]  # Centers in Ångströms
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>σ = 0.1  # Width
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>For distance d_ij = 1.8 Å:
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>  RBF₁(1.8) = exp(-(1.8-0.5)²/0.01) ≈ 0.00  # Far from center
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>  RBF₂(1.8) = exp(-(1.8-1.0)²/0.01) ≈ 0.00
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>  RBF₃(1.8) = exp(-(1.8-1.5)²/0.01) ≈ 0.74  # Close to center
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>  RBF₄(1.8) = exp(-(1.8-2.0)²/0.01) ≈ 0.82  # Closest center
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>  ...
</span></code></pre></div></p>
<p>This creates a smooth, continuous representation that:
- Captures nuances between bond lengths
- Allows interpolation to unseen distances
- Provides smooth gradients for optimization</p>
<p><strong>Step 3: Interaction Blocks (Message Passing)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a># For each interaction layer t:
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>x_i^(t+1) = x_i^(t) + Σ_{j≠i} x_j^(t) ⊙ W_ij^(t)
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>Where:
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>  ⊙ is element-wise multiplication (Hadamard product)
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>  W_ij^(t) = FilterNetwork_t(d_ij) is the distance-dependent filter
</span></code></pre></div>
<p><strong>Detailed Breakdown:</strong></p>
<ol>
<li><strong>Cutoff Function</strong>: Only interact with nearby atoms
   <div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>if d_ij &gt; r_cutoff (typically 5-10 Å):
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>    W_ij = 0  # No interaction
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>else:
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>    W_ij = FilterNetwork(d_ij) × smooth_cutoff(d_ij)
</span></code></pre></div></li>
</ol>
<p>Smooth cutoff prevents discontinuities:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>f_cutoff(d) = 0.5 × [cos(π × d / r_cutoff) + 1]  if d &lt; r_cutoff
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>              0                                     otherwise
</span></code></pre></div></p>
<ol>
<li>
<p><strong>Filter Network Architecture</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>e = RBF_expansion(d_ij)      # [K] vector
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>h = Dense(e)                  # [K] → [hidden_dim]
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>h = ShiftedSoftplus(h)        # Smooth non-linearity
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>W = Dense(h)                  # [hidden_dim] → [d×d]
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>W = W × f_cutoff(d_ij)       # Apply cutoff
</span></code></pre></div></p>
</li>
<li>
<p><strong>Atom-wise Update</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a># Aggregate filtered neighbor features
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>m_i = Σ_{j∈neighbors(i)} x_j ⊙ W_ij
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a># Update with residual connection
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>x_i = x_i + m_i
</span></code></pre></div></p>
</li>
</ol>
<p><strong>Step 4: Output Modules</strong></p>
<p>After T interaction blocks:
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a># Atom-wise energy contributions
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>E_i = MLP_atom(x_i^(T))  # Scalar per atom
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a># Sum for total energy (size-extensive property)
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>E_total = Σ_i E_i
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a># Or average for intensive properties
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>Property = (1/N) Σ_i MLP(x_i^(T))
</span></code></pre></div></p>
<p><strong>Key Design Choices:</strong></p>
<ol>
<li><strong>Only distances, not coordinates</strong>:</li>
<li>Distances are rotation and translation invariant</li>
<li>||r_i - r_j|| is the same regardless of overall position/orientation</li>
<li>
<p>This guarantees the network is invariant</p>
</li>
<li>
<p><strong>Continuous filters</strong>:</p>
</li>
<li>Smoothly adapts to any distance</li>
<li>Better than discrete binning (1.0-1.5 Å, 1.5-2.0 Å, &hellip;)</li>
<li>
<p>Allows accurate interpolation</p>
</li>
<li>
<p><strong>Shifted Softplus activation</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>ShiftedSoftplus(x) = log(0.5 × exp(x) + 0.5)
</span></code></pre></div></p>
</li>
<li>Smooth everywhere (unlike ReLU)</li>
<li>Important for force prediction: forces = -∇E</li>
<li>Provides smooth gradients</li>
</ol>
<p><strong>Strengths:</strong>
- <strong>Efficient</strong>: Linear in number of atoms (with cutoff)
- <strong>Scalable</strong>: Handles molecules from 10 to 1000+ atoms
- <strong>Accurate</strong>: State-of-the-art on QM9 and other benchmarks
- <strong>End-to-end differentiable</strong>: Can predict forces via backpropagation
- <strong>Physically motivated</strong>: Design mirrors physics of interactions</p>
<p><strong>Limitations:</strong>
- <strong>Distance-only</strong>: Doesn&rsquo;t explicitly capture angles
- <strong>Isotropic</strong>: Treats all directions equally (no directionality)
- <strong>Cannot predict vector properties directly</strong>: Forces require gradients</p>
<p><strong>Implementation Notes:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Typical hyperparameters</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">num_interactions</span> <span class="o">=</span> <span class="mi">6</span>        <span class="c1"># Depth of network</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="n">num_gaussians</span> <span class="o">=</span> <span class="mi">50</span>          <span class="c1"># Number of RBF centers</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="n">cutoff</span> <span class="o">=</span> <span class="mf">5.0</span>                <span class="c1"># Interaction cutoff (Å)</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="n">hidden_dim</span> <span class="o">=</span> <span class="mi">128</span>            <span class="c1"># Feature dimension</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="n">num_filters</span> <span class="o">=</span> <span class="mi">128</span>           <span class="c1"># Filter network dimension</span>
</span></code></pre></div>
<h4 id="dimenet__directional__message__passing__neural__network">DimeNet (Directional Message Passing Neural Network)<a class="headerlink" href="#dimenet__directional__message__passing__neural__network" title="Permanent link">&para;</a></h4>
<p>DimeNet extends SchNet by incorporating angular information, making it significantly more expressive for molecular modeling.</p>
<p><strong>Key Innovation: Beyond Distances</strong></p>
<p>While distances capture bond lengths, many properties depend on:
- <strong>Bond angles</strong>: H-O-H angle in water determines properties
- <strong>Dihedral angles</strong>: Rotations around single bonds affect conformation
- <strong>Triplet interactions</strong>: Three-body terms in force fields</p>
<p><strong>Physics Analogy</strong>: 
- SchNet ≈ Lennard-Jones potential (pairwise, distance-only)
- DimeNet ≈ Force fields with angle terms (CHARMM, AMBER)</p>
<p><strong>Architecture: Directional Messages</strong></p>
<p>DimeNet introduces messages that depend on triplets of atoms (i,j,k):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>                k
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>               /
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>              /θ_{ijk}
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>             /
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>            j -------- i
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>          d_jk      d_ij
</span></code></pre></div>
<p><strong>Step 1: Distance and Angle Embeddings</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a># Distance embedding (like SchNet)
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>e_dist(d_ij) = RBF_expansion(d_ij)
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a># NEW: Angle embedding
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>θ_{ijk} = angle between vectors (r_j - r_i) and (r_k - r_j)
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>e_angle(θ_{ijk}) = SphericalBasisFunctions(θ_{ijk})
</span></code></pre></div>
<p><strong>Spherical Basis Functions:</strong></p>
<p>Instead of Gaussians (for distances), use spherical harmonics for angles:
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a># Angles are periodic: 0° = 360°
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a># Use basis that respects this periodicity
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>SBF_k(θ) = Σ_n c_{nk} × exp(-(n - n_0)²/σ²) × sin(nθ)
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a># These form a complete basis for representing angular functions
</span></code></pre></div></p>
<p><strong>Step 2: Directional Message Passing</strong></p>
<p>The crucial innovation - messages depend on geometric triplets:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a># For each atom i:
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>m_ij = Σ_{k∈N(j), k≠i} MessageBlock(d_ij, d_jk, θ_{ijk}) ⊙ x_k
</span></code></pre></div>
<p>Let&rsquo;s break down <code>MessageBlock(d_ij, d_jk, θ_{ijk})</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">MessageBlock</span><span class="p">(</span><span class="n">d_ij</span><span class="p">,</span> <span class="n">d_jk</span><span class="p">,</span> <span class="n">theta_ijk</span><span class="p">):</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>    <span class="c1"># Embed distances</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>    <span class="n">rbf_ij</span> <span class="o">=</span> <span class="n">RBF</span><span class="p">(</span><span class="n">d_ij</span><span class="p">)</span>        <span class="c1"># [n_rbf]</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>    <span class="n">rbf_jk</span> <span class="o">=</span> <span class="n">RBF</span><span class="p">(</span><span class="n">d_jk</span><span class="p">)</span>        <span class="c1"># [n_rbf]</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>    <span class="c1"># Embed angle</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>    <span class="n">sbf</span> <span class="o">=</span> <span class="n">SphericalBasis</span><span class="p">(</span><span class="n">theta_ijk</span><span class="p">)</span>  <span class="c1"># [n_sbf]</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>    <span class="c1"># Combine using bilinear layer</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>    <span class="c1"># This learns correlations between distances and angles</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>    <span class="n">W</span> <span class="o">=</span> <span class="n">BilinearLayer</span><span class="p">(</span><span class="n">rbf_ij</span><span class="p">,</span> <span class="n">rbf_jk</span><span class="p">,</span> <span class="n">sbf</span><span class="p">)</span>  <span class="c1"># [d × d] matrix</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>    <span class="k">return</span> <span class="n">W</span>
</span></code></pre></div>
<p><strong>Bilinear Layer Explained:</strong></p>
<p>The bilinear layer is crucial for combining geometric features:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>W = Σ_m Σ_n Σ_l  U_{mnl} × rbf_ij[m] × rbf_jk[n] × sbf[l]
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>Where U is a learned tensor of parameters
</span></code></pre></div>
<p>This allows the network to learn patterns like:
- &ldquo;When d_ij ≈ 1.5 Å AND d_jk ≈ 1.2 Å AND θ ≈ 120°&rdquo; → strong interaction
- Captures correlations between geometric features
- More expressive than treating features independently</p>
<p><strong>Step 3: Update with Directional Information</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a># Aggregate directional messages
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>m_i = Σ_{j∈N(i)} m_ij
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a># Update node features
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>x_i = Update(x_i, m_i)  # Typically a residual network
</span></code></pre></div>
<p><strong>Why This Works Better:</strong></p>
<ol>
<li><strong>Angular Information</strong>: Distinguishes linear vs bent vs tetrahedral</li>
<li>Example: CO₂ (linear, 180°) vs H₂O (bent, 104.5°)</li>
<li>
<p>Same atom types, different angles → different properties</p>
</li>
<li>
<p><strong>Dihedral Sensitivity</strong>: Captures rotational barriers</p>
</li>
<li>Ethane: staggered vs eclipsed conformations</li>
<li>
<p>Different angles → different energies</p>
</li>
<li>
<p><strong>Three-Body Interactions</strong>: More realistic physics</p>
</li>
<li>Many quantum effects involve three atoms</li>
<li>Necessary for accurate force fields</li>
</ol>
<p><strong>Maintaining Rotational Invariance:</strong></p>
<p>Despite using angles, DimeNet remains rotationally invariant because:
- Angles are invariant: θ_{ijk} doesn&rsquo;t change under rotation
- Only distances and angles used (not absolute coordinates)
- No preferred orientation in space</p>
<p><strong>DimeNet++ Improvements:</strong></p>
<p>The original DimeNet was slow. DimeNet++ optimized:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a># DimeNet: T-shaped message passing
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>Message: k → j → i  (sequential)
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a># DimeNet++: Optimized message aggregation
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>Message: All k → all j → all i  (more parallel)
</span></code></pre></div>
<p><strong>Optimization strategies:</strong>
1. <strong>Shared bilinear layers</strong>: Reduce parameters
2. <strong>Efficient triplet enumeration</strong>: Better data structures
3. <strong>Grouped convolutions</strong>: Reduce computational cost
4. <strong>Memory-efficient attention</strong>: Lower memory footprint</p>
<p><strong>Performance:</strong>
- DimeNet++: 2-5× faster than DimeNet
- Same or better accuracy
- Can handle larger molecules (100+ atoms)</p>
<p><strong>Advantages:</strong>
- <strong>Higher accuracy</strong>: 20-40% better MAE on QM9 vs SchNet
- <strong>Captures geometry</strong>: Angles and dihedrals encoded
- <strong>Physics-aware</strong>: Mirrors force field design
- <strong>Still rotationally invariant</strong>: Maintains symmetries</p>
<p><strong>Disadvantages:</strong>
- <strong>Computational cost</strong>: O(N × k²) where k is coordination number
- <strong>Memory</strong>: Stores triplets, not just pairs
- <strong>Complexity</strong>: More hyperparameters to tune</p>
<p><strong>Use Cases:</strong>
- High-accuracy property prediction
- Conformational energy differences
- Transition state geometries
- Systems where angles matter (chelates, rings, etc.)</p>
<h4 id="painn__polarizable__atom__interaction__neural__network">PaiNN (Polarizable Atom Interaction Neural Network)<a class="headerlink" href="#painn__polarizable__atom__interaction__neural__network" title="Permanent link">&para;</a></h4>
<p>PaiNN represents a paradigm shift: instead of just invariant features, it maintains both scalar (invariant) and vector (equivariant) representations.</p>
<p><strong>Motivation: Vector Properties</strong></p>
<p>Many important properties are vectors (have direction):
- <strong>Forces</strong>: F = -∇E (gradient of energy)
- <strong>Dipole moments</strong>: μ = Σ_i q_i r_i
- <strong>Magnetic moments</strong>: Direction matters
- <strong>Polarizability</strong>: Tensorial response to fields</p>
<p>Previous models (SchNet, DimeNet):
- Can only predict scalar outputs directly
- Forces require numerical differentiation: F = -dE/dR
- Inefficient and sometimes inaccurate</p>
<p>PaiNN: 
- Predicts vectors directly
- Learns force fields end-to-end
- Truly equivariant architecture</p>
<p><strong>Equivariance Explained:</strong></p>
<p>For a rotation matrix Q:
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>Invariant (scalar): f(QR) = f(R)
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>    Example: ||v|| = ||Qv||  (length unchanged)
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>Equivariant (vector): f(QR) = Q f(R)
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>    Example: Qv rotates the same way as input
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>Equivariant (rank-2 tensor): f(QR) = Q f(R) Q^T
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>    Example: Stress tensor transforms
</span></code></pre></div></p>
<p><strong>Feature Representation:</strong></p>
<p>Each atom i has TWO types of features:</p>
<ol>
<li><strong>Scalar features</strong> s_i ∈ ℝ^d:</li>
<li>Rotation invariant</li>
<li>Examples: atomic charge, energy contribution, electron density</li>
<li>
<p>Transforms: s_i → s_i (unchanged under rotation)</p>
</li>
<li>
<p><strong>Vector features</strong> v_i ∈ ℝ^(d×3):</p>
</li>
<li>Rotation equivariant  </li>
<li>Examples: dipole moment, force vector, polarization</li>
<li>Transforms: v_i → Q v_i (rotates with molecule)</li>
</ol>
<p><strong>Architecture Overview:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>Input: (s_i^(0), v_i^(0)) for each atom
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>       s_i^(0) = embedding(Z_i)  # Initial: just element type
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>       v_i^(0) = 0                # Initial: no directional info
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>Message Passing Layers:
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>    (s_i, v_i) → MessagePass → (s_i&#39;, v_i&#39;)
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>Output: 
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>    Scalar: energy = Σ_i MLP(s_i^(T))
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>    Vector: forces = Σ_i v_i^(T)  # Or per-atom force contribution
</span></code></pre></div>
<p><strong>Message Passing in PaiNN:</strong></p>
<p>Each layer consists of three parts:</p>
<p><strong>Part 1: Scalar Message Passing</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># Compute scalar messages from neighbors</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>    <span class="n">d_ij</span> <span class="o">=</span> <span class="o">||</span><span class="n">r_j</span> <span class="o">-</span> <span class="n">r_i</span><span class="o">||</span>  <span class="c1"># Distance</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>    <span class="n">dir_ij</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_j</span> <span class="o">-</span> <span class="n">r_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_ij</span>  <span class="c1"># Unit direction vector</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>    <span class="c1"># Filter based on distance</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>    <span class="n">φ_ij</span> <span class="o">=</span> <span class="n">FilterNetwork</span><span class="p">(</span><span class="n">d_ij</span><span class="p">)</span>  <span class="c1"># Like SchNet</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>    <span class="c1"># Scalar message (rotation invariant)</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>    <span class="n">m_s_ij</span> <span class="o">=</span> <span class="n">φ_ij</span> <span class="err">⊙</span> <span class="n">s_j</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>    <span class="c1"># Also incorporate magnitude of vector features</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>    <span class="n">m_s_ij</span> <span class="o">+=</span> <span class="n">φ_ij</span> <span class="err">⊙</span> <span class="o">||</span><span class="n">v_j</span><span class="o">||</span><span class="err">²</span>  <span class="c1"># Invariant: length squared</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="c1"># Aggregate</span>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="n">m_s_i</span> <span class="o">=</span> <span class="n">Σ_j</span> <span class="n">m_s_ij</span>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a>
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="c1"># Update scalars</span>
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a><span class="n">s_i</span> <span class="o">=</span> <span class="n">s_i</span> <span class="o">+</span> <span class="n">MLP</span><span class="p">(</span><span class="n">m_s_i</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Part 2: Vector Message Passing</strong></p>
<p>This is where equivariance happens:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1"># Compute vector messages</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>    <span class="n">d_ij</span> <span class="o">=</span> <span class="o">||</span><span class="n">r_j</span> <span class="o">-</span> <span class="n">r_i</span><span class="o">||</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>    <span class="n">dir_ij</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_j</span> <span class="o">-</span> <span class="n">r_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_ij</span>  <span class="c1"># ← KEY: Direction vector</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>    <span class="n">φ_ij</span> <span class="o">=</span> <span class="n">FilterNetwork</span><span class="p">(</span><span class="n">d_ij</span><span class="p">)</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>    <span class="c1"># Vector message (rotation equivariant!)</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>    <span class="c1"># Multiply by direction to make equivariant</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>    <span class="n">m_v_ij</span> <span class="o">=</span> <span class="n">φ_ij</span> <span class="err">⊙</span> <span class="n">v_j</span>  <span class="c1"># Element-wise filter</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>    <span class="n">m_v_ij</span> <span class="o">+=</span> <span class="p">(</span><span class="n">φ_ij</span> <span class="err">⊙</span> <span class="n">s_j</span><span class="p">)</span> <span class="err">×</span> <span class="n">dir_ij</span>  <span class="c1"># Scalar-to-vector term</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="c1"># Aggregate vectors</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="n">m_v_i</span> <span class="o">=</span> <span class="n">Σ_j</span> <span class="n">m_v_ij</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="c1"># Update vectors</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="n">v_i</span> <span class="o">=</span> <span class="n">v_i</span> <span class="o">+</span> <span class="n">m_v_i</span>
</span></code></pre></div>
<p><strong>Why this is equivariant:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>Under rotation Q:
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>    dir_ij → Q dir_ij  (direction rotates)
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>    v_j → Q v_j        (vector features rotate)
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>    m_v_ij = φ_ij ⊙ v_j + (φ_ij ⊙ s_j) × dir_ij
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>         → φ_ij ⊙ (Q v_j) + (φ_ij ⊙ s_j) × (Q dir_ij)
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>         = Q [φ_ij ⊙ v_j + (φ_ij ⊙ s_j) × dir_ij]
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>         = Q m_v_ij  ✓
</span></code></pre></div>
<p><strong>Part 3: Mixing Scalars and Vectors</strong></p>
<p>Cross-interactions between scalar and vector features:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1"># Vector → Scalar: Extract invariant info from vectors</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="n">s_i</span> <span class="o">=</span> <span class="n">s_i</span> <span class="o">+</span> <span class="n">MLP</span><span class="p">(</span><span class="o">||</span><span class="n">v_i</span><span class="o">||</span><span class="p">)</span>  <span class="c1"># Length is invariant</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="n">s_i</span> <span class="o">=</span> <span class="n">s_i</span> <span class="o">+</span> <span class="n">MLP</span><span class="p">(</span><span class="n">v_i</span> <span class="err">·</span> <span class="n">v_i</span><span class="p">)</span>  <span class="c1"># Dot product is invariant</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="c1"># Scalar → Vector: Modulate vectors by scalars</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="n">v_i</span> <span class="o">=</span> <span class="n">v_i</span> <span class="err">⊙</span> <span class="n">σ</span><span class="p">(</span><span class="n">U</span> <span class="n">s_i</span><span class="p">)</span>  <span class="c1"># Element-wise gating</span>
</span></code></pre></div>
<p><strong>Complete Update Equations:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a># Scalar update
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>Δs_i = Σ_j [W_s(d_ij) ⊙ s_j + W_vs(d_ij) ⊙ ||v_j||²]
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>s_i = s_i + MLP(Δs_i + ||v_i||²)
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a># Vector update  
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>Δv_i = Σ_j [W_v(d_ij) ⊙ v_j + W_sv(d_ij) ⊙ s_j ⊙ (r_j - r_i) / d_ij]
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>v_i = v_i + Δv_i
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a># Mix scalar and vector
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>s_i = s_i + U_vs ||v_i||
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>v_i = (W_vv v_i) ⊙ σ(U_sv s_i)
</span></code></pre></div>
<p><strong>Output Predictions:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># Energy (scalar invariant)</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">E_i</span> <span class="o">=</span> <span class="n">MLP_scalar</span><span class="p">(</span><span class="n">s_i</span><span class="p">)</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="n">E_total</span> <span class="o">=</span> <span class="n">Σ_i</span> <span class="n">E_i</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="c1"># Forces (vector equivariant)</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="n">F_i</span> <span class="o">=</span> <span class="n">v_i</span>  <span class="c1"># Already in correct format!</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="c1"># Or: F_i = Linear(v_i) for learned scaling</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="c1"># Other vector properties</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="n">dipole</span> <span class="o">=</span> <span class="n">Σ_i</span> <span class="n">q_i</span> <span class="err">×</span> <span class="n">v_i</span>  <span class="c1"># If q_i are charges</span>
</span></code></pre></div>
<p><strong>Advantages of PaiNN:</strong></p>
<ol>
<li><strong>Direct vector prediction</strong>:</li>
<li>Forces without numerical differentiation</li>
<li>More accurate and efficient</li>
<li>
<p>Can predict multiple vector properties</p>
</li>
<li>
<p><strong>True equivariance</strong>:</p>
</li>
<li>Guarantees physical consistency</li>
<li>Rotated inputs → correctly rotated outputs</li>
<li>
<p>No violation of physics</p>
</li>
<li>
<p><strong>Expressive representations</strong>:</p>
</li>
<li>Vectors encode directional information</li>
<li>Richer than scalar-only features</li>
<li>
<p>Better for anisotropic systems</p>
</li>
<li>
<p><strong>Force field learning</strong>:</p>
</li>
<li>Can be trained on forces directly</li>
<li>Learns better potential energy surfaces</li>
<li>Useful for molecular dynamics</li>
</ol>
<p><strong>Training Considerations:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1"># Loss function combining energy and forces</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="n">loss</span> <span class="o">=</span> <span class="n">w_E</span> <span class="o">||</span><span class="n">E_pred</span> <span class="o">-</span> <span class="n">E_true</span><span class="o">||</span><span class="err">²</span> <span class="o">+</span> <span class="n">w_F</span> <span class="o">||</span><span class="n">F_pred</span> <span class="o">-</span> <span class="n">F_true</span><span class="o">||</span><span class="err">²</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="c1"># Typical weights</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="n">w_E</span> <span class="o">=</span> <span class="mf">1.0</span>   <span class="c1"># Energy in eV or kcal/mol</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="n">w_F</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># Forces in eV/Å (forces are smaller, need higher weight)</span>
</span></code></pre></div>
<p><strong>Applications:</strong></p>
<ol>
<li><strong>Molecular Dynamics</strong>:</li>
<li>Learn accurate force fields from DFT</li>
<li>1000× faster than ab initio MD</li>
<li>
<p>Maintains accuracy of quantum calculations</p>
</li>
<li>
<p><strong>Transition State Search</strong>:</p>
</li>
<li>Accurate forces guide optimization</li>
<li>Find saddle points efficiently</li>
<li>
<p>Predict reaction barriers</p>
</li>
<li>
<p><strong>Dipole Moment Prediction</strong>:</p>
</li>
<li>Important for spectroscopy</li>
<li>Drug-like properties</li>
<li>
<p>Solvent effects</p>
</li>
<li>
<p><strong>Polarizability</strong>:</p>
</li>
<li>Response to external fields</li>
<li>Optical properties</li>
<li>Intermolecular interactions</li>
</ol>
<p><strong>Implementation Notes:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1"># Hyperparameters</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="n">num_layers</span> <span class="o">=</span> <span class="mi">5</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="n">hidden_dim_scalar</span> <span class="o">=</span> <span class="mi">128</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">hidden_dim_vector</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># Vectors have 3× more parameters (x,y,z)</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="n">num_rbf</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="n">cutoff</span> <span class="o">=</span> <span class="mf">5.0</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="c1"># Vector features typically smaller dimension to save memory</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="c1"># v_i ∈ ℝ^(d×3) uses 3× memory of s_i ∈ ℝ^d</span>
</span></code></pre></div>
<h4 id="comparison__of__approaches">Comparison of Approaches<a class="headerlink" href="#comparison__of__approaches" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Model</th>
<th>Distance</th>
<th>Angles</th>
<th>Equivariance</th>
<th>Outputs</th>
<th>Complexity</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SchNet</strong></td>
<td>✓</td>
<td>✗</td>
<td>Invariant</td>
<td>Scalars</td>
<td>O(N×k)</td>
<td>Fast, general purpose, good baseline</td>
</tr>
<tr>
<td><strong>DimeNet</strong></td>
<td>✓</td>
<td>✓</td>
<td>Invariant</td>
<td>Scalars</td>
<td>O(N×k²)</td>
<td>High accuracy, angle-dependent properties</td>
</tr>
<tr>
<td><strong>DimeNet++</strong></td>
<td>✓</td>
<td>✓</td>
<td>Invariant</td>
<td>Scalars</td>
<td>O(N×k²)*</td>
<td>DimeNet with 3-5× speedup</td>
</tr>
<tr>
<td><strong>PaiNN</strong></td>
<td>✓</td>
<td>Implicit</td>
<td>Equivariant</td>
<td>Scalars + Vectors</td>
<td>O(N×k)</td>
<td>Forces, vector properties, MD</td>
</tr>
</tbody>
</table>
<p>*DimeNet++ optimized but same computational complexity</p>
<p><strong>When to Choose Each:</strong></p>
<p><strong>SchNet:</strong>
-  Need fast inference
-  Large molecules (&gt;100 atoms)
-  Don&rsquo;t need highest accuracy
-  Conformational search (many evaluations)
- X Highly angle-dependent properties
- X Need force predictions</p>
<p><strong>DimeNet/DimeNet++:</strong>
-  Need highest accuracy
-  Angle and dihedral effects important
-  Small to medium molecules (&lt;50 atoms)
-  Property prediction only
- X Computational budget limited
- X Need force predictions
- X Very large molecules</p>
<p><strong>PaiNN:</strong>
-  Need force predictions
-  Molecular dynamics simulations
-  Vector property prediction
-  Want equivariant representations
-  Good accuracy/speed trade-off
- X Only need scalar properties
- X Maximum simplicity desired</p>
<p><strong>Practical Decision Tree:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>Do you need vector outputs (forces, dipoles)?
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>├─ Yes → Use PaiNN
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>└─ No
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>    │
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>    └─ Is accuracy critical and dataset small?
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>        ├─ Yes → Use DimeNet++
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>        └─ No → Use SchNet (fastest)
</span></code></pre></div>
<p><strong>Benchmarks (QM9 dataset, HOMO energy):</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>Method          MAE (meV)   Time/molecule   Parameters
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>SchNet          41          0.5 ms          600K
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>DimeNet         33          3.0 ms          2M  
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>DimeNet++       29          1.2 ms          2M
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>PaiNN           35          0.8 ms          800K
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>Note: Exact numbers vary by implementation and hardware
</span></code></pre></div>
<hr />
<h3 id="4__protein-ligand__interaction__modeling">4. Protein-Ligand Interaction Modeling<a class="headerlink" href="#4__protein-ligand__interaction__modeling" title="Permanent link">&para;</a></h3>
<p>Understanding how small molecules (ligands) bind to proteins is crucial for drug discovery. GNNs provide powerful tools for modeling these complex interactions, potentially accelerating the drug development pipeline from years to months.</p>
<h4 id="the__drug__discovery__challenge">The Drug Discovery Challenge<a class="headerlink" href="#the__drug__discovery__challenge" title="Permanent link">&para;</a></h4>
<p><strong>Traditional Drug Discovery:</strong></p>
<ol>
<li><strong>Target Identification</strong>: Identify disease-related protein (months-years)</li>
<li><strong>Hit Discovery</strong>: Screen 10⁵-10⁶ compounds experimentally (months, $$$)</li>
<li><strong>Lead Optimization</strong>: Iteratively improve binding (years, $$$$)</li>
<li><strong>Clinical Trials</strong>: Test in humans (years, $$$$$)</li>
</ol>
<p><strong>Total</strong>: 10-15 years, $1-2 billion per drug</p>
<p><strong>AI-Accelerated Discovery:</strong></p>
<p>GNNs can predict binding without experiments:
- Virtual screening: 10⁶ compounds in hours
- Structure-based optimization
- Reduced experimental testing
- Faster iteration cycles</p>
<p><strong>Impact</strong>: Several AI-discovered drugs now in clinical trials</p>
<h4 id="problem__formulation">Problem Formulation<a class="headerlink" href="#problem__formulation" title="Permanent link">&para;</a></h4>
<p><strong>Key Tasks:</strong></p>
<ol>
<li><strong>Binding Affinity Prediction</strong>: </li>
<li>Predict the strength of protein-ligand binding</li>
<li>Metrics: IC₅₀, Ki, Kd, ΔG_bind</li>
<li>Range: nM (strong) to mM (weak)</li>
<li>
<p>Applications: Virtual screening, lead optimization</p>
</li>
<li>
<p><strong>Binding Pose Prediction</strong>: </p>
</li>
<li>Determine the 3D orientation of ligand in binding pocket</li>
<li>Must satisfy spatial constraints</li>
<li>Account for protein flexibility</li>
<li>
<p>Applications: Structure-based drug design</p>
</li>
<li>
<p><strong>Virtual Screening</strong>: </p>
</li>
<li>Rank large libraries of compounds</li>
<li>Prioritize for experimental testing</li>
<li>Requires fast inference (&lt;1s per compound)</li>
<li>
<p>Applications: Hit discovery, library filtering</p>
</li>
<li>
<p><strong>Selectivity Prediction</strong>:</p>
</li>
<li>Binding to target vs off-targets</li>
<li>Crucial for drug safety</li>
<li>Multi-protein modeling</li>
<li>Applications: Toxicity prediction, side effect profiling</li>
</ol>
<p><strong>Input Data:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>Protein:
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>  - Sequence: MKTAYIAKQRQ... (amino acid sequence)
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>  - Structure: 3D coordinates of atoms or residues
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>  - Features: Secondary structure, surface accessibility, physicochemical properties
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>Ligand:
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>  - SMILES: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O (structure string)
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>  - 3D Conformation: Atomic coordinates
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>  - Features: Atom types, charges, pharmacophore points
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>Complex:
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>  - Binding pose (if known from X-ray crystallography)
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>  - Interaction types (H-bonds, hydrophobic, π-stacking)
</span></code></pre></div>
<h4 id="representation__strategies">Representation Strategies<a class="headerlink" href="#representation__strategies" title="Permanent link">&para;</a></h4>
<p><strong>Challenge</strong>: How to represent a protein-ligand complex as a graph?</p>
<p><strong>Strategy 1: Separate Protein and Ligand Graphs</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>   [Protein Graph]    [Ligand Graph]
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>   Nodes: Residues    Nodes: Atoms
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>   Edges: Contacts    Edges: Bonds
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>          ↓                  ↓
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>      [GNN_prot]        [GNN_lig]
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>          ↓                  ↓
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>      h_protein         h_ligand
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>          └─────→ [Concatenate] ←─────┘
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>                       ↓
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>                   [MLP head]
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>                       ↓
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>                   Affinity
</span></code></pre></div>
<p><strong>Protein Graph Construction:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1"># Option A: Residue-level (coarse-grained)</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">protein</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>    <span class="n">node_features</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>        <span class="n">residue</span><span class="o">.</span><span class="n">amino_acid_type</span><span class="p">,</span>     <span class="c1"># One-hot: 20 amino acids</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>        <span class="n">residue</span><span class="o">.</span><span class="n">secondary_structure</span><span class="p">,</span>  <span class="c1"># Helix, sheet, coil</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>        <span class="n">residue</span><span class="o">.</span><span class="n">surface_accessibility</span><span class="p">,</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>        <span class="n">residue</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>        <span class="n">residue</span><span class="o">.</span><span class="n">hydrophobicity</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>    <span class="p">]</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="c1"># Edges: spatial proximity</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>    <span class="k">if</span> <span class="n">distance</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">CA</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">CA</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">:</span>  <span class="c1"># C-alpha distance</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>        <span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">CA</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">CA</span><span class="p">))</span>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a><span class="c1"># Option B: Atom-level (fine-grained)</span>
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a><span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">protein</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
</span><span id="__span-62-18"><a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a>    <span class="n">node_features</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-62-19"><a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span>
</span><span id="__span-62-20"><a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
</span><span id="__span-62-21"><a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">in_backbone</span><span class="p">,</span>
</span><span id="__span-62-22"><a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">in_sidechain</span>
</span><span id="__span-62-23"><a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a>    <span class="p">]</span>
</span></code></pre></div>
<p><strong>Ligand Graph Construction:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="c1"># Atoms as nodes</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>    <span class="n">node_features</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">,</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">formal_charge</span><span class="p">,</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">hybridization</span><span class="p">,</span>    <span class="c1"># sp, sp2, sp3</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">is_aromatic</span><span class="p">,</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">num_hydrogens</span><span class="p">,</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>        <span class="n">atom</span><span class="o">.</span><span class="n">chirality</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>    <span class="p">]</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="c1"># Bonds as edges</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">ligand</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a>    <span class="n">edge_features</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-63-16"><a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>        <span class="n">bond</span><span class="o">.</span><span class="n">bond_type</span><span class="p">,</span>    <span class="c1"># Single, double, triple, aromatic</span>
</span><span id="__span-63-17"><a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a>        <span class="n">bond</span><span class="o">.</span><span class="n">is_conjugated</span><span class="p">,</span>
</span><span id="__span-63-18"><a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a>        <span class="n">bond</span><span class="o">.</span><span class="n">is_in_ring</span><span class="p">,</span>
</span><span id="__span-63-19"><a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a>        <span class="n">bond</span><span class="o">.</span><span class="n">stereo</span>        <span class="c1"># E/Z, cis/trans</span>
</span><span id="__span-63-20"><a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a>    <span class="p">]</span>
</span></code></pre></div>
<p><strong>Pros:</strong>
- Simple architecture
- Can pre-train on protein/ligand datasets separately
- Modular: easy to swap GNN architectures</p>
<p><strong>Cons:</strong>
- No explicit inter-molecular interactions
- Late fusion may miss important binding details
- Less interpretable (black box combination)</p>
<p><strong>Strategy 2: Joint Protein-Ligand Interaction Graph</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>    Protein nodes + Ligand nodes
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>            ↓
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>    Intra-molecular edges (protein bonds, ligand bonds)
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>            +
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>    Inter-molecular edges (binding interactions)
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>            ↓
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>        [Joint GNN]
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>            ↓
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>      [Global pooling]
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>            ↓
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a>         Affinity
</span></code></pre></div>
<p><strong>Interaction Graph Construction:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1"># Combine protein and ligand into one graph</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="n">G</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="c1"># Add protein nodes</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="n">G</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">protein_atoms</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;protein&#39;</span><span class="p">)</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="c1"># Add ligand nodes  </span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="n">G</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">ligand_atoms</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;ligand&#39;</span><span class="p">)</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a><span class="c1"># Add intra-molecular edges</span>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="n">G</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">protein_bonds</span><span class="p">)</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="n">G</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">ligand_bonds</span><span class="p">)</span>
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>
</span><span id="__span-65-14"><a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="c1"># Add inter-molecular edges (KEY!)</span>
</span><span id="__span-65-15"><a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a><span class="k">for</span> <span class="n">p_atom</span> <span class="ow">in</span> <span class="n">protein_atoms</span><span class="p">:</span>
</span><span id="__span-65-16"><a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>    <span class="k">for</span> <span class="n">l_atom</span> <span class="ow">in</span> <span class="n">ligand_atoms</span><span class="p">:</span>
</span><span id="__span-65-17"><a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">p_atom</span><span class="p">,</span> <span class="n">l_atom</span><span class="p">)</span>
</span><span id="__span-65-18"><a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a>        <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>  <span class="c1"># Interaction cutoff</span>
</span><span id="__span-65-19"><a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a>            <span class="n">interaction_type</span> <span class="o">=</span> <span class="n">classify_interaction</span><span class="p">(</span><span class="n">p_atom</span><span class="p">,</span> <span class="n">l_atom</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
</span><span id="__span-65-20"><a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">p_atom</span><span class="p">,</span> <span class="n">l_atom</span><span class="p">,</span> 
</span><span id="__span-65-21"><a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a>                      <span class="n">distance</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
</span><span id="__span-65-22"><a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a>                      <span class="n">interaction</span><span class="o">=</span><span class="n">interaction_type</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Interaction Types:</strong></p>
<p>Classify inter-molecular edges by interaction:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">classify_interaction</span><span class="p">(</span><span class="n">p_atom</span><span class="p">,</span> <span class="n">l_atom</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>    <span class="n">interactions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>    <span class="c1"># Hydrogen bond</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>    <span class="k">if</span> <span class="n">is_h_bond_donor</span><span class="p">(</span><span class="n">p_atom</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_h_bond_acceptor</span><span class="p">(</span><span class="n">l_atom</span><span class="p">):</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">3.5</span> <span class="ow">and</span> <span class="n">angle_ok</span><span class="p">:</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>            <span class="n">interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;H-bond&#39;</span><span class="p">)</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>    <span class="c1"># Hydrophobic</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>    <span class="k">if</span> <span class="n">is_hydrophobic</span><span class="p">(</span><span class="n">p_atom</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_hydrophobic</span><span class="p">(</span><span class="n">l_atom</span><span class="p">):</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">4.5</span><span class="p">:</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>            <span class="n">interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;hydrophobic&#39;</span><span class="p">)</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>    <span class="c1"># Pi-stacking</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>    <span class="k">if</span> <span class="n">is_aromatic</span><span class="p">(</span><span class="n">p_atom</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_aromatic</span><span class="p">(</span><span class="n">l_atom</span><span class="p">):</span>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>        <span class="k">if</span> <span class="mf">3.5</span> <span class="o">&lt;</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">4.5</span><span class="p">:</span>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a>            <span class="n">interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pi-stacking&#39;</span><span class="p">)</span>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a>    <span class="c1"># Electrostatic</span>
</span><span id="__span-66-20"><a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a>    <span class="k">if</span> <span class="n">charge</span><span class="p">(</span><span class="n">p_atom</span><span class="p">)</span> <span class="o">*</span> <span class="n">charge</span><span class="p">(</span><span class="n">l_atom</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Opposite charges</span>
</span><span id="__span-66-21"><a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a>        <span class="n">interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;electrostatic&#39;</span><span class="p">)</span>
</span><span id="__span-66-22"><a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a>
</span><span id="__span-66-23"><a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a>    <span class="c1"># Salt bridge</span>
</span><span id="__span-66-24"><a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a>    <span class="k">if</span> <span class="n">is_charged_residue</span><span class="p">(</span><span class="n">p_atom</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_charged_group</span><span class="p">(</span><span class="n">l_atom</span><span class="p">):</span>
</span><span id="__span-66-25"><a id="__codelineno-66-25" name="__codelineno-66-25" href="#__codelineno-66-25"></a>        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">4.0</span><span class="p">:</span>
</span><span id="__span-66-26"><a id="__codelineno-66-26" name="__codelineno-66-26" href="#__codelineno-66-26"></a>            <span class="n">interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;salt-bridge&#39;</span><span class="p">)</span>
</span><span id="__span-66-27"><a id="__codelineno-66-27" name="__codelineno-66-27" href="#__codelineno-66-27"></a>
</span><span id="__span-66-28"><a id="__codelineno-66-28" name="__codelineno-66-28" href="#__codelineno-66-28"></a>    <span class="k">return</span> <span class="n">interactions</span>
</span></code></pre></div>
<p><strong>Pros:</strong>
- Explicit interaction modeling
- Message passing directly between protein and ligand
- More interpretable (can visualize key interactions)
- Better captures binding geometry</p>
<p><strong>Cons:</strong>
- Larger graphs (more nodes and edges)
- Requires 3D structure (binding pose)
- More complex to implement</p>
<p><strong>Strategy 3: Attention-Based Cross-Attention</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>    [Protein GNN] → h_protein_nodes
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>    [Ligand GNN]  → h_ligand_nodes
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>          ↓              ↓
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>    [Cross-Attention Layer]
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>          ↓
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>    Attended features
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>          ↓
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>    [Prediction head]
</span></code></pre></div>
<p><strong>Cross-Attention Mechanism:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># Protein attends to ligand</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="k">for</span> <span class="n">p_node</span> <span class="ow">in</span> <span class="n">protein_nodes</span><span class="p">:</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>    <span class="c1"># Compute attention to all ligand nodes</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>    <span class="n">attention</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>    <span class="k">for</span> <span class="n">l_node</span> <span class="ow">in</span> <span class="n">ligand_nodes</span><span class="p">:</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>        <span class="c1"># Attention score based on features and geometry</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>        <span class="n">score</span> <span class="o">=</span> <span class="n">attention_function</span><span class="p">(</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>            <span class="n">h_protein</span><span class="p">[</span><span class="n">p_node</span><span class="p">],</span> 
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>            <span class="n">h_ligand</span><span class="p">[</span><span class="n">l_node</span><span class="p">],</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>            <span class="n">distance</span><span class="p">(</span><span class="n">p_node</span><span class="p">,</span> <span class="n">l_node</span><span class="p">)</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>        <span class="p">)</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>        <span class="n">attention</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>    <span class="c1"># Softmax normalize</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>    <span class="n">attention</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">attention</span><span class="p">)</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>    <span class="c1"># Attended ligand features</span>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>    <span class="n">h_protein</span><span class="p">[</span><span class="n">p_node</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weighted_sum</span><span class="p">(</span><span class="n">attention</span><span class="p">,</span> <span class="n">h_ligand</span><span class="p">)</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a><span class="c1"># Ligand attends to protein (symmetric)</span>
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a><span class="k">for</span> <span class="n">l_node</span> <span class="ow">in</span> <span class="n">ligand_nodes</span><span class="p">:</span>
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>    <span class="c1"># Similar process in reverse</span>
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a>    <span class="o">...</span>
</span></code></pre></div>
<p><strong>Attention Function:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">attention_function</span><span class="p">(</span><span class="n">h_p</span><span class="p">,</span> <span class="n">h_l</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>    <span class="c1"># Feature similarity</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>    <span class="n">feat_sim</span> <span class="o">=</span> <span class="n">dot_product</span><span class="p">(</span><span class="n">W_p</span> <span class="o">@</span> <span class="n">h_p</span><span class="p">,</span> <span class="n">W_l</span> <span class="o">@</span> <span class="n">h_l</span><span class="p">)</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>    <span class="c1"># Distance penalty (closer = more attention)</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>    <span class="n">dist_weight</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">distance</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>    <span class="c1"># Combined score</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>    <span class="n">score</span> <span class="o">=</span> <span class="n">feat_sim</span> <span class="o">*</span> <span class="n">dist_weight</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a>    <span class="k">return</span> <span class="n">score</span>
</span></code></pre></div>
<p><strong>Pros:</strong>
- Learns which protein-ligand pairs interact
- Flexible: works without predefined interaction edges
- Can handle multiple binding modes
- Interpretable attention weights</p>
<p><strong>Cons:</strong>
- O(N_protein × N_ligand) complexity
- May overfit on small datasets
- Requires careful regularization</p>
<h4 id="architecture__patterns">Architecture Patterns<a class="headerlink" href="#architecture__patterns" title="Permanent link">&para;</a></h4>
<p><strong>Pattern 1: Separate Encoding with Late Fusion</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SeparateFusionModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">protein_gnn</span> <span class="o">=</span> <span class="n">GNN</span><span class="p">(</span><span class="n">protein_features</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ligand_gnn</span> <span class="o">=</span> <span class="n">GNN</span><span class="p">(</span><span class="n">ligand_features</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein_graph</span><span class="p">,</span> <span class="n">ligand_graph</span><span class="p">):</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>        <span class="c1"># Encode separately</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>        <span class="n">h_prot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_gnn</span><span class="p">(</span><span class="n">protein_graph</span><span class="p">)</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>        <span class="n">h_lig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ligand_gnn</span><span class="p">(</span><span class="n">ligand_graph</span><span class="p">)</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>        <span class="c1"># Global pooling</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>        <span class="n">z_prot</span> <span class="o">=</span> <span class="n">global_mean_pool</span><span class="p">(</span><span class="n">h_prot</span><span class="p">,</span> <span class="n">protein_graph</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a>        <span class="n">z_lig</span> <span class="o">=</span> <span class="n">global_mean_pool</span><span class="p">(</span><span class="n">h_lig</span><span class="p">,</span> <span class="n">ligand_graph</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a>
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a>        <span class="c1"># Concatenate and predict</span>
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">z_prot</span><span class="p">,</span> <span class="n">z_lig</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-70-18"><a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a>        <span class="n">affinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_mlp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="__span-70-19"><a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>        <span class="k">return</span> <span class="n">affinity</span>
</span></code></pre></div>
<p><strong>Pattern 2: Joint Encoding</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">JointGraphModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gnn</span> <span class="o">=</span> <span class="n">GNN</span><span class="p">(</span><span class="n">node_features</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_interactions</span><span class="p">,</span> <span class="n">edge_dim</span><span class="p">)</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">readout</span> <span class="o">=</span> <span class="n">Set2Set</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">complex_graph</span><span class="p">):</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>        <span class="c1"># Embed interactions</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>        <span class="n">edge_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_embedding</span><span class="p">(</span><span class="n">complex_graph</span><span class="o">.</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a>        <span class="c1"># Joint message passing</span>
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnn</span><span class="p">(</span><span class="n">complex_graph</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>                     <span class="n">complex_graph</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span>
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a>                     <span class="n">edge_attr</span><span class="p">)</span>
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a>
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>        <span class="c1"># Global pooling</span>
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readout</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">complex_graph</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</span><span id="__span-71-19"><a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a>
</span><span id="__span-71-20"><a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a>        <span class="c1"># Predict affinity</span>
</span><span id="__span-71-21"><a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a>        <span class="n">affinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="__span-71-22"><a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>        <span class="k">return</span> <span class="n">affinity</span>
</span></code></pre></div>
<p><strong>Pattern 3: Cross-Attention</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CrossAttentionModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">protein_encoder</span> <span class="o">=</span> <span class="n">GNN</span><span class="p">(</span><span class="n">protein_features</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ligand_encoder</span> <span class="o">=</span> <span class="n">GNN</span><span class="p">(</span><span class="n">ligand_features</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cross_attention</span> <span class="o">=</span> <span class="n">CrossAttentionLayer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein_graph</span><span class="p">,</span> <span class="n">ligand_graph</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>        <span class="c1"># Encode separately</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>        <span class="n">h_prot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_encoder</span><span class="p">(</span><span class="n">protein_graph</span><span class="p">)</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>        <span class="n">h_lig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ligand_encoder</span><span class="p">(</span><span class="n">ligand_graph</span><span class="p">)</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>        <span class="c1"># Cross-attention</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>        <span class="n">h_prot_updated</span><span class="p">,</span> <span class="n">h_lig_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_attention</span><span class="p">(</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>            <span class="n">h_prot</span><span class="p">,</span> <span class="n">h_lig</span><span class="p">,</span> <span class="n">distances</span>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a>        <span class="p">)</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a>
</span><span id="__span-72-18"><a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a>        <span class="c1"># Pool both</span>
</span><span id="__span-72-19"><a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>        <span class="n">z_prot</span> <span class="o">=</span> <span class="n">global_attention_pool</span><span class="p">(</span><span class="n">h_prot_updated</span><span class="p">)</span>
</span><span id="__span-72-20"><a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a>        <span class="n">z_lig</span> <span class="o">=</span> <span class="n">global_attention_pool</span><span class="p">(</span><span class="n">h_lig_updated</span><span class="p">)</span>
</span><span id="__span-72-21"><a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a>
</span><span id="__span-72-22"><a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a>        <span class="c1"># Predict from combined representation</span>
</span><span id="__span-72-23"><a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a>        <span class="n">affinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">z_prot</span> <span class="o">+</span> <span class="n">z_lig</span><span class="p">)</span>
</span><span id="__span-72-24"><a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a>        <span class="k">return</span> <span class="n">affinity</span>
</span></code></pre></div>
<h4 id="key__considerations">Key Considerations<a class="headerlink" href="#key__considerations" title="Permanent link">&para;</a></h4>
<p><strong>1. Geometric Information</strong></p>
<p>3D coordinates are essential for accurate binding prediction:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1"># Distance features (crucial!)</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="n">edge_features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">edge</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>    <span class="c1"># Distance encoding</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>    <span class="n">rbf</span> <span class="o">=</span> <span class="n">gaussian_rbf</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">centers</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>    <span class="n">edge_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbf</span><span class="p">)</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>    <span class="c1"># Direction (for equivariant models)</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a>    <span class="n">direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">d</span>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a><span class="c1"># Use in GNN</span>
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a><span class="n">h</span> <span class="o">=</span> <span class="n">GNN</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">edge_features</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Why geometry matters:</strong>
- Binding pocket shape determines complementarity
- Hydrogen bonds have geometric constraints (distance + angle)
- Hydrophobic interactions are distance-dependent
- Steric clashes prevent binding</p>
<p><strong>2. Data Challenges</strong></p>
<p><strong>Limited Experimental Data:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>Available binding data:
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>- PDBbind: ~20,000 protein-ligand complexes
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>- ChEMBL: ~2M bioactivity measurements (but many without structures)
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>- BindingDB: ~2M Ki/Kd values
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>Compare to:
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>- ImageNet: 14M images
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a>- GPT training: trillions of tokens
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>Challenge: Deep learning typically needs more data
</span></code></pre></div>
<p><strong>Solutions:</strong></p>
<p>a) <strong>Data Augmentation:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1"># Rotation augmentation</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">]:</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    <span class="n">rotated_complex</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="nb">complex</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>    <span class="n">train_on</span><span class="p">(</span><span class="n">rotated_complex</span><span class="p">)</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="c1"># Conformational sampling</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">generate_conformations</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>    <span class="n">augmented_complex</span> <span class="o">=</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>    <span class="n">train_on</span><span class="p">(</span><span class="n">augmented_complex</span><span class="p">)</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="c1"># Noise injection</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="k">for</span> <span class="n">noise_level</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]:</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>    <span class="n">noisy_coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">+</span> <span class="n">noise_level</span> <span class="o">*</span> <span class="n">random_normal</span><span class="p">()</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>    <span class="n">train_on</span><span class="p">(</span><span class="n">noisy_coords</span><span class="p">)</span>
</span></code></pre></div></p>
<p>b) <strong>Transfer Learning:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="c1"># Pre-train on easier tasks</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="n">model</span><span class="o">.</span><span class="n">pretrain</span><span class="p">(</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>    <span class="n">task</span><span class="o">=</span><span class="s1">&#39;molecular_property_prediction&#39;</span><span class="p">,</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>    <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;QM9&#39;</span><span class="p">,</span>  <span class="c1"># Millions of molecules</span>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>    <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="p">)</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a><span class="c1"># Fine-tune on binding</span>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="n">model</span><span class="o">.</span><span class="n">finetune</span><span class="p">(</span>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>    <span class="n">task</span><span class="o">=</span><span class="s1">&#39;binding_affinity&#39;</span><span class="p">,</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a>    <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;PDBbind&#39;</span><span class="p">,</span>  <span class="c1"># Thousands of complexes</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-4</span>  <span class="c1"># Lower learning rate</span>
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a><span class="p">)</span>
</span></code></pre></div></p>
<p>c) <strong>Multi-Task Learning:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1"># Learn related tasks simultaneously</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">w1</span> <span class="o">*</span> <span class="n">loss_binding_affinity</span> <span class="o">+</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>        <span class="n">w2</span> <span class="o">*</span> <span class="n">loss_binding_pose</span> <span class="o">+</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>        <span class="n">w3</span> <span class="o">*</span> <span class="n">loss_protein_function</span> <span class="o">+</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>        <span class="n">w4</span> <span class="o">*</span> <span class="n">loss_ligand_properties</span><span class="p">)</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="c1"># Shared representations benefit all tasks</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="c1"># More efficient use of limited data</span>
</span></code></pre></div></p>
<p><strong>Missing Structures:</strong></p>
<p>Many bioactivity measurements lack 3D structures:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1"># Sequence-only prediction (when no structure)</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="k">if</span> <span class="n">protein_structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>    <span class="c1"># Use sequence-based protein representation</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    <span class="n">h_prot</span> <span class="o">=</span> <span class="n">ProteinLanguageModel</span><span class="p">(</span><span class="n">protein_sequence</span><span class="p">)</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>    <span class="c1"># Use structure-based GNN</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>    <span class="n">h_prot</span> <span class="o">=</span> <span class="n">ProteinGNN</span><span class="p">(</span><span class="n">protein_structure</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>3. Interpretability</strong></p>
<p>Understanding WHY a compound binds is as important as predicting IF it binds:</p>
<p><strong>Attention Visualization:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="c1"># Extract attention weights</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="n">attentions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_attention_weights</span><span class="p">()</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="c1"># Identify key protein residues</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="n">important_residues</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="k">for</span> <span class="n">residue</span><span class="p">,</span> <span class="n">attention</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">attentions</span><span class="p">):</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>    <span class="k">if</span> <span class="n">attention</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>        <span class="n">important_residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="c1"># Visualize in 3D</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="n">visualize_protein_ligand</span><span class="p">(</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>    <span class="n">protein</span><span class="p">,</span> 
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>    <span class="n">ligand</span><span class="p">,</span>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a>    <span class="n">highlight_residues</span><span class="o">=</span><span class="n">important_residues</span><span class="p">,</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>    <span class="n">highlight_atoms</span><span class="o">=</span><span class="n">high_attention_ligand_atoms</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a><span class="p">)</span>
</span></code></pre></div>
<p><strong>Interaction Decomposition:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1"># Analyze contribution of each interaction type</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="k">for</span> <span class="n">interaction_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;H-bond&#39;</span><span class="p">,</span> <span class="s1">&#39;hydrophobic&#39;</span><span class="p">,</span> <span class="s1">&#39;pi-stack&#39;</span><span class="p">]:</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>    <span class="c1"># Ablation: remove this interaction type</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>    <span class="n">affinity_without</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>        <span class="nb">complex</span><span class="p">,</span> 
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>        <span class="n">exclude_interaction</span><span class="o">=</span><span class="n">interaction_type</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>    <span class="p">)</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>    <span class="n">contribution</span> <span class="o">=</span> <span class="n">affinity_full</span> <span class="o">-</span> <span class="n">affinity_without</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interaction_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">contribution</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> kcal/mol&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Gradient-Based Explanations:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># Which atoms matter most?</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="n">ligand</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="n">affinity</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">ligand</span><span class="p">)</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="n">affinity</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="c1"># Atoms with large gradients are important</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="n">importance</span> <span class="o">=</span> <span class="n">ligand</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="n">visualize_atom_importance</span><span class="p">(</span><span class="n">ligand</span><span class="p">,</span> <span class="n">importance</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Applications:</strong></p>
<ol>
<li><strong>SAR (Structure-Activity Relationship)</strong>:</li>
<li>&ldquo;This hydrogen bond donor is crucial&rdquo;</li>
<li>&ldquo;Hydrophobic tail can be modified&rdquo;</li>
<li>
<p>Guides medicinal chemistry</p>
</li>
<li>
<p><strong>Failure Analysis</strong>:</p>
</li>
<li>&ldquo;Model focuses on wrong pocket&rdquo;</li>
<li>&ldquo;Missed key water-mediated H-bond&rdquo;</li>
<li>
<p>Improves model training</p>
</li>
<li>
<p><strong>Knowledge Discovery</strong>:</p>
</li>
<li>Identify novel binding motifs</li>
<li>Understand selectivity patterns</li>
<li>Generate hypotheses for experiments</li>
</ol>
<h4 id="state-of-the-art__models">State-of-the-Art Models<a class="headerlink" href="#state-of-the-art__models" title="Permanent link">&para;</a></h4>
<p><strong>EquiBind (2021)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>Key Innovation: SE(3)-equivariant blind docking
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>Architecture:
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>- Separate protein and ligand encoders
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>- Equivariant graph neural network (EGNN)
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>- Predicts keypoint matches
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>- Direct coordinate prediction (no search)
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a>Performance:
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a>- 38% success rate (&lt;2Å RMSD) on PDBbind
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a>- 1000× faster than traditional docking
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a>- Fully differentiable
</span></code></pre></div>
<p><strong>GraphDTA / DeepDTA (2018)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>Key Innovation: End-to-end learning from sequences
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>Architecture:
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>- CNN for protein sequences
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>- GNN for ligand graphs
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>- Concatenation + MLP
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>- Trained on drug-target affinity
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>Performance:
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>- Competitive on Davis and KIBA datasets
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a>- Works without 3D structures
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>- Fast inference for virtual screening
</span></code></pre></div>
<p><strong>ATOM3D (2021)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>Key Innovation: 3D structure benchmarks
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>Datasets:
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>- Protein-ligand binding (PDB)
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>- Protein structure prediction
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>- RNA structure
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>- Molecular dynamics
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>Models:
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>- SchNet, DimeNet applied to biomolecules
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>- Transformers with 3D positional encoding
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>- Graph transformers
</span></code></pre></div>
<p><strong>TANKBind (2023)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>Key Innovation: Equivariant blind docking with diffusion
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a>Architecture:
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a>- Diffusion model for pose generation
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>- Equivariant score matching
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a>- Iterative refinement
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a>- Confidence estimation
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a>Performance:
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a>- State-of-the-art on blind docking
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a>- Handles protein flexibility
</span><span id="__span-85-12"><a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a>- Generalizes to unseen proteins
</span></code></pre></div>
<h4 id="practical__workflow">Practical Workflow<a class="headerlink" href="#practical__workflow" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="c1"># 1. Data preparation</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">biopandas.pdb</span><span class="w"> </span><span class="kn">import</span> <span class="n">PandasPdb</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="c1"># Load protein</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="n">protein</span> <span class="o">=</span> <span class="n">PandasPdb</span><span class="p">()</span><span class="o">.</span><span class="n">fetch_pdb</span><span class="p">(</span><span class="s1">&#39;1a2b&#39;</span><span class="p">)</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="n">protein_graph</span> <span class="o">=</span> <span class="n">protein_to_graph</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="c1"># Load ligand</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="n">ligand</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromMol2File</span><span class="p">(</span><span class="s1">&#39;ligand.mol2&#39;</span><span class="p">)</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="n">ligand_graph</span> <span class="o">=</span> <span class="n">mol_to_graph</span><span class="p">(</span><span class="n">ligand</span><span class="p">)</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="c1"># 2. Model training</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ProteinLigandGNN</span><span class="p">(</span>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a>    <span class="n">protein_features</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a>    <span class="n">ligand_features</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a>    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a>    <span class="n">num_layers</span><span class="o">=</span><span class="mi">4</span>
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a><span class="p">)</span>
</span><span id="__span-86-19"><a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a>
</span><span id="__span-86-20"><a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span id="__span-86-21"><a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a>
</span><span id="__span-86-22"><a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span id="__span-86-23"><a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a>    <span class="k">for</span> <span class="n">protein_graph</span><span class="p">,</span> <span class="n">ligand_graph</span><span class="p">,</span> <span class="n">affinity</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
</span><span id="__span-86-24"><a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a>        <span class="n">pred_affinity</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">protein_graph</span><span class="p">,</span> <span class="n">ligand_graph</span><span class="p">)</span>
</span><span id="__span-86-25"><a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">pred_affinity</span><span class="p">,</span> <span class="n">affinity</span><span class="p">)</span>
</span><span id="__span-86-26"><a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a>
</span><span id="__span-86-27"><a id="__codelineno-86-27" name="__codelineno-86-27" href="#__codelineno-86-27"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-86-28"><a id="__codelineno-86-28" name="__codelineno-86-28" href="#__codelineno-86-28"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-86-29"><a id="__codelineno-86-29" name="__codelineno-86-29" href="#__codelineno-86-29"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-86-30"><a id="__codelineno-86-30" name="__codelineno-86-30" href="#__codelineno-86-30"></a>
</span><span id="__span-86-31"><a id="__codelineno-86-31" name="__codelineno-86-31" href="#__codelineno-86-31"></a><span class="c1"># 3. Virtual screening</span>
</span><span id="__span-86-32"><a id="__codelineno-86-32" name="__codelineno-86-32" href="#__codelineno-86-32"></a><span class="n">candidates</span> <span class="o">=</span> <span class="n">load_library</span><span class="p">(</span><span class="s1">&#39;drugbank.sdf&#39;</span><span class="p">)</span>  <span class="c1"># 10,000 compounds</span>
</span><span id="__span-86-33"><a id="__codelineno-86-33" name="__codelineno-86-33" href="#__codelineno-86-33"></a>
</span><span id="__span-86-34"><a id="__codelineno-86-34" name="__codelineno-86-34" href="#__codelineno-86-34"></a><span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-86-35"><a id="__codelineno-86-35" name="__codelineno-86-35" href="#__codelineno-86-35"></a><span class="k">for</span> <span class="n">ligand</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
</span><span id="__span-86-36"><a id="__codelineno-86-36" name="__codelineno-86-36" href="#__codelineno-86-36"></a>    <span class="n">ligand_graph</span> <span class="o">=</span> <span class="n">mol_to_graph</span><span class="p">(</span><span class="n">ligand</span><span class="p">)</span>
</span><span id="__span-86-37"><a id="__codelineno-86-37" name="__codelineno-86-37" href="#__codelineno-86-37"></a>    <span class="n">affinity</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">protein_graph</span><span class="p">,</span> <span class="n">ligand_graph</span><span class="p">)</span>
</span><span id="__span-86-38"><a id="__codelineno-86-38" name="__codelineno-86-38" href="#__codelineno-86-38"></a>    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ligand</span><span class="p">,</span> <span class="n">affinity</span><span class="p">))</span>
</span><span id="__span-86-39"><a id="__codelineno-86-39" name="__codelineno-86-39" href="#__codelineno-86-39"></a>
</span><span id="__span-86-40"><a id="__codelineno-86-40" name="__codelineno-86-40" href="#__codelineno-86-40"></a><span class="c1"># Sort by predicted affinity</span>
</span><span id="__span-86-41"><a id="__codelineno-86-41" name="__codelineno-86-41" href="#__codelineno-86-41"></a><span class="n">predictions</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-86-42"><a id="__codelineno-86-42" name="__codelineno-86-42" href="#__codelineno-86-42"></a>
</span><span id="__span-86-43"><a id="__codelineno-86-43" name="__codelineno-86-43" href="#__codelineno-86-43"></a><span class="c1"># Test top 100 experimentally</span>
</span><span id="__span-86-44"><a id="__codelineno-86-44" name="__codelineno-86-44" href="#__codelineno-86-44"></a><span class="n">top_hits</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
</span></code></pre></div>
<h4 id="future__directions">Future Directions<a class="headerlink" href="#future__directions" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Physics-Informed Neural Networks</strong>:</li>
<li>Incorporate electrostatics, solvation</li>
<li>Constrain predictions with physical laws</li>
<li>
<p>Hybrid quantum/classical approaches</p>
</li>
<li>
<p><strong>Generative Models</strong>:</p>
</li>
<li>Generate ligands for target protein</li>
<li>Optimize for multiple objectives</li>
<li>
<p>De novo drug design</p>
</li>
<li>
<p><strong>Allostery and Dynamics</strong>:</p>
</li>
<li>Model protein conformational changes</li>
<li>Long-range allosteric effects</li>
<li>
<p>Molecular dynamics integration</p>
</li>
<li>
<p><strong>Multi-Target Modeling</strong>:</p>
</li>
<li>Selectivity across protein families</li>
<li>Polypharmacology</li>
<li>Side effect prediction</li>
</ol>
<hr />
<h3 id="5__crystal__structures__for__materials__science">5. Crystal Structures for Materials Science<a class="headerlink" href="#5__crystal__structures__for__materials__science" title="Permanent link">&para;</a></h3>
<p>GNNs are revolutionizing materials science by predicting properties of crystalline materials from their atomic structures. This enables high-throughput screening of millions of hypothetical materials, dramatically accelerating materials discovery.</p>
<h4 id="understanding__crystalline__materials">Understanding Crystalline Materials<a class="headerlink" href="#understanding__crystalline__materials" title="Permanent link">&para;</a></h4>
<p><strong>What Makes Crystals Different?</strong></p>
<p>Unlike molecules, crystals are:
- <strong>Infinite</strong>: Periodic repetition in 3D space
- <strong>Ordered</strong>: Atoms arranged in regular lattices
- <strong>Defined by symmetry</strong>: Space groups and point groups
- <strong>Bulk properties</strong>: Properties of the infinite system, not just a cluster</p>
<p><strong>Real-World Impact:</strong></p>
<p>Materials with specific properties enable technology:
- <strong>Batteries</strong>: Li-ion conductors (electric vehicles)
- <strong>Solar cells</strong>: High-efficiency photovoltaics
- <strong>Catalysts</strong>: Green chemical production
- <strong>Semiconductors</strong>: Computing and electronics
- <strong>Superconductors</strong>: Lossless power transmission</p>
<p><strong>The Discovery Challenge:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>Possible stable materials: ~10^50 (combinatorial explosion!)
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>Known materials: ~200,000 (Materials Project, ICSD)
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>Fully characterized: ~50,000
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>Currently used: ~10,000
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>DFT calculation: 1-1000 CPU-hours per material
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>ML prediction: 0.001 seconds per material
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>Speed-up: 10^6× faster!
</span></code></pre></div>
<h4 id="crystal__representation">Crystal Representation<a class="headerlink" href="#crystal__representation" title="Permanent link">&para;</a></h4>
<p><strong>Unit Cell Description:</strong></p>
<p>A crystal is fully specified by:</p>
<ol>
<li>
<p><strong>Lattice Vectors</strong>: Define the unit cell
   <div class="language-text highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>a⃗ = [a_x, a_y, a_z]  # First lattice vector
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>b⃗ = [b_x, b_y, b_z]  # Second lattice vector  
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>c⃗ = [c_x, c_y, c_z]  # Third lattice vector
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>Lattice matrix: L = [a⃗ | b⃗ | c⃗]
</span></code></pre></div></p>
</li>
<li>
<p><strong>Lattice Parameters</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>a, b, c = lengths of vectors (Ångströms)
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>α, β, γ = angles between vectors (degrees)
</span></code></pre></div></p>
</li>
<li>
<p><strong>Basis</strong>: Atomic positions within the unit cell
   <div class="language-text highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>Fractional coordinates: (u, v, w) where 0 ≤ u,v,w &lt; 1
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>Cartesian coordinates: r⃗ = u·a⃗ + v·b⃗ + w·c⃗
</span></code></pre></div></p>
</li>
<li>
<p><strong>Space Group</strong>: Symmetry operations
   <div class="language-text highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>230 possible space groups in 3D
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>Examples: P21/c (monoclinic), Fm3̄m (cubic), P63/mmc (hexagonal)
</span></code></pre></div></p>
</li>
</ol>
<p><strong>Example: Diamond (Carbon)</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>Lattice: Face-centered cubic (FCC)
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a>  a = b = c = 3.567 Å
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a>  α = β = γ = 90°
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a>Basis: Two carbon atoms at
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>  C₁: (0, 0, 0)
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a>  C₂: (0.25, 0.25, 0.25)
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a>
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a>Space group: Fd3̄m (227)
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a>
</span><span id="__span-92-11"><a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a>Infinite crystal:
</span><span id="__span-92-12"><a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a>  All positions (n₁, n₂, n₃) + basis
</span><span id="__span-92-13"><a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a>  where n₁, n₂, n₃ ∈ ℤ
</span></code></pre></div>
<h4 id="periodic__boundary__conditions">Periodic Boundary Conditions<a class="headerlink" href="#periodic__boundary__conditions" title="Permanent link">&para;</a></h4>
<p><strong>The Periodicity Challenge:</strong></p>
<p>For graph construction, we need neighbors, but:
- Atoms near cell boundaries have neighbors in adjacent cells
- Must account for periodic images
- Same atom appears infinitely many times</p>
<p><strong>Graph Construction Algorithm:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">construct_crystal_graph</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">lattice</span><span class="p">,</span> <span class="n">cutoff_radius</span><span class="p">):</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="sd">    Build graph respecting periodic boundaries</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a>    <span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a>
</span><span id="__span-93-7"><a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a>    <span class="c1"># Add nodes for atoms in unit cell</span>
</span><span id="__span-93-8"><a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a>    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
</span><span id="__span-93-9"><a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a>        <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
</span><span id="__span-93-10"><a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a>            <span class="n">element</span><span class="o">=</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span>
</span><span id="__span-93-11"><a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a>            <span class="n">position</span><span class="o">=</span><span class="n">atom</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span>  <span class="c1"># Fractional coordinates</span>
</span><span id="__span-93-12"><a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a>            <span class="n">features</span><span class="o">=</span><span class="n">get_atom_features</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
</span><span id="__span-93-13"><a id="__codelineno-93-13" name="__codelineno-93-13" href="#__codelineno-93-13"></a>        <span class="p">)</span>
</span><span id="__span-93-14"><a id="__codelineno-93-14" name="__codelineno-93-14" href="#__codelineno-93-14"></a>
</span><span id="__span-93-15"><a id="__codelineno-93-15" name="__codelineno-93-15" href="#__codelineno-93-15"></a>    <span class="c1"># Find neighbors using minimum image convention</span>
</span><span id="__span-93-16"><a id="__codelineno-93-16" name="__codelineno-93-16" href="#__codelineno-93-16"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
</span><span id="__span-93-17"><a id="__codelineno-93-17" name="__codelineno-93-17" href="#__codelineno-93-17"></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">atom_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
</span><span id="__span-93-18"><a id="__codelineno-93-18" name="__codelineno-93-18" href="#__codelineno-93-18"></a>            <span class="c1"># Check all periodic images of atom_j</span>
</span><span id="__span-93-19"><a id="__codelineno-93-19" name="__codelineno-93-19" href="#__codelineno-93-19"></a>            <span class="k">for</span> <span class="n">n1</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="__span-93-20"><a id="__codelineno-93-20" name="__codelineno-93-20" href="#__codelineno-93-20"></a>                <span class="k">for</span> <span class="n">n2</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="__span-93-21"><a id="__codelineno-93-21" name="__codelineno-93-21" href="#__codelineno-93-21"></a>                    <span class="k">for</span> <span class="n">n3</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="__span-93-22"><a id="__codelineno-93-22" name="__codelineno-93-22" href="#__codelineno-93-22"></a>                        <span class="c1"># Skip self-loops (unless different cells)</span>
</span><span id="__span-93-23"><a id="__codelineno-93-23" name="__codelineno-93-23" href="#__codelineno-93-23"></a>                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="__span-93-24"><a id="__codelineno-93-24" name="__codelineno-93-24" href="#__codelineno-93-24"></a>                            <span class="k">continue</span>
</span><span id="__span-93-25"><a id="__codelineno-93-25" name="__codelineno-93-25" href="#__codelineno-93-25"></a>
</span><span id="__span-93-26"><a id="__codelineno-93-26" name="__codelineno-93-26" href="#__codelineno-93-26"></a>                        <span class="c1"># Compute distance through periodic boundaries</span>
</span><span id="__span-93-27"><a id="__codelineno-93-27" name="__codelineno-93-27" href="#__codelineno-93-27"></a>                        <span class="n">image_position</span> <span class="o">=</span> <span class="n">atom_j</span><span class="o">.</span><span class="n">frac_coords</span> <span class="o">+</span> <span class="p">[</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">]</span>
</span><span id="__span-93-28"><a id="__codelineno-93-28" name="__codelineno-93-28" href="#__codelineno-93-28"></a>                        <span class="n">cart_position</span> <span class="o">=</span> <span class="n">lattice</span><span class="o">.</span><span class="n">to_cartesian</span><span class="p">(</span><span class="n">image_position</span><span class="p">)</span>
</span><span id="__span-93-29"><a id="__codelineno-93-29" name="__codelineno-93-29" href="#__codelineno-93-29"></a>                        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
</span><span id="__span-93-30"><a id="__codelineno-93-30" name="__codelineno-93-30" href="#__codelineno-93-30"></a>                            <span class="n">cart_position</span> <span class="o">-</span> <span class="n">lattice</span><span class="o">.</span><span class="n">to_cartesian</span><span class="p">(</span><span class="n">atom_i</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
</span><span id="__span-93-31"><a id="__codelineno-93-31" name="__codelineno-93-31" href="#__codelineno-93-31"></a>                        <span class="p">)</span>
</span><span id="__span-93-32"><a id="__codelineno-93-32" name="__codelineno-93-32" href="#__codelineno-93-32"></a>
</span><span id="__span-93-33"><a id="__codelineno-93-33" name="__codelineno-93-33" href="#__codelineno-93-33"></a>                        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">cutoff_radius</span><span class="p">:</span>
</span><span id="__span-93-34"><a id="__codelineno-93-34" name="__codelineno-93-34" href="#__codelineno-93-34"></a>                            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
</span><span id="__span-93-35"><a id="__codelineno-93-35" name="__codelineno-93-35" href="#__codelineno-93-35"></a>                                <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
</span><span id="__span-93-36"><a id="__codelineno-93-36" name="__codelineno-93-36" href="#__codelineno-93-36"></a>                                <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
</span><span id="__span-93-37"><a id="__codelineno-93-37" name="__codelineno-93-37" href="#__codelineno-93-37"></a>                                <span class="n">cell_offset</span><span class="o">=</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">),</span>  <span class="c1"># Which periodic image</span>
</span><span id="__span-93-38"><a id="__codelineno-93-38" name="__codelineno-93-38" href="#__codelineno-93-38"></a>                                <span class="n">direction</span><span class="o">=</span><span class="n">cart_position</span> <span class="o">-</span> <span class="n">atom_i</span><span class="o">.</span><span class="n">cart_coords</span>
</span><span id="__span-93-39"><a id="__codelineno-93-39" name="__codelineno-93-39" href="#__codelineno-93-39"></a>                            <span class="p">)</span>
</span><span id="__span-93-40"><a id="__codelineno-93-40" name="__codelineno-93-40" href="#__codelineno-93-40"></a>
</span><span id="__span-93-41"><a id="__codelineno-93-41" name="__codelineno-93-41" href="#__codelineno-93-41"></a>    <span class="k">return</span> <span class="n">graph</span>
</span></code></pre></div>
<p><strong>Minimum Image Convention:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a>For each pair of atoms, consider all periodic images
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a>Choose the closest one (minimum distance)
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>Example: 1D crystal with cell size 10 Å
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a>  Atom A at x=1
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>  Atom B at x=9
</span><span id="__span-94-7"><a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a>
</span><span id="__span-94-8"><a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a>  Direct distance: |9-1| = 8 Å
</span><span id="__span-94-9"><a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>  Through boundary: |9-1-10| = 2 Å  ← MINIMUM (use this!)
</span><span id="__span-94-10"><a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a>
</span><span id="__span-94-11"><a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>This handles wrapped distances correctly
</span></code></pre></div>
<p><strong>Challenges:</strong></p>
<ol>
<li><strong>Variable coordination</strong>: Atoms may have different numbers of neighbors</li>
<li><strong>Long-range order</strong>: Some properties depend on distant atoms</li>
<li><strong>Supercell construction</strong>: May need to replicate unit cell for larger cutoffs</li>
</ol>
<h4 id="property__prediction__tasks">Property Prediction Tasks<a class="headerlink" href="#property__prediction__tasks" title="Permanent link">&para;</a></h4>
<p><strong>Electronic Properties</strong></p>
<p>These determine conducting and optical behavior:</p>
<p><strong>1. Band Gap (E_g)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>Definition: Energy difference between valence and conduction bands
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a>Units: eV
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>Range: 0 (metal) to &gt;10 eV (insulator)
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>Applications:
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a>- E_g ≈ 1.3 eV: Solar cells (optimal for sunlight)
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>- E_g &gt; 5 eV: Transparent insulators (windows)
</span><span id="__span-95-8"><a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a>- E_g = 0: Metals (wires, electrodes)
</span><span id="__span-95-9"><a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a>
</span><span id="__span-95-10"><a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a>Prediction challenge: 
</span><span id="__span-95-11"><a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>- DFT often underestimates (by 30-50%)
</span><span id="__span-95-12"><a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a>- GNNs can learn correction factors
</span></code></pre></div></p>
<p><strong>2. Formation Energy (E_f)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>Definition: Energy to form compound from elements
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a>Formula: E_f = E_compound - Σ_i n_i × E_element(i)
</span><span id="__span-96-3"><a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a>Units: eV/atom
</span><span id="__span-96-4"><a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a>
</span><span id="__span-96-5"><a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a>Applications:
</span><span id="__span-96-6"><a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a>- E_f &lt; 0: Thermodynamically stable
</span><span id="__span-96-7"><a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a>- E_f &gt; 0.1 eV/atom: Likely unstable
</span><span id="__span-96-8"><a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a>- Guides synthesis feasibility
</span><span id="__span-96-9"><a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a>
</span><span id="__span-96-10"><a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a>Prediction: Critical for materials discovery
</span></code></pre></div></p>
<p><strong>3. Energy Above Hull (E_hull)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a>Definition: Energy above stable composition convex hull
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a>Measures: Thermodynamic stability relative to competing phases
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a>
</span><span id="__span-97-4"><a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a>E_hull = 0: On convex hull (thermodynamically stable)
</span><span id="__span-97-5"><a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a>E_hull &lt; 0.025 eV/atom: Potentially synthesizable
</span><span id="__span-97-6"><a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a>E_hull &gt; 0.1 eV/atom: Very unlikely to be stable
</span><span id="__span-97-7"><a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a>
</span><span id="__span-97-8"><a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a>Applications:
</span><span id="__span-97-9"><a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a>- Virtual materials screening
</span><span id="__span-97-10"><a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a>- Stability prediction before synthesis
</span></code></pre></div></p>
<p><strong>Mechanical Properties</strong></p>
<p>Determine material strength and elasticity:</p>
<p><strong>1. Bulk Modulus (B)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a>Definition: Resistance to uniform compression
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a>Formula: B = -V (∂P/∂V)_T
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a>Units: GPa
</span><span id="__span-98-4"><a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a>Range: 1 GPa (soft) to 400 GPa (diamond)
</span><span id="__span-98-5"><a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a>
</span><span id="__span-98-6"><a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a>Applications:
</span><span id="__span-98-7"><a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a>- High B: Armor, cutting tools
</span><span id="__span-98-8"><a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a>- Low B: Flexible substrates, cushioning
</span></code></pre></div></p>
<p><strong>2. Shear Modulus (G)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a>Definition: Resistance to shear deformation
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a>Units: GPa
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a>
</span><span id="__span-99-4"><a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>Applications:
</span><span id="__span-99-5"><a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>- G/B ratio indicates ductility
</span><span id="__span-99-6"><a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>- High G: Stiff materials
</span><span id="__span-99-7"><a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a>- Critical for structural applications
</span></code></pre></div></p>
<p><strong>3. Elastic Constants (C_ij)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>Tensor: 6×6 matrix (21 independent components for general case)
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a>Symmetry: Reduces components based on crystal system
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>  - Cubic: 3 independent constants
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a>  - Hexagonal: 5 constants
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a>  - Triclinic: 21 constants
</span><span id="__span-100-6"><a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a>
</span><span id="__span-100-7"><a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a>Applications:
</span><span id="__span-100-8"><a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a>- Full mechanical characterization
</span><span id="__span-100-9"><a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a>- Anisotropic behavior prediction
</span></code></pre></div></p>
<p><strong>Thermodynamic Properties</strong></p>
<p><strong>1. Phonon Properties</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a>Frequency spectrum: Vibrational modes
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a>Heat capacity: C_v(T) from phonons
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a>Thermal expansion: α(T)
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a>Thermal conductivity: κ
</span><span id="__span-101-5"><a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a>
</span><span id="__span-101-6"><a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a>Challenge: Requires dynamical matrix (expensive!)
</span><span id="__span-101-7"><a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a>GNN potential: Fast phonon calculations
</span></code></pre></div></p>
<p><strong>2. Free Energy</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>Temperature-dependent stability
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a>Phase transitions
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>Chemical potential
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>Applications:
</span><span id="__span-102-6"><a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a>- Phase diagram prediction
</span><span id="__span-102-7"><a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>- High-temperature materials
</span></code></pre></div></p>
<h4 id="specialized__architectures">Specialized Architectures<a class="headerlink" href="#specialized__architectures" title="Permanent link">&para;</a></h4>
<p><strong>CGCNN (Crystal Graph Convolutional Neural Networks)</strong></p>
<p>One of the first GNN architectures specifically designed for crystals.</p>
<p><strong>Architecture:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CGCNNConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;CGCNN convolution layer&quot;&quot;&quot;</span>
</span><span id="__span-103-3"><a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_features</span><span class="p">,</span> <span class="n">edge_features</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
</span><span id="__span-103-4"><a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">node_features</span> <span class="o">+</span> <span class="n">edge_features</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
</span><span id="__span-103-5"><a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
</span><span id="__span-103-6"><a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a>
</span><span id="__span-103-7"><a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_attr</span><span class="p">):</span>
</span><span id="__span-103-8"><a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a>        <span class="c1"># For each edge (i → j)</span>
</span><span id="__span-103-9"><a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a>        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">edge_index</span>
</span><span id="__span-103-10"><a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a>
</span><span id="__span-103-11"><a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a>        <span class="c1"># Concatenate: [h_i || h_j || e_ij]</span>
</span><span id="__span-103-12"><a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">edge_attr</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-103-13"><a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a>
</span><span id="__span-103-14"><a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a>        <span class="c1"># Transform and normalize</span>
</span><span id="__span-103-15"><a id="__codelineno-103-15" name="__codelineno-103-15" href="#__codelineno-103-15"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_fc</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span>
</span><span id="__span-103-16"><a id="__codelineno-103-16" name="__codelineno-103-16" href="#__codelineno-103-16"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-103-17"><a id="__codelineno-103-17" name="__codelineno-103-17" href="#__codelineno-103-17"></a>
</span><span id="__span-103-18"><a id="__codelineno-103-18" name="__codelineno-103-18" href="#__codelineno-103-18"></a>        <span class="c1"># Aggregate to each node</span>
</span><span id="__span-103-19"><a id="__codelineno-103-19" name="__codelineno-103-19" href="#__codelineno-103-19"></a>        <span class="c1"># Sum over all incoming edges</span>
</span><span id="__span-103-20"><a id="__codelineno-103-20" name="__codelineno-103-20" href="#__codelineno-103-20"></a>        <span class="n">x_new</span> <span class="o">=</span> <span class="n">scatter_add</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-103-21"><a id="__codelineno-103-21" name="__codelineno-103-21" href="#__codelineno-103-21"></a>
</span><span id="__span-103-22"><a id="__codelineno-103-22" name="__codelineno-103-22" href="#__codelineno-103-22"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x_new</span>  <span class="c1"># Residual connection</span>
</span></code></pre></div>
<p><strong>Key Features:</strong></p>
<ol>
<li>
<p><strong>Distance-based edge weights</strong>:
   <div class="language-python highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">edge_features</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">8.0</span><span class="p">):</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a>    <span class="c1"># Gaussian distance encoding</span>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a>    <span class="n">centers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a>    <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="n">distance</span> <span class="o">-</span> <span class="n">centers</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Pooling for crystal-level properties</strong>:
   <div class="language-python highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="c1"># Average over all atoms</span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="n">h_crystal</span> <span class="o">=</span> <span class="n">global_mean_pool</span><span class="p">(</span><span class="n">h_atoms</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a>
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a><span class="c1"># Or weighted by composition</span>
</span><span id="__span-105-5"><a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a><span class="n">h_crystal</span> <span class="o">=</span> <span class="n">Σ_i</span> <span class="p">(</span><span class="n">n_i</span> <span class="o">/</span> <span class="n">N_total</span><span class="p">)</span> <span class="err">×</span> <span class="n">h_i</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Handling variable composition</strong>:
   <div class="language-python highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="c1"># Works for any stoichiometry</span>
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="c1"># Na₂Cl₂: 2 Na nodes, 2 Cl nodes</span>
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a><span class="c1"># Na₁₀Cl₁₀: 10 Na nodes, 10 Cl nodes</span>
</span><span id="__span-106-4"><a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a><span class="c1"># Same model, different graph sizes</span>
</span></code></pre></div></p>
</li>
</ol>
<p><strong>Training:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="c1"># Dataset: Materials Project</span>
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">CrystalDataset</span><span class="p">(</span><span class="s1">&#39;materials_project&#39;</span><span class="p">)</span>
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a>
</span><span id="__span-107-4"><a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a><span class="n">model</span> <span class="o">=</span> <span class="n">CGCNN</span><span class="p">(</span>
</span><span id="__span-107-5"><a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a>    <span class="n">atom_features</span><span class="o">=</span><span class="mi">92</span><span class="p">,</span>  <span class="c1"># One-hot: 92 elements</span>
</span><span id="__span-107-6"><a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a>    <span class="n">edge_features</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># Gaussian RBFs</span>
</span><span id="__span-107-7"><a id="__codelineno-107-7" name="__codelineno-107-7" href="#__codelineno-107-7"></a>    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="__span-107-8"><a id="__codelineno-107-8" name="__codelineno-107-8" href="#__codelineno-107-8"></a>    <span class="n">num_layers</span><span class="o">=</span><span class="mi">4</span>
</span><span id="__span-107-9"><a id="__codelineno-107-9" name="__codelineno-107-9" href="#__codelineno-107-9"></a><span class="p">)</span>
</span><span id="__span-107-10"><a id="__codelineno-107-10" name="__codelineno-107-10" href="#__codelineno-107-10"></a>
</span><span id="__span-107-11"><a id="__codelineno-107-11" name="__codelineno-107-11" href="#__codelineno-107-11"></a><span class="c1"># Predict formation energy</span>
</span><span id="__span-107-12"><a id="__codelineno-107-12" name="__codelineno-107-12" href="#__codelineno-107-12"></a><span class="k">for</span> <span class="n">crystal_graph</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
</span><span id="__span-107-13"><a id="__codelineno-107-13" name="__codelineno-107-13" href="#__codelineno-107-13"></a>    <span class="n">pred_energy</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">crystal_graph</span><span class="p">)</span>
</span><span id="__span-107-14"><a id="__codelineno-107-14" name="__codelineno-107-14" href="#__codelineno-107-14"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">pred_energy</span><span class="p">,</span> <span class="n">crystal_graph</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Performance:</strong>
- MAE ≈ 0.04 eV/atom for formation energy
- Handles diverse chemistries (metals, semiconductors, insulators)
- Fast: 1000× faster than DFT</p>
<p><strong>MEGNet (MatErials Graph Network)</strong></p>
<p>Multi-level graph network with atom, bond, and global state.</p>
<p><strong>Three-Level Architecture:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a>        ┌─────────────┐
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a>        │ Global State│  (lattice, volume, composition)
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a>        │   g ∈ ℝᵈ    │
</span><span id="__span-108-4"><a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a>        └──────┬──────┘
</span><span id="__span-108-5"><a id="__codelineno-108-5" name="__codelineno-108-5" href="#__codelineno-108-5"></a>               │
</span><span id="__span-108-6"><a id="__codelineno-108-6" name="__codelineno-108-6" href="#__codelineno-108-6"></a>      ┌────────┴────────┐
</span><span id="__span-108-7"><a id="__codelineno-108-7" name="__codelineno-108-7" href="#__codelineno-108-7"></a>      │                 │
</span><span id="__span-108-8"><a id="__codelineno-108-8" name="__codelineno-108-8" href="#__codelineno-108-8"></a>┌─────▼─────┐    ┌──────▼──────┐
</span><span id="__span-108-9"><a id="__codelineno-108-9" name="__codelineno-108-9" href="#__codelineno-108-9"></a>│Atom States│    │ Bond States │
</span><span id="__span-108-10"><a id="__codelineno-108-10" name="__codelineno-108-10" href="#__codelineno-108-10"></a>│  v ∈ ℝᵈ   │◄──►│   e ∈ ℝᵈ    │
</span><span id="__span-108-11"><a id="__codelineno-108-11" name="__codelineno-108-11" href="#__codelineno-108-11"></a>└───────────┘    └─────────────┘
</span></code></pre></div>
<p><strong>Update Rules:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="c1"># Bond update: use atoms + global</span>
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a><span class="n">e_ij</span><span class="s1">&#39; = φ_e([e_ij || v_i || v_j || g])</span>
</span><span id="__span-109-3"><a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a>
</span><span id="__span-109-4"><a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a><span class="c1"># Atom update: aggregate bonds + global  </span>
</span><span id="__span-109-5"><a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a><span class="n">v_i</span><span class="s1">&#39; = φ_v([v_i || Σ_j e_ij&#39;</span> <span class="o">||</span> <span class="n">g</span><span class="p">])</span>
</span><span id="__span-109-6"><a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a>
</span><span id="__span-109-7"><a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a><span class="c1"># Global update: aggregate atoms + bonds</span>
</span><span id="__span-109-8"><a id="__codelineno-109-8" name="__codelineno-109-8" href="#__codelineno-109-8"></a><span class="n">g</span><span class="s1">&#39; = φ_g([g || Σ_i v_i&#39;</span> <span class="o">||</span> <span class="n">Σ_ij</span> <span class="n">e_ij</span><span class="s1">&#39;])</span>
</span></code></pre></div>
<p><strong>Advantages:</strong></p>
<ol>
<li><strong>Multi-scale information</strong>:</li>
<li>Local: Atom and bond features</li>
<li>
<p>Global: Crystal-level properties (volume, space group)</p>
</li>
<li>
<p><strong>Richer representations</strong>:</p>
</li>
<li>Bonds have their own learned features</li>
<li>
<p>Global state captures extensive properties</p>
</li>
<li>
<p><strong>Better for complex properties</strong>:</p>
</li>
<li>Properties that depend on global structure</li>
<li>Example: Thermal conductivity (collective behavior)</li>
</ol>
<p><strong>Applications:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="c1"># Multi-task learning</span>
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="n">model</span> <span class="o">=</span> <span class="n">MEGNet</span><span class="p">(</span><span class="n">tasks</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a>    <span class="s1">&#39;formation_energy&#39;</span><span class="p">,</span>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a>    <span class="s1">&#39;band_gap&#39;</span><span class="p">,</span>
</span><span id="__span-110-5"><a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a>    <span class="s1">&#39;bulk_modulus&#39;</span><span class="p">,</span>
</span><span id="__span-110-6"><a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a>    <span class="s1">&#39;shear_modulus&#39;</span>
</span><span id="__span-110-7"><a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="p">])</span>
</span><span id="__span-110-8"><a id="__codelineno-110-8" name="__codelineno-110-8" href="#__codelineno-110-8"></a>
</span><span id="__span-110-9"><a id="__codelineno-110-9" name="__codelineno-110-9" href="#__codelineno-110-9"></a><span class="c1"># Shared encoder, separate heads</span>
</span><span id="__span-110-10"><a id="__codelineno-110-10" name="__codelineno-110-10" href="#__codelineno-110-10"></a><span class="n">h_shared</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">crystal</span><span class="p">)</span>
</span><span id="__span-110-11"><a id="__codelineno-110-11" name="__codelineno-110-11" href="#__codelineno-110-11"></a><span class="n">E_f</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">head_energy</span><span class="p">(</span><span class="n">h_shared</span><span class="p">)</span>
</span><span id="__span-110-12"><a id="__codelineno-110-12" name="__codelineno-110-12" href="#__codelineno-110-12"></a><span class="n">E_g</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">head_gap</span><span class="p">(</span><span class="n">h_shared</span><span class="p">)</span>
</span><span id="__span-110-13"><a id="__codelineno-110-13" name="__codelineno-110-13" href="#__codelineno-110-13"></a><span class="n">B</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">head_bulk</span><span class="p">(</span><span class="n">h_shared</span><span class="p">)</span>
</span><span id="__span-110-14"><a id="__codelineno-110-14" name="__codelineno-110-14" href="#__codelineno-110-14"></a><span class="n">G</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">head_shear</span><span class="p">(</span><span class="n">h_shared</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>SchNet for Crystals</strong></p>
<p>Adapting continuous filters for periodic systems.</p>
<p><strong>Modifications for Periodicity:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SchNetCrystal</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rbf_expansion</span> <span class="o">=</span> <span class="n">GaussianRBF</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
</span><span id="__span-111-4"><a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
</span><span id="__span-111-5"><a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a>            <span class="n">InteractionBlock</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span><span id="__span-111-6"><a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a>        <span class="p">])</span>
</span><span id="__span-111-7"><a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a>
</span><span id="__span-111-8"><a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crystal</span><span class="p">):</span>
</span><span id="__span-111-9"><a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a>        <span class="c1"># Handle periodic images</span>
</span><span id="__span-111-10"><a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a>        <span class="n">distances</span><span class="p">,</span> <span class="n">cell_offsets</span> <span class="o">=</span> <span class="n">get_neighbor_distances</span><span class="p">(</span>
</span><span id="__span-111-11"><a id="__codelineno-111-11" name="__codelineno-111-11" href="#__codelineno-111-11"></a>            <span class="n">crystal</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span>
</span><span id="__span-111-12"><a id="__codelineno-111-12" name="__codelineno-111-12" href="#__codelineno-111-12"></a>            <span class="n">crystal</span><span class="o">.</span><span class="n">lattice</span><span class="p">,</span>
</span><span id="__span-111-13"><a id="__codelineno-111-13" name="__codelineno-111-13" href="#__codelineno-111-13"></a>            <span class="n">cutoff</span><span class="o">=</span><span class="mf">5.0</span>
</span><span id="__span-111-14"><a id="__codelineno-111-14" name="__codelineno-111-14" href="#__codelineno-111-14"></a>        <span class="p">)</span>
</span><span id="__span-111-15"><a id="__codelineno-111-15" name="__codelineno-111-15" href="#__codelineno-111-15"></a>
</span><span id="__span-111-16"><a id="__codelineno-111-16" name="__codelineno-111-16" href="#__codelineno-111-16"></a>        <span class="c1"># Distance features (same as molecular SchNet)</span>
</span><span id="__span-111-17"><a id="__codelineno-111-17" name="__codelineno-111-17" href="#__codelineno-111-17"></a>        <span class="n">edge_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbf_expansion</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
</span><span id="__span-111-18"><a id="__codelineno-111-18" name="__codelineno-111-18" href="#__codelineno-111-18"></a>
</span><span id="__span-111-19"><a id="__codelineno-111-19" name="__codelineno-111-19" href="#__codelineno-111-19"></a>        <span class="c1"># Message passing with periodic edges</span>
</span><span id="__span-111-20"><a id="__codelineno-111-20" name="__codelineno-111-20" href="#__codelineno-111-20"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">crystal</span><span class="o">.</span><span class="n">atomic_numbers</span><span class="p">)</span>
</span><span id="__span-111-21"><a id="__codelineno-111-21" name="__codelineno-111-21" href="#__codelineno-111-21"></a>        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_blocks</span><span class="p">:</span>
</span><span id="__span-111-22"><a id="__codelineno-111-22" name="__codelineno-111-22" href="#__codelineno-111-22"></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">crystal</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_features</span><span class="p">)</span>
</span><span id="__span-111-23"><a id="__codelineno-111-23" name="__codelineno-111-23" href="#__codelineno-111-23"></a>
</span><span id="__span-111-24"><a id="__codelineno-111-24" name="__codelineno-111-24" href="#__codelineno-111-24"></a>        <span class="c1"># Crystal-level pooling</span>
</span><span id="__span-111-25"><a id="__codelineno-111-25" name="__codelineno-111-25" href="#__codelineno-111-25"></a>        <span class="k">return</span> <span class="n">global_mean_pool</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">crystal</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Handling Variable Unit Cell Size:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="c1"># Challenge: Different crystals have different numbers of atoms</span>
</span><span id="__span-112-2"><a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a><span class="c1"># Solution: Normalization</span>
</span><span id="__span-112-3"><a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a>
</span><span id="__span-112-4"><a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a><span class="c1"># Per-atom properties → extensive</span>
</span><span id="__span-112-5"><a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a><span class="n">energy_per_atom</span> <span class="o">=</span> <span class="n">total_energy</span> <span class="o">/</span> <span class="n">num_atoms</span>
</span><span id="__span-112-6"><a id="__codelineno-112-6" name="__codelineno-112-6" href="#__codelineno-112-6"></a>
</span><span id="__span-112-7"><a id="__codelineno-112-7" name="__codelineno-112-7" href="#__codelineno-112-7"></a><span class="c1"># Or use composition-weighted features</span>
</span><span id="__span-112-8"><a id="__codelineno-112-8" name="__codelineno-112-8" href="#__codelineno-112-8"></a><span class="n">composition</span> <span class="o">=</span> <span class="n">get_composition</span><span class="p">(</span><span class="n">crystal</span><span class="p">)</span>  <span class="c1"># {&#39;Na&#39;: 2, &#39;Cl&#39;: 2}</span>
</span><span id="__span-112-9"><a id="__codelineno-112-9" name="__codelineno-112-9" href="#__codelineno-112-9"></a><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">composition</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">composition</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> 
</span><span id="__span-112-10"><a id="__codelineno-112-10" name="__codelineno-112-10" href="#__codelineno-112-10"></a>           <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">]</span>
</span><span id="__span-112-11"><a id="__codelineno-112-11" name="__codelineno-112-11" href="#__codelineno-112-11"></a><span class="n">h_crystal</span> <span class="o">=</span> <span class="n">Σ_i</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="err">×</span> <span class="n">h_i</span>
</span></code></pre></div>
<p><strong>Allegro / NequIP</strong></p>
<p>State-of-the-art equivariant models for materials.</p>
<p><strong>E(3)-Equivariant Architecture:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">E3NN_Crystal</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-113-2"><a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Based on e3nn library&quot;&quot;&quot;</span>
</span><span id="__span-113-3"><a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-113-4"><a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a>        <span class="c1"># Irreducible representations (irreps)</span>
</span><span id="__span-113-5"><a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a>        <span class="c1"># l=0: scalars (rotation invariant)</span>
</span><span id="__span-113-6"><a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a>        <span class="c1"># l=1: vectors (rotation equivariant)</span>
</span><span id="__span-113-7"><a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a>        <span class="c1"># l=2: rank-2 tensors</span>
</span><span id="__span-113-8"><a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a>
</span><span id="__span-113-9"><a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">irreps_in</span> <span class="o">=</span> <span class="s2">&quot;92x0e&quot;</span>  <span class="c1"># 92 elements, scalar features</span>
</span><span id="__span-113-10"><a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">irreps_hidden</span> <span class="o">=</span> <span class="s2">&quot;128x0e + 64x1o + 32x2e&quot;</span>  <span class="c1"># Mixed irreps</span>
</span><span id="__span-113-11"><a id="__codelineno-113-11" name="__codelineno-113-11" href="#__codelineno-113-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">irreps_out</span> <span class="o">=</span> <span class="s2">&quot;1x0e&quot;</span>  <span class="c1"># Energy (scalar)</span>
</span><span id="__span-113-12"><a id="__codelineno-113-12" name="__codelineno-113-12" href="#__codelineno-113-12"></a>
</span><span id="__span-113-13"><a id="__codelineno-113-13" name="__codelineno-113-13" href="#__codelineno-113-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convolution</span> <span class="o">=</span> <span class="n">E3Convolution</span><span class="p">(</span>
</span><span id="__span-113-14"><a id="__codelineno-113-14" name="__codelineno-113-14" href="#__codelineno-113-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">irreps_in</span><span class="p">,</span> 
</span><span id="__span-113-15"><a id="__codelineno-113-15" name="__codelineno-113-15" href="#__codelineno-113-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">irreps_hidden</span>
</span><span id="__span-113-16"><a id="__codelineno-113-16" name="__codelineno-113-16" href="#__codelineno-113-16"></a>        <span class="p">)</span>
</span><span id="__span-113-17"><a id="__codelineno-113-17" name="__codelineno-113-17" href="#__codelineno-113-17"></a>
</span><span id="__span-113-18"><a id="__codelineno-113-18" name="__codelineno-113-18" href="#__codelineno-113-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crystal</span><span class="p">):</span>
</span><span id="__span-113-19"><a id="__codelineno-113-19" name="__codelineno-113-19" href="#__codelineno-113-19"></a>        <span class="c1"># Features transform correctly under rotations</span>
</span><span id="__span-113-20"><a id="__codelineno-113-20" name="__codelineno-113-20" href="#__codelineno-113-20"></a>        <span class="c1"># Scalars: unchanged</span>
</span><span id="__span-113-21"><a id="__codelineno-113-21" name="__codelineno-113-21" href="#__codelineno-113-21"></a>        <span class="c1"># Vectors: rotate with crystal</span>
</span><span id="__span-113-22"><a id="__codelineno-113-22" name="__codelineno-113-22" href="#__codelineno-113-22"></a>        <span class="c1"># Tensors: rotate as rank-2 tensors</span>
</span><span id="__span-113-23"><a id="__codelineno-113-23" name="__codelineno-113-23" href="#__codelineno-113-23"></a>        <span class="o">...</span>
</span></code></pre></div>
<p><strong>Applications:</strong></p>
<ol>
<li>
<p><strong>Force Field Learning</strong>:
   <div class="language-python highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="c1"># Train on energy and forces</span>
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="n">energy_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">crystal</span><span class="p">)</span>
</span><span id="__span-114-3"><a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a><span class="n">forces_pred</span> <span class="o">=</span> <span class="o">-</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">energy_pred</span><span class="p">,</span> <span class="n">crystal</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
</span><span id="__span-114-4"><a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a>
</span><span id="__span-114-5"><a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a><span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_E</span> <span class="o">*</span> <span class="p">(</span><span class="n">energy_pred</span> <span class="o">-</span> <span class="n">energy_true</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
</span><span id="__span-114-6"><a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a>        <span class="n">w_F</span> <span class="o">*</span> <span class="p">(</span><span class="n">forces_pred</span> <span class="o">-</span> <span class="n">forces_true</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Molecular Dynamics</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a>Learned potential: 1000-10000× faster than DFT
</span><span id="__span-115-2"><a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a>Accuracy: Near DFT quality
</span><span id="__span-115-3"><a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a>Application: Simulate nanoseconds to microseconds
</span></code></pre></div></p>
</li>
<li>
<p><strong>Stress Tensor Prediction</strong>:
   <div class="language-python highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="c1"># Stress tensor: rank-2 equivariant quantity</span>
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a><span class="n">stress</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_stress</span><span class="p">(</span><span class="n">crystal</span><span class="p">)</span>
</span><span id="__span-116-3"><a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a><span class="c1"># Transforms as: σ → Q σ Q^T under rotation Q</span>
</span></code></pre></div></p>
</li>
</ol>
<h4 id="handling__periodicity__technical__details">Handling Periodicity: Technical Details<a class="headerlink" href="#handling__periodicity__technical__details" title="Permanent link">&para;</a></h4>
<p><strong>Minimum Image Convention in Practice:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">minimum_image_distance</span><span class="p">(</span><span class="n">frac_coords_i</span><span class="p">,</span> <span class="n">frac_coords_j</span><span class="p">,</span> <span class="n">lattice</span><span class="p">):</span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a><span class="sd">    Compute minimum distance through periodic boundaries</span>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-117-5"><a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a>    <span class="c1"># Difference in fractional coordinates</span>
</span><span id="__span-117-6"><a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a>    <span class="n">d_frac</span> <span class="o">=</span> <span class="n">frac_coords_j</span> <span class="o">-</span> <span class="n">frac_coords_i</span>
</span><span id="__span-117-7"><a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a>
</span><span id="__span-117-8"><a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a>    <span class="c1"># Wrap to [-0.5, 0.5] (minimum image)</span>
</span><span id="__span-117-9"><a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a>    <span class="n">d_frac</span> <span class="o">=</span> <span class="n">d_frac</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">d_frac</span><span class="p">)</span>
</span><span id="__span-117-10"><a id="__codelineno-117-10" name="__codelineno-117-10" href="#__codelineno-117-10"></a>
</span><span id="__span-117-11"><a id="__codelineno-117-11" name="__codelineno-117-11" href="#__codelineno-117-11"></a>    <span class="c1"># Convert to Cartesian</span>
</span><span id="__span-117-12"><a id="__codelineno-117-12" name="__codelineno-117-12" href="#__codelineno-117-12"></a>    <span class="n">d_cart</span> <span class="o">=</span> <span class="n">lattice</span> <span class="o">@</span> <span class="n">d_frac</span>
</span><span id="__span-117-13"><a id="__codelineno-117-13" name="__codelineno-117-13" href="#__codelineno-117-13"></a>
</span><span id="__span-117-14"><a id="__codelineno-117-14" name="__codelineno-117-14" href="#__codelineno-117-14"></a>    <span class="c1"># Distance</span>
</span><span id="__span-117-15"><a id="__codelineno-117-15" name="__codelineno-117-15" href="#__codelineno-117-15"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d_cart</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Edge Attributes for Periodic Systems:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="n">edge_attr</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a>    <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="n">d_ij</span><span class="p">,</span>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a>    <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">r_j</span> <span class="o">-</span> <span class="n">r_i</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_ij</span><span class="p">,</span>  <span class="c1"># Unit vector</span>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a>    <span class="s1">&#39;cell_offset&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">),</span>      <span class="c1"># Which periodic image</span>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a>    <span class="s1">&#39;is_boundary&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">n1</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Lattice as Global Feature:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="c1"># Include lattice parameters as global features</span>
</span><span id="__span-119-2"><a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="n">lattice_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span>
</span><span id="__span-119-3"><a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a>    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>           <span class="c1"># Lengths</span>
</span><span id="__span-119-4"><a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a>    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="c1"># Angles</span>
</span><span id="__span-119-5"><a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a>    <span class="n">volume</span><span class="p">,</span>            <span class="c1"># Cell volume</span>
</span><span id="__span-119-6"><a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a>    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">volume</span><span class="p">),</span>    <span class="c1"># Log volume (more uniform distribution)</span>
</span><span id="__span-119-7"><a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a><span class="p">])</span>
</span><span id="__span-119-8"><a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a>
</span><span id="__span-119-9"><a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a><span class="c1"># Broadcast to all atoms</span>
</span><span id="__span-119-10"><a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a><span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">crystal</span><span class="p">:</span>
</span><span id="__span-119-11"><a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a>    <span class="n">atom</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">lattice_features</span><span class="p">])</span>
</span></code></pre></div>
<h4 id="applications">Applications<a class="headerlink" href="#applications" title="Permanent link">&para;</a></h4>
<p><strong>Materials Discovery Workflow:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="c1"># 1. Generate candidate structures</span>
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.io.cif</span><span class="w"> </span><span class="kn">import</span> <span class="n">CifWriter</span>
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Structure</span>
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a>
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a><span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="k">for</span> <span class="n">composition</span> <span class="ow">in</span> <span class="n">element_combinations</span><span class="p">:</span>
</span><span id="__span-120-7"><a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a>    <span class="k">for</span> <span class="n">prototype</span> <span class="ow">in</span> <span class="n">common_structures</span><span class="p">:</span>
</span><span id="__span-120-8"><a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a>        <span class="n">structure</span> <span class="o">=</span> <span class="n">substitute</span><span class="p">(</span><span class="n">prototype</span><span class="p">,</span> <span class="n">composition</span><span class="p">)</span>
</span><span id="__span-120-9"><a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a>        <span class="k">if</span> <span class="n">is_reasonable</span><span class="p">(</span><span class="n">structure</span><span class="p">):</span>  <span class="c1"># Basic filters</span>
</span><span id="__span-120-10"><a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a>            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
</span><span id="__span-120-11"><a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a>
</span><span id="__span-120-12"><a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="si">}</span><span class="s2"> candidates&quot;</span><span class="p">)</span>  <span class="c1"># ~10⁶</span>
</span><span id="__span-120-13"><a id="__codelineno-120-13" name="__codelineno-120-13" href="#__codelineno-120-13"></a>
</span><span id="__span-120-14"><a id="__codelineno-120-14" name="__codelineno-120-14" href="#__codelineno-120-14"></a><span class="c1"># 2. Screen with GNN</span>
</span><span id="__span-120-15"><a id="__codelineno-120-15" name="__codelineno-120-15" href="#__codelineno-120-15"></a><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;megnet_bandgap.pt&#39;</span><span class="p">)</span>
</span><span id="__span-120-16"><a id="__codelineno-120-16" name="__codelineno-120-16" href="#__codelineno-120-16"></a>
</span><span id="__span-120-17"><a id="__codelineno-120-17" name="__codelineno-120-17" href="#__codelineno-120-17"></a><span class="n">promising</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-120-18"><a id="__codelineno-120-18" name="__codelineno-120-18" href="#__codelineno-120-18"></a><span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
</span><span id="__span-120-19"><a id="__codelineno-120-19" name="__codelineno-120-19" href="#__codelineno-120-19"></a>    <span class="n">graph</span> <span class="o">=</span> <span class="n">structure_to_graph</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
</span><span id="__span-120-20"><a id="__codelineno-120-20" name="__codelineno-120-20" href="#__codelineno-120-20"></a>    <span class="n">E_g</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
</span><span id="__span-120-21"><a id="__codelineno-120-21" name="__codelineno-120-21" href="#__codelineno-120-21"></a>
</span><span id="__span-120-22"><a id="__codelineno-120-22" name="__codelineno-120-22" href="#__codelineno-120-22"></a>    <span class="k">if</span> <span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">E_g</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">:</span>  <span class="c1"># Target range for solar cells</span>
</span><span id="__span-120-23"><a id="__codelineno-120-23" name="__codelineno-120-23" href="#__codelineno-120-23"></a>        <span class="n">promising</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">structure</span><span class="p">,</span> <span class="n">E_g</span><span class="p">))</span>
</span><span id="__span-120-24"><a id="__codelineno-120-24" name="__codelineno-120-24" href="#__codelineno-120-24"></a>
</span><span id="__span-120-25"><a id="__codelineno-120-25" name="__codelineno-120-25" href="#__codelineno-120-25"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">promising</span><span class="p">)</span><span class="si">}</span><span class="s2"> promising candidates&quot;</span><span class="p">)</span>  <span class="c1"># ~10³</span>
</span><span id="__span-120-26"><a id="__codelineno-120-26" name="__codelineno-120-26" href="#__codelineno-120-26"></a>
</span><span id="__span-120-27"><a id="__codelineno-120-27" name="__codelineno-120-27" href="#__codelineno-120-27"></a><span class="c1"># 3. Refine with DFT</span>
</span><span id="__span-120-28"><a id="__codelineno-120-28" name="__codelineno-120-28" href="#__codelineno-120-28"></a><span class="k">for</span> <span class="n">structure</span><span class="p">,</span> <span class="n">E_g_predicted</span> <span class="ow">in</span> <span class="n">promising</span><span class="p">[:</span><span class="mi">100</span><span class="p">]:</span>  <span class="c1"># Top 100</span>
</span><span id="__span-120-29"><a id="__codelineno-120-29" name="__codelineno-120-29" href="#__codelineno-120-29"></a>    <span class="n">E_g_dft</span> <span class="o">=</span> <span class="n">run_dft</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>  <span class="c1"># Expensive but accurate</span>
</span><span id="__span-120-30"><a id="__codelineno-120-30" name="__codelineno-120-30" href="#__codelineno-120-30"></a>
</span><span id="__span-120-31"><a id="__codelineno-120-31" name="__codelineno-120-31" href="#__codelineno-120-31"></a>    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">E_g_dft</span> <span class="o">-</span> <span class="n">E_g_predicted</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
</span><span id="__span-120-32"><a id="__codelineno-120-32" name="__codelineno-120-32" href="#__codelineno-120-32"></a>        <span class="c1"># GNN was accurate!</span>
</span><span id="__span-120-33"><a id="__codelineno-120-33" name="__codelineno-120-33" href="#__codelineno-120-33"></a>        <span class="n">save_for_synthesis</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
</span><span id="__span-120-34"><a id="__codelineno-120-34" name="__codelineno-120-34" href="#__codelineno-120-34"></a>
</span><span id="__span-120-35"><a id="__codelineno-120-35" name="__codelineno-120-35" href="#__codelineno-120-35"></a><span class="c1"># 4. Experimental synthesis (top 10)</span>
</span></code></pre></div>
<p><strong>Process Optimization:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="c1"># Predict stability under different conditions</span>
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">predict_stability_map</span><span class="p">(</span><span class="n">composition</span><span class="p">):</span>
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>    <span class="n">structures</span> <span class="o">=</span> <span class="n">generate_polymorphs</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a>    <span class="n">temperatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># K</span>
</span><span id="__span-121-6"><a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a>    <span class="n">pressures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># GPa</span>
</span><span id="__span-121-7"><a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a>
</span><span id="__span-121-8"><a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a>    <span class="n">phase_diagram</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pressures</span><span class="p">)))</span>
</span><span id="__span-121-9"><a id="__codelineno-121-9" name="__codelineno-121-9" href="#__codelineno-121-9"></a>
</span><span id="__span-121-10"><a id="__codelineno-121-10" name="__codelineno-121-10" href="#__codelineno-121-10"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">temperatures</span><span class="p">):</span>
</span><span id="__span-121-11"><a id="__codelineno-121-11" name="__codelineno-121-11" href="#__codelineno-121-11"></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">P</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pressures</span><span class="p">):</span>
</span><span id="__span-121-12"><a id="__codelineno-121-12" name="__codelineno-121-12" href="#__codelineno-121-12"></a>            <span class="n">energies</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-121-13"><a id="__codelineno-121-13" name="__codelineno-121-13" href="#__codelineno-121-13"></a>                <span class="n">model</span><span class="o">.</span><span class="n">predict_free_energy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span> 
</span><span id="__span-121-14"><a id="__codelineno-121-14" name="__codelineno-121-14" href="#__codelineno-121-14"></a>                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">structures</span>
</span><span id="__span-121-15"><a id="__codelineno-121-15" name="__codelineno-121-15" href="#__codelineno-121-15"></a>            <span class="p">]</span>
</span><span id="__span-121-16"><a id="__codelineno-121-16" name="__codelineno-121-16" href="#__codelineno-121-16"></a>            <span class="n">phase_diagram</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
</span><span id="__span-121-17"><a id="__codelineno-121-17" name="__codelineno-121-17" href="#__codelineno-121-17"></a>
</span><span id="__span-121-18"><a id="__codelineno-121-18" name="__codelineno-121-18" href="#__codelineno-121-18"></a>    <span class="k">return</span> <span class="n">phase_diagram</span>
</span></code></pre></div>
<p><strong>Doping and Substitution:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="c1"># Explore chemical substitutions</span>
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a><span class="n">base_structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s1">&#39;LiFePO4.cif&#39;</span><span class="p">)</span>
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>
</span><span id="__span-122-4"><a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a><span class="k">for</span> <span class="n">dopant</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">]:</span>
</span><span id="__span-122-5"><a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">iron_sites</span><span class="p">:</span>
</span><span id="__span-122-6"><a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a>        <span class="n">doped</span> <span class="o">=</span> <span class="n">base_structure</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-122-7"><a id="__codelineno-122-7" name="__codelineno-122-7" href="#__codelineno-122-7"></a>        <span class="n">doped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">dopant</span><span class="p">)</span>
</span><span id="__span-122-8"><a id="__codelineno-122-8" name="__codelineno-122-8" href="#__codelineno-122-8"></a>
</span><span id="__span-122-9"><a id="__codelineno-122-9" name="__codelineno-122-9" href="#__codelineno-122-9"></a>        <span class="c1"># Predict properties of doped material</span>
</span><span id="__span-122-10"><a id="__codelineno-122-10" name="__codelineno-122-10" href="#__codelineno-122-10"></a>        <span class="n">E_g</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">doped</span><span class="p">,</span> <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;band_gap&#39;</span><span class="p">)</span>
</span><span id="__span-122-11"><a id="__codelineno-122-11" name="__codelineno-122-11" href="#__codelineno-122-11"></a>        <span class="n">conductivity</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">doped</span><span class="p">,</span> <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;ionic_conductivity&#39;</span><span class="p">)</span>
</span><span id="__span-122-12"><a id="__codelineno-122-12" name="__codelineno-122-12" href="#__codelineno-122-12"></a>
</span><span id="__span-122-13"><a id="__codelineno-122-13" name="__codelineno-122-13" href="#__codelineno-122-13"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Li</span><span class="si">{</span><span class="n">dopant</span><span class="si">}</span><span class="s2">PO4: E_g=</span><span class="si">{</span><span class="n">E_g</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> eV, σ=</span><span class="si">{</span><span class="n">conductivity</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> S/cm&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Catalysis Applications:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="c1"># Surface models for catalysis</span>
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">model_surface</span><span class="p">(</span><span class="n">bulk_structure</span><span class="p">,</span> <span class="n">miller_indices</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)):</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a>    <span class="c1"># Create surface slab</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a>    <span class="n">slab</span> <span class="o">=</span> <span class="n">bulk_structure</span><span class="o">.</span><span class="n">get_surface</span><span class="p">(</span><span class="n">miller_indices</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="__span-123-5"><a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a>
</span><span id="__span-123-6"><a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a>    <span class="c1"># Add adsorbate</span>
</span><span id="__span-123-7"><a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a>    <span class="n">adsorbate</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">([</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.74</span><span class="p">]])</span>
</span><span id="__span-123-8"><a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a>    <span class="n">slab_with_ads</span> <span class="o">=</span> <span class="n">add_adsorbate</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">adsorbate</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="s1">&#39;ontop&#39;</span><span class="p">)</span>
</span><span id="__span-123-9"><a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a>
</span><span id="__span-123-10"><a id="__codelineno-123-10" name="__codelineno-123-10" href="#__codelineno-123-10"></a>    <span class="c1"># Predict adsorption energy</span>
</span><span id="__span-123-11"><a id="__codelineno-123-11" name="__codelineno-123-11" href="#__codelineno-123-11"></a>    <span class="n">E_slab</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_energy</span><span class="p">(</span><span class="n">slab</span><span class="p">)</span>
</span><span id="__span-123-12"><a id="__codelineno-123-12" name="__codelineno-123-12" href="#__codelineno-123-12"></a>    <span class="n">E_slab_ads</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_energy</span><span class="p">(</span><span class="n">slab_with_ads</span><span class="p">)</span>
</span><span id="__span-123-13"><a id="__codelineno-123-13" name="__codelineno-123-13" href="#__codelineno-123-13"></a>    <span class="n">E_H2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_energy</span><span class="p">(</span><span class="n">adsorbate</span><span class="p">)</span>
</span><span id="__span-123-14"><a id="__codelineno-123-14" name="__codelineno-123-14" href="#__codelineno-123-14"></a>
</span><span id="__span-123-15"><a id="__codelineno-123-15" name="__codelineno-123-15" href="#__codelineno-123-15"></a>    <span class="n">E_ads</span> <span class="o">=</span> <span class="n">E_slab_ads</span> <span class="o">-</span> <span class="n">E_slab</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">E_H2</span>
</span><span id="__span-123-16"><a id="__codelineno-123-16" name="__codelineno-123-16" href="#__codelineno-123-16"></a>    <span class="k">return</span> <span class="n">E_ads</span>
</span></code></pre></div>
<h4 id="challenges__and__future__directions">Challenges and Future Directions<a class="headerlink" href="#challenges__and__future__directions" title="Permanent link">&para;</a></h4>
<p><strong>Current Limitations:</strong></p>
<ol>
<li><strong>Size limitations</strong>: Most models use small unit cells</li>
<li>Typical: 10-50 atoms</li>
<li>
<p>Real systems: Can have 100-1000 atoms (supercells, defects)</p>
</li>
<li>
<p><strong>Accuracy vs speed trade-off</strong>:</p>
</li>
<li>GNNs: Fast but ~10% error</li>
<li>DFT: Slow but ~1% error</li>
<li>
<p>Need: Fast AND accurate</p>
</li>
<li>
<p><strong>Out-of-distribution generalization</strong>:</p>
</li>
<li>Models trained on known materials</li>
<li>May fail on truly novel chemistries</li>
<li>Active learning can help</li>
</ol>
<p><strong>Emerging Directions:</strong></p>
<ol>
<li>
<p><strong>Foundation Models</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a>Pre-train on ALL known structures (~200K)
</span><span id="__span-124-2"><a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a>Transfer to specific tasks
</span><span id="__span-124-3"><a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a>Few-shot learning for new properties
</span></code></pre></div></p>
</li>
<li>
<p><strong>Inverse Design</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a>Input: Desired properties (E_g=1.3 eV, stable, earth-abundant)
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a>Output: Candidate structures
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a>Challenge: Generative models for crystals
</span></code></pre></div></p>
</li>
<li>
<p><strong>Multi-fidelity Learning</strong>:
   <div class="language-text highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a>Low-fidelity: GNN predictions (fast, many)
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a>High-fidelity: DFT calculations (slow, few)
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a>Combine: Bayesian optimization, active learning
</span></code></pre></div></p>
</li>
<li>
<p><strong>Uncertainty Quantification</strong>:
   <div class="language-python highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_with_uncertainty</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a><span class="k">if</span> <span class="n">uncertainty</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-127-4"><a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a>    <span class="c1"># High confidence, trust prediction</span>
</span><span id="__span-127-5"><a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a>    <span class="n">use_prediction</span><span class="p">()</span>
</span><span id="__span-127-6"><a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-127-7"><a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a>    <span class="c1"># Low confidence, run DFT</span>
</span><span id="__span-127-8"><a id="__codelineno-127-8" name="__codelineno-127-8" href="#__codelineno-127-8"></a>    <span class="n">run_dft_calculation</span><span class="p">()</span>
</span></code></pre></div></p>
</li>
</ol>
<hr />
<h3 id="6__practical__building__a__gat__for__qm9__dataset">6. Practical: Building a GAT for QM9 Dataset<a class="headerlink" href="#6__practical__building__a__gat__for__qm9__dataset" title="Permanent link">&para;</a></h3>
<p>In this hands-on session, we&rsquo;ll build a Graph Attention Network to predict molecular properties on the QM9 dataset. This practical will cover the complete workflow from data loading to model evaluation and interpretation.</p>
<h4 id="dataset__overview">Dataset Overview<a class="headerlink" href="#dataset__overview" title="Permanent link">&para;</a></h4>
<p><strong>QM9 Dataset:</strong></p>
<p>The QM9 dataset is a quantum chemistry benchmark containing:
- <strong>134,000 small organic molecules</strong> (subset of GDB-17 database)
- <strong>Up to 9 heavy atoms</strong> (C, O, N, F) - excludes hydrogen in counting
- <strong>19 regression targets</strong> computed with Density Functional Theory (DFT)
- <strong>3D molecular geometries</strong> with optimized coordinates</p>
<p><strong>Target Properties:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a>Index  Property                          Units        Typical Range
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a>0      Dipole moment                     D            0-5
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a>1      Isotropic polarizability          a₀³          10-100  
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a>2      HOMO energy                       eV           -12 to -5
</span><span id="__span-128-5"><a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a>3      LUMO energy                       eV           -5 to 5
</span><span id="__span-128-6"><a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a>4      HOMO-LUMO gap                     eV           2-15
</span><span id="__span-128-7"><a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a>5      Electronic spatial extent         a₀²          200-1500
</span><span id="__span-128-8"><a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a>6      Zero-point vibrational energy     eV           0.5-3.0
</span><span id="__span-128-9"><a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a>7      Internal energy (0K)              eV           -100 to 0
</span><span id="__span-128-10"><a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a>8      Internal energy (298K)            eV           -100 to 0
</span><span id="__span-128-11"><a id="__codelineno-128-11" name="__codelineno-128-11" href="#__codelineno-128-11"></a>9      Enthalpy (298K)                   eV           -100 to 0
</span><span id="__span-128-12"><a id="__codelineno-128-12" name="__codelineno-128-12" href="#__codelineno-128-12"></a>10     Free energy (298K)                eV           -100 to 0
</span><span id="__span-128-13"><a id="__codelineno-128-13" name="__codelineno-128-13" href="#__codelineno-128-13"></a>11     Heat capacity (298K)              cal/mol/K    10-40
</span><span id="__span-128-14"><a id="__codelineno-128-14" name="__codelineno-128-14" href="#__codelineno-128-14"></a>12     Atomization energy (0K)           eV           -100 to 0
</span><span id="__span-128-15"><a id="__codelineno-128-15" name="__codelineno-128-15" href="#__codelineno-128-15"></a>13     Atomization energy (298K)         eV           -100 to 0
</span><span id="__span-128-16"><a id="__codelineno-128-16" name="__codelineno-128-16" href="#__codelineno-128-16"></a>14-18  Rotational constants A,B,C        GHz          Various
</span></code></pre></div>
<p><strong>Why QM9 is Important:</strong></p>
<ol>
<li><strong>Benchmark standard</strong>: Most papers report QM9 results</li>
<li><strong>Diverse chemistry</strong>: Various functional groups and structures</li>
<li><strong>Ground truth quality</strong>: High-level DFT calculations (B3LYP/6-31G(2df,p))</li>
<li><strong>Moderate size</strong>: Large enough to train deep models, small enough to iterate quickly</li>
<li><strong>Multi-task learning</strong>: 19 targets allow testing generalization</li>
</ol>
<p><strong>Data Format:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="c1"># Each molecule has:</span>
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a><span class="n">molecule</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-129-3"><a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a>    <span class="s1">&#39;num_atoms&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
</span><span id="__span-129-4"><a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a>    <span class="s1">&#39;atomic_numbers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>  <span class="c1"># Element types</span>
</span><span id="__span-129-5"><a id="__codelineno-129-5" name="__codelineno-129-5" href="#__codelineno-129-5"></a>    <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">z2</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>  <span class="c1"># 3D coordinates (Å)</span>
</span><span id="__span-129-6"><a id="__codelineno-129-6" name="__codelineno-129-6" href="#__codelineno-129-6"></a>    <span class="s1">&#39;edge_index&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>  <span class="c1"># Bond connectivity</span>
</span><span id="__span-129-7"><a id="__codelineno-129-7" name="__codelineno-129-7" href="#__codelineno-129-7"></a>    <span class="s1">&#39;edge_attr&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>  <span class="c1"># Bond types (1=single, 2=double, 3=triple)</span>
</span><span id="__span-129-8"><a id="__codelineno-129-8" name="__codelineno-129-8" href="#__codelineno-129-8"></a>    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.7</span><span class="p">,</span> <span class="mf">48.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.8</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>  <span class="c1"># 19 target properties</span>
</span><span id="__span-129-9"><a id="__codelineno-129-9" name="__codelineno-129-9" href="#__codelineno-129-9"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="implementation__steps">Implementation Steps<a class="headerlink" href="#implementation__steps" title="Permanent link">&para;</a></h4>
<p><strong>Step 1: Data Loading and Preprocessing</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-130-3"><a id="__codelineno-130-3" name="__codelineno-130-3" href="#__codelineno-130-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
</span><span id="__span-130-4"><a id="__codelineno-130-4" name="__codelineno-130-4" href="#__codelineno-130-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">QM9</span>
</span><span id="__span-130-5"><a id="__codelineno-130-5" name="__codelineno-130-5" href="#__codelineno-130-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
</span><span id="__span-130-6"><a id="__codelineno-130-6" name="__codelineno-130-6" href="#__codelineno-130-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">GATConv</span><span class="p">,</span> <span class="n">global_mean_pool</span><span class="p">,</span> <span class="n">global_add_pool</span>
</span><span id="__span-130-7"><a id="__codelineno-130-7" name="__codelineno-130-7" href="#__codelineno-130-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-130-8"><a id="__codelineno-130-8" name="__codelineno-130-8" href="#__codelineno-130-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span>
</span><span id="__span-130-9"><a id="__codelineno-130-9" name="__codelineno-130-9" href="#__codelineno-130-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-130-10"><a id="__codelineno-130-10" name="__codelineno-130-10" href="#__codelineno-130-10"></a>
</span><span id="__span-130-11"><a id="__codelineno-130-11" name="__codelineno-130-11" href="#__codelineno-130-11"></a><span class="c1"># Set random seeds for reproducibility</span>
</span><span id="__span-130-12"><a id="__codelineno-130-12" name="__codelineno-130-12" href="#__codelineno-130-12"></a><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-130-13"><a id="__codelineno-130-13" name="__codelineno-130-13" href="#__codelineno-130-13"></a><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-130-14"><a id="__codelineno-130-14" name="__codelineno-130-14" href="#__codelineno-130-14"></a>
</span><span id="__span-130-15"><a id="__codelineno-130-15" name="__codelineno-130-15" href="#__codelineno-130-15"></a><span class="c1"># Load QM9 dataset</span>
</span><span id="__span-130-16"><a id="__codelineno-130-16" name="__codelineno-130-16" href="#__codelineno-130-16"></a><span class="c1"># This will download ~200MB on first run</span>
</span><span id="__span-130-17"><a id="__codelineno-130-17" name="__codelineno-130-17" href="#__codelineno-130-17"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading QM9 dataset...&quot;</span><span class="p">)</span>
</span><span id="__span-130-18"><a id="__codelineno-130-18" name="__codelineno-130-18" href="#__codelineno-130-18"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">QM9</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data/QM9&#39;</span><span class="p">)</span>
</span><span id="__span-130-19"><a id="__codelineno-130-19" name="__codelineno-130-19" href="#__codelineno-130-19"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total molecules: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-20"><a id="__codelineno-130-20" name="__codelineno-130-20" href="#__codelineno-130-20"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of features: </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-21"><a id="__codelineno-130-21" name="__codelineno-130-21" href="#__codelineno-130-21"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of targets: </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_tasks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-22"><a id="__codelineno-130-22" name="__codelineno-130-22" href="#__codelineno-130-22"></a>
</span><span id="__span-130-23"><a id="__codelineno-130-23" name="__codelineno-130-23" href="#__codelineno-130-23"></a><span class="c1"># Select target property to predict</span>
</span><span id="__span-130-24"><a id="__codelineno-130-24" name="__codelineno-130-24" href="#__codelineno-130-24"></a><span class="c1"># Let&#39;s predict HOMO energy (index 2)</span>
</span><span id="__span-130-25"><a id="__codelineno-130-25" name="__codelineno-130-25" href="#__codelineno-130-25"></a><span class="n">target_idx</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-130-26"><a id="__codelineno-130-26" name="__codelineno-130-26" href="#__codelineno-130-26"></a><span class="n">target_name</span> <span class="o">=</span> <span class="s1">&#39;HOMO_energy&#39;</span>
</span><span id="__span-130-27"><a id="__codelineno-130-27" name="__codelineno-130-27" href="#__codelineno-130-27"></a>
</span><span id="__span-130-28"><a id="__codelineno-130-28" name="__codelineno-130-28" href="#__codelineno-130-28"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Target: </span><span class="si">{</span><span class="n">target_name</span><span class="si">}</span><span class="s2"> (index </span><span class="si">{</span><span class="n">target_idx</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="__span-130-29"><a id="__codelineno-130-29" name="__codelineno-130-29" href="#__codelineno-130-29"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="w"> </span><span class="n">target_idx</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-30"><a id="__codelineno-130-30" name="__codelineno-130-30" href="#__codelineno-130-30"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Std: </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="w"> </span><span class="n">target_idx</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-31"><a id="__codelineno-130-31" name="__codelineno-130-31" href="#__codelineno-130-31"></a>
</span><span id="__span-130-32"><a id="__codelineno-130-32" name="__codelineno-130-32" href="#__codelineno-130-32"></a><span class="c1"># Examine a sample molecule</span>
</span><span id="__span-130-33"><a id="__codelineno-130-33" name="__codelineno-130-33" href="#__codelineno-130-33"></a><span class="n">sample</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-130-34"><a id="__codelineno-130-34" name="__codelineno-130-34" href="#__codelineno-130-34"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample molecule:&quot;</span><span class="p">)</span>
</span><span id="__span-130-35"><a id="__codelineno-130-35" name="__codelineno-130-35" href="#__codelineno-130-35"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of atoms: </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">num_nodes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-36"><a id="__codelineno-130-36" name="__codelineno-130-36" href="#__codelineno-130-36"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of bonds: </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">num_edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-37"><a id="__codelineno-130-37" name="__codelineno-130-37" href="#__codelineno-130-37"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Node features shape: </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-38"><a id="__codelineno-130-38" name="__codelineno-130-38" href="#__codelineno-130-38"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Edge indices shape: </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-39"><a id="__codelineno-130-39" name="__codelineno-130-39" href="#__codelineno-130-39"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Target values: </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-40"><a id="__codelineno-130-40" name="__codelineno-130-40" href="#__codelineno-130-40"></a>
</span><span id="__span-130-41"><a id="__codelineno-130-41" name="__codelineno-130-41" href="#__codelineno-130-41"></a><span class="c1"># Split dataset (80% train, 10% validation, 10% test)</span>
</span><span id="__span-130-42"><a id="__codelineno-130-42" name="__codelineno-130-42" href="#__codelineno-130-42"></a><span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
</span><span id="__span-130-43"><a id="__codelineno-130-43" name="__codelineno-130-43" href="#__codelineno-130-43"></a><span class="n">val_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
</span><span id="__span-130-44"><a id="__codelineno-130-44" name="__codelineno-130-44" href="#__codelineno-130-44"></a><span class="n">test_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span> <span class="o">-</span> <span class="n">val_size</span>
</span><span id="__span-130-45"><a id="__codelineno-130-45" name="__codelineno-130-45" href="#__codelineno-130-45"></a>
</span><span id="__span-130-46"><a id="__codelineno-130-46" name="__codelineno-130-46" href="#__codelineno-130-46"></a><span class="c1"># Use specific indices to ensure consistent splits</span>
</span><span id="__span-130-47"><a id="__codelineno-130-47" name="__codelineno-130-47" href="#__codelineno-130-47"></a><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
</span><span id="__span-130-48"><a id="__codelineno-130-48" name="__codelineno-130-48" href="#__codelineno-130-48"></a><span class="n">val_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">train_size</span><span class="p">:</span><span class="n">train_size</span> <span class="o">+</span> <span class="n">val_size</span><span class="p">]</span>
</span><span id="__span-130-49"><a id="__codelineno-130-49" name="__codelineno-130-49" href="#__codelineno-130-49"></a><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">train_size</span> <span class="o">+</span> <span class="n">val_size</span><span class="p">:]</span>
</span><span id="__span-130-50"><a id="__codelineno-130-50" name="__codelineno-130-50" href="#__codelineno-130-50"></a>
</span><span id="__span-130-51"><a id="__codelineno-130-51" name="__codelineno-130-51" href="#__codelineno-130-51"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dataset splits:&quot;</span><span class="p">)</span>
</span><span id="__span-130-52"><a id="__codelineno-130-52" name="__codelineno-130-52" href="#__codelineno-130-52"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> molecules&quot;</span><span class="p">)</span>
</span><span id="__span-130-53"><a id="__codelineno-130-53" name="__codelineno-130-53" href="#__codelineno-130-53"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> molecules&quot;</span><span class="p">)</span>
</span><span id="__span-130-54"><a id="__codelineno-130-54" name="__codelineno-130-54" href="#__codelineno-130-54"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> molecules&quot;</span><span class="p">)</span>
</span><span id="__span-130-55"><a id="__codelineno-130-55" name="__codelineno-130-55" href="#__codelineno-130-55"></a>
</span><span id="__span-130-56"><a id="__codelineno-130-56" name="__codelineno-130-56" href="#__codelineno-130-56"></a><span class="c1"># Compute normalization statistics from training set only</span>
</span><span id="__span-130-57"><a id="__codelineno-130-57" name="__codelineno-130-57" href="#__codelineno-130-57"></a><span class="c1"># This prevents data leakage</span>
</span><span id="__span-130-58"><a id="__codelineno-130-58" name="__codelineno-130-58" href="#__codelineno-130-58"></a><span class="n">y_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">train_dataset</span><span class="p">])</span>
</span><span id="__span-130-59"><a id="__codelineno-130-59" name="__codelineno-130-59" href="#__codelineno-130-59"></a><span class="n">target_mean</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="__span-130-60"><a id="__codelineno-130-60" name="__codelineno-130-60" href="#__codelineno-130-60"></a><span class="n">target_std</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="__span-130-61"><a id="__codelineno-130-61" name="__codelineno-130-61" href="#__codelineno-130-61"></a>
</span><span id="__span-130-62"><a id="__codelineno-130-62" name="__codelineno-130-62" href="#__codelineno-130-62"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalization (from train set):&quot;</span><span class="p">)</span>
</span><span id="__span-130-63"><a id="__codelineno-130-63" name="__codelineno-130-63" href="#__codelineno-130-63"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">target_mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-64"><a id="__codelineno-130-64" name="__codelineno-130-64" href="#__codelineno-130-64"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std: </span><span class="si">{</span><span class="n">target_std</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-65"><a id="__codelineno-130-65" name="__codelineno-130-65" href="#__codelineno-130-65"></a>
</span><span id="__span-130-66"><a id="__codelineno-130-66" name="__codelineno-130-66" href="#__codelineno-130-66"></a><span class="c1"># Create data loaders</span>
</span><span id="__span-130-67"><a id="__codelineno-130-67" name="__codelineno-130-67" href="#__codelineno-130-67"></a><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="__span-130-68"><a id="__codelineno-130-68" name="__codelineno-130-68" href="#__codelineno-130-68"></a>
</span><span id="__span-130-69"><a id="__codelineno-130-69" name="__codelineno-130-69" href="#__codelineno-130-69"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
</span><span id="__span-130-70"><a id="__codelineno-130-70" name="__codelineno-130-70" href="#__codelineno-130-70"></a>    <span class="n">train_dataset</span><span class="p">,</span> 
</span><span id="__span-130-71"><a id="__codelineno-130-71" name="__codelineno-130-71" href="#__codelineno-130-71"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
</span><span id="__span-130-72"><a id="__codelineno-130-72" name="__codelineno-130-72" href="#__codelineno-130-72"></a>    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Shuffle training data</span>
</span><span id="__span-130-73"><a id="__codelineno-130-73" name="__codelineno-130-73" href="#__codelineno-130-73"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span>  <span class="c1"># Parallel data loading</span>
</span><span id="__span-130-74"><a id="__codelineno-130-74" name="__codelineno-130-74" href="#__codelineno-130-74"></a><span class="p">)</span>
</span><span id="__span-130-75"><a id="__codelineno-130-75" name="__codelineno-130-75" href="#__codelineno-130-75"></a><span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
</span><span id="__span-130-76"><a id="__codelineno-130-76" name="__codelineno-130-76" href="#__codelineno-130-76"></a>    <span class="n">val_dataset</span><span class="p">,</span> 
</span><span id="__span-130-77"><a id="__codelineno-130-77" name="__codelineno-130-77" href="#__codelineno-130-77"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-130-78"><a id="__codelineno-130-78" name="__codelineno-130-78" href="#__codelineno-130-78"></a>    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-130-79"><a id="__codelineno-130-79" name="__codelineno-130-79" href="#__codelineno-130-79"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span>
</span><span id="__span-130-80"><a id="__codelineno-130-80" name="__codelineno-130-80" href="#__codelineno-130-80"></a><span class="p">)</span>
</span><span id="__span-130-81"><a id="__codelineno-130-81" name="__codelineno-130-81" href="#__codelineno-130-81"></a><span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
</span><span id="__span-130-82"><a id="__codelineno-130-82" name="__codelineno-130-82" href="#__codelineno-130-82"></a>    <span class="n">test_dataset</span><span class="p">,</span> 
</span><span id="__span-130-83"><a id="__codelineno-130-83" name="__codelineno-130-83" href="#__codelineno-130-83"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-130-84"><a id="__codelineno-130-84" name="__codelineno-130-84" href="#__codelineno-130-84"></a>    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-130-85"><a id="__codelineno-130-85" name="__codelineno-130-85" href="#__codelineno-130-85"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span>
</span><span id="__span-130-86"><a id="__codelineno-130-86" name="__codelineno-130-86" href="#__codelineno-130-86"></a><span class="p">)</span>
</span><span id="__span-130-87"><a id="__codelineno-130-87" name="__codelineno-130-87" href="#__codelineno-130-87"></a>
</span><span id="__span-130-88"><a id="__codelineno-130-88" name="__codelineno-130-88" href="#__codelineno-130-88"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Batch information:&quot;</span><span class="p">)</span>
</span><span id="__span-130-89"><a id="__codelineno-130-89" name="__codelineno-130-89" href="#__codelineno-130-89"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-90"><a id="__codelineno-130-90" name="__codelineno-130-90" href="#__codelineno-130-90"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-91"><a id="__codelineno-130-91" name="__codelineno-130-91" href="#__codelineno-130-91"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-130-92"><a id="__codelineno-130-92" name="__codelineno-130-92" href="#__codelineno-130-92"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Understanding the Data:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="c1"># Visualize feature distributions</span>
</span><span id="__span-131-2"><a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">analyze_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dataset&#39;</span><span class="p">):</span>
</span><span id="__span-131-3"><a id="__codelineno-131-3" name="__codelineno-131-3" href="#__codelineno-131-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze and visualize dataset statistics&quot;&quot;&quot;</span>
</span><span id="__span-131-4"><a id="__codelineno-131-4" name="__codelineno-131-4" href="#__codelineno-131-4"></a>
</span><span id="__span-131-5"><a id="__codelineno-131-5" name="__codelineno-131-5" href="#__codelineno-131-5"></a>    <span class="c1"># Collect statistics</span>
</span><span id="__span-131-6"><a id="__codelineno-131-6" name="__codelineno-131-6" href="#__codelineno-131-6"></a>    <span class="n">num_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">num_nodes</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
</span><span id="__span-131-7"><a id="__codelineno-131-7" name="__codelineno-131-7" href="#__codelineno-131-7"></a>    <span class="n">num_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">num_edges</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>  <span class="c1"># Divide by 2 (undirected)</span>
</span><span id="__span-131-8"><a id="__codelineno-131-8" name="__codelineno-131-8" href="#__codelineno-131-8"></a>
</span><span id="__span-131-9"><a id="__codelineno-131-9" name="__codelineno-131-9" href="#__codelineno-131-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> Statistics:&quot;</span><span class="p">)</span>
</span><span id="__span-131-10"><a id="__codelineno-131-10" name="__codelineno-131-10" href="#__codelineno-131-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Molecules with 5 atoms: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">num_atoms</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-131-11"><a id="__codelineno-131-11" name="__codelineno-131-11" href="#__codelineno-131-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Molecules with 9 atoms: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">num_atoms</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-131-12"><a id="__codelineno-131-12" name="__codelineno-131-12" href="#__codelineno-131-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Average atoms: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-131-13"><a id="__codelineno-131-13" name="__codelineno-131-13" href="#__codelineno-131-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Average bonds: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">num_bonds</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-131-14"><a id="__codelineno-131-14" name="__codelineno-131-14" href="#__codelineno-131-14"></a>
</span><span id="__span-131-15"><a id="__codelineno-131-15" name="__codelineno-131-15" href="#__codelineno-131-15"></a>    <span class="c1"># Plot distributions</span>
</span><span id="__span-131-16"><a id="__codelineno-131-16" name="__codelineno-131-16" href="#__codelineno-131-16"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="__span-131-17"><a id="__codelineno-131-17" name="__codelineno-131-17" href="#__codelineno-131-17"></a>
</span><span id="__span-131-18"><a id="__codelineno-131-18" name="__codelineno-131-18" href="#__codelineno-131-18"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="__span-131-19"><a id="__codelineno-131-19" name="__codelineno-131-19" href="#__codelineno-131-19"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Atoms&#39;</span><span class="p">)</span>
</span><span id="__span-131-20"><a id="__codelineno-131-20" name="__codelineno-131-20" href="#__codelineno-131-20"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
</span><span id="__span-131-21"><a id="__codelineno-131-21" name="__codelineno-131-21" href="#__codelineno-131-21"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Molecule Size Distribution&#39;</span><span class="p">)</span>
</span><span id="__span-131-22"><a id="__codelineno-131-22" name="__codelineno-131-22" href="#__codelineno-131-22"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-131-23"><a id="__codelineno-131-23" name="__codelineno-131-23" href="#__codelineno-131-23"></a>
</span><span id="__span-131-24"><a id="__codelineno-131-24" name="__codelineno-131-24" href="#__codelineno-131-24"></a>    <span class="c1"># Get target values</span>
</span><span id="__span-131-25"><a id="__codelineno-131-25" name="__codelineno-131-25" href="#__codelineno-131-25"></a>    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
</span><span id="__span-131-26"><a id="__codelineno-131-26" name="__codelineno-131-26" href="#__codelineno-131-26"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
</span><span id="__span-131-27"><a id="__codelineno-131-27" name="__codelineno-131-27" href="#__codelineno-131-27"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_name</span><span class="si">}</span><span class="s1"> (eV)&#39;</span><span class="p">)</span>
</span><span id="__span-131-28"><a id="__codelineno-131-28" name="__codelineno-131-28" href="#__codelineno-131-28"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
</span><span id="__span-131-29"><a id="__codelineno-131-29" name="__codelineno-131-29" href="#__codelineno-131-29"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Target Distribution&#39;</span><span class="p">)</span>
</span><span id="__span-131-30"><a id="__codelineno-131-30" name="__codelineno-131-30" href="#__codelineno-131-30"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-131-31"><a id="__codelineno-131-31" name="__codelineno-131-31" href="#__codelineno-131-31"></a>
</span><span id="__span-131-32"><a id="__codelineno-131-32" name="__codelineno-131-32" href="#__codelineno-131-32"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-131-33"><a id="__codelineno-131-33" name="__codelineno-131-33" href="#__codelineno-131-33"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_analysis.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</span><span id="__span-131-34"><a id="__codelineno-131-34" name="__codelineno-131-34" href="#__codelineno-131-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Saved: </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_analysis.png&quot;</span><span class="p">)</span>
</span><span id="__span-131-35"><a id="__codelineno-131-35" name="__codelineno-131-35" href="#__codelineno-131-35"></a>
</span><span id="__span-131-36"><a id="__codelineno-131-36" name="__codelineno-131-36" href="#__codelineno-131-36"></a><span class="n">analyze_dataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="s1">&#39;Training Set&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 2: Define GAT Model</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">GATForQM9</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-132-2"><a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-132-3"><a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a><span class="sd">    Graph Attention Network for molecular property prediction</span>
</span><span id="__span-132-4"><a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a>
</span><span id="__span-132-5"><a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a><span class="sd">    Architecture:</span>
</span><span id="__span-132-6"><a id="__codelineno-132-6" name="__codelineno-132-6" href="#__codelineno-132-6"></a><span class="sd">    - Initial embedding layer</span>
</span><span id="__span-132-7"><a id="__codelineno-132-7" name="__codelineno-132-7" href="#__codelineno-132-7"></a><span class="sd">    - Multiple GAT layers with multi-head attention</span>
</span><span id="__span-132-8"><a id="__codelineno-132-8" name="__codelineno-132-8" href="#__codelineno-132-8"></a><span class="sd">    - Batch normalization and residual connections</span>
</span><span id="__span-132-9"><a id="__codelineno-132-9" name="__codelineno-132-9" href="#__codelineno-132-9"></a><span class="sd">    - Global pooling</span>
</span><span id="__span-132-10"><a id="__codelineno-132-10" name="__codelineno-132-10" href="#__codelineno-132-10"></a><span class="sd">    - MLP prediction head</span>
</span><span id="__span-132-11"><a id="__codelineno-132-11" name="__codelineno-132-11" href="#__codelineno-132-11"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-132-12"><a id="__codelineno-132-12" name="__codelineno-132-12" href="#__codelineno-132-12"></a>
</span><span id="__span-132-13"><a id="__codelineno-132-13" name="__codelineno-132-13" href="#__codelineno-132-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="__span-132-14"><a id="__codelineno-132-14" name="__codelineno-132-14" href="#__codelineno-132-14"></a>                 <span class="n">num_node_features</span><span class="p">,</span>
</span><span id="__span-132-15"><a id="__codelineno-132-15" name="__codelineno-132-15" href="#__codelineno-132-15"></a>                 <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="__span-132-16"><a id="__codelineno-132-16" name="__codelineno-132-16" href="#__codelineno-132-16"></a>                 <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
</span><span id="__span-132-17"><a id="__codelineno-132-17" name="__codelineno-132-17" href="#__codelineno-132-17"></a>                 <span class="n">num_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-132-18"><a id="__codelineno-132-18" name="__codelineno-132-18" href="#__codelineno-132-18"></a>                 <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="__span-132-19"><a id="__codelineno-132-19" name="__codelineno-132-19" href="#__codelineno-132-19"></a>                 <span class="n">target_mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="__span-132-20"><a id="__codelineno-132-20" name="__codelineno-132-20" href="#__codelineno-132-20"></a>                 <span class="n">target_std</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
</span><span id="__span-132-21"><a id="__codelineno-132-21" name="__codelineno-132-21" href="#__codelineno-132-21"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">GATForQM9</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-132-22"><a id="__codelineno-132-22" name="__codelineno-132-22" href="#__codelineno-132-22"></a>
</span><span id="__span-132-23"><a id="__codelineno-132-23" name="__codelineno-132-23" href="#__codelineno-132-23"></a>        <span class="c1"># Store normalization parameters</span>
</span><span id="__span-132-24"><a id="__codelineno-132-24" name="__codelineno-132-24" href="#__codelineno-132-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;target_mean&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">target_mean</span><span class="p">))</span>
</span><span id="__span-132-25"><a id="__codelineno-132-25" name="__codelineno-132-25" href="#__codelineno-132-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;target_std&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">target_std</span><span class="p">))</span>
</span><span id="__span-132-26"><a id="__codelineno-132-26" name="__codelineno-132-26" href="#__codelineno-132-26"></a>
</span><span id="__span-132-27"><a id="__codelineno-132-27" name="__codelineno-132-27" href="#__codelineno-132-27"></a>        <span class="c1"># Initial node embedding</span>
</span><span id="__span-132-28"><a id="__codelineno-132-28" name="__codelineno-132-28" href="#__codelineno-132-28"></a>        <span class="c1"># Maps input features to hidden dimension</span>
</span><span id="__span-132-29"><a id="__codelineno-132-29" name="__codelineno-132-29" href="#__codelineno-132-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_node_features</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-132-30"><a id="__codelineno-132-30" name="__codelineno-132-30" href="#__codelineno-132-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_bn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-132-31"><a id="__codelineno-132-31" name="__codelineno-132-31" href="#__codelineno-132-31"></a>
</span><span id="__span-132-32"><a id="__codelineno-132-32" name="__codelineno-132-32" href="#__codelineno-132-32"></a>        <span class="c1"># GAT layers with multi-head attention</span>
</span><span id="__span-132-33"><a id="__codelineno-132-33" name="__codelineno-132-33" href="#__codelineno-132-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gat_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
</span><span id="__span-132-34"><a id="__codelineno-132-34" name="__codelineno-132-34" href="#__codelineno-132-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_norms</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
</span><span id="__span-132-35"><a id="__codelineno-132-35" name="__codelineno-132-35" href="#__codelineno-132-35"></a>
</span><span id="__span-132-36"><a id="__codelineno-132-36" name="__codelineno-132-36" href="#__codelineno-132-36"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
</span><span id="__span-132-37"><a id="__codelineno-132-37" name="__codelineno-132-37" href="#__codelineno-132-37"></a>            <span class="c1"># Input dimension changes after concatenation</span>
</span><span id="__span-132-38"><a id="__codelineno-132-38" name="__codelineno-132-38" href="#__codelineno-132-38"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-132-39"><a id="__codelineno-132-39" name="__codelineno-132-39" href="#__codelineno-132-39"></a>                <span class="n">in_channels</span> <span class="o">=</span> <span class="n">hidden_dim</span>
</span><span id="__span-132-40"><a id="__codelineno-132-40" name="__codelineno-132-40" href="#__codelineno-132-40"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-132-41"><a id="__codelineno-132-41" name="__codelineno-132-41" href="#__codelineno-132-41"></a>                <span class="n">in_channels</span> <span class="o">=</span> <span class="n">hidden_dim</span> <span class="o">*</span> <span class="n">num_heads</span>
</span><span id="__span-132-42"><a id="__codelineno-132-42" name="__codelineno-132-42" href="#__codelineno-132-42"></a>
</span><span id="__span-132-43"><a id="__codelineno-132-43" name="__codelineno-132-43" href="#__codelineno-132-43"></a>            <span class="c1"># Last layer averages heads instead of concatenation</span>
</span><span id="__span-132-44"><a id="__codelineno-132-44" name="__codelineno-132-44" href="#__codelineno-132-44"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_layers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-132-45"><a id="__codelineno-132-45" name="__codelineno-132-45" href="#__codelineno-132-45"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gat_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-132-46"><a id="__codelineno-132-46" name="__codelineno-132-46" href="#__codelineno-132-46"></a>                    <span class="n">GATConv</span><span class="p">(</span>
</span><span id="__span-132-47"><a id="__codelineno-132-47" name="__codelineno-132-47" href="#__codelineno-132-47"></a>                        <span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span>
</span><span id="__span-132-48"><a id="__codelineno-132-48" name="__codelineno-132-48" href="#__codelineno-132-48"></a>                        <span class="n">out_channels</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span>
</span><span id="__span-132-49"><a id="__codelineno-132-49" name="__codelineno-132-49" href="#__codelineno-132-49"></a>                        <span class="n">heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
</span><span id="__span-132-50"><a id="__codelineno-132-50" name="__codelineno-132-50" href="#__codelineno-132-50"></a>                        <span class="n">concat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Average instead of concatenate</span>
</span><span id="__span-132-51"><a id="__codelineno-132-51" name="__codelineno-132-51" href="#__codelineno-132-51"></a>                        <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
</span><span id="__span-132-52"><a id="__codelineno-132-52" name="__codelineno-132-52" href="#__codelineno-132-52"></a>                        <span class="n">add_self_loops</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Include self-attention</span>
</span><span id="__span-132-53"><a id="__codelineno-132-53" name="__codelineno-132-53" href="#__codelineno-132-53"></a>                        <span class="n">bias</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-132-54"><a id="__codelineno-132-54" name="__codelineno-132-54" href="#__codelineno-132-54"></a>                    <span class="p">)</span>
</span><span id="__span-132-55"><a id="__codelineno-132-55" name="__codelineno-132-55" href="#__codelineno-132-55"></a>                <span class="p">)</span>
</span><span id="__span-132-56"><a id="__codelineno-132-56" name="__codelineno-132-56" href="#__codelineno-132-56"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">batch_norms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">))</span>
</span><span id="__span-132-57"><a id="__codelineno-132-57" name="__codelineno-132-57" href="#__codelineno-132-57"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-132-58"><a id="__codelineno-132-58" name="__codelineno-132-58" href="#__codelineno-132-58"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gat_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-132-59"><a id="__codelineno-132-59" name="__codelineno-132-59" href="#__codelineno-132-59"></a>                    <span class="n">GATConv</span><span class="p">(</span>
</span><span id="__span-132-60"><a id="__codelineno-132-60" name="__codelineno-132-60" href="#__codelineno-132-60"></a>                        <span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span>
</span><span id="__span-132-61"><a id="__codelineno-132-61" name="__codelineno-132-61" href="#__codelineno-132-61"></a>                        <span class="n">out_channels</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span>
</span><span id="__span-132-62"><a id="__codelineno-132-62" name="__codelineno-132-62" href="#__codelineno-132-62"></a>                        <span class="n">heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
</span><span id="__span-132-63"><a id="__codelineno-132-63" name="__codelineno-132-63" href="#__codelineno-132-63"></a>                        <span class="n">concat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Concatenate attention heads</span>
</span><span id="__span-132-64"><a id="__codelineno-132-64" name="__codelineno-132-64" href="#__codelineno-132-64"></a>                        <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
</span><span id="__span-132-65"><a id="__codelineno-132-65" name="__codelineno-132-65" href="#__codelineno-132-65"></a>                        <span class="n">add_self_loops</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-132-66"><a id="__codelineno-132-66" name="__codelineno-132-66" href="#__codelineno-132-66"></a>                        <span class="n">bias</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-132-67"><a id="__codelineno-132-67" name="__codelineno-132-67" href="#__codelineno-132-67"></a>                    <span class="p">)</span>
</span><span id="__span-132-68"><a id="__codelineno-132-68" name="__codelineno-132-68" href="#__codelineno-132-68"></a>                <span class="p">)</span>
</span><span id="__span-132-69"><a id="__codelineno-132-69" name="__codelineno-132-69" href="#__codelineno-132-69"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">batch_norms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">*</span> <span class="n">num_heads</span><span class="p">))</span>
</span><span id="__span-132-70"><a id="__codelineno-132-70" name="__codelineno-132-70" href="#__codelineno-132-70"></a>
</span><span id="__span-132-71"><a id="__codelineno-132-71" name="__codelineno-132-71" href="#__codelineno-132-71"></a>        <span class="c1"># Prediction head</span>
</span><span id="__span-132-72"><a id="__codelineno-132-72" name="__codelineno-132-72" href="#__codelineno-132-72"></a>        <span class="c1"># Two-layer MLP with ReLU activation</span>
</span><span id="__span-132-73"><a id="__codelineno-132-73" name="__codelineno-132-73" href="#__codelineno-132-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-132-74"><a id="__codelineno-132-74" name="__codelineno-132-74" href="#__codelineno-132-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bn_fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-132-75"><a id="__codelineno-132-75" name="__codelineno-132-75" href="#__codelineno-132-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-132-76"><a id="__codelineno-132-76" name="__codelineno-132-76" href="#__codelineno-132-76"></a>
</span><span id="__span-132-77"><a id="__codelineno-132-77" name="__codelineno-132-77" href="#__codelineno-132-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-132-78"><a id="__codelineno-132-78" name="__codelineno-132-78" href="#__codelineno-132-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="__span-132-79"><a id="__codelineno-132-79" name="__codelineno-132-79" href="#__codelineno-132-79"></a>
</span><span id="__span-132-80"><a id="__codelineno-132-80" name="__codelineno-132-80" href="#__codelineno-132-80"></a>        <span class="c1"># Initialize weights</span>
</span><span id="__span-132-81"><a id="__codelineno-132-81" name="__codelineno-132-81" href="#__codelineno-132-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_weights</span><span class="p">()</span>
</span><span id="__span-132-82"><a id="__codelineno-132-82" name="__codelineno-132-82" href="#__codelineno-132-82"></a>
</span><span id="__span-132-83"><a id="__codelineno-132-83" name="__codelineno-132-83" href="#__codelineno-132-83"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-132-84"><a id="__codelineno-132-84" name="__codelineno-132-84" href="#__codelineno-132-84"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Kaiming initialization for better training&quot;&quot;&quot;</span>
</span><span id="__span-132-85"><a id="__codelineno-132-85" name="__codelineno-132-85" href="#__codelineno-132-85"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-132-86"><a id="__codelineno-132-86" name="__codelineno-132-86" href="#__codelineno-132-86"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-132-87"><a id="__codelineno-132-87" name="__codelineno-132-87" href="#__codelineno-132-87"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_out&#39;</span><span class="p">,</span> <span class="n">nonlinearity</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span>
</span><span id="__span-132-88"><a id="__codelineno-132-88" name="__codelineno-132-88" href="#__codelineno-132-88"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-132-89"><a id="__codelineno-132-89" name="__codelineno-132-89" href="#__codelineno-132-89"></a>                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-132-90"><a id="__codelineno-132-90" name="__codelineno-132-90" href="#__codelineno-132-90"></a>
</span><span id="__span-132-91"><a id="__codelineno-132-91" name="__codelineno-132-91" href="#__codelineno-132-91"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="__span-132-92"><a id="__codelineno-132-92" name="__codelineno-132-92" href="#__codelineno-132-92"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-132-93"><a id="__codelineno-132-93" name="__codelineno-132-93" href="#__codelineno-132-93"></a><span class="sd">        Forward pass</span>
</span><span id="__span-132-94"><a id="__codelineno-132-94" name="__codelineno-132-94" href="#__codelineno-132-94"></a>
</span><span id="__span-132-95"><a id="__codelineno-132-95" name="__codelineno-132-95" href="#__codelineno-132-95"></a><span class="sd">        Args:</span>
</span><span id="__span-132-96"><a id="__codelineno-132-96" name="__codelineno-132-96" href="#__codelineno-132-96"></a><span class="sd">            data: PyG Batch object with x, edge_index, batch</span>
</span><span id="__span-132-97"><a id="__codelineno-132-97" name="__codelineno-132-97" href="#__codelineno-132-97"></a>
</span><span id="__span-132-98"><a id="__codelineno-132-98" name="__codelineno-132-98" href="#__codelineno-132-98"></a><span class="sd">        Returns:</span>
</span><span id="__span-132-99"><a id="__codelineno-132-99" name="__codelineno-132-99" href="#__codelineno-132-99"></a><span class="sd">            predictions: Tensor of shape [batch_size]</span>
</span><span id="__span-132-100"><a id="__codelineno-132-100" name="__codelineno-132-100" href="#__codelineno-132-100"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-132-101"><a id="__codelineno-132-101" name="__codelineno-132-101" href="#__codelineno-132-101"></a>        <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span>
</span><span id="__span-132-102"><a id="__codelineno-132-102" name="__codelineno-132-102" href="#__codelineno-132-102"></a>
</span><span id="__span-132-103"><a id="__codelineno-132-103" name="__codelineno-132-103" href="#__codelineno-132-103"></a>        <span class="c1"># Initial embedding</span>
</span><span id="__span-132-104"><a id="__codelineno-132-104" name="__codelineno-132-104" href="#__codelineno-132-104"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-105"><a id="__codelineno-132-105" name="__codelineno-132-105" href="#__codelineno-132-105"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_bn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-106"><a id="__codelineno-132-106" name="__codelineno-132-106" href="#__codelineno-132-106"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-107"><a id="__codelineno-132-107" name="__codelineno-132-107" href="#__codelineno-132-107"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-108"><a id="__codelineno-132-108" name="__codelineno-132-108" href="#__codelineno-132-108"></a>
</span><span id="__span-132-109"><a id="__codelineno-132-109" name="__codelineno-132-109" href="#__codelineno-132-109"></a>        <span class="c1"># GAT layers with residual connections</span>
</span><span id="__span-132-110"><a id="__codelineno-132-110" name="__codelineno-132-110" href="#__codelineno-132-110"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">gat</span><span class="p">,</span> <span class="n">bn</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gat_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_norms</span><span class="p">)):</span>
</span><span id="__span-132-111"><a id="__codelineno-132-111" name="__codelineno-132-111" href="#__codelineno-132-111"></a>            <span class="c1"># Store input for residual connection</span>
</span><span id="__span-132-112"><a id="__codelineno-132-112" name="__codelineno-132-112" href="#__codelineno-132-112"></a>            <span class="n">x_residual</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="__span-132-113"><a id="__codelineno-132-113" name="__codelineno-132-113" href="#__codelineno-132-113"></a>
</span><span id="__span-132-114"><a id="__codelineno-132-114" name="__codelineno-132-114" href="#__codelineno-132-114"></a>            <span class="c1"># GAT convolution</span>
</span><span id="__span-132-115"><a id="__codelineno-132-115" name="__codelineno-132-115" href="#__codelineno-132-115"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">gat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span><span id="__span-132-116"><a id="__codelineno-132-116" name="__codelineno-132-116" href="#__codelineno-132-116"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">bn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-117"><a id="__codelineno-132-117" name="__codelineno-132-117" href="#__codelineno-132-117"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-118"><a id="__codelineno-132-118" name="__codelineno-132-118" href="#__codelineno-132-118"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-119"><a id="__codelineno-132-119" name="__codelineno-132-119" href="#__codelineno-132-119"></a>
</span><span id="__span-132-120"><a id="__codelineno-132-120" name="__codelineno-132-120" href="#__codelineno-132-120"></a>            <span class="c1"># Residual connection (with projection if dimensions don&#39;t match)</span>
</span><span id="__span-132-121"><a id="__codelineno-132-121" name="__codelineno-132-121" href="#__codelineno-132-121"></a>            <span class="k">if</span> <span class="n">x_residual</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
</span><span id="__span-132-122"><a id="__codelineno-132-122" name="__codelineno-132-122" href="#__codelineno-132-122"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x_residual</span>
</span><span id="__span-132-123"><a id="__codelineno-132-123" name="__codelineno-132-123" href="#__codelineno-132-123"></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Skip for first layer</span>
</span><span id="__span-132-124"><a id="__codelineno-132-124" name="__codelineno-132-124" href="#__codelineno-132-124"></a>                <span class="c1"># Project residual to match dimensions</span>
</span><span id="__span-132-125"><a id="__codelineno-132-125" name="__codelineno-132-125" href="#__codelineno-132-125"></a>                <span class="n">x_residual_proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project_residual</span><span class="p">(</span><span class="n">x_residual</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="__span-132-126"><a id="__codelineno-132-126" name="__codelineno-132-126" href="#__codelineno-132-126"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x_residual_proj</span>
</span><span id="__span-132-127"><a id="__codelineno-132-127" name="__codelineno-132-127" href="#__codelineno-132-127"></a>
</span><span id="__span-132-128"><a id="__codelineno-132-128" name="__codelineno-132-128" href="#__codelineno-132-128"></a>        <span class="c1"># Global pooling: aggregate node features to graph-level</span>
</span><span id="__span-132-129"><a id="__codelineno-132-129" name="__codelineno-132-129" href="#__codelineno-132-129"></a>        <span class="c1"># Mean pooling: intensive property (per-atom average)</span>
</span><span id="__span-132-130"><a id="__codelineno-132-130" name="__codelineno-132-130" href="#__codelineno-132-130"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">global_mean_pool</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
</span><span id="__span-132-131"><a id="__codelineno-132-131" name="__codelineno-132-131" href="#__codelineno-132-131"></a>
</span><span id="__span-132-132"><a id="__codelineno-132-132" name="__codelineno-132-132" href="#__codelineno-132-132"></a>        <span class="c1"># Prediction head</span>
</span><span id="__span-132-133"><a id="__codelineno-132-133" name="__codelineno-132-133" href="#__codelineno-132-133"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-134"><a id="__codelineno-132-134" name="__codelineno-132-134" href="#__codelineno-132-134"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn_fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-135"><a id="__codelineno-132-135" name="__codelineno-132-135" href="#__codelineno-132-135"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-136"><a id="__codelineno-132-136" name="__codelineno-132-136" href="#__codelineno-132-136"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-137"><a id="__codelineno-132-137" name="__codelineno-132-137" href="#__codelineno-132-137"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-132-138"><a id="__codelineno-132-138" name="__codelineno-132-138" href="#__codelineno-132-138"></a>
</span><span id="__span-132-139"><a id="__codelineno-132-139" name="__codelineno-132-139" href="#__codelineno-132-139"></a>        <span class="c1"># Denormalize predictions</span>
</span><span id="__span-132-140"><a id="__codelineno-132-140" name="__codelineno-132-140" href="#__codelineno-132-140"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_std</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_mean</span>
</span><span id="__span-132-141"><a id="__codelineno-132-141" name="__codelineno-132-141" href="#__codelineno-132-141"></a>
</span><span id="__span-132-142"><a id="__codelineno-132-142" name="__codelineno-132-142" href="#__codelineno-132-142"></a>        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Remove last dimension [batch, 1] -&gt; [batch]</span>
</span><span id="__span-132-143"><a id="__codelineno-132-143" name="__codelineno-132-143" href="#__codelineno-132-143"></a>
</span><span id="__span-132-144"><a id="__codelineno-132-144" name="__codelineno-132-144" href="#__codelineno-132-144"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_project_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_residual</span><span class="p">,</span> <span class="n">target_dim</span><span class="p">):</span>
</span><span id="__span-132-145"><a id="__codelineno-132-145" name="__codelineno-132-145" href="#__codelineno-132-145"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to project residual connection&quot;&quot;&quot;</span>
</span><span id="__span-132-146"><a id="__codelineno-132-146" name="__codelineno-132-146" href="#__codelineno-132-146"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;residual_projections&#39;</span><span class="p">):</span>
</span><span id="__span-132-147"><a id="__codelineno-132-147" name="__codelineno-132-147" href="#__codelineno-132-147"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">residual_projections</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-132-148"><a id="__codelineno-132-148" name="__codelineno-132-148" href="#__codelineno-132-148"></a>
</span><span id="__span-132-149"><a id="__codelineno-132-149" name="__codelineno-132-149" href="#__codelineno-132-149"></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_residual</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">target_dim</span><span class="p">)</span>
</span><span id="__span-132-150"><a id="__codelineno-132-150" name="__codelineno-132-150" href="#__codelineno-132-150"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_projections</span><span class="p">:</span>
</span><span id="__span-132-151"><a id="__codelineno-132-151" name="__codelineno-132-151" href="#__codelineno-132-151"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">residual_projections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
</span><span id="__span-132-152"><a id="__codelineno-132-152" name="__codelineno-132-152" href="#__codelineno-132-152"></a>                <span class="n">x_residual</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> 
</span><span id="__span-132-153"><a id="__codelineno-132-153" name="__codelineno-132-153" href="#__codelineno-132-153"></a>                <span class="n">target_dim</span><span class="p">,</span>
</span><span id="__span-132-154"><a id="__codelineno-132-154" name="__codelineno-132-154" href="#__codelineno-132-154"></a>                <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
</span><span id="__span-132-155"><a id="__codelineno-132-155" name="__codelineno-132-155" href="#__codelineno-132-155"></a>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x_residual</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-132-156"><a id="__codelineno-132-156" name="__codelineno-132-156" href="#__codelineno-132-156"></a>
</span><span id="__span-132-157"><a id="__codelineno-132-157" name="__codelineno-132-157" href="#__codelineno-132-157"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_projections</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">x_residual</span><span class="p">)</span>
</span><span id="__span-132-158"><a id="__codelineno-132-158" name="__codelineno-132-158" href="#__codelineno-132-158"></a>
</span><span id="__span-132-159"><a id="__codelineno-132-159" name="__codelineno-132-159" href="#__codelineno-132-159"></a><span class="c1"># Instantiate model</span>
</span><span id="__span-132-160"><a id="__codelineno-132-160" name="__codelineno-132-160" href="#__codelineno-132-160"></a><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="__span-132-161"><a id="__codelineno-132-161" name="__codelineno-132-161" href="#__codelineno-132-161"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Using device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-132-162"><a id="__codelineno-132-162" name="__codelineno-132-162" href="#__codelineno-132-162"></a>
</span><span id="__span-132-163"><a id="__codelineno-132-163" name="__codelineno-132-163" href="#__codelineno-132-163"></a><span class="n">model</span> <span class="o">=</span> <span class="n">GATForQM9</span><span class="p">(</span>
</span><span id="__span-132-164"><a id="__codelineno-132-164" name="__codelineno-132-164" href="#__codelineno-132-164"></a>    <span class="n">num_node_features</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_features</span><span class="p">,</span>
</span><span id="__span-132-165"><a id="__codelineno-132-165" name="__codelineno-132-165" href="#__codelineno-132-165"></a>    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="__span-132-166"><a id="__codelineno-132-166" name="__codelineno-132-166" href="#__codelineno-132-166"></a>    <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
</span><span id="__span-132-167"><a id="__codelineno-132-167" name="__codelineno-132-167" href="#__codelineno-132-167"></a>    <span class="n">num_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
</span><span id="__span-132-168"><a id="__codelineno-132-168" name="__codelineno-132-168" href="#__codelineno-132-168"></a>    <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span><span id="__span-132-169"><a id="__codelineno-132-169" name="__codelineno-132-169" href="#__codelineno-132-169"></a>    <span class="n">target_mean</span><span class="o">=</span><span class="n">target_mean</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
</span><span id="__span-132-170"><a id="__codelineno-132-170" name="__codelineno-132-170" href="#__codelineno-132-170"></a>    <span class="n">target_std</span><span class="o">=</span><span class="n">target_std</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-132-171"><a id="__codelineno-132-171" name="__codelineno-132-171" href="#__codelineno-132-171"></a><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-132-172"><a id="__codelineno-132-172" name="__codelineno-132-172" href="#__codelineno-132-172"></a>
</span><span id="__span-132-173"><a id="__codelineno-132-173" name="__codelineno-132-173" href="#__codelineno-132-173"></a><span class="c1"># Count parameters</span>
</span><span id="__span-132-174"><a id="__codelineno-132-174" name="__codelineno-132-174" href="#__codelineno-132-174"></a><span class="n">num_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
</span><span id="__span-132-175"><a id="__codelineno-132-175" name="__codelineno-132-175" href="#__codelineno-132-175"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of trainable parameters: </span><span class="si">{</span><span class="n">num_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-132-176"><a id="__codelineno-132-176" name="__codelineno-132-176" href="#__codelineno-132-176"></a>
</span><span id="__span-132-177"><a id="__codelineno-132-177" name="__codelineno-132-177" href="#__codelineno-132-177"></a><span class="c1"># Print model architecture</span>
</span><span id="__span-132-178"><a id="__codelineno-132-178" name="__codelineno-132-178" href="#__codelineno-132-178"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Model Architecture:&quot;</span><span class="p">)</span>
</span><span id="__span-132-179"><a id="__codelineno-132-179" name="__codelineno-132-179" href="#__codelineno-132-179"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 3: Training Loop with Best Practices</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="__span-133-2"><a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Train for one epoch&quot;&quot;&quot;</span>
</span><span id="__span-133-3"><a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-133-4"><a id="__codelineno-133-4" name="__codelineno-133-4" href="#__codelineno-133-4"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-133-5"><a id="__codelineno-133-5" name="__codelineno-133-5" href="#__codelineno-133-5"></a>    <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-133-6"><a id="__codelineno-133-6" name="__codelineno-133-6" href="#__codelineno-133-6"></a>
</span><span id="__span-133-7"><a id="__codelineno-133-7" name="__codelineno-133-7" href="#__codelineno-133-7"></a>    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
</span><span id="__span-133-8"><a id="__codelineno-133-8" name="__codelineno-133-8" href="#__codelineno-133-8"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-133-9"><a id="__codelineno-133-9" name="__codelineno-133-9" href="#__codelineno-133-9"></a>
</span><span id="__span-133-10"><a id="__codelineno-133-10" name="__codelineno-133-10" href="#__codelineno-133-10"></a>        <span class="c1"># Forward pass</span>
</span><span id="__span-133-11"><a id="__codelineno-133-11" name="__codelineno-133-11" href="#__codelineno-133-11"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-133-12"><a id="__codelineno-133-12" name="__codelineno-133-12" href="#__codelineno-133-12"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">target_idx</span><span class="p">]</span>
</span><span id="__span-133-13"><a id="__codelineno-133-13" name="__codelineno-133-13" href="#__codelineno-133-13"></a>
</span><span id="__span-133-14"><a id="__codelineno-133-14" name="__codelineno-133-14" href="#__codelineno-133-14"></a>        <span class="c1"># Compute loss</span>
</span><span id="__span-133-15"><a id="__codelineno-133-15" name="__codelineno-133-15" href="#__codelineno-133-15"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span><span id="__span-133-16"><a id="__codelineno-133-16" name="__codelineno-133-16" href="#__codelineno-133-16"></a>
</span><span id="__span-133-17"><a id="__codelineno-133-17" name="__codelineno-133-17" href="#__codelineno-133-17"></a>        <span class="c1"># Backward pass</span>
</span><span id="__span-133-18"><a id="__codelineno-133-18" name="__codelineno-133-18" href="#__codelineno-133-18"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-133-19"><a id="__codelineno-133-19" name="__codelineno-133-19" href="#__codelineno-133-19"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-133-20"><a id="__codelineno-133-20" name="__codelineno-133-20" href="#__codelineno-133-20"></a>
</span><span id="__span-133-21"><a id="__codelineno-133-21" name="__codelineno-133-21" href="#__codelineno-133-21"></a>        <span class="c1"># Gradient clipping to prevent explosion</span>
</span><span id="__span-133-22"><a id="__codelineno-133-22" name="__codelineno-133-22" href="#__codelineno-133-22"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-133-23"><a id="__codelineno-133-23" name="__codelineno-133-23" href="#__codelineno-133-23"></a>
</span><span id="__span-133-24"><a id="__codelineno-133-24" name="__codelineno-133-24" href="#__codelineno-133-24"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-133-25"><a id="__codelineno-133-25" name="__codelineno-133-25" href="#__codelineno-133-25"></a>
</span><span id="__span-133-26"><a id="__codelineno-133-26" name="__codelineno-133-26" href="#__codelineno-133-26"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">num_graphs</span>
</span><span id="__span-133-27"><a id="__codelineno-133-27" name="__codelineno-133-27" href="#__codelineno-133-27"></a>        <span class="n">num_samples</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">num_graphs</span>
</span><span id="__span-133-28"><a id="__codelineno-133-28" name="__codelineno-133-28" href="#__codelineno-133-28"></a>
</span><span id="__span-133-29"><a id="__codelineno-133-29" name="__codelineno-133-29" href="#__codelineno-133-29"></a>    <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="n">num_samples</span>
</span><span id="__span-133-30"><a id="__codelineno-133-30" name="__codelineno-133-30" href="#__codelineno-133-30"></a>
</span><span id="__span-133-31"><a id="__codelineno-133-31" name="__codelineno-133-31" href="#__codelineno-133-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="__span-133-32"><a id="__codelineno-133-32" name="__codelineno-133-32" href="#__codelineno-133-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate model&quot;&quot;&quot;</span>
</span><span id="__span-133-33"><a id="__codelineno-133-33" name="__codelineno-133-33" href="#__codelineno-133-33"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-133-34"><a id="__codelineno-133-34" name="__codelineno-133-34" href="#__codelineno-133-34"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-133-35"><a id="__codelineno-133-35" name="__codelineno-133-35" href="#__codelineno-133-35"></a>    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-133-36"><a id="__codelineno-133-36" name="__codelineno-133-36" href="#__codelineno-133-36"></a>    <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-133-37"><a id="__codelineno-133-37" name="__codelineno-133-37" href="#__codelineno-133-37"></a>
</span><span id="__span-133-38"><a id="__codelineno-133-38" name="__codelineno-133-38" href="#__codelineno-133-38"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-133-39"><a id="__codelineno-133-39" name="__codelineno-133-39" href="#__codelineno-133-39"></a>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
</span><span id="__span-133-40"><a id="__codelineno-133-40" name="__codelineno-133-40" href="#__codelineno-133-40"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-133-41"><a id="__codelineno-133-41" name="__codelineno-133-41" href="#__codelineno-133-41"></a>            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-133-42"><a id="__codelineno-133-42" name="__codelineno-133-42" href="#__codelineno-133-42"></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">target_idx</span><span class="p">]</span>
</span><span id="__span-133-43"><a id="__codelineno-133-43" name="__codelineno-133-43" href="#__codelineno-133-43"></a>
</span><span id="__span-133-44"><a id="__codelineno-133-44" name="__codelineno-133-44" href="#__codelineno-133-44"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span><span id="__span-133-45"><a id="__codelineno-133-45" name="__codelineno-133-45" href="#__codelineno-133-45"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">num_graphs</span>
</span><span id="__span-133-46"><a id="__codelineno-133-46" name="__codelineno-133-46" href="#__codelineno-133-46"></a>
</span><span id="__span-133-47"><a id="__codelineno-133-47" name="__codelineno-133-47" href="#__codelineno-133-47"></a>            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</span><span id="__span-133-48"><a id="__codelineno-133-48" name="__codelineno-133-48" href="#__codelineno-133-48"></a>            <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</span><span id="__span-133-49"><a id="__codelineno-133-49" name="__codelineno-133-49" href="#__codelineno-133-49"></a>
</span><span id="__span-133-50"><a id="__codelineno-133-50" name="__codelineno-133-50" href="#__codelineno-133-50"></a>    <span class="n">predictions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
</span><span id="__span-133-51"><a id="__codelineno-133-51" name="__codelineno-133-51" href="#__codelineno-133-51"></a>    <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
</span><span id="__span-133-52"><a id="__codelineno-133-52" name="__codelineno-133-52" href="#__codelineno-133-52"></a>
</span><span id="__span-133-53"><a id="__codelineno-133-53" name="__codelineno-133-53" href="#__codelineno-133-53"></a>    <span class="c1"># Compute metrics</span>
</span><span id="__span-133-54"><a id="__codelineno-133-54" name="__codelineno-133-54" href="#__codelineno-133-54"></a>    <span class="n">mae</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-133-55"><a id="__codelineno-133-55" name="__codelineno-133-55" href="#__codelineno-133-55"></a>    <span class="n">rmse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-133-56"><a id="__codelineno-133-56" name="__codelineno-133-56" href="#__codelineno-133-56"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">predictions</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-133-57"><a id="__codelineno-133-57" name="__codelineno-133-57" href="#__codelineno-133-57"></a>
</span><span id="__span-133-58"><a id="__codelineno-133-58" name="__codelineno-133-58" href="#__codelineno-133-58"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-133-59"><a id="__codelineno-133-59" name="__codelineno-133-59" href="#__codelineno-133-59"></a>        <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">),</span>
</span><span id="__span-133-60"><a id="__codelineno-133-60" name="__codelineno-133-60" href="#__codelineno-133-60"></a>        <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span>
</span><span id="__span-133-61"><a id="__codelineno-133-61" name="__codelineno-133-61" href="#__codelineno-133-61"></a>        <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
</span><span id="__span-133-62"><a id="__codelineno-133-62" name="__codelineno-133-62" href="#__codelineno-133-62"></a>        <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
</span><span id="__span-133-63"><a id="__codelineno-133-63" name="__codelineno-133-63" href="#__codelineno-133-63"></a>        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">,</span>
</span><span id="__span-133-64"><a id="__codelineno-133-64" name="__codelineno-133-64" href="#__codelineno-133-64"></a>        <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="n">targets</span>
</span><span id="__span-133-65"><a id="__codelineno-133-65" name="__codelineno-133-65" href="#__codelineno-133-65"></a>    <span class="p">}</span>
</span><span id="__span-133-66"><a id="__codelineno-133-66" name="__codelineno-133-66" href="#__codelineno-133-66"></a>
</span><span id="__span-133-67"><a id="__codelineno-133-67" name="__codelineno-133-67" href="#__codelineno-133-67"></a><span class="c1"># Setup training</span>
</span><span id="__span-133-68"><a id="__codelineno-133-68" name="__codelineno-133-68" href="#__codelineno-133-68"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</span><span id="__span-133-69"><a id="__codelineno-133-69" name="__codelineno-133-69" href="#__codelineno-133-69"></a><span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="__span-133-70"><a id="__codelineno-133-70" name="__codelineno-133-70" href="#__codelineno-133-70"></a>    <span class="n">optimizer</span><span class="p">,</span> 
</span><span id="__span-133-71"><a id="__codelineno-133-71" name="__codelineno-133-71" href="#__codelineno-133-71"></a>    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> 
</span><span id="__span-133-72"><a id="__codelineno-133-72" name="__codelineno-133-72" href="#__codelineno-133-72"></a>    <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Reduce LR by half</span>
</span><span id="__span-133-73"><a id="__codelineno-133-73" name="__codelineno-133-73" href="#__codelineno-133-73"></a>    <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># Wait 10 epochs before reducing</span>
</span><span id="__span-133-74"><a id="__codelineno-133-74" name="__codelineno-133-74" href="#__codelineno-133-74"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-133-75"><a id="__codelineno-133-75" name="__codelineno-133-75" href="#__codelineno-133-75"></a>    <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span>  <span class="c1"># Don&#39;t go below this</span>
</span><span id="__span-133-76"><a id="__codelineno-133-76" name="__codelineno-133-76" href="#__codelineno-133-76"></a><span class="p">)</span>
</span><span id="__span-133-77"><a id="__codelineno-133-77" name="__codelineno-133-77" href="#__codelineno-133-77"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>  <span class="c1"># MAE loss</span>
</span><span id="__span-133-78"><a id="__codelineno-133-78" name="__codelineno-133-78" href="#__codelineno-133-78"></a>
</span><span id="__span-133-79"><a id="__codelineno-133-79" name="__codelineno-133-79" href="#__codelineno-133-79"></a><span class="c1"># Training loop</span>
</span><span id="__span-133-80"><a id="__codelineno-133-80" name="__codelineno-133-80" href="#__codelineno-133-80"></a><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="__span-133-81"><a id="__codelineno-133-81" name="__codelineno-133-81" href="#__codelineno-133-81"></a><span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="__span-133-82"><a id="__codelineno-133-82" name="__codelineno-133-82" href="#__codelineno-133-82"></a><span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-133-83"><a id="__codelineno-133-83" name="__codelineno-133-83" href="#__codelineno-133-83"></a><span class="n">early_stop_patience</span> <span class="o">=</span> <span class="mi">30</span>
</span><span id="__span-133-84"><a id="__codelineno-133-84" name="__codelineno-133-84" href="#__codelineno-133-84"></a>
</span><span id="__span-133-85"><a id="__codelineno-133-85" name="__codelineno-133-85" href="#__codelineno-133-85"></a><span class="c1"># Track history</span>
</span><span id="__span-133-86"><a id="__codelineno-133-86" name="__codelineno-133-86" href="#__codelineno-133-86"></a><span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-133-87"><a id="__codelineno-133-87" name="__codelineno-133-87" href="#__codelineno-133-87"></a>    <span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-133-88"><a id="__codelineno-133-88" name="__codelineno-133-88" href="#__codelineno-133-88"></a>    <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-133-89"><a id="__codelineno-133-89" name="__codelineno-133-89" href="#__codelineno-133-89"></a>    <span class="s1">&#39;val_mae&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-133-90"><a id="__codelineno-133-90" name="__codelineno-133-90" href="#__codelineno-133-90"></a>    <span class="s1">&#39;val_r2&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-133-91"><a id="__codelineno-133-91" name="__codelineno-133-91" href="#__codelineno-133-91"></a>    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="__span-133-92"><a id="__codelineno-133-92" name="__codelineno-133-92" href="#__codelineno-133-92"></a><span class="p">}</span>
</span><span id="__span-133-93"><a id="__codelineno-133-93" name="__codelineno-133-93" href="#__codelineno-133-93"></a>
</span><span id="__span-133-94"><a id="__codelineno-133-94" name="__codelineno-133-94" href="#__codelineno-133-94"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting training for </span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2"> epochs...&quot;</span><span class="p">)</span>
</span><span id="__span-133-95"><a id="__codelineno-133-95" name="__codelineno-133-95" href="#__codelineno-133-95"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</span><span id="__span-133-96"><a id="__codelineno-133-96" name="__codelineno-133-96" href="#__codelineno-133-96"></a>
</span><span id="__span-133-97"><a id="__codelineno-133-97" name="__codelineno-133-97" href="#__codelineno-133-97"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
</span><span id="__span-133-98"><a id="__codelineno-133-98" name="__codelineno-133-98" href="#__codelineno-133-98"></a>    <span class="c1"># Train</span>
</span><span id="__span-133-99"><a id="__codelineno-133-99" name="__codelineno-133-99" href="#__codelineno-133-99"></a>    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-133-100"><a id="__codelineno-133-100" name="__codelineno-133-100" href="#__codelineno-133-100"></a>
</span><span id="__span-133-101"><a id="__codelineno-133-101" name="__codelineno-133-101" href="#__codelineno-133-101"></a>    <span class="c1"># Evaluate</span>
</span><span id="__span-133-102"><a id="__codelineno-133-102" name="__codelineno-133-102" href="#__codelineno-133-102"></a>    <span class="n">val_metrics</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-133-103"><a id="__codelineno-133-103" name="__codelineno-133-103" href="#__codelineno-133-103"></a>    <span class="n">val_loss</span> <span class="o">=</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
</span><span id="__span-133-104"><a id="__codelineno-133-104" name="__codelineno-133-104" href="#__codelineno-133-104"></a>    <span class="n">val_mae</span> <span class="o">=</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
</span><span id="__span-133-105"><a id="__codelineno-133-105" name="__codelineno-133-105" href="#__codelineno-133-105"></a>    <span class="n">val_r2</span> <span class="o">=</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span>
</span><span id="__span-133-106"><a id="__codelineno-133-106" name="__codelineno-133-106" href="#__codelineno-133-106"></a>
</span><span id="__span-133-107"><a id="__codelineno-133-107" name="__codelineno-133-107" href="#__codelineno-133-107"></a>    <span class="c1"># Learning rate scheduling</span>
</span><span id="__span-133-108"><a id="__codelineno-133-108" name="__codelineno-133-108" href="#__codelineno-133-108"></a>    <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-133-109"><a id="__codelineno-133-109" name="__codelineno-133-109" href="#__codelineno-133-109"></a>    <span class="n">current_lr</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
</span><span id="__span-133-110"><a id="__codelineno-133-110" name="__codelineno-133-110" href="#__codelineno-133-110"></a>
</span><span id="__span-133-111"><a id="__codelineno-133-111" name="__codelineno-133-111" href="#__codelineno-133-111"></a>    <span class="c1"># Store history</span>
</span><span id="__span-133-112"><a id="__codelineno-133-112" name="__codelineno-133-112" href="#__codelineno-133-112"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
</span><span id="__span-133-113"><a id="__codelineno-133-113" name="__codelineno-133-113" href="#__codelineno-133-113"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-133-114"><a id="__codelineno-133-114" name="__codelineno-133-114" href="#__codelineno-133-114"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_mae</span><span class="p">)</span>
</span><span id="__span-133-115"><a id="__codelineno-133-115" name="__codelineno-133-115" href="#__codelineno-133-115"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_r2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_r2</span><span class="p">)</span>
</span><span id="__span-133-116"><a id="__codelineno-133-116" name="__codelineno-133-116" href="#__codelineno-133-116"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_lr</span><span class="p">)</span>
</span><span id="__span-133-117"><a id="__codelineno-133-117" name="__codelineno-133-117" href="#__codelineno-133-117"></a>
</span><span id="__span-133-118"><a id="__codelineno-133-118" name="__codelineno-133-118" href="#__codelineno-133-118"></a>    <span class="c1"># Save best model</span>
</span><span id="__span-133-119"><a id="__codelineno-133-119" name="__codelineno-133-119" href="#__codelineno-133-119"></a>    <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
</span><span id="__span-133-120"><a id="__codelineno-133-120" name="__codelineno-133-120" href="#__codelineno-133-120"></a>        <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
</span><span id="__span-133-121"><a id="__codelineno-133-121" name="__codelineno-133-121" href="#__codelineno-133-121"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
</span><span id="__span-133-122"><a id="__codelineno-133-122" name="__codelineno-133-122" href="#__codelineno-133-122"></a>            <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
</span><span id="__span-133-123"><a id="__codelineno-133-123" name="__codelineno-133-123" href="#__codelineno-133-123"></a>            <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="__span-133-124"><a id="__codelineno-133-124" name="__codelineno-133-124" href="#__codelineno-133-124"></a>            <span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="__span-133-125"><a id="__codelineno-133-125" name="__codelineno-133-125" href="#__codelineno-133-125"></a>            <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="n">val_loss</span><span class="p">,</span>
</span><span id="__span-133-126"><a id="__codelineno-133-126" name="__codelineno-133-126" href="#__codelineno-133-126"></a>            <span class="s1">&#39;val_mae&#39;</span><span class="p">:</span> <span class="n">val_mae</span><span class="p">,</span>
</span><span id="__span-133-127"><a id="__codelineno-133-127" name="__codelineno-133-127" href="#__codelineno-133-127"></a>        <span class="p">},</span> <span class="s1">&#39;best_gat_qm9.pt&#39;</span><span class="p">)</span>
</span><span id="__span-133-128"><a id="__codelineno-133-128" name="__codelineno-133-128" href="#__codelineno-133-128"></a>        <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-133-129"><a id="__codelineno-133-129" name="__codelineno-133-129" href="#__codelineno-133-129"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-133-130"><a id="__codelineno-133-130" name="__codelineno-133-130" href="#__codelineno-133-130"></a>        <span class="n">patience_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-133-131"><a id="__codelineno-133-131" name="__codelineno-133-131" href="#__codelineno-133-131"></a>
</span><span id="__span-133-132"><a id="__codelineno-133-132" name="__codelineno-133-132" href="#__codelineno-133-132"></a>    <span class="c1"># Print progress</span>
</span><span id="__span-133-133"><a id="__codelineno-133-133" name="__codelineno-133-133" href="#__codelineno-133-133"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-133-134"><a id="__codelineno-133-134" name="__codelineno-133-134" href="#__codelineno-133-134"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s1">3d</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
</span><span id="__span-133-135"><a id="__codelineno-133-135" name="__codelineno-133-135" href="#__codelineno-133-135"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-133-136"><a id="__codelineno-133-136" name="__codelineno-133-136" href="#__codelineno-133-136"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Val Loss:   </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">  |  MAE: </span><span class="si">{</span><span class="n">val_mae</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">  |  R²: </span><span class="si">{</span><span class="n">val_r2</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-133-137"><a id="__codelineno-133-137" name="__codelineno-133-137" href="#__codelineno-133-137"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  LR: </span><span class="si">{</span><span class="n">current_lr</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">  |  Best Val: </span><span class="si">{</span><span class="n">best_val_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">  |  Patience: </span><span class="si">{</span><span class="n">patience_counter</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">early_stop_patience</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-133-138"><a id="__codelineno-133-138" name="__codelineno-133-138" href="#__codelineno-133-138"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</span><span id="__span-133-139"><a id="__codelineno-133-139" name="__codelineno-133-139" href="#__codelineno-133-139"></a>
</span><span id="__span-133-140"><a id="__codelineno-133-140" name="__codelineno-133-140" href="#__codelineno-133-140"></a>    <span class="c1"># Early stopping</span>
</span><span id="__span-133-141"><a id="__codelineno-133-141" name="__codelineno-133-141" href="#__codelineno-133-141"></a>    <span class="k">if</span> <span class="n">patience_counter</span> <span class="o">&gt;=</span> <span class="n">early_stop_patience</span><span class="p">:</span>
</span><span id="__span-133-142"><a id="__codelineno-133-142" name="__codelineno-133-142" href="#__codelineno-133-142"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Early stopping triggered at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-133-143"><a id="__codelineno-133-143" name="__codelineno-133-143" href="#__codelineno-133-143"></a>        <span class="k">break</span>
</span><span id="__span-133-144"><a id="__codelineno-133-144" name="__codelineno-133-144" href="#__codelineno-133-144"></a>
</span><span id="__span-133-145"><a id="__codelineno-133-145" name="__codelineno-133-145" href="#__codelineno-133-145"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</span><span id="__span-133-146"><a id="__codelineno-133-146" name="__codelineno-133-146" href="#__codelineno-133-146"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training completed!&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 4: Model Evaluation and Analysis</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="c1"># Load best model</span>
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loading best model...&quot;</span><span class="p">)</span>
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;best_gat_qm9.pt&#39;</span><span class="p">)</span>
</span><span id="__span-134-4"><a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
</span><span id="__span-134-5"><a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best model from epoch </span><span class="si">{</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-134-6"><a id="__codelineno-134-6" name="__codelineno-134-6" href="#__codelineno-134-6"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best validation MAE: </span><span class="si">{</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> eV&quot;</span><span class="p">)</span>
</span><span id="__span-134-7"><a id="__codelineno-134-7" name="__codelineno-134-7" href="#__codelineno-134-7"></a>
</span><span id="__span-134-8"><a id="__codelineno-134-8" name="__codelineno-134-8" href="#__codelineno-134-8"></a><span class="c1"># Evaluate on test set</span>
</span><span id="__span-134-9"><a id="__codelineno-134-9" name="__codelineno-134-9" href="#__codelineno-134-9"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluating on test set...&quot;</span><span class="p">)</span>
</span><span id="__span-134-10"><a id="__codelineno-134-10" name="__codelineno-134-10" href="#__codelineno-134-10"></a><span class="n">test_metrics</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-134-11"><a id="__codelineno-134-11" name="__codelineno-134-11" href="#__codelineno-134-11"></a>
</span><span id="__span-134-12"><a id="__codelineno-134-12" name="__codelineno-134-12" href="#__codelineno-134-12"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test Set Results:&quot;</span><span class="p">)</span>
</span><span id="__span-134-13"><a id="__codelineno-134-13" name="__codelineno-134-13" href="#__codelineno-134-13"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Loss: </span><span class="si">{</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-134-14"><a id="__codelineno-134-14" name="__codelineno-134-14" href="#__codelineno-134-14"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MAE:  </span><span class="si">{</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> eV&quot;</span><span class="p">)</span>
</span><span id="__span-134-15"><a id="__codelineno-134-15" name="__codelineno-134-15" href="#__codelineno-134-15"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RMSE: </span><span class="si">{</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> eV&quot;</span><span class="p">)</span>
</span><span id="__span-134-16"><a id="__codelineno-134-16" name="__codelineno-134-16" href="#__codelineno-134-16"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R²:   </span><span class="si">{</span><span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-134-17"><a id="__codelineno-134-17" name="__codelineno-134-17" href="#__codelineno-134-17"></a>
</span><span id="__span-134-18"><a id="__codelineno-134-18" name="__codelineno-134-18" href="#__codelineno-134-18"></a><span class="c1"># Plot training curves</span>
</span><span id="__span-134-19"><a id="__codelineno-134-19" name="__codelineno-134-19" href="#__codelineno-134-19"></a><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span><span id="__span-134-20"><a id="__codelineno-134-20" name="__codelineno-134-20" href="#__codelineno-134-20"></a>
</span><span id="__span-134-21"><a id="__codelineno-134-21" name="__codelineno-134-21" href="#__codelineno-134-21"></a><span class="c1"># Loss curves</span>
</span><span id="__span-134-22"><a id="__codelineno-134-22" name="__codelineno-134-22" href="#__codelineno-134-22"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-134-23"><a id="__codelineno-134-23" name="__codelineno-134-23" href="#__codelineno-134-23"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-134-24"><a id="__codelineno-134-24" name="__codelineno-134-24" href="#__codelineno-134-24"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-134-25"><a id="__codelineno-134-25" name="__codelineno-134-25" href="#__codelineno-134-25"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss (MAE)&#39;</span><span class="p">)</span>
</span><span id="__span-134-26"><a id="__codelineno-134-26" name="__codelineno-134-26" href="#__codelineno-134-26"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Training and Validation Loss&#39;</span><span class="p">)</span>
</span><span id="__span-134-27"><a id="__codelineno-134-27" name="__codelineno-134-27" href="#__codelineno-134-27"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-134-28"><a id="__codelineno-134-28" name="__codelineno-134-28" href="#__codelineno-134-28"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-134-29"><a id="__codelineno-134-29" name="__codelineno-134-29" href="#__codelineno-134-29"></a>
</span><span id="__span-134-30"><a id="__codelineno-134-30" name="__codelineno-134-30" href="#__codelineno-134-30"></a><span class="c1"># MAE over epochs</span>
</span><span id="__span-134-31"><a id="__codelineno-134-31" name="__codelineno-134-31" href="#__codelineno-134-31"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-134-32"><a id="__codelineno-134-32" name="__codelineno-134-32" href="#__codelineno-134-32"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-134-33"><a id="__codelineno-134-33" name="__codelineno-134-33" href="#__codelineno-134-33"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MAE (eV)&#39;</span><span class="p">)</span>
</span><span id="__span-134-34"><a id="__codelineno-134-34" name="__codelineno-134-34" href="#__codelineno-134-34"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Validation MAE&#39;</span><span class="p">)</span>
</span><span id="__span-134-35"><a id="__codelineno-134-35" name="__codelineno-134-35" href="#__codelineno-134-35"></a><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-134-36"><a id="__codelineno-134-36" name="__codelineno-134-36" href="#__codelineno-134-36"></a>
</span><span id="__span-134-37"><a id="__codelineno-134-37" name="__codelineno-134-37" href="#__codelineno-134-37"></a><span class="c1"># R² over epochs</span>
</span><span id="__span-134-38"><a id="__codelineno-134-38" name="__codelineno-134-38" href="#__codelineno-134-38"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_r2&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-134-39"><a id="__codelineno-134-39" name="__codelineno-134-39" href="#__codelineno-134-39"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-134-40"><a id="__codelineno-134-40" name="__codelineno-134-40" href="#__codelineno-134-40"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R² Score&#39;</span><span class="p">)</span>
</span><span id="__span-134-41"><a id="__codelineno-134-41" name="__codelineno-134-41" href="#__codelineno-134-41"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Validation R²&#39;</span><span class="p">)</span>
</span><span id="__span-134-42"><a id="__codelineno-134-42" name="__codelineno-134-42" href="#__codelineno-134-42"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-134-43"><a id="__codelineno-134-43" name="__codelineno-134-43" href="#__codelineno-134-43"></a>
</span><span id="__span-134-44"><a id="__codelineno-134-44" name="__codelineno-134-44" href="#__codelineno-134-44"></a><span class="c1"># Learning rate schedule</span>
</span><span id="__span-134-45"><a id="__codelineno-134-45" name="__codelineno-134-45" href="#__codelineno-134-45"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-134-46"><a id="__codelineno-134-46" name="__codelineno-134-46" href="#__codelineno-134-46"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-134-47"><a id="__codelineno-134-47" name="__codelineno-134-47" href="#__codelineno-134-47"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Learning Rate&#39;</span><span class="p">)</span>
</span><span id="__span-134-48"><a id="__codelineno-134-48" name="__codelineno-134-48" href="#__codelineno-134-48"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Learning Rate Schedule&#39;</span><span class="p">)</span>
</span><span id="__span-134-49"><a id="__codelineno-134-49" name="__codelineno-134-49" href="#__codelineno-134-49"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="__span-134-50"><a id="__codelineno-134-50" name="__codelineno-134-50" href="#__codelineno-134-50"></a><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-134-51"><a id="__codelineno-134-51" name="__codelineno-134-51" href="#__codelineno-134-51"></a>
</span><span id="__span-134-52"><a id="__codelineno-134-52" name="__codelineno-134-52" href="#__codelineno-134-52"></a><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-134-53"><a id="__codelineno-134-53" name="__codelineno-134-53" href="#__codelineno-134-53"></a><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;training_curves.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</span><span id="__span-134-54"><a id="__codelineno-134-54" name="__codelineno-134-54" href="#__codelineno-134-54"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved: training_curves.png&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Step 5: Visualization and Interpretation</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_predictions</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">):</span>
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create comprehensive prediction plots&quot;&quot;&quot;</span>
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a>
</span><span id="__span-135-4"><a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a>    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-135-5"><a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a>    <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-135-6"><a id="__codelineno-135-6" name="__codelineno-135-6" href="#__codelineno-135-6"></a>
</span><span id="__span-135-7"><a id="__codelineno-135-7" name="__codelineno-135-7" href="#__codelineno-135-7"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="__span-135-8"><a id="__codelineno-135-8" name="__codelineno-135-8" href="#__codelineno-135-8"></a>
</span><span id="__span-135-9"><a id="__codelineno-135-9" name="__codelineno-135-9" href="#__codelineno-135-9"></a>    <span class="c1"># Scatter plot: Predicted vs Actual</span>
</span><span id="__span-135-10"><a id="__codelineno-135-10" name="__codelineno-135-10" href="#__codelineno-135-10"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="__span-135-11"><a id="__codelineno-135-11" name="__codelineno-135-11" href="#__codelineno-135-11"></a>
</span><span id="__span-135-12"><a id="__codelineno-135-12" name="__codelineno-135-12" href="#__codelineno-135-12"></a>    <span class="c1"># Perfect prediction line</span>
</span><span id="__span-135-13"><a id="__codelineno-135-13" name="__codelineno-135-13" href="#__codelineno-135-13"></a>    <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">predictions</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">predictions</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</span><span id="__span-135-14"><a id="__codelineno-135-14" name="__codelineno-135-14" href="#__codelineno-135-14"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">],</span> <span class="p">[</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Perfect Prediction&#39;</span><span class="p">)</span>
</span><span id="__span-135-15"><a id="__codelineno-135-15" name="__codelineno-135-15" href="#__codelineno-135-15"></a>
</span><span id="__span-135-16"><a id="__codelineno-135-16" name="__codelineno-135-16" href="#__codelineno-135-16"></a>    <span class="c1"># Add statistics text</span>
</span><span id="__span-135-17"><a id="__codelineno-135-17" name="__codelineno-135-17" href="#__codelineno-135-17"></a>    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
</span><span id="__span-135-18"><a id="__codelineno-135-18" name="__codelineno-135-18" href="#__codelineno-135-18"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
</span><span id="__span-135-19"><a id="__codelineno-135-19" name="__codelineno-135-19" href="#__codelineno-135-19"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
</span><span id="__span-135-20"><a id="__codelineno-135-20" name="__codelineno-135-20" href="#__codelineno-135-20"></a>        <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span>
</span><span id="__span-135-21"><a id="__codelineno-135-21" name="__codelineno-135-21" href="#__codelineno-135-21"></a>        <span class="sa">f</span><span class="s1">&#39;MAE = </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> eV</span><span class="se">\n</span><span class="s1">R² = </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="__span-135-22"><a id="__codelineno-135-22" name="__codelineno-135-22" href="#__codelineno-135-22"></a>        <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
</span><span id="__span-135-23"><a id="__codelineno-135-23" name="__codelineno-135-23" href="#__codelineno-135-23"></a>        <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="__span-135-24"><a id="__codelineno-135-24" name="__codelineno-135-24" href="#__codelineno-135-24"></a>        <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
</span><span id="__span-135-25"><a id="__codelineno-135-25" name="__codelineno-135-25" href="#__codelineno-135-25"></a>        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-135-26"><a id="__codelineno-135-26" name="__codelineno-135-26" href="#__codelineno-135-26"></a>    <span class="p">)</span>
</span><span id="__span-135-27"><a id="__codelineno-135-27" name="__codelineno-135-27" href="#__codelineno-135-27"></a>
</span><span id="__span-135-28"><a id="__codelineno-135-28" name="__codelineno-135-28" href="#__codelineno-135-28"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Actual </span><span class="si">{</span><span class="n">target_name</span><span class="si">}</span><span class="s1"> (eV)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="__span-135-29"><a id="__codelineno-135-29" name="__codelineno-135-29" href="#__codelineno-135-29"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Predicted </span><span class="si">{</span><span class="n">target_name</span><span class="si">}</span><span class="s1"> (eV)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="__span-135-30"><a id="__codelineno-135-30" name="__codelineno-135-30" href="#__codelineno-135-30"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s1"> Set: Predictions vs Actual&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="__span-135-31"><a id="__codelineno-135-31" name="__codelineno-135-31" href="#__codelineno-135-31"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-135-32"><a id="__codelineno-135-32" name="__codelineno-135-32" href="#__codelineno-135-32"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-135-33"><a id="__codelineno-135-33" name="__codelineno-135-33" href="#__codelineno-135-33"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
</span><span id="__span-135-34"><a id="__codelineno-135-34" name="__codelineno-135-34" href="#__codelineno-135-34"></a>
</span><span id="__span-135-35"><a id="__codelineno-135-35" name="__codelineno-135-35" href="#__codelineno-135-35"></a>    <span class="c1"># Error distribution</span>
</span><span id="__span-135-36"><a id="__codelineno-135-36" name="__codelineno-135-36" href="#__codelineno-135-36"></a>    <span class="n">errors</span> <span class="o">=</span> <span class="n">predictions</span> <span class="o">-</span> <span class="n">targets</span>
</span><span id="__span-135-37"><a id="__codelineno-135-37" name="__codelineno-135-37" href="#__codelineno-135-37"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;coral&#39;</span><span class="p">)</span>
</span><span id="__span-135-38"><a id="__codelineno-135-38" name="__codelineno-135-38" href="#__codelineno-135-38"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Zero Error&#39;</span><span class="p">)</span>
</span><span id="__span-135-39"><a id="__codelineno-135-39" name="__codelineno-135-39" href="#__codelineno-135-39"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Prediction Error (eV)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="__span-135-40"><a id="__codelineno-135-40" name="__codelineno-135-40" href="#__codelineno-135-40"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="__span-135-41"><a id="__codelineno-135-41" name="__codelineno-135-41" href="#__codelineno-135-41"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Error Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="__span-135-42"><a id="__codelineno-135-42" name="__codelineno-135-42" href="#__codelineno-135-42"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-135-43"><a id="__codelineno-135-43" name="__codelineno-135-43" href="#__codelineno-135-43"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-135-44"><a id="__codelineno-135-44" name="__codelineno-135-44" href="#__codelineno-135-44"></a>
</span><span id="__span-135-45"><a id="__codelineno-135-45" name="__codelineno-135-45" href="#__codelineno-135-45"></a>    <span class="c1"># Error vs actual value</span>
</span><span id="__span-135-46"><a id="__codelineno-135-46" name="__codelineno-135-46" href="#__codelineno-135-46"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">errors</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
</span><span id="__span-135-47"><a id="__codelineno-135-47" name="__codelineno-135-47" href="#__codelineno-135-47"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">mae</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean MAE = </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-135-48"><a id="__codelineno-135-48" name="__codelineno-135-48" href="#__codelineno-135-48"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Actual </span><span class="si">{</span><span class="n">target_name</span><span class="si">}</span><span class="s1"> (eV)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="__span-135-49"><a id="__codelineno-135-49" name="__codelineno-135-49" href="#__codelineno-135-49"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Absolute Error (eV)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="__span-135-50"><a id="__codelineno-135-50" name="__codelineno-135-50" href="#__codelineno-135-50"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Absolute Error vs Actual Value&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="__span-135-51"><a id="__codelineno-135-51" name="__codelineno-135-51" href="#__codelineno-135-51"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-135-52"><a id="__codelineno-135-52" name="__codelineno-135-52" href="#__codelineno-135-52"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-135-53"><a id="__codelineno-135-53" name="__codelineno-135-53" href="#__codelineno-135-53"></a>
</span><span id="__span-135-54"><a id="__codelineno-135-54" name="__codelineno-135-54" href="#__codelineno-135-54"></a>    <span class="c1"># Q-Q plot (Quantile-Quantile)</span>
</span><span id="__span-135-55"><a id="__codelineno-135-55" name="__codelineno-135-55" href="#__codelineno-135-55"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
</span><span id="__span-135-56"><a id="__codelineno-135-56" name="__codelineno-135-56" href="#__codelineno-135-56"></a>    <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="__span-135-57"><a id="__codelineno-135-57" name="__codelineno-135-57" href="#__codelineno-135-57"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot (Error Normality)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="__span-135-58"><a id="__codelineno-135-58" name="__codelineno-135-58" href="#__codelineno-135-58"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-135-59"><a id="__codelineno-135-59" name="__codelineno-135-59" href="#__codelineno-135-59"></a>
</span><span id="__span-135-60"><a id="__codelineno-135-60" name="__codelineno-135-60" href="#__codelineno-135-60"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-135-61"><a id="__codelineno-135-61" name="__codelineno-135-61" href="#__codelineno-135-61"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dataset_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_predictions.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</span><span id="__span-135-62"><a id="__codelineno-135-62" name="__codelineno-135-62" href="#__codelineno-135-62"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved: </span><span class="si">{</span><span class="n">dataset_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_predictions.png&quot;</span><span class="p">)</span>
</span><span id="__span-135-63"><a id="__codelineno-135-63" name="__codelineno-135-63" href="#__codelineno-135-63"></a>
</span><span id="__span-135-64"><a id="__codelineno-135-64" name="__codelineno-135-64" href="#__codelineno-135-64"></a><span class="c1"># Plot test set predictions</span>
</span><span id="__span-135-65"><a id="__codelineno-135-65" name="__codelineno-135-65" href="#__codelineno-135-65"></a><span class="n">plot_predictions</span><span class="p">(</span>
</span><span id="__span-135-66"><a id="__codelineno-135-66" name="__codelineno-135-66" href="#__codelineno-135-66"></a>    <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">],</span>
</span><span id="__span-135-67"><a id="__codelineno-135-67" name="__codelineno-135-67" href="#__codelineno-135-67"></a>    <span class="n">test_metrics</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">],</span>
</span><span id="__span-135-68"><a id="__codelineno-135-68" name="__codelineno-135-68" href="#__codelineno-135-68"></a>    <span class="n">dataset_name</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span>
</span><span id="__span-135-69"><a id="__codelineno-135-69" name="__codelineno-135-69" href="#__codelineno-135-69"></a><span class="p">)</span>
</span><span id="__span-135-70"><a id="__codelineno-135-70" name="__codelineno-135-70" href="#__codelineno-135-70"></a>
</span><span id="__span-135-71"><a id="__codelineno-135-71" name="__codelineno-135-71" href="#__codelineno-135-71"></a><span class="c1"># Analyze errors by molecule size</span>
</span><span id="__span-135-72"><a id="__codelineno-135-72" name="__codelineno-135-72" href="#__codelineno-135-72"></a><span class="k">def</span><span class="w"> </span><span class="nf">analyze_errors_by_size</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="__span-135-73"><a id="__codelineno-135-73" name="__codelineno-135-73" href="#__codelineno-135-73"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze how prediction error varies with molecule size&quot;&quot;&quot;</span>
</span><span id="__span-135-74"><a id="__codelineno-135-74" name="__codelineno-135-74" href="#__codelineno-135-74"></a>
</span><span id="__span-135-75"><a id="__codelineno-135-75" name="__codelineno-135-75" href="#__codelineno-135-75"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-135-76"><a id="__codelineno-135-76" name="__codelineno-135-76" href="#__codelineno-135-76"></a>    <span class="n">errors_by_size</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)}</span>
</span><span id="__span-135-77"><a id="__codelineno-135-77" name="__codelineno-135-77" href="#__codelineno-135-77"></a>
</span><span id="__span-135-78"><a id="__codelineno-135-78" name="__codelineno-135-78" href="#__codelineno-135-78"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-135-79"><a id="__codelineno-135-79" name="__codelineno-135-79" href="#__codelineno-135-79"></a>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
</span><span id="__span-135-80"><a id="__codelineno-135-80" name="__codelineno-135-80" href="#__codelineno-135-80"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-135-81"><a id="__codelineno-135-81" name="__codelineno-135-81" href="#__codelineno-135-81"></a>            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-135-82"><a id="__codelineno-135-82" name="__codelineno-135-82" href="#__codelineno-135-82"></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">target_idx</span><span class="p">]</span>
</span><span id="__span-135-83"><a id="__codelineno-135-83" name="__codelineno-135-83" href="#__codelineno-135-83"></a>            <span class="n">errors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="__span-135-84"><a id="__codelineno-135-84" name="__codelineno-135-84" href="#__codelineno-135-84"></a>
</span><span id="__span-135-85"><a id="__codelineno-135-85" name="__codelineno-135-85" href="#__codelineno-135-85"></a>            <span class="c1"># Group by number of atoms</span>
</span><span id="__span-135-86"><a id="__codelineno-135-86" name="__codelineno-135-86" href="#__codelineno-135-86"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
</span><span id="__span-135-87"><a id="__codelineno-135-87" name="__codelineno-135-87" href="#__codelineno-135-87"></a>                <span class="n">num_atoms</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-135-88"><a id="__codelineno-135-88" name="__codelineno-135-88" href="#__codelineno-135-88"></a>                <span class="k">if</span> <span class="n">num_atoms</span> <span class="ow">in</span> <span class="n">errors_by_size</span><span class="p">:</span>
</span><span id="__span-135-89"><a id="__codelineno-135-89" name="__codelineno-135-89" href="#__codelineno-135-89"></a>                    <span class="n">errors_by_size</span><span class="p">[</span><span class="n">num_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="__span-135-90"><a id="__codelineno-135-90" name="__codelineno-135-90" href="#__codelineno-135-90"></a>
</span><span id="__span-135-91"><a id="__codelineno-135-91" name="__codelineno-135-91" href="#__codelineno-135-91"></a>    <span class="c1"># Plot</span>
</span><span id="__span-135-92"><a id="__codelineno-135-92" name="__codelineno-135-92" href="#__codelineno-135-92"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="__span-135-93"><a id="__codelineno-135-93" name="__codelineno-135-93" href="#__codelineno-135-93"></a>    <span class="n">sizes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">errors_by_size</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="__span-135-94"><a id="__codelineno-135-94" name="__codelineno-135-94" href="#__codelineno-135-94"></a>    <span class="n">mean_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">errors_by_size</span><span class="p">[</span><span class="n">size</span><span class="p">])</span> <span class="k">if</span> <span class="n">errors_by_size</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">]</span>
</span><span id="__span-135-95"><a id="__codelineno-135-95" name="__codelineno-135-95" href="#__codelineno-135-95"></a>    <span class="n">std_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">errors_by_size</span><span class="p">[</span><span class="n">size</span><span class="p">])</span> <span class="k">if</span> <span class="n">errors_by_size</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">]</span>
</span><span id="__span-135-96"><a id="__codelineno-135-96" name="__codelineno-135-96" href="#__codelineno-135-96"></a>
</span><span id="__span-135-97"><a id="__codelineno-135-97" name="__codelineno-135-97" href="#__codelineno-135-97"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">mean_errors</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std_errors</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-135-98"><a id="__codelineno-135-98" name="__codelineno-135-98" href="#__codelineno-135-98"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Heavy Atoms&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="__span-135-99"><a id="__codelineno-135-99" name="__codelineno-135-99" href="#__codelineno-135-99"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Absolute Error (eV)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="__span-135-100"><a id="__codelineno-135-100" name="__codelineno-135-100" href="#__codelineno-135-100"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Prediction Error vs Molecule Size&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="__span-135-101"><a id="__codelineno-135-101" name="__codelineno-135-101" href="#__codelineno-135-101"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-135-102"><a id="__codelineno-135-102" name="__codelineno-135-102" href="#__codelineno-135-102"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-135-103"><a id="__codelineno-135-103" name="__codelineno-135-103" href="#__codelineno-135-103"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;error_by_size.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</span><span id="__span-135-104"><a id="__codelineno-135-104" name="__codelineno-135-104" href="#__codelineno-135-104"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved: error_by_size.png&quot;</span><span class="p">)</span>
</span><span id="__span-135-105"><a id="__codelineno-135-105" name="__codelineno-135-105" href="#__codelineno-135-105"></a>
</span><span id="__span-135-106"><a id="__codelineno-135-106" name="__codelineno-135-106" href="#__codelineno-135-106"></a>    <span class="k">return</span> <span class="n">errors_by_size</span>
</span><span id="__span-135-107"><a id="__codelineno-135-107" name="__codelineno-135-107" href="#__codelineno-135-107"></a>
</span><span id="__span-135-108"><a id="__codelineno-135-108" name="__codelineno-135-108" href="#__codelineno-135-108"></a><span class="n">errors_by_size</span> <span class="o">=</span> <span class="n">analyze_errors_by_size</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="expected__results">Expected Results<a class="headerlink" href="#expected__results" title="Permanent link">&para;</a></h4>
<p><strong>Performance Benchmarks:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a>For HOMO energy prediction (in meV):
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a>
</span><span id="__span-136-3"><a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a>Method          MAE     RMSE    R²      Parameters
</span><span id="__span-136-4"><a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a>Baseline        300     420     0.00    -
</span><span id="__span-136-5"><a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a>Linear          180     250     0.45    10K
</span><span id="__span-136-6"><a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a>MLP             120     170     0.72    50K
</span><span id="__span-136-7"><a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a>GCN             45      65      0.94    500K
</span><span id="__span-136-8"><a id="__codelineno-136-8" name="__codelineno-136-8" href="#__codelineno-136-8"></a>GAT (ours)      35-40   50-55   0.96    800K
</span><span id="__span-136-9"><a id="__codelineno-136-9" name="__codelineno-136-9" href="#__codelineno-136-9"></a>DimeNet++       25-30   40-45   0.98    2M
</span><span id="__span-136-10"><a id="__codelineno-136-10" name="__codelineno-136-10" href="#__codelineno-136-10"></a>
</span><span id="__span-136-11"><a id="__codelineno-136-11" name="__codelineno-136-11" href="#__codelineno-136-11"></a>Note: Results vary by hyperparameters and random seed
</span></code></pre></div>
<p><strong>Training Time:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a>Hardware: Single GPU (V100)
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a>Batch size: 32
</span><span id="__span-137-3"><a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a>Epochs: ~100-150 to convergence
</span><span id="__span-137-4"><a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a>
</span><span id="__span-137-5"><a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a>Time per epoch: ~30 seconds
</span><span id="__span-137-6"><a id="__codelineno-137-6" name="__codelineno-137-6" href="#__codelineno-137-6"></a>Total training: ~60-90 minutes
</span><span id="__span-137-7"><a id="__codelineno-137-7" name="__codelineno-137-7" href="#__codelineno-137-7"></a>Inference: ~1000 molecules/second
</span></code></pre></div>
<h4 id="extension__ideas">Extension Ideas<a class="headerlink" href="#extension__ideas" title="Permanent link">&para;</a></h4>
<p><strong>1. Multi-Task Learning</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MultiTaskGAT</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-138-2"><a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Predict multiple properties simultaneously&quot;&quot;&quot;</span>
</span><span id="__span-138-3"><a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_tasks</span><span class="o">=</span><span class="mi">19</span><span class="p">):</span>
</span><span id="__span-138-4"><a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-138-5"><a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a>        <span class="c1"># Shared encoder</span>
</span><span id="__span-138-6"><a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">GATEncoder</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-138-7"><a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a>
</span><span id="__span-138-8"><a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a>        <span class="c1"># Separate heads for each task</span>
</span><span id="__span-138-9"><a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_heads</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
</span><span id="__span-138-10"><a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">)</span>
</span><span id="__span-138-11"><a id="__codelineno-138-11" name="__codelineno-138-11" href="#__codelineno-138-11"></a>        <span class="p">])</span>
</span><span id="__span-138-12"><a id="__codelineno-138-12" name="__codelineno-138-12" href="#__codelineno-138-12"></a>
</span><span id="__span-138-13"><a id="__codelineno-138-13" name="__codelineno-138-13" href="#__codelineno-138-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="__span-138-14"><a id="__codelineno-138-14" name="__codelineno-138-14" href="#__codelineno-138-14"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-138-15"><a id="__codelineno-138-15" name="__codelineno-138-15" href="#__codelineno-138-15"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">head</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_heads</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-138-16"><a id="__codelineno-138-16" name="__codelineno-138-16" href="#__codelineno-138-16"></a>
</span><span id="__span-138-17"><a id="__codelineno-138-17" name="__codelineno-138-17" href="#__codelineno-138-17"></a><span class="c1"># Train with multi-task loss</span>
</span><span id="__span-138-18"><a id="__codelineno-138-18" name="__codelineno-138-18" href="#__codelineno-138-18"></a><span class="n">loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">target</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span></code></pre></div>
<p><strong>2. Add 3D Distance Information</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a><span class="c1"># Add edge features based on 3D distances</span>
</span><span id="__span-139-2"><a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a><span class="n">edge_attr</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-139-3"><a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a><span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">t</span><span class="p">():</span>
</span><span id="__span-139-4"><a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a>    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">edge</span>
</span><span id="__span-139-5"><a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a>    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span id="__span-139-6"><a id="__codelineno-139-6" name="__codelineno-139-6" href="#__codelineno-139-6"></a>
</span><span id="__span-139-7"><a id="__codelineno-139-7" name="__codelineno-139-7" href="#__codelineno-139-7"></a>    <span class="c1"># Gaussian RBF encoding</span>
</span><span id="__span-139-8"><a id="__codelineno-139-8" name="__codelineno-139-8" href="#__codelineno-139-8"></a>    <span class="n">rbf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">dist</span> <span class="o">-</span> <span class="n">centers</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span>
</span><span id="__span-139-9"><a id="__codelineno-139-9" name="__codelineno-139-9" href="#__codelineno-139-9"></a>    <span class="n">edge_attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbf</span><span class="p">)</span>
</span><span id="__span-139-10"><a id="__codelineno-139-10" name="__codelineno-139-10" href="#__codelineno-139-10"></a>
</span><span id="__span-139-11"><a id="__codelineno-139-11" name="__codelineno-139-11" href="#__codelineno-139-11"></a><span class="c1"># Use in GAT</span>
</span><span id="__span-139-12"><a id="__codelineno-139-12" name="__codelineno-139-12" href="#__codelineno-139-12"></a><span class="n">model</span> <span class="o">=</span> <span class="n">GATConv</span><span class="p">(</span><span class="n">edge_dim</span><span class="o">=</span><span class="n">num_rbf</span><span class="p">)</span>  <span class="c1"># Enable edge features</span>
</span></code></pre></div>
<p><strong>3. Attention Visualization</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_attention</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">molecule_idx</span><span class="p">):</span>
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize attention weights for a molecule&quot;&quot;&quot;</span>
</span><span id="__span-140-3"><a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a>
</span><span id="__span-140-4"><a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">molecule_idx</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-140-5"><a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-140-6"><a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a>
</span><span id="__span-140-7"><a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a>    <span class="c1"># Hook to capture attention</span>
</span><span id="__span-140-8"><a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a>    <span class="n">attention_weights</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-140-9"><a id="__codelineno-140-9" name="__codelineno-140-9" href="#__codelineno-140-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">hook_fn</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</span><span id="__span-140-10"><a id="__codelineno-140-10" name="__codelineno-140-10" href="#__codelineno-140-10"></a>        <span class="c1"># GATConv returns (output, attention_weights)</span>
</span><span id="__span-140-11"><a id="__codelineno-140-11" name="__codelineno-140-11" href="#__codelineno-140-11"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-140-12"><a id="__codelineno-140-12" name="__codelineno-140-12" href="#__codelineno-140-12"></a>            <span class="n">attention_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</span><span id="__span-140-13"><a id="__codelineno-140-13" name="__codelineno-140-13" href="#__codelineno-140-13"></a>
</span><span id="__span-140-14"><a id="__codelineno-140-14" name="__codelineno-140-14" href="#__codelineno-140-14"></a>    <span class="c1"># Register hooks on GAT layers</span>
</span><span id="__span-140-15"><a id="__codelineno-140-15" name="__codelineno-140-15" href="#__codelineno-140-15"></a>    <span class="n">hooks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-140-16"><a id="__codelineno-140-16" name="__codelineno-140-16" href="#__codelineno-140-16"></a>    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">gat_layers</span><span class="p">:</span>
</span><span id="__span-140-17"><a id="__codelineno-140-17" name="__codelineno-140-17" href="#__codelineno-140-17"></a>        <span class="n">hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">hook_fn</span><span class="p">))</span>
</span><span id="__span-140-18"><a id="__codelineno-140-18" name="__codelineno-140-18" href="#__codelineno-140-18"></a>
</span><span id="__span-140-19"><a id="__codelineno-140-19" name="__codelineno-140-19" href="#__codelineno-140-19"></a>    <span class="c1"># Forward pass</span>
</span><span id="__span-140-20"><a id="__codelineno-140-20" name="__codelineno-140-20" href="#__codelineno-140-20"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-140-21"><a id="__codelineno-140-21" name="__codelineno-140-21" href="#__codelineno-140-21"></a>        <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-140-22"><a id="__codelineno-140-22" name="__codelineno-140-22" href="#__codelineno-140-22"></a>
</span><span id="__span-140-23"><a id="__codelineno-140-23" name="__codelineno-140-23" href="#__codelineno-140-23"></a>    <span class="c1"># Remove hooks</span>
</span><span id="__span-140-24"><a id="__codelineno-140-24" name="__codelineno-140-24" href="#__codelineno-140-24"></a>    <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
</span><span id="__span-140-25"><a id="__codelineno-140-25" name="__codelineno-140-25" href="#__codelineno-140-25"></a>        <span class="n">hook</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</span><span id="__span-140-26"><a id="__codelineno-140-26" name="__codelineno-140-26" href="#__codelineno-140-26"></a>
</span><span id="__span-140-27"><a id="__codelineno-140-27" name="__codelineno-140-27" href="#__codelineno-140-27"></a>    <span class="c1"># Visualize (requires RDKit or py3Dmol)</span>
</span><span id="__span-140-28"><a id="__codelineno-140-28" name="__codelineno-140-28" href="#__codelineno-140-28"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
</span><span id="__span-140-29"><a id="__codelineno-140-29" name="__codelineno-140-29" href="#__codelineno-140-29"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Draw</span>
</span><span id="__span-140-30"><a id="__codelineno-140-30" name="__codelineno-140-30" href="#__codelineno-140-30"></a>
</span><span id="__span-140-31"><a id="__codelineno-140-31" name="__codelineno-140-31" href="#__codelineno-140-31"></a>    <span class="c1"># Highlight high-attention bonds</span>
</span><span id="__span-140-32"><a id="__codelineno-140-32" name="__codelineno-140-32" href="#__codelineno-140-32"></a>    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>  <span class="c1"># If SMILES available</span>
</span><span id="__span-140-33"><a id="__codelineno-140-33" name="__codelineno-140-33" href="#__codelineno-140-33"></a>    <span class="n">highlight_bonds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-140-34"><a id="__codelineno-140-34" name="__codelineno-140-34" href="#__codelineno-140-34"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">t</span><span class="p">()):</span>
</span><span id="__span-140-35"><a id="__codelineno-140-35" name="__codelineno-140-35" href="#__codelineno-140-35"></a>        <span class="k">if</span> <span class="n">attention_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-140-36"><a id="__codelineno-140-36" name="__codelineno-140-36" href="#__codelineno-140-36"></a>            <span class="n">highlight_bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetBondBetweenAtoms</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">())</span>
</span><span id="__span-140-37"><a id="__codelineno-140-37" name="__codelineno-140-37" href="#__codelineno-140-37"></a>
</span><span id="__span-140-38"><a id="__codelineno-140-38" name="__codelineno-140-38" href="#__codelineno-140-38"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolToImage</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">highlightBonds</span><span class="o">=</span><span class="n">highlight_bonds</span><span class="p">)</span>
</span><span id="__span-140-39"><a id="__codelineno-140-39" name="__codelineno-140-39" href="#__codelineno-140-39"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="__span-140-40"><a id="__codelineno-140-40" name="__codelineno-140-40" href="#__codelineno-140-40"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="__span-140-41"><a id="__codelineno-140-41" name="__codelineno-140-41" href="#__codelineno-140-41"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;attention_mol_</span><span class="si">{</span><span class="n">molecule_idx</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>4. Hyperparameter Tuning</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">optuna</span>
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a>
</span><span id="__span-141-3"><a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
</span><span id="__span-141-4"><a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a>    <span class="c1"># Suggest hyperparameters</span>
</span><span id="__span-141-5"><a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a>    <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;hidden_dim&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
</span><span id="__span-141-6"><a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a>    <span class="n">num_heads</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;num_heads&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="__span-141-7"><a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a>    <span class="n">num_layers</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;num_layers&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</span><span id="__span-141-8"><a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a>    <span class="n">dropout</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;dropout&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-141-9"><a id="__codelineno-141-9" name="__codelineno-141-9" href="#__codelineno-141-9"></a>    <span class="n">lr</span> <span class="o">=</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_loguniform</span><span class="p">(</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
</span><span id="__span-141-10"><a id="__codelineno-141-10" name="__codelineno-141-10" href="#__codelineno-141-10"></a>
</span><span id="__span-141-11"><a id="__codelineno-141-11" name="__codelineno-141-11" href="#__codelineno-141-11"></a>    <span class="c1"># Train model</span>
</span><span id="__span-141-12"><a id="__codelineno-141-12" name="__codelineno-141-12" href="#__codelineno-141-12"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">GATForQM9</span><span class="p">(</span><span class="n">hidden_dim</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span><span id="__span-141-13"><a id="__codelineno-141-13" name="__codelineno-141-13" href="#__codelineno-141-13"></a>    <span class="c1"># ... training loop ...</span>
</span><span id="__span-141-14"><a id="__codelineno-141-14" name="__codelineno-141-14" href="#__codelineno-141-14"></a>
</span><span id="__span-141-15"><a id="__codelineno-141-15" name="__codelineno-141-15" href="#__codelineno-141-15"></a>    <span class="k">return</span> <span class="n">val_mae</span>
</span><span id="__span-141-16"><a id="__codelineno-141-16" name="__codelineno-141-16" href="#__codelineno-141-16"></a>
</span><span id="__span-141-17"><a id="__codelineno-141-17" name="__codelineno-141-17" href="#__codelineno-141-17"></a><span class="c1"># Run optimization</span>
</span><span id="__span-141-18"><a id="__codelineno-141-18" name="__codelineno-141-18" href="#__codelineno-141-18"></a><span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;minimize&#39;</span><span class="p">)</span>
</span><span id="__span-141-19"><a id="__codelineno-141-19" name="__codelineno-141-19" href="#__codelineno-141-19"></a><span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-141-20"><a id="__codelineno-141-20" name="__codelineno-141-20" href="#__codelineno-141-20"></a>
</span><span id="__span-141-21"><a id="__codelineno-141-21" name="__codelineno-141-21" href="#__codelineno-141-21"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best hyperparameters: </span><span class="si">{</span><span class="n">study</span><span class="o">.</span><span class="n">best_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>5. Ensemble Methods</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="c1"># Train multiple models with different seeds</span>
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a><span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a><span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-142-4"><a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-142-5"><a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">GATForQM9</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-142-6"><a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a>    <span class="c1"># ... train model ...</span>
</span><span id="__span-142-7"><a id="__codelineno-142-7" name="__codelineno-142-7" href="#__codelineno-142-7"></a>    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-142-8"><a id="__codelineno-142-8" name="__codelineno-142-8" href="#__codelineno-142-8"></a>
</span><span id="__span-142-9"><a id="__codelineno-142-9" name="__codelineno-142-9" href="#__codelineno-142-9"></a><span class="c1"># Ensemble prediction</span>
</span><span id="__span-142-10"><a id="__codelineno-142-10" name="__codelineno-142-10" href="#__codelineno-142-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">ensemble_predict</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="__span-142-11"><a id="__codelineno-142-11" name="__codelineno-142-11" href="#__codelineno-142-11"></a>    <span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
</span><span id="__span-142-12"><a id="__codelineno-142-12" name="__codelineno-142-12" href="#__codelineno-142-12"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-142-13"><a id="__codelineno-142-13" name="__codelineno-142-13" href="#__codelineno-142-13"></a>
</span><span id="__span-142-14"><a id="__codelineno-142-14" name="__codelineno-142-14" href="#__codelineno-142-14"></a><span class="c1"># Usually 2-5% better than single model</span>
</span></code></pre></div>
<p>This practical provides a complete, production-ready implementation of GAT for molecular property prediction with extensive analysis and interpretation tools.</p>
<hr />
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>Today we covered the fundamentals of graph neural networks and their applications in computational chemistry and materials science:</p>
<ol>
<li><strong>Message Passing Neural Networks</strong> provide a flexible framework for learning on graphs</li>
<li><strong>Graph Attention Networks</strong> learn adaptive edge weights through attention mechanisms</li>
<li><strong>Equivariant Networks</strong> (SchNet, DimeNet, PaiNN) respect 3D geometric symmetries</li>
<li><strong>Protein-Ligand Modeling</strong> enables AI-driven drug discovery</li>
<li><strong>Crystal Structure Prediction</strong> accelerates materials discovery</li>
<li><strong>Practical Implementation</strong> demonstrated how to build and train GATs on real molecular data</li>
</ol>
<h2 id="additional__resources">Additional Resources<a class="headerlink" href="#additional__resources" title="Permanent link">&para;</a></h2>
<p><strong>Papers:</strong>
- &ldquo;Neural Message Passing for Quantum Chemistry&rdquo; (Gilmer et al., 2017)
- &ldquo;Graph Attention Networks&rdquo; (Veličković et al., 2018)
- &ldquo;SchNet: A continuous-filter convolutional neural network&rdquo; (Schütt et al., 2017)
- &ldquo;Directional Message Passing for Molecular Graphs&rdquo; (Klicpera et al., 2020)
- &ldquo;Equivariant message passing for the prediction of tensorial properties&rdquo; (Schütt et al., 2021)</p>
<p><strong>Tutorials:</strong>
- PyTorch Geometric documentation and tutorials
- Open Catalyst Project tutorials
- Deep Graph Library (DGL) examples</p>
<p><strong>Datasets:</strong>
- QM9: Small organic molecules
- PCQM4M: Large-scale quantum chemistry dataset
- Materials Project: Inorganic crystals
- PDBbind: Protein-ligand binding affinities
- Open Catalyst: Catalytic materials</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../day2/" class="btn btn-neutral float-left" title="Neural Networks"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../day4/" class="btn btn-neutral float-right" title="Generative Models">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../day2/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../day4/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../assets/_markdown_exec_pyodide.js"></script>
      <script src="../search/main.js"></script>
      <script src="../js/open_in_new_tab.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
