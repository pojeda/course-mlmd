<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://pojeda.github.io/course-mlmd/day2/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Neural Networks - ML/MD course</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_markdown_exec_pyodide.css" rel="stylesheet" />
        <link href="../assets/_markdown_exec_ansi.css" rel="stylesheet" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Neural Networks";
        var mkdocs_page_input_path = "day2.md";
        var mkdocs_page_url = "/course-mlmd/day2/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../images/hpc2n-qmmm.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../day0/">Introduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 1</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../day1/">ML for Molecular Systems</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 2</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Neural Networks</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#table__of__contents">Table of Contents</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#1__deep__learning__fundamentals">1. Deep Learning Fundamentals</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#11__why__deep__learning__for__molecules">1.1 Why Deep Learning for Molecules?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#12__neural__network__basics">1.2 Neural Network Basics</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#13__activation__functions">1.3 Activation Functions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#14__loss__functions__and__backpropagation">1.4 Loss Functions and Backpropagation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#15__optimization__algorithms">1.5 Optimization Algorithms</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2__feedforward__neural__networks">2. Feedforward Neural Networks</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#21__architecture__design">2.1 Architecture Design</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#22__full__training__example">2.2 Full Training Example</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#23__best__practices__and__tips">2.3 Best Practices and Tips</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#3__multi-task__learning">3. Multi-Task Learning</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#31__why__and__when__to__use__multi-task__learning">3.1 Why and When to Use Multi-Task Learning</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#32__multi-task__architecture">3.2 Multi-Task Architecture</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#33__training__strategies">3.3 Training Strategies</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#34__task__balancing__techniques">3.4 Task Balancing Techniques</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#35__performance__comparison">3.5 Performance Comparison</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#4__convolutional__neural__networks">4. Convolutional Neural Networks</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#41__1d__cnns__for__smiles">4.1 1D CNNs for SMILES</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#42__2d__cnns__for__molecular__images">4.2 2D CNNs for Molecular Images</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#43__when__to__use__each__approach">4.3 When to Use Each Approach</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#5__recurrent__neural__networks">5. Recurrent Neural Networks</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#51__lstm__for__smiles__sequences">5.1 LSTM for SMILES Sequences</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#52__gru__alternative">5.2 GRU Alternative</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#53__comparison__with__cnns">5.3 Comparison with CNNs</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#6__transfer__learning">6. Transfer Learning</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#61__why__transfer__learning__for__molecules">6.1 Why Transfer Learning for Molecules</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#62__pre-training__strategies">6.2 Pre-Training Strategies</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#63__fine-tuning__workflow">6.3 Fine-Tuning Workflow</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#64__pre-trained__models__chemberta">6.4 Pre-Trained Models (ChemBERTa)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#65__results__and__comparisons">6.5 Results and Comparisons</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#7__complete__practical__exercise">7. Complete Practical Exercise</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#71__problem__bbb__permeability__prediction">7.1 Problem: BBB Permeability Prediction</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#72__full__pipeline">7.2 Full Pipeline</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#73__expected__output">7.3 Expected Output</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#8__model__interpretation">8. Model Interpretation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#81__gradient-based__importance">8.1 Gradient-Based Importance</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#82__integrated__gradients">8.2 Integrated Gradients</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#83__activation__maximization">8.3 Activation Maximization</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#9__best__practices">9. Best Practices</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#91__hyperparameter__tuning__with__optuna">9.1 Hyperparameter Tuning with Optuna</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#92__complete__debugging__checklist">9.2 Complete Debugging Checklist</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#93__common__issues__and__solutions">9.3 Common Issues and Solutions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#10__key__takeaways">10. Key Takeaways</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#11__resources">11. Resources</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#111__essential__papers">11.1 Essential Papers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#112__software__libraries">11.2 Software Libraries</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#113__datasets">11.3 Datasets</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#114__online__courses__and__tutorials">11.4 Online Courses and Tutorials</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#115__useful__blogs__and__articles">11.5 Useful Blogs and Articles</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#116__community__and__forums">11.6 Community and Forums</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#12__homework__assignment">12. Homework Assignment</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#instructions">Instructions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__1__implement__a__custom__neural__network__10__points">Exercise 1: Implement a Custom Neural Network (10 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__2__activation__function__comparison__8__points">Exercise 2: Activation Function Comparison (8 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__3__implement__multi-task__learning__12__points">Exercise 3: Implement Multi-Task Learning (12 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__4__smiles__cnn__implementation__10__points">Exercise 4: SMILES CNN Implementation (10 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__5__lstm__vs__gru__comparison__10__points">Exercise 5: LSTM vs GRU Comparison (10 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__6__transfer__learning__experiment__12__points">Exercise 6: Transfer Learning Experiment (12 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__7__model__interpretation__10__points">Exercise 7: Model Interpretation (10 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__8__hyperparameter__tuning__with__optuna__10__points">Exercise 8: Hyperparameter Tuning with Optuna (10 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__9__complete__pipeline__development__15__points">Exercise 9: Complete Pipeline Development (15 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exercise__10__research__paper__implementation__13__points">Exercise 10: Research Paper Implementation (13 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#bonus__exercise__ensemble__methods__5__points">Bonus Exercise: Ensemble Methods (+5 points)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#submission__guidelines">Submission Guidelines</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#13__appendix">13. Appendix</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#appendix__a__complete__feedforward__nn__template">Appendix A: Complete Feedforward NN Template</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#appendix__b__smiles__processing__utilities">Appendix B: SMILES Processing Utilities</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#appendix__c__model__evaluation__suite">Appendix C: Model Evaluation Suite</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 3</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../day3/">Graph Neural Networks</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 4</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../day4/">Generative Models</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Day 5</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../day5/">Advanced Models</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="../summary.md">Summary</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">ML/MD course</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Day 2</li>
      <li class="breadcrumb-item active">Neural Networks</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="day__2__deep__learning__for__molecular__systems">Day 2: Deep Learning for Molecular Systems<a class="headerlink" href="#day__2__deep__learning__for__molecular__systems" title="Permanent link">&para;</a></h1>
<p><strong>Machine Learning for Molecular Systems - Advanced Course</strong></p>
<p><em>Course Module 2: Neural Networks and Deep Learning Applications</em></p>
<hr />
<h2 id="table__of__contents">Table of Contents<a class="headerlink" href="#table__of__contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-deep-learning-fundamentals">Deep Learning Fundamentals</a></li>
<li><a href="#2-feedforward-neural-networks">Feedforward Neural Networks</a></li>
<li><a href="#3-multi-task-learning">Multi-Task Learning</a></li>
<li><a href="#4-convolutional-neural-networks">Convolutional Neural Networks</a></li>
<li><a href="#5-recurrent-neural-networks">Recurrent Neural Networks</a></li>
<li><a href="#6-transfer-learning">Transfer Learning</a></li>
<li><a href="#7-complete-practical-exercise">Complete Practical Exercise</a></li>
<li><a href="#8-model-interpretation">Model Interpretation</a></li>
<li><a href="#9-best-practices">Best Practices</a></li>
<li><a href="#10-key-takeaways">Key Takeaways</a></li>
<li><a href="#11-resources">Resources</a></li>
<li><a href="#12-homework-assignment">Homework Assignment</a></li>
<li><a href="#13-appendix">Appendix</a></li>
</ol>
<hr />
<h2 id="1__deep__learning__fundamentals">1. Deep Learning Fundamentals<a class="headerlink" href="#1__deep__learning__fundamentals" title="Permanent link">&para;</a></h2>
<h3 id="11__why__deep__learning__for__molecules">1.1 Why Deep Learning for Molecules?<a class="headerlink" href="#11__why__deep__learning__for__molecules" title="Permanent link">&para;</a></h3>
<p>Deep learning has revolutionized molecular property prediction by automatically learning complex representations from raw molecular data. Unlike traditional machine learning approaches that rely on hand-crafted descriptors, deep learning models can:</p>
<p><strong>Key Advantages:</strong></p>
<ul>
<li><strong>Automatic Feature Learning</strong>: Neural networks learn hierarchical representations directly from molecular structures (SMILES, graphs, 3D coordinates) without manual feature engineering</li>
<li><strong>Complex Pattern Recognition</strong>: Capture non-linear relationships and subtle structural patterns that affect molecular properties</li>
<li><strong>Transfer Learning</strong>: Pre-trained models on large chemical databases can be fine-tuned for specific tasks with limited data</li>
<li><strong>End-to-End Learning</strong>: Direct mapping from molecular representation to property prediction in a single unified model</li>
<li><strong>Multi-Task Learning</strong>: Simultaneously predict multiple properties, sharing learned representations across tasks</li>
</ul>
<p><strong>Detailed Examples:</strong></p>
<p><strong>Example 1: Solubility Prediction</strong>
Traditional ML approach requires calculating molecular descriptors (LogP, molecular weight, H-bond donors/acceptors). Deep learning models can learn these patterns directly from SMILES strings:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Input: &quot;CC(=O)OC1=CC=CC=C1C(=O)O&quot; (Aspirin)
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>Model learns: aromatic rings → non-polar regions
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             carboxyl groups → polar regions
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>             overall balance → solubility estimate
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>Output: LogS = -1.5 (moderate solubility)
</span></code></pre></div>
<p><strong>Example 2: Toxicity Prediction</strong>
Deep learning excels at identifying toxic substructures (toxicophores) without explicit rules:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Model automatically learns:
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>- Aromatic amines → potential carcinogens
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>- Epoxides → DNA reactivity
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>- Nitro groups → mutagenicity risk
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>- Combination patterns → synergistic effects
</span></code></pre></div>
<p><strong>Example 3: Drug-Likeness</strong>
Rather than using Lipinski&rsquo;s Rule of Five, neural networks learn implicit drug-likeness:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Training on FDA-approved drugs, the model learns:
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>- Optimal molecular weight ranges
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>- Hydrogen bonding patterns
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>- Lipophilicity balance
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>- Metabolic stability indicators
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>- Blood-brain barrier permeability
</span></code></pre></div>
<h3 id="12__neural__network__basics">1.2 Neural Network Basics<a class="headerlink" href="#12__neural__network__basics" title="Permanent link">&para;</a></h3>
<p>A neural network consists of interconnected layers of artificial neurons that transform input data through learned weights and biases.</p>
<p><strong>Architecture Components:</strong></p>
<p><strong>Input Layer</strong>: Receives molecular features (fingerprints, descriptors, or embeddings)
- Size determined by feature dimension
- No activation function applied</p>
<p><strong>Hidden Layers</strong>: Transform inputs through non-linear operations
- Each neuron computes: <strong>z = Σ(w_i × x_i) + b</strong>
- Applies activation function: <strong>a = f(z)</strong>
- Multiple layers enable hierarchical feature learning</p>
<p><strong>Output Layer</strong>: Produces final predictions
- Regression: Single neuron with linear activation
- Binary classification: Single neuron with sigmoid activation
- Multi-class: Multiple neurons with softmax activation</p>
<p><strong>Mathematical Foundation:</strong></p>
<p>For a single neuron:
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Input: x = [x₁, x₂, ..., xₙ]
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>Weights: w = [w₁, w₂, ..., wₙ]
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>Bias: b
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>Linear transformation: z = w₁x₁ + w₂x₂ + ... + wₙxₙ + b = w^T x + b
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>Activation: a = f(z)
</span></code></pre></div></p>
<p>For a layer:
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Z^[l] = W^[l] × A^[l-1] + b^[l]
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>A^[l] = f(Z^[l])
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>Where:
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>- l = layer index
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>- W^[l] = weight matrix for layer l
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>- A^[l-1] = activations from previous layer
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>- b^[l] = bias vector for layer l
</span></code></pre></div></p>
<p><strong>Forward Propagation Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Simple 3-layer network</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">forward_propagation</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="sd">    X: input features (n_features, m_samples)</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="sd">    parameters: dictionary containing W1, b1, W2, b2, W3, b3</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="c1"># Layer 1: Input → Hidden (128 neurons)</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;W1&#39;</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;b1&#39;</span><span class="p">]</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="n">A1</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">Z1</span><span class="p">)</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="c1"># Layer 2: Hidden → Hidden (64 neurons)</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="n">Z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;W2&#39;</span><span class="p">],</span> <span class="n">A1</span><span class="p">)</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="n">A2</span> <span class="o">=</span> <span class="n">relu</span><span class="p">(</span><span class="n">Z2</span><span class="p">)</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="c1"># Layer 3: Hidden → Output (1 neuron for regression)</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="n">Z3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;W3&#39;</span><span class="p">],</span> <span class="n">A2</span><span class="p">)</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;b3&#39;</span><span class="p">]</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span class="n">A3</span> <span class="o">=</span> <span class="n">Z3</span>  <span class="c1"># Linear activation for regression</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>    <span class="n">cache</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="n">Z1</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">:</span> <span class="n">A1</span><span class="p">,</span> <span class="s1">&#39;Z2&#39;</span><span class="p">:</span> <span class="n">Z2</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">:</span> <span class="n">A2</span><span class="p">,</span> <span class="s1">&#39;Z3&#39;</span><span class="p">:</span> <span class="n">Z3</span><span class="p">,</span> <span class="s1">&#39;A3&#39;</span><span class="p">:</span> <span class="n">A3</span><span class="p">}</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="k">return</span> <span class="n">A3</span><span class="p">,</span> <span class="n">cache</span>
</span></code></pre></div>
<h3 id="13__activation__functions">1.3 Activation Functions<a class="headerlink" href="#13__activation__functions" title="Permanent link">&para;</a></h3>
<p>Activation functions introduce non-linearity, enabling neural networks to learn complex patterns.</p>
<p><strong>ReLU (Rectified Linear Unit)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>f(x) = max(0, x)
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>f&#39;(x) = 1 if x &gt; 0, else 0
</span></code></pre></div></p>
<p><strong>Advantages:</strong>
- Computationally efficient
- Helps mitigate vanishing gradient problem
- Induces sparsity (many neurons output 0)
- Default choice for hidden layers</p>
<p><strong>Disadvantages:</strong>
- Dead ReLU problem (neurons stuck at 0)
- Not zero-centered</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">relu</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">relu_derivative</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Visualization Concept:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>   |     /
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>   |    /
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>   |   /
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>   |  /
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>___|/_________
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>   0
</span></code></pre></div></p>
<p><strong>Leaky ReLU</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>f(x) = max(0.01x, x)
</span></code></pre></div></p>
<p><strong>Advantages:</strong>
- Prevents dead neurons
- Small gradient for negative values</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">leaky_relu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Sigmoid</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>f(x) = 1 / (1 + e^(-x))
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>f&#39;(x) = f(x) × (1 - f(x))
</span></code></pre></div></p>
<p><strong>Use Cases:</strong>
- Binary classification output layer
- Gate mechanisms in LSTM/GRU</p>
<p><strong>Disadvantages:</strong>
- Vanishing gradient problem
- Not zero-centered
- Computationally expensive</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">sigmoid_derivative</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="k">return</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Tanh (Hyperbolic Tangent)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>f(x) = (e^x - e^(-x)) / (e^x + e^(-x))
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>f&#39;(x) = 1 - f(x)²
</span></code></pre></div></p>
<p><strong>Advantages:</strong>
- Zero-centered (better than sigmoid)
- Stronger gradients than sigmoid</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">tanh_derivative</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</span></code></pre></div>
<p><strong>Softmax (Multi-Class Output)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>f(x_i) = e^(x_i) / Σ(e^(x_j))
</span></code></pre></div></p>
<p><strong>Properties:</strong>
- Outputs sum to 1 (probability distribution)
- Used for multi-class classification</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="n">exp_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>  <span class="c1"># Numerical stability</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="k">return</span> <span class="n">exp_x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">exp_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Activation Function Selection Guide:</strong></p>
<table>
<thead>
<tr>
<th>Layer Type</th>
<th>Recommended Activation</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hidden layers (general)</td>
<td>ReLU</td>
<td>Fast, effective, prevents vanishing gradients</td>
</tr>
<tr>
<td>Hidden layers (negative values important)</td>
<td>Leaky ReLU / ELU</td>
<td>Allows negative activations</td>
</tr>
<tr>
<td>Output (regression)</td>
<td>Linear</td>
<td>Unrestricted output range</td>
</tr>
<tr>
<td>Output (binary classification)</td>
<td>Sigmoid</td>
<td>Output in [0, 1] range</td>
</tr>
<tr>
<td>Output (multi-class)</td>
<td>Softmax</td>
<td>Probability distribution</td>
</tr>
<tr>
<td>Recurrent networks</td>
<td>Tanh</td>
<td>Zero-centered, bounded</td>
</tr>
</tbody>
</table>
<h3 id="14__loss__functions__and__backpropagation">1.4 Loss Functions and Backpropagation<a class="headerlink" href="#14__loss__functions__and__backpropagation" title="Permanent link">&para;</a></h3>
<p><strong>Loss Functions</strong> quantify how well the model&rsquo;s predictions match the true values.</p>
<p><strong>Mean Squared Error (MSE) - Regression</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>L(y, ŷ) = (1/n) × Σ(y_i - ŷ_i)²
</span></code></pre></div></p>
<p><strong>Characteristics:</strong>
- Penalizes large errors more heavily
- Sensitive to outliers
- Smooth gradient</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">mse_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">mse_derivative</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Mean Absolute Error (MAE) - Robust Regression</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>L(y, ŷ) = (1/n) × Σ|y_i - ŷ_i|
</span></code></pre></div></p>
<p><strong>Advantages:</strong>
- Less sensitive to outliers
- All errors weighted equally</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">mae_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>
</span></code></pre></div>
<p><strong>Binary Cross-Entropy - Binary Classification</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>L(y, ŷ) = -(1/n) × Σ[y_i × log(ŷ_i) + (1-y_i) × log(1-ŷ_i)]
</span></code></pre></div></p>
<p><strong>Used when:</strong>
- Predicting probability of single class
- Output: sigmoid activation</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">binary_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-15</span>  <span class="c1"># Prevent log(0)</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>
</span></code></pre></div>
<p><strong>Categorical Cross-Entropy - Multi-Class Classification</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>L(y, ŷ) = -(1/n) × Σ Σ y_ij × log(ŷ_ij)
</span></code></pre></div></p>
<p><strong>Used when:</strong>
- Multiple mutually exclusive classes
- Output: softmax activation</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">categorical_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-15</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))</span> <span class="o">/</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Backpropagation Algorithm</strong></p>
<p>Backpropagation computes gradients of the loss with respect to all parameters using the chain rule.</p>
<p><strong>Algorithm Steps:</strong></p>
<ol>
<li><strong>Forward Pass</strong>: Compute predictions and loss</li>
<li><strong>Output Layer Gradient</strong>: ∂L/∂a^[L]</li>
<li><strong>Backward Pass</strong>: Compute gradients layer by layer</li>
<li><strong>Parameter Update</strong>: Update weights and biases</li>
</ol>
<p><strong>Mathematical Derivation:</strong></p>
<p>For layer l:
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>dZ^[l] = dA^[l] ⊙ f&#39;(Z^[l])
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>dW^[l] = (1/m) × dZ^[l] × A^[l-1]^T
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>db^[l] = (1/m) × Σ dZ^[l]
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>dA^[l-1] = W^[l]^T × dZ^[l]
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>Where:
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>- ⊙ represents element-wise multiplication
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>- f&#39; is the derivative of activation function
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>- m is the number of training examples
</span></code></pre></div></p>
<p><strong>Complete Backpropagation Implementation:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">backward_propagation</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="sd">    Implements backpropagation for 3-layer network</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="sd">    Args:</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="sd">        X: input features</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="sd">        Y: true labels</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="sd">        cache: forward propagation cache</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="sd">        parameters: model parameters (W1, b1, W2, b2, W3, b3)</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="sd">    Returns:</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="sd">        gradients: dictionary containing dW1, db1, dW2, db2, dW3, db3</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>    <span class="n">m</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>    <span class="c1"># Retrieve cached values</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>    <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">A3</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">],</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">],</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;A3&#39;</span><span class="p">]</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>    <span class="n">Z1</span><span class="p">,</span> <span class="n">Z2</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;Z1&#39;</span><span class="p">],</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;Z2&#39;</span><span class="p">]</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>    <span class="c1"># Output layer (Layer 3)</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>    <span class="n">dZ3</span> <span class="o">=</span> <span class="n">A3</span> <span class="o">-</span> <span class="n">Y</span>  <span class="c1"># For MSE loss with linear activation</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>    <span class="n">dW3</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dZ3</span><span class="p">,</span> <span class="n">A2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>    <span class="n">db3</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dZ3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>    <span class="c1"># Hidden layer 2</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>    <span class="n">dA2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;W3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dZ3</span><span class="p">)</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>    <span class="n">dZ2</span> <span class="o">=</span> <span class="n">dA2</span> <span class="o">*</span> <span class="n">relu_derivative</span><span class="p">(</span><span class="n">Z2</span><span class="p">)</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>    <span class="n">dW2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dZ2</span><span class="p">,</span> <span class="n">A1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>    <span class="n">db2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dZ2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>    <span class="c1"># Hidden layer 1</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>    <span class="n">dA1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;W2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dZ2</span><span class="p">)</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>    <span class="n">dZ1</span> <span class="o">=</span> <span class="n">dA1</span> <span class="o">*</span> <span class="n">relu_derivative</span><span class="p">(</span><span class="n">Z1</span><span class="p">)</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a>    <span class="n">dW1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dZ1</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>    <span class="n">db1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dZ1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a>    <span class="n">gradients</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a>        <span class="s1">&#39;dW1&#39;</span><span class="p">:</span> <span class="n">dW1</span><span class="p">,</span> <span class="s1">&#39;db1&#39;</span><span class="p">:</span> <span class="n">db1</span><span class="p">,</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>        <span class="s1">&#39;dW2&#39;</span><span class="p">:</span> <span class="n">dW2</span><span class="p">,</span> <span class="s1">&#39;db2&#39;</span><span class="p">:</span> <span class="n">db2</span><span class="p">,</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a>        <span class="s1">&#39;dW3&#39;</span><span class="p">:</span> <span class="n">dW3</span><span class="p">,</span> <span class="s1">&#39;db3&#39;</span><span class="p">:</span> <span class="n">db3</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a>    <span class="p">}</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a>    <span class="k">return</span> <span class="n">gradients</span>
</span></code></pre></div>
<h3 id="15__optimization__algorithms">1.5 Optimization Algorithms<a class="headerlink" href="#15__optimization__algorithms" title="Permanent link">&para;</a></h3>
<p>Optimization algorithms update model parameters to minimize the loss function.</p>
<p><strong>Gradient Descent (Batch)</strong></p>
<p>Updates parameters using the entire dataset:
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>W := W - α × ∂L/∂W
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>b := b - α × ∂L/∂b
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>Where α is the learning rate
</span></code></pre></div></p>
<p><strong>Pros</strong>: Stable convergence, exact gradient
<strong>Cons</strong>: Slow for large datasets, memory intensive</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">gradient_descent</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">):</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="sd">    Update parameters using batch gradient descent</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>        <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">[</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="k">return</span> <span class="n">parameters</span>
</span></code></pre></div>
<p><strong>Stochastic Gradient Descent (SGD)</strong></p>
<p>Updates parameters using one sample at a time:
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>W := W - α × ∂L_i/∂W  (for single sample i)
</span></code></pre></div></p>
<p><strong>Pros</strong>: Fast updates, can escape local minima
<strong>Cons</strong>: Noisy updates, unstable convergence</p>
<p><strong>Mini-Batch Gradient Descent</strong></p>
<p>Compromise between batch and stochastic (typically 32-256 samples):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">mini_batch_gradient_descent</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="sd">    Mini-batch gradient descent implementation</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="n">m</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>    <span class="n">num_batches</span> <span class="o">=</span> <span class="n">m</span> <span class="o">//</span> <span class="n">batch_size</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>        <span class="c1"># Get mini-batch</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">batch_size</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>        <span class="n">X_batch</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>        <span class="n">Y_batch</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>        <span class="c1"># Forward propagation</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>        <span class="n">A3</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">forward_propagation</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a>        <span class="c1"># Backward propagation</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>        <span class="n">gradients</span> <span class="o">=</span> <span class="n">backward_propagation</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">Y_batch</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>        <span class="c1"># Update parameters</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a>        <span class="n">parameters</span> <span class="o">=</span> <span class="n">gradient_descent</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">)</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a>    <span class="k">return</span> <span class="n">parameters</span>
</span></code></pre></div>
<p><strong>Momentum</strong></p>
<p>Accelerates SGD by accumulating velocity in relevant direction:
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>v := β × v + (1-β) × ∂L/∂W
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>W := W - α × v
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>Common β values: 0.9, 0.99
</span></code></pre></div></p>
<p><strong>Benefits:</strong>
- Smooths out oscillations
- Faster convergence
- Better navigation of ravines</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">momentum_optimizer</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="sd">    Parameters update with momentum</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>        <span class="c1"># Update velocity</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>        <span class="n">velocity</span><span class="p">[</span><span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">velocity</span><span class="p">[</span><span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">[</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>        <span class="c1"># Update parameters</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>        <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">velocity</span><span class="p">[</span><span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>    <span class="k">return</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">velocity</span>
</span></code></pre></div>
<p><strong>RMSprop (Root Mean Square Propagation)</strong></p>
<p>Adapts learning rate per parameter based on recent gradients:
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>s := β × s + (1-β) × (∂L/∂W)²
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>W := W - α × (∂L/∂W) / √(s + ε)
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>Where ε is a small constant for numerical stability (typically 1e-8)
</span></code></pre></div></p>
<p><strong>Benefits:</strong>
- Adaptive learning rates
- Works well for non-stationary objectives
- Good for RNNs</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">rmsprop_optimizer</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="sd">    RMSprop optimization</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>        <span class="c1"># Update cache (squared gradients)</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>        <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;s&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;s&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">[</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>        <span class="c1"># Update parameters</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>        <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">[</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cache</span><span class="p">[</span><span class="s1">&#39;s&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>    <span class="k">return</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">cache</span>
</span></code></pre></div>
<p><strong>Adam (Adaptive Moment Estimation)</strong></p>
<p>Combines momentum and RMSprop:
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>m := β₁ × m + (1-β₁) × ∂L/∂W          (momentum)
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>v := β₂ × v + (1-β₂) × (∂L/∂W)²       (RMSprop)
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>m̂ := m / (1-β₁^t)                      (bias correction)
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>v̂ := v / (1-β₂^t)                      (bias correction)
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>W := W - α × m̂ / (√v̂ + ε)
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>Common values: β₁=0.9, β₂=0.999, ε=1e-8
</span></code></pre></div></p>
<p><strong>Benefits:</strong>
- Most popular optimizer for deep learning
- Works well with sparse gradients
- Combines benefits of momentum and RMSprop
- Bias correction for initialization</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">adam_optimizer</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">adam_cache</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">beta1</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">beta2</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span> 
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>                   <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="sd">    Adam optimization with bias correction</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="sd">    Args:</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="sd">        t: iteration number (for bias correction)</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>        <span class="c1"># Update momentum</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>        <span class="n">adam_cache</span><span class="p">[</span><span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta1</span> <span class="o">*</span> <span class="n">adam_cache</span><span class="p">[</span><span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta1</span><span class="p">)</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">[</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>        <span class="c1"># Update RMSprop</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>        <span class="n">adam_cache</span><span class="p">[</span><span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">adam_cache</span><span class="p">[</span><span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta2</span><span class="p">)</span> <span class="o">*</span> <span class="n">gradients</span><span class="p">[</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>        <span class="c1"># Bias correction</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>        <span class="n">m_corrected</span> <span class="o">=</span> <span class="n">adam_cache</span><span class="p">[</span><span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta1</span><span class="o">**</span><span class="n">t</span><span class="p">)</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>        <span class="n">v_corrected</span> <span class="o">=</span> <span class="n">adam_cache</span><span class="p">[</span><span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta2</span><span class="o">**</span><span class="n">t</span><span class="p">)</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>        <span class="c1"># Update parameters</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a>        <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="n">learning_rate</span> <span class="o">*</span> <span class="n">m_corrected</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v_corrected</span><span class="p">)</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>    <span class="k">return</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">adam_cache</span>
</span></code></pre></div>
<p><strong>AdamW (Adam with Weight Decay)</strong></p>
<p>Adam with decoupled weight decay regularization:
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>W := W - α × (m̂ / (√v̂ + ε) + λ × W)
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>Where λ is the weight decay coefficient
</span></code></pre></div></p>
<p><strong>Benefits:</strong>
- Better generalization than Adam
- Proper weight decay implementation
- State-of-the-art for many tasks</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1"># Using PyTorch implementation</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Optimizer Selection Guide:</strong></p>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Recommended Optimizer</th>
<th>Learning Rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>General purpose / starting point</td>
<td>Adam</td>
<td>1e-3</td>
</tr>
<tr>
<td>Large dataset, need speed</td>
<td>SGD with momentum</td>
<td>1e-2 (with decay)</td>
</tr>
<tr>
<td>RNNs / sequence models</td>
<td>Adam or RMSprop</td>
<td>1e-3 to 1e-4</td>
</tr>
<tr>
<td>Fine-tuning pretrained models</td>
<td>AdamW</td>
<td>1e-5 to 1e-4</td>
</tr>
<tr>
<td>Non-stationary problems</td>
<td>RMSprop</td>
<td>1e-3</td>
</tr>
<tr>
<td>When overfitting occurs</td>
<td>AdamW or SGD</td>
<td>Lower rates</td>
</tr>
</tbody>
</table>
<p><strong>Learning Rate Scheduling:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Learning rate decay</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">lr_decay</span><span class="p">(</span><span class="n">initial_lr</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">decay_rate</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>    <span class="k">return</span> <span class="n">initial_lr</span> <span class="o">*</span> <span class="p">(</span><span class="n">decay_rate</span> <span class="o">**</span> <span class="n">epoch</span><span class="p">)</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="c1"># Step decay</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">step_decay</span><span class="p">(</span><span class="n">initial_lr</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">epochs_drop</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>    <span class="k">return</span> <span class="n">initial_lr</span> <span class="o">*</span> <span class="p">(</span><span class="n">drop</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">epoch</span> <span class="o">/</span> <span class="n">epochs_drop</span><span class="p">))</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="c1"># Cosine annealing</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">cosine_annealing</span><span class="p">(</span><span class="n">initial_lr</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">total_epochs</span><span class="p">):</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>    <span class="k">return</span> <span class="n">initial_lr</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">epoch</span> <span class="o">/</span> <span class="n">total_epochs</span><span class="p">))</span>
</span></code></pre></div>
<hr />
<h2 id="2__feedforward__neural__networks">2. Feedforward Neural Networks<a class="headerlink" href="#2__feedforward__neural__networks" title="Permanent link">&para;</a></h2>
<h3 id="21__architecture__design">2.1 Architecture Design<a class="headerlink" href="#21__architecture__design" title="Permanent link">&para;</a></h3>
<p>A feedforward neural network (FNN) is the simplest type of artificial neural network where information moves in only one direction—forward—from input to output.</p>
<p><strong>Design Principles:</strong></p>
<p><strong>Layer Size Guidelines:</strong>
- <strong>Input layer</strong>: Size = number of molecular features (e.g., 2048 for Morgan fingerprints)
- <strong>Hidden layers</strong>: Start with 128-256 neurons, gradually decrease
- <strong>Output layer</strong>: 
  - Regression: 1 neuron
  - Binary classification: 1 neuron
  - Multi-class: Number of classes</p>
<p><strong>Architecture Patterns:</strong></p>
<p><strong>Pattern 1: Pyramid Structure</strong> (Recommended for most molecular tasks)
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>Input (2048) → Hidden1 (512) → Hidden2 (256) → Hidden3 (128) → Output (1)
</span></code></pre></div>
- Progressively reduces dimensionality
- Learns hierarchical features</p>
<p><strong>Pattern 2: Hourglass Structure</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>Input (2048) → Hidden1 (256) → Hidden2 (128) → Hidden3 (256) → Output (1)
</span></code></pre></div>
- Creates bottleneck representation
- Useful for learning compressed features</p>
<p><strong>Pattern 3: Constant Width</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>Input (2048) → Hidden1 (256) → Hidden2 (256) → Hidden3 (256) → Output (1)
</span></code></pre></div>
- Maintains capacity throughout
- Good for complex non-linear mappings</p>
<p><strong>Depth vs Width Trade-off:</strong></p>
<table>
<thead>
<tr>
<th>Architecture</th>
<th>Pros</th>
<th>Cons</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td>Deep &amp; Narrow (5+ layers, 64-128 neurons)</td>
<td>Hierarchical features, fewer parameters</td>
<td>Harder to train, vanishing gradients</td>
<td>Complex patterns, large datasets</td>
</tr>
<tr>
<td>Shallow &amp; Wide (2-3 layers, 512+ neurons)</td>
<td>Easier to train, stable</td>
<td>More parameters, less hierarchical</td>
<td>Simple patterns, small datasets</td>
</tr>
<tr>
<td>Balanced (3-4 layers, 128-256 neurons)</td>
<td>Good trade-off</td>
<td>-</td>
<td>General purpose, recommended starting point</td>
</tr>
</tbody>
</table>
<p><strong>Complete Architecture Implementation:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">MolecularFNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="sd">    Feedforward Neural Network for molecular property prediction</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> 
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>                 <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="sd">        Args:</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="sd">            input_dim: Size of input features (e.g., fingerprint length)</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="sd">            hidden_dims: List of hidden layer sizes</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="sd">            output_dim: Number of output neurons (1 for regression)</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="sd">            dropout_rate: Dropout probability for regularization</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MolecularFNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>        <span class="c1"># Build layers dynamically</span>
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a>        <span class="n">prev_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a>
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a>        <span class="k">for</span> <span class="n">hidden_dim</span> <span class="ow">in</span> <span class="n">hidden_dims</span><span class="p">:</span>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">prev_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">))</span>
</span><span id="__span-43-26"><a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">))</span>  <span class="c1"># Batch normalization</span>
</span><span id="__span-43-27"><a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
</span><span id="__span-43-28"><a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">))</span>
</span><span id="__span-43-29"><a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a>            <span class="n">prev_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
</span><span id="__span-43-30"><a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a>
</span><span id="__span-43-31"><a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a>        <span class="c1"># Output layer</span>
</span><span id="__span-43-32"><a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">prev_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">))</span>
</span><span id="__span-43-33"><a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a>
</span><span id="__span-43-34"><a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span><span id="__span-43-35"><a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a>
</span><span id="__span-43-36"><a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a>        <span class="c1"># Initialize weights</span>
</span><span id="__span-43-37"><a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_weights</span><span class="p">()</span>
</span><span id="__span-43-38"><a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a>
</span><span id="__span-43-39"><a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-43-40"><a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;He initialization for ReLU networks&quot;&quot;&quot;</span>
</span><span id="__span-43-41"><a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-43-42"><a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-43-43"><a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_in&#39;</span><span class="p">,</span> <span class="n">nonlinearity</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span>
</span><span id="__span-43-44"><a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-43-45"><a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a>                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-43-46"><a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a>
</span><span id="__span-43-47"><a id="__codelineno-43-47" name="__codelineno-43-47" href="#__codelineno-43-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-43-48"><a id="__codelineno-43-48" name="__codelineno-43-48" href="#__codelineno-43-48"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-43-49"><a id="__codelineno-43-49" name="__codelineno-43-49" href="#__codelineno-43-49"></a><span class="sd">        Forward pass</span>
</span><span id="__span-43-50"><a id="__codelineno-43-50" name="__codelineno-43-50" href="#__codelineno-43-50"></a>
</span><span id="__span-43-51"><a id="__codelineno-43-51" name="__codelineno-43-51" href="#__codelineno-43-51"></a><span class="sd">        Args:</span>
</span><span id="__span-43-52"><a id="__codelineno-43-52" name="__codelineno-43-52" href="#__codelineno-43-52"></a><span class="sd">            x: Input tensor of shape (batch_size, input_dim)</span>
</span><span id="__span-43-53"><a id="__codelineno-43-53" name="__codelineno-43-53" href="#__codelineno-43-53"></a>
</span><span id="__span-43-54"><a id="__codelineno-43-54" name="__codelineno-43-54" href="#__codelineno-43-54"></a><span class="sd">        Returns:</span>
</span><span id="__span-43-55"><a id="__codelineno-43-55" name="__codelineno-43-55" href="#__codelineno-43-55"></a><span class="sd">            Output predictions of shape (batch_size, output_dim)</span>
</span><span id="__span-43-56"><a id="__codelineno-43-56" name="__codelineno-43-56" href="#__codelineno-43-56"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-43-57"><a id="__codelineno-43-57" name="__codelineno-43-57" href="#__codelineno-43-57"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-43-58"><a id="__codelineno-43-58" name="__codelineno-43-58" href="#__codelineno-43-58"></a>
</span><span id="__span-43-59"><a id="__codelineno-43-59" name="__codelineno-43-59" href="#__codelineno-43-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-43-60"><a id="__codelineno-43-60" name="__codelineno-43-60" href="#__codelineno-43-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-43-61"><a id="__codelineno-43-61" name="__codelineno-43-61" href="#__codelineno-43-61"></a><span class="sd">        Extract learned representations from second-to-last layer</span>
</span><span id="__span-43-62"><a id="__codelineno-43-62" name="__codelineno-43-62" href="#__codelineno-43-62"></a><span class="sd">        Useful for visualization and transfer learning</span>
</span><span id="__span-43-63"><a id="__codelineno-43-63" name="__codelineno-43-63" href="#__codelineno-43-63"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-43-64"><a id="__codelineno-43-64" name="__codelineno-43-64" href="#__codelineno-43-64"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># All layers except final</span>
</span><span id="__span-43-65"><a id="__codelineno-43-65" name="__codelineno-43-65" href="#__codelineno-43-65"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-43-66"><a id="__codelineno-43-66" name="__codelineno-43-66" href="#__codelineno-43-66"></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="__span-43-67"><a id="__codelineno-43-67" name="__codelineno-43-67" href="#__codelineno-43-67"></a>
</span><span id="__span-43-68"><a id="__codelineno-43-68" name="__codelineno-43-68" href="#__codelineno-43-68"></a><span class="c1"># Example instantiation</span>
</span><span id="__span-43-69"><a id="__codelineno-43-69" name="__codelineno-43-69" href="#__codelineno-43-69"></a><span class="n">model</span> <span class="o">=</span> <span class="n">MolecularFNN</span><span class="p">(</span>
</span><span id="__span-43-70"><a id="__codelineno-43-70" name="__codelineno-43-70" href="#__codelineno-43-70"></a>    <span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>           <span class="c1"># Morgan fingerprint size</span>
</span><span id="__span-43-71"><a id="__codelineno-43-71" name="__codelineno-43-71" href="#__codelineno-43-71"></a>    <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
</span><span id="__span-43-72"><a id="__codelineno-43-72" name="__codelineno-43-72" href="#__codelineno-43-72"></a>    <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>             <span class="c1"># Single regression output</span>
</span><span id="__span-43-73"><a id="__codelineno-43-73" name="__codelineno-43-73" href="#__codelineno-43-73"></a>    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span>
</span><span id="__span-43-74"><a id="__codelineno-43-74" name="__codelineno-43-74" href="#__codelineno-43-74"></a><span class="p">)</span>
</span><span id="__span-43-75"><a id="__codelineno-43-75" name="__codelineno-43-75" href="#__codelineno-43-75"></a>
</span><span id="__span-43-76"><a id="__codelineno-43-76" name="__codelineno-43-76" href="#__codelineno-43-76"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-43-77"><a id="__codelineno-43-77" name="__codelineno-43-77" href="#__codelineno-43-77"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total parameters: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="22__full__training__example">2.2 Full Training Example<a class="headerlink" href="#22__full__training__example" title="Permanent link">&para;</a></h3>
<p><strong>Complete Training Pipeline:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">AllChem</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="c1"># 1. DATA PREPARATION</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">MolecularDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom Dataset for molecular data&quot;&quot;&quot;</span>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_bits</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="sd">        Args:</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="sd">            smiles_list: List of SMILES strings</span>
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a><span class="sd">            labels: Array of target values</span>
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a><span class="sd">            radius: Morgan fingerprint radius</span>
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a><span class="sd">            n_bits: Fingerprint length</span>
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-44-29"><a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-44-30"><a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>
</span><span id="__span-44-31"><a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>        <span class="k">for</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span><span id="__span-44-32"><a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>            <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-44-33"><a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>            <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-44-34"><a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>                <span class="c1"># Generate Morgan fingerprint</span>
</span><span id="__span-44-35"><a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a>                <span class="n">fp</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">nBits</span><span class="o">=</span><span class="n">n_bits</span><span class="p">)</span>
</span><span id="__span-44-36"><a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span><span id="__span-44-37"><a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="__span-44-38"><a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a>
</span><span id="__span-44-39"><a id="__codelineno-44-39" name="__codelineno-44-39" href="#__codelineno-44-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">))</span>
</span><span id="__span-44-40"><a id="__codelineno-44-40" name="__codelineno-44-40" href="#__codelineno-44-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-44-41"><a id="__codelineno-44-41" name="__codelineno-44-41" href="#__codelineno-44-41"></a>
</span><span id="__span-44-42"><a id="__codelineno-44-42" name="__codelineno-44-42" href="#__codelineno-44-42"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-44-43"><a id="__codelineno-44-43" name="__codelineno-44-43" href="#__codelineno-44-43"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">)</span>
</span><span id="__span-44-44"><a id="__codelineno-44-44" name="__codelineno-44-44" href="#__codelineno-44-44"></a>
</span><span id="__span-44-45"><a id="__codelineno-44-45" name="__codelineno-44-45" href="#__codelineno-44-45"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="__span-44-46"><a id="__codelineno-44-46" name="__codelineno-44-46" href="#__codelineno-44-46"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="__span-44-47"><a id="__codelineno-44-47" name="__codelineno-44-47" href="#__codelineno-44-47"></a>
</span><span id="__span-44-48"><a id="__codelineno-44-48" name="__codelineno-44-48" href="#__codelineno-44-48"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-49"><a id="__codelineno-44-49" name="__codelineno-44-49" href="#__codelineno-44-49"></a><span class="c1"># 2. TRAINING FUNCTION</span>
</span><span id="__span-44-50"><a id="__codelineno-44-50" name="__codelineno-44-50" href="#__codelineno-44-50"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-51"><a id="__codelineno-44-51" name="__codelineno-44-51" href="#__codelineno-44-51"></a>
</span><span id="__span-44-52"><a id="__codelineno-44-52" name="__codelineno-44-52" href="#__codelineno-44-52"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="__span-44-53"><a id="__codelineno-44-53" name="__codelineno-44-53" href="#__codelineno-44-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Train for one epoch&quot;&quot;&quot;</span>
</span><span id="__span-44-54"><a id="__codelineno-44-54" name="__codelineno-44-54" href="#__codelineno-44-54"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-44-55"><a id="__codelineno-44-55" name="__codelineno-44-55" href="#__codelineno-44-55"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-44-56"><a id="__codelineno-44-56" name="__codelineno-44-56" href="#__codelineno-44-56"></a>
</span><span id="__span-44-57"><a id="__codelineno-44-57" name="__codelineno-44-57" href="#__codelineno-44-57"></a>    <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
</span><span id="__span-44-58"><a id="__codelineno-44-58" name="__codelineno-44-58" href="#__codelineno-44-58"></a>        <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">batch_y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-44-59"><a id="__codelineno-44-59" name="__codelineno-44-59" href="#__codelineno-44-59"></a>
</span><span id="__span-44-60"><a id="__codelineno-44-60" name="__codelineno-44-60" href="#__codelineno-44-60"></a>        <span class="c1"># Forward pass</span>
</span><span id="__span-44-61"><a id="__codelineno-44-61" name="__codelineno-44-61" href="#__codelineno-44-61"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-44-62"><a id="__codelineno-44-62" name="__codelineno-44-62" href="#__codelineno-44-62"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-44-63"><a id="__codelineno-44-63" name="__codelineno-44-63" href="#__codelineno-44-63"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-44-64"><a id="__codelineno-44-64" name="__codelineno-44-64" href="#__codelineno-44-64"></a>
</span><span id="__span-44-65"><a id="__codelineno-44-65" name="__codelineno-44-65" href="#__codelineno-44-65"></a>        <span class="c1"># Backward pass</span>
</span><span id="__span-44-66"><a id="__codelineno-44-66" name="__codelineno-44-66" href="#__codelineno-44-66"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-44-67"><a id="__codelineno-44-67" name="__codelineno-44-67" href="#__codelineno-44-67"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-44-68"><a id="__codelineno-44-68" name="__codelineno-44-68" href="#__codelineno-44-68"></a>
</span><span id="__span-44-69"><a id="__codelineno-44-69" name="__codelineno-44-69" href="#__codelineno-44-69"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-44-70"><a id="__codelineno-44-70" name="__codelineno-44-70" href="#__codelineno-44-70"></a>
</span><span id="__span-44-71"><a id="__codelineno-44-71" name="__codelineno-44-71" href="#__codelineno-44-71"></a>    <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
</span><span id="__span-44-72"><a id="__codelineno-44-72" name="__codelineno-44-72" href="#__codelineno-44-72"></a>
</span><span id="__span-44-73"><a id="__codelineno-44-73" name="__codelineno-44-73" href="#__codelineno-44-73"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-74"><a id="__codelineno-44-74" name="__codelineno-44-74" href="#__codelineno-44-74"></a><span class="c1"># 3. VALIDATION FUNCTION</span>
</span><span id="__span-44-75"><a id="__codelineno-44-75" name="__codelineno-44-75" href="#__codelineno-44-75"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-76"><a id="__codelineno-44-76" name="__codelineno-44-76" href="#__codelineno-44-76"></a>
</span><span id="__span-44-77"><a id="__codelineno-44-77" name="__codelineno-44-77" href="#__codelineno-44-77"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="__span-44-78"><a id="__codelineno-44-78" name="__codelineno-44-78" href="#__codelineno-44-78"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate the model&quot;&quot;&quot;</span>
</span><span id="__span-44-79"><a id="__codelineno-44-79" name="__codelineno-44-79" href="#__codelineno-44-79"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-44-80"><a id="__codelineno-44-80" name="__codelineno-44-80" href="#__codelineno-44-80"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-44-81"><a id="__codelineno-44-81" name="__codelineno-44-81" href="#__codelineno-44-81"></a>    <span class="n">all_predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-44-82"><a id="__codelineno-44-82" name="__codelineno-44-82" href="#__codelineno-44-82"></a>    <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-44-83"><a id="__codelineno-44-83" name="__codelineno-44-83" href="#__codelineno-44-83"></a>
</span><span id="__span-44-84"><a id="__codelineno-44-84" name="__codelineno-44-84" href="#__codelineno-44-84"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-44-85"><a id="__codelineno-44-85" name="__codelineno-44-85" href="#__codelineno-44-85"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
</span><span id="__span-44-86"><a id="__codelineno-44-86" name="__codelineno-44-86" href="#__codelineno-44-86"></a>            <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">batch_y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-44-87"><a id="__codelineno-44-87" name="__codelineno-44-87" href="#__codelineno-44-87"></a>
</span><span id="__span-44-88"><a id="__codelineno-44-88" name="__codelineno-44-88" href="#__codelineno-44-88"></a>            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-44-89"><a id="__codelineno-44-89" name="__codelineno-44-89" href="#__codelineno-44-89"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-44-90"><a id="__codelineno-44-90" name="__codelineno-44-90" href="#__codelineno-44-90"></a>
</span><span id="__span-44-91"><a id="__codelineno-44-91" name="__codelineno-44-91" href="#__codelineno-44-91"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-44-92"><a id="__codelineno-44-92" name="__codelineno-44-92" href="#__codelineno-44-92"></a>            <span class="n">all_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-44-93"><a id="__codelineno-44-93" name="__codelineno-44-93" href="#__codelineno-44-93"></a>            <span class="n">all_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-44-94"><a id="__codelineno-44-94" name="__codelineno-44-94" href="#__codelineno-44-94"></a>
</span><span id="__span-44-95"><a id="__codelineno-44-95" name="__codelineno-44-95" href="#__codelineno-44-95"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
</span><span id="__span-44-96"><a id="__codelineno-44-96" name="__codelineno-44-96" href="#__codelineno-44-96"></a>
</span><span id="__span-44-97"><a id="__codelineno-44-97" name="__codelineno-44-97" href="#__codelineno-44-97"></a>    <span class="c1"># Calculate metrics</span>
</span><span id="__span-44-98"><a id="__codelineno-44-98" name="__codelineno-44-98" href="#__codelineno-44-98"></a>    <span class="n">all_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-44-99"><a id="__codelineno-44-99" name="__codelineno-44-99" href="#__codelineno-44-99"></a>    <span class="n">all_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-44-100"><a id="__codelineno-44-100" name="__codelineno-44-100" href="#__codelineno-44-100"></a>
</span><span id="__span-44-101"><a id="__codelineno-44-101" name="__codelineno-44-101" href="#__codelineno-44-101"></a>    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">))</span>
</span><span id="__span-44-102"><a id="__codelineno-44-102" name="__codelineno-44-102" href="#__codelineno-44-102"></a>    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
</span><span id="__span-44-103"><a id="__codelineno-44-103" name="__codelineno-44-103" href="#__codelineno-44-103"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
</span><span id="__span-44-104"><a id="__codelineno-44-104" name="__codelineno-44-104" href="#__codelineno-44-104"></a>
</span><span id="__span-44-105"><a id="__codelineno-44-105" name="__codelineno-44-105" href="#__codelineno-44-105"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">mae</span><span class="p">,</span> <span class="n">r2</span>
</span><span id="__span-44-106"><a id="__codelineno-44-106" name="__codelineno-44-106" href="#__codelineno-44-106"></a>
</span><span id="__span-44-107"><a id="__codelineno-44-107" name="__codelineno-44-107" href="#__codelineno-44-107"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-108"><a id="__codelineno-44-108" name="__codelineno-44-108" href="#__codelineno-44-108"></a><span class="c1"># 4. COMPLETE TRAINING PIPELINE</span>
</span><span id="__span-44-109"><a id="__codelineno-44-109" name="__codelineno-44-109" href="#__codelineno-44-109"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-110"><a id="__codelineno-44-110" name="__codelineno-44-110" href="#__codelineno-44-110"></a>
</span><span id="__span-44-111"><a id="__codelineno-44-111" name="__codelineno-44-111" href="#__codelineno-44-111"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_molecular_model</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> 
</span><span id="__span-44-112"><a id="__codelineno-44-112" name="__codelineno-44-112" href="#__codelineno-44-112"></a>                          <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-44-113"><a id="__codelineno-44-113" name="__codelineno-44-113" href="#__codelineno-44-113"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-44-114"><a id="__codelineno-44-114" name="__codelineno-44-114" href="#__codelineno-44-114"></a><span class="sd">    Complete training pipeline for molecular property prediction</span>
</span><span id="__span-44-115"><a id="__codelineno-44-115" name="__codelineno-44-115" href="#__codelineno-44-115"></a>
</span><span id="__span-44-116"><a id="__codelineno-44-116" name="__codelineno-44-116" href="#__codelineno-44-116"></a><span class="sd">    Args:</span>
</span><span id="__span-44-117"><a id="__codelineno-44-117" name="__codelineno-44-117" href="#__codelineno-44-117"></a><span class="sd">        smiles_train: Training SMILES</span>
</span><span id="__span-44-118"><a id="__codelineno-44-118" name="__codelineno-44-118" href="#__codelineno-44-118"></a><span class="sd">        y_train: Training labels</span>
</span><span id="__span-44-119"><a id="__codelineno-44-119" name="__codelineno-44-119" href="#__codelineno-44-119"></a><span class="sd">        smiles_val: Validation SMILES</span>
</span><span id="__span-44-120"><a id="__codelineno-44-120" name="__codelineno-44-120" href="#__codelineno-44-120"></a><span class="sd">        y_val: Validation labels</span>
</span><span id="__span-44-121"><a id="__codelineno-44-121" name="__codelineno-44-121" href="#__codelineno-44-121"></a><span class="sd">        config: Configuration dictionary</span>
</span><span id="__span-44-122"><a id="__codelineno-44-122" name="__codelineno-44-122" href="#__codelineno-44-122"></a>
</span><span id="__span-44-123"><a id="__codelineno-44-123" name="__codelineno-44-123" href="#__codelineno-44-123"></a><span class="sd">    Returns:</span>
</span><span id="__span-44-124"><a id="__codelineno-44-124" name="__codelineno-44-124" href="#__codelineno-44-124"></a><span class="sd">        trained_model: Best model</span>
</span><span id="__span-44-125"><a id="__codelineno-44-125" name="__codelineno-44-125" href="#__codelineno-44-125"></a><span class="sd">        history: Training history</span>
</span><span id="__span-44-126"><a id="__codelineno-44-126" name="__codelineno-44-126" href="#__codelineno-44-126"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-44-127"><a id="__codelineno-44-127" name="__codelineno-44-127" href="#__codelineno-44-127"></a>    <span class="c1"># Default configuration</span>
</span><span id="__span-44-128"><a id="__codelineno-44-128" name="__codelineno-44-128" href="#__codelineno-44-128"></a>    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-44-129"><a id="__codelineno-44-129" name="__codelineno-44-129" href="#__codelineno-44-129"></a>        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-44-130"><a id="__codelineno-44-130" name="__codelineno-44-130" href="#__codelineno-44-130"></a>            <span class="s1">&#39;input_dim&#39;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
</span><span id="__span-44-131"><a id="__codelineno-44-131" name="__codelineno-44-131" href="#__codelineno-44-131"></a>            <span class="s1">&#39;hidden_dims&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
</span><span id="__span-44-132"><a id="__codelineno-44-132" name="__codelineno-44-132" href="#__codelineno-44-132"></a>            <span class="s1">&#39;output_dim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-44-133"><a id="__codelineno-44-133" name="__codelineno-44-133" href="#__codelineno-44-133"></a>            <span class="s1">&#39;dropout_rate&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
</span><span id="__span-44-134"><a id="__codelineno-44-134" name="__codelineno-44-134" href="#__codelineno-44-134"></a>            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
</span><span id="__span-44-135"><a id="__codelineno-44-135" name="__codelineno-44-135" href="#__codelineno-44-135"></a>            <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
</span><span id="__span-44-136"><a id="__codelineno-44-136" name="__codelineno-44-136" href="#__codelineno-44-136"></a>            <span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="__span-44-137"><a id="__codelineno-44-137" name="__codelineno-44-137" href="#__codelineno-44-137"></a>            <span class="s1">&#39;patience&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
</span><span id="__span-44-138"><a id="__codelineno-44-138" name="__codelineno-44-138" href="#__codelineno-44-138"></a>            <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>
</span><span id="__span-44-139"><a id="__codelineno-44-139" name="__codelineno-44-139" href="#__codelineno-44-139"></a>        <span class="p">}</span>
</span><span id="__span-44-140"><a id="__codelineno-44-140" name="__codelineno-44-140" href="#__codelineno-44-140"></a>
</span><span id="__span-44-141"><a id="__codelineno-44-141" name="__codelineno-44-141" href="#__codelineno-44-141"></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">])</span>
</span><span id="__span-44-142"><a id="__codelineno-44-142" name="__codelineno-44-142" href="#__codelineno-44-142"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-44-143"><a id="__codelineno-44-143" name="__codelineno-44-143" href="#__codelineno-44-143"></a>
</span><span id="__span-44-144"><a id="__codelineno-44-144" name="__codelineno-44-144" href="#__codelineno-44-144"></a>    <span class="c1"># Create datasets</span>
</span><span id="__span-44-145"><a id="__codelineno-44-145" name="__codelineno-44-145" href="#__codelineno-44-145"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating datasets...&quot;</span><span class="p">)</span>
</span><span id="__span-44-146"><a id="__codelineno-44-146" name="__codelineno-44-146" href="#__codelineno-44-146"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">MolecularDataset</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</span><span id="__span-44-147"><a id="__codelineno-44-147" name="__codelineno-44-147" href="#__codelineno-44-147"></a>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">MolecularDataset</span><span class="p">(</span><span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-44-148"><a id="__codelineno-44-148" name="__codelineno-44-148" href="#__codelineno-44-148"></a>
</span><span id="__span-44-149"><a id="__codelineno-44-149" name="__codelineno-44-149" href="#__codelineno-44-149"></a>    <span class="c1"># Create data loaders</span>
</span><span id="__span-44-150"><a id="__codelineno-44-150" name="__codelineno-44-150" href="#__codelineno-44-150"></a>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> 
</span><span id="__span-44-151"><a id="__codelineno-44-151" name="__codelineno-44-151" href="#__codelineno-44-151"></a>                             <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-44-152"><a id="__codelineno-44-152" name="__codelineno-44-152" href="#__codelineno-44-152"></a>    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> 
</span><span id="__span-44-153"><a id="__codelineno-44-153" name="__codelineno-44-153" href="#__codelineno-44-153"></a>                           <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-44-154"><a id="__codelineno-44-154" name="__codelineno-44-154" href="#__codelineno-44-154"></a>
</span><span id="__span-44-155"><a id="__codelineno-44-155" name="__codelineno-44-155" href="#__codelineno-44-155"></a>    <span class="c1"># Initialize model</span>
</span><span id="__span-44-156"><a id="__codelineno-44-156" name="__codelineno-44-156" href="#__codelineno-44-156"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">MolecularFNN</span><span class="p">(</span>
</span><span id="__span-44-157"><a id="__codelineno-44-157" name="__codelineno-44-157" href="#__codelineno-44-157"></a>        <span class="n">input_dim</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_dim&#39;</span><span class="p">],</span>
</span><span id="__span-44-158"><a id="__codelineno-44-158" name="__codelineno-44-158" href="#__codelineno-44-158"></a>        <span class="n">hidden_dims</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hidden_dims&#39;</span><span class="p">],</span>
</span><span id="__span-44-159"><a id="__codelineno-44-159" name="__codelineno-44-159" href="#__codelineno-44-159"></a>        <span class="n">output_dim</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_dim&#39;</span><span class="p">],</span>
</span><span id="__span-44-160"><a id="__codelineno-44-160" name="__codelineno-44-160" href="#__codelineno-44-160"></a>        <span class="n">dropout_rate</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dropout_rate&#39;</span><span class="p">]</span>
</span><span id="__span-44-161"><a id="__codelineno-44-161" name="__codelineno-44-161" href="#__codelineno-44-161"></a>    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-44-162"><a id="__codelineno-44-162" name="__codelineno-44-162" href="#__codelineno-44-162"></a>
</span><span id="__span-44-163"><a id="__codelineno-44-163" name="__codelineno-44-163" href="#__codelineno-44-163"></a>    <span class="c1"># Loss and optimizer</span>
</span><span id="__span-44-164"><a id="__codelineno-44-164" name="__codelineno-44-164" href="#__codelineno-44-164"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-44-165"><a id="__codelineno-44-165" name="__codelineno-44-165" href="#__codelineno-44-165"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">])</span>
</span><span id="__span-44-166"><a id="__codelineno-44-166" name="__codelineno-44-166" href="#__codelineno-44-166"></a>
</span><span id="__span-44-167"><a id="__codelineno-44-167" name="__codelineno-44-167" href="#__codelineno-44-167"></a>    <span class="c1"># Learning rate scheduler</span>
</span><span id="__span-44-168"><a id="__codelineno-44-168" name="__codelineno-44-168" href="#__codelineno-44-168"></a>    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="__span-44-169"><a id="__codelineno-44-169" name="__codelineno-44-169" href="#__codelineno-44-169"></a>        <span class="n">optimizer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-44-170"><a id="__codelineno-44-170" name="__codelineno-44-170" href="#__codelineno-44-170"></a>    <span class="p">)</span>
</span><span id="__span-44-171"><a id="__codelineno-44-171" name="__codelineno-44-171" href="#__codelineno-44-171"></a>
</span><span id="__span-44-172"><a id="__codelineno-44-172" name="__codelineno-44-172" href="#__codelineno-44-172"></a>    <span class="c1"># Training history</span>
</span><span id="__span-44-173"><a id="__codelineno-44-173" name="__codelineno-44-173" href="#__codelineno-44-173"></a>    <span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-44-174"><a id="__codelineno-44-174" name="__codelineno-44-174" href="#__codelineno-44-174"></a>        <span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> 
</span><span id="__span-44-175"><a id="__codelineno-44-175" name="__codelineno-44-175" href="#__codelineno-44-175"></a>        <span class="s1">&#39;val_rmse&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_mae&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_r2&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="__span-44-176"><a id="__codelineno-44-176" name="__codelineno-44-176" href="#__codelineno-44-176"></a>    <span class="p">}</span>
</span><span id="__span-44-177"><a id="__codelineno-44-177" name="__codelineno-44-177" href="#__codelineno-44-177"></a>
</span><span id="__span-44-178"><a id="__codelineno-44-178" name="__codelineno-44-178" href="#__codelineno-44-178"></a>    <span class="c1"># Early stopping</span>
</span><span id="__span-44-179"><a id="__codelineno-44-179" name="__codelineno-44-179" href="#__codelineno-44-179"></a>    <span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="__span-44-180"><a id="__codelineno-44-180" name="__codelineno-44-180" href="#__codelineno-44-180"></a>    <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-44-181"><a id="__codelineno-44-181" name="__codelineno-44-181" href="#__codelineno-44-181"></a>    <span class="n">best_model_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-44-182"><a id="__codelineno-44-182" name="__codelineno-44-182" href="#__codelineno-44-182"></a>
</span><span id="__span-44-183"><a id="__codelineno-44-183" name="__codelineno-44-183" href="#__codelineno-44-183"></a>    <span class="c1"># Training loop</span>
</span><span id="__span-44-184"><a id="__codelineno-44-184" name="__codelineno-44-184" href="#__codelineno-44-184"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting training...&quot;</span><span class="p">)</span>
</span><span id="__span-44-185"><a id="__codelineno-44-185" name="__codelineno-44-185" href="#__codelineno-44-185"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]):</span>
</span><span id="__span-44-186"><a id="__codelineno-44-186" name="__codelineno-44-186" href="#__codelineno-44-186"></a>        <span class="c1"># Train</span>
</span><span id="__span-44-187"><a id="__codelineno-44-187" name="__codelineno-44-187" href="#__codelineno-44-187"></a>        <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-44-188"><a id="__codelineno-44-188" name="__codelineno-44-188" href="#__codelineno-44-188"></a>
</span><span id="__span-44-189"><a id="__codelineno-44-189" name="__codelineno-44-189" href="#__codelineno-44-189"></a>        <span class="c1"># Validate</span>
</span><span id="__span-44-190"><a id="__codelineno-44-190" name="__codelineno-44-190" href="#__codelineno-44-190"></a>        <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_rmse</span><span class="p">,</span> <span class="n">val_mae</span><span class="p">,</span> <span class="n">val_r2</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="__span-44-191"><a id="__codelineno-44-191" name="__codelineno-44-191" href="#__codelineno-44-191"></a>
</span><span id="__span-44-192"><a id="__codelineno-44-192" name="__codelineno-44-192" href="#__codelineno-44-192"></a>        <span class="c1"># Learning rate scheduling</span>
</span><span id="__span-44-193"><a id="__codelineno-44-193" name="__codelineno-44-193" href="#__codelineno-44-193"></a>        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-44-194"><a id="__codelineno-44-194" name="__codelineno-44-194" href="#__codelineno-44-194"></a>
</span><span id="__span-44-195"><a id="__codelineno-44-195" name="__codelineno-44-195" href="#__codelineno-44-195"></a>        <span class="c1"># Save history</span>
</span><span id="__span-44-196"><a id="__codelineno-44-196" name="__codelineno-44-196" href="#__codelineno-44-196"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
</span><span id="__span-44-197"><a id="__codelineno-44-197" name="__codelineno-44-197" href="#__codelineno-44-197"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-44-198"><a id="__codelineno-44-198" name="__codelineno-44-198" href="#__codelineno-44-198"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_rmse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_rmse</span><span class="p">)</span>
</span><span id="__span-44-199"><a id="__codelineno-44-199" name="__codelineno-44-199" href="#__codelineno-44-199"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_mae</span><span class="p">)</span>
</span><span id="__span-44-200"><a id="__codelineno-44-200" name="__codelineno-44-200" href="#__codelineno-44-200"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_r2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_r2</span><span class="p">)</span>
</span><span id="__span-44-201"><a id="__codelineno-44-201" name="__codelineno-44-201" href="#__codelineno-44-201"></a>
</span><span id="__span-44-202"><a id="__codelineno-44-202" name="__codelineno-44-202" href="#__codelineno-44-202"></a>        <span class="c1"># Print progress</span>
</span><span id="__span-44-203"><a id="__codelineno-44-203" name="__codelineno-44-203" href="#__codelineno-44-203"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-44-204"><a id="__codelineno-44-204" name="__codelineno-44-204" href="#__codelineno-44-204"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-44-205"><a id="__codelineno-44-205" name="__codelineno-44-205" href="#__codelineno-44-205"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-44-206"><a id="__codelineno-44-206" name="__codelineno-44-206" href="#__codelineno-44-206"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val Loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, RMSE: </span><span class="si">{</span><span class="n">val_rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="__span-44-207"><a id="__codelineno-44-207" name="__codelineno-44-207" href="#__codelineno-44-207"></a>                  <span class="sa">f</span><span class="s2">&quot;MAE: </span><span class="si">{</span><span class="n">val_mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, R²: </span><span class="si">{</span><span class="n">val_r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-44-208"><a id="__codelineno-44-208" name="__codelineno-44-208" href="#__codelineno-44-208"></a>
</span><span id="__span-44-209"><a id="__codelineno-44-209" name="__codelineno-44-209" href="#__codelineno-44-209"></a>        <span class="c1"># Early stopping</span>
</span><span id="__span-44-210"><a id="__codelineno-44-210" name="__codelineno-44-210" href="#__codelineno-44-210"></a>        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
</span><span id="__span-44-211"><a id="__codelineno-44-211" name="__codelineno-44-211" href="#__codelineno-44-211"></a>            <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
</span><span id="__span-44-212"><a id="__codelineno-44-212" name="__codelineno-44-212" href="#__codelineno-44-212"></a>            <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-44-213"><a id="__codelineno-44-213" name="__codelineno-44-213" href="#__codelineno-44-213"></a>            <span class="n">best_model_state</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-44-214"><a id="__codelineno-44-214" name="__codelineno-44-214" href="#__codelineno-44-214"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-44-215"><a id="__codelineno-44-215" name="__codelineno-44-215" href="#__codelineno-44-215"></a>            <span class="n">patience_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-44-216"><a id="__codelineno-44-216" name="__codelineno-44-216" href="#__codelineno-44-216"></a>            <span class="k">if</span> <span class="n">patience_counter</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]:</span>
</span><span id="__span-44-217"><a id="__codelineno-44-217" name="__codelineno-44-217" href="#__codelineno-44-217"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Early stopping at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-44-218"><a id="__codelineno-44-218" name="__codelineno-44-218" href="#__codelineno-44-218"></a>                <span class="k">break</span>
</span><span id="__span-44-219"><a id="__codelineno-44-219" name="__codelineno-44-219" href="#__codelineno-44-219"></a>
</span><span id="__span-44-220"><a id="__codelineno-44-220" name="__codelineno-44-220" href="#__codelineno-44-220"></a>    <span class="c1"># Load best model</span>
</span><span id="__span-44-221"><a id="__codelineno-44-221" name="__codelineno-44-221" href="#__codelineno-44-221"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_model_state</span><span class="p">)</span>
</span><span id="__span-44-222"><a id="__codelineno-44-222" name="__codelineno-44-222" href="#__codelineno-44-222"></a>
</span><span id="__span-44-223"><a id="__codelineno-44-223" name="__codelineno-44-223" href="#__codelineno-44-223"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training complete!&quot;</span><span class="p">)</span>
</span><span id="__span-44-224"><a id="__codelineno-44-224" name="__codelineno-44-224" href="#__codelineno-44-224"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best validation loss: </span><span class="si">{</span><span class="n">best_val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-44-225"><a id="__codelineno-44-225" name="__codelineno-44-225" href="#__codelineno-44-225"></a>
</span><span id="__span-44-226"><a id="__codelineno-44-226" name="__codelineno-44-226" href="#__codelineno-44-226"></a>    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">history</span>
</span><span id="__span-44-227"><a id="__codelineno-44-227" name="__codelineno-44-227" href="#__codelineno-44-227"></a>
</span><span id="__span-44-228"><a id="__codelineno-44-228" name="__codelineno-44-228" href="#__codelineno-44-228"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-229"><a id="__codelineno-44-229" name="__codelineno-44-229" href="#__codelineno-44-229"></a><span class="c1"># 5. EXAMPLE USAGE</span>
</span><span id="__span-44-230"><a id="__codelineno-44-230" name="__codelineno-44-230" href="#__codelineno-44-230"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-44-231"><a id="__codelineno-44-231" name="__codelineno-44-231" href="#__codelineno-44-231"></a>
</span><span id="__span-44-232"><a id="__codelineno-44-232" name="__codelineno-44-232" href="#__codelineno-44-232"></a><span class="c1"># Generate synthetic data for demonstration</span>
</span><span id="__span-44-233"><a id="__codelineno-44-233" name="__codelineno-44-233" href="#__codelineno-44-233"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
</span><span id="__span-44-234"><a id="__codelineno-44-234" name="__codelineno-44-234" href="#__codelineno-44-234"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate synthetic molecular data&quot;&quot;&quot;</span>
</span><span id="__span-44-235"><a id="__codelineno-44-235" name="__codelineno-44-235" href="#__codelineno-44-235"></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-44-236"><a id="__codelineno-44-236" name="__codelineno-44-236" href="#__codelineno-44-236"></a>
</span><span id="__span-44-237"><a id="__codelineno-44-237" name="__codelineno-44-237" href="#__codelineno-44-237"></a>    <span class="c1"># Simple SMILES for demonstration (in practice, use real dataset)</span>
</span><span id="__span-44-238"><a id="__codelineno-44-238" name="__codelineno-44-238" href="#__codelineno-44-238"></a>    <span class="n">base_smiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CCO&#39;</span><span class="p">,</span> <span class="s1">&#39;CC(C)O&#39;</span><span class="p">,</span> <span class="s1">&#39;CCCO&#39;</span><span class="p">,</span> <span class="s1">&#39;CC(C)CO&#39;</span><span class="p">,</span> <span class="s1">&#39;CCCCO&#39;</span><span class="p">]</span>
</span><span id="__span-44-239"><a id="__codelineno-44-239" name="__codelineno-44-239" href="#__codelineno-44-239"></a>    <span class="n">smiles_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">base_smiles</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="__span-44-240"><a id="__codelineno-44-240" name="__codelineno-44-240" href="#__codelineno-44-240"></a>
</span><span id="__span-44-241"><a id="__codelineno-44-241" name="__codelineno-44-241" href="#__codelineno-44-241"></a>    <span class="c1"># Synthetic labels (in practice, use real property values)</span>
</span><span id="__span-44-242"><a id="__codelineno-44-242" name="__codelineno-44-242" href="#__codelineno-44-242"></a>    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="__span-44-243"><a id="__codelineno-44-243" name="__codelineno-44-243" href="#__codelineno-44-243"></a>
</span><span id="__span-44-244"><a id="__codelineno-44-244" name="__codelineno-44-244" href="#__codelineno-44-244"></a>    <span class="k">return</span> <span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span>
</span><span id="__span-44-245"><a id="__codelineno-44-245" name="__codelineno-44-245" href="#__codelineno-44-245"></a>
</span><span id="__span-44-246"><a id="__codelineno-44-246" name="__codelineno-44-246" href="#__codelineno-44-246"></a><span class="c1"># Generate data</span>
</span><span id="__span-44-247"><a id="__codelineno-44-247" name="__codelineno-44-247" href="#__codelineno-44-247"></a><span class="n">smiles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">generate_synthetic_data</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="__span-44-248"><a id="__codelineno-44-248" name="__codelineno-44-248" href="#__codelineno-44-248"></a>
</span><span id="__span-44-249"><a id="__codelineno-44-249" name="__codelineno-44-249" href="#__codelineno-44-249"></a><span class="c1"># Split data</span>
</span><span id="__span-44-250"><a id="__codelineno-44-250" name="__codelineno-44-250" href="#__codelineno-44-250"></a><span class="n">smiles_train</span><span class="p">,</span> <span class="n">smiles_temp</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_temp</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
</span><span id="__span-44-251"><a id="__codelineno-44-251" name="__codelineno-44-251" href="#__codelineno-44-251"></a>    <span class="n">smiles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
</span><span id="__span-44-252"><a id="__codelineno-44-252" name="__codelineno-44-252" href="#__codelineno-44-252"></a><span class="p">)</span>
</span><span id="__span-44-253"><a id="__codelineno-44-253" name="__codelineno-44-253" href="#__codelineno-44-253"></a><span class="n">smiles_val</span><span class="p">,</span> <span class="n">smiles_test</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
</span><span id="__span-44-254"><a id="__codelineno-44-254" name="__codelineno-44-254" href="#__codelineno-44-254"></a>    <span class="n">smiles_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
</span><span id="__span-44-255"><a id="__codelineno-44-255" name="__codelineno-44-255" href="#__codelineno-44-255"></a><span class="p">)</span>
</span><span id="__span-44-256"><a id="__codelineno-44-256" name="__codelineno-44-256" href="#__codelineno-44-256"></a>
</span><span id="__span-44-257"><a id="__codelineno-44-257" name="__codelineno-44-257" href="#__codelineno-44-257"></a><span class="c1"># Train model</span>
</span><span id="__span-44-258"><a id="__codelineno-44-258" name="__codelineno-44-258" href="#__codelineno-44-258"></a><span class="n">model</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="n">train_molecular_model</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-44-259"><a id="__codelineno-44-259" name="__codelineno-44-259" href="#__codelineno-44-259"></a>
</span><span id="__span-44-260"><a id="__codelineno-44-260" name="__codelineno-44-260" href="#__codelineno-44-260"></a><span class="c1"># Visualize training history</span>
</span><span id="__span-44-261"><a id="__codelineno-44-261" name="__codelineno-44-261" href="#__codelineno-44-261"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-44-262"><a id="__codelineno-44-262" name="__codelineno-44-262" href="#__codelineno-44-262"></a>
</span><span id="__span-44-263"><a id="__codelineno-44-263" name="__codelineno-44-263" href="#__codelineno-44-263"></a><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="__span-44-264"><a id="__codelineno-44-264" name="__codelineno-44-264" href="#__codelineno-44-264"></a>
</span><span id="__span-44-265"><a id="__codelineno-44-265" name="__codelineno-44-265" href="#__codelineno-44-265"></a><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-44-266"><a id="__codelineno-44-266" name="__codelineno-44-266" href="#__codelineno-44-266"></a><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">)</span>
</span><span id="__span-44-267"><a id="__codelineno-44-267" name="__codelineno-44-267" href="#__codelineno-44-267"></a><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Loss&#39;</span><span class="p">)</span>
</span><span id="__span-44-268"><a id="__codelineno-44-268" name="__codelineno-44-268" href="#__codelineno-44-268"></a><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-44-269"><a id="__codelineno-44-269" name="__codelineno-44-269" href="#__codelineno-44-269"></a><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
</span><span id="__span-44-270"><a id="__codelineno-44-270" name="__codelineno-44-270" href="#__codelineno-44-270"></a><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-44-271"><a id="__codelineno-44-271" name="__codelineno-44-271" href="#__codelineno-44-271"></a><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Training and Validation Loss&#39;</span><span class="p">)</span>
</span><span id="__span-44-272"><a id="__codelineno-44-272" name="__codelineno-44-272" href="#__codelineno-44-272"></a>
</span><span id="__span-44-273"><a id="__codelineno-44-273" name="__codelineno-44-273" href="#__codelineno-44-273"></a><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-44-274"><a id="__codelineno-44-274" name="__codelineno-44-274" href="#__codelineno-44-274"></a><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_rmse&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RMSE&#39;</span><span class="p">)</span>
</span><span id="__span-44-275"><a id="__codelineno-44-275" name="__codelineno-44-275" href="#__codelineno-44-275"></a><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
</span><span id="__span-44-276"><a id="__codelineno-44-276" name="__codelineno-44-276" href="#__codelineno-44-276"></a><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-44-277"><a id="__codelineno-44-277" name="__codelineno-44-277" href="#__codelineno-44-277"></a><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
</span><span id="__span-44-278"><a id="__codelineno-44-278" name="__codelineno-44-278" href="#__codelineno-44-278"></a><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-44-279"><a id="__codelineno-44-279" name="__codelineno-44-279" href="#__codelineno-44-279"></a><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Validation Errors&#39;</span><span class="p">)</span>
</span><span id="__span-44-280"><a id="__codelineno-44-280" name="__codelineno-44-280" href="#__codelineno-44-280"></a>
</span><span id="__span-44-281"><a id="__codelineno-44-281" name="__codelineno-44-281" href="#__codelineno-44-281"></a><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-44-282"><a id="__codelineno-44-282" name="__codelineno-44-282" href="#__codelineno-44-282"></a><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_r2&#39;</span><span class="p">])</span>
</span><span id="__span-44-283"><a id="__codelineno-44-283" name="__codelineno-44-283" href="#__codelineno-44-283"></a><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-44-284"><a id="__codelineno-44-284" name="__codelineno-44-284" href="#__codelineno-44-284"></a><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;R² Score&#39;</span><span class="p">)</span>
</span><span id="__span-44-285"><a id="__codelineno-44-285" name="__codelineno-44-285" href="#__codelineno-44-285"></a><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Validation R²&#39;</span><span class="p">)</span>
</span><span id="__span-44-286"><a id="__codelineno-44-286" name="__codelineno-44-286" href="#__codelineno-44-286"></a>
</span><span id="__span-44-287"><a id="__codelineno-44-287" name="__codelineno-44-287" href="#__codelineno-44-287"></a><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-44-288"><a id="__codelineno-44-288" name="__codelineno-44-288" href="#__codelineno-44-288"></a><span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;training_history.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="__span-44-289"><a id="__codelineno-44-289" name="__codelineno-44-289" href="#__codelineno-44-289"></a><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="23__best__practices__and__tips">2.3 Best Practices and Tips<a class="headerlink" href="#23__best__practices__and__tips" title="Permanent link">&para;</a></h3>
<p><strong>1. Data Preprocessing</strong></p>
<ul>
<li>
<p><strong>Normalize inputs</strong>: Scale features to similar ranges
  <div class="language-python highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="n">X_val_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Handle missing values</strong>: Remove or impute before training</p>
</li>
<li><strong>Remove duplicates</strong>: Ensure no data leakage between train/val/test sets</li>
</ul>
<p><strong>2. Architecture Selection</strong></p>
<ul>
<li><strong>Start simple</strong>: Begin with 2-3 hidden layers</li>
<li><strong>Increase gradually</strong>: Add complexity only if needed</li>
<li><strong>Monitor overfitting</strong>: If train loss &lt;&lt; val loss, model too complex</li>
</ul>
<p><strong>3. Hyperparameter Tuning Priority</strong></p>
<table>
<thead>
<tr>
<th>Priority</th>
<th>Hyperparameter</th>
<th>Impact</th>
<th>Typical Range</th>
</tr>
</thead>
<tbody>
<tr>
<td>HIGH</td>
<td>Learning rate</td>
<td>Critical for convergence</td>
<td>1e-4 to 1e-2</td>
</tr>
<tr>
<td>HIGH</td>
<td>Batch size</td>
<td>Memory and convergence speed</td>
<td>32, 64, 128, 256</td>
</tr>
<tr>
<td>MEDIUM</td>
<td>Number of layers</td>
<td>Model capacity</td>
<td>2-5</td>
</tr>
<tr>
<td>MEDIUM</td>
<td>Neurons per layer</td>
<td>Model capacity</td>
<td>64, 128, 256, 512</td>
</tr>
<tr>
<td>MEDIUM</td>
<td>Dropout rate</td>
<td>Regularization</td>
<td>0.1-0.5</td>
</tr>
<tr>
<td>LOW</td>
<td>Optimizer</td>
<td>Usually Adam works</td>
<td>Adam, AdamW</td>
</tr>
<tr>
<td>LOW</td>
<td>Activation function</td>
<td>ReLU usually best</td>
<td>ReLU, Leaky ReLU</td>
</tr>
</tbody>
</table>
<p><strong>4. Regularization Techniques</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1"># L2 Regularization (Weight Decay)</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="c1"># Dropout (already in model architecture)</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="c1"># Batch Normalization (already in model architecture)</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="c1"># Early Stopping (implemented in training loop)</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>    <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>    <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>    <span class="n">patience_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span></code></pre></div>
<p><strong>5. Debugging Checklist</strong></p>
<ul>
<li><strong>Problem</strong>: Loss is NaN</li>
<li>
<p><strong>Solution</strong>: Reduce learning rate, check for invalid inputs, add gradient clipping
  <div class="language-python highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>Problem</strong>: Loss not decreasing</p>
</li>
<li>
<p><strong>Solution</strong>: Increase learning rate, check data preprocessing, verify labels</p>
</li>
<li>
<p><strong>Problem</strong>: Training loss decreasing but validation loss increasing</p>
</li>
<li>
<p><strong>Solution</strong>: Overfitting - increase dropout, add L2 regularization, reduce model size</p>
</li>
<li>
<p><strong>Problem</strong>: Both losses high and not improving</p>
</li>
<li><strong>Solution</strong>: Underfitting - increase model capacity, decrease regularization, train longer</li>
</ul>
<p><strong>6. Monitoring Training</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1"># Use TensorBoard for real-time monitoring</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.tensorboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryWriter</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="s1">&#39;runs/experiment_1&#39;</span><span class="p">)</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="c1"># During training loop</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;Loss/train&#39;</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;Loss/val&#39;</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;Metrics/RMSE&#39;</span><span class="p">,</span> <span class="n">val_rmse</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;Metrics/R2&#39;</span><span class="p">,</span> <span class="n">val_r2</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="c1"># View with: tensorboard --logdir=runs</span>
</span></code></pre></div>
<p><strong>7. Model Saving and Loading</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># Save complete model state</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>    <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">best_val_loss</span><span class="p">,</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>    <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="n">history</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="p">},</span> <span class="s1">&#39;best_model.pth&#39;</span><span class="p">)</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="c1"># Load model</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;best_model.pth&#39;</span><span class="p">)</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">])</span>
</span></code></pre></div>
<p><strong>8. Tips for Molecular Data</strong></p>
<ul>
<li><strong>Use appropriate fingerprints</strong>: Morgan (most common), MACCS, RDKit fingerprints</li>
<li><strong>Consider molecular size</strong>: Normalize by molecular weight or atom count if relevant</li>
<li><strong>Handle invalid SMILES</strong>: Filter out molecules that RDKit cannot parse</li>
<li><strong>Augmentation</strong>: Consider SMILES enumeration for data augmentation</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># SMILES enumeration for augmentation</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">enumerate_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">n_variants</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate different SMILES representations of same molecule&quot;&quot;&quot;</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">smiles</span><span class="p">]</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>    <span class="n">variants</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_variants</span><span class="p">):</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>        <span class="n">variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">doRandom</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a>    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">variants</span><span class="p">))</span>
</span></code></pre></div>
<hr />
<h2 id="3__multi-task__learning">3. Multi-Task Learning<a class="headerlink" href="#3__multi-task__learning" title="Permanent link">&para;</a></h2>
<h3 id="31__why__and__when__to__use__multi-task__learning">3.1 Why and When to Use Multi-Task Learning<a class="headerlink" href="#31__why__and__when__to__use__multi-task__learning" title="Permanent link">&para;</a></h3>
<p>Multi-task learning (MTL) is a machine learning paradigm where a model simultaneously learns multiple related tasks, sharing representations between tasks.</p>
<p><strong>Key Benefits:</strong></p>
<ol>
<li><strong>Improved Generalization</strong>: Shared representations act as implicit regularization</li>
<li><strong>Data Efficiency</strong>: Tasks with more data help tasks with less data</li>
<li><strong>Related Features</strong>: Capture common patterns across molecular properties</li>
<li><strong>Transfer Learning</strong>: Learn general molecular representations</li>
<li><strong>Computational Efficiency</strong>: One model predicts multiple properties</li>
</ol>
<p><strong>When to Use MTL:</strong></p>
<p><strong>Ideal Scenarios:</strong>
- <strong>Related Properties</strong>: Predicting solubility, LogP, and permeability (all related to molecular polarity)
- <strong>Limited Data</strong>: Some tasks have abundant data, others have scarce data
- <strong>Shared Features</strong>: Tasks depend on similar molecular features
- <strong>Multiple Endpoints</strong>: Drug discovery (ADMET properties all relevant)</p>
<p><strong>Not Recommended:</strong>
- <strong>Unrelated Tasks</strong>: Predicting solubility and catalytic activity (different mechanisms)
- <strong>Conflicting Objectives</strong>: Tasks requiring opposite feature representations
- <strong>Single Task is Sufficient</strong>: When only one property matters</p>
<p><strong>Examples in Drug Discovery:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>Task Group 1: ADMET Properties
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>├─ Absorption (Caco-2 permeability)
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>├─ Distribution (BBB permeability, plasma protein binding)
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>├─ Metabolism (CYP450 inhibition, metabolic stability)
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>├─ Excretion (clearance, half-life)
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>└─ Toxicity (hERG inhibition, hepatotoxicity)
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>Task Group 2: Physical Properties
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>├─ Solubility (aqueous, LogS)
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>├─ Lipophilicity (LogP, LogD)
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>└─ Permeability (PAMPA, Caco-2)
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>Task Group 3: Biological Activity
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>├─ Target binding (IC50, Ki)
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>├─ Cell viability (CC50)
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>└─ Selectivity across targets
</span></code></pre></div>
<h3 id="32__multi-task__architecture">3.2 Multi-Task Architecture<a class="headerlink" href="#32__multi-task__architecture" title="Permanent link">&para;</a></h3>
<p><strong>Hard Parameter Sharing</strong> (Most Common)</p>
<p>All tasks share hidden layers, separate output heads:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>              Input (Molecular Features)
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>                       |
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>            Shared Hidden Layers
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>                   /   |   \
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>           Task 1  Task 2  Task 3
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>          Output  Output  Output
</span></code></pre></div>
<p><strong>Complete Implementation:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">MultiTaskMolecularModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="sd">    Multi-task neural network for molecular property prediction</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">shared_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span> 
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>                 <span class="n">task_configs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="sd">        Args:</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="sd">            input_dim: Size of input features</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="sd">            shared_dims: List of shared hidden layer sizes</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="sd">            task_configs: List of dicts with task specifications</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="sd">                         [{&#39;name&#39;: &#39;task1&#39;, &#39;output_dim&#39;: 1, &#39;task_type&#39;: &#39;regression&#39;}, ...]</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="sd">            dropout_rate: Dropout probability</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MultiTaskMolecularModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>        <span class="k">if</span> <span class="n">task_configs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>            <span class="n">task_configs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;solubility&#39;</span><span class="p">,</span> <span class="s1">&#39;output_dim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">},</span>
</span><span id="__span-53-23"><a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a>                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;toxicity&#39;</span><span class="p">,</span> <span class="s1">&#39;output_dim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s1">&#39;classification&#39;</span><span class="p">}</span>
</span><span id="__span-53-24"><a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>            <span class="p">]</span>
</span><span id="__span-53-25"><a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a>
</span><span id="__span-53-26"><a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_configs</span> <span class="o">=</span> <span class="n">task_configs</span>
</span><span id="__span-53-27"><a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">]</span>
</span><span id="__span-53-28"><a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a>
</span><span id="__span-53-29"><a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a>        <span class="c1"># Shared layers</span>
</span><span id="__span-53-30"><a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a>        <span class="n">shared_layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-53-31"><a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a>        <span class="n">prev_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
</span><span id="__span-53-32"><a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a>
</span><span id="__span-53-33"><a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a>        <span class="k">for</span> <span class="n">hidden_dim</span> <span class="ow">in</span> <span class="n">shared_dims</span><span class="p">:</span>
</span><span id="__span-53-34"><a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a>            <span class="n">shared_layers</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="__span-53-35"><a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">prev_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
</span><span id="__span-53-36"><a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">),</span>
</span><span id="__span-53-37"><a id="__codelineno-53-37" name="__codelineno-53-37" href="#__codelineno-53-37"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-53-38"><a id="__codelineno-53-38" name="__codelineno-53-38" href="#__codelineno-53-38"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)</span>
</span><span id="__span-53-39"><a id="__codelineno-53-39" name="__codelineno-53-39" href="#__codelineno-53-39"></a>            <span class="p">])</span>
</span><span id="__span-53-40"><a id="__codelineno-53-40" name="__codelineno-53-40" href="#__codelineno-53-40"></a>            <span class="n">prev_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
</span><span id="__span-53-41"><a id="__codelineno-53-41" name="__codelineno-53-41" href="#__codelineno-53-41"></a>
</span><span id="__span-53-42"><a id="__codelineno-53-42" name="__codelineno-53-42" href="#__codelineno-53-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_network</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">shared_layers</span><span class="p">)</span>
</span><span id="__span-53-43"><a id="__codelineno-53-43" name="__codelineno-53-43" href="#__codelineno-53-43"></a>
</span><span id="__span-53-44"><a id="__codelineno-53-44" name="__codelineno-53-44" href="#__codelineno-53-44"></a>        <span class="c1"># Task-specific heads</span>
</span><span id="__span-53-45"><a id="__codelineno-53-45" name="__codelineno-53-45" href="#__codelineno-53-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_heads</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="__span-53-46"><a id="__codelineno-53-46" name="__codelineno-53-46" href="#__codelineno-53-46"></a>
</span><span id="__span-53-47"><a id="__codelineno-53-47" name="__codelineno-53-47" href="#__codelineno-53-47"></a>        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">:</span>
</span><span id="__span-53-48"><a id="__codelineno-53-48" name="__codelineno-53-48" href="#__codelineno-53-48"></a>            <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="__span-53-49"><a id="__codelineno-53-49" name="__codelineno-53-49" href="#__codelineno-53-49"></a>            <span class="n">output_dim</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;output_dim&#39;</span><span class="p">]</span>
</span><span id="__span-53-50"><a id="__codelineno-53-50" name="__codelineno-53-50" href="#__codelineno-53-50"></a>
</span><span id="__span-53-51"><a id="__codelineno-53-51" name="__codelineno-53-51" href="#__codelineno-53-51"></a>            <span class="c1"># Task-specific layers (2 layers)</span>
</span><span id="__span-53-52"><a id="__codelineno-53-52" name="__codelineno-53-52" href="#__codelineno-53-52"></a>            <span class="n">task_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-53-53"><a id="__codelineno-53-53" name="__codelineno-53-53" href="#__codelineno-53-53"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">prev_dim</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
</span><span id="__span-53-54"><a id="__codelineno-53-54" name="__codelineno-53-54" href="#__codelineno-53-54"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-53-55"><a id="__codelineno-53-55" name="__codelineno-53-55" href="#__codelineno-53-55"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">),</span>
</span><span id="__span-53-56"><a id="__codelineno-53-56" name="__codelineno-53-56" href="#__codelineno-53-56"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</span><span id="__span-53-57"><a id="__codelineno-53-57" name="__codelineno-53-57" href="#__codelineno-53-57"></a>            <span class="p">)</span>
</span><span id="__span-53-58"><a id="__codelineno-53-58" name="__codelineno-53-58" href="#__codelineno-53-58"></a>
</span><span id="__span-53-59"><a id="__codelineno-53-59" name="__codelineno-53-59" href="#__codelineno-53-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">task_heads</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_head</span>
</span><span id="__span-53-60"><a id="__codelineno-53-60" name="__codelineno-53-60" href="#__codelineno-53-60"></a>
</span><span id="__span-53-61"><a id="__codelineno-53-61" name="__codelineno-53-61" href="#__codelineno-53-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-53-62"><a id="__codelineno-53-62" name="__codelineno-53-62" href="#__codelineno-53-62"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-53-63"><a id="__codelineno-53-63" name="__codelineno-53-63" href="#__codelineno-53-63"></a><span class="sd">        Forward pass through shared network and all task heads</span>
</span><span id="__span-53-64"><a id="__codelineno-53-64" name="__codelineno-53-64" href="#__codelineno-53-64"></a>
</span><span id="__span-53-65"><a id="__codelineno-53-65" name="__codelineno-53-65" href="#__codelineno-53-65"></a><span class="sd">        Args:</span>
</span><span id="__span-53-66"><a id="__codelineno-53-66" name="__codelineno-53-66" href="#__codelineno-53-66"></a><span class="sd">            x: Input tensor (batch_size, input_dim)</span>
</span><span id="__span-53-67"><a id="__codelineno-53-67" name="__codelineno-53-67" href="#__codelineno-53-67"></a>
</span><span id="__span-53-68"><a id="__codelineno-53-68" name="__codelineno-53-68" href="#__codelineno-53-68"></a><span class="sd">        Returns:</span>
</span><span id="__span-53-69"><a id="__codelineno-53-69" name="__codelineno-53-69" href="#__codelineno-53-69"></a><span class="sd">            Dictionary of predictions for each task</span>
</span><span id="__span-53-70"><a id="__codelineno-53-70" name="__codelineno-53-70" href="#__codelineno-53-70"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-53-71"><a id="__codelineno-53-71" name="__codelineno-53-71" href="#__codelineno-53-71"></a>        <span class="c1"># Shared representations</span>
</span><span id="__span-53-72"><a id="__codelineno-53-72" name="__codelineno-53-72" href="#__codelineno-53-72"></a>        <span class="n">shared_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_network</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-53-73"><a id="__codelineno-53-73" name="__codelineno-53-73" href="#__codelineno-53-73"></a>
</span><span id="__span-53-74"><a id="__codelineno-53-74" name="__codelineno-53-74" href="#__codelineno-53-74"></a>        <span class="c1"># Task-specific predictions</span>
</span><span id="__span-53-75"><a id="__codelineno-53-75" name="__codelineno-53-75" href="#__codelineno-53-75"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-53-76"><a id="__codelineno-53-76" name="__codelineno-53-76" href="#__codelineno-53-76"></a>        <span class="k">for</span> <span class="n">task_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_names</span><span class="p">:</span>
</span><span id="__span-53-77"><a id="__codelineno-53-77" name="__codelineno-53-77" href="#__codelineno-53-77"></a>            <span class="n">outputs</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_heads</span><span class="p">[</span><span class="n">task_name</span><span class="p">](</span><span class="n">shared_features</span><span class="p">)</span>
</span><span id="__span-53-78"><a id="__codelineno-53-78" name="__codelineno-53-78" href="#__codelineno-53-78"></a>
</span><span id="__span-53-79"><a id="__codelineno-53-79" name="__codelineno-53-79" href="#__codelineno-53-79"></a>        <span class="k">return</span> <span class="n">outputs</span>
</span><span id="__span-53-80"><a id="__codelineno-53-80" name="__codelineno-53-80" href="#__codelineno-53-80"></a>
</span><span id="__span-53-81"><a id="__codelineno-53-81" name="__codelineno-53-81" href="#__codelineno-53-81"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_shared_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-53-82"><a id="__codelineno-53-82" name="__codelineno-53-82" href="#__codelineno-53-82"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract shared representations for visualization or transfer learning&quot;&quot;&quot;</span>
</span><span id="__span-53-83"><a id="__codelineno-53-83" name="__codelineno-53-83" href="#__codelineno-53-83"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_network</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-53-84"><a id="__codelineno-53-84" name="__codelineno-53-84" href="#__codelineno-53-84"></a>
</span><span id="__span-53-85"><a id="__codelineno-53-85" name="__codelineno-53-85" href="#__codelineno-53-85"></a><span class="c1"># Example instantiation</span>
</span><span id="__span-53-86"><a id="__codelineno-53-86" name="__codelineno-53-86" href="#__codelineno-53-86"></a><span class="n">task_configs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-53-87"><a id="__codelineno-53-87" name="__codelineno-53-87" href="#__codelineno-53-87"></a>    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;solubility&#39;</span><span class="p">,</span> <span class="s1">&#39;output_dim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">},</span>
</span><span id="__span-53-88"><a id="__codelineno-53-88" name="__codelineno-53-88" href="#__codelineno-53-88"></a>    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bbb_permeability&#39;</span><span class="p">,</span> <span class="s1">&#39;output_dim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">},</span>
</span><span id="__span-53-89"><a id="__codelineno-53-89" name="__codelineno-53-89" href="#__codelineno-53-89"></a>    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;toxicity&#39;</span><span class="p">,</span> <span class="s1">&#39;output_dim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s1">&#39;classification&#39;</span><span class="p">},</span>
</span><span id="__span-53-90"><a id="__codelineno-53-90" name="__codelineno-53-90" href="#__codelineno-53-90"></a>    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;cyp450_inhibition&#39;</span><span class="p">,</span> <span class="s1">&#39;output_dim&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s1">&#39;multi-class&#39;</span><span class="p">}</span>
</span><span id="__span-53-91"><a id="__codelineno-53-91" name="__codelineno-53-91" href="#__codelineno-53-91"></a><span class="p">]</span>
</span><span id="__span-53-92"><a id="__codelineno-53-92" name="__codelineno-53-92" href="#__codelineno-53-92"></a>
</span><span id="__span-53-93"><a id="__codelineno-53-93" name="__codelineno-53-93" href="#__codelineno-53-93"></a><span class="n">model</span> <span class="o">=</span> <span class="n">MultiTaskMolecularModel</span><span class="p">(</span>
</span><span id="__span-53-94"><a id="__codelineno-53-94" name="__codelineno-53-94" href="#__codelineno-53-94"></a>    <span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
</span><span id="__span-53-95"><a id="__codelineno-53-95" name="__codelineno-53-95" href="#__codelineno-53-95"></a>    <span class="n">shared_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span>
</span><span id="__span-53-96"><a id="__codelineno-53-96" name="__codelineno-53-96" href="#__codelineno-53-96"></a>    <span class="n">task_configs</span><span class="o">=</span><span class="n">task_configs</span><span class="p">,</span>
</span><span id="__span-53-97"><a id="__codelineno-53-97" name="__codelineno-53-97" href="#__codelineno-53-97"></a>    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span>
</span><span id="__span-53-98"><a id="__codelineno-53-98" name="__codelineno-53-98" href="#__codelineno-53-98"></a><span class="p">)</span>
</span><span id="__span-53-99"><a id="__codelineno-53-99" name="__codelineno-53-99" href="#__codelineno-53-99"></a>
</span><span id="__span-53-100"><a id="__codelineno-53-100" name="__codelineno-53-100" href="#__codelineno-53-100"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Soft Parameter Sharing</strong> (Advanced)</p>
<p>Each task has its own network, but networks are constrained to be similar:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SoftParameterSharingModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="sd">    Soft parameter sharing: separate networks with similarity constraints</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dims</span><span class="p">,</span> <span class="n">num_tasks</span><span class="p">):</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SoftParameterSharingModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>        <span class="c1"># Create separate networks for each task</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task_networks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_network</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dims</span><span class="p">)</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">)</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a>        <span class="p">])</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dims</span><span class="p">):</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a>        <span class="n">prev_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a>        <span class="k">for</span> <span class="n">hidden_dim</span> <span class="ow">in</span> <span class="n">hidden_dims</span><span class="p">:</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a>            <span class="n">layers</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">prev_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a>            <span class="p">])</span>
</span><span id="__span-54-22"><a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a>            <span class="n">prev_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
</span><span id="__span-54-23"><a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">prev_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="__span-54-24"><a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a>        <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span><span id="__span-54-25"><a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a>
</span><span id="__span-54-26"><a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-54-27"><a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-54-28"><a id="__codelineno-54-28" name="__codelineno-54-28" href="#__codelineno-54-28"></a>        <span class="k">for</span> <span class="n">network</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_networks</span><span class="p">:</span>
</span><span id="__span-54-29"><a id="__codelineno-54-29" name="__codelineno-54-29" href="#__codelineno-54-29"></a>            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">network</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="__span-54-30"><a id="__codelineno-54-30" name="__codelineno-54-30" href="#__codelineno-54-30"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-54-31"><a id="__codelineno-54-31" name="__codelineno-54-31" href="#__codelineno-54-31"></a>
</span><span id="__span-54-32"><a id="__codelineno-54-32" name="__codelineno-54-32" href="#__codelineno-54-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_similarity_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lambda_reg</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
</span><span id="__span-54-33"><a id="__codelineno-54-33" name="__codelineno-54-33" href="#__codelineno-54-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-54-34"><a id="__codelineno-54-34" name="__codelineno-54-34" href="#__codelineno-54-34"></a><span class="sd">        Regularization term to keep task networks similar</span>
</span><span id="__span-54-35"><a id="__codelineno-54-35" name="__codelineno-54-35" href="#__codelineno-54-35"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-54-36"><a id="__codelineno-54-36" name="__codelineno-54-36" href="#__codelineno-54-36"></a>        <span class="n">similarity_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-54-37"><a id="__codelineno-54-37" name="__codelineno-54-37" href="#__codelineno-54-37"></a>        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_networks</span><span class="p">)</span>
</span><span id="__span-54-38"><a id="__codelineno-54-38" name="__codelineno-54-38" href="#__codelineno-54-38"></a>
</span><span id="__span-54-39"><a id="__codelineno-54-39" name="__codelineno-54-39" href="#__codelineno-54-39"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">):</span>
</span><span id="__span-54-40"><a id="__codelineno-54-40" name="__codelineno-54-40" href="#__codelineno-54-40"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_tasks</span><span class="p">):</span>
</span><span id="__span-54-41"><a id="__codelineno-54-41" name="__codelineno-54-41" href="#__codelineno-54-41"></a>                <span class="c1"># L2 distance between parameters</span>
</span><span id="__span-54-42"><a id="__codelineno-54-42" name="__codelineno-54-42" href="#__codelineno-54-42"></a>                <span class="k">for</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_networks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> 
</span><span id="__span-54-43"><a id="__codelineno-54-43" name="__codelineno-54-43" href="#__codelineno-54-43"></a>                                 <span class="bp">self</span><span class="o">.</span><span class="n">task_networks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">()):</span>
</span><span id="__span-54-44"><a id="__codelineno-54-44" name="__codelineno-54-44" href="#__codelineno-54-44"></a>                    <span class="n">similarity_loss</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-54-45"><a id="__codelineno-54-45" name="__codelineno-54-45" href="#__codelineno-54-45"></a>
</span><span id="__span-54-46"><a id="__codelineno-54-46" name="__codelineno-54-46" href="#__codelineno-54-46"></a>        <span class="k">return</span> <span class="n">lambda_reg</span> <span class="o">*</span> <span class="n">similarity_loss</span>
</span></code></pre></div>
<h3 id="33__training__strategies">3.3 Training Strategies<a class="headerlink" href="#33__training__strategies" title="Permanent link">&para;</a></h3>
<p><strong>Multi-Task Loss Function:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_multitask_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">,</span> <span class="n">task_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="sd">    Compute weighted combination of task-specific losses</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="sd">    Args:</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="sd">        outputs: Dict of predictions {task_name: predictions}</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="sd">        labels: Dict of true labels {task_name: labels}</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="sd">        task_configs: List of task configurations</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="sd">        task_weights: Dict of loss weights {task_name: weight}</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="sd">    Returns:</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="sd">        total_loss: Combined loss</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="sd">        task_losses: Dict of individual task losses</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a>    <span class="k">if</span> <span class="n">task_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-55-16"><a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a>        <span class="n">task_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">}</span>
</span><span id="__span-55-17"><a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>
</span><span id="__span-55-18"><a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a>    <span class="n">task_losses</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-55-19"><a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-55-20"><a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a>
</span><span id="__span-55-21"><a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a>    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">:</span>
</span><span id="__span-55-22"><a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a>        <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="__span-55-23"><a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a>        <span class="n">task_type</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span>
</span><span id="__span-55-24"><a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a>
</span><span id="__span-55-25"><a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a>        <span class="c1"># Skip if no labels for this task in batch</span>
</span><span id="__span-55-26"><a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a>        <span class="k">if</span> <span class="n">task_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span> <span class="ow">or</span> <span class="n">labels</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-55-27"><a id="__codelineno-55-27" name="__codelineno-55-27" href="#__codelineno-55-27"></a>            <span class="k">continue</span>
</span><span id="__span-55-28"><a id="__codelineno-55-28" name="__codelineno-55-28" href="#__codelineno-55-28"></a>
</span><span id="__span-55-29"><a id="__codelineno-55-29" name="__codelineno-55-29" href="#__codelineno-55-29"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span>
</span><span id="__span-55-30"><a id="__codelineno-55-30" name="__codelineno-55-30" href="#__codelineno-55-30"></a>        <span class="n">true</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span>
</span><span id="__span-55-31"><a id="__codelineno-55-31" name="__codelineno-55-31" href="#__codelineno-55-31"></a>
</span><span id="__span-55-32"><a id="__codelineno-55-32" name="__codelineno-55-32" href="#__codelineno-55-32"></a>        <span class="c1"># Select appropriate loss function</span>
</span><span id="__span-55-33"><a id="__codelineno-55-33" name="__codelineno-55-33" href="#__codelineno-55-33"></a>        <span class="k">if</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
</span><span id="__span-55-34"><a id="__codelineno-55-34" name="__codelineno-55-34" href="#__codelineno-55-34"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()(</span><span class="n">pred</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span>
</span><span id="__span-55-35"><a id="__codelineno-55-35" name="__codelineno-55-35" href="#__codelineno-55-35"></a>        <span class="k">elif</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
</span><span id="__span-55-36"><a id="__codelineno-55-36" name="__codelineno-55-36" href="#__codelineno-55-36"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()(</span><span class="n">pred</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span>
</span><span id="__span-55-37"><a id="__codelineno-55-37" name="__codelineno-55-37" href="#__codelineno-55-37"></a>        <span class="k">elif</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;multi-class&#39;</span><span class="p">:</span>
</span><span id="__span-55-38"><a id="__codelineno-55-38" name="__codelineno-55-38" href="#__codelineno-55-38"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()(</span><span class="n">pred</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span>
</span><span id="__span-55-39"><a id="__codelineno-55-39" name="__codelineno-55-39" href="#__codelineno-55-39"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-55-40"><a id="__codelineno-55-40" name="__codelineno-55-40" href="#__codelineno-55-40"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown task type: </span><span class="si">{</span><span class="n">task_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-55-41"><a id="__codelineno-55-41" name="__codelineno-55-41" href="#__codelineno-55-41"></a>
</span><span id="__span-55-42"><a id="__codelineno-55-42" name="__codelineno-55-42" href="#__codelineno-55-42"></a>        <span class="n">task_losses</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-55-43"><a id="__codelineno-55-43" name="__codelineno-55-43" href="#__codelineno-55-43"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">task_weights</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss</span>
</span><span id="__span-55-44"><a id="__codelineno-55-44" name="__codelineno-55-44" href="#__codelineno-55-44"></a>
</span><span id="__span-55-45"><a id="__codelineno-55-45" name="__codelineno-55-45" href="#__codelineno-55-45"></a>    <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">task_losses</span>
</span></code></pre></div>
<p><strong>Complete Training Loop:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_multitask_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">,</span> 
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>                         <span class="n">num_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="sd">    Complete multi-task training pipeline</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>    <span class="c1"># Initialize task weights (can be learned or fixed)</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>    <span class="n">task_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">}</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>    <span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;task_losses&#39;</span><span class="p">:</span> <span class="p">{}}</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>    <span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a>        <span class="c1"># Training</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>        <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>        <span class="n">train_task_losses</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">}</span>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_labels</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a>            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a>            <span class="n">batch_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> 
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a>                          <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="__span-56-26"><a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a>
</span><span id="__span-56-27"><a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-56-28"><a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-56-29"><a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a>
</span><span id="__span-56-30"><a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a>            <span class="n">loss</span><span class="p">,</span> <span class="n">task_losses</span> <span class="o">=</span> <span class="n">compute_multitask_loss</span><span class="p">(</span>
</span><span id="__span-56-31"><a id="__codelineno-56-31" name="__codelineno-56-31" href="#__codelineno-56-31"></a>                <span class="n">outputs</span><span class="p">,</span> <span class="n">batch_labels</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">,</span> <span class="n">task_weights</span>
</span><span id="__span-56-32"><a id="__codelineno-56-32" name="__codelineno-56-32" href="#__codelineno-56-32"></a>            <span class="p">)</span>
</span><span id="__span-56-33"><a id="__codelineno-56-33" name="__codelineno-56-33" href="#__codelineno-56-33"></a>
</span><span id="__span-56-34"><a id="__codelineno-56-34" name="__codelineno-56-34" href="#__codelineno-56-34"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-56-35"><a id="__codelineno-56-35" name="__codelineno-56-35" href="#__codelineno-56-35"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-56-36"><a id="__codelineno-56-36" name="__codelineno-56-36" href="#__codelineno-56-36"></a>
</span><span id="__span-56-37"><a id="__codelineno-56-37" name="__codelineno-56-37" href="#__codelineno-56-37"></a>            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-56-38"><a id="__codelineno-56-38" name="__codelineno-56-38" href="#__codelineno-56-38"></a>            <span class="k">for</span> <span class="n">task_name</span><span class="p">,</span> <span class="n">task_loss</span> <span class="ow">in</span> <span class="n">task_losses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-56-39"><a id="__codelineno-56-39" name="__codelineno-56-39" href="#__codelineno-56-39"></a>                <span class="n">train_task_losses</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">task_loss</span>
</span><span id="__span-56-40"><a id="__codelineno-56-40" name="__codelineno-56-40" href="#__codelineno-56-40"></a>
</span><span id="__span-56-41"><a id="__codelineno-56-41" name="__codelineno-56-41" href="#__codelineno-56-41"></a>        <span class="c1"># Validation</span>
</span><span id="__span-56-42"><a id="__codelineno-56-42" name="__codelineno-56-42" href="#__codelineno-56-42"></a>        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-56-43"><a id="__codelineno-56-43" name="__codelineno-56-43" href="#__codelineno-56-43"></a>        <span class="n">val_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-56-44"><a id="__codelineno-56-44" name="__codelineno-56-44" href="#__codelineno-56-44"></a>        <span class="n">val_task_losses</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">}</span>
</span><span id="__span-56-45"><a id="__codelineno-56-45" name="__codelineno-56-45" href="#__codelineno-56-45"></a>
</span><span id="__span-56-46"><a id="__codelineno-56-46" name="__codelineno-56-46" href="#__codelineno-56-46"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-56-47"><a id="__codelineno-56-47" name="__codelineno-56-47" href="#__codelineno-56-47"></a>            <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_labels</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
</span><span id="__span-56-48"><a id="__codelineno-56-48" name="__codelineno-56-48" href="#__codelineno-56-48"></a>                <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-56-49"><a id="__codelineno-56-49" name="__codelineno-56-49" href="#__codelineno-56-49"></a>                <span class="n">batch_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> 
</span><span id="__span-56-50"><a id="__codelineno-56-50" name="__codelineno-56-50" href="#__codelineno-56-50"></a>                              <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="__span-56-51"><a id="__codelineno-56-51" name="__codelineno-56-51" href="#__codelineno-56-51"></a>
</span><span id="__span-56-52"><a id="__codelineno-56-52" name="__codelineno-56-52" href="#__codelineno-56-52"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-56-53"><a id="__codelineno-56-53" name="__codelineno-56-53" href="#__codelineno-56-53"></a>                <span class="n">loss</span><span class="p">,</span> <span class="n">task_losses</span> <span class="o">=</span> <span class="n">compute_multitask_loss</span><span class="p">(</span>
</span><span id="__span-56-54"><a id="__codelineno-56-54" name="__codelineno-56-54" href="#__codelineno-56-54"></a>                    <span class="n">outputs</span><span class="p">,</span> <span class="n">batch_labels</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">,</span> <span class="n">task_weights</span>
</span><span id="__span-56-55"><a id="__codelineno-56-55" name="__codelineno-56-55" href="#__codelineno-56-55"></a>                <span class="p">)</span>
</span><span id="__span-56-56"><a id="__codelineno-56-56" name="__codelineno-56-56" href="#__codelineno-56-56"></a>
</span><span id="__span-56-57"><a id="__codelineno-56-57" name="__codelineno-56-57" href="#__codelineno-56-57"></a>                <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-56-58"><a id="__codelineno-56-58" name="__codelineno-56-58" href="#__codelineno-56-58"></a>                <span class="k">for</span> <span class="n">task_name</span><span class="p">,</span> <span class="n">task_loss</span> <span class="ow">in</span> <span class="n">task_losses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-56-59"><a id="__codelineno-56-59" name="__codelineno-56-59" href="#__codelineno-56-59"></a>                    <span class="n">val_task_losses</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">task_loss</span>
</span><span id="__span-56-60"><a id="__codelineno-56-60" name="__codelineno-56-60" href="#__codelineno-56-60"></a>
</span><span id="__span-56-61"><a id="__codelineno-56-61" name="__codelineno-56-61" href="#__codelineno-56-61"></a>        <span class="c1"># Average losses</span>
</span><span id="__span-56-62"><a id="__codelineno-56-62" name="__codelineno-56-62" href="#__codelineno-56-62"></a>        <span class="n">train_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
</span><span id="__span-56-63"><a id="__codelineno-56-63" name="__codelineno-56-63" href="#__codelineno-56-63"></a>        <span class="n">val_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
</span><span id="__span-56-64"><a id="__codelineno-56-64" name="__codelineno-56-64" href="#__codelineno-56-64"></a>
</span><span id="__span-56-65"><a id="__codelineno-56-65" name="__codelineno-56-65" href="#__codelineno-56-65"></a>        <span class="c1"># Learning rate scheduling</span>
</span><span id="__span-56-66"><a id="__codelineno-56-66" name="__codelineno-56-66" href="#__codelineno-56-66"></a>        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-56-67"><a id="__codelineno-56-67" name="__codelineno-56-67" href="#__codelineno-56-67"></a>
</span><span id="__span-56-68"><a id="__codelineno-56-68" name="__codelineno-56-68" href="#__codelineno-56-68"></a>        <span class="c1"># Print progress</span>
</span><span id="__span-56-69"><a id="__codelineno-56-69" name="__codelineno-56-69" href="#__codelineno-56-69"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-56-70"><a id="__codelineno-56-70" name="__codelineno-56-70" href="#__codelineno-56-70"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-56-71"><a id="__codelineno-56-71" name="__codelineno-56-71" href="#__codelineno-56-71"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Val Loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-56-72"><a id="__codelineno-56-72" name="__codelineno-56-72" href="#__codelineno-56-72"></a>            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">:</span>
</span><span id="__span-56-73"><a id="__codelineno-56-73" name="__codelineno-56-73" href="#__codelineno-56-73"></a>                <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="__span-56-74"><a id="__codelineno-56-74" name="__codelineno-56-74" href="#__codelineno-56-74"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val_task_losses</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-56-75"><a id="__codelineno-56-75" name="__codelineno-56-75" href="#__codelineno-56-75"></a>
</span><span id="__span-56-76"><a id="__codelineno-56-76" name="__codelineno-56-76" href="#__codelineno-56-76"></a>        <span class="c1"># Save best model</span>
</span><span id="__span-56-77"><a id="__codelineno-56-77" name="__codelineno-56-77" href="#__codelineno-56-77"></a>        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
</span><span id="__span-56-78"><a id="__codelineno-56-78" name="__codelineno-56-78" href="#__codelineno-56-78"></a>            <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
</span><span id="__span-56-79"><a id="__codelineno-56-79" name="__codelineno-56-79" href="#__codelineno-56-79"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;best_multitask_model.pth&#39;</span><span class="p">)</span>
</span><span id="__span-56-80"><a id="__codelineno-56-80" name="__codelineno-56-80" href="#__codelineno-56-80"></a>
</span><span id="__span-56-81"><a id="__codelineno-56-81" name="__codelineno-56-81" href="#__codelineno-56-81"></a>    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">history</span>
</span></code></pre></div>
<h3 id="34__task__balancing__techniques">3.4 Task Balancing Techniques<a class="headerlink" href="#34__task__balancing__techniques" title="Permanent link">&para;</a></h3>
<p>Balancing multiple tasks is crucial for effective multi-task learning.</p>
<p><strong>1. Manual Weight Tuning</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1"># Simple fixed weights</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="n">task_weights</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>    <span class="s1">&#39;solubility&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>    <span class="s1">&#39;bbb_permeability&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># Prioritize this task</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="s1">&#39;toxicity&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>    <span class="s1">&#39;cyp450_inhibition&#39;</span><span class="p">:</span> <span class="mf">1.0</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>2. Uncertainty Weighting</strong> (Kendall et al., 2018)</p>
<p>Learns task weights based on homoscedastic uncertainty:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MultiTaskLossWithUncertainty</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="sd">    Automatically learns task weights based on uncertainty</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_tasks</span><span class="p">):</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MultiTaskLossWithUncertainty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>        <span class="c1"># Log variance for each task (learned parameters)</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_vars</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">))</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">losses</span><span class="p">):</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="sd">        Args:</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="sd">            losses: List of individual task losses</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="sd">        Returns:</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="sd">            Weighted total loss</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">):</span>
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a>            <span class="n">precision</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">log_vars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">precision</span> <span class="o">*</span> <span class="n">loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a>
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a>        <span class="k">return</span> <span class="n">total_loss</span>
</span><span id="__span-58-24"><a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a>
</span><span id="__span-58-25"><a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a><span class="c1"># Usage in training</span>
</span><span id="__span-58-26"><a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a><span class="n">uncertainty_loss</span> <span class="o">=</span> <span class="n">MultiTaskLossWithUncertainty</span><span class="p">(</span><span class="n">num_tasks</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="__span-58-27"><a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">uncertainty_loss</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span>
</span></code></pre></div>
<p><strong>3. Gradient Normalization (GradNorm)</strong></p>
<p>Balances tasks by normalizing gradient magnitudes:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_gradnorm_weights</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="sd">    Compute task weights using GradNorm algorithm</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="sd">    Args:</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="sd">        model: Neural network model</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="sd">        losses: List of task losses</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="sd">        alpha: Hyperparameter for balancing (default: 1.5)</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="sd">    Returns:</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="sd">        Updated task weights</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a>    <span class="c1"># Get gradients for last shared layer</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a>    <span class="n">shared_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">shared_network</span><span class="o">.</span><span class="n">parameters</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>
</span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a>    <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-59-17"><a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a>    <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">losses</span><span class="p">:</span>
</span><span id="__span-59-18"><a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a>        <span class="n">grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">shared_params</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-59-19"><a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a>        <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">grad</span><span class="p">))</span>
</span><span id="__span-59-20"><a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a>
</span><span id="__span-59-21"><a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a>    <span class="c1"># Compute inverse training rate</span>
</span><span id="__span-59-22"><a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a>    <span class="n">loss_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="n">loss</span> <span class="o">/</span> <span class="n">losses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">losses</span><span class="p">]</span>
</span><span id="__span-59-23"><a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a>    <span class="n">mean_loss_ratio</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">loss_ratios</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss_ratios</span><span class="p">)</span>
</span><span id="__span-59-24"><a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a>
</span><span id="__span-59-25"><a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a>    <span class="c1"># Compute target gradients</span>
</span><span id="__span-59-26"><a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a>    <span class="n">target_grads</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_loss_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">**</span> <span class="n">alpha</span><span class="p">)</span> <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">loss_ratios</span><span class="p">]</span>
</span><span id="__span-59-27"><a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a>
</span><span id="__span-59-28"><a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a>    <span class="c1"># Compute weights</span>
</span><span id="__span-59-29"><a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a>    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span> <span class="o">/</span> <span class="n">grad</span> <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">grad</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_grads</span><span class="p">,</span> <span class="n">gradients</span><span class="p">)]</span>
</span><span id="__span-59-30"><a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a>
</span><span id="__span-59-31"><a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a>    <span class="c1"># Normalize</span>
</span><span id="__span-59-32"><a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a>    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>
</span><span id="__span-59-33"><a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a>
</span><span id="__span-59-34"><a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a>    <span class="k">return</span> <span class="n">weights</span>
</span></code></pre></div>
<p><strong>4. Dynamic Task Prioritization</strong></p>
<p>Adjust weights during training based on task performance:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DynamicTaskWeighting</span><span class="p">:</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="sd">    Dynamically adjust task weights during training</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_tasks</span><span class="p">,</span> <span class="n">initial_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>        <span class="k">if</span> <span class="n">initial_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tasks</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">initial_weights</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_history</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tasks</span><span class="p">)]</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">task_losses</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;inverse_performance&#39;</span><span class="p">):</span>
</span><span id="__span-60-14"><a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-60-15"><a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="sd">        Update weights based on task performance</span>
</span><span id="__span-60-16"><a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>
</span><span id="__span-60-17"><a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="sd">        Strategies:</span>
</span><span id="__span-60-18"><a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="sd">        - &#39;inverse_performance&#39;: Higher weight for worse-performing tasks</span>
</span><span id="__span-60-19"><a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="sd">        - &#39;uncertainty&#39;: Higher weight for high-variance tasks</span>
</span><span id="__span-60-20"><a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="sd">        - &#39;curriculum&#39;: Gradually increase difficulty</span>
</span><span id="__span-60-21"><a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-60-22"><a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_losses</span><span class="p">):</span>
</span><span id="__span-60-23"><a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loss_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="__span-60-24"><a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a>
</span><span id="__span-60-25"><a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Wait for some history</span>
</span><span id="__span-60-26"><a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
</span><span id="__span-60-27"><a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a>
</span><span id="__span-60-28"><a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a>        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;inverse_performance&#39;</span><span class="p">:</span>
</span><span id="__span-60-29"><a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a>            <span class="c1"># Give more weight to tasks with higher recent loss</span>
</span><span id="__span-60-30"><a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a>            <span class="n">recent_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span> <span class="k">for</span> <span class="n">history</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_history</span><span class="p">]</span>
</span><span id="__span-60-31"><a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">recent_losses</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_losses</span><span class="p">)</span> 
</span><span id="__span-60-32"><a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a>                           <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">recent_losses</span><span class="p">]</span>
</span><span id="__span-60-33"><a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a>
</span><span id="__span-60-34"><a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a>        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;uncertainty&#39;</span><span class="p">:</span>
</span><span id="__span-60-35"><a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a>            <span class="c1"># Give more weight to high-variance tasks</span>
</span><span id="__span-60-36"><a id="__codelineno-60-36" name="__codelineno-60-36" href="#__codelineno-60-36"></a>            <span class="n">variances</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span> <span class="k">for</span> <span class="n">history</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_history</span><span class="p">]</span>
</span><span id="__span-60-37"><a id="__codelineno-60-37" name="__codelineno-60-37" href="#__codelineno-60-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span> 
</span><span id="__span-60-38"><a id="__codelineno-60-38" name="__codelineno-60-38" href="#__codelineno-60-38"></a>                           <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variances</span><span class="p">]</span>
</span><span id="__span-60-39"><a id="__codelineno-60-39" name="__codelineno-60-39" href="#__codelineno-60-39"></a>
</span><span id="__span-60-40"><a id="__codelineno-60-40" name="__codelineno-60-40" href="#__codelineno-60-40"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
</span></code></pre></div>
<h3 id="35__performance__comparison">3.5 Performance Comparison<a class="headerlink" href="#35__performance__comparison" title="Permanent link">&para;</a></h3>
<p><strong>Evaluation Metrics for Multi-Task Learning:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_multitask_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="sd">    Comprehensive evaluation of multi-task model</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>    <span class="c1"># Store predictions and labels</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>    <span class="n">predictions</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">}</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>    <span class="n">true_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">}</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_labels</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">:</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>                <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>                <span class="k">if</span> <span class="n">task_name</span> <span class="ow">in</span> <span class="n">batch_labels</span> <span class="ow">and</span> <span class="n">batch_labels</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>                    <span class="n">predictions</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>                        <span class="n">outputs</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>                    <span class="p">)</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a>                    <span class="n">true_labels</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
</span><span id="__span-61-24"><a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a>                        <span class="n">batch_labels</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-61-25"><a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a>                    <span class="p">)</span>
</span><span id="__span-61-26"><a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a>
</span><span id="__span-61-27"><a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a>    <span class="c1"># Compute metrics for each task</span>
</span><span id="__span-61-28"><a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-61-29"><a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a>
</span><span id="__span-61-30"><a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a>    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">:</span>
</span><span id="__span-61-31"><a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a>        <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="__span-61-32"><a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a>        <span class="n">task_type</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span>
</span><span id="__span-61-33"><a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a>
</span><span id="__span-61-34"><a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">task_name</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-61-35"><a id="__codelineno-61-35" name="__codelineno-61-35" href="#__codelineno-61-35"></a>        <span class="n">true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_labels</span><span class="p">[</span><span class="n">task_name</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-61-36"><a id="__codelineno-61-36" name="__codelineno-61-36" href="#__codelineno-61-36"></a>
</span><span id="__span-61-37"><a id="__codelineno-61-37" name="__codelineno-61-37" href="#__codelineno-61-37"></a>        <span class="k">if</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
</span><span id="__span-61-38"><a id="__codelineno-61-38" name="__codelineno-61-38" href="#__codelineno-61-38"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span>
</span><span id="__span-61-39"><a id="__codelineno-61-39" name="__codelineno-61-39" href="#__codelineno-61-39"></a>
</span><span id="__span-61-40"><a id="__codelineno-61-40" name="__codelineno-61-40" href="#__codelineno-61-40"></a>            <span class="n">results</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-61-41"><a id="__codelineno-61-41" name="__codelineno-61-41" href="#__codelineno-61-41"></a>                <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pred</span><span class="p">)),</span>
</span><span id="__span-61-42"><a id="__codelineno-61-42" name="__codelineno-61-42" href="#__codelineno-61-42"></a>                <span class="s1">&#39;MAE&#39;</span><span class="p">:</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pred</span><span class="p">),</span>
</span><span id="__span-61-43"><a id="__codelineno-61-43" name="__codelineno-61-43" href="#__codelineno-61-43"></a>                <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
</span><span id="__span-61-44"><a id="__codelineno-61-44" name="__codelineno-61-44" href="#__codelineno-61-44"></a>            <span class="p">}</span>
</span><span id="__span-61-45"><a id="__codelineno-61-45" name="__codelineno-61-45" href="#__codelineno-61-45"></a>
</span><span id="__span-61-46"><a id="__codelineno-61-46" name="__codelineno-61-46" href="#__codelineno-61-46"></a>        <span class="k">elif</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
</span><span id="__span-61-47"><a id="__codelineno-61-47" name="__codelineno-61-47" href="#__codelineno-61-47"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span>
</span><span id="__span-61-48"><a id="__codelineno-61-48" name="__codelineno-61-48" href="#__codelineno-61-48"></a>
</span><span id="__span-61-49"><a id="__codelineno-61-49" name="__codelineno-61-49" href="#__codelineno-61-49"></a>            <span class="n">pred_binary</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="__span-61-50"><a id="__codelineno-61-50" name="__codelineno-61-50" href="#__codelineno-61-50"></a>
</span><span id="__span-61-51"><a id="__codelineno-61-51" name="__codelineno-61-51" href="#__codelineno-61-51"></a>            <span class="n">results</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-61-52"><a id="__codelineno-61-52" name="__codelineno-61-52" href="#__codelineno-61-52"></a>                <span class="s1">&#39;ROC-AUC&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pred</span><span class="p">),</span>
</span><span id="__span-61-53"><a id="__codelineno-61-53" name="__codelineno-61-53" href="#__codelineno-61-53"></a>                <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pred_binary</span><span class="p">),</span>
</span><span id="__span-61-54"><a id="__codelineno-61-54" name="__codelineno-61-54" href="#__codelineno-61-54"></a>                <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">pred_binary</span><span class="p">)</span>
</span><span id="__span-61-55"><a id="__codelineno-61-55" name="__codelineno-61-55" href="#__codelineno-61-55"></a>            <span class="p">}</span>
</span><span id="__span-61-56"><a id="__codelineno-61-56" name="__codelineno-61-56" href="#__codelineno-61-56"></a>
</span><span id="__span-61-57"><a id="__codelineno-61-57" name="__codelineno-61-57" href="#__codelineno-61-57"></a>    <span class="k">return</span> <span class="n">results</span>
</span><span id="__span-61-58"><a id="__codelineno-61-58" name="__codelineno-61-58" href="#__codelineno-61-58"></a>
</span><span id="__span-61-59"><a id="__codelineno-61-59" name="__codelineno-61-59" href="#__codelineno-61-59"></a><span class="c1"># Compare with single-task models</span>
</span><span id="__span-61-60"><a id="__codelineno-61-60" name="__codelineno-61-60" href="#__codelineno-61-60"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_single_vs_multitask</span><span class="p">(</span><span class="n">smiles_data</span><span class="p">,</span> <span class="n">labels_dict</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">):</span>
</span><span id="__span-61-61"><a id="__codelineno-61-61" name="__codelineno-61-61" href="#__codelineno-61-61"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-61-62"><a id="__codelineno-61-62" name="__codelineno-61-62" href="#__codelineno-61-62"></a><span class="sd">    Train single-task models and compare with multi-task model</span>
</span><span id="__span-61-63"><a id="__codelineno-61-63" name="__codelineno-61-63" href="#__codelineno-61-63"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-61-64"><a id="__codelineno-61-64" name="__codelineno-61-64" href="#__codelineno-61-64"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;single_task&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;multi_task&#39;</span><span class="p">:</span> <span class="p">{}}</span>
</span><span id="__span-61-65"><a id="__codelineno-61-65" name="__codelineno-61-65" href="#__codelineno-61-65"></a>
</span><span id="__span-61-66"><a id="__codelineno-61-66" name="__codelineno-61-66" href="#__codelineno-61-66"></a>    <span class="c1"># Train single-task models</span>
</span><span id="__span-61-67"><a id="__codelineno-61-67" name="__codelineno-61-67" href="#__codelineno-61-67"></a>    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">:</span>
</span><span id="__span-61-68"><a id="__codelineno-61-68" name="__codelineno-61-68" href="#__codelineno-61-68"></a>        <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="__span-61-69"><a id="__codelineno-61-69" name="__codelineno-61-69" href="#__codelineno-61-69"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training single-task model for </span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-61-70"><a id="__codelineno-61-70" name="__codelineno-61-70" href="#__codelineno-61-70"></a>
</span><span id="__span-61-71"><a id="__codelineno-61-71" name="__codelineno-61-71" href="#__codelineno-61-71"></a>        <span class="n">single_model</span> <span class="o">=</span> <span class="n">MolecularFNN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-61-72"><a id="__codelineno-61-72" name="__codelineno-61-72" href="#__codelineno-61-72"></a>        <span class="c1"># Train single_model (code similar to previous examples)</span>
</span><span id="__span-61-73"><a id="__codelineno-61-73" name="__codelineno-61-73" href="#__codelineno-61-73"></a>        <span class="c1"># ...</span>
</span><span id="__span-61-74"><a id="__codelineno-61-74" name="__codelineno-61-74" href="#__codelineno-61-74"></a>        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;single_task&#39;</span><span class="p">][</span><span class="n">task_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">single_model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
</span><span id="__span-61-75"><a id="__codelineno-61-75" name="__codelineno-61-75" href="#__codelineno-61-75"></a>
</span><span id="__span-61-76"><a id="__codelineno-61-76" name="__codelineno-61-76" href="#__codelineno-61-76"></a>    <span class="c1"># Train multi-task model</span>
</span><span id="__span-61-77"><a id="__codelineno-61-77" name="__codelineno-61-77" href="#__codelineno-61-77"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training multi-task model...&quot;</span><span class="p">)</span>
</span><span id="__span-61-78"><a id="__codelineno-61-78" name="__codelineno-61-78" href="#__codelineno-61-78"></a>    <span class="n">multitask_model</span> <span class="o">=</span> <span class="n">MultiTaskMolecularModel</span><span class="p">(</span><span class="n">task_configs</span><span class="o">=</span><span class="n">task_configs</span><span class="p">)</span>
</span><span id="__span-61-79"><a id="__codelineno-61-79" name="__codelineno-61-79" href="#__codelineno-61-79"></a>    <span class="c1"># Train multitask_model</span>
</span><span id="__span-61-80"><a id="__codelineno-61-80" name="__codelineno-61-80" href="#__codelineno-61-80"></a>    <span class="c1"># ...</span>
</span><span id="__span-61-81"><a id="__codelineno-61-81" name="__codelineno-61-81" href="#__codelineno-61-81"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;multi_task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate_multitask_model</span><span class="p">(</span><span class="n">multitask_model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">)</span>
</span><span id="__span-61-82"><a id="__codelineno-61-82" name="__codelineno-61-82" href="#__codelineno-61-82"></a>
</span><span id="__span-61-83"><a id="__codelineno-61-83" name="__codelineno-61-83" href="#__codelineno-61-83"></a>    <span class="c1"># Print comparison</span>
</span><span id="__span-61-84"><a id="__codelineno-61-84" name="__codelineno-61-84" href="#__codelineno-61-84"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</span><span id="__span-61-85"><a id="__codelineno-61-85" name="__codelineno-61-85" href="#__codelineno-61-85"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SINGLE-TASK vs MULTI-TASK COMPARISON&quot;</span><span class="p">)</span>
</span><span id="__span-61-86"><a id="__codelineno-61-86" name="__codelineno-61-86" href="#__codelineno-61-86"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</span><span id="__span-61-87"><a id="__codelineno-61-87" name="__codelineno-61-87" href="#__codelineno-61-87"></a>
</span><span id="__span-61-88"><a id="__codelineno-61-88" name="__codelineno-61-88" href="#__codelineno-61-88"></a>    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">:</span>
</span><span id="__span-61-89"><a id="__codelineno-61-89" name="__codelineno-61-89" href="#__codelineno-61-89"></a>        <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="__span-61-90"><a id="__codelineno-61-90" name="__codelineno-61-90" href="#__codelineno-61-90"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">task_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
</span><span id="__span-61-91"><a id="__codelineno-61-91" name="__codelineno-61-91" href="#__codelineno-61-91"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Single-task RMSE: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;single_task&#39;</span><span class="p">][</span><span class="n">task_name</span><span class="p">][</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-61-92"><a id="__codelineno-61-92" name="__codelineno-61-92" href="#__codelineno-61-92"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Multi-task RMSE:  </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;multi_task&#39;</span><span class="p">][</span><span class="n">task_name</span><span class="p">][</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-61-93"><a id="__codelineno-61-93" name="__codelineno-61-93" href="#__codelineno-61-93"></a>
</span><span id="__span-61-94"><a id="__codelineno-61-94" name="__codelineno-61-94" href="#__codelineno-61-94"></a>        <span class="n">improvement</span> <span class="o">=</span> <span class="p">((</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;single_task&#39;</span><span class="p">][</span><span class="n">task_name</span><span class="p">][</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span> <span class="o">-</span> 
</span><span id="__span-61-95"><a id="__codelineno-61-95" name="__codelineno-61-95" href="#__codelineno-61-95"></a>                       <span class="n">results</span><span class="p">[</span><span class="s1">&#39;multi_task&#39;</span><span class="p">][</span><span class="n">task_name</span><span class="p">][</span><span class="s1">&#39;RMSE&#39;</span><span class="p">])</span> <span class="o">/</span> 
</span><span id="__span-61-96"><a id="__codelineno-61-96" name="__codelineno-61-96" href="#__codelineno-61-96"></a>                       <span class="n">results</span><span class="p">[</span><span class="s1">&#39;single_task&#39;</span><span class="p">][</span><span class="n">task_name</span><span class="p">][</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="__span-61-97"><a id="__codelineno-61-97" name="__codelineno-61-97" href="#__codelineno-61-97"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Improvement: </span><span class="si">{</span><span class="n">improvement</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="__span-61-98"><a id="__codelineno-61-98" name="__codelineno-61-98" href="#__codelineno-61-98"></a>
</span><span id="__span-61-99"><a id="__codelineno-61-99" name="__codelineno-61-99" href="#__codelineno-61-99"></a>    <span class="k">return</span> <span class="n">results</span>
</span></code></pre></div>
<p><strong>Expected Results:</strong></p>
<table>
<thead>
<tr>
<th>Task</th>
<th>Single-Task RMSE</th>
<th>Multi-Task RMSE</th>
<th>Improvement</th>
</tr>
</thead>
<tbody>
<tr>
<td>Solubility</td>
<td>0.85</td>
<td>0.72</td>
<td>15.3%</td>
</tr>
<tr>
<td>BBB Permeability</td>
<td>0.92</td>
<td>0.79</td>
<td>14.1%</td>
</tr>
<tr>
<td>Toxicity (AUC)</td>
<td>0.78</td>
<td>0.84</td>
<td>7.7%</td>
</tr>
<tr>
<td>CYP450 Inhibition</td>
<td>0.88</td>
<td>0.81</td>
<td>8.0%</td>
</tr>
</tbody>
</table>
<p>Multi-task learning typically shows 10-20% improvement, especially for tasks with limited data.</p>
<hr />
<h2 id="4__convolutional__neural__networks">4. Convolutional Neural Networks<a class="headerlink" href="#4__convolutional__neural__networks" title="Permanent link">&para;</a></h2>
<p>Convolutional Neural Networks (CNNs) excel at extracting local patterns and spatial hierarchies, making them suitable for sequence and image data representations of molecules.</p>
<h3 id="41__1d__cnns__for__smiles">4.1 1D CNNs for SMILES<a class="headerlink" href="#41__1d__cnns__for__smiles" title="Permanent link">&para;</a></h3>
<p>SMILES strings can be treated as sequences where local substructures (like functional groups) are important patterns.</p>
<p><strong>Architecture Overview:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>SMILES: &quot;CCO&quot; → Embedding → Conv1D layers → Pooling → Dense → Output
</span></code></pre></div>
<p><strong>Complete Implementation:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">SMILES_CNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="sd">    1D Convolutional Neural Network for SMILES strings</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">num_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> 
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>                 <span class="n">filter_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="sd">        Args:</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="sd">            vocab_size: Size of character vocabulary (typically 40-60 for SMILES)</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="sd">            embedding_dim: Dimension of character embeddings</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="sd">            num_filters: Number of filters per filter size</span>
</span><span id="__span-63-16"><a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a><span class="sd">            filter_sizes: List of filter sizes (kernel sizes)</span>
</span><span id="__span-63-17"><a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a><span class="sd">            hidden_dim: Size of fully connected layer</span>
</span><span id="__span-63-18"><a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a><span class="sd">            output_dim: Output size (1 for regression)</span>
</span><span id="__span-63-19"><a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a><span class="sd">            dropout_rate: Dropout probability</span>
</span><span id="__span-63-20"><a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-63-21"><a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SMILES_CNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-63-22"><a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a>
</span><span id="__span-63-23"><a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a>        <span class="c1"># Character embedding layer</span>
</span><span id="__span-63-24"><a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-63-25"><a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a>
</span><span id="__span-63-26"><a id="__codelineno-63-26" name="__codelineno-63-26" href="#__codelineno-63-26"></a>        <span class="c1"># Multiple convolutional layers with different kernel sizes</span>
</span><span id="__span-63-27"><a id="__codelineno-63-27" name="__codelineno-63-27" href="#__codelineno-63-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
</span><span id="__span-63-28"><a id="__codelineno-63-28" name="__codelineno-63-28" href="#__codelineno-63-28"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">,</span>
</span><span id="__span-63-29"><a id="__codelineno-63-29" name="__codelineno-63-29" href="#__codelineno-63-29"></a>                     <span class="n">out_channels</span><span class="o">=</span><span class="n">num_filters</span><span class="p">,</span>
</span><span id="__span-63-30"><a id="__codelineno-63-30" name="__codelineno-63-30" href="#__codelineno-63-30"></a>                     <span class="n">kernel_size</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
</span><span id="__span-63-31"><a id="__codelineno-63-31" name="__codelineno-63-31" href="#__codelineno-63-31"></a>            <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">filter_sizes</span>
</span><span id="__span-63-32"><a id="__codelineno-63-32" name="__codelineno-63-32" href="#__codelineno-63-32"></a>        <span class="p">])</span>
</span><span id="__span-63-33"><a id="__codelineno-63-33" name="__codelineno-63-33" href="#__codelineno-63-33"></a>
</span><span id="__span-63-34"><a id="__codelineno-63-34" name="__codelineno-63-34" href="#__codelineno-63-34"></a>        <span class="c1"># Fully connected layers</span>
</span><span id="__span-63-35"><a id="__codelineno-63-35" name="__codelineno-63-35" href="#__codelineno-63-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
</span><span id="__span-63-36"><a id="__codelineno-63-36" name="__codelineno-63-36" href="#__codelineno-63-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</span><span id="__span-63-37"><a id="__codelineno-63-37" name="__codelineno-63-37" href="#__codelineno-63-37"></a>
</span><span id="__span-63-38"><a id="__codelineno-63-38" name="__codelineno-63-38" href="#__codelineno-63-38"></a>        <span class="c1"># Regularization</span>
</span><span id="__span-63-39"><a id="__codelineno-63-39" name="__codelineno-63-39" href="#__codelineno-63-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)</span>
</span><span id="__span-63-40"><a id="__codelineno-63-40" name="__codelineno-63-40" href="#__codelineno-63-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_filters</span><span class="p">)</span>
</span><span id="__span-63-41"><a id="__codelineno-63-41" name="__codelineno-63-41" href="#__codelineno-63-41"></a>
</span><span id="__span-63-42"><a id="__codelineno-63-42" name="__codelineno-63-42" href="#__codelineno-63-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-63-43"><a id="__codelineno-63-43" name="__codelineno-63-43" href="#__codelineno-63-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-63-44"><a id="__codelineno-63-44" name="__codelineno-63-44" href="#__codelineno-63-44"></a><span class="sd">        Args:</span>
</span><span id="__span-63-45"><a id="__codelineno-63-45" name="__codelineno-63-45" href="#__codelineno-63-45"></a><span class="sd">            x: Input tensor of shape (batch_size, max_length)</span>
</span><span id="__span-63-46"><a id="__codelineno-63-46" name="__codelineno-63-46" href="#__codelineno-63-46"></a>
</span><span id="__span-63-47"><a id="__codelineno-63-47" name="__codelineno-63-47" href="#__codelineno-63-47"></a><span class="sd">        Returns:</span>
</span><span id="__span-63-48"><a id="__codelineno-63-48" name="__codelineno-63-48" href="#__codelineno-63-48"></a><span class="sd">            Output predictions of shape (batch_size, output_dim)</span>
</span><span id="__span-63-49"><a id="__codelineno-63-49" name="__codelineno-63-49" href="#__codelineno-63-49"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-63-50"><a id="__codelineno-63-50" name="__codelineno-63-50" href="#__codelineno-63-50"></a>        <span class="c1"># Embedding: (batch_size, max_length) -&gt; (batch_size, max_length, embedding_dim)</span>
</span><span id="__span-63-51"><a id="__codelineno-63-51" name="__codelineno-63-51" href="#__codelineno-63-51"></a>        <span class="n">embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-63-52"><a id="__codelineno-63-52" name="__codelineno-63-52" href="#__codelineno-63-52"></a>
</span><span id="__span-63-53"><a id="__codelineno-63-53" name="__codelineno-63-53" href="#__codelineno-63-53"></a>        <span class="c1"># Transpose for Conv1d: (batch_size, embedding_dim, max_length)</span>
</span><span id="__span-63-54"><a id="__codelineno-63-54" name="__codelineno-63-54" href="#__codelineno-63-54"></a>        <span class="n">embedded</span> <span class="o">=</span> <span class="n">embedded</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-63-55"><a id="__codelineno-63-55" name="__codelineno-63-55" href="#__codelineno-63-55"></a>
</span><span id="__span-63-56"><a id="__codelineno-63-56" name="__codelineno-63-56" href="#__codelineno-63-56"></a>        <span class="c1"># Apply convolutions and max pooling</span>
</span><span id="__span-63-57"><a id="__codelineno-63-57" name="__codelineno-63-57" href="#__codelineno-63-57"></a>        <span class="n">conv_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-63-58"><a id="__codelineno-63-58" name="__codelineno-63-58" href="#__codelineno-63-58"></a>        <span class="k">for</span> <span class="n">conv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="p">:</span>
</span><span id="__span-63-59"><a id="__codelineno-63-59" name="__codelineno-63-59" href="#__codelineno-63-59"></a>            <span class="c1"># Convolution + ReLU: (batch_size, num_filters, length - kernel_size + 1)</span>
</span><span id="__span-63-60"><a id="__codelineno-63-60" name="__codelineno-63-60" href="#__codelineno-63-60"></a>            <span class="n">conv_out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">conv</span><span class="p">(</span><span class="n">embedded</span><span class="p">))</span>
</span><span id="__span-63-61"><a id="__codelineno-63-61" name="__codelineno-63-61" href="#__codelineno-63-61"></a>
</span><span id="__span-63-62"><a id="__codelineno-63-62" name="__codelineno-63-62" href="#__codelineno-63-62"></a>            <span class="c1"># Max pooling: (batch_size, num_filters, 1)</span>
</span><span id="__span-63-63"><a id="__codelineno-63-63" name="__codelineno-63-63" href="#__codelineno-63-63"></a>            <span class="n">pooled</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">max_pool1d</span><span class="p">(</span><span class="n">conv_out</span><span class="p">,</span> <span class="n">conv_out</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><span id="__span-63-64"><a id="__codelineno-63-64" name="__codelineno-63-64" href="#__codelineno-63-64"></a>
</span><span id="__span-63-65"><a id="__codelineno-63-65" name="__codelineno-63-65" href="#__codelineno-63-65"></a>            <span class="c1"># Flatten: (batch_size, num_filters)</span>
</span><span id="__span-63-66"><a id="__codelineno-63-66" name="__codelineno-63-66" href="#__codelineno-63-66"></a>            <span class="n">conv_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pooled</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><span id="__span-63-67"><a id="__codelineno-63-67" name="__codelineno-63-67" href="#__codelineno-63-67"></a>
</span><span id="__span-63-68"><a id="__codelineno-63-68" name="__codelineno-63-68" href="#__codelineno-63-68"></a>        <span class="c1"># Concatenate all filter outputs: (batch_size, len(filter_sizes) * num_filters)</span>
</span><span id="__span-63-69"><a id="__codelineno-63-69" name="__codelineno-63-69" href="#__codelineno-63-69"></a>        <span class="n">concatenated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">conv_outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-63-70"><a id="__codelineno-63-70" name="__codelineno-63-70" href="#__codelineno-63-70"></a>
</span><span id="__span-63-71"><a id="__codelineno-63-71" name="__codelineno-63-71" href="#__codelineno-63-71"></a>        <span class="c1"># Batch normalization</span>
</span><span id="__span-63-72"><a id="__codelineno-63-72" name="__codelineno-63-72" href="#__codelineno-63-72"></a>        <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_norm</span><span class="p">(</span><span class="n">concatenated</span><span class="p">)</span>
</span><span id="__span-63-73"><a id="__codelineno-63-73" name="__codelineno-63-73" href="#__codelineno-63-73"></a>
</span><span id="__span-63-74"><a id="__codelineno-63-74" name="__codelineno-63-74" href="#__codelineno-63-74"></a>        <span class="c1"># Fully connected layers</span>
</span><span id="__span-63-75"><a id="__codelineno-63-75" name="__codelineno-63-75" href="#__codelineno-63-75"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">normalized</span><span class="p">)))</span>
</span><span id="__span-63-76"><a id="__codelineno-63-76" name="__codelineno-63-76" href="#__codelineno-63-76"></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">hidden</span><span class="p">))</span>
</span><span id="__span-63-77"><a id="__codelineno-63-77" name="__codelineno-63-77" href="#__codelineno-63-77"></a>
</span><span id="__span-63-78"><a id="__codelineno-63-78" name="__codelineno-63-78" href="#__codelineno-63-78"></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="__span-63-79"><a id="__codelineno-63-79" name="__codelineno-63-79" href="#__codelineno-63-79"></a>
</span><span id="__span-63-80"><a id="__codelineno-63-80" name="__codelineno-63-80" href="#__codelineno-63-80"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-63-81"><a id="__codelineno-63-81" name="__codelineno-63-81" href="#__codelineno-63-81"></a><span class="c1"># SMILES Tokenization</span>
</span><span id="__span-63-82"><a id="__codelineno-63-82" name="__codelineno-63-82" href="#__codelineno-63-82"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-63-83"><a id="__codelineno-63-83" name="__codelineno-63-83" href="#__codelineno-63-83"></a>
</span><span id="__span-63-84"><a id="__codelineno-63-84" name="__codelineno-63-84" href="#__codelineno-63-84"></a><span class="k">class</span><span class="w"> </span><span class="nc">SMILESTokenizer</span><span class="p">:</span>
</span><span id="__span-63-85"><a id="__codelineno-63-85" name="__codelineno-63-85" href="#__codelineno-63-85"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-63-86"><a id="__codelineno-63-86" name="__codelineno-63-86" href="#__codelineno-63-86"></a><span class="sd">    Tokenizer for SMILES strings</span>
</span><span id="__span-63-87"><a id="__codelineno-63-87" name="__codelineno-63-87" href="#__codelineno-63-87"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-63-88"><a id="__codelineno-63-88" name="__codelineno-63-88" href="#__codelineno-63-88"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-63-89"><a id="__codelineno-63-89" name="__codelineno-63-89" href="#__codelineno-63-89"></a>        <span class="c1"># Common SMILES tokens</span>
</span><span id="__span-63-90"><a id="__codelineno-63-90" name="__codelineno-63-90" href="#__codelineno-63-90"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-63-91"><a id="__codelineno-63-91" name="__codelineno-63-91" href="#__codelineno-63-91"></a>            <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span>  <span class="c1"># Atoms</span>
</span><span id="__span-63-92"><a id="__codelineno-63-92" name="__codelineno-63-92" href="#__codelineno-63-92"></a>            <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>  <span class="c1"># Aromatic atoms</span>
</span><span id="__span-63-93"><a id="__codelineno-63-93" name="__codelineno-63-93" href="#__codelineno-63-93"></a>            <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span>  <span class="c1"># Bonds</span>
</span><span id="__span-63-94"><a id="__codelineno-63-94" name="__codelineno-63-94" href="#__codelineno-63-94"></a>            <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span>  <span class="c1"># Branches</span>
</span><span id="__span-63-95"><a id="__codelineno-63-95" name="__codelineno-63-95" href="#__codelineno-63-95"></a>            <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span>  <span class="c1"># Atom properties</span>
</span><span id="__span-63-96"><a id="__codelineno-63-96" name="__codelineno-63-96" href="#__codelineno-63-96"></a>            <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>  <span class="c1"># Charges</span>
</span><span id="__span-63-97"><a id="__codelineno-63-97" name="__codelineno-63-97" href="#__codelineno-63-97"></a>            <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span>  <span class="c1"># Ring numbers</span>
</span><span id="__span-63-98"><a id="__codelineno-63-98" name="__codelineno-63-98" href="#__codelineno-63-98"></a>            <span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="s1">&#39;@@&#39;</span><span class="p">,</span>  <span class="c1"># Chirality</span>
</span><span id="__span-63-99"><a id="__codelineno-63-99" name="__codelineno-63-99" href="#__codelineno-63-99"></a>            <span class="s1">&#39;H&#39;</span><span class="p">,</span>  <span class="c1"># Hydrogen</span>
</span><span id="__span-63-100"><a id="__codelineno-63-100" name="__codelineno-63-100" href="#__codelineno-63-100"></a>            <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span>  <span class="c1"># Stereochemistry</span>
</span><span id="__span-63-101"><a id="__codelineno-63-101" name="__codelineno-63-101" href="#__codelineno-63-101"></a>        <span class="p">]</span>
</span><span id="__span-63-102"><a id="__codelineno-63-102" name="__codelineno-63-102" href="#__codelineno-63-102"></a>
</span><span id="__span-63-103"><a id="__codelineno-63-103" name="__codelineno-63-103" href="#__codelineno-63-103"></a>        <span class="c1"># Special tokens</span>
</span><span id="__span-63-104"><a id="__codelineno-63-104" name="__codelineno-63-104" href="#__codelineno-63-104"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;START&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;END&gt;&#39;</span><span class="p">]</span>
</span><span id="__span-63-105"><a id="__codelineno-63-105" name="__codelineno-63-105" href="#__codelineno-63-105"></a>
</span><span id="__span-63-106"><a id="__codelineno-63-106" name="__codelineno-63-106" href="#__codelineno-63-106"></a>        <span class="c1"># Create vocabulary</span>
</span><span id="__span-63-107"><a id="__codelineno-63-107" name="__codelineno-63-107" href="#__codelineno-63-107"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_tokens</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span>
</span><span id="__span-63-108"><a id="__codelineno-63-108" name="__codelineno-63-108" href="#__codelineno-63-108"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">token</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)}</span>
</span><span id="__span-63-109"><a id="__codelineno-63-109" name="__codelineno-63-109" href="#__codelineno-63-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="__span-63-110"><a id="__codelineno-63-110" name="__codelineno-63-110" href="#__codelineno-63-110"></a>
</span><span id="__span-63-111"><a id="__codelineno-63-111" name="__codelineno-63-111" href="#__codelineno-63-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;PAD&gt;&#39;</span><span class="p">]</span>
</span><span id="__span-63-112"><a id="__codelineno-63-112" name="__codelineno-63-112" href="#__codelineno-63-112"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unk_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">]</span>
</span><span id="__span-63-113"><a id="__codelineno-63-113" name="__codelineno-63-113" href="#__codelineno-63-113"></a>
</span><span id="__span-63-114"><a id="__codelineno-63-114" name="__codelineno-63-114" href="#__codelineno-63-114"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">):</span>
</span><span id="__span-63-115"><a id="__codelineno-63-115" name="__codelineno-63-115" href="#__codelineno-63-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-63-116"><a id="__codelineno-63-116" name="__codelineno-63-116" href="#__codelineno-63-116"></a><span class="sd">        Tokenize SMILES string into characters</span>
</span><span id="__span-63-117"><a id="__codelineno-63-117" name="__codelineno-63-117" href="#__codelineno-63-117"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-63-118"><a id="__codelineno-63-118" name="__codelineno-63-118" href="#__codelineno-63-118"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-63-119"><a id="__codelineno-63-119" name="__codelineno-63-119" href="#__codelineno-63-119"></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-63-120"><a id="__codelineno-63-120" name="__codelineno-63-120" href="#__codelineno-63-120"></a>        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
</span><span id="__span-63-121"><a id="__codelineno-63-121" name="__codelineno-63-121" href="#__codelineno-63-121"></a>            <span class="c1"># Check for two-character tokens (Cl, Br, @@)</span>
</span><span id="__span-63-122"><a id="__codelineno-63-122" name="__codelineno-63-122" href="#__codelineno-63-122"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-63-123"><a id="__codelineno-63-123" name="__codelineno-63-123" href="#__codelineno-63-123"></a>                <span class="n">two_char</span> <span class="o">=</span> <span class="n">smiles</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-63-124"><a id="__codelineno-63-124" name="__codelineno-63-124" href="#__codelineno-63-124"></a>                <span class="k">if</span> <span class="n">two_char</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
</span><span id="__span-63-125"><a id="__codelineno-63-125" name="__codelineno-63-125" href="#__codelineno-63-125"></a>                    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">two_char</span><span class="p">)</span>
</span><span id="__span-63-126"><a id="__codelineno-63-126" name="__codelineno-63-126" href="#__codelineno-63-126"></a>                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
</span><span id="__span-63-127"><a id="__codelineno-63-127" name="__codelineno-63-127" href="#__codelineno-63-127"></a>                    <span class="k">continue</span>
</span><span id="__span-63-128"><a id="__codelineno-63-128" name="__codelineno-63-128" href="#__codelineno-63-128"></a>
</span><span id="__span-63-129"><a id="__codelineno-63-129" name="__codelineno-63-129" href="#__codelineno-63-129"></a>            <span class="c1"># Single character token</span>
</span><span id="__span-63-130"><a id="__codelineno-63-130" name="__codelineno-63-130" href="#__codelineno-63-130"></a>            <span class="n">token</span> <span class="o">=</span> <span class="n">smiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="__span-63-131"><a id="__codelineno-63-131" name="__codelineno-63-131" href="#__codelineno-63-131"></a>            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="k">else</span> <span class="s1">&#39;&lt;UNK&gt;&#39;</span><span class="p">)</span>
</span><span id="__span-63-132"><a id="__codelineno-63-132" name="__codelineno-63-132" href="#__codelineno-63-132"></a>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-63-133"><a id="__codelineno-63-133" name="__codelineno-63-133" href="#__codelineno-63-133"></a>
</span><span id="__span-63-134"><a id="__codelineno-63-134" name="__codelineno-63-134" href="#__codelineno-63-134"></a>        <span class="k">return</span> <span class="n">tokens</span>
</span><span id="__span-63-135"><a id="__codelineno-63-135" name="__codelineno-63-135" href="#__codelineno-63-135"></a>
</span><span id="__span-63-136"><a id="__codelineno-63-136" name="__codelineno-63-136" href="#__codelineno-63-136"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="__span-63-137"><a id="__codelineno-63-137" name="__codelineno-63-137" href="#__codelineno-63-137"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-63-138"><a id="__codelineno-63-138" name="__codelineno-63-138" href="#__codelineno-63-138"></a><span class="sd">        Convert SMILES to integer sequence</span>
</span><span id="__span-63-139"><a id="__codelineno-63-139" name="__codelineno-63-139" href="#__codelineno-63-139"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-63-140"><a id="__codelineno-63-140" name="__codelineno-63-140" href="#__codelineno-63-140"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-63-141"><a id="__codelineno-63-141" name="__codelineno-63-141" href="#__codelineno-63-141"></a>
</span><span id="__span-63-142"><a id="__codelineno-63-142" name="__codelineno-63-142" href="#__codelineno-63-142"></a>        <span class="c1"># Convert to indices</span>
</span><span id="__span-63-143"><a id="__codelineno-63-143" name="__codelineno-63-143" href="#__codelineno-63-143"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
</span><span id="__span-63-144"><a id="__codelineno-63-144" name="__codelineno-63-144" href="#__codelineno-63-144"></a>
</span><span id="__span-63-145"><a id="__codelineno-63-145" name="__codelineno-63-145" href="#__codelineno-63-145"></a>        <span class="c1"># Pad or truncate</span>
</span><span id="__span-63-146"><a id="__codelineno-63-146" name="__codelineno-63-146" href="#__codelineno-63-146"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
</span><span id="__span-63-147"><a id="__codelineno-63-147" name="__codelineno-63-147" href="#__codelineno-63-147"></a>            <span class="n">indices</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
</span><span id="__span-63-148"><a id="__codelineno-63-148" name="__codelineno-63-148" href="#__codelineno-63-148"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-63-149"><a id="__codelineno-63-149" name="__codelineno-63-149" href="#__codelineno-63-149"></a>            <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>
</span><span id="__span-63-150"><a id="__codelineno-63-150" name="__codelineno-63-150" href="#__codelineno-63-150"></a>
</span><span id="__span-63-151"><a id="__codelineno-63-151" name="__codelineno-63-151" href="#__codelineno-63-151"></a>        <span class="k">return</span> <span class="n">indices</span>
</span><span id="__span-63-152"><a id="__codelineno-63-152" name="__codelineno-63-152" href="#__codelineno-63-152"></a>
</span><span id="__span-63-153"><a id="__codelineno-63-153" name="__codelineno-63-153" href="#__codelineno-63-153"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batch_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="__span-63-154"><a id="__codelineno-63-154" name="__codelineno-63-154" href="#__codelineno-63-154"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-63-155"><a id="__codelineno-63-155" name="__codelineno-63-155" href="#__codelineno-63-155"></a><span class="sd">        Encode batch of SMILES strings</span>
</span><span id="__span-63-156"><a id="__codelineno-63-156" name="__codelineno-63-156" href="#__codelineno-63-156"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-63-157"><a id="__codelineno-63-157" name="__codelineno-63-157" href="#__codelineno-63-157"></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">max_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">smiles_list</span><span class="p">]</span>
</span><span id="__span-63-158"><a id="__codelineno-63-158" name="__codelineno-63-158" href="#__codelineno-63-158"></a>
</span><span id="__span-63-159"><a id="__codelineno-63-159" name="__codelineno-63-159" href="#__codelineno-63-159"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-63-160"><a id="__codelineno-63-160" name="__codelineno-63-160" href="#__codelineno-63-160"></a><span class="c1"># Dataset and Training</span>
</span><span id="__span-63-161"><a id="__codelineno-63-161" name="__codelineno-63-161" href="#__codelineno-63-161"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-63-162"><a id="__codelineno-63-162" name="__codelineno-63-162" href="#__codelineno-63-162"></a>
</span><span id="__span-63-163"><a id="__codelineno-63-163" name="__codelineno-63-163" href="#__codelineno-63-163"></a><span class="k">class</span><span class="w"> </span><span class="nc">SMILES_Dataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="__span-63-164"><a id="__codelineno-63-164" name="__codelineno-63-164" href="#__codelineno-63-164"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-63-165"><a id="__codelineno-63-165" name="__codelineno-63-165" href="#__codelineno-63-165"></a><span class="sd">    Dataset for SMILES strings</span>
</span><span id="__span-63-166"><a id="__codelineno-63-166" name="__codelineno-63-166" href="#__codelineno-63-166"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-63-167"><a id="__codelineno-63-167" name="__codelineno-63-167" href="#__codelineno-63-167"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="__span-63-168"><a id="__codelineno-63-168" name="__codelineno-63-168" href="#__codelineno-63-168"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</span><span id="__span-63-169"><a id="__codelineno-63-169" name="__codelineno-63-169" href="#__codelineno-63-169"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoded_smiles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-63-170"><a id="__codelineno-63-170" name="__codelineno-63-170" href="#__codelineno-63-170"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-63-171"><a id="__codelineno-63-171" name="__codelineno-63-171" href="#__codelineno-63-171"></a>
</span><span id="__span-63-172"><a id="__codelineno-63-172" name="__codelineno-63-172" href="#__codelineno-63-172"></a>        <span class="k">for</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span><span id="__span-63-173"><a id="__codelineno-63-173" name="__codelineno-63-173" href="#__codelineno-63-173"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-63-174"><a id="__codelineno-63-174" name="__codelineno-63-174" href="#__codelineno-63-174"></a>                <span class="n">encoded</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">max_length</span><span class="p">))</span>
</span><span id="__span-63-175"><a id="__codelineno-63-175" name="__codelineno-63-175" href="#__codelineno-63-175"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoded_smiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
</span><span id="__span-63-176"><a id="__codelineno-63-176" name="__codelineno-63-176" href="#__codelineno-63-176"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="__span-63-177"><a id="__codelineno-63-177" name="__codelineno-63-177" href="#__codelineno-63-177"></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="__span-63-178"><a id="__codelineno-63-178" name="__codelineno-63-178" href="#__codelineno-63-178"></a>                <span class="k">continue</span>
</span><span id="__span-63-179"><a id="__codelineno-63-179" name="__codelineno-63-179" href="#__codelineno-63-179"></a>
</span><span id="__span-63-180"><a id="__codelineno-63-180" name="__codelineno-63-180" href="#__codelineno-63-180"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-63-181"><a id="__codelineno-63-181" name="__codelineno-63-181" href="#__codelineno-63-181"></a>
</span><span id="__span-63-182"><a id="__codelineno-63-182" name="__codelineno-63-182" href="#__codelineno-63-182"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-63-183"><a id="__codelineno-63-183" name="__codelineno-63-183" href="#__codelineno-63-183"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoded_smiles</span><span class="p">)</span>
</span><span id="__span-63-184"><a id="__codelineno-63-184" name="__codelineno-63-184" href="#__codelineno-63-184"></a>
</span><span id="__span-63-185"><a id="__codelineno-63-185" name="__codelineno-63-185" href="#__codelineno-63-185"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="__span-63-186"><a id="__codelineno-63-186" name="__codelineno-63-186" href="#__codelineno-63-186"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoded_smiles</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="__span-63-187"><a id="__codelineno-63-187" name="__codelineno-63-187" href="#__codelineno-63-187"></a>
</span><span id="__span-63-188"><a id="__codelineno-63-188" name="__codelineno-63-188" href="#__codelineno-63-188"></a><span class="c1"># Example usage</span>
</span><span id="__span-63-189"><a id="__codelineno-63-189" name="__codelineno-63-189" href="#__codelineno-63-189"></a><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SMILESTokenizer</span><span class="p">()</span>
</span><span id="__span-63-190"><a id="__codelineno-63-190" name="__codelineno-63-190" href="#__codelineno-63-190"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocabulary size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-63-191"><a id="__codelineno-63-191" name="__codelineno-63-191" href="#__codelineno-63-191"></a>
</span><span id="__span-63-192"><a id="__codelineno-63-192" name="__codelineno-63-192" href="#__codelineno-63-192"></a><span class="c1"># Create model</span>
</span><span id="__span-63-193"><a id="__codelineno-63-193" name="__codelineno-63-193" href="#__codelineno-63-193"></a><span class="n">model</span> <span class="o">=</span> <span class="n">SMILES_CNN</span><span class="p">(</span>
</span><span id="__span-63-194"><a id="__codelineno-63-194" name="__codelineno-63-194" href="#__codelineno-63-194"></a>    <span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">),</span>
</span><span id="__span-63-195"><a id="__codelineno-63-195" name="__codelineno-63-195" href="#__codelineno-63-195"></a>    <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="__span-63-196"><a id="__codelineno-63-196" name="__codelineno-63-196" href="#__codelineno-63-196"></a>    <span class="n">num_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="__span-63-197"><a id="__codelineno-63-197" name="__codelineno-63-197" href="#__codelineno-63-197"></a>    <span class="n">filter_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
</span><span id="__span-63-198"><a id="__codelineno-63-198" name="__codelineno-63-198" href="#__codelineno-63-198"></a>    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
</span><span id="__span-63-199"><a id="__codelineno-63-199" name="__codelineno-63-199" href="#__codelineno-63-199"></a>    <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-63-200"><a id="__codelineno-63-200" name="__codelineno-63-200" href="#__codelineno-63-200"></a>    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span>
</span><span id="__span-63-201"><a id="__codelineno-63-201" name="__codelineno-63-201" href="#__codelineno-63-201"></a><span class="p">)</span>
</span><span id="__span-63-202"><a id="__codelineno-63-202" name="__codelineno-63-202" href="#__codelineno-63-202"></a>
</span><span id="__span-63-203"><a id="__codelineno-63-203" name="__codelineno-63-203" href="#__codelineno-63-203"></a><span class="c1"># Create dataset</span>
</span><span id="__span-63-204"><a id="__codelineno-63-204" name="__codelineno-63-204" href="#__codelineno-63-204"></a><span class="n">smiles_train</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CCO&quot;</span><span class="p">,</span> <span class="s2">&quot;CC(C)O&quot;</span><span class="p">,</span> <span class="s2">&quot;CCCO&quot;</span><span class="p">,</span> <span class="s2">&quot;CC(C)CO&quot;</span><span class="p">]</span>  <span class="c1"># Example SMILES</span>
</span><span id="__span-63-205"><a id="__codelineno-63-205" name="__codelineno-63-205" href="#__codelineno-63-205"></a><span class="n">labels_train</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">]</span>  <span class="c1"># Example labels</span>
</span><span id="__span-63-206"><a id="__codelineno-63-206" name="__codelineno-63-206" href="#__codelineno-63-206"></a>
</span><span id="__span-63-207"><a id="__codelineno-63-207" name="__codelineno-63-207" href="#__codelineno-63-207"></a><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">SMILES_Dataset</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">labels_train</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-63-208"><a id="__codelineno-63-208" name="__codelineno-63-208" href="#__codelineno-63-208"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-63-209"><a id="__codelineno-63-209" name="__codelineno-63-209" href="#__codelineno-63-209"></a>
</span><span id="__span-63-210"><a id="__codelineno-63-210" name="__codelineno-63-210" href="#__codelineno-63-210"></a><span class="c1"># Training loop (similar to previous examples)</span>
</span><span id="__span-63-211"><a id="__codelineno-63-211" name="__codelineno-63-211" href="#__codelineno-63-211"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-63-212"><a id="__codelineno-63-212" name="__codelineno-63-212" href="#__codelineno-63-212"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-63-213"><a id="__codelineno-63-213" name="__codelineno-63-213" href="#__codelineno-63-213"></a>
</span><span id="__span-63-214"><a id="__codelineno-63-214" name="__codelineno-63-214" href="#__codelineno-63-214"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
</span><span id="__span-63-215"><a id="__codelineno-63-215" name="__codelineno-63-215" href="#__codelineno-63-215"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-63-216"><a id="__codelineno-63-216" name="__codelineno-63-216" href="#__codelineno-63-216"></a>    <span class="k">for</span> <span class="n">batch_smiles</span><span class="p">,</span> <span class="n">batch_labels</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
</span><span id="__span-63-217"><a id="__codelineno-63-217" name="__codelineno-63-217" href="#__codelineno-63-217"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-63-218"><a id="__codelineno-63-218" name="__codelineno-63-218" href="#__codelineno-63-218"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_smiles</span><span class="p">)</span>
</span><span id="__span-63-219"><a id="__codelineno-63-219" name="__codelineno-63-219" href="#__codelineno-63-219"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_labels</span><span class="p">)</span>
</span><span id="__span-63-220"><a id="__codelineno-63-220" name="__codelineno-63-220" href="#__codelineno-63-220"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-63-221"><a id="__codelineno-63-221" name="__codelineno-63-221" href="#__codelineno-63-221"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></code></pre></div>
<p><strong>Key Design Choices:</strong></p>
<ol>
<li><strong>Multiple Filter Sizes</strong>: Capture patterns of different lengths (3=short, 5=medium, 7=long functional groups)</li>
<li><strong>Embedding Layer</strong>: Learn distributed representations of SMILES characters</li>
<li><strong>Max Pooling</strong>: Extract most important features regardless of position</li>
<li><strong>Concatenation</strong>: Combine features from different filter sizes</li>
</ol>
<h3 id="42__2d__cnns__for__molecular__images">4.2 2D CNNs for Molecular Images<a class="headerlink" href="#42__2d__cnns__for__molecular__images" title="Permanent link">&para;</a></h3>
<p>Molecules can be represented as 2D images (chemical structure diagrams) or as heatmaps of molecular properties.</p>
<p><strong>Image Representation Approaches:</strong></p>
<ol>
<li><strong>Chemical Structure Diagrams</strong>: Rendered 2D molecular structures</li>
<li><strong>3D Conformer Projections</strong>: 2D projections of 3D molecular conformations</li>
<li><strong>Property Heatmaps</strong>: Grids showing electrostatic potential, electron density, etc.</li>
</ol>
<p><strong>Implementation:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">models</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Molecular2DCNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="sd">    2D CNN for molecular images</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="sd">        Args:</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="sd">            num_classes: Number of output classes/values</span>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="sd">            pretrained: Whether to use pretrained ImageNet weights</span>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Molecular2DCNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-64-16"><a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a>
</span><span id="__span-64-17"><a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a>        <span class="c1"># Option 1: Custom CNN architecture</span>
</span><span id="__span-64-18"><a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-64-19"><a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a>            <span class="c1"># First conv block</span>
</span><span id="__span-64-20"><a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="__span-64-21"><a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
</span><span id="__span-64-22"><a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-64-23"><a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="__span-64-24"><a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a>
</span><span id="__span-64-25"><a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a>            <span class="c1"># Second conv block</span>
</span><span id="__span-64-26"><a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="__span-64-27"><a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
</span><span id="__span-64-28"><a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-64-29"><a id="__codelineno-64-29" name="__codelineno-64-29" href="#__codelineno-64-29"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="__span-64-30"><a id="__codelineno-64-30" name="__codelineno-64-30" href="#__codelineno-64-30"></a>
</span><span id="__span-64-31"><a id="__codelineno-64-31" name="__codelineno-64-31" href="#__codelineno-64-31"></a>            <span class="c1"># Third conv block</span>
</span><span id="__span-64-32"><a id="__codelineno-64-32" name="__codelineno-64-32" href="#__codelineno-64-32"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="__span-64-33"><a id="__codelineno-64-33" name="__codelineno-64-33" href="#__codelineno-64-33"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
</span><span id="__span-64-34"><a id="__codelineno-64-34" name="__codelineno-64-34" href="#__codelineno-64-34"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-64-35"><a id="__codelineno-64-35" name="__codelineno-64-35" href="#__codelineno-64-35"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="__span-64-36"><a id="__codelineno-64-36" name="__codelineno-64-36" href="#__codelineno-64-36"></a>
</span><span id="__span-64-37"><a id="__codelineno-64-37" name="__codelineno-64-37" href="#__codelineno-64-37"></a>            <span class="c1"># Fourth conv block</span>
</span><span id="__span-64-38"><a id="__codelineno-64-38" name="__codelineno-64-38" href="#__codelineno-64-38"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span><span id="__span-64-39"><a id="__codelineno-64-39" name="__codelineno-64-39" href="#__codelineno-64-39"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span><span id="__span-64-40"><a id="__codelineno-64-40" name="__codelineno-64-40" href="#__codelineno-64-40"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-64-41"><a id="__codelineno-64-41" name="__codelineno-64-41" href="#__codelineno-64-41"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-64-42"><a id="__codelineno-64-42" name="__codelineno-64-42" href="#__codelineno-64-42"></a>        <span class="p">)</span>
</span><span id="__span-64-43"><a id="__codelineno-64-43" name="__codelineno-64-43" href="#__codelineno-64-43"></a>
</span><span id="__span-64-44"><a id="__codelineno-64-44" name="__codelineno-64-44" href="#__codelineno-64-44"></a>        <span class="c1"># Fully connected layers</span>
</span><span id="__span-64-45"><a id="__codelineno-64-45" name="__codelineno-64-45" href="#__codelineno-64-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-64-46"><a id="__codelineno-64-46" name="__codelineno-64-46" href="#__codelineno-64-46"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">14</span> <span class="o">*</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>  <span class="c1"># Assuming 224x224 input</span>
</span><span id="__span-64-47"><a id="__codelineno-64-47" name="__codelineno-64-47" href="#__codelineno-64-47"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-64-48"><a id="__codelineno-64-48" name="__codelineno-64-48" href="#__codelineno-64-48"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
</span><span id="__span-64-49"><a id="__codelineno-64-49" name="__codelineno-64-49" href="#__codelineno-64-49"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
</span><span id="__span-64-50"><a id="__codelineno-64-50" name="__codelineno-64-50" href="#__codelineno-64-50"></a>        <span class="p">)</span>
</span><span id="__span-64-51"><a id="__codelineno-64-51" name="__codelineno-64-51" href="#__codelineno-64-51"></a>
</span><span id="__span-64-52"><a id="__codelineno-64-52" name="__codelineno-64-52" href="#__codelineno-64-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-64-53"><a id="__codelineno-64-53" name="__codelineno-64-53" href="#__codelineno-64-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-64-54"><a id="__codelineno-64-54" name="__codelineno-64-54" href="#__codelineno-64-54"></a><span class="sd">        Args:</span>
</span><span id="__span-64-55"><a id="__codelineno-64-55" name="__codelineno-64-55" href="#__codelineno-64-55"></a><span class="sd">            x: Input images of shape (batch_size, 3, 224, 224)</span>
</span><span id="__span-64-56"><a id="__codelineno-64-56" name="__codelineno-64-56" href="#__codelineno-64-56"></a>
</span><span id="__span-64-57"><a id="__codelineno-64-57" name="__codelineno-64-57" href="#__codelineno-64-57"></a><span class="sd">        Returns:</span>
</span><span id="__span-64-58"><a id="__codelineno-64-58" name="__codelineno-64-58" href="#__codelineno-64-58"></a><span class="sd">            Output predictions of shape (batch_size, num_classes)</span>
</span><span id="__span-64-59"><a id="__codelineno-64-59" name="__codelineno-64-59" href="#__codelineno-64-59"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-64-60"><a id="__codelineno-64-60" name="__codelineno-64-60" href="#__codelineno-64-60"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_layers</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-64-61"><a id="__codelineno-64-61" name="__codelineno-64-61" href="#__codelineno-64-61"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Flatten</span>
</span><span id="__span-64-62"><a id="__codelineno-64-62" name="__codelineno-64-62" href="#__codelineno-64-62"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_layers</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-64-63"><a id="__codelineno-64-63" name="__codelineno-64-63" href="#__codelineno-64-63"></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="__span-64-64"><a id="__codelineno-64-64" name="__codelineno-64-64" href="#__codelineno-64-64"></a>
</span><span id="__span-64-65"><a id="__codelineno-64-65" name="__codelineno-64-65" href="#__codelineno-64-65"></a><span class="k">class</span><span class="w"> </span><span class="nc">MolecularResNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-64-66"><a id="__codelineno-64-66" name="__codelineno-64-66" href="#__codelineno-64-66"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-64-67"><a id="__codelineno-64-67" name="__codelineno-64-67" href="#__codelineno-64-67"></a><span class="sd">    ResNet-based model for molecular images (transfer learning)</span>
</span><span id="__span-64-68"><a id="__codelineno-64-68" name="__codelineno-64-68" href="#__codelineno-64-68"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-64-69"><a id="__codelineno-64-69" name="__codelineno-64-69" href="#__codelineno-64-69"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-64-70"><a id="__codelineno-64-70" name="__codelineno-64-70" href="#__codelineno-64-70"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MolecularResNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-64-71"><a id="__codelineno-64-71" name="__codelineno-64-71" href="#__codelineno-64-71"></a>
</span><span id="__span-64-72"><a id="__codelineno-64-72" name="__codelineno-64-72" href="#__codelineno-64-72"></a>        <span class="c1"># Load pretrained ResNet</span>
</span><span id="__span-64-73"><a id="__codelineno-64-73" name="__codelineno-64-73" href="#__codelineno-64-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet50</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="n">pretrained</span><span class="p">)</span>
</span><span id="__span-64-74"><a id="__codelineno-64-74" name="__codelineno-64-74" href="#__codelineno-64-74"></a>
</span><span id="__span-64-75"><a id="__codelineno-64-75" name="__codelineno-64-75" href="#__codelineno-64-75"></a>        <span class="c1"># Replace final layer</span>
</span><span id="__span-64-76"><a id="__codelineno-64-76" name="__codelineno-64-76" href="#__codelineno-64-76"></a>        <span class="n">num_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">fc</span><span class="o">.</span><span class="n">in_features</span>
</span><span id="__span-64-77"><a id="__codelineno-64-77" name="__codelineno-64-77" href="#__codelineno-64-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_features</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
</span><span id="__span-64-78"><a id="__codelineno-64-78" name="__codelineno-64-78" href="#__codelineno-64-78"></a>
</span><span id="__span-64-79"><a id="__codelineno-64-79" name="__codelineno-64-79" href="#__codelineno-64-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-64-80"><a id="__codelineno-64-80" name="__codelineno-64-80" href="#__codelineno-64-80"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-64-81"><a id="__codelineno-64-81" name="__codelineno-64-81" href="#__codelineno-64-81"></a>
</span><span id="__span-64-82"><a id="__codelineno-64-82" name="__codelineno-64-82" href="#__codelineno-64-82"></a><span class="c1"># Generate molecular images from SMILES</span>
</span><span id="__span-64-83"><a id="__codelineno-64-83" name="__codelineno-64-83" href="#__codelineno-64-83"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
</span><span id="__span-64-84"><a id="__codelineno-64-84" name="__codelineno-64-84" href="#__codelineno-64-84"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Draw</span>
</span><span id="__span-64-85"><a id="__codelineno-64-85" name="__codelineno-64-85" href="#__codelineno-64-85"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
</span><span id="__span-64-86"><a id="__codelineno-64-86" name="__codelineno-64-86" href="#__codelineno-64-86"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
</span><span id="__span-64-87"><a id="__codelineno-64-87" name="__codelineno-64-87" href="#__codelineno-64-87"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-64-88"><a id="__codelineno-64-88" name="__codelineno-64-88" href="#__codelineno-64-88"></a>
</span><span id="__span-64-89"><a id="__codelineno-64-89" name="__codelineno-64-89" href="#__codelineno-64-89"></a><span class="k">def</span><span class="w"> </span><span class="nf">smiles_to_image</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)):</span>
</span><span id="__span-64-90"><a id="__codelineno-64-90" name="__codelineno-64-90" href="#__codelineno-64-90"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-64-91"><a id="__codelineno-64-91" name="__codelineno-64-91" href="#__codelineno-64-91"></a><span class="sd">    Convert SMILES to image</span>
</span><span id="__span-64-92"><a id="__codelineno-64-92" name="__codelineno-64-92" href="#__codelineno-64-92"></a>
</span><span id="__span-64-93"><a id="__codelineno-64-93" name="__codelineno-64-93" href="#__codelineno-64-93"></a><span class="sd">    Args:</span>
</span><span id="__span-64-94"><a id="__codelineno-64-94" name="__codelineno-64-94" href="#__codelineno-64-94"></a><span class="sd">        smiles: SMILES string</span>
</span><span id="__span-64-95"><a id="__codelineno-64-95" name="__codelineno-64-95" href="#__codelineno-64-95"></a><span class="sd">        size: Image size (width, height)</span>
</span><span id="__span-64-96"><a id="__codelineno-64-96" name="__codelineno-64-96" href="#__codelineno-64-96"></a>
</span><span id="__span-64-97"><a id="__codelineno-64-97" name="__codelineno-64-97" href="#__codelineno-64-97"></a><span class="sd">    Returns:</span>
</span><span id="__span-64-98"><a id="__codelineno-64-98" name="__codelineno-64-98" href="#__codelineno-64-98"></a><span class="sd">        numpy array of shape (3, height, width)</span>
</span><span id="__span-64-99"><a id="__codelineno-64-99" name="__codelineno-64-99" href="#__codelineno-64-99"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-64-100"><a id="__codelineno-64-100" name="__codelineno-64-100" href="#__codelineno-64-100"></a>    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-64-101"><a id="__codelineno-64-101" name="__codelineno-64-101" href="#__codelineno-64-101"></a>    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-64-102"><a id="__codelineno-64-102" name="__codelineno-64-102" href="#__codelineno-64-102"></a>        <span class="c1"># Return blank image if invalid SMILES</span>
</span><span id="__span-64-103"><a id="__codelineno-64-103" name="__codelineno-64-103" href="#__codelineno-64-103"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="__span-64-104"><a id="__codelineno-64-104" name="__codelineno-64-104" href="#__codelineno-64-104"></a>
</span><span id="__span-64-105"><a id="__codelineno-64-105" name="__codelineno-64-105" href="#__codelineno-64-105"></a>    <span class="c1"># Draw molecule</span>
</span><span id="__span-64-106"><a id="__codelineno-64-106" name="__codelineno-64-106" href="#__codelineno-64-106"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolToImage</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-64-107"><a id="__codelineno-64-107" name="__codelineno-64-107" href="#__codelineno-64-107"></a>
</span><span id="__span-64-108"><a id="__codelineno-64-108" name="__codelineno-64-108" href="#__codelineno-64-108"></a>    <span class="c1"># Convert to numpy array</span>
</span><span id="__span-64-109"><a id="__codelineno-64-109" name="__codelineno-64-109" href="#__codelineno-64-109"></a>    <span class="n">img_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="__span-64-110"><a id="__codelineno-64-110" name="__codelineno-64-110" href="#__codelineno-64-110"></a>
</span><span id="__span-64-111"><a id="__codelineno-64-111" name="__codelineno-64-111" href="#__codelineno-64-111"></a>    <span class="c1"># Convert to (C, H, W) format</span>
</span><span id="__span-64-112"><a id="__codelineno-64-112" name="__codelineno-64-112" href="#__codelineno-64-112"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Grayscale</span>
</span><span id="__span-64-113"><a id="__codelineno-64-113" name="__codelineno-64-113" href="#__codelineno-64-113"></a>        <span class="n">img_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">img_array</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-64-114"><a id="__codelineno-64-114" name="__codelineno-64-114" href="#__codelineno-64-114"></a>    <span class="k">else</span><span class="p">:</span>  <span class="c1"># RGB</span>
</span><span id="__span-64-115"><a id="__codelineno-64-115" name="__codelineno-64-115" href="#__codelineno-64-115"></a>        <span class="n">img_array</span> <span class="o">=</span> <span class="n">img_array</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-64-116"><a id="__codelineno-64-116" name="__codelineno-64-116" href="#__codelineno-64-116"></a>
</span><span id="__span-64-117"><a id="__codelineno-64-117" name="__codelineno-64-117" href="#__codelineno-64-117"></a>    <span class="k">return</span> <span class="n">img_array</span> <span class="o">/</span> <span class="mf">255.0</span>  <span class="c1"># Normalize to [0, 1]</span>
</span><span id="__span-64-118"><a id="__codelineno-64-118" name="__codelineno-64-118" href="#__codelineno-64-118"></a>
</span><span id="__span-64-119"><a id="__codelineno-64-119" name="__codelineno-64-119" href="#__codelineno-64-119"></a><span class="k">class</span><span class="w"> </span><span class="nc">MolecularImageDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="__span-64-120"><a id="__codelineno-64-120" name="__codelineno-64-120" href="#__codelineno-64-120"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-64-121"><a id="__codelineno-64-121" name="__codelineno-64-121" href="#__codelineno-64-121"></a><span class="sd">    Dataset for molecular images</span>
</span><span id="__span-64-122"><a id="__codelineno-64-122" name="__codelineno-64-122" href="#__codelineno-64-122"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-64-123"><a id="__codelineno-64-123" name="__codelineno-64-123" href="#__codelineno-64-123"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)):</span>
</span><span id="__span-64-124"><a id="__codelineno-64-124" name="__codelineno-64-124" href="#__codelineno-64-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-64-125"><a id="__codelineno-64-125" name="__codelineno-64-125" href="#__codelineno-64-125"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-64-126"><a id="__codelineno-64-126" name="__codelineno-64-126" href="#__codelineno-64-126"></a>
</span><span id="__span-64-127"><a id="__codelineno-64-127" name="__codelineno-64-127" href="#__codelineno-64-127"></a>        <span class="k">for</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span><span id="__span-64-128"><a id="__codelineno-64-128" name="__codelineno-64-128" href="#__codelineno-64-128"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">smiles_to_image</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span id="__span-64-129"><a id="__codelineno-64-129" name="__codelineno-64-129" href="#__codelineno-64-129"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
</span><span id="__span-64-130"><a id="__codelineno-64-130" name="__codelineno-64-130" href="#__codelineno-64-130"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="__span-64-131"><a id="__codelineno-64-131" name="__codelineno-64-131" href="#__codelineno-64-131"></a>
</span><span id="__span-64-132"><a id="__codelineno-64-132" name="__codelineno-64-132" href="#__codelineno-64-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-64-133"><a id="__codelineno-64-133" name="__codelineno-64-133" href="#__codelineno-64-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="__span-64-134"><a id="__codelineno-64-134" name="__codelineno-64-134" href="#__codelineno-64-134"></a>
</span><span id="__span-64-135"><a id="__codelineno-64-135" name="__codelineno-64-135" href="#__codelineno-64-135"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-64-136"><a id="__codelineno-64-136" name="__codelineno-64-136" href="#__codelineno-64-136"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
</span><span id="__span-64-137"><a id="__codelineno-64-137" name="__codelineno-64-137" href="#__codelineno-64-137"></a>
</span><span id="__span-64-138"><a id="__codelineno-64-138" name="__codelineno-64-138" href="#__codelineno-64-138"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="__span-64-139"><a id="__codelineno-64-139" name="__codelineno-64-139" href="#__codelineno-64-139"></a>        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="__span-64-140"><a id="__codelineno-64-140" name="__codelineno-64-140" href="#__codelineno-64-140"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="__span-64-141"><a id="__codelineno-64-141" name="__codelineno-64-141" href="#__codelineno-64-141"></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-64-142"><a id="__codelineno-64-142" name="__codelineno-64-142" href="#__codelineno-64-142"></a>        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span></code></pre></div>
<h3 id="43__when__to__use__each__approach">4.3 When to Use Each Approach<a class="headerlink" href="#43__when__to__use__each__approach" title="Permanent link">&para;</a></h3>
<p><strong>Comparison Table:</strong></p>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Best For</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>1D CNN on SMILES</strong></td>
<td>- Sequence patterns<br>- Functional groups<br>- Large datasets</td>
<td>- Fast training<br>- No molecular rendering<br>- Handles variable length</td>
<td>- Limited spatial info<br>- SMILES representation bias</td>
</tr>
<tr>
<td><strong>2D CNN on Images</strong></td>
<td>- Spatial relationships<br>- Stereochemistry<br>- Visual patterns</td>
<td>- Captures 2D structure<br>- Transfer learning from ImageNet<br>- Interpretable</td>
<td>- Slow image generation<br>- Fixed size input<br>- Loss of 3D info</td>
</tr>
<tr>
<td><strong>Graph Neural Networks</strong></td>
<td>- Atom/bond relationships<br>- 3D structure<br>- Small molecules</td>
<td>- Natural molecular representation<br>- Permutation invariant<br>- Interpretable</td>
<td>- More complex implementation<br>- (Covered in Day 3)</td>
</tr>
</tbody>
</table>
<p><strong>Decision Guide:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>START
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>  ├─ Need fast training? → 1D CNN on SMILES
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>  ├─ Have molecular images? → 2D CNN
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>  ├─ 3D structure important? → GNN (Day 3)
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>  ├─ Sequence patterns important? → 1D CNN or RNN
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>  └─ Spatial relationships important? → 2D CNN or GNN
</span></code></pre></div>
<p><strong>Example Use Cases:</strong></p>
<p><strong>Use 1D CNN on SMILES:</strong>
- Toxicity prediction (functional group patterns)
- Synthetic accessibility (molecular complexity)
- Quick property screening</p>
<p><strong>Use 2D CNN on Images:</strong>
- Structure-activity relationship visualization
- Similarity search with visual features
- Transfer learning from chemical structure databases</p>
<p><strong>Hybrid Approach:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">HybridMolecularModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="sd">    Combine 1D CNN (SMILES) and 2D CNN (images) for robust predictions</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">):</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">HybridMolecularModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>        <span class="c1"># 1D CNN branch for SMILES</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">smiles_cnn</span> <span class="o">=</span> <span class="n">SMILES_CNN</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>        <span class="c1"># 2D CNN branch for images</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_cnn</span> <span class="o">=</span> <span class="n">Molecular2DCNN</span><span class="p">()</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>        <span class="c1"># Fusion layer</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Combine predictions</span>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">images</span><span class="p">):</span>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a><span class="sd">        Args:</span>
</span><span id="__span-66-20"><a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a><span class="sd">            smiles: Encoded SMILES (batch_size, max_length)</span>
</span><span id="__span-66-21"><a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a><span class="sd">            images: Molecular images (batch_size, 3, 224, 224)</span>
</span><span id="__span-66-22"><a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a>
</span><span id="__span-66-23"><a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a><span class="sd">        Returns:</span>
</span><span id="__span-66-24"><a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a><span class="sd">            Combined predictions</span>
</span><span id="__span-66-25"><a id="__codelineno-66-25" name="__codelineno-66-25" href="#__codelineno-66-25"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-66-26"><a id="__codelineno-66-26" name="__codelineno-66-26" href="#__codelineno-66-26"></a>        <span class="n">smiles_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles_cnn</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-66-27"><a id="__codelineno-66-27" name="__codelineno-66-27" href="#__codelineno-66-27"></a>        <span class="n">image_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_cnn</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
</span><span id="__span-66-28"><a id="__codelineno-66-28" name="__codelineno-66-28" href="#__codelineno-66-28"></a>
</span><span id="__span-66-29"><a id="__codelineno-66-29" name="__codelineno-66-29" href="#__codelineno-66-29"></a>        <span class="c1"># Concatenate and fuse</span>
</span><span id="__span-66-30"><a id="__codelineno-66-30" name="__codelineno-66-30" href="#__codelineno-66-30"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">smiles_pred</span><span class="p">,</span> <span class="n">image_pred</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-66-31"><a id="__codelineno-66-31" name="__codelineno-66-31" href="#__codelineno-66-31"></a>        <span class="n">final_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
</span><span id="__span-66-32"><a id="__codelineno-66-32" name="__codelineno-66-32" href="#__codelineno-66-32"></a>
</span><span id="__span-66-33"><a id="__codelineno-66-33" name="__codelineno-66-33" href="#__codelineno-66-33"></a>        <span class="k">return</span> <span class="n">final_pred</span>
</span></code></pre></div>
<hr />
<h2 id="5__recurrent__neural__networks">5. Recurrent Neural Networks<a class="headerlink" href="#5__recurrent__neural__networks" title="Permanent link">&para;</a></h2>
<p>Recurrent Neural Networks (RNNs) process sequential data by maintaining hidden states that capture information from previous time steps. They are ideal for SMILES strings where the order of tokens matters.</p>
<h3 id="51__lstm__for__smiles__sequences">5.1 LSTM for SMILES Sequences<a class="headerlink" href="#51__lstm__for__smiles__sequences" title="Permanent link">&para;</a></h3>
<p>Long Short-Term Memory (LSTM) networks address the vanishing gradient problem in traditional RNNs through gating mechanisms.</p>
<p><strong>LSTM Architecture:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>Input → Embedding → LSTM layers → Final hidden state → Dense → Output
</span></code></pre></div>
<p><strong>Complete Implementation:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">SMILES_LSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="sd">    LSTM model for SMILES-based molecular property prediction</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> 
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>                 <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="sd">        Args:</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="sd">            vocab_size: Size of SMILES vocabulary</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a><span class="sd">            embedding_dim: Dimension of character embeddings</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="sd">            hidden_dim: Size of LSTM hidden state</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="sd">            num_layers: Number of stacked LSTM layers</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="sd">            output_dim: Output size (1 for regression)</span>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="sd">            dropout_rate: Dropout between LSTM layers</span>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a><span class="sd">            bidirectional: Whether to use bidirectional LSTM</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SMILES_LSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>
</span><span id="__span-68-24"><a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional</span> <span class="o">=</span> <span class="n">bidirectional</span>
</span><span id="__span-68-25"><a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a>
</span><span id="__span-68-26"><a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a>        <span class="c1"># Embedding layer</span>
</span><span id="__span-68-27"><a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-68-28"><a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a>
</span><span id="__span-68-29"><a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a>        <span class="c1"># LSTM layers</span>
</span><span id="__span-68-30"><a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
</span><span id="__span-68-31"><a id="__codelineno-68-31" name="__codelineno-68-31" href="#__codelineno-68-31"></a>            <span class="n">input_size</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">,</span>
</span><span id="__span-68-32"><a id="__codelineno-68-32" name="__codelineno-68-32" href="#__codelineno-68-32"></a>            <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span>
</span><span id="__span-68-33"><a id="__codelineno-68-33" name="__codelineno-68-33" href="#__codelineno-68-33"></a>            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
</span><span id="__span-68-34"><a id="__codelineno-68-34" name="__codelineno-68-34" href="#__codelineno-68-34"></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-68-35"><a id="__codelineno-68-35" name="__codelineno-68-35" href="#__codelineno-68-35"></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">dropout_rate</span> <span class="k">if</span> <span class="n">num_layers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-68-36"><a id="__codelineno-68-36" name="__codelineno-68-36" href="#__codelineno-68-36"></a>            <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span>
</span><span id="__span-68-37"><a id="__codelineno-68-37" name="__codelineno-68-37" href="#__codelineno-68-37"></a>        <span class="p">)</span>
</span><span id="__span-68-38"><a id="__codelineno-68-38" name="__codelineno-68-38" href="#__codelineno-68-38"></a>
</span><span id="__span-68-39"><a id="__codelineno-68-39" name="__codelineno-68-39" href="#__codelineno-68-39"></a>        <span class="c1"># Fully connected layers</span>
</span><span id="__span-68-40"><a id="__codelineno-68-40" name="__codelineno-68-40" href="#__codelineno-68-40"></a>        <span class="n">lstm_output_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">bidirectional</span> <span class="k">else</span> <span class="n">hidden_dim</span>
</span><span id="__span-68-41"><a id="__codelineno-68-41" name="__codelineno-68-41" href="#__codelineno-68-41"></a>
</span><span id="__span-68-42"><a id="__codelineno-68-42" name="__codelineno-68-42" href="#__codelineno-68-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-68-43"><a id="__codelineno-68-43" name="__codelineno-68-43" href="#__codelineno-68-43"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">lstm_output_dim</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
</span><span id="__span-68-44"><a id="__codelineno-68-44" name="__codelineno-68-44" href="#__codelineno-68-44"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-68-45"><a id="__codelineno-68-45" name="__codelineno-68-45" href="#__codelineno-68-45"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">),</span>
</span><span id="__span-68-46"><a id="__codelineno-68-46" name="__codelineno-68-46" href="#__codelineno-68-46"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</span><span id="__span-68-47"><a id="__codelineno-68-47" name="__codelineno-68-47" href="#__codelineno-68-47"></a>        <span class="p">)</span>
</span><span id="__span-68-48"><a id="__codelineno-68-48" name="__codelineno-68-48" href="#__codelineno-68-48"></a>
</span><span id="__span-68-49"><a id="__codelineno-68-49" name="__codelineno-68-49" href="#__codelineno-68-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-68-50"><a id="__codelineno-68-50" name="__codelineno-68-50" href="#__codelineno-68-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-68-51"><a id="__codelineno-68-51" name="__codelineno-68-51" href="#__codelineno-68-51"></a><span class="sd">        Args:</span>
</span><span id="__span-68-52"><a id="__codelineno-68-52" name="__codelineno-68-52" href="#__codelineno-68-52"></a><span class="sd">            x: Input tensor of shape (batch_size, sequence_length)</span>
</span><span id="__span-68-53"><a id="__codelineno-68-53" name="__codelineno-68-53" href="#__codelineno-68-53"></a>
</span><span id="__span-68-54"><a id="__codelineno-68-54" name="__codelineno-68-54" href="#__codelineno-68-54"></a><span class="sd">        Returns:</span>
</span><span id="__span-68-55"><a id="__codelineno-68-55" name="__codelineno-68-55" href="#__codelineno-68-55"></a><span class="sd">            Output predictions of shape (batch_size, output_dim)</span>
</span><span id="__span-68-56"><a id="__codelineno-68-56" name="__codelineno-68-56" href="#__codelineno-68-56"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-68-57"><a id="__codelineno-68-57" name="__codelineno-68-57" href="#__codelineno-68-57"></a>        <span class="c1"># Embedding: (batch_size, seq_length) -&gt; (batch_size, seq_length, embedding_dim)</span>
</span><span id="__span-68-58"><a id="__codelineno-68-58" name="__codelineno-68-58" href="#__codelineno-68-58"></a>        <span class="n">embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-68-59"><a id="__codelineno-68-59" name="__codelineno-68-59" href="#__codelineno-68-59"></a>
</span><span id="__span-68-60"><a id="__codelineno-68-60" name="__codelineno-68-60" href="#__codelineno-68-60"></a>        <span class="c1"># LSTM: (batch_size, seq_length, hidden_dim * num_directions)</span>
</span><span id="__span-68-61"><a id="__codelineno-68-61" name="__codelineno-68-61" href="#__codelineno-68-61"></a>        <span class="n">lstm_out</span><span class="p">,</span> <span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">embedded</span><span class="p">)</span>
</span><span id="__span-68-62"><a id="__codelineno-68-62" name="__codelineno-68-62" href="#__codelineno-68-62"></a>
</span><span id="__span-68-63"><a id="__codelineno-68-63" name="__codelineno-68-63" href="#__codelineno-68-63"></a>        <span class="c1"># Use final hidden state</span>
</span><span id="__span-68-64"><a id="__codelineno-68-64" name="__codelineno-68-64" href="#__codelineno-68-64"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">:</span>
</span><span id="__span-68-65"><a id="__codelineno-68-65" name="__codelineno-68-65" href="#__codelineno-68-65"></a>            <span class="c1"># Concatenate forward and backward final hidden states</span>
</span><span id="__span-68-66"><a id="__codelineno-68-66" name="__codelineno-68-66" href="#__codelineno-68-66"></a>            <span class="n">hidden_forward</span> <span class="o">=</span> <span class="n">hidden</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-68-67"><a id="__codelineno-68-67" name="__codelineno-68-67" href="#__codelineno-68-67"></a>            <span class="n">hidden_backward</span> <span class="o">=</span> <span class="n">hidden</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-68-68"><a id="__codelineno-68-68" name="__codelineno-68-68" href="#__codelineno-68-68"></a>            <span class="n">final_hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hidden_forward</span><span class="p">,</span> <span class="n">hidden_backward</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-68-69"><a id="__codelineno-68-69" name="__codelineno-68-69" href="#__codelineno-68-69"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-68-70"><a id="__codelineno-68-70" name="__codelineno-68-70" href="#__codelineno-68-70"></a>            <span class="n">final_hidden</span> <span class="o">=</span> <span class="n">hidden</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-68-71"><a id="__codelineno-68-71" name="__codelineno-68-71" href="#__codelineno-68-71"></a>
</span><span id="__span-68-72"><a id="__codelineno-68-72" name="__codelineno-68-72" href="#__codelineno-68-72"></a>        <span class="c1"># Fully connected layers</span>
</span><span id="__span-68-73"><a id="__codelineno-68-73" name="__codelineno-68-73" href="#__codelineno-68-73"></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">final_hidden</span><span class="p">)</span>
</span><span id="__span-68-74"><a id="__codelineno-68-74" name="__codelineno-68-74" href="#__codelineno-68-74"></a>
</span><span id="__span-68-75"><a id="__codelineno-68-75" name="__codelineno-68-75" href="#__codelineno-68-75"></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="__span-68-76"><a id="__codelineno-68-76" name="__codelineno-68-76" href="#__codelineno-68-76"></a>
</span><span id="__span-68-77"><a id="__codelineno-68-77" name="__codelineno-68-77" href="#__codelineno-68-77"></a><span class="c1"># Create model</span>
</span><span id="__span-68-78"><a id="__codelineno-68-78" name="__codelineno-68-78" href="#__codelineno-68-78"></a><span class="n">model</span> <span class="o">=</span> <span class="n">SMILES_LSTM</span><span class="p">(</span>
</span><span id="__span-68-79"><a id="__codelineno-68-79" name="__codelineno-68-79" href="#__codelineno-68-79"></a>    <span class="n">vocab_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-68-80"><a id="__codelineno-68-80" name="__codelineno-68-80" href="#__codelineno-68-80"></a>    <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="__span-68-81"><a id="__codelineno-68-81" name="__codelineno-68-81" href="#__codelineno-68-81"></a>    <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
</span><span id="__span-68-82"><a id="__codelineno-68-82" name="__codelineno-68-82" href="#__codelineno-68-82"></a>    <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-68-83"><a id="__codelineno-68-83" name="__codelineno-68-83" href="#__codelineno-68-83"></a>    <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-68-84"><a id="__codelineno-68-84" name="__codelineno-68-84" href="#__codelineno-68-84"></a>    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="__span-68-85"><a id="__codelineno-68-85" name="__codelineno-68-85" href="#__codelineno-68-85"></a>    <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-68-86"><a id="__codelineno-68-86" name="__codelineno-68-86" href="#__codelineno-68-86"></a><span class="p">)</span>
</span><span id="__span-68-87"><a id="__codelineno-68-87" name="__codelineno-68-87" href="#__codelineno-68-87"></a>
</span><span id="__span-68-88"><a id="__codelineno-68-88" name="__codelineno-68-88" href="#__codelineno-68-88"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-68-89"><a id="__codelineno-68-89" name="__codelineno-68-89" href="#__codelineno-68-89"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total parameters: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>LSTM Internals:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1"># Manual LSTM cell implementation for understanding</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">LSTMCell</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="sd">    Single LSTM cell showing internal gates</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">):</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LSTMCell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>        <span class="c1"># Gates: forget, input, output, candidate</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">W_f</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>  <span class="c1"># Forget gate</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">W_i</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>  <span class="c1"># Input gate</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">W_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>  <span class="c1"># Output gate</span>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">W_c</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>  <span class="c1"># Candidate</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">h_prev</span><span class="p">,</span> <span class="n">c_prev</span><span class="p">):</span>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="sd">        Args:</span>
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="sd">            x_t: Input at time t (batch_size, input_size)</span>
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="sd">            h_prev: Previous hidden state (batch_size, hidden_size)</span>
</span><span id="__span-69-20"><a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="sd">            c_prev: Previous cell state (batch_size, hidden_size)</span>
</span><span id="__span-69-21"><a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a>
</span><span id="__span-69-22"><a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a><span class="sd">        Returns:</span>
</span><span id="__span-69-23"><a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="sd">            h_t: New hidden state</span>
</span><span id="__span-69-24"><a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a><span class="sd">            c_t: New cell state</span>
</span><span id="__span-69-25"><a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-69-26"><a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a>        <span class="c1"># Concatenate input and previous hidden state</span>
</span><span id="__span-69-27"><a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_t</span><span class="p">,</span> <span class="n">h_prev</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-69-28"><a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a>
</span><span id="__span-69-29"><a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a>        <span class="c1"># Forget gate: decides what to forget from cell state</span>
</span><span id="__span-69-30"><a id="__codelineno-69-30" name="__codelineno-69-30" href="#__codelineno-69-30"></a>        <span class="n">f_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_f</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
</span><span id="__span-69-31"><a id="__codelineno-69-31" name="__codelineno-69-31" href="#__codelineno-69-31"></a>
</span><span id="__span-69-32"><a id="__codelineno-69-32" name="__codelineno-69-32" href="#__codelineno-69-32"></a>        <span class="c1"># Input gate: decides what new information to store</span>
</span><span id="__span-69-33"><a id="__codelineno-69-33" name="__codelineno-69-33" href="#__codelineno-69-33"></a>        <span class="n">i_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_i</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
</span><span id="__span-69-34"><a id="__codelineno-69-34" name="__codelineno-69-34" href="#__codelineno-69-34"></a>
</span><span id="__span-69-35"><a id="__codelineno-69-35" name="__codelineno-69-35" href="#__codelineno-69-35"></a>        <span class="c1"># Candidate: new candidate values for cell state</span>
</span><span id="__span-69-36"><a id="__codelineno-69-36" name="__codelineno-69-36" href="#__codelineno-69-36"></a>        <span class="n">c_tilde</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_c</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
</span><span id="__span-69-37"><a id="__codelineno-69-37" name="__codelineno-69-37" href="#__codelineno-69-37"></a>
</span><span id="__span-69-38"><a id="__codelineno-69-38" name="__codelineno-69-38" href="#__codelineno-69-38"></a>        <span class="c1"># Update cell state</span>
</span><span id="__span-69-39"><a id="__codelineno-69-39" name="__codelineno-69-39" href="#__codelineno-69-39"></a>        <span class="n">c_t</span> <span class="o">=</span> <span class="n">f_t</span> <span class="o">*</span> <span class="n">c_prev</span> <span class="o">+</span> <span class="n">i_t</span> <span class="o">*</span> <span class="n">c_tilde</span>
</span><span id="__span-69-40"><a id="__codelineno-69-40" name="__codelineno-69-40" href="#__codelineno-69-40"></a>
</span><span id="__span-69-41"><a id="__codelineno-69-41" name="__codelineno-69-41" href="#__codelineno-69-41"></a>        <span class="c1"># Output gate: decides what to output from cell state</span>
</span><span id="__span-69-42"><a id="__codelineno-69-42" name="__codelineno-69-42" href="#__codelineno-69-42"></a>        <span class="n">o_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_o</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
</span><span id="__span-69-43"><a id="__codelineno-69-43" name="__codelineno-69-43" href="#__codelineno-69-43"></a>
</span><span id="__span-69-44"><a id="__codelineno-69-44" name="__codelineno-69-44" href="#__codelineno-69-44"></a>        <span class="c1"># Update hidden state</span>
</span><span id="__span-69-45"><a id="__codelineno-69-45" name="__codelineno-69-45" href="#__codelineno-69-45"></a>        <span class="n">h_t</span> <span class="o">=</span> <span class="n">o_t</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">c_t</span><span class="p">)</span>
</span><span id="__span-69-46"><a id="__codelineno-69-46" name="__codelineno-69-46" href="#__codelineno-69-46"></a>
</span><span id="__span-69-47"><a id="__codelineno-69-47" name="__codelineno-69-47" href="#__codelineno-69-47"></a>        <span class="k">return</span> <span class="n">h_t</span><span class="p">,</span> <span class="n">c_t</span>
</span></code></pre></div>
<p><strong>Attention Mechanism for LSTM:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SMILES_LSTM_Attention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="sd">    LSTM with attention mechanism for SMILES</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">):</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SMILES_LSTM_Attention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>        <span class="c1"># Attention layer</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a>        <span class="c1"># Output layer</span>
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a>
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-70-18"><a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a>        <span class="c1"># Embedding and LSTM</span>
</span><span id="__span-70-19"><a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>        <span class="n">embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-70-20"><a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a>        <span class="n">lstm_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">embedded</span><span class="p">)</span>  <span class="c1"># (batch, seq_len, hidden*2)</span>
</span><span id="__span-70-21"><a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a>
</span><span id="__span-70-22"><a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a>        <span class="c1"># Attention weights</span>
</span><span id="__span-70-23"><a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a>        <span class="n">attention_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">lstm_out</span><span class="p">)</span>  <span class="c1"># (batch, seq_len, 1)</span>
</span><span id="__span-70-24"><a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a>        <span class="n">attention_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attention_scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-70-25"><a id="__codelineno-70-25" name="__codelineno-70-25" href="#__codelineno-70-25"></a>
</span><span id="__span-70-26"><a id="__codelineno-70-26" name="__codelineno-70-26" href="#__codelineno-70-26"></a>        <span class="c1"># Weighted sum of LSTM outputs</span>
</span><span id="__span-70-27"><a id="__codelineno-70-27" name="__codelineno-70-27" href="#__codelineno-70-27"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">attention_weights</span> <span class="o">*</span> <span class="n">lstm_out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (batch, hidden*2)</span>
</span><span id="__span-70-28"><a id="__codelineno-70-28" name="__codelineno-70-28" href="#__codelineno-70-28"></a>
</span><span id="__span-70-29"><a id="__codelineno-70-29" name="__codelineno-70-29" href="#__codelineno-70-29"></a>        <span class="c1"># Output</span>
</span><span id="__span-70-30"><a id="__codelineno-70-30" name="__codelineno-70-30" href="#__codelineno-70-30"></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="__span-70-31"><a id="__codelineno-70-31" name="__codelineno-70-31" href="#__codelineno-70-31"></a>
</span><span id="__span-70-32"><a id="__codelineno-70-32" name="__codelineno-70-32" href="#__codelineno-70-32"></a>        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">attention_weights</span>
</span></code></pre></div>
<h3 id="52__gru__alternative">5.2 GRU Alternative<a class="headerlink" href="#52__gru__alternative" title="Permanent link">&para;</a></h3>
<p>Gated Recurrent Unit (GRU) is a simpler alternative to LSTM with fewer parameters.</p>
<p><strong>GRU vs LSTM:</strong></p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>LSTM</th>
<th>GRU</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Gates</strong></td>
<td>3 (input, forget, output)</td>
<td>2 (reset, update)</td>
</tr>
<tr>
<td><strong>Cell state</strong></td>
<td>Separate (c_t and h_t)</td>
<td>Unified (h_t only)</td>
</tr>
<tr>
<td><strong>Parameters</strong></td>
<td>More</td>
<td>Fewer (~25% less)</td>
</tr>
<tr>
<td><strong>Training speed</strong></td>
<td>Slower</td>
<td>Faster</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Slightly better on complex tasks</td>
<td>Comparable on most tasks</td>
</tr>
<tr>
<td><strong>Memory</strong></td>
<td>Higher</td>
<td>Lower</td>
</tr>
</tbody>
</table>
<p><strong>GRU Implementation:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SMILES_GRU</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="sd">    GRU model for SMILES-based molecular property prediction</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> 
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>                 <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SMILES_GRU</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>        <span class="c1"># GRU layers (API similar to LSTM)</span>
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gru</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span>
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>            <span class="n">input_size</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">,</span>
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>            <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span>
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a>            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">dropout_rate</span> <span class="k">if</span> <span class="n">num_layers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>            <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span>
</span><span id="__span-71-19"><a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a>        <span class="p">)</span>
</span><span id="__span-71-20"><a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a>
</span><span id="__span-71-21"><a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a>        <span class="n">gru_output_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">bidirectional</span> <span class="k">else</span> <span class="n">hidden_dim</span>
</span><span id="__span-71-22"><a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>
</span><span id="__span-71-23"><a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-71-24"><a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">gru_output_dim</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
</span><span id="__span-71-25"><a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-71-26"><a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">),</span>
</span><span id="__span-71-27"><a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</span><span id="__span-71-28"><a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a>        <span class="p">)</span>
</span><span id="__span-71-29"><a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a>
</span><span id="__span-71-30"><a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-71-31"><a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a>        <span class="n">embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-71-32"><a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a>        <span class="n">gru_out</span><span class="p">,</span> <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gru</span><span class="p">(</span><span class="n">embedded</span><span class="p">)</span>
</span><span id="__span-71-33"><a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a>
</span><span id="__span-71-34"><a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a>        <span class="c1"># Use final hidden state</span>
</span><span id="__span-71-35"><a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gru</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">:</span>
</span><span id="__span-71-36"><a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a>            <span class="n">hidden_forward</span> <span class="o">=</span> <span class="n">hidden</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-71-37"><a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a>            <span class="n">hidden_backward</span> <span class="o">=</span> <span class="n">hidden</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-71-38"><a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a>            <span class="n">final_hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hidden_forward</span><span class="p">,</span> <span class="n">hidden_backward</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-71-39"><a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-71-40"><a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a>            <span class="n">final_hidden</span> <span class="o">=</span> <span class="n">hidden</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="__span-71-41"><a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a>
</span><span id="__span-71-42"><a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">final_hidden</span><span class="p">)</span>
</span><span id="__span-71-43"><a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a>        <span class="k">return</span> <span class="n">output</span>
</span></code></pre></div>
<p><strong>GRU Internals:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">GRUCell</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="sd">    Single GRU cell for understanding</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">):</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">GRUCell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>        <span class="c1"># Gates: reset and update</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">W_r</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>  <span class="c1"># Reset gate</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">W_z</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>  <span class="c1"># Update gate</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">W_h</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span> <span class="o">+</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>  <span class="c1"># Candidate</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">h_prev</span><span class="p">):</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a><span class="sd">        Args:</span>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a><span class="sd">            x_t: Input at time t</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a><span class="sd">            h_prev: Previous hidden state</span>
</span><span id="__span-72-18"><a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a>
</span><span id="__span-72-19"><a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a><span class="sd">        Returns:</span>
</span><span id="__span-72-20"><a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a><span class="sd">            h_t: New hidden state</span>
</span><span id="__span-72-21"><a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-72-22"><a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_t</span><span class="p">,</span> <span class="n">h_prev</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-72-23"><a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a>
</span><span id="__span-72-24"><a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a>        <span class="c1"># Reset gate: decides how much past to forget</span>
</span><span id="__span-72-25"><a id="__codelineno-72-25" name="__codelineno-72-25" href="#__codelineno-72-25"></a>        <span class="n">r_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_r</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
</span><span id="__span-72-26"><a id="__codelineno-72-26" name="__codelineno-72-26" href="#__codelineno-72-26"></a>
</span><span id="__span-72-27"><a id="__codelineno-72-27" name="__codelineno-72-27" href="#__codelineno-72-27"></a>        <span class="c1"># Update gate: decides how much to update</span>
</span><span id="__span-72-28"><a id="__codelineno-72-28" name="__codelineno-72-28" href="#__codelineno-72-28"></a>        <span class="n">z_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_z</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
</span><span id="__span-72-29"><a id="__codelineno-72-29" name="__codelineno-72-29" href="#__codelineno-72-29"></a>
</span><span id="__span-72-30"><a id="__codelineno-72-30" name="__codelineno-72-30" href="#__codelineno-72-30"></a>        <span class="c1"># Candidate: new candidate hidden state</span>
</span><span id="__span-72-31"><a id="__codelineno-72-31" name="__codelineno-72-31" href="#__codelineno-72-31"></a>        <span class="n">combined_reset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x_t</span><span class="p">,</span> <span class="n">r_t</span> <span class="o">*</span> <span class="n">h_prev</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-72-32"><a id="__codelineno-72-32" name="__codelineno-72-32" href="#__codelineno-72-32"></a>        <span class="n">h_tilde</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_h</span><span class="p">(</span><span class="n">combined_reset</span><span class="p">))</span>
</span><span id="__span-72-33"><a id="__codelineno-72-33" name="__codelineno-72-33" href="#__codelineno-72-33"></a>
</span><span id="__span-72-34"><a id="__codelineno-72-34" name="__codelineno-72-34" href="#__codelineno-72-34"></a>        <span class="c1"># Final hidden state: interpolation between prev and candidate</span>
</span><span id="__span-72-35"><a id="__codelineno-72-35" name="__codelineno-72-35" href="#__codelineno-72-35"></a>        <span class="n">h_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">z_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">h_prev</span> <span class="o">+</span> <span class="n">z_t</span> <span class="o">*</span> <span class="n">h_tilde</span>
</span><span id="__span-72-36"><a id="__codelineno-72-36" name="__codelineno-72-36" href="#__codelineno-72-36"></a>
</span><span id="__span-72-37"><a id="__codelineno-72-37" name="__codelineno-72-37" href="#__codelineno-72-37"></a>        <span class="k">return</span> <span class="n">h_t</span>
</span></code></pre></div>
<h3 id="53__comparison__with__cnns">5.3 Comparison with CNNs<a class="headerlink" href="#53__comparison__with__cnns" title="Permanent link">&para;</a></h3>
<p><strong>Performance Comparison:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_cnn_lstm_gru</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="sd">    Compare CNN, LSTM, and GRU on same dataset</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SMILESTokenizer</span><span class="p">()</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>    <span class="c1"># Prepare data</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">SMILES_Dataset</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">SMILES_Dataset</span><span class="p">(</span><span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a>
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a>    <span class="c1"># Models to compare</span>
</span><span id="__span-73-17"><a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a>    <span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-73-18"><a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a>        <span class="s1">&#39;1D CNN&#39;</span><span class="p">:</span> <span class="n">SMILES_CNN</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">)),</span>
</span><span id="__span-73-19"><a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a>        <span class="s1">&#39;LSTM&#39;</span><span class="p">:</span> <span class="n">SMILES_LSTM</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">)),</span>
</span><span id="__span-73-20"><a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a>        <span class="s1">&#39;GRU&#39;</span><span class="p">:</span> <span class="n">SMILES_GRU</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">)),</span>
</span><span id="__span-73-21"><a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a>        <span class="s1">&#39;LSTM+Attention&#39;</span><span class="p">:</span> <span class="n">SMILES_LSTM_Attention</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">))</span>
</span><span id="__span-73-22"><a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a>    <span class="p">}</span>
</span><span id="__span-73-23"><a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a>
</span><span id="__span-73-24"><a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-73-25"><a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-73-26"><a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a>
</span><span id="__span-73-27"><a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-73-28"><a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a>        <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-73-29"><a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a>
</span><span id="__span-73-30"><a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a>        <span class="c1"># Training loop</span>
</span><span id="__span-73-31"><a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a>        <span class="n">train_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-73-32"><a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a>
</span><span id="__span-73-33"><a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a>        <span class="c1"># Evaluate</span>
</span><span id="__span-73-34"><a id="__codelineno-73-34" name="__codelineno-73-34" href="#__codelineno-73-34"></a>        <span class="n">val_metrics</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">)</span>
</span><span id="__span-73-35"><a id="__codelineno-73-35" name="__codelineno-73-35" href="#__codelineno-73-35"></a>
</span><span id="__span-73-36"><a id="__codelineno-73-36" name="__codelineno-73-36" href="#__codelineno-73-36"></a>        <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-73-37"><a id="__codelineno-73-37" name="__codelineno-73-37" href="#__codelineno-73-37"></a>            <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">],</span>
</span><span id="__span-73-38"><a id="__codelineno-73-38" name="__codelineno-73-38" href="#__codelineno-73-38"></a>            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">],</span>
</span><span id="__span-73-39"><a id="__codelineno-73-39" name="__codelineno-73-39" href="#__codelineno-73-39"></a>            <span class="s1">&#39;Parameters&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span>
</span><span id="__span-73-40"><a id="__codelineno-73-40" name="__codelineno-73-40" href="#__codelineno-73-40"></a>            <span class="s1">&#39;Training time&#39;</span><span class="p">:</span> <span class="n">val_metrics</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
</span><span id="__span-73-41"><a id="__codelineno-73-41" name="__codelineno-73-41" href="#__codelineno-73-41"></a>        <span class="p">}</span>
</span><span id="__span-73-42"><a id="__codelineno-73-42" name="__codelineno-73-42" href="#__codelineno-73-42"></a>
</span><span id="__span-73-43"><a id="__codelineno-73-43" name="__codelineno-73-43" href="#__codelineno-73-43"></a>    <span class="c1"># Print comparison</span>
</span><span id="__span-73-44"><a id="__codelineno-73-44" name="__codelineno-73-44" href="#__codelineno-73-44"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
</span><span id="__span-73-45"><a id="__codelineno-73-45" name="__codelineno-73-45" href="#__codelineno-73-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MODEL COMPARISON&quot;</span><span class="p">)</span>
</span><span id="__span-73-46"><a id="__codelineno-73-46" name="__codelineno-73-46" href="#__codelineno-73-46"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
</span><span id="__span-73-47"><a id="__codelineno-73-47" name="__codelineno-73-47" href="#__codelineno-73-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Model&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;RMSE&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;R2&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Parameters&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Time (s)&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-73-48"><a id="__codelineno-73-48" name="__codelineno-73-48" href="#__codelineno-73-48"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
</span><span id="__span-73-49"><a id="__codelineno-73-49" name="__codelineno-73-49" href="#__codelineno-73-49"></a>
</span><span id="__span-73-50"><a id="__codelineno-73-50" name="__codelineno-73-50" href="#__codelineno-73-50"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-73-51"><a id="__codelineno-73-51" name="__codelineno-73-51" href="#__codelineno-73-51"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;10.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;10.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="__span-73-52"><a id="__codelineno-73-52" name="__codelineno-73-52" href="#__codelineno-73-52"></a>              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;15,</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Training time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;10.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-73-53"><a id="__codelineno-73-53" name="__codelineno-73-53" href="#__codelineno-73-53"></a>
</span><span id="__span-73-54"><a id="__codelineno-73-54" name="__codelineno-73-54" href="#__codelineno-73-54"></a>    <span class="k">return</span> <span class="n">results</span>
</span></code></pre></div>
<p><strong>Typical Results:</strong></p>
<table>
<thead>
<tr>
<th>Model</th>
<th>RMSE</th>
<th>R²</th>
<th>Parameters</th>
<th>Training Time</th>
<th>Inference Speed</th>
</tr>
</thead>
<tbody>
<tr>
<td>1D CNN</td>
<td>0.72</td>
<td>0.85</td>
<td>1.2M</td>
<td>Fast (1x)</td>
<td>Very Fast</td>
</tr>
<tr>
<td>LSTM</td>
<td>0.68</td>
<td>0.87</td>
<td>2.5M</td>
<td>Slow (3x)</td>
<td>Slow</td>
</tr>
<tr>
<td>GRU</td>
<td>0.69</td>
<td>0.86</td>
<td>1.9M</td>
<td>Medium (2x)</td>
<td>Medium</td>
</tr>
<tr>
<td>LSTM+Attention</td>
<td>0.65</td>
<td>0.89</td>
<td>2.8M</td>
<td>Slowest (3.5x)</td>
<td>Slow</td>
</tr>
</tbody>
</table>
<p><strong>Recommendations:</strong></p>
<ul>
<li><strong>Use CNN</strong> when: Speed is priority, local patterns important, large datasets</li>
<li><strong>Use LSTM</strong> when: Long-range dependencies matter, sequential information crucial</li>
<li><strong>Use GRU</strong> when: Want RNN benefits with fewer parameters, faster training</li>
<li><strong>Use LSTM+Attention</strong> when: Need interpretability, best performance, sufficient data</li>
</ul>
<hr />
<h2 id="6__transfer__learning">6. Transfer Learning<a class="headerlink" href="#6__transfer__learning" title="Permanent link">&para;</a></h2>
<p>Transfer learning leverages knowledge learned from one task (usually on large datasets) to improve performance on another related task (often with limited data).</p>
<h3 id="61__why__transfer__learning__for__molecules">6.1 Why Transfer Learning for Molecules<a class="headerlink" href="#61__why__transfer__learning__for__molecules" title="Permanent link">&para;</a></h3>
<p><strong>Challenges in Molecular Machine Learning:</strong></p>
<ol>
<li><strong>Limited Labeled Data</strong>: Experimental measurements are expensive</li>
<li>Example: Only ~10K molecules with measured BBB permeability</li>
<li>
<p>Contrast with millions of images in ImageNet</p>
</li>
<li>
<p><strong>Data Imbalance</strong>: Some properties measured more than others</p>
</li>
<li>Solubility: ~100K datapoints</li>
<li>
<p>Metabolic stability: ~1K datapoints</p>
</li>
<li>
<p><strong>Related Tasks</strong>: Many molecular properties share underlying features</p>
</li>
<li>Lipophilicity and permeability both depend on polarity</li>
<li>Multiple ADMET properties relate to molecular shape</li>
</ol>
<p><strong>Benefits of Transfer Learning:</strong></p>
<ul>
<li><strong>Data Efficiency</strong>: Achieve good performance with 10-100x less labeled data</li>
<li><strong>Faster Convergence</strong>: Pre-trained models converge in fewer epochs</li>
<li><strong>Better Generalization</strong>: Pre-learned features capture general molecular patterns</li>
<li><strong>Domain Adaptation</strong>: Adapt models trained on one molecule type to another</li>
</ul>
<p><strong>Example Scenario:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>Problem: Predict BBB permeability (only 5,000 labeled molecules)
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>Solution 1 (From Scratch):
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>├─ Train model on 5,000 BBB molecules
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>├─ Performance: R² = 0.65
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>└─ Training time: 50 epochs
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a>Solution 2 (Transfer Learning):
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>├─ Pre-train on 1M molecules (solubility + LogP + toxicity)
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>├─ Fine-tune on 5,000 BBB molecules
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>├─ Performance: R² = 0.82 (+26%)
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a>└─ Training time: 10 epochs (5x faster)
</span></code></pre></div>
<h3 id="62__pre-training__strategies">6.2 Pre-Training Strategies<a class="headerlink" href="#62__pre-training__strategies" title="Permanent link">&para;</a></h3>
<p><strong>1. Self-Supervised Pre-training with Autoencoders</strong></p>
<p>Learn molecular representations by reconstructing input:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MolecularAutoencoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="sd">    Autoencoder for learning molecular representations</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">encoding_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MolecularAutoencoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>        <span class="c1"># Encoder</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-75-15"><a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
</span><span id="__span-75-16"><a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">encoding_dim</span><span class="p">),</span>
</span><span id="__span-75-17"><a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="__span-75-18"><a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a>        <span class="p">)</span>
</span><span id="__span-75-19"><a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a>
</span><span id="__span-75-20"><a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a>        <span class="c1"># Decoder</span>
</span><span id="__span-75-21"><a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-75-22"><a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">encoding_dim</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
</span><span id="__span-75-23"><a id="__codelineno-75-23" name="__codelineno-75-23" href="#__codelineno-75-23"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-75-24"><a id="__codelineno-75-24" name="__codelineno-75-24" href="#__codelineno-75-24"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
</span><span id="__span-75-25"><a id="__codelineno-75-25" name="__codelineno-75-25" href="#__codelineno-75-25"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span>
</span><span id="__span-75-26"><a id="__codelineno-75-26" name="__codelineno-75-26" href="#__codelineno-75-26"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-75-27"><a id="__codelineno-75-27" name="__codelineno-75-27" href="#__codelineno-75-27"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
</span><span id="__span-75-28"><a id="__codelineno-75-28" name="__codelineno-75-28" href="#__codelineno-75-28"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">),</span>
</span><span id="__span-75-29"><a id="__codelineno-75-29" name="__codelineno-75-29" href="#__codelineno-75-29"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>  <span class="c1"># Output in [0, 1] for fingerprints</span>
</span><span id="__span-75-30"><a id="__codelineno-75-30" name="__codelineno-75-30" href="#__codelineno-75-30"></a>        <span class="p">)</span>
</span><span id="__span-75-31"><a id="__codelineno-75-31" name="__codelineno-75-31" href="#__codelineno-75-31"></a>
</span><span id="__span-75-32"><a id="__codelineno-75-32" name="__codelineno-75-32" href="#__codelineno-75-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-75-33"><a id="__codelineno-75-33" name="__codelineno-75-33" href="#__codelineno-75-33"></a>        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-75-34"><a id="__codelineno-75-34" name="__codelineno-75-34" href="#__codelineno-75-34"></a>        <span class="n">reconstruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
</span><span id="__span-75-35"><a id="__codelineno-75-35" name="__codelineno-75-35" href="#__codelineno-75-35"></a>        <span class="k">return</span> <span class="n">reconstruction</span>
</span><span id="__span-75-36"><a id="__codelineno-75-36" name="__codelineno-75-36" href="#__codelineno-75-36"></a>
</span><span id="__span-75-37"><a id="__codelineno-75-37" name="__codelineno-75-37" href="#__codelineno-75-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-75-38"><a id="__codelineno-75-38" name="__codelineno-75-38" href="#__codelineno-75-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract learned representations&quot;&quot;&quot;</span>
</span><span id="__span-75-39"><a id="__codelineno-75-39" name="__codelineno-75-39" href="#__codelineno-75-39"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-75-40"><a id="__codelineno-75-40" name="__codelineno-75-40" href="#__codelineno-75-40"></a>
</span><span id="__span-75-41"><a id="__codelineno-75-41" name="__codelineno-75-41" href="#__codelineno-75-41"></a><span class="c1"># Pre-training on large unlabeled dataset</span>
</span><span id="__span-75-42"><a id="__codelineno-75-42" name="__codelineno-75-42" href="#__codelineno-75-42"></a><span class="k">def</span><span class="w"> </span><span class="nf">pretrain_autoencoder</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="__span-75-43"><a id="__codelineno-75-43" name="__codelineno-75-43" href="#__codelineno-75-43"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-75-44"><a id="__codelineno-75-44" name="__codelineno-75-44" href="#__codelineno-75-44"></a><span class="sd">    Pre-train autoencoder on large molecular dataset</span>
</span><span id="__span-75-45"><a id="__codelineno-75-45" name="__codelineno-75-45" href="#__codelineno-75-45"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-75-46"><a id="__codelineno-75-46" name="__codelineno-75-46" href="#__codelineno-75-46"></a>    <span class="c1"># Generate fingerprints</span>
</span><span id="__span-75-47"><a id="__codelineno-75-47" name="__codelineno-75-47" href="#__codelineno-75-47"></a>    <span class="n">fingerprints</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-75-48"><a id="__codelineno-75-48" name="__codelineno-75-48" href="#__codelineno-75-48"></a>    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">smiles_list</span><span class="p">:</span>
</span><span id="__span-75-49"><a id="__codelineno-75-49" name="__codelineno-75-49" href="#__codelineno-75-49"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-75-50"><a id="__codelineno-75-50" name="__codelineno-75-50" href="#__codelineno-75-50"></a>        <span class="k">if</span> <span class="n">mol</span><span class="p">:</span>
</span><span id="__span-75-51"><a id="__codelineno-75-51" name="__codelineno-75-51" href="#__codelineno-75-51"></a>            <span class="n">fp</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</span><span id="__span-75-52"><a id="__codelineno-75-52" name="__codelineno-75-52" href="#__codelineno-75-52"></a>            <span class="n">fingerprints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span><span id="__span-75-53"><a id="__codelineno-75-53" name="__codelineno-75-53" href="#__codelineno-75-53"></a>
</span><span id="__span-75-54"><a id="__codelineno-75-54" name="__codelineno-75-54" href="#__codelineno-75-54"></a>    <span class="n">fingerprints</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fingerprints</span><span class="p">))</span>
</span><span id="__span-75-55"><a id="__codelineno-75-55" name="__codelineno-75-55" href="#__codelineno-75-55"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">fingerprints</span><span class="p">,</span> <span class="n">fingerprints</span><span class="p">)</span>  <span class="c1"># Input = target</span>
</span><span id="__span-75-56"><a id="__codelineno-75-56" name="__codelineno-75-56" href="#__codelineno-75-56"></a>    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-75-57"><a id="__codelineno-75-57" name="__codelineno-75-57" href="#__codelineno-75-57"></a>
</span><span id="__span-75-58"><a id="__codelineno-75-58" name="__codelineno-75-58" href="#__codelineno-75-58"></a>    <span class="c1"># Create and train autoencoder</span>
</span><span id="__span-75-59"><a id="__codelineno-75-59" name="__codelineno-75-59" href="#__codelineno-75-59"></a>    <span class="n">autoencoder</span> <span class="o">=</span> <span class="n">MolecularAutoencoder</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">encoding_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
</span><span id="__span-75-60"><a id="__codelineno-75-60" name="__codelineno-75-60" href="#__codelineno-75-60"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">autoencoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-75-61"><a id="__codelineno-75-61" name="__codelineno-75-61" href="#__codelineno-75-61"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-75-62"><a id="__codelineno-75-62" name="__codelineno-75-62" href="#__codelineno-75-62"></a>
</span><span id="__span-75-63"><a id="__codelineno-75-63" name="__codelineno-75-63" href="#__codelineno-75-63"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
</span><span id="__span-75-64"><a id="__codelineno-75-64" name="__codelineno-75-64" href="#__codelineno-75-64"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-75-65"><a id="__codelineno-75-65" name="__codelineno-75-65" href="#__codelineno-75-65"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
</span><span id="__span-75-66"><a id="__codelineno-75-66" name="__codelineno-75-66" href="#__codelineno-75-66"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-75-67"><a id="__codelineno-75-67" name="__codelineno-75-67" href="#__codelineno-75-67"></a>            <span class="n">reconstruction</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-75-68"><a id="__codelineno-75-68" name="__codelineno-75-68" href="#__codelineno-75-68"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span> <span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-75-69"><a id="__codelineno-75-69" name="__codelineno-75-69" href="#__codelineno-75-69"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-75-70"><a id="__codelineno-75-70" name="__codelineno-75-70" href="#__codelineno-75-70"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-75-71"><a id="__codelineno-75-71" name="__codelineno-75-71" href="#__codelineno-75-71"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-75-72"><a id="__codelineno-75-72" name="__codelineno-75-72" href="#__codelineno-75-72"></a>
</span><span id="__span-75-73"><a id="__codelineno-75-73" name="__codelineno-75-73" href="#__codelineno-75-73"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-75-74"><a id="__codelineno-75-74" name="__codelineno-75-74" href="#__codelineno-75-74"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">total_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-75-75"><a id="__codelineno-75-75" name="__codelineno-75-75" href="#__codelineno-75-75"></a>
</span><span id="__span-75-76"><a id="__codelineno-75-76" name="__codelineno-75-76" href="#__codelineno-75-76"></a>    <span class="k">return</span> <span class="n">autoencoder</span>
</span><span id="__span-75-77"><a id="__codelineno-75-77" name="__codelineno-75-77" href="#__codelineno-75-77"></a>
</span><span id="__span-75-78"><a id="__codelineno-75-78" name="__codelineno-75-78" href="#__codelineno-75-78"></a><span class="c1"># Use pre-trained encoder for downstream task</span>
</span><span id="__span-75-79"><a id="__codelineno-75-79" name="__codelineno-75-79" href="#__codelineno-75-79"></a><span class="k">class</span><span class="w"> </span><span class="nc">PretrainedMolecularModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-75-80"><a id="__codelineno-75-80" name="__codelineno-75-80" href="#__codelineno-75-80"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-75-81"><a id="__codelineno-75-81" name="__codelineno-75-81" href="#__codelineno-75-81"></a><span class="sd">    Use pre-trained encoder for property prediction</span>
</span><span id="__span-75-82"><a id="__codelineno-75-82" name="__codelineno-75-82" href="#__codelineno-75-82"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-75-83"><a id="__codelineno-75-83" name="__codelineno-75-83" href="#__codelineno-75-83"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretrained_encoder</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">freeze_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-75-84"><a id="__codelineno-75-84" name="__codelineno-75-84" href="#__codelineno-75-84"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">PretrainedMolecularModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-75-85"><a id="__codelineno-75-85" name="__codelineno-75-85" href="#__codelineno-75-85"></a>
</span><span id="__span-75-86"><a id="__codelineno-75-86" name="__codelineno-75-86" href="#__codelineno-75-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">pretrained_encoder</span><span class="o">.</span><span class="n">encoder</span>
</span><span id="__span-75-87"><a id="__codelineno-75-87" name="__codelineno-75-87" href="#__codelineno-75-87"></a>
</span><span id="__span-75-88"><a id="__codelineno-75-88" name="__codelineno-75-88" href="#__codelineno-75-88"></a>        <span class="c1"># Freeze encoder weights if specified</span>
</span><span id="__span-75-89"><a id="__codelineno-75-89" name="__codelineno-75-89" href="#__codelineno-75-89"></a>        <span class="k">if</span> <span class="n">freeze_encoder</span><span class="p">:</span>
</span><span id="__span-75-90"><a id="__codelineno-75-90" name="__codelineno-75-90" href="#__codelineno-75-90"></a>            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span><span id="__span-75-91"><a id="__codelineno-75-91" name="__codelineno-75-91" href="#__codelineno-75-91"></a>                <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-75-92"><a id="__codelineno-75-92" name="__codelineno-75-92" href="#__codelineno-75-92"></a>
</span><span id="__span-75-93"><a id="__codelineno-75-93" name="__codelineno-75-93" href="#__codelineno-75-93"></a>        <span class="c1"># Add prediction head</span>
</span><span id="__span-75-94"><a id="__codelineno-75-94" name="__codelineno-75-94" href="#__codelineno-75-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-75-95"><a id="__codelineno-75-95" name="__codelineno-75-95" href="#__codelineno-75-95"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
</span><span id="__span-75-96"><a id="__codelineno-75-96" name="__codelineno-75-96" href="#__codelineno-75-96"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-75-97"><a id="__codelineno-75-97" name="__codelineno-75-97" href="#__codelineno-75-97"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
</span><span id="__span-75-98"><a id="__codelineno-75-98" name="__codelineno-75-98" href="#__codelineno-75-98"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</span><span id="__span-75-99"><a id="__codelineno-75-99" name="__codelineno-75-99" href="#__codelineno-75-99"></a>        <span class="p">)</span>
</span><span id="__span-75-100"><a id="__codelineno-75-100" name="__codelineno-75-100" href="#__codelineno-75-100"></a>
</span><span id="__span-75-101"><a id="__codelineno-75-101" name="__codelineno-75-101" href="#__codelineno-75-101"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-75-102"><a id="__codelineno-75-102" name="__codelineno-75-102" href="#__codelineno-75-102"></a>        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-75-103"><a id="__codelineno-75-103" name="__codelineno-75-103" href="#__codelineno-75-103"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_head</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</span><span id="__span-75-104"><a id="__codelineno-75-104" name="__codelineno-75-104" href="#__codelineno-75-104"></a>        <span class="k">return</span> <span class="n">predictions</span>
</span></code></pre></div>
<p><strong>2. Multi-Task Pre-training</strong></p>
<p>Train on multiple related properties simultaneously:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">pretrain_multitask</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">properties_dict</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">):</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="sd">    Pre-train on multiple molecular properties</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="sd">    Args:</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="sd">        smiles_list: List of SMILES strings</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a><span class="sd">        properties_dict: Dict of {property_name: values_array}</span>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a><span class="sd">        task_configs: List of task configurations</span>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a><span class="sd">    Returns:</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a><span class="sd">        Pre-trained model</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>    <span class="c1"># Create multi-task model</span>
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">MultiTaskMolecularModel</span><span class="p">(</span>
</span><span id="__span-76-15"><a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a>        <span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
</span><span id="__span-76-16"><a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a>        <span class="n">shared_dims</span><span class="o">=</span><span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span>
</span><span id="__span-76-17"><a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a>        <span class="n">task_configs</span><span class="o">=</span><span class="n">task_configs</span>
</span><span id="__span-76-18"><a id="__codelineno-76-18" name="__codelineno-76-18" href="#__codelineno-76-18"></a>    <span class="p">)</span>
</span><span id="__span-76-19"><a id="__codelineno-76-19" name="__codelineno-76-19" href="#__codelineno-76-19"></a>
</span><span id="__span-76-20"><a id="__codelineno-76-20" name="__codelineno-76-20" href="#__codelineno-76-20"></a>    <span class="c1"># Prepare dataset</span>
</span><span id="__span-76-21"><a id="__codelineno-76-21" name="__codelineno-76-21" href="#__codelineno-76-21"></a>    <span class="n">fingerprints</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-76-22"><a id="__codelineno-76-22" name="__codelineno-76-22" href="#__codelineno-76-22"></a>    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">}</span>
</span><span id="__span-76-23"><a id="__codelineno-76-23" name="__codelineno-76-23" href="#__codelineno-76-23"></a>
</span><span id="__span-76-24"><a id="__codelineno-76-24" name="__codelineno-76-24" href="#__codelineno-76-24"></a>    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">smiles_list</span><span class="p">:</span>
</span><span id="__span-76-25"><a id="__codelineno-76-25" name="__codelineno-76-25" href="#__codelineno-76-25"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-76-26"><a id="__codelineno-76-26" name="__codelineno-76-26" href="#__codelineno-76-26"></a>        <span class="k">if</span> <span class="n">mol</span><span class="p">:</span>
</span><span id="__span-76-27"><a id="__codelineno-76-27" name="__codelineno-76-27" href="#__codelineno-76-27"></a>            <span class="n">fp</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</span><span id="__span-76-28"><a id="__codelineno-76-28" name="__codelineno-76-28" href="#__codelineno-76-28"></a>            <span class="n">fingerprints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span><span id="__span-76-29"><a id="__codelineno-76-29" name="__codelineno-76-29" href="#__codelineno-76-29"></a>
</span><span id="__span-76-30"><a id="__codelineno-76-30" name="__codelineno-76-30" href="#__codelineno-76-30"></a>            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">task_configs</span><span class="p">:</span>
</span><span id="__span-76-31"><a id="__codelineno-76-31" name="__codelineno-76-31" href="#__codelineno-76-31"></a>                <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="__span-76-32"><a id="__codelineno-76-32" name="__codelineno-76-32" href="#__codelineno-76-32"></a>                <span class="n">labels</span><span class="p">[</span><span class="n">task_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">properties_dict</span><span class="p">[</span><span class="n">task_name</span><span class="p">])</span>
</span><span id="__span-76-33"><a id="__codelineno-76-33" name="__codelineno-76-33" href="#__codelineno-76-33"></a>
</span><span id="__span-76-34"><a id="__codelineno-76-34" name="__codelineno-76-34" href="#__codelineno-76-34"></a>    <span class="c1"># Train multi-task model</span>
</span><span id="__span-76-35"><a id="__codelineno-76-35" name="__codelineno-76-35" href="#__codelineno-76-35"></a>    <span class="c1"># (Training code similar to Section 3)</span>
</span><span id="__span-76-36"><a id="__codelineno-76-36" name="__codelineno-76-36" href="#__codelineno-76-36"></a>    <span class="c1"># ...</span>
</span><span id="__span-76-37"><a id="__codelineno-76-37" name="__codelineno-76-37" href="#__codelineno-76-37"></a>
</span><span id="__span-76-38"><a id="__codelineno-76-38" name="__codelineno-76-38" href="#__codelineno-76-38"></a>    <span class="k">return</span> <span class="n">model</span>
</span></code></pre></div>
<p><strong>3. Masked Language Model (for SMILES)</strong></p>
<p>Similar to BERT, mask random tokens and predict them:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MaskedSMILESModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="sd">    BERT-like masked language model for SMILES</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MaskedSMILESModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>        <span class="c1"># Transformer encoder</span>
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>        <span class="n">encoder_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">embedding_dim</span><span class="p">,</span>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>            <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>            <span class="n">dim_feedforward</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a>            <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span>
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a>        <span class="p">)</span>
</span><span id="__span-77-17"><a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">encoder_layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">)</span>
</span><span id="__span-77-18"><a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a>
</span><span id="__span-77-19"><a id="__codelineno-77-19" name="__codelineno-77-19" href="#__codelineno-77-19"></a>        <span class="c1"># Prediction head for masked tokens</span>
</span><span id="__span-77-20"><a id="__codelineno-77-20" name="__codelineno-77-20" href="#__codelineno-77-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mlm_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>
</span><span id="__span-77-21"><a id="__codelineno-77-21" name="__codelineno-77-21" href="#__codelineno-77-21"></a>
</span><span id="__span-77-22"><a id="__codelineno-77-22" name="__codelineno-77-22" href="#__codelineno-77-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-77-23"><a id="__codelineno-77-23" name="__codelineno-77-23" href="#__codelineno-77-23"></a>        <span class="n">embedded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-77-24"><a id="__codelineno-77-24" name="__codelineno-77-24" href="#__codelineno-77-24"></a>        <span class="n">encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span><span class="n">embedded</span><span class="p">,</span> <span class="n">src_key_padding_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</span><span id="__span-77-25"><a id="__codelineno-77-25" name="__codelineno-77-25" href="#__codelineno-77-25"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlm_head</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
</span><span id="__span-77-26"><a id="__codelineno-77-26" name="__codelineno-77-26" href="#__codelineno-77-26"></a>        <span class="k">return</span> <span class="n">predictions</span>
</span><span id="__span-77-27"><a id="__codelineno-77-27" name="__codelineno-77-27" href="#__codelineno-77-27"></a>
</span><span id="__span-77-28"><a id="__codelineno-77-28" name="__codelineno-77-28" href="#__codelineno-77-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_masked_data</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">mask_prob</span><span class="o">=</span><span class="mf">0.15</span><span class="p">):</span>
</span><span id="__span-77-29"><a id="__codelineno-77-29" name="__codelineno-77-29" href="#__codelineno-77-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-77-30"><a id="__codelineno-77-30" name="__codelineno-77-30" href="#__codelineno-77-30"></a><span class="sd">    Create masked SMILES for pre-training</span>
</span><span id="__span-77-31"><a id="__codelineno-77-31" name="__codelineno-77-31" href="#__codelineno-77-31"></a>
</span><span id="__span-77-32"><a id="__codelineno-77-32" name="__codelineno-77-32" href="#__codelineno-77-32"></a><span class="sd">    Args:</span>
</span><span id="__span-77-33"><a id="__codelineno-77-33" name="__codelineno-77-33" href="#__codelineno-77-33"></a><span class="sd">        smiles_list: List of SMILES strings</span>
</span><span id="__span-77-34"><a id="__codelineno-77-34" name="__codelineno-77-34" href="#__codelineno-77-34"></a><span class="sd">        tokenizer: SMILES tokenizer</span>
</span><span id="__span-77-35"><a id="__codelineno-77-35" name="__codelineno-77-35" href="#__codelineno-77-35"></a><span class="sd">        mask_prob: Probability of masking each token</span>
</span><span id="__span-77-36"><a id="__codelineno-77-36" name="__codelineno-77-36" href="#__codelineno-77-36"></a>
</span><span id="__span-77-37"><a id="__codelineno-77-37" name="__codelineno-77-37" href="#__codelineno-77-37"></a><span class="sd">    Returns:</span>
</span><span id="__span-77-38"><a id="__codelineno-77-38" name="__codelineno-77-38" href="#__codelineno-77-38"></a><span class="sd">        masked_inputs, targets</span>
</span><span id="__span-77-39"><a id="__codelineno-77-39" name="__codelineno-77-39" href="#__codelineno-77-39"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-77-40"><a id="__codelineno-77-40" name="__codelineno-77-40" href="#__codelineno-77-40"></a>    <span class="n">masked_inputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-77-41"><a id="__codelineno-77-41" name="__codelineno-77-41" href="#__codelineno-77-41"></a>    <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-77-42"><a id="__codelineno-77-42" name="__codelineno-77-42" href="#__codelineno-77-42"></a>
</span><span id="__span-77-43"><a id="__codelineno-77-43" name="__codelineno-77-43" href="#__codelineno-77-43"></a>    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">smiles_list</span><span class="p">:</span>
</span><span id="__span-77-44"><a id="__codelineno-77-44" name="__codelineno-77-44" href="#__codelineno-77-44"></a>        <span class="n">encoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-77-45"><a id="__codelineno-77-45" name="__codelineno-77-45" href="#__codelineno-77-45"></a>        <span class="n">masked</span> <span class="o">=</span> <span class="n">encoded</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-77-46"><a id="__codelineno-77-46" name="__codelineno-77-46" href="#__codelineno-77-46"></a>
</span><span id="__span-77-47"><a id="__codelineno-77-47" name="__codelineno-77-47" href="#__codelineno-77-47"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)):</span>
</span><span id="__span-77-48"><a id="__codelineno-77-48" name="__codelineno-77-48" href="#__codelineno-77-48"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">mask_prob</span><span class="p">:</span>
</span><span id="__span-77-49"><a id="__codelineno-77-49" name="__codelineno-77-49" href="#__codelineno-77-49"></a>                <span class="n">masked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">token_to_idx</span><span class="p">[</span><span class="s1">&#39;&lt;MASK&gt;&#39;</span><span class="p">]</span>
</span><span id="__span-77-50"><a id="__codelineno-77-50" name="__codelineno-77-50" href="#__codelineno-77-50"></a>
</span><span id="__span-77-51"><a id="__codelineno-77-51" name="__codelineno-77-51" href="#__codelineno-77-51"></a>        <span class="n">masked_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span>
</span><span id="__span-77-52"><a id="__codelineno-77-52" name="__codelineno-77-52" href="#__codelineno-77-52"></a>        <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
</span><span id="__span-77-53"><a id="__codelineno-77-53" name="__codelineno-77-53" href="#__codelineno-77-53"></a>
</span><span id="__span-77-54"><a id="__codelineno-77-54" name="__codelineno-77-54" href="#__codelineno-77-54"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">masked_inputs</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="63__fine-tuning__workflow">6.3 Fine-Tuning Workflow<a class="headerlink" href="#63__fine-tuning__workflow" title="Permanent link">&para;</a></h3>
<p><strong>Complete Fine-Tuning Pipeline:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">fine_tune_pretrained_model</span><span class="p">(</span><span class="n">pretrained_model</span><span class="p">,</span> <span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>                               <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">freeze_layers</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="sd">    Fine-tune pre-trained model on downstream task</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="sd">    Args:</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="sd">        pretrained_model: Pre-trained neural network</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="sd">        smiles_train, y_train: Training data for downstream task</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="sd">        smiles_val, y_val: Validation data</span>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="sd">        freeze_layers: Whether to freeze early layers</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a><span class="sd">    Returns:</span>
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a><span class="sd">        fine_tuned_model, history</span>
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a>    <span class="c1"># Create model with pre-trained weights</span>
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">PretrainedMolecularModel</span><span class="p">(</span>
</span><span id="__span-78-17"><a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a>        <span class="n">pretrained_encoder</span><span class="o">=</span><span class="n">pretrained_model</span><span class="p">,</span>
</span><span id="__span-78-18"><a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a>        <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-78-19"><a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a>        <span class="n">freeze_encoder</span><span class="o">=</span><span class="n">freeze_layers</span>
</span><span id="__span-78-20"><a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a>    <span class="p">)</span>
</span><span id="__span-78-21"><a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a>
</span><span id="__span-78-22"><a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a>    <span class="c1"># Prepare data</span>
</span><span id="__span-78-23"><a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">MolecularDataset</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</span><span id="__span-78-24"><a id="__codelineno-78-24" name="__codelineno-78-24" href="#__codelineno-78-24"></a>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">MolecularDataset</span><span class="p">(</span><span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-78-25"><a id="__codelineno-78-25" name="__codelineno-78-25" href="#__codelineno-78-25"></a>
</span><span id="__span-78-26"><a id="__codelineno-78-26" name="__codelineno-78-26" href="#__codelineno-78-26"></a>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-78-27"><a id="__codelineno-78-27" name="__codelineno-78-27" href="#__codelineno-78-27"></a>    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</span><span id="__span-78-28"><a id="__codelineno-78-28" name="__codelineno-78-28" href="#__codelineno-78-28"></a>
</span><span id="__span-78-29"><a id="__codelineno-78-29" name="__codelineno-78-29" href="#__codelineno-78-29"></a>    <span class="c1"># Use lower learning rate for fine-tuning</span>
</span><span id="__span-78-30"><a id="__codelineno-78-30" name="__codelineno-78-30" href="#__codelineno-78-30"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>  <span class="c1"># 10x smaller than from-scratch</span>
</span><span id="__span-78-31"><a id="__codelineno-78-31" name="__codelineno-78-31" href="#__codelineno-78-31"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-78-32"><a id="__codelineno-78-32" name="__codelineno-78-32" href="#__codelineno-78-32"></a>
</span><span id="__span-78-33"><a id="__codelineno-78-33" name="__codelineno-78-33" href="#__codelineno-78-33"></a>    <span class="c1"># Training configuration</span>
</span><span id="__span-78-34"><a id="__codelineno-78-34" name="__codelineno-78-34" href="#__codelineno-78-34"></a>    <span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># Fewer epochs needed</span>
</span><span id="__span-78-35"><a id="__codelineno-78-35" name="__codelineno-78-35" href="#__codelineno-78-35"></a>    <span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="__span-78-36"><a id="__codelineno-78-36" name="__codelineno-78-36" href="#__codelineno-78-36"></a>    <span class="n">patience</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="__span-78-37"><a id="__codelineno-78-37" name="__codelineno-78-37" href="#__codelineno-78-37"></a>    <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-78-38"><a id="__codelineno-78-38" name="__codelineno-78-38" href="#__codelineno-78-38"></a>
</span><span id="__span-78-39"><a id="__codelineno-78-39" name="__codelineno-78-39" href="#__codelineno-78-39"></a>    <span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_rmse&#39;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="__span-78-40"><a id="__codelineno-78-40" name="__codelineno-78-40" href="#__codelineno-78-40"></a>
</span><span id="__span-78-41"><a id="__codelineno-78-41" name="__codelineno-78-41" href="#__codelineno-78-41"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
</span><span id="__span-78-42"><a id="__codelineno-78-42" name="__codelineno-78-42" href="#__codelineno-78-42"></a>        <span class="c1"># Training</span>
</span><span id="__span-78-43"><a id="__codelineno-78-43" name="__codelineno-78-43" href="#__codelineno-78-43"></a>        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-78-44"><a id="__codelineno-78-44" name="__codelineno-78-44" href="#__codelineno-78-44"></a>        <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-78-45"><a id="__codelineno-78-45" name="__codelineno-78-45" href="#__codelineno-78-45"></a>
</span><span id="__span-78-46"><a id="__codelineno-78-46" name="__codelineno-78-46" href="#__codelineno-78-46"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
</span><span id="__span-78-47"><a id="__codelineno-78-47" name="__codelineno-78-47" href="#__codelineno-78-47"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-78-48"><a id="__codelineno-78-48" name="__codelineno-78-48" href="#__codelineno-78-48"></a>            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-78-49"><a id="__codelineno-78-49" name="__codelineno-78-49" href="#__codelineno-78-49"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-78-50"><a id="__codelineno-78-50" name="__codelineno-78-50" href="#__codelineno-78-50"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-78-51"><a id="__codelineno-78-51" name="__codelineno-78-51" href="#__codelineno-78-51"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-78-52"><a id="__codelineno-78-52" name="__codelineno-78-52" href="#__codelineno-78-52"></a>            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-78-53"><a id="__codelineno-78-53" name="__codelineno-78-53" href="#__codelineno-78-53"></a>
</span><span id="__span-78-54"><a id="__codelineno-78-54" name="__codelineno-78-54" href="#__codelineno-78-54"></a>        <span class="c1"># Validation</span>
</span><span id="__span-78-55"><a id="__codelineno-78-55" name="__codelineno-78-55" href="#__codelineno-78-55"></a>        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-78-56"><a id="__codelineno-78-56" name="__codelineno-78-56" href="#__codelineno-78-56"></a>        <span class="n">val_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-78-57"><a id="__codelineno-78-57" name="__codelineno-78-57" href="#__codelineno-78-57"></a>        <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-78-58"><a id="__codelineno-78-58" name="__codelineno-78-58" href="#__codelineno-78-58"></a>        <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-78-59"><a id="__codelineno-78-59" name="__codelineno-78-59" href="#__codelineno-78-59"></a>
</span><span id="__span-78-60"><a id="__codelineno-78-60" name="__codelineno-78-60" href="#__codelineno-78-60"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-78-61"><a id="__codelineno-78-61" name="__codelineno-78-61" href="#__codelineno-78-61"></a>            <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
</span><span id="__span-78-62"><a id="__codelineno-78-62" name="__codelineno-78-62" href="#__codelineno-78-62"></a>                <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-78-63"><a id="__codelineno-78-63" name="__codelineno-78-63" href="#__codelineno-78-63"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-78-64"><a id="__codelineno-78-64" name="__codelineno-78-64" href="#__codelineno-78-64"></a>                <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-78-65"><a id="__codelineno-78-65" name="__codelineno-78-65" href="#__codelineno-78-65"></a>
</span><span id="__span-78-66"><a id="__codelineno-78-66" name="__codelineno-78-66" href="#__codelineno-78-66"></a>                <span class="n">all_preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-78-67"><a id="__codelineno-78-67" name="__codelineno-78-67" href="#__codelineno-78-67"></a>                <span class="n">all_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_y</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-78-68"><a id="__codelineno-78-68" name="__codelineno-78-68" href="#__codelineno-78-68"></a>
</span><span id="__span-78-69"><a id="__codelineno-78-69" name="__codelineno-78-69" href="#__codelineno-78-69"></a>        <span class="n">train_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
</span><span id="__span-78-70"><a id="__codelineno-78-70" name="__codelineno-78-70" href="#__codelineno-78-70"></a>        <span class="n">val_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
</span><span id="__span-78-71"><a id="__codelineno-78-71" name="__codelineno-78-71" href="#__codelineno-78-71"></a>        <span class="n">val_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">))</span>
</span><span id="__span-78-72"><a id="__codelineno-78-72" name="__codelineno-78-72" href="#__codelineno-78-72"></a>
</span><span id="__span-78-73"><a id="__codelineno-78-73" name="__codelineno-78-73" href="#__codelineno-78-73"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
</span><span id="__span-78-74"><a id="__codelineno-78-74" name="__codelineno-78-74" href="#__codelineno-78-74"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-78-75"><a id="__codelineno-78-75" name="__codelineno-78-75" href="#__codelineno-78-75"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_rmse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_rmse</span><span class="p">)</span>
</span><span id="__span-78-76"><a id="__codelineno-78-76" name="__codelineno-78-76" href="#__codelineno-78-76"></a>
</span><span id="__span-78-77"><a id="__codelineno-78-77" name="__codelineno-78-77" href="#__codelineno-78-77"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="__span-78-78"><a id="__codelineno-78-78" name="__codelineno-78-78" href="#__codelineno-78-78"></a>              <span class="sa">f</span><span class="s2">&quot;Train Loss=</span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Val Loss=</span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, RMSE=</span><span class="si">{</span><span class="n">val_rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-78-79"><a id="__codelineno-78-79" name="__codelineno-78-79" href="#__codelineno-78-79"></a>
</span><span id="__span-78-80"><a id="__codelineno-78-80" name="__codelineno-78-80" href="#__codelineno-78-80"></a>        <span class="c1"># Early stopping</span>
</span><span id="__span-78-81"><a id="__codelineno-78-81" name="__codelineno-78-81" href="#__codelineno-78-81"></a>        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
</span><span id="__span-78-82"><a id="__codelineno-78-82" name="__codelineno-78-82" href="#__codelineno-78-82"></a>            <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
</span><span id="__span-78-83"><a id="__codelineno-78-83" name="__codelineno-78-83" href="#__codelineno-78-83"></a>            <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-78-84"><a id="__codelineno-78-84" name="__codelineno-78-84" href="#__codelineno-78-84"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;best_finetuned_model.pth&#39;</span><span class="p">)</span>
</span><span id="__span-78-85"><a id="__codelineno-78-85" name="__codelineno-78-85" href="#__codelineno-78-85"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-78-86"><a id="__codelineno-78-86" name="__codelineno-78-86" href="#__codelineno-78-86"></a>            <span class="n">patience_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-78-87"><a id="__codelineno-78-87" name="__codelineno-78-87" href="#__codelineno-78-87"></a>            <span class="k">if</span> <span class="n">patience_counter</span> <span class="o">&gt;=</span> <span class="n">patience</span><span class="p">:</span>
</span><span id="__span-78-88"><a id="__codelineno-78-88" name="__codelineno-78-88" href="#__codelineno-78-88"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Early stopping at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-78-89"><a id="__codelineno-78-89" name="__codelineno-78-89" href="#__codelineno-78-89"></a>                <span class="k">break</span>
</span><span id="__span-78-90"><a id="__codelineno-78-90" name="__codelineno-78-90" href="#__codelineno-78-90"></a>
</span><span id="__span-78-91"><a id="__codelineno-78-91" name="__codelineno-78-91" href="#__codelineno-78-91"></a>    <span class="c1"># Load best model</span>
</span><span id="__span-78-92"><a id="__codelineno-78-92" name="__codelineno-78-92" href="#__codelineno-78-92"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;best_finetuned_model.pth&#39;</span><span class="p">))</span>
</span><span id="__span-78-93"><a id="__codelineno-78-93" name="__codelineno-78-93" href="#__codelineno-78-93"></a>
</span><span id="__span-78-94"><a id="__codelineno-78-94" name="__codelineno-78-94" href="#__codelineno-78-94"></a>    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">history</span>
</span><span id="__span-78-95"><a id="__codelineno-78-95" name="__codelineno-78-95" href="#__codelineno-78-95"></a>
</span><span id="__span-78-96"><a id="__codelineno-78-96" name="__codelineno-78-96" href="#__codelineno-78-96"></a><span class="c1"># Gradual unfreezing strategy</span>
</span><span id="__span-78-97"><a id="__codelineno-78-97" name="__codelineno-78-97" href="#__codelineno-78-97"></a><span class="k">def</span><span class="w"> </span><span class="nf">gradual_unfreezing</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">num_phases</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-78-98"><a id="__codelineno-78-98" name="__codelineno-78-98" href="#__codelineno-78-98"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-78-99"><a id="__codelineno-78-99" name="__codelineno-78-99" href="#__codelineno-78-99"></a><span class="sd">    Gradually unfreeze layers during fine-tuning</span>
</span><span id="__span-78-100"><a id="__codelineno-78-100" name="__codelineno-78-100" href="#__codelineno-78-100"></a>
</span><span id="__span-78-101"><a id="__codelineno-78-101" name="__codelineno-78-101" href="#__codelineno-78-101"></a><span class="sd">    Phase 1: Freeze all, train head only</span>
</span><span id="__span-78-102"><a id="__codelineno-78-102" name="__codelineno-78-102" href="#__codelineno-78-102"></a><span class="sd">    Phase 2: Unfreeze top encoder layers</span>
</span><span id="__span-78-103"><a id="__codelineno-78-103" name="__codelineno-78-103" href="#__codelineno-78-103"></a><span class="sd">    Phase 3: Unfreeze all layers</span>
</span><span id="__span-78-104"><a id="__codelineno-78-104" name="__codelineno-78-104" href="#__codelineno-78-104"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-78-105"><a id="__codelineno-78-105" name="__codelineno-78-105" href="#__codelineno-78-105"></a>    <span class="n">all_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">children</span><span class="p">())</span>
</span><span id="__span-78-106"><a id="__codelineno-78-106" name="__codelineno-78-106" href="#__codelineno-78-106"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-78-107"><a id="__codelineno-78-107" name="__codelineno-78-107" href="#__codelineno-78-107"></a>
</span><span id="__span-78-108"><a id="__codelineno-78-108" name="__codelineno-78-108" href="#__codelineno-78-108"></a>    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_phases</span><span class="p">):</span>
</span><span id="__span-78-109"><a id="__codelineno-78-109" name="__codelineno-78-109" href="#__codelineno-78-109"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Phase </span><span class="si">{</span><span class="n">phase</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_phases</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-78-110"><a id="__codelineno-78-110" name="__codelineno-78-110" href="#__codelineno-78-110"></a>
</span><span id="__span-78-111"><a id="__codelineno-78-111" name="__codelineno-78-111" href="#__codelineno-78-111"></a>        <span class="c1"># Determine which layers to unfreeze</span>
</span><span id="__span-78-112"><a id="__codelineno-78-112" name="__codelineno-78-112" href="#__codelineno-78-112"></a>        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-78-113"><a id="__codelineno-78-113" name="__codelineno-78-113" href="#__codelineno-78-113"></a>            <span class="c1"># Freeze all encoder layers</span>
</span><span id="__span-78-114"><a id="__codelineno-78-114" name="__codelineno-78-114" href="#__codelineno-78-114"></a>            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span><span id="__span-78-115"><a id="__codelineno-78-115" name="__codelineno-78-115" href="#__codelineno-78-115"></a>                <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-78-116"><a id="__codelineno-78-116" name="__codelineno-78-116" href="#__codelineno-78-116"></a>        <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-78-117"><a id="__codelineno-78-117" name="__codelineno-78-117" href="#__codelineno-78-117"></a>            <span class="c1"># Unfreeze last 1/3 of encoder layers</span>
</span><span id="__span-78-118"><a id="__codelineno-78-118" name="__codelineno-78-118" href="#__codelineno-78-118"></a>            <span class="n">unfreeze_from</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_layers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">//</span> <span class="mi">3</span>
</span><span id="__span-78-119"><a id="__codelineno-78-119" name="__codelineno-78-119" href="#__codelineno-78-119"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_layers</span><span class="p">):</span>
</span><span id="__span-78-120"><a id="__codelineno-78-120" name="__codelineno-78-120" href="#__codelineno-78-120"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">unfreeze_from</span><span class="p">:</span>
</span><span id="__span-78-121"><a id="__codelineno-78-121" name="__codelineno-78-121" href="#__codelineno-78-121"></a>                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span><span id="__span-78-122"><a id="__codelineno-78-122" name="__codelineno-78-122" href="#__codelineno-78-122"></a>                        <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-78-123"><a id="__codelineno-78-123" name="__codelineno-78-123" href="#__codelineno-78-123"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-78-124"><a id="__codelineno-78-124" name="__codelineno-78-124" href="#__codelineno-78-124"></a>            <span class="c1"># Unfreeze all layers</span>
</span><span id="__span-78-125"><a id="__codelineno-78-125" name="__codelineno-78-125" href="#__codelineno-78-125"></a>            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span><span id="__span-78-126"><a id="__codelineno-78-126" name="__codelineno-78-126" href="#__codelineno-78-126"></a>                <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-78-127"><a id="__codelineno-78-127" name="__codelineno-78-127" href="#__codelineno-78-127"></a>
</span><span id="__span-78-128"><a id="__codelineno-78-128" name="__codelineno-78-128" href="#__codelineno-78-128"></a>        <span class="c1"># Use decreasing learning rate for each phase</span>
</span><span id="__span-78-129"><a id="__codelineno-78-129" name="__codelineno-78-129" href="#__codelineno-78-129"></a>        <span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">phase</span><span class="p">)</span>
</span><span id="__span-78-130"><a id="__codelineno-78-130" name="__codelineno-78-130" href="#__codelineno-78-130"></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span><span id="__span-78-131"><a id="__codelineno-78-131" name="__codelineno-78-131" href="#__codelineno-78-131"></a>
</span><span id="__span-78-132"><a id="__codelineno-78-132" name="__codelineno-78-132" href="#__codelineno-78-132"></a>        <span class="c1"># Train for this phase</span>
</span><span id="__span-78-133"><a id="__codelineno-78-133" name="__codelineno-78-133" href="#__codelineno-78-133"></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-78-134"><a id="__codelineno-78-134" name="__codelineno-78-134" href="#__codelineno-78-134"></a>            <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
</span><span id="__span-78-135"><a id="__codelineno-78-135" name="__codelineno-78-135" href="#__codelineno-78-135"></a>
</span><span id="__span-78-136"><a id="__codelineno-78-136" name="__codelineno-78-136" href="#__codelineno-78-136"></a>    <span class="k">return</span> <span class="n">model</span>
</span></code></pre></div>
<h3 id="64__pre-trained__models__chemberta">6.4 Pre-Trained Models (ChemBERTa)<a class="headerlink" href="#64__pre-trained__models__chemberta" title="Permanent link">&para;</a></h3>
<p><strong>Using ChemBERTa</strong> (Chemical BERT Architecture):</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModel</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">ChemBERTaFineTuner</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="sd">    Fine-tune ChemBERTa for molecular property prediction</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">ChemBERTaFineTuner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>        <span class="c1"># Load pre-trained ChemBERTa</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chemberta</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;seyonec/ChemBERTa-zinc-base-v1&quot;</span><span class="p">)</span>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a>        <span class="c1"># Add prediction head</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>        <span class="n">hidden_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemberta</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-79-19"><a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">),</span>
</span><span id="__span-79-20"><a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
</span><span id="__span-79-21"><a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a>        <span class="p">)</span>
</span><span id="__span-79-22"><a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a>
</span><span id="__span-79-23"><a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">):</span>
</span><span id="__span-79-24"><a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-79-25"><a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a><span class="sd">        Args:</span>
</span><span id="__span-79-26"><a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a><span class="sd">            input_ids: Tokenized SMILES (batch_size, seq_length)</span>
</span><span id="__span-79-27"><a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a><span class="sd">            attention_mask: Attention mask (batch_size, seq_length)</span>
</span><span id="__span-79-28"><a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a>
</span><span id="__span-79-29"><a id="__codelineno-79-29" name="__codelineno-79-29" href="#__codelineno-79-29"></a><span class="sd">        Returns:</span>
</span><span id="__span-79-30"><a id="__codelineno-79-30" name="__codelineno-79-30" href="#__codelineno-79-30"></a><span class="sd">            Predictions (batch_size, output_dim)</span>
</span><span id="__span-79-31"><a id="__codelineno-79-31" name="__codelineno-79-31" href="#__codelineno-79-31"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-79-32"><a id="__codelineno-79-32" name="__codelineno-79-32" href="#__codelineno-79-32"></a>        <span class="c1"># Get ChemBERTa embeddings</span>
</span><span id="__span-79-33"><a id="__codelineno-79-33" name="__codelineno-79-33" href="#__codelineno-79-33"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemberta</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">)</span>
</span><span id="__span-79-34"><a id="__codelineno-79-34" name="__codelineno-79-34" href="#__codelineno-79-34"></a>
</span><span id="__span-79-35"><a id="__codelineno-79-35" name="__codelineno-79-35" href="#__codelineno-79-35"></a>        <span class="c1"># Use [CLS] token representation</span>
</span><span id="__span-79-36"><a id="__codelineno-79-36" name="__codelineno-79-36" href="#__codelineno-79-36"></a>        <span class="n">cls_embedding</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="__span-79-37"><a id="__codelineno-79-37" name="__codelineno-79-37" href="#__codelineno-79-37"></a>
</span><span id="__span-79-38"><a id="__codelineno-79-38" name="__codelineno-79-38" href="#__codelineno-79-38"></a>        <span class="c1"># Prediction</span>
</span><span id="__span-79-39"><a id="__codelineno-79-39" name="__codelineno-79-39" href="#__codelineno-79-39"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_head</span><span class="p">(</span><span class="n">cls_embedding</span><span class="p">)</span>
</span><span id="__span-79-40"><a id="__codelineno-79-40" name="__codelineno-79-40" href="#__codelineno-79-40"></a>
</span><span id="__span-79-41"><a id="__codelineno-79-41" name="__codelineno-79-41" href="#__codelineno-79-41"></a>        <span class="k">return</span> <span class="n">predictions</span>
</span><span id="__span-79-42"><a id="__codelineno-79-42" name="__codelineno-79-42" href="#__codelineno-79-42"></a>
</span><span id="__span-79-43"><a id="__codelineno-79-43" name="__codelineno-79-43" href="#__codelineno-79-43"></a><span class="c1"># Usage example</span>
</span><span id="__span-79-44"><a id="__codelineno-79-44" name="__codelineno-79-44" href="#__codelineno-79-44"></a><span class="k">def</span><span class="w"> </span><span class="nf">use_chemberta</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span><span id="__span-79-45"><a id="__codelineno-79-45" name="__codelineno-79-45" href="#__codelineno-79-45"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-79-46"><a id="__codelineno-79-46" name="__codelineno-79-46" href="#__codelineno-79-46"></a><span class="sd">    Fine-tune ChemBERTa on your dataset</span>
</span><span id="__span-79-47"><a id="__codelineno-79-47" name="__codelineno-79-47" href="#__codelineno-79-47"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-79-48"><a id="__codelineno-79-48" name="__codelineno-79-48" href="#__codelineno-79-48"></a>    <span class="c1"># Load tokenizer</span>
</span><span id="__span-79-49"><a id="__codelineno-79-49" name="__codelineno-79-49" href="#__codelineno-79-49"></a>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;seyonec/ChemBERTa-zinc-base-v1&quot;</span><span class="p">)</span>
</span><span id="__span-79-50"><a id="__codelineno-79-50" name="__codelineno-79-50" href="#__codelineno-79-50"></a>
</span><span id="__span-79-51"><a id="__codelineno-79-51" name="__codelineno-79-51" href="#__codelineno-79-51"></a>    <span class="c1"># Tokenize SMILES</span>
</span><span id="__span-79-52"><a id="__codelineno-79-52" name="__codelineno-79-52" href="#__codelineno-79-52"></a>    <span class="n">encoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
</span><span id="__span-79-53"><a id="__codelineno-79-53" name="__codelineno-79-53" href="#__codelineno-79-53"></a>        <span class="n">smiles_list</span><span class="p">,</span>
</span><span id="__span-79-54"><a id="__codelineno-79-54" name="__codelineno-79-54" href="#__codelineno-79-54"></a>        <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-79-55"><a id="__codelineno-79-55" name="__codelineno-79-55" href="#__codelineno-79-55"></a>        <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-79-56"><a id="__codelineno-79-56" name="__codelineno-79-56" href="#__codelineno-79-56"></a>        <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="__span-79-57"><a id="__codelineno-79-57" name="__codelineno-79-57" href="#__codelineno-79-57"></a>        <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span>
</span><span id="__span-79-58"><a id="__codelineno-79-58" name="__codelineno-79-58" href="#__codelineno-79-58"></a>    <span class="p">)</span>
</span><span id="__span-79-59"><a id="__codelineno-79-59" name="__codelineno-79-59" href="#__codelineno-79-59"></a>
</span><span id="__span-79-60"><a id="__codelineno-79-60" name="__codelineno-79-60" href="#__codelineno-79-60"></a>    <span class="c1"># Create model</span>
</span><span id="__span-79-61"><a id="__codelineno-79-61" name="__codelineno-79-61" href="#__codelineno-79-61"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">ChemBERTaFineTuner</span><span class="p">(</span><span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-79-62"><a id="__codelineno-79-62" name="__codelineno-79-62" href="#__codelineno-79-62"></a>
</span><span id="__span-79-63"><a id="__codelineno-79-63" name="__codelineno-79-63" href="#__codelineno-79-63"></a>    <span class="c1"># Training loop</span>
</span><span id="__span-79-64"><a id="__codelineno-79-64" name="__codelineno-79-64" href="#__codelineno-79-64"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">2e-5</span><span class="p">)</span>
</span><span id="__span-79-65"><a id="__codelineno-79-65" name="__codelineno-79-65" href="#__codelineno-79-65"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-79-66"><a id="__codelineno-79-66" name="__codelineno-79-66" href="#__codelineno-79-66"></a>
</span><span id="__span-79-67"><a id="__codelineno-79-67" name="__codelineno-79-67" href="#__codelineno-79-67"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-79-68"><a id="__codelineno-79-68" name="__codelineno-79-68" href="#__codelineno-79-68"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-79-69"><a id="__codelineno-79-69" name="__codelineno-79-69" href="#__codelineno-79-69"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-79-70"><a id="__codelineno-79-70" name="__codelineno-79-70" href="#__codelineno-79-70"></a>
</span><span id="__span-79-71"><a id="__codelineno-79-71" name="__codelineno-79-71" href="#__codelineno-79-71"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span>
</span><span id="__span-79-72"><a id="__codelineno-79-72" name="__codelineno-79-72" href="#__codelineno-79-72"></a>            <span class="n">input_ids</span><span class="o">=</span><span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">],</span>
</span><span id="__span-79-73"><a id="__codelineno-79-73" name="__codelineno-79-73" href="#__codelineno-79-73"></a>            <span class="n">attention_mask</span><span class="o">=</span><span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span>
</span><span id="__span-79-74"><a id="__codelineno-79-74" name="__codelineno-79-74" href="#__codelineno-79-74"></a>        <span class="p">)</span>
</span><span id="__span-79-75"><a id="__codelineno-79-75" name="__codelineno-79-75" href="#__codelineno-79-75"></a>
</span><span id="__span-79-76"><a id="__codelineno-79-76" name="__codelineno-79-76" href="#__codelineno-79-76"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">labels</span><span class="p">)</span>
</span><span id="__span-79-77"><a id="__codelineno-79-77" name="__codelineno-79-77" href="#__codelineno-79-77"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-79-78"><a id="__codelineno-79-78" name="__codelineno-79-78" href="#__codelineno-79-78"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-79-79"><a id="__codelineno-79-79" name="__codelineno-79-79" href="#__codelineno-79-79"></a>
</span><span id="__span-79-80"><a id="__codelineno-79-80" name="__codelineno-79-80" href="#__codelineno-79-80"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-79-81"><a id="__codelineno-79-81" name="__codelineno-79-81" href="#__codelineno-79-81"></a>
</span><span id="__span-79-82"><a id="__codelineno-79-82" name="__codelineno-79-82" href="#__codelineno-79-82"></a>    <span class="k">return</span> <span class="n">model</span>
</span></code></pre></div>
<h3 id="65__results__and__comparisons">6.5 Results and Comparisons<a class="headerlink" href="#65__results__and__comparisons" title="Permanent link">&para;</a></h3>
<p><strong>Comparison Study:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_transfer_learning_strategies</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="sd">    Compare different transfer learning approaches</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>    <span class="c1"># Strategy 1: Train from scratch (baseline)</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Training from scratch...&quot;</span><span class="p">)</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>    <span class="n">scratch_model</span> <span class="o">=</span> <span class="n">MolecularFNN</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>    <span class="n">scratch_history</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">scratch_model</span><span class="p">,</span> <span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;From Scratch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">scratch_model</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a>    <span class="c1"># Strategy 2: Pre-trained autoencoder</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Pre-trained autoencoder + fine-tuning...&quot;</span><span class="p">)</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a>    <span class="c1"># Pre-train on large unlabeled dataset (e.g., ZINC database)</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a>    <span class="n">large_smiles</span> <span class="o">=</span> <span class="n">load_large_dataset</span><span class="p">()</span>  <span class="c1"># Assume 1M molecules</span>
</span><span id="__span-80-17"><a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a>    <span class="n">autoencoder</span> <span class="o">=</span> <span class="n">pretrain_autoencoder</span><span class="p">(</span><span class="n">large_smiles</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-80-18"><a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a>
</span><span id="__span-80-19"><a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a>    <span class="n">transfer_model</span> <span class="o">=</span> <span class="n">PretrainedMolecularModel</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">freeze_encoder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-80-20"><a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a>    <span class="n">transfer_history</span> <span class="o">=</span> <span class="n">fine_tune_pretrained_model</span><span class="p">(</span><span class="n">transfer_model</span><span class="p">,</span> <span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
</span><span id="__span-80-21"><a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a>                                                   <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-80-22"><a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Autoencoder Transfer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">transfer_model</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-80-23"><a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a>
</span><span id="__span-80-24"><a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a>    <span class="c1"># Strategy 3: Multi-task pre-training</span>
</span><span id="__span-80-25"><a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Multi-task pre-training + fine-tuning...&quot;</span><span class="p">)</span>
</span><span id="__span-80-26"><a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a>    <span class="n">multitask_model</span> <span class="o">=</span> <span class="n">pretrain_multitask</span><span class="p">(</span><span class="n">large_smiles</span><span class="p">,</span> <span class="n">properties_dict</span><span class="p">,</span> <span class="n">task_configs</span><span class="p">)</span>
</span><span id="__span-80-27"><a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a>    <span class="n">multitask_transfer</span> <span class="o">=</span> <span class="n">fine_tune_pretrained_model</span><span class="p">(</span><span class="n">multitask_model</span><span class="p">,</span> <span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
</span><span id="__span-80-28"><a id="__codelineno-80-28" name="__codelineno-80-28" href="#__codelineno-80-28"></a>                                                    <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-80-29"><a id="__codelineno-80-29" name="__codelineno-80-29" href="#__codelineno-80-29"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Multi-Task Transfer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">multitask_transfer</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-80-30"><a id="__codelineno-80-30" name="__codelineno-80-30" href="#__codelineno-80-30"></a>
</span><span id="__span-80-31"><a id="__codelineno-80-31" name="__codelineno-80-31" href="#__codelineno-80-31"></a>    <span class="c1"># Strategy 4: ChemBERTa</span>
</span><span id="__span-80-32"><a id="__codelineno-80-32" name="__codelineno-80-32" href="#__codelineno-80-32"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. ChemBERTa fine-tuning...&quot;</span><span class="p">)</span>
</span><span id="__span-80-33"><a id="__codelineno-80-33" name="__codelineno-80-33" href="#__codelineno-80-33"></a>    <span class="n">chemberta_model</span> <span class="o">=</span> <span class="n">ChemBERTaFineTuner</span><span class="p">()</span>
</span><span id="__span-80-34"><a id="__codelineno-80-34" name="__codelineno-80-34" href="#__codelineno-80-34"></a>    <span class="n">chemberta_history</span> <span class="o">=</span> <span class="n">fine_tune_chemberta</span><span class="p">(</span><span class="n">chemberta_model</span><span class="p">,</span> <span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
</span><span id="__span-80-35"><a id="__codelineno-80-35" name="__codelineno-80-35" href="#__codelineno-80-35"></a>                                           <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-80-36"><a id="__codelineno-80-36" name="__codelineno-80-36" href="#__codelineno-80-36"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ChemBERTa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">chemberta_model</span><span class="p">,</span> <span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-80-37"><a id="__codelineno-80-37" name="__codelineno-80-37" href="#__codelineno-80-37"></a>
</span><span id="__span-80-38"><a id="__codelineno-80-38" name="__codelineno-80-38" href="#__codelineno-80-38"></a>    <span class="c1"># Print comparison</span>
</span><span id="__span-80-39"><a id="__codelineno-80-39" name="__codelineno-80-39" href="#__codelineno-80-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-80-40"><a id="__codelineno-80-40" name="__codelineno-80-40" href="#__codelineno-80-40"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TRANSFER LEARNING COMPARISON&quot;</span><span class="p">)</span>
</span><span id="__span-80-41"><a id="__codelineno-80-41" name="__codelineno-80-41" href="#__codelineno-80-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-80-42"><a id="__codelineno-80-42" name="__codelineno-80-42" href="#__codelineno-80-42"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Strategy&#39;</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;RMSE&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;R²&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Training Time&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-80-43"><a id="__codelineno-80-43" name="__codelineno-80-43" href="#__codelineno-80-43"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-80-44"><a id="__codelineno-80-44" name="__codelineno-80-44" href="#__codelineno-80-44"></a>
</span><span id="__span-80-45"><a id="__codelineno-80-45" name="__codelineno-80-45" href="#__codelineno-80-45"></a>    <span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-80-46"><a id="__codelineno-80-46" name="__codelineno-80-46" href="#__codelineno-80-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">strategy</span><span class="si">:</span><span class="s2">&lt;30</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;10.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;R²&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;10.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="__span-80-47"><a id="__codelineno-80-47" name="__codelineno-80-47" href="#__codelineno-80-47"></a>              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;15.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span id="__span-80-48"><a id="__codelineno-80-48" name="__codelineno-80-48" href="#__codelineno-80-48"></a>
</span><span id="__span-80-49"><a id="__codelineno-80-49" name="__codelineno-80-49" href="#__codelineno-80-49"></a>    <span class="k">return</span> <span class="n">results</span>
</span></code></pre></div>
<p><strong>Expected Results (BBB Permeability Example):</strong></p>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>RMSE</th>
<th>R²</th>
<th>Data Required</th>
<th>Training Time</th>
<th>Improvement</th>
</tr>
</thead>
<tbody>
<tr>
<td>From Scratch</td>
<td>0.95</td>
<td>0.68</td>
<td>5,000</td>
<td>120 min</td>
<td>Baseline</td>
</tr>
<tr>
<td>Autoencoder Transfer</td>
<td>0.78</td>
<td>0.79</td>
<td>5,000</td>
<td>45 min</td>
<td>+16%</td>
</tr>
<tr>
<td>Multi-Task Transfer</td>
<td>0.72</td>
<td>0.82</td>
<td>5,000</td>
<td>35 min</td>
<td>+20%</td>
</tr>
<tr>
<td>ChemBERTa</td>
<td>0.65</td>
<td>0.87</td>
<td>5,000</td>
<td>25 min</td>
<td>+28%</td>
</tr>
<tr>
<td>ChemBERTa (Low Data)</td>
<td>0.82</td>
<td>0.75</td>
<td>500</td>
<td>15 min</td>
<td>Still viable</td>
</tr>
</tbody>
</table>
<p><strong>Key Insights:</strong></p>
<ol>
<li>Transfer learning provides 15-30% improvement in performance</li>
<li>Training time reduced by 60-80%</li>
<li>Most effective when target task has limited data (&lt;10K samples)</li>
<li>ChemBERTa performs best due to massive pre-training on 77M molecules</li>
<li>Multi-task pre-training excellent when related properties available</li>
</ol>
<hr />
<h2 id="7__complete__practical__exercise">7. Complete Practical Exercise<a class="headerlink" href="#7__complete__practical__exercise" title="Permanent link">&para;</a></h2>
<h3 id="71__problem__bbb__permeability__prediction">7.1 Problem: BBB Permeability Prediction<a class="headerlink" href="#71__problem__bbb__permeability__prediction" title="Permanent link">&para;</a></h3>
<p><strong>Background:</strong></p>
<p>Blood-Brain Barrier (BBB) permeability is crucial for CNS drugs. We&rsquo;ll predict log(BB), the logarithm of the brain-to-blood concentration ratio.</p>
<p><strong>Dataset:</strong>
- Training: 1,500 molecules
- Validation: 300 molecules
- Test: 200 molecules
- Features: SMILES strings
- Target: log(BB) values (continuous, range: -3 to 2)</p>
<h3 id="72__full__pipeline">7.2 Full Pipeline<a class="headerlink" href="#72__full__pipeline" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="c1"># COMPLETE BBB PERMEABILITY PREDICTION PIPELINE</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
</span><span id="__span-81-12"><a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
</span><span id="__span-81-13"><a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span>
</span><span id="__span-81-14"><a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
</span><span id="__span-81-15"><a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">AllChem</span><span class="p">,</span> <span class="n">Descriptors</span>
</span><span id="__span-81-16"><a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-81-17"><a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
</span><span id="__span-81-18"><a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="__span-81-19"><a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-81-20"><a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a>
</span><span id="__span-81-21"><a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a><span class="c1"># Set random seeds for reproducibility</span>
</span><span id="__span-81-22"><a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-81-23"><a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-81-24"><a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a>
</span><span id="__span-81-25"><a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-26"><a id="__codelineno-81-26" name="__codelineno-81-26" href="#__codelineno-81-26"></a><span class="c1"># 1. DATA LOADING AND PREPROCESSING</span>
</span><span id="__span-81-27"><a id="__codelineno-81-27" name="__codelineno-81-27" href="#__codelineno-81-27"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-28"><a id="__codelineno-81-28" name="__codelineno-81-28" href="#__codelineno-81-28"></a>
</span><span id="__span-81-29"><a id="__codelineno-81-29" name="__codelineno-81-29" href="#__codelineno-81-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_bbb_data</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;bbb_permeability.csv&#39;</span><span class="p">):</span>
</span><span id="__span-81-30"><a id="__codelineno-81-30" name="__codelineno-81-30" href="#__codelineno-81-30"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-31"><a id="__codelineno-81-31" name="__codelineno-81-31" href="#__codelineno-81-31"></a><span class="sd">    Load BBB permeability dataset</span>
</span><span id="__span-81-32"><a id="__codelineno-81-32" name="__codelineno-81-32" href="#__codelineno-81-32"></a>
</span><span id="__span-81-33"><a id="__codelineno-81-33" name="__codelineno-81-33" href="#__codelineno-81-33"></a><span class="sd">    Expected columns: SMILES, logBB</span>
</span><span id="__span-81-34"><a id="__codelineno-81-34" name="__codelineno-81-34" href="#__codelineno-81-34"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-35"><a id="__codelineno-81-35" name="__codelineno-81-35" href="#__codelineno-81-35"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-81-36"><a id="__codelineno-81-36" name="__codelineno-81-36" href="#__codelineno-81-36"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span><span id="__span-81-37"><a id="__codelineno-81-37" name="__codelineno-81-37" href="#__codelineno-81-37"></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="__span-81-38"><a id="__codelineno-81-38" name="__codelineno-81-38" href="#__codelineno-81-38"></a>        <span class="c1"># Generate synthetic data for demonstration</span>
</span><span id="__span-81-39"><a id="__codelineno-81-39" name="__codelineno-81-39" href="#__codelineno-81-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating synthetic BBB data...&quot;</span><span class="p">)</span>
</span><span id="__span-81-40"><a id="__codelineno-81-40" name="__codelineno-81-40" href="#__codelineno-81-40"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">generate_synthetic_bbb_data</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
</span><span id="__span-81-41"><a id="__codelineno-81-41" name="__codelineno-81-41" href="#__codelineno-81-41"></a>
</span><span id="__span-81-42"><a id="__codelineno-81-42" name="__codelineno-81-42" href="#__codelineno-81-42"></a>    <span class="c1"># Remove invalid SMILES</span>
</span><span id="__span-81-43"><a id="__codelineno-81-43" name="__codelineno-81-43" href="#__codelineno-81-43"></a>    <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-81-44"><a id="__codelineno-81-44" name="__codelineno-81-44" href="#__codelineno-81-44"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMILES&#39;</span><span class="p">]):</span>
</span><span id="__span-81-45"><a id="__codelineno-81-45" name="__codelineno-81-45" href="#__codelineno-81-45"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-81-46"><a id="__codelineno-81-46" name="__codelineno-81-46" href="#__codelineno-81-46"></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-81-47"><a id="__codelineno-81-47" name="__codelineno-81-47" href="#__codelineno-81-47"></a>            <span class="n">valid_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="__span-81-48"><a id="__codelineno-81-48" name="__codelineno-81-48" href="#__codelineno-81-48"></a>
</span><span id="__span-81-49"><a id="__codelineno-81-49" name="__codelineno-81-49" href="#__codelineno-81-49"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-81-50"><a id="__codelineno-81-50" name="__codelineno-81-50" href="#__codelineno-81-50"></a>
</span><span id="__span-81-51"><a id="__codelineno-81-51" name="__codelineno-81-51" href="#__codelineno-81-51"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid molecules&quot;</span><span class="p">)</span>
</span><span id="__span-81-52"><a id="__codelineno-81-52" name="__codelineno-81-52" href="#__codelineno-81-52"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;logBB range: [</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;logBB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;logBB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-81-53"><a id="__codelineno-81-53" name="__codelineno-81-53" href="#__codelineno-81-53"></a>
</span><span id="__span-81-54"><a id="__codelineno-81-54" name="__codelineno-81-54" href="#__codelineno-81-54"></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="__span-81-55"><a id="__codelineno-81-55" name="__codelineno-81-55" href="#__codelineno-81-55"></a>
</span><span id="__span-81-56"><a id="__codelineno-81-56" name="__codelineno-81-56" href="#__codelineno-81-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_bbb_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
</span><span id="__span-81-57"><a id="__codelineno-81-57" name="__codelineno-81-57" href="#__codelineno-81-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-58"><a id="__codelineno-81-58" name="__codelineno-81-58" href="#__codelineno-81-58"></a><span class="sd">    Generate synthetic BBB data for demonstration</span>
</span><span id="__span-81-59"><a id="__codelineno-81-59" name="__codelineno-81-59" href="#__codelineno-81-59"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-60"><a id="__codelineno-81-60" name="__codelineno-81-60" href="#__codelineno-81-60"></a>    <span class="c1"># Common drug-like SMILES templates</span>
</span><span id="__span-81-61"><a id="__codelineno-81-61" name="__codelineno-81-61" href="#__codelineno-81-61"></a>    <span class="n">templates</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-81-62"><a id="__codelineno-81-62" name="__codelineno-81-62" href="#__codelineno-81-62"></a>        <span class="s2">&quot;CCO&quot;</span><span class="p">,</span> <span class="s2">&quot;CC(C)O&quot;</span><span class="p">,</span> <span class="s2">&quot;CCCO&quot;</span><span class="p">,</span> <span class="s2">&quot;CC(C)CO&quot;</span><span class="p">,</span> <span class="s2">&quot;CCCCO&quot;</span><span class="p">,</span>
</span><span id="__span-81-63"><a id="__codelineno-81-63" name="__codelineno-81-63" href="#__codelineno-81-63"></a>        <span class="s2">&quot;c1ccccc1&quot;</span><span class="p">,</span> <span class="s2">&quot;c1ccccc1C&quot;</span><span class="p">,</span> <span class="s2">&quot;c1ccccc1O&quot;</span><span class="p">,</span> <span class="s2">&quot;c1ccccc1N&quot;</span><span class="p">,</span>
</span><span id="__span-81-64"><a id="__codelineno-81-64" name="__codelineno-81-64" href="#__codelineno-81-64"></a>        <span class="s2">&quot;CC(=O)O&quot;</span><span class="p">,</span> <span class="s2">&quot;CC(=O)N&quot;</span><span class="p">,</span> <span class="s2">&quot;CCNC&quot;</span><span class="p">,</span> <span class="s2">&quot;CCN(C)C&quot;</span><span class="p">,</span>
</span><span id="__span-81-65"><a id="__codelineno-81-65" name="__codelineno-81-65" href="#__codelineno-81-65"></a>        <span class="s2">&quot;c1ccc(cc1)C(=O)O&quot;</span><span class="p">,</span> <span class="s2">&quot;c1ccc(cc1)N&quot;</span>
</span><span id="__span-81-66"><a id="__codelineno-81-66" name="__codelineno-81-66" href="#__codelineno-81-66"></a>    <span class="p">]</span>
</span><span id="__span-81-67"><a id="__codelineno-81-67" name="__codelineno-81-67" href="#__codelineno-81-67"></a>
</span><span id="__span-81-68"><a id="__codelineno-81-68" name="__codelineno-81-68" href="#__codelineno-81-68"></a>    <span class="n">smiles_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-81-69"><a id="__codelineno-81-69" name="__codelineno-81-69" href="#__codelineno-81-69"></a>    <span class="n">logbb_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-81-70"><a id="__codelineno-81-70" name="__codelineno-81-70" href="#__codelineno-81-70"></a>
</span><span id="__span-81-71"><a id="__codelineno-81-71" name="__codelineno-81-71" href="#__codelineno-81-71"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
</span><span id="__span-81-72"><a id="__codelineno-81-72" name="__codelineno-81-72" href="#__codelineno-81-72"></a>        <span class="c1"># Random combination of templates</span>
</span><span id="__span-81-73"><a id="__codelineno-81-73" name="__codelineno-81-73" href="#__codelineno-81-73"></a>        <span class="n">smiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span>
</span><span id="__span-81-74"><a id="__codelineno-81-74" name="__codelineno-81-74" href="#__codelineno-81-74"></a>
</span><span id="__span-81-75"><a id="__codelineno-81-75" name="__codelineno-81-75" href="#__codelineno-81-75"></a>        <span class="c1"># Calculate simple features for synthetic logBB</span>
</span><span id="__span-81-76"><a id="__codelineno-81-76" name="__codelineno-81-76" href="#__codelineno-81-76"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-81-77"><a id="__codelineno-81-77" name="__codelineno-81-77" href="#__codelineno-81-77"></a>        <span class="k">if</span> <span class="n">mol</span><span class="p">:</span>
</span><span id="__span-81-78"><a id="__codelineno-81-78" name="__codelineno-81-78" href="#__codelineno-81-78"></a>            <span class="n">mw</span> <span class="o">=</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">MolWt</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
</span><span id="__span-81-79"><a id="__codelineno-81-79" name="__codelineno-81-79" href="#__codelineno-81-79"></a>            <span class="n">logp</span> <span class="o">=</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">MolLogP</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
</span><span id="__span-81-80"><a id="__codelineno-81-80" name="__codelineno-81-80" href="#__codelineno-81-80"></a>            <span class="n">tpsa</span> <span class="o">=</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">TPSA</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
</span><span id="__span-81-81"><a id="__codelineno-81-81" name="__codelineno-81-81" href="#__codelineno-81-81"></a>
</span><span id="__span-81-82"><a id="__codelineno-81-82" name="__codelineno-81-82" href="#__codelineno-81-82"></a>            <span class="c1"># Synthetic logBB based on known correlations</span>
</span><span id="__span-81-83"><a id="__codelineno-81-83" name="__codelineno-81-83" href="#__codelineno-81-83"></a>            <span class="n">logbb</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">logp</span> <span class="o">-</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">tpsa</span> <span class="o">-</span> <span class="mf">0.003</span> <span class="o">*</span> <span class="n">mw</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-81-84"><a id="__codelineno-81-84" name="__codelineno-81-84" href="#__codelineno-81-84"></a>            <span class="n">logbb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">logbb</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-81-85"><a id="__codelineno-81-85" name="__codelineno-81-85" href="#__codelineno-81-85"></a>
</span><span id="__span-81-86"><a id="__codelineno-81-86" name="__codelineno-81-86" href="#__codelineno-81-86"></a>            <span class="n">smiles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-81-87"><a id="__codelineno-81-87" name="__codelineno-81-87" href="#__codelineno-81-87"></a>            <span class="n">logbb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logbb</span><span class="p">)</span>
</span><span id="__span-81-88"><a id="__codelineno-81-88" name="__codelineno-81-88" href="#__codelineno-81-88"></a>
</span><span id="__span-81-89"><a id="__codelineno-81-89" name="__codelineno-81-89" href="#__codelineno-81-89"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;SMILES&#39;</span><span class="p">:</span> <span class="n">smiles_list</span><span class="p">,</span> <span class="s1">&#39;logBB&#39;</span><span class="p">:</span> <span class="n">logbb_list</span><span class="p">})</span>
</span><span id="__span-81-90"><a id="__codelineno-81-90" name="__codelineno-81-90" href="#__codelineno-81-90"></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="__span-81-91"><a id="__codelineno-81-91" name="__codelineno-81-91" href="#__codelineno-81-91"></a>
</span><span id="__span-81-92"><a id="__codelineno-81-92" name="__codelineno-81-92" href="#__codelineno-81-92"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-93"><a id="__codelineno-81-93" name="__codelineno-81-93" href="#__codelineno-81-93"></a><span class="c1"># 2. FEATURE EXTRACTION</span>
</span><span id="__span-81-94"><a id="__codelineno-81-94" name="__codelineno-81-94" href="#__codelineno-81-94"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-95"><a id="__codelineno-81-95" name="__codelineno-81-95" href="#__codelineno-81-95"></a>
</span><span id="__span-81-96"><a id="__codelineno-81-96" name="__codelineno-81-96" href="#__codelineno-81-96"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_molecular_fingerprints</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_bits</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
</span><span id="__span-81-97"><a id="__codelineno-81-97" name="__codelineno-81-97" href="#__codelineno-81-97"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-98"><a id="__codelineno-81-98" name="__codelineno-81-98" href="#__codelineno-81-98"></a><span class="sd">    Compute Morgan fingerprints for molecules</span>
</span><span id="__span-81-99"><a id="__codelineno-81-99" name="__codelineno-81-99" href="#__codelineno-81-99"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-100"><a id="__codelineno-81-100" name="__codelineno-81-100" href="#__codelineno-81-100"></a>    <span class="n">fingerprints</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-81-101"><a id="__codelineno-81-101" name="__codelineno-81-101" href="#__codelineno-81-101"></a>
</span><span id="__span-81-102"><a id="__codelineno-81-102" name="__codelineno-81-102" href="#__codelineno-81-102"></a>    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing fingerprints&quot;</span><span class="p">):</span>
</span><span id="__span-81-103"><a id="__codelineno-81-103" name="__codelineno-81-103" href="#__codelineno-81-103"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-81-104"><a id="__codelineno-81-104" name="__codelineno-81-104" href="#__codelineno-81-104"></a>        <span class="k">if</span> <span class="n">mol</span><span class="p">:</span>
</span><span id="__span-81-105"><a id="__codelineno-81-105" name="__codelineno-81-105" href="#__codelineno-81-105"></a>            <span class="n">fp</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">nBits</span><span class="o">=</span><span class="n">n_bits</span><span class="p">)</span>
</span><span id="__span-81-106"><a id="__codelineno-81-106" name="__codelineno-81-106" href="#__codelineno-81-106"></a>            <span class="n">fingerprints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span><span id="__span-81-107"><a id="__codelineno-81-107" name="__codelineno-81-107" href="#__codelineno-81-107"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-81-108"><a id="__codelineno-81-108" name="__codelineno-81-108" href="#__codelineno-81-108"></a>            <span class="n">fingerprints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bits</span><span class="p">))</span>
</span><span id="__span-81-109"><a id="__codelineno-81-109" name="__codelineno-81-109" href="#__codelineno-81-109"></a>
</span><span id="__span-81-110"><a id="__codelineno-81-110" name="__codelineno-81-110" href="#__codelineno-81-110"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fingerprints</span><span class="p">)</span>
</span><span id="__span-81-111"><a id="__codelineno-81-111" name="__codelineno-81-111" href="#__codelineno-81-111"></a>
</span><span id="__span-81-112"><a id="__codelineno-81-112" name="__codelineno-81-112" href="#__codelineno-81-112"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_molecular_descriptors</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">):</span>
</span><span id="__span-81-113"><a id="__codelineno-81-113" name="__codelineno-81-113" href="#__codelineno-81-113"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-114"><a id="__codelineno-81-114" name="__codelineno-81-114" href="#__codelineno-81-114"></a><span class="sd">    Compute RDKit molecular descriptors</span>
</span><span id="__span-81-115"><a id="__codelineno-81-115" name="__codelineno-81-115" href="#__codelineno-81-115"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-116"><a id="__codelineno-81-116" name="__codelineno-81-116" href="#__codelineno-81-116"></a>    <span class="n">descriptors_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-81-117"><a id="__codelineno-81-117" name="__codelineno-81-117" href="#__codelineno-81-117"></a>
</span><span id="__span-81-118"><a id="__codelineno-81-118" name="__codelineno-81-118" href="#__codelineno-81-118"></a>    <span class="n">descriptor_functions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-81-119"><a id="__codelineno-81-119" name="__codelineno-81-119" href="#__codelineno-81-119"></a>        <span class="n">Descriptors</span><span class="o">.</span><span class="n">MolWt</span><span class="p">,</span>
</span><span id="__span-81-120"><a id="__codelineno-81-120" name="__codelineno-81-120" href="#__codelineno-81-120"></a>        <span class="n">Descriptors</span><span class="o">.</span><span class="n">MolLogP</span><span class="p">,</span>
</span><span id="__span-81-121"><a id="__codelineno-81-121" name="__codelineno-81-121" href="#__codelineno-81-121"></a>        <span class="n">Descriptors</span><span class="o">.</span><span class="n">NumHDonors</span><span class="p">,</span>
</span><span id="__span-81-122"><a id="__codelineno-81-122" name="__codelineno-81-122" href="#__codelineno-81-122"></a>        <span class="n">Descriptors</span><span class="o">.</span><span class="n">NumHAcceptors</span><span class="p">,</span>
</span><span id="__span-81-123"><a id="__codelineno-81-123" name="__codelineno-81-123" href="#__codelineno-81-123"></a>        <span class="n">Descriptors</span><span class="o">.</span><span class="n">TPSA</span><span class="p">,</span>
</span><span id="__span-81-124"><a id="__codelineno-81-124" name="__codelineno-81-124" href="#__codelineno-81-124"></a>        <span class="n">Descriptors</span><span class="o">.</span><span class="n">NumRotatableBonds</span><span class="p">,</span>
</span><span id="__span-81-125"><a id="__codelineno-81-125" name="__codelineno-81-125" href="#__codelineno-81-125"></a>        <span class="n">Descriptors</span><span class="o">.</span><span class="n">NumAromaticRings</span><span class="p">,</span>
</span><span id="__span-81-126"><a id="__codelineno-81-126" name="__codelineno-81-126" href="#__codelineno-81-126"></a>        <span class="n">Descriptors</span><span class="o">.</span><span class="n">FractionCsp3</span>
</span><span id="__span-81-127"><a id="__codelineno-81-127" name="__codelineno-81-127" href="#__codelineno-81-127"></a>    <span class="p">]</span>
</span><span id="__span-81-128"><a id="__codelineno-81-128" name="__codelineno-81-128" href="#__codelineno-81-128"></a>
</span><span id="__span-81-129"><a id="__codelineno-81-129" name="__codelineno-81-129" href="#__codelineno-81-129"></a>    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing descriptors&quot;</span><span class="p">):</span>
</span><span id="__span-81-130"><a id="__codelineno-81-130" name="__codelineno-81-130" href="#__codelineno-81-130"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-81-131"><a id="__codelineno-81-131" name="__codelineno-81-131" href="#__codelineno-81-131"></a>        <span class="k">if</span> <span class="n">mol</span><span class="p">:</span>
</span><span id="__span-81-132"><a id="__codelineno-81-132" name="__codelineno-81-132" href="#__codelineno-81-132"></a>            <span class="n">desc</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">descriptor_functions</span><span class="p">]</span>
</span><span id="__span-81-133"><a id="__codelineno-81-133" name="__codelineno-81-133" href="#__codelineno-81-133"></a>            <span class="n">descriptors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
</span><span id="__span-81-134"><a id="__codelineno-81-134" name="__codelineno-81-134" href="#__codelineno-81-134"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-81-135"><a id="__codelineno-81-135" name="__codelineno-81-135" href="#__codelineno-81-135"></a>            <span class="n">descriptors_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">descriptor_functions</span><span class="p">))</span>
</span><span id="__span-81-136"><a id="__codelineno-81-136" name="__codelineno-81-136" href="#__codelineno-81-136"></a>
</span><span id="__span-81-137"><a id="__codelineno-81-137" name="__codelineno-81-137" href="#__codelineno-81-137"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">descriptors_list</span><span class="p">)</span>
</span><span id="__span-81-138"><a id="__codelineno-81-138" name="__codelineno-81-138" href="#__codelineno-81-138"></a>
</span><span id="__span-81-139"><a id="__codelineno-81-139" name="__codelineno-81-139" href="#__codelineno-81-139"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-140"><a id="__codelineno-81-140" name="__codelineno-81-140" href="#__codelineno-81-140"></a><span class="c1"># 3. DEEP LEARNING MODEL</span>
</span><span id="__span-81-141"><a id="__codelineno-81-141" name="__codelineno-81-141" href="#__codelineno-81-141"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-142"><a id="__codelineno-81-142" name="__codelineno-81-142" href="#__codelineno-81-142"></a>
</span><span id="__span-81-143"><a id="__codelineno-81-143" name="__codelineno-81-143" href="#__codelineno-81-143"></a><span class="k">class</span><span class="w"> </span><span class="nc">BBBPermeabilityModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-81-144"><a id="__codelineno-81-144" name="__codelineno-81-144" href="#__codelineno-81-144"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-145"><a id="__codelineno-81-145" name="__codelineno-81-145" href="#__codelineno-81-145"></a><span class="sd">    Neural network for BBB permeability prediction</span>
</span><span id="__span-81-146"><a id="__codelineno-81-146" name="__codelineno-81-146" href="#__codelineno-81-146"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-147"><a id="__codelineno-81-147" name="__codelineno-81-147" href="#__codelineno-81-147"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
</span><span id="__span-81-148"><a id="__codelineno-81-148" name="__codelineno-81-148" href="#__codelineno-81-148"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BBBPermeabilityModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-81-149"><a id="__codelineno-81-149" name="__codelineno-81-149" href="#__codelineno-81-149"></a>
</span><span id="__span-81-150"><a id="__codelineno-81-150" name="__codelineno-81-150" href="#__codelineno-81-150"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="__span-81-151"><a id="__codelineno-81-151" name="__codelineno-81-151" href="#__codelineno-81-151"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
</span><span id="__span-81-152"><a id="__codelineno-81-152" name="__codelineno-81-152" href="#__codelineno-81-152"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
</span><span id="__span-81-153"><a id="__codelineno-81-153" name="__codelineno-81-153" href="#__codelineno-81-153"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-81-154"><a id="__codelineno-81-154" name="__codelineno-81-154" href="#__codelineno-81-154"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
</span><span id="__span-81-155"><a id="__codelineno-81-155" name="__codelineno-81-155" href="#__codelineno-81-155"></a>
</span><span id="__span-81-156"><a id="__codelineno-81-156" name="__codelineno-81-156" href="#__codelineno-81-156"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
</span><span id="__span-81-157"><a id="__codelineno-81-157" name="__codelineno-81-157" href="#__codelineno-81-157"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span><span id="__span-81-158"><a id="__codelineno-81-158" name="__codelineno-81-158" href="#__codelineno-81-158"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-81-159"><a id="__codelineno-81-159" name="__codelineno-81-159" href="#__codelineno-81-159"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
</span><span id="__span-81-160"><a id="__codelineno-81-160" name="__codelineno-81-160" href="#__codelineno-81-160"></a>
</span><span id="__span-81-161"><a id="__codelineno-81-161" name="__codelineno-81-161" href="#__codelineno-81-161"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
</span><span id="__span-81-162"><a id="__codelineno-81-162" name="__codelineno-81-162" href="#__codelineno-81-162"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
</span><span id="__span-81-163"><a id="__codelineno-81-163" name="__codelineno-81-163" href="#__codelineno-81-163"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-81-164"><a id="__codelineno-81-164" name="__codelineno-81-164" href="#__codelineno-81-164"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
</span><span id="__span-81-165"><a id="__codelineno-81-165" name="__codelineno-81-165" href="#__codelineno-81-165"></a>
</span><span id="__span-81-166"><a id="__codelineno-81-166" name="__codelineno-81-166" href="#__codelineno-81-166"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-81-167"><a id="__codelineno-81-167" name="__codelineno-81-167" href="#__codelineno-81-167"></a>        <span class="p">)</span>
</span><span id="__span-81-168"><a id="__codelineno-81-168" name="__codelineno-81-168" href="#__codelineno-81-168"></a>
</span><span id="__span-81-169"><a id="__codelineno-81-169" name="__codelineno-81-169" href="#__codelineno-81-169"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-81-170"><a id="__codelineno-81-170" name="__codelineno-81-170" href="#__codelineno-81-170"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-81-171"><a id="__codelineno-81-171" name="__codelineno-81-171" href="#__codelineno-81-171"></a>
</span><span id="__span-81-172"><a id="__codelineno-81-172" name="__codelineno-81-172" href="#__codelineno-81-172"></a><span class="k">class</span><span class="w"> </span><span class="nc">BBBDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="__span-81-173"><a id="__codelineno-81-173" name="__codelineno-81-173" href="#__codelineno-81-173"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataset for BBB permeability&quot;&quot;&quot;</span>
</span><span id="__span-81-174"><a id="__codelineno-81-174" name="__codelineno-81-174" href="#__codelineno-81-174"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span><span id="__span-81-175"><a id="__codelineno-81-175" name="__codelineno-81-175" href="#__codelineno-81-175"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</span><span id="__span-81-176"><a id="__codelineno-81-176" name="__codelineno-81-176" href="#__codelineno-81-176"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-81-177"><a id="__codelineno-81-177" name="__codelineno-81-177" href="#__codelineno-81-177"></a>
</span><span id="__span-81-178"><a id="__codelineno-81-178" name="__codelineno-81-178" href="#__codelineno-81-178"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-81-179"><a id="__codelineno-81-179" name="__codelineno-81-179" href="#__codelineno-81-179"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
</span><span id="__span-81-180"><a id="__codelineno-81-180" name="__codelineno-81-180" href="#__codelineno-81-180"></a>
</span><span id="__span-81-181"><a id="__codelineno-81-181" name="__codelineno-81-181" href="#__codelineno-81-181"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="__span-81-182"><a id="__codelineno-81-182" name="__codelineno-81-182" href="#__codelineno-81-182"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="__span-81-183"><a id="__codelineno-81-183" name="__codelineno-81-183" href="#__codelineno-81-183"></a>
</span><span id="__span-81-184"><a id="__codelineno-81-184" name="__codelineno-81-184" href="#__codelineno-81-184"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-185"><a id="__codelineno-81-185" name="__codelineno-81-185" href="#__codelineno-81-185"></a><span class="c1"># 4. TRAINING FUNCTION</span>
</span><span id="__span-81-186"><a id="__codelineno-81-186" name="__codelineno-81-186" href="#__codelineno-81-186"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-187"><a id="__codelineno-81-187" name="__codelineno-81-187" href="#__codelineno-81-187"></a>
</span><span id="__span-81-188"><a id="__codelineno-81-188" name="__codelineno-81-188" href="#__codelineno-81-188"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_deep_learning_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> 
</span><span id="__span-81-189"><a id="__codelineno-81-189" name="__codelineno-81-189" href="#__codelineno-81-189"></a>                              <span class="n">num_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
</span><span id="__span-81-190"><a id="__codelineno-81-190" name="__codelineno-81-190" href="#__codelineno-81-190"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-191"><a id="__codelineno-81-191" name="__codelineno-81-191" href="#__codelineno-81-191"></a><span class="sd">    Train deep learning model for BBB permeability</span>
</span><span id="__span-81-192"><a id="__codelineno-81-192" name="__codelineno-81-192" href="#__codelineno-81-192"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-193"><a id="__codelineno-81-193" name="__codelineno-81-193" href="#__codelineno-81-193"></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="__span-81-194"><a id="__codelineno-81-194" name="__codelineno-81-194" href="#__codelineno-81-194"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-195"><a id="__codelineno-81-195" name="__codelineno-81-195" href="#__codelineno-81-195"></a>
</span><span id="__span-81-196"><a id="__codelineno-81-196" name="__codelineno-81-196" href="#__codelineno-81-196"></a>    <span class="c1"># Create datasets and dataloaders</span>
</span><span id="__span-81-197"><a id="__codelineno-81-197" name="__codelineno-81-197" href="#__codelineno-81-197"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">BBBDataset</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</span><span id="__span-81-198"><a id="__codelineno-81-198" name="__codelineno-81-198" href="#__codelineno-81-198"></a>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">BBBDataset</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-81-199"><a id="__codelineno-81-199" name="__codelineno-81-199" href="#__codelineno-81-199"></a>
</span><span id="__span-81-200"><a id="__codelineno-81-200" name="__codelineno-81-200" href="#__codelineno-81-200"></a>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-81-201"><a id="__codelineno-81-201" name="__codelineno-81-201" href="#__codelineno-81-201"></a>    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="__span-81-202"><a id="__codelineno-81-202" name="__codelineno-81-202" href="#__codelineno-81-202"></a>
</span><span id="__span-81-203"><a id="__codelineno-81-203" name="__codelineno-81-203" href="#__codelineno-81-203"></a>    <span class="c1"># Initialize model</span>
</span><span id="__span-81-204"><a id="__codelineno-81-204" name="__codelineno-81-204" href="#__codelineno-81-204"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">BBBPermeabilityModel</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-81-205"><a id="__codelineno-81-205" name="__codelineno-81-205" href="#__codelineno-81-205"></a>
</span><span id="__span-81-206"><a id="__codelineno-81-206" name="__codelineno-81-206" href="#__codelineno-81-206"></a>    <span class="c1"># Loss and optimizer</span>
</span><span id="__span-81-207"><a id="__codelineno-81-207" name="__codelineno-81-207" href="#__codelineno-81-207"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-81-208"><a id="__codelineno-81-208" name="__codelineno-81-208" href="#__codelineno-81-208"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span><span id="__span-81-209"><a id="__codelineno-81-209" name="__codelineno-81-209" href="#__codelineno-81-209"></a>    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-81-210"><a id="__codelineno-81-210" name="__codelineno-81-210" href="#__codelineno-81-210"></a>
</span><span id="__span-81-211"><a id="__codelineno-81-211" name="__codelineno-81-211" href="#__codelineno-81-211"></a>    <span class="c1"># Training history</span>
</span><span id="__span-81-212"><a id="__codelineno-81-212" name="__codelineno-81-212" href="#__codelineno-81-212"></a>    <span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-81-213"><a id="__codelineno-81-213" name="__codelineno-81-213" href="#__codelineno-81-213"></a>        <span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-81-214"><a id="__codelineno-81-214" name="__codelineno-81-214" href="#__codelineno-81-214"></a>        <span class="s1">&#39;val_rmse&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_mae&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_r2&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="__span-81-215"><a id="__codelineno-81-215" name="__codelineno-81-215" href="#__codelineno-81-215"></a>    <span class="p">}</span>
</span><span id="__span-81-216"><a id="__codelineno-81-216" name="__codelineno-81-216" href="#__codelineno-81-216"></a>
</span><span id="__span-81-217"><a id="__codelineno-81-217" name="__codelineno-81-217" href="#__codelineno-81-217"></a>    <span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="__span-81-218"><a id="__codelineno-81-218" name="__codelineno-81-218" href="#__codelineno-81-218"></a>    <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-81-219"><a id="__codelineno-81-219" name="__codelineno-81-219" href="#__codelineno-81-219"></a>    <span class="n">patience</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="__span-81-220"><a id="__codelineno-81-220" name="__codelineno-81-220" href="#__codelineno-81-220"></a>
</span><span id="__span-81-221"><a id="__codelineno-81-221" name="__codelineno-81-221" href="#__codelineno-81-221"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-81-222"><a id="__codelineno-81-222" name="__codelineno-81-222" href="#__codelineno-81-222"></a>
</span><span id="__span-81-223"><a id="__codelineno-81-223" name="__codelineno-81-223" href="#__codelineno-81-223"></a>    <span class="c1"># Training loop</span>
</span><span id="__span-81-224"><a id="__codelineno-81-224" name="__codelineno-81-224" href="#__codelineno-81-224"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
</span><span id="__span-81-225"><a id="__codelineno-81-225" name="__codelineno-81-225" href="#__codelineno-81-225"></a>        <span class="c1"># Training</span>
</span><span id="__span-81-226"><a id="__codelineno-81-226" name="__codelineno-81-226" href="#__codelineno-81-226"></a>        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-81-227"><a id="__codelineno-81-227" name="__codelineno-81-227" href="#__codelineno-81-227"></a>        <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-81-228"><a id="__codelineno-81-228" name="__codelineno-81-228" href="#__codelineno-81-228"></a>
</span><span id="__span-81-229"><a id="__codelineno-81-229" name="__codelineno-81-229" href="#__codelineno-81-229"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
</span><span id="__span-81-230"><a id="__codelineno-81-230" name="__codelineno-81-230" href="#__codelineno-81-230"></a>            <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">batch_y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-81-231"><a id="__codelineno-81-231" name="__codelineno-81-231" href="#__codelineno-81-231"></a>
</span><span id="__span-81-232"><a id="__codelineno-81-232" name="__codelineno-81-232" href="#__codelineno-81-232"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-81-233"><a id="__codelineno-81-233" name="__codelineno-81-233" href="#__codelineno-81-233"></a>            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-81-234"><a id="__codelineno-81-234" name="__codelineno-81-234" href="#__codelineno-81-234"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-81-235"><a id="__codelineno-81-235" name="__codelineno-81-235" href="#__codelineno-81-235"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-81-236"><a id="__codelineno-81-236" name="__codelineno-81-236" href="#__codelineno-81-236"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-81-237"><a id="__codelineno-81-237" name="__codelineno-81-237" href="#__codelineno-81-237"></a>
</span><span id="__span-81-238"><a id="__codelineno-81-238" name="__codelineno-81-238" href="#__codelineno-81-238"></a>            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-81-239"><a id="__codelineno-81-239" name="__codelineno-81-239" href="#__codelineno-81-239"></a>
</span><span id="__span-81-240"><a id="__codelineno-81-240" name="__codelineno-81-240" href="#__codelineno-81-240"></a>        <span class="c1"># Validation</span>
</span><span id="__span-81-241"><a id="__codelineno-81-241" name="__codelineno-81-241" href="#__codelineno-81-241"></a>        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-81-242"><a id="__codelineno-81-242" name="__codelineno-81-242" href="#__codelineno-81-242"></a>        <span class="n">val_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-81-243"><a id="__codelineno-81-243" name="__codelineno-81-243" href="#__codelineno-81-243"></a>        <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-81-244"><a id="__codelineno-81-244" name="__codelineno-81-244" href="#__codelineno-81-244"></a>        <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-81-245"><a id="__codelineno-81-245" name="__codelineno-81-245" href="#__codelineno-81-245"></a>
</span><span id="__span-81-246"><a id="__codelineno-81-246" name="__codelineno-81-246" href="#__codelineno-81-246"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-81-247"><a id="__codelineno-81-247" name="__codelineno-81-247" href="#__codelineno-81-247"></a>            <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
</span><span id="__span-81-248"><a id="__codelineno-81-248" name="__codelineno-81-248" href="#__codelineno-81-248"></a>                <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">batch_y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-81-249"><a id="__codelineno-81-249" name="__codelineno-81-249" href="#__codelineno-81-249"></a>                <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-81-250"><a id="__codelineno-81-250" name="__codelineno-81-250" href="#__codelineno-81-250"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-81-251"><a id="__codelineno-81-251" name="__codelineno-81-251" href="#__codelineno-81-251"></a>
</span><span id="__span-81-252"><a id="__codelineno-81-252" name="__codelineno-81-252" href="#__codelineno-81-252"></a>                <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-81-253"><a id="__codelineno-81-253" name="__codelineno-81-253" href="#__codelineno-81-253"></a>                <span class="n">all_preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-81-254"><a id="__codelineno-81-254" name="__codelineno-81-254" href="#__codelineno-81-254"></a>                <span class="n">all_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-81-255"><a id="__codelineno-81-255" name="__codelineno-81-255" href="#__codelineno-81-255"></a>
</span><span id="__span-81-256"><a id="__codelineno-81-256" name="__codelineno-81-256" href="#__codelineno-81-256"></a>        <span class="c1"># Calculate metrics</span>
</span><span id="__span-81-257"><a id="__codelineno-81-257" name="__codelineno-81-257" href="#__codelineno-81-257"></a>        <span class="n">train_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
</span><span id="__span-81-258"><a id="__codelineno-81-258" name="__codelineno-81-258" href="#__codelineno-81-258"></a>        <span class="n">val_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
</span><span id="__span-81-259"><a id="__codelineno-81-259" name="__codelineno-81-259" href="#__codelineno-81-259"></a>
</span><span id="__span-81-260"><a id="__codelineno-81-260" name="__codelineno-81-260" href="#__codelineno-81-260"></a>        <span class="n">all_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_preds</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-81-261"><a id="__codelineno-81-261" name="__codelineno-81-261" href="#__codelineno-81-261"></a>        <span class="n">all_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-81-262"><a id="__codelineno-81-262" name="__codelineno-81-262" href="#__codelineno-81-262"></a>
</span><span id="__span-81-263"><a id="__codelineno-81-263" name="__codelineno-81-263" href="#__codelineno-81-263"></a>        <span class="n">val_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">))</span>
</span><span id="__span-81-264"><a id="__codelineno-81-264" name="__codelineno-81-264" href="#__codelineno-81-264"></a>        <span class="n">val_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">)</span>
</span><span id="__span-81-265"><a id="__codelineno-81-265" name="__codelineno-81-265" href="#__codelineno-81-265"></a>        <span class="n">val_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">)</span>
</span><span id="__span-81-266"><a id="__codelineno-81-266" name="__codelineno-81-266" href="#__codelineno-81-266"></a>
</span><span id="__span-81-267"><a id="__codelineno-81-267" name="__codelineno-81-267" href="#__codelineno-81-267"></a>        <span class="c1"># Update history</span>
</span><span id="__span-81-268"><a id="__codelineno-81-268" name="__codelineno-81-268" href="#__codelineno-81-268"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
</span><span id="__span-81-269"><a id="__codelineno-81-269" name="__codelineno-81-269" href="#__codelineno-81-269"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-81-270"><a id="__codelineno-81-270" name="__codelineno-81-270" href="#__codelineno-81-270"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_rmse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_rmse</span><span class="p">)</span>
</span><span id="__span-81-271"><a id="__codelineno-81-271" name="__codelineno-81-271" href="#__codelineno-81-271"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_mae</span><span class="p">)</span>
</span><span id="__span-81-272"><a id="__codelineno-81-272" name="__codelineno-81-272" href="#__codelineno-81-272"></a>        <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_r2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_r2</span><span class="p">)</span>
</span><span id="__span-81-273"><a id="__codelineno-81-273" name="__codelineno-81-273" href="#__codelineno-81-273"></a>
</span><span id="__span-81-274"><a id="__codelineno-81-274" name="__codelineno-81-274" href="#__codelineno-81-274"></a>        <span class="c1"># Learning rate scheduling</span>
</span><span id="__span-81-275"><a id="__codelineno-81-275" name="__codelineno-81-275" href="#__codelineno-81-275"></a>        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-81-276"><a id="__codelineno-81-276" name="__codelineno-81-276" href="#__codelineno-81-276"></a>
</span><span id="__span-81-277"><a id="__codelineno-81-277" name="__codelineno-81-277" href="#__codelineno-81-277"></a>        <span class="c1"># Print progress</span>
</span><span id="__span-81-278"><a id="__codelineno-81-278" name="__codelineno-81-278" href="#__codelineno-81-278"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-81-279"><a id="__codelineno-81-279" name="__codelineno-81-279" href="#__codelineno-81-279"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-280"><a id="__codelineno-81-280" name="__codelineno-81-280" href="#__codelineno-81-280"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-281"><a id="__codelineno-81-281" name="__codelineno-81-281" href="#__codelineno-81-281"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val Loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, RMSE: </span><span class="si">{</span><span class="n">val_rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="__span-81-282"><a id="__codelineno-81-282" name="__codelineno-81-282" href="#__codelineno-81-282"></a>                  <span class="sa">f</span><span class="s2">&quot;MAE: </span><span class="si">{</span><span class="n">val_mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, R²: </span><span class="si">{</span><span class="n">val_r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-283"><a id="__codelineno-81-283" name="__codelineno-81-283" href="#__codelineno-81-283"></a>
</span><span id="__span-81-284"><a id="__codelineno-81-284" name="__codelineno-81-284" href="#__codelineno-81-284"></a>        <span class="c1"># Early stopping</span>
</span><span id="__span-81-285"><a id="__codelineno-81-285" name="__codelineno-81-285" href="#__codelineno-81-285"></a>        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
</span><span id="__span-81-286"><a id="__codelineno-81-286" name="__codelineno-81-286" href="#__codelineno-81-286"></a>            <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
</span><span id="__span-81-287"><a id="__codelineno-81-287" name="__codelineno-81-287" href="#__codelineno-81-287"></a>            <span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-81-288"><a id="__codelineno-81-288" name="__codelineno-81-288" href="#__codelineno-81-288"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;best_bbb_model.pth&#39;</span><span class="p">)</span>
</span><span id="__span-81-289"><a id="__codelineno-81-289" name="__codelineno-81-289" href="#__codelineno-81-289"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-81-290"><a id="__codelineno-81-290" name="__codelineno-81-290" href="#__codelineno-81-290"></a>            <span class="n">patience_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-81-291"><a id="__codelineno-81-291" name="__codelineno-81-291" href="#__codelineno-81-291"></a>            <span class="k">if</span> <span class="n">patience_counter</span> <span class="o">&gt;=</span> <span class="n">patience</span><span class="p">:</span>
</span><span id="__span-81-292"><a id="__codelineno-81-292" name="__codelineno-81-292" href="#__codelineno-81-292"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Early stopping at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-293"><a id="__codelineno-81-293" name="__codelineno-81-293" href="#__codelineno-81-293"></a>                <span class="k">break</span>
</span><span id="__span-81-294"><a id="__codelineno-81-294" name="__codelineno-81-294" href="#__codelineno-81-294"></a>
</span><span id="__span-81-295"><a id="__codelineno-81-295" name="__codelineno-81-295" href="#__codelineno-81-295"></a>    <span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-81-296"><a id="__codelineno-81-296" name="__codelineno-81-296" href="#__codelineno-81-296"></a>
</span><span id="__span-81-297"><a id="__codelineno-81-297" name="__codelineno-81-297" href="#__codelineno-81-297"></a>    <span class="c1"># Load best model</span>
</span><span id="__span-81-298"><a id="__codelineno-81-298" name="__codelineno-81-298" href="#__codelineno-81-298"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;best_bbb_model.pth&#39;</span><span class="p">))</span>
</span><span id="__span-81-299"><a id="__codelineno-81-299" name="__codelineno-81-299" href="#__codelineno-81-299"></a>
</span><span id="__span-81-300"><a id="__codelineno-81-300" name="__codelineno-81-300" href="#__codelineno-81-300"></a>    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">training_time</span>
</span><span id="__span-81-301"><a id="__codelineno-81-301" name="__codelineno-81-301" href="#__codelineno-81-301"></a>
</span><span id="__span-81-302"><a id="__codelineno-81-302" name="__codelineno-81-302" href="#__codelineno-81-302"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-303"><a id="__codelineno-81-303" name="__codelineno-81-303" href="#__codelineno-81-303"></a><span class="c1"># 5. RANDOM FOREST BASELINE</span>
</span><span id="__span-81-304"><a id="__codelineno-81-304" name="__codelineno-81-304" href="#__codelineno-81-304"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-305"><a id="__codelineno-81-305" name="__codelineno-81-305" href="#__codelineno-81-305"></a>
</span><span id="__span-81-306"><a id="__codelineno-81-306" name="__codelineno-81-306" href="#__codelineno-81-306"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_random_forest_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
</span><span id="__span-81-307"><a id="__codelineno-81-307" name="__codelineno-81-307" href="#__codelineno-81-307"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-308"><a id="__codelineno-81-308" name="__codelineno-81-308" href="#__codelineno-81-308"></a><span class="sd">    Train Random Forest baseline model</span>
</span><span id="__span-81-309"><a id="__codelineno-81-309" name="__codelineno-81-309" href="#__codelineno-81-309"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-310"><a id="__codelineno-81-310" name="__codelineno-81-310" href="#__codelineno-81-310"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-81-311"><a id="__codelineno-81-311" name="__codelineno-81-311" href="#__codelineno-81-311"></a>
</span><span id="__span-81-312"><a id="__codelineno-81-312" name="__codelineno-81-312" href="#__codelineno-81-312"></a>    <span class="c1"># Train Random Forest</span>
</span><span id="__span-81-313"><a id="__codelineno-81-313" name="__codelineno-81-313" href="#__codelineno-81-313"></a>    <span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
</span><span id="__span-81-314"><a id="__codelineno-81-314" name="__codelineno-81-314" href="#__codelineno-81-314"></a>        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
</span><span id="__span-81-315"><a id="__codelineno-81-315" name="__codelineno-81-315" href="#__codelineno-81-315"></a>        <span class="n">max_depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span id="__span-81-316"><a id="__codelineno-81-316" name="__codelineno-81-316" href="#__codelineno-81-316"></a>        <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-81-317"><a id="__codelineno-81-317" name="__codelineno-81-317" href="#__codelineno-81-317"></a>        <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-81-318"><a id="__codelineno-81-318" name="__codelineno-81-318" href="#__codelineno-81-318"></a>        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="__span-81-319"><a id="__codelineno-81-319" name="__codelineno-81-319" href="#__codelineno-81-319"></a>        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
</span><span id="__span-81-320"><a id="__codelineno-81-320" name="__codelineno-81-320" href="#__codelineno-81-320"></a>    <span class="p">)</span>
</span><span id="__span-81-321"><a id="__codelineno-81-321" name="__codelineno-81-321" href="#__codelineno-81-321"></a>
</span><span id="__span-81-322"><a id="__codelineno-81-322" name="__codelineno-81-322" href="#__codelineno-81-322"></a>    <span class="n">rf_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</span><span id="__span-81-323"><a id="__codelineno-81-323" name="__codelineno-81-323" href="#__codelineno-81-323"></a>
</span><span id="__span-81-324"><a id="__codelineno-81-324" name="__codelineno-81-324" href="#__codelineno-81-324"></a>    <span class="c1"># Predictions</span>
</span><span id="__span-81-325"><a id="__codelineno-81-325" name="__codelineno-81-325" href="#__codelineno-81-325"></a>    <span class="n">train_pred</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</span><span id="__span-81-326"><a id="__codelineno-81-326" name="__codelineno-81-326" href="#__codelineno-81-326"></a>    <span class="n">val_pred</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
</span><span id="__span-81-327"><a id="__codelineno-81-327" name="__codelineno-81-327" href="#__codelineno-81-327"></a>
</span><span id="__span-81-328"><a id="__codelineno-81-328" name="__codelineno-81-328" href="#__codelineno-81-328"></a>    <span class="c1"># Metrics</span>
</span><span id="__span-81-329"><a id="__codelineno-81-329" name="__codelineno-81-329" href="#__codelineno-81-329"></a>    <span class="n">train_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">train_pred</span><span class="p">))</span>
</span><span id="__span-81-330"><a id="__codelineno-81-330" name="__codelineno-81-330" href="#__codelineno-81-330"></a>    <span class="n">val_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">val_pred</span><span class="p">))</span>
</span><span id="__span-81-331"><a id="__codelineno-81-331" name="__codelineno-81-331" href="#__codelineno-81-331"></a>    <span class="n">val_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">val_pred</span><span class="p">)</span>
</span><span id="__span-81-332"><a id="__codelineno-81-332" name="__codelineno-81-332" href="#__codelineno-81-332"></a>    <span class="n">val_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">val_pred</span><span class="p">)</span>
</span><span id="__span-81-333"><a id="__codelineno-81-333" name="__codelineno-81-333" href="#__codelineno-81-333"></a>
</span><span id="__span-81-334"><a id="__codelineno-81-334" name="__codelineno-81-334" href="#__codelineno-81-334"></a>    <span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-81-335"><a id="__codelineno-81-335" name="__codelineno-81-335" href="#__codelineno-81-335"></a>
</span><span id="__span-81-336"><a id="__codelineno-81-336" name="__codelineno-81-336" href="#__codelineno-81-336"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Random Forest Results:&quot;</span><span class="p">)</span>
</span><span id="__span-81-337"><a id="__codelineno-81-337" name="__codelineno-81-337" href="#__codelineno-81-337"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train RMSE: </span><span class="si">{</span><span class="n">train_rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-338"><a id="__codelineno-81-338" name="__codelineno-81-338" href="#__codelineno-81-338"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val RMSE: </span><span class="si">{</span><span class="n">val_rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-339"><a id="__codelineno-81-339" name="__codelineno-81-339" href="#__codelineno-81-339"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val MAE: </span><span class="si">{</span><span class="n">val_mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-340"><a id="__codelineno-81-340" name="__codelineno-81-340" href="#__codelineno-81-340"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val R²: </span><span class="si">{</span><span class="n">val_r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-341"><a id="__codelineno-81-341" name="__codelineno-81-341" href="#__codelineno-81-341"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Training time: </span><span class="si">{</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span id="__span-81-342"><a id="__codelineno-81-342" name="__codelineno-81-342" href="#__codelineno-81-342"></a>
</span><span id="__span-81-343"><a id="__codelineno-81-343" name="__codelineno-81-343" href="#__codelineno-81-343"></a>    <span class="k">return</span> <span class="n">rf_model</span><span class="p">,</span> <span class="p">{</span>
</span><span id="__span-81-344"><a id="__codelineno-81-344" name="__codelineno-81-344" href="#__codelineno-81-344"></a>        <span class="s1">&#39;train_rmse&#39;</span><span class="p">:</span> <span class="n">train_rmse</span><span class="p">,</span>
</span><span id="__span-81-345"><a id="__codelineno-81-345" name="__codelineno-81-345" href="#__codelineno-81-345"></a>        <span class="s1">&#39;val_rmse&#39;</span><span class="p">:</span> <span class="n">val_rmse</span><span class="p">,</span>
</span><span id="__span-81-346"><a id="__codelineno-81-346" name="__codelineno-81-346" href="#__codelineno-81-346"></a>        <span class="s1">&#39;val_mae&#39;</span><span class="p">:</span> <span class="n">val_mae</span><span class="p">,</span>
</span><span id="__span-81-347"><a id="__codelineno-81-347" name="__codelineno-81-347" href="#__codelineno-81-347"></a>        <span class="s1">&#39;val_r2&#39;</span><span class="p">:</span> <span class="n">val_r2</span><span class="p">,</span>
</span><span id="__span-81-348"><a id="__codelineno-81-348" name="__codelineno-81-348" href="#__codelineno-81-348"></a>        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">training_time</span>
</span><span id="__span-81-349"><a id="__codelineno-81-349" name="__codelineno-81-349" href="#__codelineno-81-349"></a>    <span class="p">}</span>
</span><span id="__span-81-350"><a id="__codelineno-81-350" name="__codelineno-81-350" href="#__codelineno-81-350"></a>
</span><span id="__span-81-351"><a id="__codelineno-81-351" name="__codelineno-81-351" href="#__codelineno-81-351"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-352"><a id="__codelineno-81-352" name="__codelineno-81-352" href="#__codelineno-81-352"></a><span class="c1"># 6. EVALUATION AND VISUALIZATION</span>
</span><span id="__span-81-353"><a id="__codelineno-81-353" name="__codelineno-81-353" href="#__codelineno-81-353"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-354"><a id="__codelineno-81-354" name="__codelineno-81-354" href="#__codelineno-81-354"></a>
</span><span id="__span-81-355"><a id="__codelineno-81-355" name="__codelineno-81-355" href="#__codelineno-81-355"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;dl&#39;</span><span class="p">):</span>
</span><span id="__span-81-356"><a id="__codelineno-81-356" name="__codelineno-81-356" href="#__codelineno-81-356"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-357"><a id="__codelineno-81-357" name="__codelineno-81-357" href="#__codelineno-81-357"></a><span class="sd">    Comprehensive model evaluation</span>
</span><span id="__span-81-358"><a id="__codelineno-81-358" name="__codelineno-81-358" href="#__codelineno-81-358"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-359"><a id="__codelineno-81-359" name="__codelineno-81-359" href="#__codelineno-81-359"></a>    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;dl&#39;</span><span class="p">:</span>
</span><span id="__span-81-360"><a id="__codelineno-81-360" name="__codelineno-81-360" href="#__codelineno-81-360"></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span><span id="__span-81-361"><a id="__codelineno-81-361" name="__codelineno-81-361" href="#__codelineno-81-361"></a>        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-81-362"><a id="__codelineno-81-362" name="__codelineno-81-362" href="#__codelineno-81-362"></a>
</span><span id="__span-81-363"><a id="__codelineno-81-363" name="__codelineno-81-363" href="#__codelineno-81-363"></a>        <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">BBBDataset</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</span><span id="__span-81-364"><a id="__codelineno-81-364" name="__codelineno-81-364" href="#__codelineno-81-364"></a>        <span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</span><span id="__span-81-365"><a id="__codelineno-81-365" name="__codelineno-81-365" href="#__codelineno-81-365"></a>
</span><span id="__span-81-366"><a id="__codelineno-81-366" name="__codelineno-81-366" href="#__codelineno-81-366"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-81-367"><a id="__codelineno-81-367" name="__codelineno-81-367" href="#__codelineno-81-367"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-81-368"><a id="__codelineno-81-368" name="__codelineno-81-368" href="#__codelineno-81-368"></a>            <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
</span><span id="__span-81-369"><a id="__codelineno-81-369" name="__codelineno-81-369" href="#__codelineno-81-369"></a>                <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-81-370"><a id="__codelineno-81-370" name="__codelineno-81-370" href="#__codelineno-81-370"></a>                <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-81-371"><a id="__codelineno-81-371" name="__codelineno-81-371" href="#__codelineno-81-371"></a>                <span class="n">predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-81-372"><a id="__codelineno-81-372" name="__codelineno-81-372" href="#__codelineno-81-372"></a>
</span><span id="__span-81-373"><a id="__codelineno-81-373" name="__codelineno-81-373" href="#__codelineno-81-373"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-81-374"><a id="__codelineno-81-374" name="__codelineno-81-374" href="#__codelineno-81-374"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-81-375"><a id="__codelineno-81-375" name="__codelineno-81-375" href="#__codelineno-81-375"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</span><span id="__span-81-376"><a id="__codelineno-81-376" name="__codelineno-81-376" href="#__codelineno-81-376"></a>
</span><span id="__span-81-377"><a id="__codelineno-81-377" name="__codelineno-81-377" href="#__codelineno-81-377"></a>    <span class="c1"># Calculate metrics</span>
</span><span id="__span-81-378"><a id="__codelineno-81-378" name="__codelineno-81-378" href="#__codelineno-81-378"></a>    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">))</span>
</span><span id="__span-81-379"><a id="__codelineno-81-379" name="__codelineno-81-379" href="#__codelineno-81-379"></a>    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
</span><span id="__span-81-380"><a id="__codelineno-81-380" name="__codelineno-81-380" href="#__codelineno-81-380"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
</span><span id="__span-81-381"><a id="__codelineno-81-381" name="__codelineno-81-381" href="#__codelineno-81-381"></a>
</span><span id="__span-81-382"><a id="__codelineno-81-382" name="__codelineno-81-382" href="#__codelineno-81-382"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test Set Evaluation:&quot;</span><span class="p">)</span>
</span><span id="__span-81-383"><a id="__codelineno-81-383" name="__codelineno-81-383" href="#__codelineno-81-383"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-384"><a id="__codelineno-81-384" name="__codelineno-81-384" href="#__codelineno-81-384"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-385"><a id="__codelineno-81-385" name="__codelineno-81-385" href="#__codelineno-81-385"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R²: </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-386"><a id="__codelineno-81-386" name="__codelineno-81-386" href="#__codelineno-81-386"></a>
</span><span id="__span-81-387"><a id="__codelineno-81-387" name="__codelineno-81-387" href="#__codelineno-81-387"></a>    <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">}</span>
</span><span id="__span-81-388"><a id="__codelineno-81-388" name="__codelineno-81-388" href="#__codelineno-81-388"></a>
</span><span id="__span-81-389"><a id="__codelineno-81-389" name="__codelineno-81-389" href="#__codelineno-81-389"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_results</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_dl</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
</span><span id="__span-81-390"><a id="__codelineno-81-390" name="__codelineno-81-390" href="#__codelineno-81-390"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-391"><a id="__codelineno-81-391" name="__codelineno-81-391" href="#__codelineno-81-391"></a><span class="sd">    Create comprehensive visualization of results</span>
</span><span id="__span-81-392"><a id="__codelineno-81-392" name="__codelineno-81-392" href="#__codelineno-81-392"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-393"><a id="__codelineno-81-393" name="__codelineno-81-393" href="#__codelineno-81-393"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="__span-81-394"><a id="__codelineno-81-394" name="__codelineno-81-394" href="#__codelineno-81-394"></a>
</span><span id="__span-81-395"><a id="__codelineno-81-395" name="__codelineno-81-395" href="#__codelineno-81-395"></a>    <span class="c1"># 1. Training history</span>
</span><span id="__span-81-396"><a id="__codelineno-81-396" name="__codelineno-81-396" href="#__codelineno-81-396"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">)</span>
</span><span id="__span-81-397"><a id="__codelineno-81-397" name="__codelineno-81-397" href="#__codelineno-81-397"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Loss&#39;</span><span class="p">)</span>
</span><span id="__span-81-398"><a id="__codelineno-81-398" name="__codelineno-81-398" href="#__codelineno-81-398"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-81-399"><a id="__codelineno-81-399" name="__codelineno-81-399" href="#__codelineno-81-399"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
</span><span id="__span-81-400"><a id="__codelineno-81-400" name="__codelineno-81-400" href="#__codelineno-81-400"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Training History&#39;</span><span class="p">)</span>
</span><span id="__span-81-401"><a id="__codelineno-81-401" name="__codelineno-81-401" href="#__codelineno-81-401"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-81-402"><a id="__codelineno-81-402" name="__codelineno-81-402" href="#__codelineno-81-402"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-81-403"><a id="__codelineno-81-403" name="__codelineno-81-403" href="#__codelineno-81-403"></a>
</span><span id="__span-81-404"><a id="__codelineno-81-404" name="__codelineno-81-404" href="#__codelineno-81-404"></a>    <span class="c1"># 2. Metrics evolution</span>
</span><span id="__span-81-405"><a id="__codelineno-81-405" name="__codelineno-81-405" href="#__codelineno-81-405"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_rmse&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="__span-81-406"><a id="__codelineno-81-406" name="__codelineno-81-406" href="#__codelineno-81-406"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-81-407"><a id="__codelineno-81-407" name="__codelineno-81-407" href="#__codelineno-81-407"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;RMSE&#39;</span><span class="p">)</span>
</span><span id="__span-81-408"><a id="__codelineno-81-408" name="__codelineno-81-408" href="#__codelineno-81-408"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Validation RMSE&#39;</span><span class="p">)</span>
</span><span id="__span-81-409"><a id="__codelineno-81-409" name="__codelineno-81-409" href="#__codelineno-81-409"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-81-410"><a id="__codelineno-81-410" name="__codelineno-81-410" href="#__codelineno-81-410"></a>
</span><span id="__span-81-411"><a id="__codelineno-81-411" name="__codelineno-81-411" href="#__codelineno-81-411"></a>    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span><span id="__span-81-412"><a id="__codelineno-81-412" name="__codelineno-81-412" href="#__codelineno-81-412"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_r2&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;R²&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="__span-81-413"><a id="__codelineno-81-413" name="__codelineno-81-413" href="#__codelineno-81-413"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R²&#39;</span><span class="p">)</span>
</span><span id="__span-81-414"><a id="__codelineno-81-414" name="__codelineno-81-414" href="#__codelineno-81-414"></a>
</span><span id="__span-81-415"><a id="__codelineno-81-415" name="__codelineno-81-415" href="#__codelineno-81-415"></a>    <span class="c1"># 3. R² evolution</span>
</span><span id="__span-81-416"><a id="__codelineno-81-416" name="__codelineno-81-416" href="#__codelineno-81-416"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_r2&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
</span><span id="__span-81-417"><a id="__codelineno-81-417" name="__codelineno-81-417" href="#__codelineno-81-417"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-81-418"><a id="__codelineno-81-418" name="__codelineno-81-418" href="#__codelineno-81-418"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R² Score&#39;</span><span class="p">)</span>
</span><span id="__span-81-419"><a id="__codelineno-81-419" name="__codelineno-81-419" href="#__codelineno-81-419"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Validation R²&#39;</span><span class="p">)</span>
</span><span id="__span-81-420"><a id="__codelineno-81-420" name="__codelineno-81-420" href="#__codelineno-81-420"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-81-421"><a id="__codelineno-81-421" name="__codelineno-81-421" href="#__codelineno-81-421"></a>
</span><span id="__span-81-422"><a id="__codelineno-81-422" name="__codelineno-81-422" href="#__codelineno-81-422"></a>    <span class="c1"># 4. DL predictions scatter plot</span>
</span><span id="__span-81-423"><a id="__codelineno-81-423" name="__codelineno-81-423" href="#__codelineno-81-423"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_dl</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-81-424"><a id="__codelineno-81-424" name="__codelineno-81-424" href="#__codelineno-81-424"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> 
</span><span id="__span-81-425"><a id="__codelineno-81-425" name="__codelineno-81-425" href="#__codelineno-81-425"></a>                     <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-81-426"><a id="__codelineno-81-426" name="__codelineno-81-426" href="#__codelineno-81-426"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True logBB&#39;</span><span class="p">)</span>
</span><span id="__span-81-427"><a id="__codelineno-81-427" name="__codelineno-81-427" href="#__codelineno-81-427"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted logBB&#39;</span><span class="p">)</span>
</span><span id="__span-81-428"><a id="__codelineno-81-428" name="__codelineno-81-428" href="#__codelineno-81-428"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Deep Learning Predictions&#39;</span><span class="p">)</span>
</span><span id="__span-81-429"><a id="__codelineno-81-429" name="__codelineno-81-429" href="#__codelineno-81-429"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-81-430"><a id="__codelineno-81-430" name="__codelineno-81-430" href="#__codelineno-81-430"></a>
</span><span id="__span-81-431"><a id="__codelineno-81-431" name="__codelineno-81-431" href="#__codelineno-81-431"></a>    <span class="c1"># 5. RF predictions scatter plot</span>
</span><span id="__span-81-432"><a id="__codelineno-81-432" name="__codelineno-81-432" href="#__codelineno-81-432"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
</span><span id="__span-81-433"><a id="__codelineno-81-433" name="__codelineno-81-433" href="#__codelineno-81-433"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> 
</span><span id="__span-81-434"><a id="__codelineno-81-434" name="__codelineno-81-434" href="#__codelineno-81-434"></a>                     <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-81-435"><a id="__codelineno-81-435" name="__codelineno-81-435" href="#__codelineno-81-435"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True logBB&#39;</span><span class="p">)</span>
</span><span id="__span-81-436"><a id="__codelineno-81-436" name="__codelineno-81-436" href="#__codelineno-81-436"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted logBB&#39;</span><span class="p">)</span>
</span><span id="__span-81-437"><a id="__codelineno-81-437" name="__codelineno-81-437" href="#__codelineno-81-437"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Random Forest Predictions&#39;</span><span class="p">)</span>
</span><span id="__span-81-438"><a id="__codelineno-81-438" name="__codelineno-81-438" href="#__codelineno-81-438"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-81-439"><a id="__codelineno-81-439" name="__codelineno-81-439" href="#__codelineno-81-439"></a>
</span><span id="__span-81-440"><a id="__codelineno-81-440" name="__codelineno-81-440" href="#__codelineno-81-440"></a>    <span class="c1"># 6. Residuals comparison</span>
</span><span id="__span-81-441"><a id="__codelineno-81-441" name="__codelineno-81-441" href="#__codelineno-81-441"></a>    <span class="n">residuals_dl</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred_dl</span>
</span><span id="__span-81-442"><a id="__codelineno-81-442" name="__codelineno-81-442" href="#__codelineno-81-442"></a>    <span class="n">residuals_rf</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred_rf</span>
</span><span id="__span-81-443"><a id="__codelineno-81-443" name="__codelineno-81-443" href="#__codelineno-81-443"></a>
</span><span id="__span-81-444"><a id="__codelineno-81-444" name="__codelineno-81-444" href="#__codelineno-81-444"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals_dl</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Deep Learning&#39;</span><span class="p">)</span>
</span><span id="__span-81-445"><a id="__codelineno-81-445" name="__codelineno-81-445" href="#__codelineno-81-445"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals_rf</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random Forest&#39;</span><span class="p">)</span>
</span><span id="__span-81-446"><a id="__codelineno-81-446" name="__codelineno-81-446" href="#__codelineno-81-446"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
</span><span id="__span-81-447"><a id="__codelineno-81-447" name="__codelineno-81-447" href="#__codelineno-81-447"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
</span><span id="__span-81-448"><a id="__codelineno-81-448" name="__codelineno-81-448" href="#__codelineno-81-448"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals Distribution&#39;</span><span class="p">)</span>
</span><span id="__span-81-449"><a id="__codelineno-81-449" name="__codelineno-81-449" href="#__codelineno-81-449"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-81-450"><a id="__codelineno-81-450" name="__codelineno-81-450" href="#__codelineno-81-450"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-81-451"><a id="__codelineno-81-451" name="__codelineno-81-451" href="#__codelineno-81-451"></a>
</span><span id="__span-81-452"><a id="__codelineno-81-452" name="__codelineno-81-452" href="#__codelineno-81-452"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-81-453"><a id="__codelineno-81-453" name="__codelineno-81-453" href="#__codelineno-81-453"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;bbb_prediction_results.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="__span-81-454"><a id="__codelineno-81-454" name="__codelineno-81-454" href="#__codelineno-81-454"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-81-455"><a id="__codelineno-81-455" name="__codelineno-81-455" href="#__codelineno-81-455"></a>
</span><span id="__span-81-456"><a id="__codelineno-81-456" name="__codelineno-81-456" href="#__codelineno-81-456"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-457"><a id="__codelineno-81-457" name="__codelineno-81-457" href="#__codelineno-81-457"></a><span class="c1"># 7. MAIN EXECUTION</span>
</span><span id="__span-81-458"><a id="__codelineno-81-458" name="__codelineno-81-458" href="#__codelineno-81-458"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-81-459"><a id="__codelineno-81-459" name="__codelineno-81-459" href="#__codelineno-81-459"></a>
</span><span id="__span-81-460"><a id="__codelineno-81-460" name="__codelineno-81-460" href="#__codelineno-81-460"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-81-461"><a id="__codelineno-81-461" name="__codelineno-81-461" href="#__codelineno-81-461"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-462"><a id="__codelineno-81-462" name="__codelineno-81-462" href="#__codelineno-81-462"></a><span class="sd">    Main execution function</span>
</span><span id="__span-81-463"><a id="__codelineno-81-463" name="__codelineno-81-463" href="#__codelineno-81-463"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-81-464"><a id="__codelineno-81-464" name="__codelineno-81-464" href="#__codelineno-81-464"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-81-465"><a id="__codelineno-81-465" name="__codelineno-81-465" href="#__codelineno-81-465"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BBB PERMEABILITY PREDICTION - COMPLETE PIPELINE&quot;</span><span class="p">)</span>
</span><span id="__span-81-466"><a id="__codelineno-81-466" name="__codelineno-81-466" href="#__codelineno-81-466"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-81-467"><a id="__codelineno-81-467" name="__codelineno-81-467" href="#__codelineno-81-467"></a>
</span><span id="__span-81-468"><a id="__codelineno-81-468" name="__codelineno-81-468" href="#__codelineno-81-468"></a>    <span class="c1"># 1. Load data</span>
</span><span id="__span-81-469"><a id="__codelineno-81-469" name="__codelineno-81-469" href="#__codelineno-81-469"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Loading data...&quot;</span><span class="p">)</span>
</span><span id="__span-81-470"><a id="__codelineno-81-470" name="__codelineno-81-470" href="#__codelineno-81-470"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">load_bbb_data</span><span class="p">()</span>
</span><span id="__span-81-471"><a id="__codelineno-81-471" name="__codelineno-81-471" href="#__codelineno-81-471"></a>
</span><span id="__span-81-472"><a id="__codelineno-81-472" name="__codelineno-81-472" href="#__codelineno-81-472"></a>    <span class="c1"># 2. Split data</span>
</span><span id="__span-81-473"><a id="__codelineno-81-473" name="__codelineno-81-473" href="#__codelineno-81-473"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Splitting data...&quot;</span><span class="p">)</span>
</span><span id="__span-81-474"><a id="__codelineno-81-474" name="__codelineno-81-474" href="#__codelineno-81-474"></a>    <span class="n">train_df</span><span class="p">,</span> <span class="n">temp_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-81-475"><a id="__codelineno-81-475" name="__codelineno-81-475" href="#__codelineno-81-475"></a>    <span class="n">val_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">temp_df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-81-476"><a id="__codelineno-81-476" name="__codelineno-81-476" href="#__codelineno-81-476"></a>
</span><span id="__span-81-477"><a id="__codelineno-81-477" name="__codelineno-81-477" href="#__codelineno-81-477"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> molecules&quot;</span><span class="p">)</span>
</span><span id="__span-81-478"><a id="__codelineno-81-478" name="__codelineno-81-478" href="#__codelineno-81-478"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> molecules&quot;</span><span class="p">)</span>
</span><span id="__span-81-479"><a id="__codelineno-81-479" name="__codelineno-81-479" href="#__codelineno-81-479"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> molecules&quot;</span><span class="p">)</span>
</span><span id="__span-81-480"><a id="__codelineno-81-480" name="__codelineno-81-480" href="#__codelineno-81-480"></a>
</span><span id="__span-81-481"><a id="__codelineno-81-481" name="__codelineno-81-481" href="#__codelineno-81-481"></a>    <span class="c1"># 3. Extract features</span>
</span><span id="__span-81-482"><a id="__codelineno-81-482" name="__codelineno-81-482" href="#__codelineno-81-482"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Extracting features...&quot;</span><span class="p">)</span>
</span><span id="__span-81-483"><a id="__codelineno-81-483" name="__codelineno-81-483" href="#__codelineno-81-483"></a>    <span class="n">X_train</span> <span class="o">=</span> <span class="n">compute_molecular_fingerprints</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s1">&#39;SMILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="__span-81-484"><a id="__codelineno-81-484" name="__codelineno-81-484" href="#__codelineno-81-484"></a>    <span class="n">X_val</span> <span class="o">=</span> <span class="n">compute_molecular_fingerprints</span><span class="p">(</span><span class="n">val_df</span><span class="p">[</span><span class="s1">&#39;SMILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="__span-81-485"><a id="__codelineno-81-485" name="__codelineno-81-485" href="#__codelineno-81-485"></a>    <span class="n">X_test</span> <span class="o">=</span> <span class="n">compute_molecular_fingerprints</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;SMILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="__span-81-486"><a id="__codelineno-81-486" name="__codelineno-81-486" href="#__codelineno-81-486"></a>
</span><span id="__span-81-487"><a id="__codelineno-81-487" name="__codelineno-81-487" href="#__codelineno-81-487"></a>    <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s1">&#39;logBB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="__span-81-488"><a id="__codelineno-81-488" name="__codelineno-81-488" href="#__codelineno-81-488"></a>    <span class="n">y_val</span> <span class="o">=</span> <span class="n">val_df</span><span class="p">[</span><span class="s1">&#39;logBB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="__span-81-489"><a id="__codelineno-81-489" name="__codelineno-81-489" href="#__codelineno-81-489"></a>    <span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;logBB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="__span-81-490"><a id="__codelineno-81-490" name="__codelineno-81-490" href="#__codelineno-81-490"></a>
</span><span id="__span-81-491"><a id="__codelineno-81-491" name="__codelineno-81-491" href="#__codelineno-81-491"></a>    <span class="c1"># 4. Train Deep Learning model</span>
</span><span id="__span-81-492"><a id="__codelineno-81-492" name="__codelineno-81-492" href="#__codelineno-81-492"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Training Deep Learning model...&quot;</span><span class="p">)</span>
</span><span id="__span-81-493"><a id="__codelineno-81-493" name="__codelineno-81-493" href="#__codelineno-81-493"></a>    <span class="n">dl_model</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">dl_time</span> <span class="o">=</span> <span class="n">train_deep_learning_model</span><span class="p">(</span>
</span><span id="__span-81-494"><a id="__codelineno-81-494" name="__codelineno-81-494" href="#__codelineno-81-494"></a>        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
</span><span id="__span-81-495"><a id="__codelineno-81-495" name="__codelineno-81-495" href="#__codelineno-81-495"></a>        <span class="n">num_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span>
</span><span id="__span-81-496"><a id="__codelineno-81-496" name="__codelineno-81-496" href="#__codelineno-81-496"></a>    <span class="p">)</span>
</span><span id="__span-81-497"><a id="__codelineno-81-497" name="__codelineno-81-497" href="#__codelineno-81-497"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Training time: </span><span class="si">{</span><span class="n">dl_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span id="__span-81-498"><a id="__codelineno-81-498" name="__codelineno-81-498" href="#__codelineno-81-498"></a>
</span><span id="__span-81-499"><a id="__codelineno-81-499" name="__codelineno-81-499" href="#__codelineno-81-499"></a>    <span class="c1"># 5. Train Random Forest baseline</span>
</span><span id="__span-81-500"><a id="__codelineno-81-500" name="__codelineno-81-500" href="#__codelineno-81-500"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">5. Training Random Forest baseline...&quot;</span><span class="p">)</span>
</span><span id="__span-81-501"><a id="__codelineno-81-501" name="__codelineno-81-501" href="#__codelineno-81-501"></a>    <span class="n">rf_model</span><span class="p">,</span> <span class="n">rf_results</span> <span class="o">=</span> <span class="n">train_random_forest_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-81-502"><a id="__codelineno-81-502" name="__codelineno-81-502" href="#__codelineno-81-502"></a>
</span><span id="__span-81-503"><a id="__codelineno-81-503" name="__codelineno-81-503" href="#__codelineno-81-503"></a>    <span class="c1"># 6. Evaluate on test set</span>
</span><span id="__span-81-504"><a id="__codelineno-81-504" name="__codelineno-81-504" href="#__codelineno-81-504"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">6. Evaluating models on test set...&quot;</span><span class="p">)</span>
</span><span id="__span-81-505"><a id="__codelineno-81-505" name="__codelineno-81-505" href="#__codelineno-81-505"></a>
</span><span id="__span-81-506"><a id="__codelineno-81-506" name="__codelineno-81-506" href="#__codelineno-81-506"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Deep Learning Model:&quot;</span><span class="p">)</span>
</span><span id="__span-81-507"><a id="__codelineno-81-507" name="__codelineno-81-507" href="#__codelineno-81-507"></a>    <span class="n">dl_predictions</span><span class="p">,</span> <span class="n">dl_metrics</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">dl_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="s1">&#39;dl&#39;</span><span class="p">)</span>
</span><span id="__span-81-508"><a id="__codelineno-81-508" name="__codelineno-81-508" href="#__codelineno-81-508"></a>
</span><span id="__span-81-509"><a id="__codelineno-81-509" name="__codelineno-81-509" href="#__codelineno-81-509"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Random Forest Model:&quot;</span><span class="p">)</span>
</span><span id="__span-81-510"><a id="__codelineno-81-510" name="__codelineno-81-510" href="#__codelineno-81-510"></a>    <span class="n">rf_predictions</span><span class="p">,</span> <span class="n">rf_metrics</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">rf_model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="s1">&#39;rf&#39;</span><span class="p">)</span>
</span><span id="__span-81-511"><a id="__codelineno-81-511" name="__codelineno-81-511" href="#__codelineno-81-511"></a>
</span><span id="__span-81-512"><a id="__codelineno-81-512" name="__codelineno-81-512" href="#__codelineno-81-512"></a>    <span class="c1"># 7. Compare results</span>
</span><span id="__span-81-513"><a id="__codelineno-81-513" name="__codelineno-81-513" href="#__codelineno-81-513"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-81-514"><a id="__codelineno-81-514" name="__codelineno-81-514" href="#__codelineno-81-514"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FINAL COMPARISON&quot;</span><span class="p">)</span>
</span><span id="__span-81-515"><a id="__codelineno-81-515" name="__codelineno-81-515" href="#__codelineno-81-515"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-81-516"><a id="__codelineno-81-516" name="__codelineno-81-516" href="#__codelineno-81-516"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Metric&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Deep Learning&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Random Forest&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Improvement&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-517"><a id="__codelineno-81-517" name="__codelineno-81-517" href="#__codelineno-81-517"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-81-518"><a id="__codelineno-81-518" name="__codelineno-81-518" href="#__codelineno-81-518"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;RMSE&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dl_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;20.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;20.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="__span-81-519"><a id="__codelineno-81-519" name="__codelineno-81-519" href="#__codelineno-81-519"></a>          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">dl_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;6.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="__span-81-520"><a id="__codelineno-81-520" name="__codelineno-81-520" href="#__codelineno-81-520"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;MAE&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dl_metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;20.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;20.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="__span-81-521"><a id="__codelineno-81-521" name="__codelineno-81-521" href="#__codelineno-81-521"></a>          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">dl_metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;6.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="__span-81-522"><a id="__codelineno-81-522" name="__codelineno-81-522" href="#__codelineno-81-522"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;R²&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dl_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;20.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;20.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="__span-81-523"><a id="__codelineno-81-523" name="__codelineno-81-523" href="#__codelineno-81-523"></a>          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">dl_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">rf_metrics</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;6.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="__span-81-524"><a id="__codelineno-81-524" name="__codelineno-81-524" href="#__codelineno-81-524"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Training Time&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dl_time</span><span class="si">:</span><span class="s2">&lt;20.1f</span><span class="si">}</span><span class="s2">s </span><span class="si">{</span><span class="n">rf_results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;20.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</span><span id="__span-81-525"><a id="__codelineno-81-525" name="__codelineno-81-525" href="#__codelineno-81-525"></a>
</span><span id="__span-81-526"><a id="__codelineno-81-526" name="__codelineno-81-526" href="#__codelineno-81-526"></a>    <span class="c1"># 8. Visualize results</span>
</span><span id="__span-81-527"><a id="__codelineno-81-527" name="__codelineno-81-527" href="#__codelineno-81-527"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">8. Generating visualizations...&quot;</span><span class="p">)</span>
</span><span id="__span-81-528"><a id="__codelineno-81-528" name="__codelineno-81-528" href="#__codelineno-81-528"></a>    <span class="n">visualize_results</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">dl_predictions</span><span class="p">,</span> <span class="n">rf_predictions</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
</span><span id="__span-81-529"><a id="__codelineno-81-529" name="__codelineno-81-529" href="#__codelineno-81-529"></a>
</span><span id="__span-81-530"><a id="__codelineno-81-530" name="__codelineno-81-530" href="#__codelineno-81-530"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-81-531"><a id="__codelineno-81-531" name="__codelineno-81-531" href="#__codelineno-81-531"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PIPELINE COMPLETE!&quot;</span><span class="p">)</span>
</span><span id="__span-81-532"><a id="__codelineno-81-532" name="__codelineno-81-532" href="#__codelineno-81-532"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-81-533"><a id="__codelineno-81-533" name="__codelineno-81-533" href="#__codelineno-81-533"></a>
</span><span id="__span-81-534"><a id="__codelineno-81-534" name="__codelineno-81-534" href="#__codelineno-81-534"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-81-535"><a id="__codelineno-81-535" name="__codelineno-81-535" href="#__codelineno-81-535"></a>        <span class="s1">&#39;dl_model&#39;</span><span class="p">:</span> <span class="n">dl_model</span><span class="p">,</span>
</span><span id="__span-81-536"><a id="__codelineno-81-536" name="__codelineno-81-536" href="#__codelineno-81-536"></a>        <span class="s1">&#39;rf_model&#39;</span><span class="p">:</span> <span class="n">rf_model</span><span class="p">,</span>
</span><span id="__span-81-537"><a id="__codelineno-81-537" name="__codelineno-81-537" href="#__codelineno-81-537"></a>        <span class="s1">&#39;dl_metrics&#39;</span><span class="p">:</span> <span class="n">dl_metrics</span><span class="p">,</span>
</span><span id="__span-81-538"><a id="__codelineno-81-538" name="__codelineno-81-538" href="#__codelineno-81-538"></a>        <span class="s1">&#39;rf_metrics&#39;</span><span class="p">:</span> <span class="n">rf_metrics</span><span class="p">,</span>
</span><span id="__span-81-539"><a id="__codelineno-81-539" name="__codelineno-81-539" href="#__codelineno-81-539"></a>        <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="n">history</span>
</span><span id="__span-81-540"><a id="__codelineno-81-540" name="__codelineno-81-540" href="#__codelineno-81-540"></a>    <span class="p">}</span>
</span><span id="__span-81-541"><a id="__codelineno-81-541" name="__codelineno-81-541" href="#__codelineno-81-541"></a>
</span><span id="__span-81-542"><a id="__codelineno-81-542" name="__codelineno-81-542" href="#__codelineno-81-542"></a><span class="c1"># Run the pipeline</span>
</span><span id="__span-81-543"><a id="__codelineno-81-543" name="__codelineno-81-543" href="#__codelineno-81-543"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-81-544"><a id="__codelineno-81-544" name="__codelineno-81-544" href="#__codelineno-81-544"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">main</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="73__expected__output">7.3 Expected Output<a class="headerlink" href="#73__expected__output" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>======================================================================
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>BBB PERMEABILITY PREDICTION - COMPLETE PIPELINE
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>======================================================================
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>1. Loading data...
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>Loaded 2000 valid molecules
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>logBB range: [-2.85, 1.92]
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a>2. Splitting data...
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a>  Train: 1400 molecules
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a>  Val: 300 molecules
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a>  Test: 300 molecules
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a>3. Extracting features...
</span><span id="__span-82-15"><a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a>Computing fingerprints: 100%|██████████| 1400/1400 [00:05&lt;00:00]
</span><span id="__span-82-16"><a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a>Computing fingerprints: 100%|██████████| 300/300 [00:01&lt;00:00]
</span><span id="__span-82-17"><a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a>Computing fingerprints: 100%|██████████| 300/300 [00:01&lt;00:00]
</span><span id="__span-82-18"><a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a>
</span><span id="__span-82-19"><a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a>4. Training Deep Learning model...
</span><span id="__span-82-20"><a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a>Using device: cuda
</span><span id="__span-82-21"><a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a>Epoch 10/100
</span><span id="__span-82-22"><a id="__codelineno-82-22" name="__codelineno-82-22" href="#__codelineno-82-22"></a>  Train Loss: 0.3245
</span><span id="__span-82-23"><a id="__codelineno-82-23" name="__codelineno-82-23" href="#__codelineno-82-23"></a>  Val Loss: 0.3678, RMSE: 0.6065, MAE: 0.4532, R²: 0.7234
</span><span id="__span-82-24"><a id="__codelineno-82-24" name="__codelineno-82-24" href="#__codelineno-82-24"></a>
</span><span id="__span-82-25"><a id="__codelineno-82-25" name="__codelineno-82-25" href="#__codelineno-82-25"></a>Epoch 20/100
</span><span id="__span-82-26"><a id="__codelineno-82-26" name="__codelineno-82-26" href="#__codelineno-82-26"></a>  Train Loss: 0.2156
</span><span id="__span-82-27"><a id="__codelineno-82-27" name="__codelineno-82-27" href="#__codelineno-82-27"></a>  Val Loss: 0.2987, RMSE: 0.5465, MAE: 0.4012, R²: 0.7789
</span><span id="__span-82-28"><a id="__codelineno-82-28" name="__codelineno-82-28" href="#__codelineno-82-28"></a>
</span><span id="__span-82-29"><a id="__codelineno-82-29" name="__codelineno-82-29" href="#__codelineno-82-29"></a>... (training continues)
</span><span id="__span-82-30"><a id="__codelineno-82-30" name="__codelineno-82-30" href="#__codelineno-82-30"></a>
</span><span id="__span-82-31"><a id="__codelineno-82-31" name="__codelineno-82-31" href="#__codelineno-82-31"></a>Early stopping at epoch 68
</span><span id="__span-82-32"><a id="__codelineno-82-32" name="__codelineno-82-32" href="#__codelineno-82-32"></a>  Training time: 142.35s
</span><span id="__span-82-33"><a id="__codelineno-82-33" name="__codelineno-82-33" href="#__codelineno-82-33"></a>
</span><span id="__span-82-34"><a id="__codelineno-82-34" name="__codelineno-82-34" href="#__codelineno-82-34"></a>5. Training Random Forest baseline...
</span><span id="__span-82-35"><a id="__codelineno-82-35" name="__codelineno-82-35" href="#__codelineno-82-35"></a>
</span><span id="__span-82-36"><a id="__codelineno-82-36" name="__codelineno-82-36" href="#__codelineno-82-36"></a>Random Forest Results:
</span><span id="__span-82-37"><a id="__codelineno-82-37" name="__codelineno-82-37" href="#__codelineno-82-37"></a>  Train RMSE: 0.1234
</span><span id="__span-82-38"><a id="__codelineno-82-38" name="__codelineno-82-38" href="#__codelineno-82-38"></a>  Val RMSE: 0.6234
</span><span id="__span-82-39"><a id="__codelineno-82-39" name="__codelineno-82-39" href="#__codelineno-82-39"></a>  Val MAE: 0.4689
</span><span id="__span-82-40"><a id="__codelineno-82-40" name="__codelineno-82-40" href="#__codelineno-82-40"></a>  Val R²: 0.7456
</span><span id="__span-82-41"><a id="__codelineno-82-41" name="__codelineno-82-41" href="#__codelineno-82-41"></a>  Training time: 56.78s
</span><span id="__span-82-42"><a id="__codelineno-82-42" name="__codelineno-82-42" href="#__codelineno-82-42"></a>
</span><span id="__span-82-43"><a id="__codelineno-82-43" name="__codelineno-82-43" href="#__codelineno-82-43"></a>6. Evaluating models on test set...
</span><span id="__span-82-44"><a id="__codelineno-82-44" name="__codelineno-82-44" href="#__codelineno-82-44"></a>
</span><span id="__span-82-45"><a id="__codelineno-82-45" name="__codelineno-82-45" href="#__codelineno-82-45"></a>Deep Learning Model:
</span><span id="__span-82-46"><a id="__codelineno-82-46" name="__codelineno-82-46" href="#__codelineno-82-46"></a>Test Set Evaluation:
</span><span id="__span-82-47"><a id="__codelineno-82-47" name="__codelineno-82-47" href="#__codelineno-82-47"></a>  RMSE: 0.5234
</span><span id="__span-82-48"><a id="__codelineno-82-48" name="__codelineno-82-48" href="#__codelineno-82-48"></a>  MAE: 0.3876
</span><span id="__span-82-49"><a id="__codelineno-82-49" name="__codelineno-82-49" href="#__codelineno-82-49"></a>  R²: 0.7923
</span><span id="__span-82-50"><a id="__codelineno-82-50" name="__codelineno-82-50" href="#__codelineno-82-50"></a>
</span><span id="__span-82-51"><a id="__codelineno-82-51" name="__codelineno-82-51" href="#__codelineno-82-51"></a>Random Forest Model:
</span><span id="__span-82-52"><a id="__codelineno-82-52" name="__codelineno-82-52" href="#__codelineno-82-52"></a>Test Set Evaluation:
</span><span id="__span-82-53"><a id="__codelineno-82-53" name="__codelineno-82-53" href="#__codelineno-82-53"></a>  RMSE: 0.5987
</span><span id="__span-82-54"><a id="__codelineno-82-54" name="__codelineno-82-54" href="#__codelineno-82-54"></a>  MAE: 0.4456
</span><span id="__span-82-55"><a id="__codelineno-82-55" name="__codelineno-82-55" href="#__codelineno-82-55"></a>  R²: 0.7534
</span><span id="__span-82-56"><a id="__codelineno-82-56" name="__codelineno-82-56" href="#__codelineno-82-56"></a>
</span><span id="__span-82-57"><a id="__codelineno-82-57" name="__codelineno-82-57" href="#__codelineno-82-57"></a>======================================================================
</span><span id="__span-82-58"><a id="__codelineno-82-58" name="__codelineno-82-58" href="#__codelineno-82-58"></a>FINAL COMPARISON
</span><span id="__span-82-59"><a id="__codelineno-82-59" name="__codelineno-82-59" href="#__codelineno-82-59"></a>======================================================================
</span><span id="__span-82-60"><a id="__codelineno-82-60" name="__codelineno-82-60" href="#__codelineno-82-60"></a>Metric          Deep Learning        Random Forest        Improvement
</span><span id="__span-82-61"><a id="__codelineno-82-61" name="__codelineno-82-61" href="#__codelineno-82-61"></a>----------------------------------------------------------------------
</span><span id="__span-82-62"><a id="__codelineno-82-62" name="__codelineno-82-62" href="#__codelineno-82-62"></a>RMSE            0.5234               0.5987                12.6%
</span><span id="__span-82-63"><a id="__codelineno-82-63" name="__codelineno-82-63" href="#__codelineno-82-63"></a>MAE             0.3876               0.4456                13.0%
</span><span id="__span-82-64"><a id="__codelineno-82-64" name="__codelineno-82-64" href="#__codelineno-82-64"></a>R²              0.7923               0.7534                 5.2%
</span><span id="__span-82-65"><a id="__codelineno-82-65" name="__codelineno-82-65" href="#__codelineno-82-65"></a>Training Time   142.4s               56.8s                
</span><span id="__span-82-66"><a id="__codelineno-82-66" name="__codelineno-82-66" href="#__codelineno-82-66"></a>
</span><span id="__span-82-67"><a id="__codelineno-82-67" name="__codelineno-82-67" href="#__codelineno-82-67"></a>8. Generating visualizations...
</span><span id="__span-82-68"><a id="__codelineno-82-68" name="__codelineno-82-68" href="#__codelineno-82-68"></a>
</span><span id="__span-82-69"><a id="__codelineno-82-69" name="__codelineno-82-69" href="#__codelineno-82-69"></a>======================================================================
</span><span id="__span-82-70"><a id="__codelineno-82-70" name="__codelineno-82-70" href="#__codelineno-82-70"></a>PIPELINE COMPLETE!
</span><span id="__span-82-71"><a id="__codelineno-82-71" name="__codelineno-82-71" href="#__codelineno-82-71"></a>======================================================================
</span></code></pre></div>
<hr />
<h2 id="8__model__interpretation">8. Model Interpretation<a class="headerlink" href="#8__model__interpretation" title="Permanent link">&para;</a></h2>
<p>Understanding what your model has learned is crucial for trust, debugging, and scientific insight.</p>
<h3 id="81__gradient-based__importance">8.1 Gradient-Based Importance<a class="headerlink" href="#81__gradient-based__importance" title="Permanent link">&para;</a></h3>
<p>Calculate feature importance by examining gradients:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_gradient_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="sd">    Compute feature importance using gradients</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a><span class="sd">    Args:</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="sd">        model: Trained neural network</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a><span class="sd">        X: Input features (numpy array or tensor)</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a><span class="sd">    Returns:</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a><span class="sd">        importance_scores: Feature importance for each sample</span>
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-83-13"><a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a>
</span><span id="__span-83-14"><a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="__span-83-15"><a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="__span-83-16"><a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a>
</span><span id="__span-83-17"><a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-83-18"><a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a>    <span class="n">X</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-83-19"><a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a>
</span><span id="__span-83-20"><a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a>    <span class="c1"># Forward pass</span>
</span><span id="__span-83-21"><a id="__codelineno-83-21" name="__codelineno-83-21" href="#__codelineno-83-21"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="__span-83-22"><a id="__codelineno-83-22" name="__codelineno-83-22" href="#__codelineno-83-22"></a>
</span><span id="__span-83-23"><a id="__codelineno-83-23" name="__codelineno-83-23" href="#__codelineno-83-23"></a>    <span class="c1"># Compute gradients</span>
</span><span id="__span-83-24"><a id="__codelineno-83-24" name="__codelineno-83-24" href="#__codelineno-83-24"></a>    <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-83-25"><a id="__codelineno-83-25" name="__codelineno-83-25" href="#__codelineno-83-25"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="__span-83-26"><a id="__codelineno-83-26" name="__codelineno-83-26" href="#__codelineno-83-26"></a>        <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-83-27"><a id="__codelineno-83-27" name="__codelineno-83-27" href="#__codelineno-83-27"></a>        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-83-28"><a id="__codelineno-83-28" name="__codelineno-83-28" href="#__codelineno-83-28"></a>            <span class="n">X</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
</span><span id="__span-83-29"><a id="__codelineno-83-29" name="__codelineno-83-29" href="#__codelineno-83-29"></a>
</span><span id="__span-83-30"><a id="__codelineno-83-30" name="__codelineno-83-30" href="#__codelineno-83-30"></a>        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-83-31"><a id="__codelineno-83-31" name="__codelineno-83-31" href="#__codelineno-83-31"></a>        <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">grad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="__span-83-32"><a id="__codelineno-83-32" name="__codelineno-83-32" href="#__codelineno-83-32"></a>
</span><span id="__span-83-33"><a id="__codelineno-83-33" name="__codelineno-83-33" href="#__codelineno-83-33"></a>    <span class="n">gradients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span>
</span><span id="__span-83-34"><a id="__codelineno-83-34" name="__codelineno-83-34" href="#__codelineno-83-34"></a>
</span><span id="__span-83-35"><a id="__codelineno-83-35" name="__codelineno-83-35" href="#__codelineno-83-35"></a>    <span class="c1"># Importance = absolute gradient * input value</span>
</span><span id="__span-83-36"><a id="__codelineno-83-36" name="__codelineno-83-36" href="#__codelineno-83-36"></a>    <span class="n">importance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-83-37"><a id="__codelineno-83-37" name="__codelineno-83-37" href="#__codelineno-83-37"></a>
</span><span id="__span-83-38"><a id="__codelineno-83-38" name="__codelineno-83-38" href="#__codelineno-83-38"></a>    <span class="k">return</span> <span class="n">importance</span>
</span><span id="__span-83-39"><a id="__codelineno-83-39" name="__codelineno-83-39" href="#__codelineno-83-39"></a>
</span><span id="__span-83-40"><a id="__codelineno-83-40" name="__codelineno-83-40" href="#__codelineno-83-40"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_feature_importance</span><span class="p">(</span><span class="n">importance</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
</span><span id="__span-83-41"><a id="__codelineno-83-41" name="__codelineno-83-41" href="#__codelineno-83-41"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-83-42"><a id="__codelineno-83-42" name="__codelineno-83-42" href="#__codelineno-83-42"></a><span class="sd">    Visualize feature importance</span>
</span><span id="__span-83-43"><a id="__codelineno-83-43" name="__codelineno-83-43" href="#__codelineno-83-43"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-83-44"><a id="__codelineno-83-44" name="__codelineno-83-44" href="#__codelineno-83-44"></a>    <span class="c1"># Average importance across samples</span>
</span><span id="__span-83-45"><a id="__codelineno-83-45" name="__codelineno-83-45" href="#__codelineno-83-45"></a>    <span class="n">avg_importance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">importance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-83-46"><a id="__codelineno-83-46" name="__codelineno-83-46" href="#__codelineno-83-46"></a>
</span><span id="__span-83-47"><a id="__codelineno-83-47" name="__codelineno-83-47" href="#__codelineno-83-47"></a>    <span class="c1"># Get top-k features</span>
</span><span id="__span-83-48"><a id="__codelineno-83-48" name="__codelineno-83-48" href="#__codelineno-83-48"></a>    <span class="n">top_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">avg_importance</span><span class="p">)[</span><span class="o">-</span><span class="n">top_k</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-83-49"><a id="__codelineno-83-49" name="__codelineno-83-49" href="#__codelineno-83-49"></a>    <span class="n">top_importance</span> <span class="o">=</span> <span class="n">avg_importance</span><span class="p">[</span><span class="n">top_indices</span><span class="p">]</span>
</span><span id="__span-83-50"><a id="__codelineno-83-50" name="__codelineno-83-50" href="#__codelineno-83-50"></a>
</span><span id="__span-83-51"><a id="__codelineno-83-51" name="__codelineno-83-51" href="#__codelineno-83-51"></a>    <span class="k">if</span> <span class="n">feature_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-83-52"><a id="__codelineno-83-52" name="__codelineno-83-52" href="#__codelineno-83-52"></a>        <span class="n">top_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="p">]</span>
</span><span id="__span-83-53"><a id="__codelineno-83-53" name="__codelineno-83-53" href="#__codelineno-83-53"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-83-54"><a id="__codelineno-83-54" name="__codelineno-83-54" href="#__codelineno-83-54"></a>        <span class="n">top_features</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Feature </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="p">]</span>
</span><span id="__span-83-55"><a id="__codelineno-83-55" name="__codelineno-83-55" href="#__codelineno-83-55"></a>
</span><span id="__span-83-56"><a id="__codelineno-83-56" name="__codelineno-83-56" href="#__codelineno-83-56"></a>    <span class="c1"># Plot</span>
</span><span id="__span-83-57"><a id="__codelineno-83-57" name="__codelineno-83-57" href="#__codelineno-83-57"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span><span id="__span-83-58"><a id="__codelineno-83-58" name="__codelineno-83-58" href="#__codelineno-83-58"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">top_k</span><span class="p">),</span> <span class="n">top_importance</span><span class="p">)</span>
</span><span id="__span-83-59"><a id="__codelineno-83-59" name="__codelineno-83-59" href="#__codelineno-83-59"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">top_k</span><span class="p">),</span> <span class="n">top_features</span><span class="p">)</span>
</span><span id="__span-83-60"><a id="__codelineno-83-60" name="__codelineno-83-60" href="#__codelineno-83-60"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Importance Score&#39;</span><span class="p">)</span>
</span><span id="__span-83-61"><a id="__codelineno-83-61" name="__codelineno-83-61" href="#__codelineno-83-61"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top </span><span class="si">{</span><span class="n">top_k</span><span class="si">}</span><span class="s1"> Most Important Features&#39;</span><span class="p">)</span>
</span><span id="__span-83-62"><a id="__codelineno-83-62" name="__codelineno-83-62" href="#__codelineno-83-62"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-83-63"><a id="__codelineno-83-63" name="__codelineno-83-63" href="#__codelineno-83-63"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;feature_importance.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</span><span id="__span-83-64"><a id="__codelineno-83-64" name="__codelineno-83-64" href="#__codelineno-83-64"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-83-65"><a id="__codelineno-83-65" name="__codelineno-83-65" href="#__codelineno-83-65"></a>
</span><span id="__span-83-66"><a id="__codelineno-83-66" name="__codelineno-83-66" href="#__codelineno-83-66"></a><span class="c1"># Usage</span>
</span><span id="__span-83-67"><a id="__codelineno-83-67" name="__codelineno-83-67" href="#__codelineno-83-67"></a><span class="n">importance_scores</span> <span class="o">=</span> <span class="n">compute_gradient_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
</span><span id="__span-83-68"><a id="__codelineno-83-68" name="__codelineno-83-68" href="#__codelineno-83-68"></a><span class="n">visualize_feature_importance</span><span class="p">(</span><span class="n">importance_scores</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="82__integrated__gradients">8.2 Integrated Gradients<a class="headerlink" href="#82__integrated__gradients" title="Permanent link">&para;</a></h3>
<p>More accurate attribution method that accounts for baseline:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">integrated_gradients</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">):</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="sd">    Compute integrated gradients for feature attribution</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="sd">    Args:</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="sd">        model: Trained neural network</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="sd">        X: Input features</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="sd">        baseline: Baseline input (default: zero)</span>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a><span class="sd">        steps: Number of integration steps</span>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a><span class="sd">    Returns:</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a><span class="sd">        attributions: Feature attributions</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a>
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a>        <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a>
</span><span id="__span-84-19"><a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-84-20"><a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a>
</span><span id="__span-84-21"><a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a>    <span class="k">if</span> <span class="n">baseline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-84-22"><a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a>        <span class="n">baseline</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="__span-84-23"><a id="__codelineno-84-23" name="__codelineno-84-23" href="#__codelineno-84-23"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-84-24"><a id="__codelineno-84-24" name="__codelineno-84-24" href="#__codelineno-84-24"></a>        <span class="n">baseline</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-84-25"><a id="__codelineno-84-25" name="__codelineno-84-25" href="#__codelineno-84-25"></a>
</span><span id="__span-84-26"><a id="__codelineno-84-26" name="__codelineno-84-26" href="#__codelineno-84-26"></a>    <span class="c1"># Generate interpolated inputs</span>
</span><span id="__span-84-27"><a id="__codelineno-84-27" name="__codelineno-84-27" href="#__codelineno-84-27"></a>    <span class="n">alphas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-84-28"><a id="__codelineno-84-28" name="__codelineno-84-28" href="#__codelineno-84-28"></a>    <span class="n">interpolated_inputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-84-29"><a id="__codelineno-84-29" name="__codelineno-84-29" href="#__codelineno-84-29"></a>
</span><span id="__span-84-30"><a id="__codelineno-84-30" name="__codelineno-84-30" href="#__codelineno-84-30"></a>    <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">:</span>
</span><span id="__span-84-31"><a id="__codelineno-84-31" name="__codelineno-84-31" href="#__codelineno-84-31"></a>        <span class="n">interpolated</span> <span class="o">=</span> <span class="n">baseline</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">)</span>
</span><span id="__span-84-32"><a id="__codelineno-84-32" name="__codelineno-84-32" href="#__codelineno-84-32"></a>        <span class="n">interpolated_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolated</span><span class="p">)</span>
</span><span id="__span-84-33"><a id="__codelineno-84-33" name="__codelineno-84-33" href="#__codelineno-84-33"></a>
</span><span id="__span-84-34"><a id="__codelineno-84-34" name="__codelineno-84-34" href="#__codelineno-84-34"></a>    <span class="n">interpolated_inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">interpolated_inputs</span><span class="p">)</span>
</span><span id="__span-84-35"><a id="__codelineno-84-35" name="__codelineno-84-35" href="#__codelineno-84-35"></a>
</span><span id="__span-84-36"><a id="__codelineno-84-36" name="__codelineno-84-36" href="#__codelineno-84-36"></a>    <span class="c1"># Compute gradients for each interpolated input</span>
</span><span id="__span-84-37"><a id="__codelineno-84-37" name="__codelineno-84-37" href="#__codelineno-84-37"></a>    <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-84-38"><a id="__codelineno-84-38" name="__codelineno-84-38" href="#__codelineno-84-38"></a>
</span><span id="__span-84-39"><a id="__codelineno-84-39" name="__codelineno-84-39" href="#__codelineno-84-39"></a>    <span class="k">for</span> <span class="n">interp_input</span> <span class="ow">in</span> <span class="n">interpolated_inputs</span><span class="p">:</span>
</span><span id="__span-84-40"><a id="__codelineno-84-40" name="__codelineno-84-40" href="#__codelineno-84-40"></a>        <span class="n">interp_input</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-84-41"><a id="__codelineno-84-41" name="__codelineno-84-41" href="#__codelineno-84-41"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">interp_input</span><span class="p">)</span>
</span><span id="__span-84-42"><a id="__codelineno-84-42" name="__codelineno-84-42" href="#__codelineno-84-42"></a>
</span><span id="__span-84-43"><a id="__codelineno-84-43" name="__codelineno-84-43" href="#__codelineno-84-43"></a>        <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-84-44"><a id="__codelineno-84-44" name="__codelineno-84-44" href="#__codelineno-84-44"></a>        <span class="n">output</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-84-45"><a id="__codelineno-84-45" name="__codelineno-84-45" href="#__codelineno-84-45"></a>
</span><span id="__span-84-46"><a id="__codelineno-84-46" name="__codelineno-84-46" href="#__codelineno-84-46"></a>        <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp_input</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
</span><span id="__span-84-47"><a id="__codelineno-84-47" name="__codelineno-84-47" href="#__codelineno-84-47"></a>
</span><span id="__span-84-48"><a id="__codelineno-84-48" name="__codelineno-84-48" href="#__codelineno-84-48"></a>    <span class="n">gradients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">gradients</span><span class="p">)</span>
</span><span id="__span-84-49"><a id="__codelineno-84-49" name="__codelineno-84-49" href="#__codelineno-84-49"></a>
</span><span id="__span-84-50"><a id="__codelineno-84-50" name="__codelineno-84-50" href="#__codelineno-84-50"></a>    <span class="c1"># Average gradients and multiply by input difference</span>
</span><span id="__span-84-51"><a id="__codelineno-84-51" name="__codelineno-84-51" href="#__codelineno-84-51"></a>    <span class="n">avg_gradients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-84-52"><a id="__codelineno-84-52" name="__codelineno-84-52" href="#__codelineno-84-52"></a>    <span class="n">attributions</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="o">-</span> <span class="n">baseline</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span> <span class="o">*</span> <span class="n">avg_gradients</span>
</span><span id="__span-84-53"><a id="__codelineno-84-53" name="__codelineno-84-53" href="#__codelineno-84-53"></a>
</span><span id="__span-84-54"><a id="__codelineno-84-54" name="__codelineno-84-54" href="#__codelineno-84-54"></a>    <span class="k">return</span> <span class="n">attributions</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-84-55"><a id="__codelineno-84-55" name="__codelineno-84-55" href="#__codelineno-84-55"></a>
</span><span id="__span-84-56"><a id="__codelineno-84-56" name="__codelineno-84-56" href="#__codelineno-84-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">explain_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">importance_method</span><span class="o">=</span><span class="s1">&#39;integrated_gradients&#39;</span><span class="p">):</span>
</span><span id="__span-84-57"><a id="__codelineno-84-57" name="__codelineno-84-57" href="#__codelineno-84-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-84-58"><a id="__codelineno-84-58" name="__codelineno-84-58" href="#__codelineno-84-58"></a><span class="sd">    Explain prediction for a single molecule</span>
</span><span id="__span-84-59"><a id="__codelineno-84-59" name="__codelineno-84-59" href="#__codelineno-84-59"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-84-60"><a id="__codelineno-84-60" name="__codelineno-84-60" href="#__codelineno-84-60"></a>    <span class="c1"># Encode SMILES</span>
</span><span id="__span-84-61"><a id="__codelineno-84-61" name="__codelineno-84-61" href="#__codelineno-84-61"></a>    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-84-62"><a id="__codelineno-84-62" name="__codelineno-84-62" href="#__codelineno-84-62"></a>    <span class="n">fp</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</span><span id="__span-84-63"><a id="__codelineno-84-63" name="__codelineno-84-63" href="#__codelineno-84-63"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-84-64"><a id="__codelineno-84-64" name="__codelineno-84-64" href="#__codelineno-84-64"></a>
</span><span id="__span-84-65"><a id="__codelineno-84-65" name="__codelineno-84-65" href="#__codelineno-84-65"></a>    <span class="c1"># Get prediction</span>
</span><span id="__span-84-66"><a id="__codelineno-84-66" name="__codelineno-84-66" href="#__codelineno-84-66"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-84-67"><a id="__codelineno-84-67" name="__codelineno-84-67" href="#__codelineno-84-67"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-84-68"><a id="__codelineno-84-68" name="__codelineno-84-68" href="#__codelineno-84-68"></a>        <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">X</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-84-69"><a id="__codelineno-84-69" name="__codelineno-84-69" href="#__codelineno-84-69"></a>
</span><span id="__span-84-70"><a id="__codelineno-84-70" name="__codelineno-84-70" href="#__codelineno-84-70"></a>    <span class="c1"># Get importance</span>
</span><span id="__span-84-71"><a id="__codelineno-84-71" name="__codelineno-84-71" href="#__codelineno-84-71"></a>    <span class="k">if</span> <span class="n">importance_method</span> <span class="o">==</span> <span class="s1">&#39;integrated_gradients&#39;</span><span class="p">:</span>
</span><span id="__span-84-72"><a id="__codelineno-84-72" name="__codelineno-84-72" href="#__codelineno-84-72"></a>        <span class="n">importance</span> <span class="o">=</span> <span class="n">integrated_gradients</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</span><span id="__span-84-73"><a id="__codelineno-84-73" name="__codelineno-84-73" href="#__codelineno-84-73"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-84-74"><a id="__codelineno-84-74" name="__codelineno-84-74" href="#__codelineno-84-74"></a>        <span class="n">importance</span> <span class="o">=</span> <span class="n">compute_gradient_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</span><span id="__span-84-75"><a id="__codelineno-84-75" name="__codelineno-84-75" href="#__codelineno-84-75"></a>
</span><span id="__span-84-76"><a id="__codelineno-84-76" name="__codelineno-84-76" href="#__codelineno-84-76"></a>    <span class="c1"># Visualize</span>
</span><span id="__span-84-77"><a id="__codelineno-84-77" name="__codelineno-84-77" href="#__codelineno-84-77"></a>    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="__span-84-78"><a id="__codelineno-84-78" name="__codelineno-84-78" href="#__codelineno-84-78"></a>
</span><span id="__span-84-79"><a id="__codelineno-84-79" name="__codelineno-84-79" href="#__codelineno-84-79"></a>    <span class="c1"># Draw molecule</span>
</span><span id="__span-84-80"><a id="__codelineno-84-80" name="__codelineno-84-80" href="#__codelineno-84-80"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolToImage</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
</span><span id="__span-84-81"><a id="__codelineno-84-81" name="__codelineno-84-81" href="#__codelineno-84-81"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="__span-84-82"><a id="__codelineno-84-82" name="__codelineno-84-82" href="#__codelineno-84-82"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</span><span id="__span-84-83"><a id="__codelineno-84-83" name="__codelineno-84-83" href="#__codelineno-84-83"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Predicted logBB: </span><span class="si">{</span><span class="n">prediction</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-84-84"><a id="__codelineno-84-84" name="__codelineno-84-84" href="#__codelineno-84-84"></a>
</span><span id="__span-84-85"><a id="__codelineno-84-85" name="__codelineno-84-85" href="#__codelineno-84-85"></a>    <span class="c1"># Plot importance</span>
</span><span id="__span-84-86"><a id="__codelineno-84-86" name="__codelineno-84-86" href="#__codelineno-84-86"></a>    <span class="n">top_k</span> <span class="o">=</span> <span class="mi">50</span>
</span><span id="__span-84-87"><a id="__codelineno-84-87" name="__codelineno-84-87" href="#__codelineno-84-87"></a>    <span class="n">top_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">importance</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="o">-</span><span class="n">top_k</span><span class="p">:]</span>
</span><span id="__span-84-88"><a id="__codelineno-84-88" name="__codelineno-84-88" href="#__codelineno-84-88"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">top_k</span><span class="p">),</span> <span class="n">importance</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_indices</span><span class="p">])</span>
</span><span id="__span-84-89"><a id="__codelineno-84-89" name="__codelineno-84-89" href="#__codelineno-84-89"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Attribution Score&#39;</span><span class="p">)</span>
</span><span id="__span-84-90"><a id="__codelineno-84-90" name="__codelineno-84-90" href="#__codelineno-84-90"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Fingerprint Bit&#39;</span><span class="p">)</span>
</span><span id="__span-84-91"><a id="__codelineno-84-91" name="__codelineno-84-91" href="#__codelineno-84-91"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Feature Attributions (Integrated Gradients)&#39;</span><span class="p">)</span>
</span><span id="__span-84-92"><a id="__codelineno-84-92" name="__codelineno-84-92" href="#__codelineno-84-92"></a>
</span><span id="__span-84-93"><a id="__codelineno-84-93" name="__codelineno-84-93" href="#__codelineno-84-93"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-84-94"><a id="__codelineno-84-94" name="__codelineno-84-94" href="#__codelineno-84-94"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;explanation_</span><span class="si">{</span><span class="n">smiles</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</span><span id="__span-84-95"><a id="__codelineno-84-95" name="__codelineno-84-95" href="#__codelineno-84-95"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-84-96"><a id="__codelineno-84-96" name="__codelineno-84-96" href="#__codelineno-84-96"></a>
</span><span id="__span-84-97"><a id="__codelineno-84-97" name="__codelineno-84-97" href="#__codelineno-84-97"></a>    <span class="k">return</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">importance</span>
</span></code></pre></div>
<h3 id="83__activation__maximization">8.3 Activation Maximization<a class="headerlink" href="#83__activation__maximization" title="Permanent link">&para;</a></h3>
<p>Find input patterns that maximally activate specific neurons:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">activation_maximization</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="p">,</span> 
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a>                           <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2048</span><span class="p">),</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="sd">    Find input that maximally activates a specific neuron</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="sd">    Args:</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="sd">        model: Neural network</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="sd">        layer_name: Name of layer to analyze</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="sd">        neuron_idx: Index of neuron in that layer</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a><span class="sd">        input_shape: Shape of input</span>
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="sd">        iterations: Number of optimization steps</span>
</span><span id="__span-85-12"><a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a><span class="sd">        lr: Learning rate</span>
</span><span id="__span-85-13"><a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a>
</span><span id="__span-85-14"><a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a><span class="sd">    Returns:</span>
</span><span id="__span-85-15"><a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a><span class="sd">        optimal_input: Input that maximizes activation</span>
</span><span id="__span-85-16"><a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-85-17"><a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-85-18"><a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a>
</span><span id="__span-85-19"><a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a>    <span class="c1"># Initialize random input</span>
</span><span id="__span-85-20"><a id="__codelineno-85-20" name="__codelineno-85-20" href="#__codelineno-85-20"></a>    <span class="n">optimal_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-85-21"><a id="__codelineno-85-21" name="__codelineno-85-21" href="#__codelineno-85-21"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">([</span><span class="n">optimal_input</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span><span id="__span-85-22"><a id="__codelineno-85-22" name="__codelineno-85-22" href="#__codelineno-85-22"></a>
</span><span id="__span-85-23"><a id="__codelineno-85-23" name="__codelineno-85-23" href="#__codelineno-85-23"></a>    <span class="c1"># Get layer</span>
</span><span id="__span-85-24"><a id="__codelineno-85-24" name="__codelineno-85-24" href="#__codelineno-85-24"></a>    <span class="n">activation</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-85-25"><a id="__codelineno-85-25" name="__codelineno-85-25" href="#__codelineno-85-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_activation</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span id="__span-85-26"><a id="__codelineno-85-26" name="__codelineno-85-26" href="#__codelineno-85-26"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">hook</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</span><span id="__span-85-27"><a id="__codelineno-85-27" name="__codelineno-85-27" href="#__codelineno-85-27"></a>            <span class="n">activation</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
</span><span id="__span-85-28"><a id="__codelineno-85-28" name="__codelineno-85-28" href="#__codelineno-85-28"></a>        <span class="k">return</span> <span class="n">hook</span>
</span><span id="__span-85-29"><a id="__codelineno-85-29" name="__codelineno-85-29" href="#__codelineno-85-29"></a>
</span><span id="__span-85-30"><a id="__codelineno-85-30" name="__codelineno-85-30" href="#__codelineno-85-30"></a>    <span class="c1"># Register hook</span>
</span><span id="__span-85-31"><a id="__codelineno-85-31" name="__codelineno-85-31" href="#__codelineno-85-31"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
</span><span id="__span-85-32"><a id="__codelineno-85-32" name="__codelineno-85-32" href="#__codelineno-85-32"></a>        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">layer_name</span><span class="p">:</span>
</span><span id="__span-85-33"><a id="__codelineno-85-33" name="__codelineno-85-33" href="#__codelineno-85-33"></a>            <span class="n">module</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">get_activation</span><span class="p">(</span><span class="n">layer_name</span><span class="p">))</span>
</span><span id="__span-85-34"><a id="__codelineno-85-34" name="__codelineno-85-34" href="#__codelineno-85-34"></a>            <span class="k">break</span>
</span><span id="__span-85-35"><a id="__codelineno-85-35" name="__codelineno-85-35" href="#__codelineno-85-35"></a>
</span><span id="__span-85-36"><a id="__codelineno-85-36" name="__codelineno-85-36" href="#__codelineno-85-36"></a>    <span class="c1"># Optimize</span>
</span><span id="__span-85-37"><a id="__codelineno-85-37" name="__codelineno-85-37" href="#__codelineno-85-37"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
</span><span id="__span-85-38"><a id="__codelineno-85-38" name="__codelineno-85-38" href="#__codelineno-85-38"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-85-39"><a id="__codelineno-85-39" name="__codelineno-85-39" href="#__codelineno-85-39"></a>
</span><span id="__span-85-40"><a id="__codelineno-85-40" name="__codelineno-85-40" href="#__codelineno-85-40"></a>        <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">optimal_input</span><span class="p">)</span>
</span><span id="__span-85-41"><a id="__codelineno-85-41" name="__codelineno-85-41" href="#__codelineno-85-41"></a>
</span><span id="__span-85-42"><a id="__codelineno-85-42" name="__codelineno-85-42" href="#__codelineno-85-42"></a>        <span class="c1"># Loss = negative activation (we want to maximize)</span>
</span><span id="__span-85-43"><a id="__codelineno-85-43" name="__codelineno-85-43" href="#__codelineno-85-43"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">activation</span><span class="p">[</span><span class="n">layer_name</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="p">]</span>
</span><span id="__span-85-44"><a id="__codelineno-85-44" name="__codelineno-85-44" href="#__codelineno-85-44"></a>
</span><span id="__span-85-45"><a id="__codelineno-85-45" name="__codelineno-85-45" href="#__codelineno-85-45"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-85-46"><a id="__codelineno-85-46" name="__codelineno-85-46" href="#__codelineno-85-46"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-85-47"><a id="__codelineno-85-47" name="__codelineno-85-47" href="#__codelineno-85-47"></a>
</span><span id="__span-85-48"><a id="__codelineno-85-48" name="__codelineno-85-48" href="#__codelineno-85-48"></a>        <span class="c1"># Clip to valid range [0, 1] for fingerprints</span>
</span><span id="__span-85-49"><a id="__codelineno-85-49" name="__codelineno-85-49" href="#__codelineno-85-49"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-85-50"><a id="__codelineno-85-50" name="__codelineno-85-50" href="#__codelineno-85-50"></a>            <span class="n">optimal_input</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-85-51"><a id="__codelineno-85-51" name="__codelineno-85-51" href="#__codelineno-85-51"></a>
</span><span id="__span-85-52"><a id="__codelineno-85-52" name="__codelineno-85-52" href="#__codelineno-85-52"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-85-53"><a id="__codelineno-85-53" name="__codelineno-85-53" href="#__codelineno-85-53"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, Activation: </span><span class="si">{</span><span class="o">-</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-85-54"><a id="__codelineno-85-54" name="__codelineno-85-54" href="#__codelineno-85-54"></a>
</span><span id="__span-85-55"><a id="__codelineno-85-55" name="__codelineno-85-55" href="#__codelineno-85-55"></a>    <span class="k">return</span> <span class="n">optimal_input</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-85-56"><a id="__codelineno-85-56" name="__codelineno-85-56" href="#__codelineno-85-56"></a>
</span><span id="__span-85-57"><a id="__codelineno-85-57" name="__codelineno-85-57" href="#__codelineno-85-57"></a><span class="c1"># Usage</span>
</span><span id="__span-85-58"><a id="__codelineno-85-58" name="__codelineno-85-58" href="#__codelineno-85-58"></a><span class="n">optimal_fp</span> <span class="o">=</span> <span class="n">activation_maximization</span><span class="p">(</span>
</span><span id="__span-85-59"><a id="__codelineno-85-59" name="__codelineno-85-59" href="#__codelineno-85-59"></a>    <span class="n">model</span><span class="p">,</span> 
</span><span id="__span-85-60"><a id="__codelineno-85-60" name="__codelineno-85-60" href="#__codelineno-85-60"></a>    <span class="n">layer_name</span><span class="o">=</span><span class="s1">&#39;network.4&#39;</span><span class="p">,</span>  <span class="c1"># Second hidden layer</span>
</span><span id="__span-85-61"><a id="__codelineno-85-61" name="__codelineno-85-61" href="#__codelineno-85-61"></a>    <span class="n">neuron_idx</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="__span-85-62"><a id="__codelineno-85-62" name="__codelineno-85-62" href="#__codelineno-85-62"></a>    <span class="n">iterations</span><span class="o">=</span><span class="mi">1000</span>
</span><span id="__span-85-63"><a id="__codelineno-85-63" name="__codelineno-85-63" href="#__codelineno-85-63"></a><span class="p">)</span>
</span><span id="__span-85-64"><a id="__codelineno-85-64" name="__codelineno-85-64" href="#__codelineno-85-64"></a>
</span><span id="__span-85-65"><a id="__codelineno-85-65" name="__codelineno-85-65" href="#__codelineno-85-65"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal fingerprint pattern: </span><span class="si">{</span><span class="n">optimal_fp</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-85-66"><a id="__codelineno-85-66" name="__codelineno-85-66" href="#__codelineno-85-66"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of active bits: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">optimal_fp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Attention Visualization for LSTM:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_attention</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="sd">    Visualize attention weights for LSTM model with attention</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a>    <span class="c1"># Encode SMILES</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a>    <span class="n">encoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">encoded</span><span class="p">])</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a>    <span class="c1"># Get prediction and attention weights</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a>        <span class="n">prediction</span><span class="p">,</span> <span class="n">attention_weights</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a>    <span class="c1"># Plot attention</span>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a>    <span class="n">attention</span> <span class="o">=</span> <span class="n">attention_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a>    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a>
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="__span-86-19"><a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)),</span> <span class="n">attention</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)])</span>
</span><span id="__span-86-20"><a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)),</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
</span><span id="__span-86-21"><a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;SMILES Token&#39;</span><span class="p">)</span>
</span><span id="__span-86-22"><a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Attention Weight&#39;</span><span class="p">)</span>
</span><span id="__span-86-23"><a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attention Weights for: </span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="se">\n</span><span class="s1">Prediction: </span><span class="si">{</span><span class="n">prediction</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="__span-86-24"><a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-86-25"><a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;attention_visualization.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</span><span id="__span-86-26"><a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h2 id="9__best__practices">9. Best Practices<a class="headerlink" href="#9__best__practices" title="Permanent link">&para;</a></h2>
<h3 id="91__hyperparameter__tuning__with__optuna">9.1 Hyperparameter Tuning with Optuna<a class="headerlink" href="#91__hyperparameter__tuning__with__optuna" title="Permanent link">&para;</a></h3>
<p>Automated hyperparameter optimization:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">optuna</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">optuna.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_optimization_history</span><span class="p">,</span> <span class="n">plot_param_importances</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="sd">    Objective function for Optuna hyperparameter optimization</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>    <span class="c1"># Suggest hyperparameters</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>        <span class="s1">&#39;hidden_dim_1&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;hidden_dim_1&#39;</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">128</span><span class="p">),</span>
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>        <span class="s1">&#39;hidden_dim_2&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;hidden_dim_2&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span>
</span><span id="__span-87-12"><a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a>        <span class="s1">&#39;hidden_dim_3&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;hidden_dim_3&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span>
</span><span id="__span-87-13"><a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>        <span class="s1">&#39;dropout_rate&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s1">&#39;dropout_rate&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span id="__span-87-14"><a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a>        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_loguniform</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">),</span>
</span><span id="__span-87-15"><a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a>        <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]),</span>
</span><span id="__span-87-16"><a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a>        <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_loguniform</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
</span><span id="__span-87-17"><a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a>    <span class="p">}</span>
</span><span id="__span-87-18"><a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a>
</span><span id="__span-87-19"><a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a>    <span class="c1"># Create model</span>
</span><span id="__span-87-20"><a id="__codelineno-87-20" name="__codelineno-87-20" href="#__codelineno-87-20"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">MolecularFNN</span><span class="p">(</span>
</span><span id="__span-87-21"><a id="__codelineno-87-21" name="__codelineno-87-21" href="#__codelineno-87-21"></a>        <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-87-22"><a id="__codelineno-87-22" name="__codelineno-87-22" href="#__codelineno-87-22"></a>        <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hidden_dim_1&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hidden_dim_2&#39;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hidden_dim_3&#39;</span><span class="p">]],</span>
</span><span id="__span-87-23"><a id="__codelineno-87-23" name="__codelineno-87-23" href="#__codelineno-87-23"></a>        <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-87-24"><a id="__codelineno-87-24" name="__codelineno-87-24" href="#__codelineno-87-24"></a>        <span class="n">dropout_rate</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dropout_rate&#39;</span><span class="p">]</span>
</span><span id="__span-87-25"><a id="__codelineno-87-25" name="__codelineno-87-25" href="#__codelineno-87-25"></a>    <span class="p">)</span>
</span><span id="__span-87-26"><a id="__codelineno-87-26" name="__codelineno-87-26" href="#__codelineno-87-26"></a>
</span><span id="__span-87-27"><a id="__codelineno-87-27" name="__codelineno-87-27" href="#__codelineno-87-27"></a>    <span class="c1"># Create dataloaders</span>
</span><span id="__span-87-28"><a id="__codelineno-87-28" name="__codelineno-87-28" href="#__codelineno-87-28"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">BBBDataset</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</span><span id="__span-87-29"><a id="__codelineno-87-29" name="__codelineno-87-29" href="#__codelineno-87-29"></a>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">BBBDataset</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
</span><span id="__span-87-30"><a id="__codelineno-87-30" name="__codelineno-87-30" href="#__codelineno-87-30"></a>
</span><span id="__span-87-31"><a id="__codelineno-87-31" name="__codelineno-87-31" href="#__codelineno-87-31"></a>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-87-32"><a id="__codelineno-87-32" name="__codelineno-87-32" href="#__codelineno-87-32"></a>    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])</span>
</span><span id="__span-87-33"><a id="__codelineno-87-33" name="__codelineno-87-33" href="#__codelineno-87-33"></a>
</span><span id="__span-87-34"><a id="__codelineno-87-34" name="__codelineno-87-34" href="#__codelineno-87-34"></a>    <span class="c1"># Train</span>
</span><span id="__span-87-35"><a id="__codelineno-87-35" name="__codelineno-87-35" href="#__codelineno-87-35"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> 
</span><span id="__span-87-36"><a id="__codelineno-87-36" name="__codelineno-87-36" href="#__codelineno-87-36"></a>                          <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">],</span>
</span><span id="__span-87-37"><a id="__codelineno-87-37" name="__codelineno-87-37" href="#__codelineno-87-37"></a>                          <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">])</span>
</span><span id="__span-87-38"><a id="__codelineno-87-38" name="__codelineno-87-38" href="#__codelineno-87-38"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-87-39"><a id="__codelineno-87-39" name="__codelineno-87-39" href="#__codelineno-87-39"></a>
</span><span id="__span-87-40"><a id="__codelineno-87-40" name="__codelineno-87-40" href="#__codelineno-87-40"></a>    <span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Reduced for faster tuning</span>
</span><span id="__span-87-41"><a id="__codelineno-87-41" name="__codelineno-87-41" href="#__codelineno-87-41"></a>
</span><span id="__span-87-42"><a id="__codelineno-87-42" name="__codelineno-87-42" href="#__codelineno-87-42"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
</span><span id="__span-87-43"><a id="__codelineno-87-43" name="__codelineno-87-43" href="#__codelineno-87-43"></a>        <span class="c1"># Training</span>
</span><span id="__span-87-44"><a id="__codelineno-87-44" name="__codelineno-87-44" href="#__codelineno-87-44"></a>        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-87-45"><a id="__codelineno-87-45" name="__codelineno-87-45" href="#__codelineno-87-45"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
</span><span id="__span-87-46"><a id="__codelineno-87-46" name="__codelineno-87-46" href="#__codelineno-87-46"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-87-47"><a id="__codelineno-87-47" name="__codelineno-87-47" href="#__codelineno-87-47"></a>            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-87-48"><a id="__codelineno-87-48" name="__codelineno-87-48" href="#__codelineno-87-48"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-87-49"><a id="__codelineno-87-49" name="__codelineno-87-49" href="#__codelineno-87-49"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-87-50"><a id="__codelineno-87-50" name="__codelineno-87-50" href="#__codelineno-87-50"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-87-51"><a id="__codelineno-87-51" name="__codelineno-87-51" href="#__codelineno-87-51"></a>
</span><span id="__span-87-52"><a id="__codelineno-87-52" name="__codelineno-87-52" href="#__codelineno-87-52"></a>        <span class="c1"># Validation</span>
</span><span id="__span-87-53"><a id="__codelineno-87-53" name="__codelineno-87-53" href="#__codelineno-87-53"></a>        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-87-54"><a id="__codelineno-87-54" name="__codelineno-87-54" href="#__codelineno-87-54"></a>        <span class="n">val_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-87-55"><a id="__codelineno-87-55" name="__codelineno-87-55" href="#__codelineno-87-55"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-87-56"><a id="__codelineno-87-56" name="__codelineno-87-56" href="#__codelineno-87-56"></a>            <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
</span><span id="__span-87-57"><a id="__codelineno-87-57" name="__codelineno-87-57" href="#__codelineno-87-57"></a>                <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-87-58"><a id="__codelineno-87-58" name="__codelineno-87-58" href="#__codelineno-87-58"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-87-59"><a id="__codelineno-87-59" name="__codelineno-87-59" href="#__codelineno-87-59"></a>                <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-87-60"><a id="__codelineno-87-60" name="__codelineno-87-60" href="#__codelineno-87-60"></a>
</span><span id="__span-87-61"><a id="__codelineno-87-61" name="__codelineno-87-61" href="#__codelineno-87-61"></a>        <span class="n">val_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
</span><span id="__span-87-62"><a id="__codelineno-87-62" name="__codelineno-87-62" href="#__codelineno-87-62"></a>
</span><span id="__span-87-63"><a id="__codelineno-87-63" name="__codelineno-87-63" href="#__codelineno-87-63"></a>        <span class="c1"># Report intermediate value for pruning</span>
</span><span id="__span-87-64"><a id="__codelineno-87-64" name="__codelineno-87-64" href="#__codelineno-87-64"></a>        <span class="n">trial</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">val_loss</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
</span><span id="__span-87-65"><a id="__codelineno-87-65" name="__codelineno-87-65" href="#__codelineno-87-65"></a>
</span><span id="__span-87-66"><a id="__codelineno-87-66" name="__codelineno-87-66" href="#__codelineno-87-66"></a>        <span class="c1"># Handle pruning</span>
</span><span id="__span-87-67"><a id="__codelineno-87-67" name="__codelineno-87-67" href="#__codelineno-87-67"></a>        <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
</span><span id="__span-87-68"><a id="__codelineno-87-68" name="__codelineno-87-68" href="#__codelineno-87-68"></a>            <span class="k">raise</span> <span class="n">optuna</span><span class="o">.</span><span class="n">TrialPruned</span><span class="p">()</span>
</span><span id="__span-87-69"><a id="__codelineno-87-69" name="__codelineno-87-69" href="#__codelineno-87-69"></a>
</span><span id="__span-87-70"><a id="__codelineno-87-70" name="__codelineno-87-70" href="#__codelineno-87-70"></a>    <span class="k">return</span> <span class="n">val_loss</span>
</span><span id="__span-87-71"><a id="__codelineno-87-71" name="__codelineno-87-71" href="#__codelineno-87-71"></a>
</span><span id="__span-87-72"><a id="__codelineno-87-72" name="__codelineno-87-72" href="#__codelineno-87-72"></a><span class="c1"># Run optimization</span>
</span><span id="__span-87-73"><a id="__codelineno-87-73" name="__codelineno-87-73" href="#__codelineno-87-73"></a><span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span>
</span><span id="__span-87-74"><a id="__codelineno-87-74" name="__codelineno-87-74" href="#__codelineno-87-74"></a>    <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;minimize&#39;</span><span class="p">,</span>
</span><span id="__span-87-75"><a id="__codelineno-87-75" name="__codelineno-87-75" href="#__codelineno-87-75"></a>    <span class="n">pruner</span><span class="o">=</span><span class="n">optuna</span><span class="o">.</span><span class="n">pruners</span><span class="o">.</span><span class="n">MedianPruner</span><span class="p">(</span><span class="n">n_startup_trials</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_warmup_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-87-76"><a id="__codelineno-87-76" name="__codelineno-87-76" href="#__codelineno-87-76"></a><span class="p">)</span>
</span><span id="__span-87-77"><a id="__codelineno-87-77" name="__codelineno-87-77" href="#__codelineno-87-77"></a>
</span><span id="__span-87-78"><a id="__codelineno-87-78" name="__codelineno-87-78" href="#__codelineno-87-78"></a><span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
</span><span id="__span-87-79"><a id="__codelineno-87-79" name="__codelineno-87-79" href="#__codelineno-87-79"></a>    <span class="k">lambda</span> <span class="n">trial</span><span class="p">:</span> <span class="n">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
</span><span id="__span-87-80"><a id="__codelineno-87-80" name="__codelineno-87-80" href="#__codelineno-87-80"></a>    <span class="n">n_trials</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-87-81"><a id="__codelineno-87-81" name="__codelineno-87-81" href="#__codelineno-87-81"></a>    <span class="n">timeout</span><span class="o">=</span><span class="mi">7200</span>  <span class="c1"># 2 hours</span>
</span><span id="__span-87-82"><a id="__codelineno-87-82" name="__codelineno-87-82" href="#__codelineno-87-82"></a><span class="p">)</span>
</span><span id="__span-87-83"><a id="__codelineno-87-83" name="__codelineno-87-83" href="#__codelineno-87-83"></a>
</span><span id="__span-87-84"><a id="__codelineno-87-84" name="__codelineno-87-84" href="#__codelineno-87-84"></a><span class="c1"># Print results</span>
</span><span id="__span-87-85"><a id="__codelineno-87-85" name="__codelineno-87-85" href="#__codelineno-87-85"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best hyperparameters:&quot;</span><span class="p">)</span>
</span><span id="__span-87-86"><a id="__codelineno-87-86" name="__codelineno-87-86" href="#__codelineno-87-86"></a><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">study</span><span class="o">.</span><span class="n">best_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-87-87"><a id="__codelineno-87-87" name="__codelineno-87-87" href="#__codelineno-87-87"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-87-88"><a id="__codelineno-87-88" name="__codelineno-87-88" href="#__codelineno-87-88"></a>
</span><span id="__span-87-89"><a id="__codelineno-87-89" name="__codelineno-87-89" href="#__codelineno-87-89"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best validation loss: </span><span class="si">{</span><span class="n">study</span><span class="o">.</span><span class="n">best_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-87-90"><a id="__codelineno-87-90" name="__codelineno-87-90" href="#__codelineno-87-90"></a>
</span><span id="__span-87-91"><a id="__codelineno-87-91" name="__codelineno-87-91" href="#__codelineno-87-91"></a><span class="c1"># Visualize</span>
</span><span id="__span-87-92"><a id="__codelineno-87-92" name="__codelineno-87-92" href="#__codelineno-87-92"></a><span class="n">fig1</span> <span class="o">=</span> <span class="n">plot_optimization_history</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
</span><span id="__span-87-93"><a id="__codelineno-87-93" name="__codelineno-87-93" href="#__codelineno-87-93"></a><span class="n">fig1</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;optimization_history.png&#39;</span><span class="p">)</span>
</span><span id="__span-87-94"><a id="__codelineno-87-94" name="__codelineno-87-94" href="#__codelineno-87-94"></a>
</span><span id="__span-87-95"><a id="__codelineno-87-95" name="__codelineno-87-95" href="#__codelineno-87-95"></a><span class="n">fig2</span> <span class="o">=</span> <span class="n">plot_param_importances</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
</span><span id="__span-87-96"><a id="__codelineno-87-96" name="__codelineno-87-96" href="#__codelineno-87-96"></a><span class="n">fig2</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;param_importances.png&#39;</span><span class="p">)</span>
</span><span id="__span-87-97"><a id="__codelineno-87-97" name="__codelineno-87-97" href="#__codelineno-87-97"></a>
</span><span id="__span-87-98"><a id="__codelineno-87-98" name="__codelineno-87-98" href="#__codelineno-87-98"></a><span class="c1"># Train final model with best parameters</span>
</span><span id="__span-87-99"><a id="__codelineno-87-99" name="__codelineno-87-99" href="#__codelineno-87-99"></a><span class="n">best_config</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">best_params</span>
</span><span id="__span-87-100"><a id="__codelineno-87-100" name="__codelineno-87-100" href="#__codelineno-87-100"></a><span class="n">final_model</span> <span class="o">=</span> <span class="n">MolecularFNN</span><span class="p">(</span>
</span><span id="__span-87-101"><a id="__codelineno-87-101" name="__codelineno-87-101" href="#__codelineno-87-101"></a>    <span class="n">input_dim</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="__span-87-102"><a id="__codelineno-87-102" name="__codelineno-87-102" href="#__codelineno-87-102"></a>    <span class="n">hidden_dims</span><span class="o">=</span><span class="p">[</span><span class="n">best_config</span><span class="p">[</span><span class="s1">&#39;hidden_dim_1&#39;</span><span class="p">],</span> 
</span><span id="__span-87-103"><a id="__codelineno-87-103" name="__codelineno-87-103" href="#__codelineno-87-103"></a>                <span class="n">best_config</span><span class="p">[</span><span class="s1">&#39;hidden_dim_2&#39;</span><span class="p">],</span> 
</span><span id="__span-87-104"><a id="__codelineno-87-104" name="__codelineno-87-104" href="#__codelineno-87-104"></a>                <span class="n">best_config</span><span class="p">[</span><span class="s1">&#39;hidden_dim_3&#39;</span><span class="p">]],</span>
</span><span id="__span-87-105"><a id="__codelineno-87-105" name="__codelineno-87-105" href="#__codelineno-87-105"></a>    <span class="n">output_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-87-106"><a id="__codelineno-87-106" name="__codelineno-87-106" href="#__codelineno-87-106"></a>    <span class="n">dropout_rate</span><span class="o">=</span><span class="n">best_config</span><span class="p">[</span><span class="s1">&#39;dropout_rate&#39;</span><span class="p">]</span>
</span><span id="__span-87-107"><a id="__codelineno-87-107" name="__codelineno-87-107" href="#__codelineno-87-107"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="92__complete__debugging__checklist">9.2 Complete Debugging Checklist<a class="headerlink" href="#92__complete__debugging__checklist" title="Permanent link">&para;</a></h3>
<p><strong>Pre-Training Checks:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">pre_training_diagnostics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="sd">    Run diagnostics before training</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PRE-TRAINING DIAGNOSTICS&quot;</span><span class="p">)</span>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a>    <span class="c1"># 1. Check data loading</span>
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Data Loading Check:&quot;</span><span class="p">)</span>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a>        <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Batch shapes: X=</span><span class="si">{</span><span class="n">batch_x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Y=</span><span class="si">{</span><span class="n">batch_y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ X range: [</span><span class="si">{</span><span class="n">batch_x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">batch_x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Y range: [</span><span class="si">{</span><span class="n">batch_y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">batch_y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ No NaN in X: </span><span class="si">{</span><span class="ow">not</span><span class="w"> </span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-19"><a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ No NaN in Y: </span><span class="si">{</span><span class="ow">not</span><span class="w"> </span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">batch_y</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-20"><a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-88-21"><a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✗ Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-22"><a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-88-23"><a id="__codelineno-88-23" name="__codelineno-88-23" href="#__codelineno-88-23"></a>
</span><span id="__span-88-24"><a id="__codelineno-88-24" name="__codelineno-88-24" href="#__codelineno-88-24"></a>    <span class="c1"># 2. Check forward pass</span>
</span><span id="__span-88-25"><a id="__codelineno-88-25" name="__codelineno-88-25" href="#__codelineno-88-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Forward Pass Check:&quot;</span><span class="p">)</span>
</span><span id="__span-88-26"><a id="__codelineno-88-26" name="__codelineno-88-26" href="#__codelineno-88-26"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-88-27"><a id="__codelineno-88-27" name="__codelineno-88-27" href="#__codelineno-88-27"></a>        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-88-28"><a id="__codelineno-88-28" name="__codelineno-88-28" href="#__codelineno-88-28"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-88-29"><a id="__codelineno-88-29" name="__codelineno-88-29" href="#__codelineno-88-29"></a>            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-88-30"><a id="__codelineno-88-30" name="__codelineno-88-30" href="#__codelineno-88-30"></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-88-31"><a id="__codelineno-88-31" name="__codelineno-88-31" href="#__codelineno-88-31"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Output shape: </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-32"><a id="__codelineno-88-32" name="__codelineno-88-32" href="#__codelineno-88-32"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Output range: [</span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-88-33"><a id="__codelineno-88-33" name="__codelineno-88-33" href="#__codelineno-88-33"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ No NaN in output: </span><span class="si">{</span><span class="ow">not</span><span class="w"> </span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-34"><a id="__codelineno-88-34" name="__codelineno-88-34" href="#__codelineno-88-34"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-88-35"><a id="__codelineno-88-35" name="__codelineno-88-35" href="#__codelineno-88-35"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✗ Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-36"><a id="__codelineno-88-36" name="__codelineno-88-36" href="#__codelineno-88-36"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-88-37"><a id="__codelineno-88-37" name="__codelineno-88-37" href="#__codelineno-88-37"></a>
</span><span id="__span-88-38"><a id="__codelineno-88-38" name="__codelineno-88-38" href="#__codelineno-88-38"></a>    <span class="c1"># 3. Check backward pass</span>
</span><span id="__span-88-39"><a id="__codelineno-88-39" name="__codelineno-88-39" href="#__codelineno-88-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Backward Pass Check:&quot;</span><span class="p">)</span>
</span><span id="__span-88-40"><a id="__codelineno-88-40" name="__codelineno-88-40" href="#__codelineno-88-40"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-88-41"><a id="__codelineno-88-41" name="__codelineno-88-41" href="#__codelineno-88-41"></a>        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-88-42"><a id="__codelineno-88-42" name="__codelineno-88-42" href="#__codelineno-88-42"></a>        <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-88-43"><a id="__codelineno-88-43" name="__codelineno-88-43" href="#__codelineno-88-43"></a>        <span class="n">batch_y</span> <span class="o">=</span> <span class="n">batch_y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-88-44"><a id="__codelineno-88-44" name="__codelineno-88-44" href="#__codelineno-88-44"></a>
</span><span id="__span-88-45"><a id="__codelineno-88-45" name="__codelineno-88-45" href="#__codelineno-88-45"></a>        <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-88-46"><a id="__codelineno-88-46" name="__codelineno-88-46" href="#__codelineno-88-46"></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</span><span id="__span-88-47"><a id="__codelineno-88-47" name="__codelineno-88-47" href="#__codelineno-88-47"></a>
</span><span id="__span-88-48"><a id="__codelineno-88-48" name="__codelineno-88-48" href="#__codelineno-88-48"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-88-49"><a id="__codelineno-88-49" name="__codelineno-88-49" href="#__codelineno-88-49"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-88-50"><a id="__codelineno-88-50" name="__codelineno-88-50" href="#__codelineno-88-50"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-88-51"><a id="__codelineno-88-51" name="__codelineno-88-51" href="#__codelineno-88-51"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-88-52"><a id="__codelineno-88-52" name="__codelineno-88-52" href="#__codelineno-88-52"></a>
</span><span id="__span-88-53"><a id="__codelineno-88-53" name="__codelineno-88-53" href="#__codelineno-88-53"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Loss value: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-54"><a id="__codelineno-88-54" name="__codelineno-88-54" href="#__codelineno-88-54"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Loss is finite: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-55"><a id="__codelineno-88-55" name="__codelineno-88-55" href="#__codelineno-88-55"></a>
</span><span id="__span-88-56"><a id="__codelineno-88-56" name="__codelineno-88-56" href="#__codelineno-88-56"></a>        <span class="c1"># Check gradients</span>
</span><span id="__span-88-57"><a id="__codelineno-88-57" name="__codelineno-88-57" href="#__codelineno-88-57"></a>        <span class="n">has_gradients</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-88-58"><a id="__codelineno-88-58" name="__codelineno-88-58" href="#__codelineno-88-58"></a>        <span class="n">max_grad</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-88-59"><a id="__codelineno-88-59" name="__codelineno-88-59" href="#__codelineno-88-59"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
</span><span id="__span-88-60"><a id="__codelineno-88-60" name="__codelineno-88-60" href="#__codelineno-88-60"></a>            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-88-61"><a id="__codelineno-88-61" name="__codelineno-88-61" href="#__codelineno-88-61"></a>                <span class="n">has_gradients</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-88-62"><a id="__codelineno-88-62" name="__codelineno-88-62" href="#__codelineno-88-62"></a>                <span class="n">max_grad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_grad</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="__span-88-63"><a id="__codelineno-88-63" name="__codelineno-88-63" href="#__codelineno-88-63"></a>
</span><span id="__span-88-64"><a id="__codelineno-88-64" name="__codelineno-88-64" href="#__codelineno-88-64"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Gradients computed: </span><span class="si">{</span><span class="n">has_gradients</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-65"><a id="__codelineno-88-65" name="__codelineno-88-65" href="#__codelineno-88-65"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Max gradient: </span><span class="si">{</span><span class="n">max_grad</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-66"><a id="__codelineno-88-66" name="__codelineno-88-66" href="#__codelineno-88-66"></a>
</span><span id="__span-88-67"><a id="__codelineno-88-67" name="__codelineno-88-67" href="#__codelineno-88-67"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-88-68"><a id="__codelineno-88-68" name="__codelineno-88-68" href="#__codelineno-88-68"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Optimizer step successful&quot;</span><span class="p">)</span>
</span><span id="__span-88-69"><a id="__codelineno-88-69" name="__codelineno-88-69" href="#__codelineno-88-69"></a>
</span><span id="__span-88-70"><a id="__codelineno-88-70" name="__codelineno-88-70" href="#__codelineno-88-70"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-88-71"><a id="__codelineno-88-71" name="__codelineno-88-71" href="#__codelineno-88-71"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✗ Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-72"><a id="__codelineno-88-72" name="__codelineno-88-72" href="#__codelineno-88-72"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-88-73"><a id="__codelineno-88-73" name="__codelineno-88-73" href="#__codelineno-88-73"></a>
</span><span id="__span-88-74"><a id="__codelineno-88-74" name="__codelineno-88-74" href="#__codelineno-88-74"></a>    <span class="c1"># 4. Check model parameters</span>
</span><span id="__span-88-75"><a id="__codelineno-88-75" name="__codelineno-88-75" href="#__codelineno-88-75"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Model Parameters Check:&quot;</span><span class="p">)</span>
</span><span id="__span-88-76"><a id="__codelineno-88-76" name="__codelineno-88-76" href="#__codelineno-88-76"></a>    <span class="n">total_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="__span-88-77"><a id="__codelineno-88-77" name="__codelineno-88-77" href="#__codelineno-88-77"></a>    <span class="n">trainable_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
</span><span id="__span-88-78"><a id="__codelineno-88-78" name="__codelineno-88-78" href="#__codelineno-88-78"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Total parameters: </span><span class="si">{</span><span class="n">total_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-79"><a id="__codelineno-88-79" name="__codelineno-88-79" href="#__codelineno-88-79"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Trainable parameters: </span><span class="si">{</span><span class="n">trainable_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-80"><a id="__codelineno-88-80" name="__codelineno-88-80" href="#__codelineno-88-80"></a>
</span><span id="__span-88-81"><a id="__codelineno-88-81" name="__codelineno-88-81" href="#__codelineno-88-81"></a>    <span class="c1"># 5. Check learning rate</span>
</span><span id="__span-88-82"><a id="__codelineno-88-82" name="__codelineno-88-82" href="#__codelineno-88-82"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">5. Optimizer Check:&quot;</span><span class="p">)</span>
</span><span id="__span-88-83"><a id="__codelineno-88-83" name="__codelineno-88-83" href="#__codelineno-88-83"></a>    <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
</span><span id="__span-88-84"><a id="__codelineno-88-84" name="__codelineno-88-84" href="#__codelineno-88-84"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Learning rate: </span><span class="si">{</span><span class="n">param_group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-88-85"><a id="__codelineno-88-85" name="__codelineno-88-85" href="#__codelineno-88-85"></a>
</span><span id="__span-88-86"><a id="__codelineno-88-86" name="__codelineno-88-86" href="#__codelineno-88-86"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-88-87"><a id="__codelineno-88-87" name="__codelineno-88-87" href="#__codelineno-88-87"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ALL CHECKS PASSED - READY TO TRAIN&quot;</span><span class="p">)</span>
</span><span id="__span-88-88"><a id="__codelineno-88-88" name="__codelineno-88-88" href="#__codelineno-88-88"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-88-89"><a id="__codelineno-88-89" name="__codelineno-88-89" href="#__codelineno-88-89"></a>
</span><span id="__span-88-90"><a id="__codelineno-88-90" name="__codelineno-88-90" href="#__codelineno-88-90"></a>    <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-88-91"><a id="__codelineno-88-91" name="__codelineno-88-91" href="#__codelineno-88-91"></a>
</span><span id="__span-88-92"><a id="__codelineno-88-92" name="__codelineno-88-92" href="#__codelineno-88-92"></a><span class="c1"># Run diagnostics</span>
</span><span id="__span-88-93"><a id="__codelineno-88-93" name="__codelineno-88-93" href="#__codelineno-88-93"></a><span class="k">if</span> <span class="n">pre_training_diagnostics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">):</span>
</span><span id="__span-88-94"><a id="__codelineno-88-94" name="__codelineno-88-94" href="#__codelineno-88-94"></a>    <span class="c1"># Start training</span>
</span><span id="__span-88-95"><a id="__codelineno-88-95" name="__codelineno-88-95" href="#__codelineno-88-95"></a>    <span class="n">train_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="93__common__issues__and__solutions">9.3 Common Issues and Solutions<a class="headerlink" href="#93__common__issues__and__solutions" title="Permanent link">&para;</a></h3>
<p><strong>Comprehensive Troubleshooting Table:</strong></p>
<table>
<thead>
<tr>
<th>Issue</th>
<th>Symptoms</th>
<th>Possible Causes</th>
<th>Solutions</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Loss is NaN</strong></td>
<td>Loss becomes NaN during training</td>
<td>- Learning rate too high<br>- Gradient explosion<br>- Invalid inputs</td>
<td>- Reduce learning rate by 10x<br>- Add gradient clipping<br>- Check for NaN/Inf in data<br>- Use mixed precision training</td>
</tr>
<tr>
<td><strong>Loss not decreasing</strong></td>
<td>Loss stays constant or increases</td>
<td>- Learning rate too low<br>- Wrong loss function<br>- Data not normalized<br>- Model too simple</td>
<td>- Increase learning rate<br>- Verify loss function matches task<br>- Normalize inputs<br>- Increase model capacity</td>
</tr>
<tr>
<td><strong>Overfitting</strong></td>
<td>Train loss &lt;&lt; Val loss</td>
<td>- Model too complex<br>- Too little data<br>- Insufficient regularization</td>
<td>- Add dropout (0.3-0.5)<br>- Add L2 regularization<br>- Use data augmentation<br>- Reduce model size<br>- Early stopping</td>
</tr>
<tr>
<td><strong>Underfitting</strong></td>
<td>Both losses high</td>
<td>- Model too simple<br>- Training time insufficient<br>- Learning rate issues</td>
<td>- Increase model capacity<br>- Train longer<br>- Tune learning rate<br>- Remove excessive regularization</td>
</tr>
<tr>
<td><strong>Slow training</strong></td>
<td>Training takes too long</td>
<td>- Batch size too small<br>- Model too large<br>- Inefficient data loading</td>
<td>- Increase batch size<br>- Use GPU<br>- Enable data loader workers<br>- Use mixed precision</td>
</tr>
<tr>
<td><strong>Unstable training</strong></td>
<td>Loss oscillates wildly</td>
<td>- Learning rate too high<br>- Batch size too small<br>- Poor initialization</td>
<td>- Reduce learning rate<br>- Increase batch size<br>- Use learning rate scheduler<br>- Use batch normalization</td>
</tr>
<tr>
<td><strong>Poor test performance</strong></td>
<td>Test worse than validation</td>
<td>- Data leakage<br>- Different distribution<br>- Overfitting to val set</td>
<td>- Check train/val/test splits<br>- Verify data preprocessing<br>- Use stratified splitting</td>
</tr>
<tr>
<td><strong>Gradient vanishing</strong></td>
<td>Gradients become very small</td>
<td>- Too many layers<br>- Wrong activation<br>- Poor initialization</td>
<td>- Use ReLU/Leaky ReLU<br>- Reduce number of layers<br>- Use skip connections<br>- Use batch normalization</td>
</tr>
<tr>
<td><strong>Out of memory</strong></td>
<td>CUDA out of memory</td>
<td>- Batch size too large<br>- Model too large<br>- Gradient accumulation needed</td>
<td>- Reduce batch size<br>- Use gradient checkpointing<br>- Use mixed precision<br>- Clear cache regularly</td>
</tr>
</tbody>
</table>
<p><strong>Debugging Code:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">debug_training_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">):</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="sd">    Detailed debugging of single training step</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUGGING TRAINING STEP&quot;</span><span class="p">)</span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a>    <span class="c1"># 1. Input check</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Input Check:&quot;</span><span class="p">)</span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  X shape: </span><span class="si">{</span><span class="n">batch_x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">batch_x</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Y shape: </span><span class="si">{</span><span class="n">batch_y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, dtype: </span><span class="si">{</span><span class="n">batch_y</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  X range: [</span><span class="si">{</span><span class="n">batch_x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">batch_x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Y range: [</span><span class="si">{</span><span class="n">batch_y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">batch_y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  X has NaN: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Y has NaN: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">batch_y</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a>
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a>    <span class="c1"># 2. Forward pass</span>
</span><span id="__span-89-19"><a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Forward Pass:&quot;</span><span class="p">)</span>
</span><span id="__span-89-20"><a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-89-21"><a id="__codelineno-89-21" name="__codelineno-89-21" href="#__codelineno-89-21"></a>    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-89-22"><a id="__codelineno-89-22" name="__codelineno-89-22" href="#__codelineno-89-22"></a>
</span><span id="__span-89-23"><a id="__codelineno-89-23" name="__codelineno-89-23" href="#__codelineno-89-23"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-89-24"><a id="__codelineno-89-24" name="__codelineno-89-24" href="#__codelineno-89-24"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Output shape: </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-25"><a id="__codelineno-89-25" name="__codelineno-89-25" href="#__codelineno-89-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Output range: [</span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-89-26"><a id="__codelineno-89-26" name="__codelineno-89-26" href="#__codelineno-89-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Output has NaN: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-27"><a id="__codelineno-89-27" name="__codelineno-89-27" href="#__codelineno-89-27"></a>
</span><span id="__span-89-28"><a id="__codelineno-89-28" name="__codelineno-89-28" href="#__codelineno-89-28"></a>    <span class="c1"># 3. Loss computation</span>
</span><span id="__span-89-29"><a id="__codelineno-89-29" name="__codelineno-89-29" href="#__codelineno-89-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Loss Computation:&quot;</span><span class="p">)</span>
</span><span id="__span-89-30"><a id="__codelineno-89-30" name="__codelineno-89-30" href="#__codelineno-89-30"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-89-31"><a id="__codelineno-89-31" name="__codelineno-89-31" href="#__codelineno-89-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Loss value: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-32"><a id="__codelineno-89-32" name="__codelineno-89-32" href="#__codelineno-89-32"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Loss is finite: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-33"><a id="__codelineno-89-33" name="__codelineno-89-33" href="#__codelineno-89-33"></a>
</span><span id="__span-89-34"><a id="__codelineno-89-34" name="__codelineno-89-34" href="#__codelineno-89-34"></a>    <span class="c1"># 4. Backward pass</span>
</span><span id="__span-89-35"><a id="__codelineno-89-35" name="__codelineno-89-35" href="#__codelineno-89-35"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Backward Pass:&quot;</span><span class="p">)</span>
</span><span id="__span-89-36"><a id="__codelineno-89-36" name="__codelineno-89-36" href="#__codelineno-89-36"></a>    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-89-37"><a id="__codelineno-89-37" name="__codelineno-89-37" href="#__codelineno-89-37"></a>
</span><span id="__span-89-38"><a id="__codelineno-89-38" name="__codelineno-89-38" href="#__codelineno-89-38"></a>    <span class="c1"># Check gradients</span>
</span><span id="__span-89-39"><a id="__codelineno-89-39" name="__codelineno-89-39" href="#__codelineno-89-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Gradient Statistics:&quot;</span><span class="p">)</span>
</span><span id="__span-89-40"><a id="__codelineno-89-40" name="__codelineno-89-40" href="#__codelineno-89-40"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
</span><span id="__span-89-41"><a id="__codelineno-89-41" name="__codelineno-89-41" href="#__codelineno-89-41"></a>        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-89-42"><a id="__codelineno-89-42" name="__codelineno-89-42" href="#__codelineno-89-42"></a>            <span class="n">grad_min</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-89-43"><a id="__codelineno-89-43" name="__codelineno-89-43" href="#__codelineno-89-43"></a>            <span class="n">grad_max</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-89-44"><a id="__codelineno-89-44" name="__codelineno-89-44" href="#__codelineno-89-44"></a>            <span class="n">grad_mean</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-89-45"><a id="__codelineno-89-45" name="__codelineno-89-45" href="#__codelineno-89-45"></a>            <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-89-46"><a id="__codelineno-89-46" name="__codelineno-89-46" href="#__codelineno-89-46"></a>
</span><span id="__span-89-47"><a id="__codelineno-89-47" name="__codelineno-89-47" href="#__codelineno-89-47"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
</span><span id="__span-89-48"><a id="__codelineno-89-48" name="__codelineno-89-48" href="#__codelineno-89-48"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Range: [</span><span class="si">{</span><span class="n">grad_min</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">grad_max</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="__span-89-49"><a id="__codelineno-89-49" name="__codelineno-89-49" href="#__codelineno-89-49"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Mean: </span><span class="si">{</span><span class="n">grad_mean</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, Norm: </span><span class="si">{</span><span class="n">grad_norm</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-50"><a id="__codelineno-89-50" name="__codelineno-89-50" href="#__codelineno-89-50"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Has NaN: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-51"><a id="__codelineno-89-51" name="__codelineno-89-51" href="#__codelineno-89-51"></a>
</span><span id="__span-89-52"><a id="__codelineno-89-52" name="__codelineno-89-52" href="#__codelineno-89-52"></a>    <span class="c1"># 5. Optimizer step</span>
</span><span id="__span-89-53"><a id="__codelineno-89-53" name="__codelineno-89-53" href="#__codelineno-89-53"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">5. Optimizer Step:&quot;</span><span class="p">)</span>
</span><span id="__span-89-54"><a id="__codelineno-89-54" name="__codelineno-89-54" href="#__codelineno-89-54"></a>    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-89-55"><a id="__codelineno-89-55" name="__codelineno-89-55" href="#__codelineno-89-55"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ✓ Step completed&quot;</span><span class="p">)</span>
</span><span id="__span-89-56"><a id="__codelineno-89-56" name="__codelineno-89-56" href="#__codelineno-89-56"></a>
</span><span id="__span-89-57"><a id="__codelineno-89-57" name="__codelineno-89-57" href="#__codelineno-89-57"></a>    <span class="c1"># 6. Parameter update check</span>
</span><span id="__span-89-58"><a id="__codelineno-89-58" name="__codelineno-89-58" href="#__codelineno-89-58"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">6. Parameter Update Check:&quot;</span><span class="p">)</span>
</span><span id="__span-89-59"><a id="__codelineno-89-59" name="__codelineno-89-59" href="#__codelineno-89-59"></a>    <span class="n">new_output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-89-60"><a id="__codelineno-89-60" name="__codelineno-89-60" href="#__codelineno-89-60"></a>    <span class="n">new_loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">new_output</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-89-61"><a id="__codelineno-89-61" name="__codelineno-89-61" href="#__codelineno-89-61"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  New loss: </span><span class="si">{</span><span class="n">new_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-62"><a id="__codelineno-89-62" name="__codelineno-89-62" href="#__codelineno-89-62"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Loss change: </span><span class="si">{</span><span class="n">new_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-89-63"><a id="__codelineno-89-63" name="__codelineno-89-63" href="#__codelineno-89-63"></a>
</span><span id="__span-89-64"><a id="__codelineno-89-64" name="__codelineno-89-64" href="#__codelineno-89-64"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-89-65"><a id="__codelineno-89-65" name="__codelineno-89-65" href="#__codelineno-89-65"></a>
</span><span id="__span-89-66"><a id="__codelineno-89-66" name="__codelineno-89-66" href="#__codelineno-89-66"></a><span class="c1"># Usage: Run on first batch to debug</span>
</span><span id="__span-89-67"><a id="__codelineno-89-67" name="__codelineno-89-67" href="#__codelineno-89-67"></a><span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
</span><span id="__span-89-68"><a id="__codelineno-89-68" name="__codelineno-89-68" href="#__codelineno-89-68"></a><span class="n">debug_training_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="10__key__takeaways">10. Key Takeaways<a class="headerlink" href="#10__key__takeaways" title="Permanent link">&para;</a></h2>
<p><strong>Core Concepts:</strong></p>
<ol>
<li><strong>Deep Learning Advantages for Molecules</strong></li>
<li>Automatic feature learning from raw molecular representations</li>
<li>Captures complex non-linear relationships</li>
<li>Enables transfer learning and multi-task learning</li>
<li>
<p>State-of-the-art performance on many molecular property prediction tasks</p>
</li>
<li>
<p><strong>Model Selection Guidelines</strong></p>
</li>
<li><strong>Feedforward NN</strong>: Best for general-purpose molecular property prediction with fingerprints</li>
<li><strong>1D CNN</strong>: Excellent for SMILES when local patterns (functional groups) matter</li>
<li><strong>LSTM/GRU</strong>: Best for sequence modeling and when order matters in SMILES</li>
<li><strong>Multi-Task</strong>: Use when predicting multiple related properties</li>
<li>
<p><strong>Transfer Learning</strong>: Critical when data is limited (&lt;5K samples)</p>
</li>
<li>
<p><strong>Architecture Best Practices</strong></p>
</li>
<li>Start simple (2-3 layers) and add complexity only if needed</li>
<li>Use ReLU activation for hidden layers</li>
<li>Apply batch normalization and dropout for regularization</li>
<li>Use Adam optimizer with learning rate 1e-3 as default</li>
<li>
<p>Implement early stopping (patience=15-20)</p>
</li>
<li>
<p><strong>Training Strategies</strong></p>
</li>
<li>Always split data into train/val/test (70/15/15)</li>
<li>Normalize inputs for faster convergence</li>
<li>Use learning rate scheduling (ReduceLROnPlateau)</li>
<li>Monitor multiple metrics (RMSE, MAE, R²)</li>
<li>
<p>Save best model based on validation loss</p>
</li>
<li>
<p><strong>Performance Optimization</strong></p>
</li>
<li>Deep learning typically provides 10-20% improvement over Random Forest</li>
<li>Transfer learning can improve performance by 15-30% with limited data</li>
<li>Multi-task learning helps when tasks are related</li>
<li>
<p>Ensemble methods (combining multiple models) can add another 5-10%</p>
</li>
<li>
<p><strong>Hyperparameter Importance Ranking</strong></p>
</li>
<li>Learning rate (most critical)</li>
<li>Batch size</li>
<li>Number of layers and neurons</li>
<li>Dropout rate</li>
<li>
<p>Optimizer choice (Adam usually best)</p>
</li>
<li>
<p><strong>Common Pitfalls to Avoid</strong></p>
</li>
<li>Training without validation set</li>
<li>Not normalizing inputs</li>
<li>Ignoring overfitting signs</li>
<li>Using too large learning rate</li>
<li>Not checking for data leakage</li>
<li>
<p>Forgetting to set model.eval() during inference</p>
</li>
<li>
<p><strong>Model Interpretation Matters</strong></p>
</li>
<li>Use gradient-based methods for feature importance</li>
<li>Integrated gradients provide better attributions</li>
<li>Attention mechanisms add interpretability</li>
<li>
<p>Always validate interpretations with domain knowledge</p>
</li>
<li>
<p><strong>Production Considerations</strong></p>
</li>
<li>Save model architecture and weights separately</li>
<li>Version control for models and data</li>
<li>Monitor model performance degradation over time</li>
<li>Implement confidence scoring for predictions</li>
<li>
<p>Document training procedures and hyperparameters</p>
</li>
<li>
<p><strong>Research Directions</strong></p>
<ul>
<li>Graph Neural Networks for molecular graphs (Day 3)</li>
<li>3D conformation-based models</li>
<li>Active learning for efficient data collection</li>
<li>Uncertainty quantification</li>
<li>Explainable AI for drug discovery</li>
</ul>
</li>
</ol>
<p><strong>Performance Benchmarks (BBB Permeability):</strong></p>
<table>
<thead>
<tr>
<th>Approach</th>
<th>R² Score</th>
<th>RMSE</th>
<th>Training Time</th>
<th>Data Required</th>
</tr>
</thead>
<tbody>
<tr>
<td>Random Forest</td>
<td>0.75</td>
<td>0.60</td>
<td>Fast (1 min)</td>
<td>1K+</td>
</tr>
<tr>
<td>Feedforward NN</td>
<td>0.79</td>
<td>0.52</td>
<td>Medium (15 min)</td>
<td>1K+</td>
</tr>
<tr>
<td>1D CNN (SMILES)</td>
<td>0.82</td>
<td>0.48</td>
<td>Medium (20 min)</td>
<td>2K+</td>
</tr>
<tr>
<td>LSTM (SMILES)</td>
<td>0.84</td>
<td>0.45</td>
<td>Slow (45 min)</td>
<td>3K+</td>
</tr>
<tr>
<td>Transfer Learning</td>
<td>0.87</td>
<td>0.41</td>
<td>Fast (10 min)</td>
<td>500+</td>
</tr>
<tr>
<td>Multi-Task</td>
<td>0.86</td>
<td>0.42</td>
<td>Medium (25 min)</td>
<td>1K+ per task</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="11__resources">11. Resources<a class="headerlink" href="#11__resources" title="Permanent link">&para;</a></h2>
<h3 id="111__essential__papers">11.1 Essential Papers<a class="headerlink" href="#111__essential__papers" title="Permanent link">&para;</a></h3>
<p><strong>Deep Learning Fundamentals:</strong>
1. LeCun, Y., Bengio, Y., &amp; Hinton, G. (2015). &ldquo;Deep learning.&rdquo; <em>Nature</em>, 521(7553), 436-444.
2. Goodfellow, I., Bengio, Y., &amp; Courville, A. (2016). <em>Deep Learning</em>. MIT Press.</p>
<p><strong>Molecular Deep Learning:</strong>
3. Wu, Z., et al. (2018). &ldquo;MoleculeNet: A benchmark for molecular machine learning.&rdquo; <em>Chemical Science</em>, 9(2), 513-530.
4. Wen, M., et al. (2020). &ldquo;Deep learning for molecular property prediction.&rdquo; <em>arXiv preprint</em> arXiv:2003.03167.
5. Goh, G. B., et al. (2017). &ldquo;Deep learning for computational chemistry.&rdquo; <em>Journal of Computational Chemistry</em>, 38(16), 1291-1307.</p>
<p><strong>Architecture-Specific:</strong>
6. Gómez-Bombarelli, R., et al. (2018). &ldquo;Automatic chemical design using a data-driven continuous representation of molecules.&rdquo; <em>ACS Central Science</em>, 4(2), 268-276.
7. Zheng, S., et al. (2020). &ldquo;Identifying structure–property relationships through SMILES syntax analysis with self-attention mechanism.&rdquo; <em>Journal of Chemical Information and Modeling</em>, 59(2), 914-923.
8. Chithrananda, S., et al. (2020). &ldquo;ChemBERTa: Large-scale self-supervised pretraining for molecular property prediction.&rdquo; <em>arXiv preprint</em> arXiv:2010.09885.</p>
<p><strong>Transfer Learning:</strong>
9. Hu, W., et al. (2020). &ldquo;Strategies for pre-training graph neural networks.&rdquo; <em>ICLR 2020</em>.
10. Ramsundar, B., et al. (2015). &ldquo;Massively multitask networks for drug discovery.&rdquo; <em>arXiv preprint</em> arXiv:1502.02072.</p>
<p><strong>Model Interpretation:</strong>
11. Sundararajan, M., et al. (2017). &ldquo;Axiomatic attribution for deep networks.&rdquo; <em>ICML 2017</em>.
12. Jiménez-Luna, J., et al. (2020). &ldquo;Drug discovery with explainable artificial intelligence.&rdquo; <em>Nature Machine Intelligence</em>, 2(10), 573-584.</p>
<h3 id="112__software__libraries">11.2 Software Libraries<a class="headerlink" href="#112__software__libraries" title="Permanent link">&para;</a></h3>
<p><strong>Deep Learning Frameworks:</strong>
- <strong>PyTorch</strong>: https://pytorch.org/ (Recommended for research)
- <strong>TensorFlow/Keras</strong>: https://www.tensorflow.org/
- <strong>JAX</strong>: https://github.com/google/jax (For advanced users)</p>
<p><strong>Molecular Machine Learning:</strong>
- <strong>DeepChem</strong>: https://deepchem.io/ (Comprehensive molecular ML library)
- <strong>RDKit</strong>: https://www.rdkit.org/ (Cheminformatics toolkit)
- <strong>Mordred</strong>: https://github.com/mordred-descriptor/mordred (Molecular descriptors)
- <strong>ChemProp</strong>: https://github.com/chemprop/chemprop (Message passing neural networks)</p>
<p><strong>Model Interpretation:</strong>
- <strong>Captum</strong>: https://captum.ai/ (PyTorch interpretability)
- <strong>SHAP</strong>: https://github.com/slundberg/shap (SHapley Additive exPlanations)
- <strong>LIME</strong>: https://github.com/marcotcr/lime (Local interpretable model-agnostic explanations)</p>
<p><strong>Hyperparameter Tuning:</strong>
- <strong>Optuna</strong>: https://optuna.org/ (Automated hyperparameter optimization)
- <strong>Ray Tune</strong>: https://docs.ray.io/en/latest/tune/index.html (Scalable tuning)
- <strong>Weights &amp; Biases</strong>: https://wandb.ai/ (Experiment tracking)</p>
<h3 id="113__datasets">11.3 Datasets<a class="headerlink" href="#113__datasets" title="Permanent link">&para;</a></h3>
<p><strong>Public Molecular Datasets:</strong>
1. <strong>MoleculeNet</strong>: Collection of datasets for molecular property prediction
   - http://moleculenet.ai/</p>
<ol>
<li><strong>ZINC Database</strong>: 230M purchasable compounds</li>
<li>
<p>https://zinc.docking.org/</p>
</li>
<li>
<p><strong>PubChem</strong>: 100M+ compounds with biological activities</p>
</li>
<li>
<p>https://pubchem.ncbi.nlm.nih.gov/</p>
</li>
<li>
<p><strong>ChEMBL</strong>: 2M+ bioactive molecules</p>
</li>
<li>
<p>https://www.ebi.ac.uk/chembl/</p>
</li>
<li>
<p><strong>Tox21</strong>: Toxicity data for 12K compounds</p>
</li>
<li>
<p>https://tripod.nih.gov/tox21/</p>
</li>
<li>
<p><strong>BBBP (Blood-Brain Barrier Penetration)</strong>: 2K molecules</p>
</li>
<li>
<p>Part of MoleculeNet</p>
</li>
<li>
<p><strong>ESOL (Solubility)</strong>: 1K molecules with measured solubility</p>
</li>
<li>https://pubs.acs.org/doi/10.1021/ci034243x</li>
</ol>
<h3 id="114__online__courses__and__tutorials">11.4 Online Courses and Tutorials<a class="headerlink" href="#114__online__courses__and__tutorials" title="Permanent link">&para;</a></h3>
<p><strong>Deep Learning:</strong>
1. <strong>Deep Learning Specialization</strong> (Coursera - Andrew Ng)
   - https://www.coursera.org/specializations/deep-learning</p>
<ol>
<li><strong>Fast.ai Practical Deep Learning</strong></li>
<li>https://course.fast.ai/</li>
</ol>
<p><strong>Molecular Machine Learning:</strong>
3. <strong>DeepChem Tutorials</strong>
   - https://deepchem.readthedocs.io/en/latest/get_started/tutorials.html</p>
<ol>
<li><strong>Molecular Machine Learning</strong> (MIT)</li>
<li>
<p>http://molecularml.github.io/</p>
</li>
<li>
<p><strong>Machine Learning for Drug Discovery</strong> (Stanford)</p>
</li>
<li>http://cs229.stanford.edu/proj2019aut/</li>
</ol>
<h3 id="115__useful__blogs__and__articles">11.5 Useful Blogs and Articles<a class="headerlink" href="#115__useful__blogs__and__articles" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Distill.pub</strong>: Interactive ML visualizations</li>
<li>
<p>https://distill.pub/</p>
</li>
<li>
<p><strong>Pat Walters&rsquo; Blog</strong>: Practical cheminformatics</p>
</li>
<li>
<p>http://practicalcheminformatics.blogspot.com/</p>
</li>
<li>
<p><strong>Is Life Worth Living?</strong>: Deep learning for chemistry</p>
</li>
<li>
<p>https://iwatobipen.wordpress.com/</p>
</li>
<li>
<p><strong>DeepMind Research</strong>: Latest AI research</p>
</li>
<li>https://deepmind.com/research</li>
</ol>
<h3 id="116__community__and__forums">11.6 Community and Forums<a class="headerlink" href="#116__community__and__forums" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>RDKit Discussions</strong>: https://github.com/rdkit/rdkit/discussions</li>
<li><strong>DeepChem Gitter</strong>: https://gitter.im/deepchem/Lobby</li>
<li><strong>r/MachineLearning</strong>: https://www.reddit.com/r/MachineLearning/</li>
<li><strong>r/cheminformatics</strong>: https://www.reddit.com/r/cheminformatics/</li>
</ol>
<hr />
<h2 id="12__homework__assignment">12. Homework Assignment<a class="headerlink" href="#12__homework__assignment" title="Permanent link">&para;</a></h2>
<h3 id="instructions">Instructions<a class="headerlink" href="#instructions" title="Permanent link">&para;</a></h3>
<p>Complete the following 10 exercises to reinforce your understanding of Day 2 concepts. Submit a Jupyter notebook with code, results, and brief explanations.</p>
<p><strong>Evaluation Criteria:</strong>
- Code correctness and clarity (40%)
- Results and analysis quality (30%)
- Explanations and insights (20%)
- Code documentation (10%)</p>
<p><strong>Submission Format:</strong>
- Jupyter notebook (.ipynb)
- Include all outputs and visualizations
- Add markdown cells with explanations
- Ensure code is reproducible</p>
<hr />
<h3 id="exercise__1__implement__a__custom__neural__network__10__points">Exercise 1: Implement a Custom Neural Network (10 points)<a class="headerlink" href="#exercise__1__implement__a__custom__neural__network__10__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Build a feedforward neural network from scratch using only NumPy (no PyTorch/TensorFlow).</p>
<p><strong>Requirements:</strong>
- Implement forward propagation
- Implement backward propagation
- Train on a simple molecular dataset (e.g., solubility)
- Compare performance with PyTorch implementation</p>
<p><strong>Deliverables:</strong>
- Complete implementation with comments
- Training loss plot
- Comparison table</p>
<hr />
<h3 id="exercise__2__activation__function__comparison__8__points">Exercise 2: Activation Function Comparison (8 points)<a class="headerlink" href="#exercise__2__activation__function__comparison__8__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Compare different activation functions on molecular property prediction.</p>
<p><strong>Requirements:</strong>
- Test: ReLU, Leaky ReLU, ELU, SELU, Tanh
- Use same architecture (3 hidden layers)
- Plot training curves for each
- Analyze convergence speed and final performance</p>
<p><strong>Deliverables:</strong>
- Training curves for all activations
- Performance comparison table
- Analysis of results (2-3 paragraphs)</p>
<hr />
<h3 id="exercise__3__implement__multi-task__learning__12__points">Exercise 3: Implement Multi-Task Learning (12 points)<a class="headerlink" href="#exercise__3__implement__multi-task__learning__12__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Build a multi-task model to predict multiple molecular properties.</p>
<p><strong>Requirements:</strong>
- Predict at least 3 properties (e.g., solubility, LogP, TPSA)
- Implement task weighting (try 3 different strategies)
- Compare with single-task models
- Visualize shared representations (t-SNE)</p>
<p><strong>Deliverables:</strong>
- Multi-task model implementation
- Performance comparison
- t-SNE visualization
- Analysis of benefits</p>
<hr />
<h3 id="exercise__4__smiles__cnn__implementation__10__points">Exercise 4: SMILES CNN Implementation (10 points)<a class="headerlink" href="#exercise__4__smiles__cnn__implementation__10__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Implement and optimize a 1D CNN for SMILES.</p>
<p><strong>Requirements:</strong>
- Test different filter sizes (3, 5, 7, 9)
- Test different numbers of filters (32, 64, 128)
- Implement data augmentation (SMILES enumeration)
- Compare with fingerprint-based model</p>
<p><strong>Deliverables:</strong>
- CNN implementation
- Hyperparameter search results
- Performance comparison
- Best model configuration</p>
<hr />
<h3 id="exercise__5__lstm__vs__gru__comparison__10__points">Exercise 5: LSTM vs GRU Comparison (10 points)<a class="headerlink" href="#exercise__5__lstm__vs__gru__comparison__10__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Compare LSTM and GRU architectures for SMILES processing.</p>
<p><strong>Requirements:</strong>
- Implement both LSTM and GRU
- Add attention mechanism to both
- Compare training time, memory usage, performance
- Test on sequences of different lengths</p>
<p><strong>Deliverables:</strong>
- Both implementations
- Performance metrics table
- Training time comparison
- Recommendations</p>
<hr />
<h3 id="exercise__6__transfer__learning__experiment__12__points">Exercise 6: Transfer Learning Experiment (12 points)<a class="headerlink" href="#exercise__6__transfer__learning__experiment__12__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Implement transfer learning for a low-data regime task.</p>
<p><strong>Requirements:</strong>
- Pre-train on large dataset (e.g., solubility, 10K molecules)
- Fine-tune on small dataset (BBB permeability, 500 molecules)
- Try different freezing strategies
- Compare with training from scratch</p>
<p><strong>Deliverables:</strong>
- Pre-training code
- Fine-tuning code
- Learning curves comparison
- Analysis of data efficiency</p>
<hr />
<h3 id="exercise__7__model__interpretation__10__points">Exercise 7: Model Interpretation (10 points)<a class="headerlink" href="#exercise__7__model__interpretation__10__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Implement and compare interpretation methods.</p>
<p><strong>Requirements:</strong>
- Implement gradient-based importance
- Implement integrated gradients
- Apply to 10 test molecules
- Visualize important features
- Validate interpretations</p>
<p><strong>Deliverables:</strong>
- Implementation of both methods
- Visualizations for 5 molecules
- Comparison of methods
- Validation with domain knowledge</p>
<hr />
<h3 id="exercise__8__hyperparameter__tuning__with__optuna__10__points">Exercise 8: Hyperparameter Tuning with Optuna (10 points)<a class="headerlink" href="#exercise__8__hyperparameter__tuning__with__optuna__10__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Use Optuna to find optimal hyperparameters.</p>
<p><strong>Requirements:</strong>
- Define search space for 6+ hyperparameters
- Run at least 50 trials
- Visualize optimization history
- Analyze parameter importance
- Train final model with best parameters</p>
<p><strong>Deliverables:</strong>
- Optuna code
- Optimization visualizations
- Best hyperparameters
- Final model performance</p>
<hr />
<h3 id="exercise__9__complete__pipeline__development__15__points">Exercise 9: Complete Pipeline Development (15 points)<a class="headerlink" href="#exercise__9__complete__pipeline__development__15__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Build a complete end-to-end pipeline for a novel dataset.</p>
<p><strong>Requirements:</strong>
- Choose a dataset from MoleculeNet (not used in class)
- Data preprocessing and splitting
- Feature engineering
- Model selection (try 3+ architectures)
- Hyperparameter tuning
- Final evaluation and error analysis</p>
<p><strong>Deliverables:</strong>
- Complete pipeline code
- Detailed README
- Results report (1-2 pages)
- Error analysis</p>
<hr />
<h3 id="exercise__10__research__paper__implementation__13__points">Exercise 10: Research Paper Implementation (13 points)<a class="headerlink" href="#exercise__10__research__paper__implementation__13__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Implement a model from a recent research paper.</p>
<p><strong>Suggested Papers:</strong>
1. &ldquo;Molecular graph convolutions: moving beyond fingerprints&rdquo; (Duvenaud et al., 2015)
2. &ldquo;Analyzing learned molecular representations for property prediction&rdquo; (Yang et al., 2019)
3. &ldquo;Self-Attention-Based Molecular Representation&rdquo; (Zheng et al., 2019)</p>
<p><strong>Requirements:</strong>
- Implement core architecture from paper
- Reproduce key results (within 5% of reported performance)
- Apply to new dataset
- Write implementation notes</p>
<p><strong>Deliverables:</strong>
- Implementation code
- Results comparison with paper
- Application to new dataset
- Implementation notes (1 page)</p>
<hr />
<h3 id="bonus__exercise__ensemble__methods__5__points">Bonus Exercise: Ensemble Methods (+5 points)<a class="headerlink" href="#bonus__exercise__ensemble__methods__5__points" title="Permanent link">&para;</a></h3>
<p><strong>Task:</strong> Implement ensemble methods to improve predictions.</p>
<p><strong>Requirements:</strong>
- Create ensemble of 5+ models (different architectures)
- Try different ensemble strategies (averaging, stacking, voting)
- Compare with individual models
- Analyze diversity of predictions</p>
<p><strong>Deliverables:</strong>
- Ensemble implementation
- Performance comparison
- Diversity analysis</p>
<hr />
<h3 id="submission__guidelines">Submission Guidelines<a class="headerlink" href="#submission__guidelines" title="Permanent link">&para;</a></h3>
<p><strong>File Structure:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>homework_day2/
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>├── README.md
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>├── exercise_1_custom_nn.ipynb
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>├── exercise_2_activation_comparison.ipynb
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>├── exercise_3_multitask.ipynb
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>├── exercise_4_smiles_cnn.ipynb
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>├── exercise_5_lstm_gru.ipynb
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>├── exercise_6_transfer_learning.ipynb
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>├── exercise_7_interpretation.ipynb
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>├── exercise_8_optuna.ipynb
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>├── exercise_9_complete_pipeline.ipynb
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>├── exercise_10_paper_implementation.ipynb
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>├── bonus_ensemble.ipynb (optional)
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>├── data/ (if applicable)
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a>└── models/ (saved models)
</span></code></pre></div></p>
<p><strong>README.md should include:</strong>
- Student name and ID
- Brief description of each exercise
- Key findings and insights
- Challenges encountered
- Total time spent</p>
<p><strong>Deadline:</strong> 7 days from course date</p>
<p><strong>Grading:</strong> Total 100 points (+ 5 bonus)</p>
<hr />
<h2 id="13__appendix">13. Appendix<a class="headerlink" href="#13__appendix" title="Permanent link">&para;</a></h2>
<h3 id="appendix__a__complete__feedforward__nn__template">Appendix A: Complete Feedforward NN Template<a class="headerlink" href="#appendix__a__complete__feedforward__nn__template" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="sd">Complete Feedforward Neural Network Template</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="sd">For Molecular Property Prediction</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a><span class="sd">This template provides a production-ready implementation</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="sd">with all best practices included.</span>
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a>
</span><span id="__span-91-9"><a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-91-10"><a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-91-11"><a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
</span><span id="__span-91-12"><a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
</span><span id="__span-91-13"><a id="__codelineno-91-13" name="__codelineno-91-13" href="#__codelineno-91-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-91-14"><a id="__codelineno-91-14" name="__codelineno-91-14" href="#__codelineno-91-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
</span><span id="__span-91-15"><a id="__codelineno-91-15" name="__codelineno-91-15" href="#__codelineno-91-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
</span><span id="__span-91-16"><a id="__codelineno-91-16" name="__codelineno-91-16" href="#__codelineno-91-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
</span><span id="__span-91-17"><a id="__codelineno-91-17" name="__codelineno-91-17" href="#__codelineno-91-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
</span><span id="__span-91-18"><a id="__codelineno-91-18" name="__codelineno-91-18" href="#__codelineno-91-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">AllChem</span>
</span><span id="__span-91-19"><a id="__codelineno-91-19" name="__codelineno-91-19" href="#__codelineno-91-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-91-20"><a id="__codelineno-91-20" name="__codelineno-91-20" href="#__codelineno-91-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="__span-91-21"><a id="__codelineno-91-21" name="__codelineno-91-21" href="#__codelineno-91-21"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-91-22"><a id="__codelineno-91-22" name="__codelineno-91-22" href="#__codelineno-91-22"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-91-23"><a id="__codelineno-91-23" name="__codelineno-91-23" href="#__codelineno-91-23"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-91-24"><a id="__codelineno-91-24" name="__codelineno-91-24" href="#__codelineno-91-24"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="__span-91-25"><a id="__codelineno-91-25" name="__codelineno-91-25" href="#__codelineno-91-25"></a>
</span><span id="__span-91-26"><a id="__codelineno-91-26" name="__codelineno-91-26" href="#__codelineno-91-26"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-27"><a id="__codelineno-91-27" name="__codelineno-91-27" href="#__codelineno-91-27"></a><span class="c1"># 1. CONFIGURATION</span>
</span><span id="__span-91-28"><a id="__codelineno-91-28" name="__codelineno-91-28" href="#__codelineno-91-28"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-29"><a id="__codelineno-91-29" name="__codelineno-91-29" href="#__codelineno-91-29"></a>
</span><span id="__span-91-30"><a id="__codelineno-91-30" name="__codelineno-91-30" href="#__codelineno-91-30"></a><span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
</span><span id="__span-91-31"><a id="__codelineno-91-31" name="__codelineno-91-31" href="#__codelineno-91-31"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for model training&quot;&quot;&quot;</span>
</span><span id="__span-91-32"><a id="__codelineno-91-32" name="__codelineno-91-32" href="#__codelineno-91-32"></a>
</span><span id="__span-91-33"><a id="__codelineno-91-33" name="__codelineno-91-33" href="#__codelineno-91-33"></a>    <span class="c1"># Data</span>
</span><span id="__span-91-34"><a id="__codelineno-91-34" name="__codelineno-91-34" href="#__codelineno-91-34"></a>    <span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;molecular_data.csv&#39;</span>
</span><span id="__span-91-35"><a id="__codelineno-91-35" name="__codelineno-91-35" href="#__codelineno-91-35"></a>    <span class="n">smiles_column</span> <span class="o">=</span> <span class="s1">&#39;SMILES&#39;</span>
</span><span id="__span-91-36"><a id="__codelineno-91-36" name="__codelineno-91-36" href="#__codelineno-91-36"></a>    <span class="n">target_column</span> <span class="o">=</span> <span class="s1">&#39;property&#39;</span>
</span><span id="__span-91-37"><a id="__codelineno-91-37" name="__codelineno-91-37" href="#__codelineno-91-37"></a>
</span><span id="__span-91-38"><a id="__codelineno-91-38" name="__codelineno-91-38" href="#__codelineno-91-38"></a>    <span class="c1"># Features</span>
</span><span id="__span-91-39"><a id="__codelineno-91-39" name="__codelineno-91-39" href="#__codelineno-91-39"></a>    <span class="n">fingerprint_radius</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="__span-91-40"><a id="__codelineno-91-40" name="__codelineno-91-40" href="#__codelineno-91-40"></a>    <span class="n">fingerprint_bits</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span id="__span-91-41"><a id="__codelineno-91-41" name="__codelineno-91-41" href="#__codelineno-91-41"></a>
</span><span id="__span-91-42"><a id="__codelineno-91-42" name="__codelineno-91-42" href="#__codelineno-91-42"></a>    <span class="c1"># Model</span>
</span><span id="__span-91-43"><a id="__codelineno-91-43" name="__codelineno-91-43" href="#__codelineno-91-43"></a>    <span class="n">input_dim</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span id="__span-91-44"><a id="__codelineno-91-44" name="__codelineno-91-44" href="#__codelineno-91-44"></a>    <span class="n">hidden_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
</span><span id="__span-91-45"><a id="__codelineno-91-45" name="__codelineno-91-45" href="#__codelineno-91-45"></a>    <span class="n">output_dim</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-91-46"><a id="__codelineno-91-46" name="__codelineno-91-46" href="#__codelineno-91-46"></a>    <span class="n">dropout_rate</span> <span class="o">=</span> <span class="mf">0.3</span>
</span><span id="__span-91-47"><a id="__codelineno-91-47" name="__codelineno-91-47" href="#__codelineno-91-47"></a>
</span><span id="__span-91-48"><a id="__codelineno-91-48" name="__codelineno-91-48" href="#__codelineno-91-48"></a>    <span class="c1"># Training</span>
</span><span id="__span-91-49"><a id="__codelineno-91-49" name="__codelineno-91-49" href="#__codelineno-91-49"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="__span-91-50"><a id="__codelineno-91-50" name="__codelineno-91-50" href="#__codelineno-91-50"></a>    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.001</span>
</span><span id="__span-91-51"><a id="__codelineno-91-51" name="__codelineno-91-51" href="#__codelineno-91-51"></a>    <span class="n">weight_decay</span> <span class="o">=</span> <span class="mf">1e-5</span>
</span><span id="__span-91-52"><a id="__codelineno-91-52" name="__codelineno-91-52" href="#__codelineno-91-52"></a>    <span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="__span-91-53"><a id="__codelineno-91-53" name="__codelineno-91-53" href="#__codelineno-91-53"></a>    <span class="n">patience</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="__span-91-54"><a id="__codelineno-91-54" name="__codelineno-91-54" href="#__codelineno-91-54"></a>
</span><span id="__span-91-55"><a id="__codelineno-91-55" name="__codelineno-91-55" href="#__codelineno-91-55"></a>    <span class="c1"># Device</span>
</span><span id="__span-91-56"><a id="__codelineno-91-56" name="__codelineno-91-56" href="#__codelineno-91-56"></a>    <span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>
</span><span id="__span-91-57"><a id="__codelineno-91-57" name="__codelineno-91-57" href="#__codelineno-91-57"></a>
</span><span id="__span-91-58"><a id="__codelineno-91-58" name="__codelineno-91-58" href="#__codelineno-91-58"></a>    <span class="c1"># Paths</span>
</span><span id="__span-91-59"><a id="__codelineno-91-59" name="__codelineno-91-59" href="#__codelineno-91-59"></a>    <span class="n">model_dir</span> <span class="o">=</span> <span class="s1">&#39;models&#39;</span>
</span><span id="__span-91-60"><a id="__codelineno-91-60" name="__codelineno-91-60" href="#__codelineno-91-60"></a>    <span class="n">results_dir</span> <span class="o">=</span> <span class="s1">&#39;results&#39;</span>
</span><span id="__span-91-61"><a id="__codelineno-91-61" name="__codelineno-91-61" href="#__codelineno-91-61"></a>
</span><span id="__span-91-62"><a id="__codelineno-91-62" name="__codelineno-91-62" href="#__codelineno-91-62"></a>    <span class="c1"># Random seed</span>
</span><span id="__span-91-63"><a id="__codelineno-91-63" name="__codelineno-91-63" href="#__codelineno-91-63"></a>    <span class="n">random_seed</span> <span class="o">=</span> <span class="mi">42</span>
</span><span id="__span-91-64"><a id="__codelineno-91-64" name="__codelineno-91-64" href="#__codelineno-91-64"></a>
</span><span id="__span-91-65"><a id="__codelineno-91-65" name="__codelineno-91-65" href="#__codelineno-91-65"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-66"><a id="__codelineno-91-66" name="__codelineno-91-66" href="#__codelineno-91-66"></a><span class="c1"># 2. DATA HANDLING</span>
</span><span id="__span-91-67"><a id="__codelineno-91-67" name="__codelineno-91-67" href="#__codelineno-91-67"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-68"><a id="__codelineno-91-68" name="__codelineno-91-68" href="#__codelineno-91-68"></a>
</span><span id="__span-91-69"><a id="__codelineno-91-69" name="__codelineno-91-69" href="#__codelineno-91-69"></a><span class="k">class</span><span class="w"> </span><span class="nc">MolecularDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="__span-91-70"><a id="__codelineno-91-70" name="__codelineno-91-70" href="#__codelineno-91-70"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataset for molecular property prediction&quot;&quot;&quot;</span>
</span><span id="__span-91-71"><a id="__codelineno-91-71" name="__codelineno-91-71" href="#__codelineno-91-71"></a>
</span><span id="__span-91-72"><a id="__codelineno-91-72" name="__codelineno-91-72" href="#__codelineno-91-72"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-91-73"><a id="__codelineno-91-73" name="__codelineno-91-73" href="#__codelineno-91-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="__span-91-74"><a id="__codelineno-91-74" name="__codelineno-91-74" href="#__codelineno-91-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-91-75"><a id="__codelineno-91-75" name="__codelineno-91-75" href="#__codelineno-91-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-91-76"><a id="__codelineno-91-76" name="__codelineno-91-76" href="#__codelineno-91-76"></a>
</span><span id="__span-91-77"><a id="__codelineno-91-77" name="__codelineno-91-77" href="#__codelineno-91-77"></a>        <span class="c1"># Generate fingerprints</span>
</span><span id="__span-91-78"><a id="__codelineno-91-78" name="__codelineno-91-78" href="#__codelineno-91-78"></a>        <span class="k">for</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">targets</span><span class="p">),</span> 
</span><span id="__span-91-79"><a id="__codelineno-91-79" name="__codelineno-91-79" href="#__codelineno-91-79"></a>                                   <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing molecules&quot;</span><span class="p">):</span>
</span><span id="__span-91-80"><a id="__codelineno-91-80" name="__codelineno-91-80" href="#__codelineno-91-80"></a>            <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-91-81"><a id="__codelineno-91-81" name="__codelineno-91-81" href="#__codelineno-91-81"></a>            <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-91-82"><a id="__codelineno-91-82" name="__codelineno-91-82" href="#__codelineno-91-82"></a>                <span class="n">fp</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganFingerprintAsBitVect</span><span class="p">(</span>
</span><span id="__span-91-83"><a id="__codelineno-91-83" name="__codelineno-91-83" href="#__codelineno-91-83"></a>                    <span class="n">mol</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">fingerprint_radius</span><span class="p">,</span> <span class="n">nBits</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">fingerprint_bits</span>
</span><span id="__span-91-84"><a id="__codelineno-91-84" name="__codelineno-91-84" href="#__codelineno-91-84"></a>                <span class="p">)</span>
</span><span id="__span-91-85"><a id="__codelineno-91-85" name="__codelineno-91-85" href="#__codelineno-91-85"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
</span><span id="__span-91-86"><a id="__codelineno-91-86" name="__codelineno-91-86" href="#__codelineno-91-86"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="__span-91-87"><a id="__codelineno-91-87" name="__codelineno-91-87" href="#__codelineno-91-87"></a>
</span><span id="__span-91-88"><a id="__codelineno-91-88" name="__codelineno-91-88" href="#__codelineno-91-88"></a>        <span class="c1"># Convert to tensors</span>
</span><span id="__span-91-89"><a id="__codelineno-91-89" name="__codelineno-91-89" href="#__codelineno-91-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">)</span>
</span><span id="__span-91-90"><a id="__codelineno-91-90" name="__codelineno-91-90" href="#__codelineno-91-90"></a>
</span><span id="__span-91-91"><a id="__codelineno-91-91" name="__codelineno-91-91" href="#__codelineno-91-91"></a>        <span class="c1"># Scale features</span>
</span><span id="__span-91-92"><a id="__codelineno-91-92" name="__codelineno-91-92" href="#__codelineno-91-92"></a>        <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-91-93"><a id="__codelineno-91-93" name="__codelineno-91-93" href="#__codelineno-91-93"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
</span><span id="__span-91-94"><a id="__codelineno-91-94" name="__codelineno-91-94" href="#__codelineno-91-94"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">)</span>
</span><span id="__span-91-95"><a id="__codelineno-91-95" name="__codelineno-91-95" href="#__codelineno-91-95"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-91-96"><a id="__codelineno-91-96" name="__codelineno-91-96" href="#__codelineno-91-96"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">scaler</span>
</span><span id="__span-91-97"><a id="__codelineno-91-97" name="__codelineno-91-97" href="#__codelineno-91-97"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">)</span>
</span><span id="__span-91-98"><a id="__codelineno-91-98" name="__codelineno-91-98" href="#__codelineno-91-98"></a>
</span><span id="__span-91-99"><a id="__codelineno-91-99" name="__codelineno-91-99" href="#__codelineno-91-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">)</span>
</span><span id="__span-91-100"><a id="__codelineno-91-100" name="__codelineno-91-100" href="#__codelineno-91-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-91-101"><a id="__codelineno-91-101" name="__codelineno-91-101" href="#__codelineno-91-101"></a>
</span><span id="__span-91-102"><a id="__codelineno-91-102" name="__codelineno-91-102" href="#__codelineno-91-102"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-91-103"><a id="__codelineno-91-103" name="__codelineno-91-103" href="#__codelineno-91-103"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">)</span>
</span><span id="__span-91-104"><a id="__codelineno-91-104" name="__codelineno-91-104" href="#__codelineno-91-104"></a>
</span><span id="__span-91-105"><a id="__codelineno-91-105" name="__codelineno-91-105" href="#__codelineno-91-105"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="__span-91-106"><a id="__codelineno-91-106" name="__codelineno-91-106" href="#__codelineno-91-106"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fingerprints</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="__span-91-107"><a id="__codelineno-91-107" name="__codelineno-91-107" href="#__codelineno-91-107"></a>
</span><span id="__span-91-108"><a id="__codelineno-91-108" name="__codelineno-91-108" href="#__codelineno-91-108"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-109"><a id="__codelineno-91-109" name="__codelineno-91-109" href="#__codelineno-91-109"></a><span class="c1"># 3. MODEL DEFINITION</span>
</span><span id="__span-91-110"><a id="__codelineno-91-110" name="__codelineno-91-110" href="#__codelineno-91-110"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-111"><a id="__codelineno-91-111" name="__codelineno-91-111" href="#__codelineno-91-111"></a>
</span><span id="__span-91-112"><a id="__codelineno-91-112" name="__codelineno-91-112" href="#__codelineno-91-112"></a><span class="k">class</span><span class="w"> </span><span class="nc">MolecularNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-91-113"><a id="__codelineno-91-113" name="__codelineno-91-113" href="#__codelineno-91-113"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Feedforward neural network for molecular property prediction&quot;&quot;&quot;</span>
</span><span id="__span-91-114"><a id="__codelineno-91-114" name="__codelineno-91-114" href="#__codelineno-91-114"></a>
</span><span id="__span-91-115"><a id="__codelineno-91-115" name="__codelineno-91-115" href="#__codelineno-91-115"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span id="__span-91-116"><a id="__codelineno-91-116" name="__codelineno-91-116" href="#__codelineno-91-116"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MolecularNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-91-117"><a id="__codelineno-91-117" name="__codelineno-91-117" href="#__codelineno-91-117"></a>
</span><span id="__span-91-118"><a id="__codelineno-91-118" name="__codelineno-91-118" href="#__codelineno-91-118"></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-91-119"><a id="__codelineno-91-119" name="__codelineno-91-119" href="#__codelineno-91-119"></a>        <span class="n">prev_dim</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">input_dim</span>
</span><span id="__span-91-120"><a id="__codelineno-91-120" name="__codelineno-91-120" href="#__codelineno-91-120"></a>
</span><span id="__span-91-121"><a id="__codelineno-91-121" name="__codelineno-91-121" href="#__codelineno-91-121"></a>        <span class="c1"># Hidden layers</span>
</span><span id="__span-91-122"><a id="__codelineno-91-122" name="__codelineno-91-122" href="#__codelineno-91-122"></a>        <span class="k">for</span> <span class="n">hidden_dim</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">hidden_dims</span><span class="p">:</span>
</span><span id="__span-91-123"><a id="__codelineno-91-123" name="__codelineno-91-123" href="#__codelineno-91-123"></a>            <span class="n">layers</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="__span-91-124"><a id="__codelineno-91-124" name="__codelineno-91-124" href="#__codelineno-91-124"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">prev_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
</span><span id="__span-91-125"><a id="__codelineno-91-125" name="__codelineno-91-125" href="#__codelineno-91-125"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">),</span>
</span><span id="__span-91-126"><a id="__codelineno-91-126" name="__codelineno-91-126" href="#__codelineno-91-126"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
</span><span id="__span-91-127"><a id="__codelineno-91-127" name="__codelineno-91-127" href="#__codelineno-91-127"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">)</span>
</span><span id="__span-91-128"><a id="__codelineno-91-128" name="__codelineno-91-128" href="#__codelineno-91-128"></a>            <span class="p">])</span>
</span><span id="__span-91-129"><a id="__codelineno-91-129" name="__codelineno-91-129" href="#__codelineno-91-129"></a>            <span class="n">prev_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
</span><span id="__span-91-130"><a id="__codelineno-91-130" name="__codelineno-91-130" href="#__codelineno-91-130"></a>
</span><span id="__span-91-131"><a id="__codelineno-91-131" name="__codelineno-91-131" href="#__codelineno-91-131"></a>        <span class="c1"># Output layer</span>
</span><span id="__span-91-132"><a id="__codelineno-91-132" name="__codelineno-91-132" href="#__codelineno-91-132"></a>        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">prev_dim</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">output_dim</span><span class="p">))</span>
</span><span id="__span-91-133"><a id="__codelineno-91-133" name="__codelineno-91-133" href="#__codelineno-91-133"></a>
</span><span id="__span-91-134"><a id="__codelineno-91-134" name="__codelineno-91-134" href="#__codelineno-91-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span><span id="__span-91-135"><a id="__codelineno-91-135" name="__codelineno-91-135" href="#__codelineno-91-135"></a>
</span><span id="__span-91-136"><a id="__codelineno-91-136" name="__codelineno-91-136" href="#__codelineno-91-136"></a>        <span class="c1"># Initialize weights</span>
</span><span id="__span-91-137"><a id="__codelineno-91-137" name="__codelineno-91-137" href="#__codelineno-91-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_weights</span><span class="p">()</span>
</span><span id="__span-91-138"><a id="__codelineno-91-138" name="__codelineno-91-138" href="#__codelineno-91-138"></a>
</span><span id="__span-91-139"><a id="__codelineno-91-139" name="__codelineno-91-139" href="#__codelineno-91-139"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-91-140"><a id="__codelineno-91-140" name="__codelineno-91-140" href="#__codelineno-91-140"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;He initialization for ReLU networks&quot;&quot;&quot;</span>
</span><span id="__span-91-141"><a id="__codelineno-91-141" name="__codelineno-91-141" href="#__codelineno-91-141"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
</span><span id="__span-91-142"><a id="__codelineno-91-142" name="__codelineno-91-142" href="#__codelineno-91-142"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">):</span>
</span><span id="__span-91-143"><a id="__codelineno-91-143" name="__codelineno-91-143" href="#__codelineno-91-143"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fan_in&#39;</span><span class="p">,</span> <span class="n">nonlinearity</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span>
</span><span id="__span-91-144"><a id="__codelineno-91-144" name="__codelineno-91-144" href="#__codelineno-91-144"></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-91-145"><a id="__codelineno-91-145" name="__codelineno-91-145" href="#__codelineno-91-145"></a>                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-91-146"><a id="__codelineno-91-146" name="__codelineno-91-146" href="#__codelineno-91-146"></a>
</span><span id="__span-91-147"><a id="__codelineno-91-147" name="__codelineno-91-147" href="#__codelineno-91-147"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-91-148"><a id="__codelineno-91-148" name="__codelineno-91-148" href="#__codelineno-91-148"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-91-149"><a id="__codelineno-91-149" name="__codelineno-91-149" href="#__codelineno-91-149"></a>
</span><span id="__span-91-150"><a id="__codelineno-91-150" name="__codelineno-91-150" href="#__codelineno-91-150"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-151"><a id="__codelineno-91-151" name="__codelineno-91-151" href="#__codelineno-91-151"></a><span class="c1"># 4. TRAINING</span>
</span><span id="__span-91-152"><a id="__codelineno-91-152" name="__codelineno-91-152" href="#__codelineno-91-152"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-153"><a id="__codelineno-91-153" name="__codelineno-91-153" href="#__codelineno-91-153"></a>
</span><span id="__span-91-154"><a id="__codelineno-91-154" name="__codelineno-91-154" href="#__codelineno-91-154"></a><span class="k">class</span><span class="w"> </span><span class="nc">Trainer</span><span class="p">:</span>
</span><span id="__span-91-155"><a id="__codelineno-91-155" name="__codelineno-91-155" href="#__codelineno-91-155"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Training manager&quot;&quot;&quot;</span>
</span><span id="__span-91-156"><a id="__codelineno-91-156" name="__codelineno-91-156" href="#__codelineno-91-156"></a>
</span><span id="__span-91-157"><a id="__codelineno-91-157" name="__codelineno-91-157" href="#__codelineno-91-157"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span id="__span-91-158"><a id="__codelineno-91-158" name="__codelineno-91-158" href="#__codelineno-91-158"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="__span-91-159"><a id="__codelineno-91-159" name="__codelineno-91-159" href="#__codelineno-91-159"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="__span-91-160"><a id="__codelineno-91-160" name="__codelineno-91-160" href="#__codelineno-91-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-161"><a id="__codelineno-91-161" name="__codelineno-91-161" href="#__codelineno-91-161"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-162"><a id="__codelineno-91-162" name="__codelineno-91-162" href="#__codelineno-91-162"></a>
</span><span id="__span-91-163"><a id="__codelineno-91-163" name="__codelineno-91-163" href="#__codelineno-91-163"></a>        <span class="c1"># Optimizer and criterion</span>
</span><span id="__span-91-164"><a id="__codelineno-91-164" name="__codelineno-91-164" href="#__codelineno-91-164"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</span><span id="__span-91-165"><a id="__codelineno-91-165" name="__codelineno-91-165" href="#__codelineno-91-165"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="__span-91-166"><a id="__codelineno-91-166" name="__codelineno-91-166" href="#__codelineno-91-166"></a>            <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
</span><span id="__span-91-167"><a id="__codelineno-91-167" name="__codelineno-91-167" href="#__codelineno-91-167"></a>            <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
</span><span id="__span-91-168"><a id="__codelineno-91-168" name="__codelineno-91-168" href="#__codelineno-91-168"></a>            <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">weight_decay</span>
</span><span id="__span-91-169"><a id="__codelineno-91-169" name="__codelineno-91-169" href="#__codelineno-91-169"></a>        <span class="p">)</span>
</span><span id="__span-91-170"><a id="__codelineno-91-170" name="__codelineno-91-170" href="#__codelineno-91-170"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="__span-91-171"><a id="__codelineno-91-171" name="__codelineno-91-171" href="#__codelineno-91-171"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-91-172"><a id="__codelineno-91-172" name="__codelineno-91-172" href="#__codelineno-91-172"></a>        <span class="p">)</span>
</span><span id="__span-91-173"><a id="__codelineno-91-173" name="__codelineno-91-173" href="#__codelineno-91-173"></a>
</span><span id="__span-91-174"><a id="__codelineno-91-174" name="__codelineno-91-174" href="#__codelineno-91-174"></a>        <span class="c1"># History</span>
</span><span id="__span-91-175"><a id="__codelineno-91-175" name="__codelineno-91-175" href="#__codelineno-91-175"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-91-176"><a id="__codelineno-91-176" name="__codelineno-91-176" href="#__codelineno-91-176"></a>            <span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-91-177"><a id="__codelineno-91-177" name="__codelineno-91-177" href="#__codelineno-91-177"></a>            <span class="s1">&#39;val_rmse&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_mae&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_r2&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="__span-91-178"><a id="__codelineno-91-178" name="__codelineno-91-178" href="#__codelineno-91-178"></a>        <span class="p">}</span>
</span><span id="__span-91-179"><a id="__codelineno-91-179" name="__codelineno-91-179" href="#__codelineno-91-179"></a>
</span><span id="__span-91-180"><a id="__codelineno-91-180" name="__codelineno-91-180" href="#__codelineno-91-180"></a>        <span class="c1"># Best model tracking</span>
</span><span id="__span-91-181"><a id="__codelineno-91-181" name="__codelineno-91-181" href="#__codelineno-91-181"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span id="__span-91-182"><a id="__codelineno-91-182" name="__codelineno-91-182" href="#__codelineno-91-182"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_state</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-91-183"><a id="__codelineno-91-183" name="__codelineno-91-183" href="#__codelineno-91-183"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-91-184"><a id="__codelineno-91-184" name="__codelineno-91-184" href="#__codelineno-91-184"></a>
</span><span id="__span-91-185"><a id="__codelineno-91-185" name="__codelineno-91-185" href="#__codelineno-91-185"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">):</span>
</span><span id="__span-91-186"><a id="__codelineno-91-186" name="__codelineno-91-186" href="#__codelineno-91-186"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Train for one epoch&quot;&quot;&quot;</span>
</span><span id="__span-91-187"><a id="__codelineno-91-187" name="__codelineno-91-187" href="#__codelineno-91-187"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-91-188"><a id="__codelineno-91-188" name="__codelineno-91-188" href="#__codelineno-91-188"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-91-189"><a id="__codelineno-91-189" name="__codelineno-91-189" href="#__codelineno-91-189"></a>
</span><span id="__span-91-190"><a id="__codelineno-91-190" name="__codelineno-91-190" href="#__codelineno-91-190"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
</span><span id="__span-91-191"><a id="__codelineno-91-191" name="__codelineno-91-191" href="#__codelineno-91-191"></a>            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-192"><a id="__codelineno-91-192" name="__codelineno-91-192" href="#__codelineno-91-192"></a>            <span class="n">batch_y</span> <span class="o">=</span> <span class="n">batch_y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-193"><a id="__codelineno-91-193" name="__codelineno-91-193" href="#__codelineno-91-193"></a>
</span><span id="__span-91-194"><a id="__codelineno-91-194" name="__codelineno-91-194" href="#__codelineno-91-194"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="__span-91-195"><a id="__codelineno-91-195" name="__codelineno-91-195" href="#__codelineno-91-195"></a>            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-91-196"><a id="__codelineno-91-196" name="__codelineno-91-196" href="#__codelineno-91-196"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-91-197"><a id="__codelineno-91-197" name="__codelineno-91-197" href="#__codelineno-91-197"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="__span-91-198"><a id="__codelineno-91-198" name="__codelineno-91-198" href="#__codelineno-91-198"></a>
</span><span id="__span-91-199"><a id="__codelineno-91-199" name="__codelineno-91-199" href="#__codelineno-91-199"></a>            <span class="c1"># Gradient clipping</span>
</span><span id="__span-91-200"><a id="__codelineno-91-200" name="__codelineno-91-200" href="#__codelineno-91-200"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-91-201"><a id="__codelineno-91-201" name="__codelineno-91-201" href="#__codelineno-91-201"></a>
</span><span id="__span-91-202"><a id="__codelineno-91-202" name="__codelineno-91-202" href="#__codelineno-91-202"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="__span-91-203"><a id="__codelineno-91-203" name="__codelineno-91-203" href="#__codelineno-91-203"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-91-204"><a id="__codelineno-91-204" name="__codelineno-91-204" href="#__codelineno-91-204"></a>
</span><span id="__span-91-205"><a id="__codelineno-91-205" name="__codelineno-91-205" href="#__codelineno-91-205"></a>        <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
</span><span id="__span-91-206"><a id="__codelineno-91-206" name="__codelineno-91-206" href="#__codelineno-91-206"></a>
</span><span id="__span-91-207"><a id="__codelineno-91-207" name="__codelineno-91-207" href="#__codelineno-91-207"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">):</span>
</span><span id="__span-91-208"><a id="__codelineno-91-208" name="__codelineno-91-208" href="#__codelineno-91-208"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the model&quot;&quot;&quot;</span>
</span><span id="__span-91-209"><a id="__codelineno-91-209" name="__codelineno-91-209" href="#__codelineno-91-209"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-91-210"><a id="__codelineno-91-210" name="__codelineno-91-210" href="#__codelineno-91-210"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-91-211"><a id="__codelineno-91-211" name="__codelineno-91-211" href="#__codelineno-91-211"></a>        <span class="n">all_predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-91-212"><a id="__codelineno-91-212" name="__codelineno-91-212" href="#__codelineno-91-212"></a>        <span class="n">all_targets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-91-213"><a id="__codelineno-91-213" name="__codelineno-91-213" href="#__codelineno-91-213"></a>
</span><span id="__span-91-214"><a id="__codelineno-91-214" name="__codelineno-91-214" href="#__codelineno-91-214"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-91-215"><a id="__codelineno-91-215" name="__codelineno-91-215" href="#__codelineno-91-215"></a>            <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>
</span><span id="__span-91-216"><a id="__codelineno-91-216" name="__codelineno-91-216" href="#__codelineno-91-216"></a>                <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-217"><a id="__codelineno-91-217" name="__codelineno-91-217" href="#__codelineno-91-217"></a>                <span class="n">batch_y</span> <span class="o">=</span> <span class="n">batch_y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-218"><a id="__codelineno-91-218" name="__codelineno-91-218" href="#__codelineno-91-218"></a>
</span><span id="__span-91-219"><a id="__codelineno-91-219" name="__codelineno-91-219" href="#__codelineno-91-219"></a>                <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-91-220"><a id="__codelineno-91-220" name="__codelineno-91-220" href="#__codelineno-91-220"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span>
</span><span id="__span-91-221"><a id="__codelineno-91-221" name="__codelineno-91-221" href="#__codelineno-91-221"></a>
</span><span id="__span-91-222"><a id="__codelineno-91-222" name="__codelineno-91-222" href="#__codelineno-91-222"></a>                <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="__span-91-223"><a id="__codelineno-91-223" name="__codelineno-91-223" href="#__codelineno-91-223"></a>                <span class="n">all_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-91-224"><a id="__codelineno-91-224" name="__codelineno-91-224" href="#__codelineno-91-224"></a>                <span class="n">all_targets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-91-225"><a id="__codelineno-91-225" name="__codelineno-91-225" href="#__codelineno-91-225"></a>
</span><span id="__span-91-226"><a id="__codelineno-91-226" name="__codelineno-91-226" href="#__codelineno-91-226"></a>        <span class="c1"># Calculate metrics</span>
</span><span id="__span-91-227"><a id="__codelineno-91-227" name="__codelineno-91-227" href="#__codelineno-91-227"></a>        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
</span><span id="__span-91-228"><a id="__codelineno-91-228" name="__codelineno-91-228" href="#__codelineno-91-228"></a>        <span class="n">all_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-91-229"><a id="__codelineno-91-229" name="__codelineno-91-229" href="#__codelineno-91-229"></a>        <span class="n">all_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_targets</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-91-230"><a id="__codelineno-91-230" name="__codelineno-91-230" href="#__codelineno-91-230"></a>
</span><span id="__span-91-231"><a id="__codelineno-91-231" name="__codelineno-91-231" href="#__codelineno-91-231"></a>        <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">all_targets</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">))</span>
</span><span id="__span-91-232"><a id="__codelineno-91-232" name="__codelineno-91-232" href="#__codelineno-91-232"></a>        <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">all_targets</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
</span><span id="__span-91-233"><a id="__codelineno-91-233" name="__codelineno-91-233" href="#__codelineno-91-233"></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">all_targets</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
</span><span id="__span-91-234"><a id="__codelineno-91-234" name="__codelineno-91-234" href="#__codelineno-91-234"></a>
</span><span id="__span-91-235"><a id="__codelineno-91-235" name="__codelineno-91-235" href="#__codelineno-91-235"></a>        <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">mae</span><span class="p">,</span> <span class="n">r2</span>
</span><span id="__span-91-236"><a id="__codelineno-91-236" name="__codelineno-91-236" href="#__codelineno-91-236"></a>
</span><span id="__span-91-237"><a id="__codelineno-91-237" name="__codelineno-91-237" href="#__codelineno-91-237"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">):</span>
</span><span id="__span-91-238"><a id="__codelineno-91-238" name="__codelineno-91-238" href="#__codelineno-91-238"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Complete training loop&quot;&quot;&quot;</span>
</span><span id="__span-91-239"><a id="__codelineno-91-239" name="__codelineno-91-239" href="#__codelineno-91-239"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-240"><a id="__codelineno-91-240" name="__codelineno-91-240" href="#__codelineno-91-240"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model has </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> parameters&quot;</span><span class="p">)</span>
</span><span id="__span-91-241"><a id="__codelineno-91-241" name="__codelineno-91-241" href="#__codelineno-91-241"></a>
</span><span id="__span-91-242"><a id="__codelineno-91-242" name="__codelineno-91-242" href="#__codelineno-91-242"></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">):</span>
</span><span id="__span-91-243"><a id="__codelineno-91-243" name="__codelineno-91-243" href="#__codelineno-91-243"></a>            <span class="c1"># Train</span>
</span><span id="__span-91-244"><a id="__codelineno-91-244" name="__codelineno-91-244" href="#__codelineno-91-244"></a>            <span class="n">train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
</span><span id="__span-91-245"><a id="__codelineno-91-245" name="__codelineno-91-245" href="#__codelineno-91-245"></a>
</span><span id="__span-91-246"><a id="__codelineno-91-246" name="__codelineno-91-246" href="#__codelineno-91-246"></a>            <span class="c1"># Validate</span>
</span><span id="__span-91-247"><a id="__codelineno-91-247" name="__codelineno-91-247" href="#__codelineno-91-247"></a>            <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_rmse</span><span class="p">,</span> <span class="n">val_mae</span><span class="p">,</span> <span class="n">val_r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
</span><span id="__span-91-248"><a id="__codelineno-91-248" name="__codelineno-91-248" href="#__codelineno-91-248"></a>
</span><span id="__span-91-249"><a id="__codelineno-91-249" name="__codelineno-91-249" href="#__codelineno-91-249"></a>            <span class="c1"># Update history</span>
</span><span id="__span-91-250"><a id="__codelineno-91-250" name="__codelineno-91-250" href="#__codelineno-91-250"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
</span><span id="__span-91-251"><a id="__codelineno-91-251" name="__codelineno-91-251" href="#__codelineno-91-251"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-91-252"><a id="__codelineno-91-252" name="__codelineno-91-252" href="#__codelineno-91-252"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_rmse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_rmse</span><span class="p">)</span>
</span><span id="__span-91-253"><a id="__codelineno-91-253" name="__codelineno-91-253" href="#__codelineno-91-253"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_mae</span><span class="p">)</span>
</span><span id="__span-91-254"><a id="__codelineno-91-254" name="__codelineno-91-254" href="#__codelineno-91-254"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_r2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_r2</span><span class="p">)</span>
</span><span id="__span-91-255"><a id="__codelineno-91-255" name="__codelineno-91-255" href="#__codelineno-91-255"></a>
</span><span id="__span-91-256"><a id="__codelineno-91-256" name="__codelineno-91-256" href="#__codelineno-91-256"></a>            <span class="c1"># Learning rate scheduling</span>
</span><span id="__span-91-257"><a id="__codelineno-91-257" name="__codelineno-91-257" href="#__codelineno-91-257"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
</span><span id="__span-91-258"><a id="__codelineno-91-258" name="__codelineno-91-258" href="#__codelineno-91-258"></a>
</span><span id="__span-91-259"><a id="__codelineno-91-259" name="__codelineno-91-259" href="#__codelineno-91-259"></a>            <span class="c1"># Print progress</span>
</span><span id="__span-91-260"><a id="__codelineno-91-260" name="__codelineno-91-260" href="#__codelineno-91-260"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-91-261"><a id="__codelineno-91-261" name="__codelineno-91-261" href="#__codelineno-91-261"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-262"><a id="__codelineno-91-262" name="__codelineno-91-262" href="#__codelineno-91-262"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-263"><a id="__codelineno-91-263" name="__codelineno-91-263" href="#__codelineno-91-263"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val Loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, RMSE: </span><span class="si">{</span><span class="n">val_rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="__span-91-264"><a id="__codelineno-91-264" name="__codelineno-91-264" href="#__codelineno-91-264"></a>                      <span class="sa">f</span><span class="s2">&quot;MAE: </span><span class="si">{</span><span class="n">val_mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, R²: </span><span class="si">{</span><span class="n">val_r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-265"><a id="__codelineno-91-265" name="__codelineno-91-265" href="#__codelineno-91-265"></a>
</span><span id="__span-91-266"><a id="__codelineno-91-266" name="__codelineno-91-266" href="#__codelineno-91-266"></a>            <span class="c1"># Early stopping</span>
</span><span id="__span-91-267"><a id="__codelineno-91-267" name="__codelineno-91-267" href="#__codelineno-91-267"></a>            <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_val_loss</span><span class="p">:</span>
</span><span id="__span-91-268"><a id="__codelineno-91-268" name="__codelineno-91-268" href="#__codelineno-91-268"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
</span><span id="__span-91-269"><a id="__codelineno-91-269" name="__codelineno-91-269" href="#__codelineno-91-269"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">best_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-91-270"><a id="__codelineno-91-270" name="__codelineno-91-270" href="#__codelineno-91-270"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">patience_counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-91-271"><a id="__codelineno-91-271" name="__codelineno-91-271" href="#__codelineno-91-271"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-91-272"><a id="__codelineno-91-272" name="__codelineno-91-272" href="#__codelineno-91-272"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">patience_counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-91-273"><a id="__codelineno-91-273" name="__codelineno-91-273" href="#__codelineno-91-273"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience_counter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">patience</span><span class="p">:</span>
</span><span id="__span-91-274"><a id="__codelineno-91-274" name="__codelineno-91-274" href="#__codelineno-91-274"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Early stopping at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-275"><a id="__codelineno-91-275" name="__codelineno-91-275" href="#__codelineno-91-275"></a>                    <span class="k">break</span>
</span><span id="__span-91-276"><a id="__codelineno-91-276" name="__codelineno-91-276" href="#__codelineno-91-276"></a>
</span><span id="__span-91-277"><a id="__codelineno-91-277" name="__codelineno-91-277" href="#__codelineno-91-277"></a>        <span class="c1"># Load best model</span>
</span><span id="__span-91-278"><a id="__codelineno-91-278" name="__codelineno-91-278" href="#__codelineno-91-278"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_state</span><span class="p">)</span>
</span><span id="__span-91-279"><a id="__codelineno-91-279" name="__codelineno-91-279" href="#__codelineno-91-279"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training complete! Best validation loss: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-280"><a id="__codelineno-91-280" name="__codelineno-91-280" href="#__codelineno-91-280"></a>
</span><span id="__span-91-281"><a id="__codelineno-91-281" name="__codelineno-91-281" href="#__codelineno-91-281"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
</span><span id="__span-91-282"><a id="__codelineno-91-282" name="__codelineno-91-282" href="#__codelineno-91-282"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save model and training info&quot;&quot;&quot;</span>
</span><span id="__span-91-283"><a id="__codelineno-91-283" name="__codelineno-91-283" href="#__codelineno-91-283"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
</span><span id="__span-91-284"><a id="__codelineno-91-284" name="__codelineno-91-284" href="#__codelineno-91-284"></a>            <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="__span-91-285"><a id="__codelineno-91-285" name="__codelineno-91-285" href="#__codelineno-91-285"></a>            <span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="__span-91-286"><a id="__codelineno-91-286" name="__codelineno-91-286" href="#__codelineno-91-286"></a>            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">),</span>
</span><span id="__span-91-287"><a id="__codelineno-91-287" name="__codelineno-91-287" href="#__codelineno-91-287"></a>            <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
</span><span id="__span-91-288"><a id="__codelineno-91-288" name="__codelineno-91-288" href="#__codelineno-91-288"></a>            <span class="s1">&#39;best_val_loss&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_val_loss</span>
</span><span id="__span-91-289"><a id="__codelineno-91-289" name="__codelineno-91-289" href="#__codelineno-91-289"></a>        <span class="p">},</span> <span class="n">filepath</span><span class="p">)</span>
</span><span id="__span-91-290"><a id="__codelineno-91-290" name="__codelineno-91-290" href="#__codelineno-91-290"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model saved to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-291"><a id="__codelineno-91-291" name="__codelineno-91-291" href="#__codelineno-91-291"></a>
</span><span id="__span-91-292"><a id="__codelineno-91-292" name="__codelineno-91-292" href="#__codelineno-91-292"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
</span><span id="__span-91-293"><a id="__codelineno-91-293" name="__codelineno-91-293" href="#__codelineno-91-293"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load saved model&quot;&quot;&quot;</span>
</span><span id="__span-91-294"><a id="__codelineno-91-294" name="__codelineno-91-294" href="#__codelineno-91-294"></a>        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-295"><a id="__codelineno-91-295" name="__codelineno-91-295" href="#__codelineno-91-295"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
</span><span id="__span-91-296"><a id="__codelineno-91-296" name="__codelineno-91-296" href="#__codelineno-91-296"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">])</span>
</span><span id="__span-91-297"><a id="__codelineno-91-297" name="__codelineno-91-297" href="#__codelineno-91-297"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span>
</span><span id="__span-91-298"><a id="__codelineno-91-298" name="__codelineno-91-298" href="#__codelineno-91-298"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model loaded from </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-299"><a id="__codelineno-91-299" name="__codelineno-91-299" href="#__codelineno-91-299"></a>
</span><span id="__span-91-300"><a id="__codelineno-91-300" name="__codelineno-91-300" href="#__codelineno-91-300"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-301"><a id="__codelineno-91-301" name="__codelineno-91-301" href="#__codelineno-91-301"></a><span class="c1"># 5. EVALUATION</span>
</span><span id="__span-91-302"><a id="__codelineno-91-302" name="__codelineno-91-302" href="#__codelineno-91-302"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-303"><a id="__codelineno-91-303" name="__codelineno-91-303" href="#__codelineno-91-303"></a>
</span><span id="__span-91-304"><a id="__codelineno-91-304" name="__codelineno-91-304" href="#__codelineno-91-304"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="__span-91-305"><a id="__codelineno-91-305" name="__codelineno-91-305" href="#__codelineno-91-305"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate model on test set&quot;&quot;&quot;</span>
</span><span id="__span-91-306"><a id="__codelineno-91-306" name="__codelineno-91-306" href="#__codelineno-91-306"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-91-307"><a id="__codelineno-91-307" name="__codelineno-91-307" href="#__codelineno-91-307"></a>    <span class="n">all_predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-91-308"><a id="__codelineno-91-308" name="__codelineno-91-308" href="#__codelineno-91-308"></a>    <span class="n">all_targets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-91-309"><a id="__codelineno-91-309" name="__codelineno-91-309" href="#__codelineno-91-309"></a>
</span><span id="__span-91-310"><a id="__codelineno-91-310" name="__codelineno-91-310" href="#__codelineno-91-310"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-91-311"><a id="__codelineno-91-311" name="__codelineno-91-311" href="#__codelineno-91-311"></a>        <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
</span><span id="__span-91-312"><a id="__codelineno-91-312" name="__codelineno-91-312" href="#__codelineno-91-312"></a>            <span class="n">batch_x</span> <span class="o">=</span> <span class="n">batch_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-313"><a id="__codelineno-91-313" name="__codelineno-91-313" href="#__codelineno-91-313"></a>            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_x</span><span class="p">)</span>
</span><span id="__span-91-314"><a id="__codelineno-91-314" name="__codelineno-91-314" href="#__codelineno-91-314"></a>
</span><span id="__span-91-315"><a id="__codelineno-91-315" name="__codelineno-91-315" href="#__codelineno-91-315"></a>            <span class="n">all_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-91-316"><a id="__codelineno-91-316" name="__codelineno-91-316" href="#__codelineno-91-316"></a>            <span class="n">all_targets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_y</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span><span id="__span-91-317"><a id="__codelineno-91-317" name="__codelineno-91-317" href="#__codelineno-91-317"></a>
</span><span id="__span-91-318"><a id="__codelineno-91-318" name="__codelineno-91-318" href="#__codelineno-91-318"></a>    <span class="n">all_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-91-319"><a id="__codelineno-91-319" name="__codelineno-91-319" href="#__codelineno-91-319"></a>    <span class="n">all_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_targets</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-91-320"><a id="__codelineno-91-320" name="__codelineno-91-320" href="#__codelineno-91-320"></a>
</span><span id="__span-91-321"><a id="__codelineno-91-321" name="__codelineno-91-321" href="#__codelineno-91-321"></a>    <span class="c1"># Calculate metrics</span>
</span><span id="__span-91-322"><a id="__codelineno-91-322" name="__codelineno-91-322" href="#__codelineno-91-322"></a>    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">all_targets</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">))</span>
</span><span id="__span-91-323"><a id="__codelineno-91-323" name="__codelineno-91-323" href="#__codelineno-91-323"></a>    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">all_targets</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
</span><span id="__span-91-324"><a id="__codelineno-91-324" name="__codelineno-91-324" href="#__codelineno-91-324"></a>    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">all_targets</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
</span><span id="__span-91-325"><a id="__codelineno-91-325" name="__codelineno-91-325" href="#__codelineno-91-325"></a>
</span><span id="__span-91-326"><a id="__codelineno-91-326" name="__codelineno-91-326" href="#__codelineno-91-326"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test Set Evaluation:&quot;</span><span class="p">)</span>
</span><span id="__span-91-327"><a id="__codelineno-91-327" name="__codelineno-91-327" href="#__codelineno-91-327"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-328"><a id="__codelineno-91-328" name="__codelineno-91-328" href="#__codelineno-91-328"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-329"><a id="__codelineno-91-329" name="__codelineno-91-329" href="#__codelineno-91-329"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R²: </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-330"><a id="__codelineno-91-330" name="__codelineno-91-330" href="#__codelineno-91-330"></a>
</span><span id="__span-91-331"><a id="__codelineno-91-331" name="__codelineno-91-331" href="#__codelineno-91-331"></a>    <span class="k">return</span> <span class="n">all_predictions</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">}</span>
</span><span id="__span-91-332"><a id="__codelineno-91-332" name="__codelineno-91-332" href="#__codelineno-91-332"></a>
</span><span id="__span-91-333"><a id="__codelineno-91-333" name="__codelineno-91-333" href="#__codelineno-91-333"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;results.png&#39;</span><span class="p">):</span>
</span><span id="__span-91-334"><a id="__codelineno-91-334" name="__codelineno-91-334" href="#__codelineno-91-334"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot training history and predictions&quot;&quot;&quot;</span>
</span><span id="__span-91-335"><a id="__codelineno-91-335" name="__codelineno-91-335" href="#__codelineno-91-335"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span><span id="__span-91-336"><a id="__codelineno-91-336" name="__codelineno-91-336" href="#__codelineno-91-336"></a>
</span><span id="__span-91-337"><a id="__codelineno-91-337" name="__codelineno-91-337" href="#__codelineno-91-337"></a>    <span class="c1"># Training history</span>
</span><span id="__span-91-338"><a id="__codelineno-91-338" name="__codelineno-91-338" href="#__codelineno-91-338"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">)</span>
</span><span id="__span-91-339"><a id="__codelineno-91-339" name="__codelineno-91-339" href="#__codelineno-91-339"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Loss&#39;</span><span class="p">)</span>
</span><span id="__span-91-340"><a id="__codelineno-91-340" name="__codelineno-91-340" href="#__codelineno-91-340"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-91-341"><a id="__codelineno-91-341" name="__codelineno-91-341" href="#__codelineno-91-341"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
</span><span id="__span-91-342"><a id="__codelineno-91-342" name="__codelineno-91-342" href="#__codelineno-91-342"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Training History&#39;</span><span class="p">)</span>
</span><span id="__span-91-343"><a id="__codelineno-91-343" name="__codelineno-91-343" href="#__codelineno-91-343"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-91-344"><a id="__codelineno-91-344" name="__codelineno-91-344" href="#__codelineno-91-344"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-91-345"><a id="__codelineno-91-345" name="__codelineno-91-345" href="#__codelineno-91-345"></a>
</span><span id="__span-91-346"><a id="__codelineno-91-346" name="__codelineno-91-346" href="#__codelineno-91-346"></a>    <span class="c1"># Metrics</span>
</span><span id="__span-91-347"><a id="__codelineno-91-347" name="__codelineno-91-347" href="#__codelineno-91-347"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_rmse&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RMSE&#39;</span><span class="p">)</span>
</span><span id="__span-91-348"><a id="__codelineno-91-348" name="__codelineno-91-348" href="#__codelineno-91-348"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_mae&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">)</span>
</span><span id="__span-91-349"><a id="__codelineno-91-349" name="__codelineno-91-349" href="#__codelineno-91-349"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
</span><span id="__span-91-350"><a id="__codelineno-91-350" name="__codelineno-91-350" href="#__codelineno-91-350"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
</span><span id="__span-91-351"><a id="__codelineno-91-351" name="__codelineno-91-351" href="#__codelineno-91-351"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Validation Errors&#39;</span><span class="p">)</span>
</span><span id="__span-91-352"><a id="__codelineno-91-352" name="__codelineno-91-352" href="#__codelineno-91-352"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-91-353"><a id="__codelineno-91-353" name="__codelineno-91-353" href="#__codelineno-91-353"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-91-354"><a id="__codelineno-91-354" name="__codelineno-91-354" href="#__codelineno-91-354"></a>
</span><span id="__span-91-355"><a id="__codelineno-91-355" name="__codelineno-91-355" href="#__codelineno-91-355"></a>    <span class="c1"># Predictions</span>
</span><span id="__span-91-356"><a id="__codelineno-91-356" name="__codelineno-91-356" href="#__codelineno-91-356"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-91-357"><a id="__codelineno-91-357" name="__codelineno-91-357" href="#__codelineno-91-357"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">targets</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">targets</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> 
</span><span id="__span-91-358"><a id="__codelineno-91-358" name="__codelineno-91-358" href="#__codelineno-91-358"></a>                     <span class="p">[</span><span class="n">targets</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">targets</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-91-359"><a id="__codelineno-91-359" name="__codelineno-91-359" href="#__codelineno-91-359"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
</span><span id="__span-91-360"><a id="__codelineno-91-360" name="__codelineno-91-360" href="#__codelineno-91-360"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predictions&#39;</span><span class="p">)</span>
</span><span id="__span-91-361"><a id="__codelineno-91-361" name="__codelineno-91-361" href="#__codelineno-91-361"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predictions vs True Values&#39;</span><span class="p">)</span>
</span><span id="__span-91-362"><a id="__codelineno-91-362" name="__codelineno-91-362" href="#__codelineno-91-362"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-91-363"><a id="__codelineno-91-363" name="__codelineno-91-363" href="#__codelineno-91-363"></a>
</span><span id="__span-91-364"><a id="__codelineno-91-364" name="__codelineno-91-364" href="#__codelineno-91-364"></a>    <span class="c1"># Residuals</span>
</span><span id="__span-91-365"><a id="__codelineno-91-365" name="__codelineno-91-365" href="#__codelineno-91-365"></a>    <span class="n">residuals</span> <span class="o">=</span> <span class="n">targets</span> <span class="o">-</span> <span class="n">predictions</span>
</span><span id="__span-91-366"><a id="__codelineno-91-366" name="__codelineno-91-366" href="#__codelineno-91-366"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-91-367"><a id="__codelineno-91-367" name="__codelineno-91-367" href="#__codelineno-91-367"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
</span><span id="__span-91-368"><a id="__codelineno-91-368" name="__codelineno-91-368" href="#__codelineno-91-368"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
</span><span id="__span-91-369"><a id="__codelineno-91-369" name="__codelineno-91-369" href="#__codelineno-91-369"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual Distribution&#39;</span><span class="p">)</span>
</span><span id="__span-91-370"><a id="__codelineno-91-370" name="__codelineno-91-370" href="#__codelineno-91-370"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-91-371"><a id="__codelineno-91-371" name="__codelineno-91-371" href="#__codelineno-91-371"></a>
</span><span id="__span-91-372"><a id="__codelineno-91-372" name="__codelineno-91-372" href="#__codelineno-91-372"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-91-373"><a id="__codelineno-91-373" name="__codelineno-91-373" href="#__codelineno-91-373"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="__span-91-374"><a id="__codelineno-91-374" name="__codelineno-91-374" href="#__codelineno-91-374"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results saved to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-375"><a id="__codelineno-91-375" name="__codelineno-91-375" href="#__codelineno-91-375"></a>
</span><span id="__span-91-376"><a id="__codelineno-91-376" name="__codelineno-91-376" href="#__codelineno-91-376"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-377"><a id="__codelineno-91-377" name="__codelineno-91-377" href="#__codelineno-91-377"></a><span class="c1"># 6. MAIN EXECUTION</span>
</span><span id="__span-91-378"><a id="__codelineno-91-378" name="__codelineno-91-378" href="#__codelineno-91-378"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-91-379"><a id="__codelineno-91-379" name="__codelineno-91-379" href="#__codelineno-91-379"></a>
</span><span id="__span-91-380"><a id="__codelineno-91-380" name="__codelineno-91-380" href="#__codelineno-91-380"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-91-381"><a id="__codelineno-91-381" name="__codelineno-91-381" href="#__codelineno-91-381"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main execution function&quot;&quot;&quot;</span>
</span><span id="__span-91-382"><a id="__codelineno-91-382" name="__codelineno-91-382" href="#__codelineno-91-382"></a>
</span><span id="__span-91-383"><a id="__codelineno-91-383" name="__codelineno-91-383" href="#__codelineno-91-383"></a>    <span class="c1"># Set random seeds</span>
</span><span id="__span-91-384"><a id="__codelineno-91-384" name="__codelineno-91-384" href="#__codelineno-91-384"></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</span><span id="__span-91-385"><a id="__codelineno-91-385" name="__codelineno-91-385" href="#__codelineno-91-385"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</span><span id="__span-91-386"><a id="__codelineno-91-386" name="__codelineno-91-386" href="#__codelineno-91-386"></a>
</span><span id="__span-91-387"><a id="__codelineno-91-387" name="__codelineno-91-387" href="#__codelineno-91-387"></a>    <span class="c1"># Create directories</span>
</span><span id="__span-91-388"><a id="__codelineno-91-388" name="__codelineno-91-388" href="#__codelineno-91-388"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-91-389"><a id="__codelineno-91-389" name="__codelineno-91-389" href="#__codelineno-91-389"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-91-390"><a id="__codelineno-91-390" name="__codelineno-91-390" href="#__codelineno-91-390"></a>
</span><span id="__span-91-391"><a id="__codelineno-91-391" name="__codelineno-91-391" href="#__codelineno-91-391"></a>    <span class="c1"># Load data</span>
</span><span id="__span-91-392"><a id="__codelineno-91-392" name="__codelineno-91-392" href="#__codelineno-91-392"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data...&quot;</span><span class="p">)</span>
</span><span id="__span-91-393"><a id="__codelineno-91-393" name="__codelineno-91-393" href="#__codelineno-91-393"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
</span><span id="__span-91-394"><a id="__codelineno-91-394" name="__codelineno-91-394" href="#__codelineno-91-394"></a>    <span class="n">smiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">Config</span><span class="o">.</span><span class="n">smiles_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="__span-91-395"><a id="__codelineno-91-395" name="__codelineno-91-395" href="#__codelineno-91-395"></a>    <span class="n">targets</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">Config</span><span class="o">.</span><span class="n">target_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="__span-91-396"><a id="__codelineno-91-396" name="__codelineno-91-396" href="#__codelineno-91-396"></a>
</span><span id="__span-91-397"><a id="__codelineno-91-397" name="__codelineno-91-397" href="#__codelineno-91-397"></a>    <span class="c1"># Split data</span>
</span><span id="__span-91-398"><a id="__codelineno-91-398" name="__codelineno-91-398" href="#__codelineno-91-398"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Splitting data...&quot;</span><span class="p">)</span>
</span><span id="__span-91-399"><a id="__codelineno-91-399" name="__codelineno-91-399" href="#__codelineno-91-399"></a>    <span class="n">smiles_train</span><span class="p">,</span> <span class="n">smiles_temp</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_temp</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
</span><span id="__span-91-400"><a id="__codelineno-91-400" name="__codelineno-91-400" href="#__codelineno-91-400"></a>        <span class="n">smiles</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">random_seed</span>
</span><span id="__span-91-401"><a id="__codelineno-91-401" name="__codelineno-91-401" href="#__codelineno-91-401"></a>    <span class="p">)</span>
</span><span id="__span-91-402"><a id="__codelineno-91-402" name="__codelineno-91-402" href="#__codelineno-91-402"></a>    <span class="n">smiles_val</span><span class="p">,</span> <span class="n">smiles_test</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
</span><span id="__span-91-403"><a id="__codelineno-91-403" name="__codelineno-91-403" href="#__codelineno-91-403"></a>        <span class="n">smiles_temp</span><span class="p">,</span> <span class="n">y_temp</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">random_seed</span>
</span><span id="__span-91-404"><a id="__codelineno-91-404" name="__codelineno-91-404" href="#__codelineno-91-404"></a>    <span class="p">)</span>
</span><span id="__span-91-405"><a id="__codelineno-91-405" name="__codelineno-91-405" href="#__codelineno-91-405"></a>
</span><span id="__span-91-406"><a id="__codelineno-91-406" name="__codelineno-91-406" href="#__codelineno-91-406"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">)</span><span class="si">}</span><span class="s2">, Val: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles_val</span><span class="p">)</span><span class="si">}</span><span class="s2">, Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-91-407"><a id="__codelineno-91-407" name="__codelineno-91-407" href="#__codelineno-91-407"></a>
</span><span id="__span-91-408"><a id="__codelineno-91-408" name="__codelineno-91-408" href="#__codelineno-91-408"></a>    <span class="c1"># Create datasets</span>
</span><span id="__span-91-409"><a id="__codelineno-91-409" name="__codelineno-91-409" href="#__codelineno-91-409"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating datasets...&quot;</span><span class="p">)</span>
</span><span id="__span-91-410"><a id="__codelineno-91-410" name="__codelineno-91-410" href="#__codelineno-91-410"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">MolecularDataset</span><span class="p">(</span><span class="n">smiles_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">Config</span><span class="p">)</span>
</span><span id="__span-91-411"><a id="__codelineno-91-411" name="__codelineno-91-411" href="#__codelineno-91-411"></a>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">MolecularDataset</span><span class="p">(</span><span class="n">smiles_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">Config</span><span class="p">,</span> 
</span><span id="__span-91-412"><a id="__codelineno-91-412" name="__codelineno-91-412" href="#__codelineno-91-412"></a>                                   <span class="n">scaler</span><span class="o">=</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">scaler</span><span class="p">)</span>
</span><span id="__span-91-413"><a id="__codelineno-91-413" name="__codelineno-91-413" href="#__codelineno-91-413"></a>    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">MolecularDataset</span><span class="p">(</span><span class="n">smiles_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">Config</span><span class="p">,</span>
</span><span id="__span-91-414"><a id="__codelineno-91-414" name="__codelineno-91-414" href="#__codelineno-91-414"></a>                                   <span class="n">scaler</span><span class="o">=</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">scaler</span><span class="p">)</span>
</span><span id="__span-91-415"><a id="__codelineno-91-415" name="__codelineno-91-415" href="#__codelineno-91-415"></a>
</span><span id="__span-91-416"><a id="__codelineno-91-416" name="__codelineno-91-416" href="#__codelineno-91-416"></a>    <span class="c1"># Create data loaders</span>
</span><span id="__span-91-417"><a id="__codelineno-91-417" name="__codelineno-91-417" href="#__codelineno-91-417"></a>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-91-418"><a id="__codelineno-91-418" name="__codelineno-91-418" href="#__codelineno-91-418"></a>    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="__span-91-419"><a id="__codelineno-91-419" name="__codelineno-91-419" href="#__codelineno-91-419"></a>    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="__span-91-420"><a id="__codelineno-91-420" name="__codelineno-91-420" href="#__codelineno-91-420"></a>
</span><span id="__span-91-421"><a id="__codelineno-91-421" name="__codelineno-91-421" href="#__codelineno-91-421"></a>    <span class="c1"># Create model</span>
</span><span id="__span-91-422"><a id="__codelineno-91-422" name="__codelineno-91-422" href="#__codelineno-91-422"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating model...&quot;</span><span class="p">)</span>
</span><span id="__span-91-423"><a id="__codelineno-91-423" name="__codelineno-91-423" href="#__codelineno-91-423"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">MolecularNN</span><span class="p">(</span><span class="n">Config</span><span class="p">)</span>
</span><span id="__span-91-424"><a id="__codelineno-91-424" name="__codelineno-91-424" href="#__codelineno-91-424"></a>
</span><span id="__span-91-425"><a id="__codelineno-91-425" name="__codelineno-91-425" href="#__codelineno-91-425"></a>    <span class="c1"># Create trainer</span>
</span><span id="__span-91-426"><a id="__codelineno-91-426" name="__codelineno-91-426" href="#__codelineno-91-426"></a>    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Config</span><span class="p">)</span>
</span><span id="__span-91-427"><a id="__codelineno-91-427" name="__codelineno-91-427" href="#__codelineno-91-427"></a>
</span><span id="__span-91-428"><a id="__codelineno-91-428" name="__codelineno-91-428" href="#__codelineno-91-428"></a>    <span class="c1"># Train</span>
</span><span id="__span-91-429"><a id="__codelineno-91-429" name="__codelineno-91-429" href="#__codelineno-91-429"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting training...&quot;</span><span class="p">)</span>
</span><span id="__span-91-430"><a id="__codelineno-91-430" name="__codelineno-91-430" href="#__codelineno-91-430"></a>    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">)</span>
</span><span id="__span-91-431"><a id="__codelineno-91-431" name="__codelineno-91-431" href="#__codelineno-91-431"></a>
</span><span id="__span-91-432"><a id="__codelineno-91-432" name="__codelineno-91-432" href="#__codelineno-91-432"></a>    <span class="c1"># Save model</span>
</span><span id="__span-91-433"><a id="__codelineno-91-433" name="__codelineno-91-433" href="#__codelineno-91-433"></a>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
</span><span id="__span-91-434"><a id="__codelineno-91-434" name="__codelineno-91-434" href="#__codelineno-91-434"></a>    <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;model_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">.pth&#39;</span><span class="p">)</span>
</span><span id="__span-91-435"><a id="__codelineno-91-435" name="__codelineno-91-435" href="#__codelineno-91-435"></a>    <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
</span><span id="__span-91-436"><a id="__codelineno-91-436" name="__codelineno-91-436" href="#__codelineno-91-436"></a>
</span><span id="__span-91-437"><a id="__codelineno-91-437" name="__codelineno-91-437" href="#__codelineno-91-437"></a>    <span class="c1"># Evaluate on test set</span>
</span><span id="__span-91-438"><a id="__codelineno-91-438" name="__codelineno-91-438" href="#__codelineno-91-438"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluating on test set...&quot;</span><span class="p">)</span>
</span><span id="__span-91-439"><a id="__codelineno-91-439" name="__codelineno-91-439" href="#__codelineno-91-439"></a>    <span class="n">predictions</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">trainer</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="__span-91-440"><a id="__codelineno-91-440" name="__codelineno-91-440" href="#__codelineno-91-440"></a>
</span><span id="__span-91-441"><a id="__codelineno-91-441" name="__codelineno-91-441" href="#__codelineno-91-441"></a>    <span class="c1"># Plot results</span>
</span><span id="__span-91-442"><a id="__codelineno-91-442" name="__codelineno-91-442" href="#__codelineno-91-442"></a>    <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;results_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
</span><span id="__span-91-443"><a id="__codelineno-91-443" name="__codelineno-91-443" href="#__codelineno-91-443"></a>    <span class="n">plot_results</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">results_path</span><span class="p">)</span>
</span><span id="__span-91-444"><a id="__codelineno-91-444" name="__codelineno-91-444" href="#__codelineno-91-444"></a>
</span><span id="__span-91-445"><a id="__codelineno-91-445" name="__codelineno-91-445" href="#__codelineno-91-445"></a>    <span class="c1"># Save metrics</span>
</span><span id="__span-91-446"><a id="__codelineno-91-446" name="__codelineno-91-446" href="#__codelineno-91-446"></a>    <span class="n">metrics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;metrics_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">)</span>
</span><span id="__span-91-447"><a id="__codelineno-91-447" name="__codelineno-91-447" href="#__codelineno-91-447"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metrics_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-91-448"><a id="__codelineno-91-448" name="__codelineno-91-448" href="#__codelineno-91-448"></a>        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-91-449"><a id="__codelineno-91-449" name="__codelineno-91-449" href="#__codelineno-91-449"></a>
</span><span id="__span-91-450"><a id="__codelineno-91-450" name="__codelineno-91-450" href="#__codelineno-91-450"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pipeline complete!&quot;</span><span class="p">)</span>
</span><span id="__span-91-451"><a id="__codelineno-91-451" name="__codelineno-91-451" href="#__codelineno-91-451"></a>
</span><span id="__span-91-452"><a id="__codelineno-91-452" name="__codelineno-91-452" href="#__codelineno-91-452"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-91-453"><a id="__codelineno-91-453" name="__codelineno-91-453" href="#__codelineno-91-453"></a>    <span class="n">main</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="appendix__b__smiles__processing__utilities">Appendix B: SMILES Processing Utilities<a class="headerlink" href="#appendix__b__smiles__processing__utilities" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="sd">SMILES Processing Utilities</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="sd">Complete toolkit for SMILES handling, tokenization, and augmentation</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">AllChem</span>
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a>
</span><span id="__span-92-11"><a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-12"><a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a><span class="c1"># SMILES TOKENIZATION</span>
</span><span id="__span-92-13"><a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-14"><a id="__codelineno-92-14" name="__codelineno-92-14" href="#__codelineno-92-14"></a>
</span><span id="__span-92-15"><a id="__codelineno-92-15" name="__codelineno-92-15" href="#__codelineno-92-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">SMILESTokenizer</span><span class="p">:</span>
</span><span id="__span-92-16"><a id="__codelineno-92-16" name="__codelineno-92-16" href="#__codelineno-92-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Advanced SMILES tokenizer with comprehensive vocabulary&quot;&quot;&quot;</span>
</span><span id="__span-92-17"><a id="__codelineno-92-17" name="__codelineno-92-17" href="#__codelineno-92-17"></a>
</span><span id="__span-92-18"><a id="__codelineno-92-18" name="__codelineno-92-18" href="#__codelineno-92-18"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-92-19"><a id="__codelineno-92-19" name="__codelineno-92-19" href="#__codelineno-92-19"></a>        <span class="c1"># Define token patterns (order matters!)</span>
</span><span id="__span-92-20"><a id="__codelineno-92-20" name="__codelineno-92-20" href="#__codelineno-92-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_patterns</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-92-21"><a id="__codelineno-92-21" name="__codelineno-92-21" href="#__codelineno-92-21"></a>            <span class="sa">r</span><span class="s1">&#39;Br&#39;</span><span class="p">,</span>  <span class="c1"># Bromine (must come before &#39;r&#39;)</span>
</span><span id="__span-92-22"><a id="__codelineno-92-22" name="__codelineno-92-22" href="#__codelineno-92-22"></a>            <span class="sa">r</span><span class="s1">&#39;Cl&#39;</span><span class="p">,</span>  <span class="c1"># Chlorine (must come before &#39;l&#39;)</span>
</span><span id="__span-92-23"><a id="__codelineno-92-23" name="__codelineno-92-23" href="#__codelineno-92-23"></a>            <span class="sa">r</span><span class="s1">&#39;@@&#39;</span><span class="p">,</span>  <span class="c1"># Chirality</span>
</span><span id="__span-92-24"><a id="__codelineno-92-24" name="__codelineno-92-24" href="#__codelineno-92-24"></a>            <span class="sa">r</span><span class="s1">&#39;@&#39;</span><span class="p">,</span>   <span class="c1"># Chirality</span>
</span><span id="__span-92-25"><a id="__codelineno-92-25" name="__codelineno-92-25" href="#__codelineno-92-25"></a>            <span class="sa">r</span><span class="s1">&#39;\[([^\]]+)\]&#39;</span><span class="p">,</span>  <span class="c1"># Bracketed atoms</span>
</span><span id="__span-92-26"><a id="__codelineno-92-26" name="__codelineno-92-26" href="#__codelineno-92-26"></a>            <span class="sa">r</span><span class="s1">&#39;[A-Z][a-z]?&#39;</span><span class="p">,</span>   <span class="c1"># Elements</span>
</span><span id="__span-92-27"><a id="__codelineno-92-27" name="__codelineno-92-27" href="#__codelineno-92-27"></a>            <span class="sa">r</span><span class="s1">&#39;[#%\(\)\+\-0-9=</span><span class="se">\\</span><span class="s1">/]&#39;</span><span class="p">,</span>  <span class="c1"># Other tokens</span>
</span><span id="__span-92-28"><a id="__codelineno-92-28" name="__codelineno-92-28" href="#__codelineno-92-28"></a>        <span class="p">]</span>
</span><span id="__span-92-29"><a id="__codelineno-92-29" name="__codelineno-92-29" href="#__codelineno-92-29"></a>
</span><span id="__span-92-30"><a id="__codelineno-92-30" name="__codelineno-92-30" href="#__codelineno-92-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_patterns</span><span class="p">))</span>
</span><span id="__span-92-31"><a id="__codelineno-92-31" name="__codelineno-92-31" href="#__codelineno-92-31"></a>
</span><span id="__span-92-32"><a id="__codelineno-92-32" name="__codelineno-92-32" href="#__codelineno-92-32"></a>        <span class="c1"># Special tokens</span>
</span><span id="__span-92-33"><a id="__codelineno-92-33" name="__codelineno-92-33" href="#__codelineno-92-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;PAD&gt;&#39;</span>
</span><span id="__span-92-34"><a id="__codelineno-92-34" name="__codelineno-92-34" href="#__codelineno-92-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;UNK&gt;&#39;</span>
</span><span id="__span-92-35"><a id="__codelineno-92-35" name="__codelineno-92-35" href="#__codelineno-92-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;START&gt;&#39;</span>
</span><span id="__span-92-36"><a id="__codelineno-92-36" name="__codelineno-92-36" href="#__codelineno-92-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;END&gt;&#39;</span>
</span><span id="__span-92-37"><a id="__codelineno-92-37" name="__codelineno-92-37" href="#__codelineno-92-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;MASK&gt;&#39;</span>
</span><span id="__span-92-38"><a id="__codelineno-92-38" name="__codelineno-92-38" href="#__codelineno-92-38"></a>
</span><span id="__span-92-39"><a id="__codelineno-92-39" name="__codelineno-92-39" href="#__codelineno-92-39"></a>        <span class="c1"># Build vocabulary from common SMILES</span>
</span><span id="__span-92-40"><a id="__codelineno-92-40" name="__codelineno-92-40" href="#__codelineno-92-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_vocabulary</span><span class="p">()</span>
</span><span id="__span-92-41"><a id="__codelineno-92-41" name="__codelineno-92-41" href="#__codelineno-92-41"></a>
</span><span id="__span-92-42"><a id="__codelineno-92-42" name="__codelineno-92-42" href="#__codelineno-92-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-92-43"><a id="__codelineno-92-43" name="__codelineno-92-43" href="#__codelineno-92-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build comprehensive vocabulary&quot;&quot;&quot;</span>
</span><span id="__span-92-44"><a id="__codelineno-92-44" name="__codelineno-92-44" href="#__codelineno-92-44"></a>        <span class="c1"># Common SMILES tokens</span>
</span><span id="__span-92-45"><a id="__codelineno-92-45" name="__codelineno-92-45" href="#__codelineno-92-45"></a>        <span class="n">common_tokens</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-92-46"><a id="__codelineno-92-46" name="__codelineno-92-46" href="#__codelineno-92-46"></a>            <span class="c1"># Elements</span>
</span><span id="__span-92-47"><a id="__codelineno-92-47" name="__codelineno-92-47" href="#__codelineno-92-47"></a>            <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
</span><span id="__span-92-48"><a id="__codelineno-92-48" name="__codelineno-92-48" href="#__codelineno-92-48"></a>            <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span>
</span><span id="__span-92-49"><a id="__codelineno-92-49" name="__codelineno-92-49" href="#__codelineno-92-49"></a>            <span class="c1"># Aromatic</span>
</span><span id="__span-92-50"><a id="__codelineno-92-50" name="__codelineno-92-50" href="#__codelineno-92-50"></a>            <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span>
</span><span id="__span-92-51"><a id="__codelineno-92-51" name="__codelineno-92-51" href="#__codelineno-92-51"></a>            <span class="c1"># Bonds</span>
</span><span id="__span-92-52"><a id="__codelineno-92-52" name="__codelineno-92-52" href="#__codelineno-92-52"></a>            <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="__span-92-53"><a id="__codelineno-92-53" name="__codelineno-92-53" href="#__codelineno-92-53"></a>            <span class="c1"># Branches</span>
</span><span id="__span-92-54"><a id="__codelineno-92-54" name="__codelineno-92-54" href="#__codelineno-92-54"></a>            <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span>
</span><span id="__span-92-55"><a id="__codelineno-92-55" name="__codelineno-92-55" href="#__codelineno-92-55"></a>            <span class="c1"># Rings</span>
</span><span id="__span-92-56"><a id="__codelineno-92-56" name="__codelineno-92-56" href="#__codelineno-92-56"></a>            <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;%10&#39;</span><span class="p">,</span> <span class="s1">&#39;%11&#39;</span><span class="p">,</span>
</span><span id="__span-92-57"><a id="__codelineno-92-57" name="__codelineno-92-57" href="#__codelineno-92-57"></a>            <span class="c1"># Chirality</span>
</span><span id="__span-92-58"><a id="__codelineno-92-58" name="__codelineno-92-58" href="#__codelineno-92-58"></a>            <span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="s1">&#39;@@&#39;</span><span class="p">,</span>
</span><span id="__span-92-59"><a id="__codelineno-92-59" name="__codelineno-92-59" href="#__codelineno-92-59"></a>            <span class="c1"># Brackets</span>
</span><span id="__span-92-60"><a id="__codelineno-92-60" name="__codelineno-92-60" href="#__codelineno-92-60"></a>            <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span>
</span><span id="__span-92-61"><a id="__codelineno-92-61" name="__codelineno-92-61" href="#__codelineno-92-61"></a>            <span class="c1"># Charges</span>
</span><span id="__span-92-62"><a id="__codelineno-92-62" name="__codelineno-92-62" href="#__codelineno-92-62"></a>            <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;++&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
</span><span id="__span-92-63"><a id="__codelineno-92-63" name="__codelineno-92-63" href="#__codelineno-92-63"></a>            <span class="c1"># Hydrogens</span>
</span><span id="__span-92-64"><a id="__codelineno-92-64" name="__codelineno-92-64" href="#__codelineno-92-64"></a>            <span class="s1">&#39;H&#39;</span><span class="p">,</span>
</span><span id="__span-92-65"><a id="__codelineno-92-65" name="__codelineno-92-65" href="#__codelineno-92-65"></a>        <span class="p">]</span>
</span><span id="__span-92-66"><a id="__codelineno-92-66" name="__codelineno-92-66" href="#__codelineno-92-66"></a>
</span><span id="__span-92-67"><a id="__codelineno-92-67" name="__codelineno-92-67" href="#__codelineno-92-67"></a>        <span class="c1"># Special tokens</span>
</span><span id="__span-92-68"><a id="__codelineno-92-68" name="__codelineno-92-68" href="#__codelineno-92-68"></a>        <span class="n">special_tokens</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-92-69"><a id="__codelineno-92-69" name="__codelineno-92-69" href="#__codelineno-92-69"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">,</span>
</span><span id="__span-92-70"><a id="__codelineno-92-70" name="__codelineno-92-70" href="#__codelineno-92-70"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_token</span>
</span><span id="__span-92-71"><a id="__codelineno-92-71" name="__codelineno-92-71" href="#__codelineno-92-71"></a>        <span class="p">]</span>
</span><span id="__span-92-72"><a id="__codelineno-92-72" name="__codelineno-92-72" href="#__codelineno-92-72"></a>
</span><span id="__span-92-73"><a id="__codelineno-92-73" name="__codelineno-92-73" href="#__codelineno-92-73"></a>        <span class="c1"># Combined vocabulary</span>
</span><span id="__span-92-74"><a id="__codelineno-92-74" name="__codelineno-92-74" href="#__codelineno-92-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">special_tokens</span> <span class="o">+</span> <span class="n">common_tokens</span>
</span><span id="__span-92-75"><a id="__codelineno-92-75" name="__codelineno-92-75" href="#__codelineno-92-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">token</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)}</span>
</span><span id="__span-92-76"><a id="__codelineno-92-76" name="__codelineno-92-76" href="#__codelineno-92-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="__span-92-77"><a id="__codelineno-92-77" name="__codelineno-92-77" href="#__codelineno-92-77"></a>
</span><span id="__span-92-78"><a id="__codelineno-92-78" name="__codelineno-92-78" href="#__codelineno-92-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">):</span>
</span><span id="__span-92-79"><a id="__codelineno-92-79" name="__codelineno-92-79" href="#__codelineno-92-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize SMILES string&quot;&quot;&quot;</span>
</span><span id="__span-92-80"><a id="__codelineno-92-80" name="__codelineno-92-80" href="#__codelineno-92-80"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-81"><a id="__codelineno-92-81" name="__codelineno-92-81" href="#__codelineno-92-81"></a>        <span class="k">return</span> <span class="n">tokens</span>
</span><span id="__span-92-82"><a id="__codelineno-92-82" name="__codelineno-92-82" href="#__codelineno-92-82"></a>
</span><span id="__span-92-83"><a id="__codelineno-92-83" name="__codelineno-92-83" href="#__codelineno-92-83"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-92-84"><a id="__codelineno-92-84" name="__codelineno-92-84" href="#__codelineno-92-84"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert SMILES to token indices&quot;&quot;&quot;</span>
</span><span id="__span-92-85"><a id="__codelineno-92-85" name="__codelineno-92-85" href="#__codelineno-92-85"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-86"><a id="__codelineno-92-86" name="__codelineno-92-86" href="#__codelineno-92-86"></a>
</span><span id="__span-92-87"><a id="__codelineno-92-87" name="__codelineno-92-87" href="#__codelineno-92-87"></a>        <span class="k">if</span> <span class="n">add_special_tokens</span><span class="p">:</span>
</span><span id="__span-92-88"><a id="__codelineno-92-88" name="__codelineno-92-88" href="#__codelineno-92-88"></a>            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_token</span><span class="p">]</span> <span class="o">+</span> <span class="n">tokens</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">end_token</span><span class="p">]</span>
</span><span id="__span-92-89"><a id="__codelineno-92-89" name="__codelineno-92-89" href="#__codelineno-92-89"></a>
</span><span id="__span-92-90"><a id="__codelineno-92-90" name="__codelineno-92-90" href="#__codelineno-92-90"></a>        <span class="c1"># Convert to indices</span>
</span><span id="__span-92-91"><a id="__codelineno-92-91" name="__codelineno-92-91" href="#__codelineno-92-91"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-92-92"><a id="__codelineno-92-92" name="__codelineno-92-92" href="#__codelineno-92-92"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">])</span>
</span><span id="__span-92-93"><a id="__codelineno-92-93" name="__codelineno-92-93" href="#__codelineno-92-93"></a>            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
</span><span id="__span-92-94"><a id="__codelineno-92-94" name="__codelineno-92-94" href="#__codelineno-92-94"></a>        <span class="p">]</span>
</span><span id="__span-92-95"><a id="__codelineno-92-95" name="__codelineno-92-95" href="#__codelineno-92-95"></a>
</span><span id="__span-92-96"><a id="__codelineno-92-96" name="__codelineno-92-96" href="#__codelineno-92-96"></a>        <span class="c1"># Pad or truncate</span>
</span><span id="__span-92-97"><a id="__codelineno-92-97" name="__codelineno-92-97" href="#__codelineno-92-97"></a>        <span class="k">if</span> <span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-92-98"><a id="__codelineno-92-98" name="__codelineno-92-98" href="#__codelineno-92-98"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">:</span>
</span><span id="__span-92-99"><a id="__codelineno-92-99" name="__codelineno-92-99" href="#__codelineno-92-99"></a>                <span class="n">indices</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">token_to_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
</span><span id="__span-92-100"><a id="__codelineno-92-100" name="__codelineno-92-100" href="#__codelineno-92-100"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-92-101"><a id="__codelineno-92-101" name="__codelineno-92-101" href="#__codelineno-92-101"></a>                <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>
</span><span id="__span-92-102"><a id="__codelineno-92-102" name="__codelineno-92-102" href="#__codelineno-92-102"></a>
</span><span id="__span-92-103"><a id="__codelineno-92-103" name="__codelineno-92-103" href="#__codelineno-92-103"></a>        <span class="k">return</span> <span class="n">indices</span>
</span><span id="__span-92-104"><a id="__codelineno-92-104" name="__codelineno-92-104" href="#__codelineno-92-104"></a>
</span><span id="__span-92-105"><a id="__codelineno-92-105" name="__codelineno-92-105" href="#__codelineno-92-105"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
</span><span id="__span-92-106"><a id="__codelineno-92-106" name="__codelineno-92-106" href="#__codelineno-92-106"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert token indices back to SMILES&quot;&quot;&quot;</span>
</span><span id="__span-92-107"><a id="__codelineno-92-107" name="__codelineno-92-107" href="#__codelineno-92-107"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
</span><span id="__span-92-108"><a id="__codelineno-92-108" name="__codelineno-92-108" href="#__codelineno-92-108"></a>
</span><span id="__span-92-109"><a id="__codelineno-92-109" name="__codelineno-92-109" href="#__codelineno-92-109"></a>        <span class="c1"># Remove special tokens and padding</span>
</span><span id="__span-92-110"><a id="__codelineno-92-110" name="__codelineno-92-110" href="#__codelineno-92-110"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> 
</span><span id="__span-92-111"><a id="__codelineno-92-111" name="__codelineno-92-111" href="#__codelineno-92-111"></a>                 <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_token</span><span class="p">]]</span>
</span><span id="__span-92-112"><a id="__codelineno-92-112" name="__codelineno-92-112" href="#__codelineno-92-112"></a>
</span><span id="__span-92-113"><a id="__codelineno-92-113" name="__codelineno-92-113" href="#__codelineno-92-113"></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="__span-92-114"><a id="__codelineno-92-114" name="__codelineno-92-114" href="#__codelineno-92-114"></a>
</span><span id="__span-92-115"><a id="__codelineno-92-115" name="__codelineno-92-115" href="#__codelineno-92-115"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batch_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="__span-92-116"><a id="__codelineno-92-116" name="__codelineno-92-116" href="#__codelineno-92-116"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode batch of SMILES&quot;&quot;&quot;</span>
</span><span id="__span-92-117"><a id="__codelineno-92-117" name="__codelineno-92-117" href="#__codelineno-92-117"></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">smiles_list</span><span class="p">]</span>
</span><span id="__span-92-118"><a id="__codelineno-92-118" name="__codelineno-92-118" href="#__codelineno-92-118"></a>
</span><span id="__span-92-119"><a id="__codelineno-92-119" name="__codelineno-92-119" href="#__codelineno-92-119"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-120"><a id="__codelineno-92-120" name="__codelineno-92-120" href="#__codelineno-92-120"></a><span class="c1"># SMILES VALIDATION AND CANONICALIZATION</span>
</span><span id="__span-92-121"><a id="__codelineno-92-121" name="__codelineno-92-121" href="#__codelineno-92-121"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-122"><a id="__codelineno-92-122" name="__codelineno-92-122" href="#__codelineno-92-122"></a>
</span><span id="__span-92-123"><a id="__codelineno-92-123" name="__codelineno-92-123" href="#__codelineno-92-123"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
</span><span id="__span-92-124"><a id="__codelineno-92-124" name="__codelineno-92-124" href="#__codelineno-92-124"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if SMILES is valid&quot;&quot;&quot;</span>
</span><span id="__span-92-125"><a id="__codelineno-92-125" name="__codelineno-92-125" href="#__codelineno-92-125"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-92-126"><a id="__codelineno-92-126" name="__codelineno-92-126" href="#__codelineno-92-126"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-127"><a id="__codelineno-92-127" name="__codelineno-92-127" href="#__codelineno-92-127"></a>        <span class="k">return</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="__span-92-128"><a id="__codelineno-92-128" name="__codelineno-92-128" href="#__codelineno-92-128"></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="__span-92-129"><a id="__codelineno-92-129" name="__codelineno-92-129" href="#__codelineno-92-129"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-92-130"><a id="__codelineno-92-130" name="__codelineno-92-130" href="#__codelineno-92-130"></a>
</span><span id="__span-92-131"><a id="__codelineno-92-131" name="__codelineno-92-131" href="#__codelineno-92-131"></a><span class="k">def</span><span class="w"> </span><span class="nf">canonicalize_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
</span><span id="__span-92-132"><a id="__codelineno-92-132" name="__codelineno-92-132" href="#__codelineno-92-132"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert to canonical SMILES&quot;&quot;&quot;</span>
</span><span id="__span-92-133"><a id="__codelineno-92-133" name="__codelineno-92-133" href="#__codelineno-92-133"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-92-134"><a id="__codelineno-92-134" name="__codelineno-92-134" href="#__codelineno-92-134"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-135"><a id="__codelineno-92-135" name="__codelineno-92-135" href="#__codelineno-92-135"></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-92-136"><a id="__codelineno-92-136" name="__codelineno-92-136" href="#__codelineno-92-136"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-92-137"><a id="__codelineno-92-137" name="__codelineno-92-137" href="#__codelineno-92-137"></a>        <span class="k">return</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">canonical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-92-138"><a id="__codelineno-92-138" name="__codelineno-92-138" href="#__codelineno-92-138"></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="__span-92-139"><a id="__codelineno-92-139" name="__codelineno-92-139" href="#__codelineno-92-139"></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-92-140"><a id="__codelineno-92-140" name="__codelineno-92-140" href="#__codelineno-92-140"></a>
</span><span id="__span-92-141"><a id="__codelineno-92-141" name="__codelineno-92-141" href="#__codelineno-92-141"></a><span class="k">def</span><span class="w"> </span><span class="nf">remove_stereochemistry</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
</span><span id="__span-92-142"><a id="__codelineno-92-142" name="__codelineno-92-142" href="#__codelineno-92-142"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove stereochemistry information&quot;&quot;&quot;</span>
</span><span id="__span-92-143"><a id="__codelineno-92-143" name="__codelineno-92-143" href="#__codelineno-92-143"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-92-144"><a id="__codelineno-92-144" name="__codelineno-92-144" href="#__codelineno-92-144"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-145"><a id="__codelineno-92-145" name="__codelineno-92-145" href="#__codelineno-92-145"></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-92-146"><a id="__codelineno-92-146" name="__codelineno-92-146" href="#__codelineno-92-146"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-92-147"><a id="__codelineno-92-147" name="__codelineno-92-147" href="#__codelineno-92-147"></a>        <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveStereochemistry</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
</span><span id="__span-92-148"><a id="__codelineno-92-148" name="__codelineno-92-148" href="#__codelineno-92-148"></a>        <span class="k">return</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
</span><span id="__span-92-149"><a id="__codelineno-92-149" name="__codelineno-92-149" href="#__codelineno-92-149"></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="__span-92-150"><a id="__codelineno-92-150" name="__codelineno-92-150" href="#__codelineno-92-150"></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-92-151"><a id="__codelineno-92-151" name="__codelineno-92-151" href="#__codelineno-92-151"></a>
</span><span id="__span-92-152"><a id="__codelineno-92-152" name="__codelineno-92-152" href="#__codelineno-92-152"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-153"><a id="__codelineno-92-153" name="__codelineno-92-153" href="#__codelineno-92-153"></a><span class="c1"># SMILES AUGMENTATION</span>
</span><span id="__span-92-154"><a id="__codelineno-92-154" name="__codelineno-92-154" href="#__codelineno-92-154"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-155"><a id="__codelineno-92-155" name="__codelineno-92-155" href="#__codelineno-92-155"></a>
</span><span id="__span-92-156"><a id="__codelineno-92-156" name="__codelineno-92-156" href="#__codelineno-92-156"></a><span class="k">def</span><span class="w"> </span><span class="nf">enumerate_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">n_variants</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-92-157"><a id="__codelineno-92-157" name="__codelineno-92-157" href="#__codelineno-92-157"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate different SMILES representations of same molecule&quot;&quot;&quot;</span>
</span><span id="__span-92-158"><a id="__codelineno-92-158" name="__codelineno-92-158" href="#__codelineno-92-158"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-92-159"><a id="__codelineno-92-159" name="__codelineno-92-159" href="#__codelineno-92-159"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-160"><a id="__codelineno-92-160" name="__codelineno-92-160" href="#__codelineno-92-160"></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-92-161"><a id="__codelineno-92-161" name="__codelineno-92-161" href="#__codelineno-92-161"></a>            <span class="k">return</span> <span class="p">[</span><span class="n">smiles</span><span class="p">]</span>
</span><span id="__span-92-162"><a id="__codelineno-92-162" name="__codelineno-92-162" href="#__codelineno-92-162"></a>
</span><span id="__span-92-163"><a id="__codelineno-92-163" name="__codelineno-92-163" href="#__codelineno-92-163"></a>        <span class="n">variants</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-92-164"><a id="__codelineno-92-164" name="__codelineno-92-164" href="#__codelineno-92-164"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_variants</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># Generate more, then sample</span>
</span><span id="__span-92-165"><a id="__codelineno-92-165" name="__codelineno-92-165" href="#__codelineno-92-165"></a>            <span class="n">variant</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">doRandom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-92-166"><a id="__codelineno-92-166" name="__codelineno-92-166" href="#__codelineno-92-166"></a>            <span class="n">variants</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>
</span><span id="__span-92-167"><a id="__codelineno-92-167" name="__codelineno-92-167" href="#__codelineno-92-167"></a>
</span><span id="__span-92-168"><a id="__codelineno-92-168" name="__codelineno-92-168" href="#__codelineno-92-168"></a>        <span class="n">variants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">variants</span><span class="p">)</span>
</span><span id="__span-92-169"><a id="__codelineno-92-169" name="__codelineno-92-169" href="#__codelineno-92-169"></a>
</span><span id="__span-92-170"><a id="__codelineno-92-170" name="__codelineno-92-170" href="#__codelineno-92-170"></a>        <span class="c1"># Ensure original is included</span>
</span><span id="__span-92-171"><a id="__codelineno-92-171" name="__codelineno-92-171" href="#__codelineno-92-171"></a>        <span class="k">if</span> <span class="n">smiles</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
</span><span id="__span-92-172"><a id="__codelineno-92-172" name="__codelineno-92-172" href="#__codelineno-92-172"></a>            <span class="n">variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-173"><a id="__codelineno-92-173" name="__codelineno-92-173" href="#__codelineno-92-173"></a>
</span><span id="__span-92-174"><a id="__codelineno-92-174" name="__codelineno-92-174" href="#__codelineno-92-174"></a>        <span class="k">return</span> <span class="n">variants</span><span class="p">[:</span><span class="n">n_variants</span><span class="p">]</span>
</span><span id="__span-92-175"><a id="__codelineno-92-175" name="__codelineno-92-175" href="#__codelineno-92-175"></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="__span-92-176"><a id="__codelineno-92-176" name="__codelineno-92-176" href="#__codelineno-92-176"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">smiles</span><span class="p">]</span>
</span><span id="__span-92-177"><a id="__codelineno-92-177" name="__codelineno-92-177" href="#__codelineno-92-177"></a>
</span><span id="__span-92-178"><a id="__codelineno-92-178" name="__codelineno-92-178" href="#__codelineno-92-178"></a><span class="k">def</span><span class="w"> </span><span class="nf">augment_smiles_dataset</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">augmentation_factor</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-92-179"><a id="__codelineno-92-179" name="__codelineno-92-179" href="#__codelineno-92-179"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Augment SMILES dataset with enumeration&quot;&quot;&quot;</span>
</span><span id="__span-92-180"><a id="__codelineno-92-180" name="__codelineno-92-180" href="#__codelineno-92-180"></a>    <span class="n">augmented_smiles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-92-181"><a id="__codelineno-92-181" name="__codelineno-92-181" href="#__codelineno-92-181"></a>    <span class="n">augmented_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-92-182"><a id="__codelineno-92-182" name="__codelineno-92-182" href="#__codelineno-92-182"></a>
</span><span id="__span-92-183"><a id="__codelineno-92-183" name="__codelineno-92-183" href="#__codelineno-92-183"></a>    <span class="k">for</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span><span id="__span-92-184"><a id="__codelineno-92-184" name="__codelineno-92-184" href="#__codelineno-92-184"></a>        <span class="n">variants</span> <span class="o">=</span> <span class="n">enumerate_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">n_variants</span><span class="o">=</span><span class="n">augmentation_factor</span><span class="p">)</span>
</span><span id="__span-92-185"><a id="__codelineno-92-185" name="__codelineno-92-185" href="#__codelineno-92-185"></a>        <span class="n">augmented_smiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">variants</span><span class="p">)</span>
</span><span id="__span-92-186"><a id="__codelineno-92-186" name="__codelineno-92-186" href="#__codelineno-92-186"></a>        <span class="n">augmented_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">label</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">variants</span><span class="p">))</span>
</span><span id="__span-92-187"><a id="__codelineno-92-187" name="__codelineno-92-187" href="#__codelineno-92-187"></a>
</span><span id="__span-92-188"><a id="__codelineno-92-188" name="__codelineno-92-188" href="#__codelineno-92-188"></a>    <span class="k">return</span> <span class="n">augmented_smiles</span><span class="p">,</span> <span class="n">augmented_labels</span>
</span><span id="__span-92-189"><a id="__codelineno-92-189" name="__codelineno-92-189" href="#__codelineno-92-189"></a>
</span><span id="__span-92-190"><a id="__codelineno-92-190" name="__codelineno-92-190" href="#__codelineno-92-190"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-191"><a id="__codelineno-92-191" name="__codelineno-92-191" href="#__codelineno-92-191"></a><span class="c1"># SMILES FILTERING</span>
</span><span id="__span-92-192"><a id="__codelineno-92-192" name="__codelineno-92-192" href="#__codelineno-92-192"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-193"><a id="__codelineno-92-193" name="__codelineno-92-193" href="#__codelineno-92-193"></a>
</span><span id="__span-92-194"><a id="__codelineno-92-194" name="__codelineno-92-194" href="#__codelineno-92-194"></a><span class="k">def</span><span class="w"> </span><span class="nf">filter_smiles_dataset</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> 
</span><span id="__span-92-195"><a id="__codelineno-92-195" name="__codelineno-92-195" href="#__codelineno-92-195"></a>                         <span class="n">remove_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-92-196"><a id="__codelineno-92-196" name="__codelineno-92-196" href="#__codelineno-92-196"></a>                         <span class="n">remove_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-92-197"><a id="__codelineno-92-197" name="__codelineno-92-197" href="#__codelineno-92-197"></a>                         <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-92-198"><a id="__codelineno-92-198" name="__codelineno-92-198" href="#__codelineno-92-198"></a>                         <span class="n">min_atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-92-199"><a id="__codelineno-92-199" name="__codelineno-92-199" href="#__codelineno-92-199"></a>                         <span class="n">max_atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-92-200"><a id="__codelineno-92-200" name="__codelineno-92-200" href="#__codelineno-92-200"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter SMILES dataset based on criteria&quot;&quot;&quot;</span>
</span><span id="__span-92-201"><a id="__codelineno-92-201" name="__codelineno-92-201" href="#__codelineno-92-201"></a>    <span class="n">filtered_smiles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-92-202"><a id="__codelineno-92-202" name="__codelineno-92-202" href="#__codelineno-92-202"></a>    <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-92-203"><a id="__codelineno-92-203" name="__codelineno-92-203" href="#__codelineno-92-203"></a>    <span class="n">seen_canonical</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-92-204"><a id="__codelineno-92-204" name="__codelineno-92-204" href="#__codelineno-92-204"></a>
</span><span id="__span-92-205"><a id="__codelineno-92-205" name="__codelineno-92-205" href="#__codelineno-92-205"></a>    <span class="k">for</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span><span id="__span-92-206"><a id="__codelineno-92-206" name="__codelineno-92-206" href="#__codelineno-92-206"></a>        <span class="c1"># Check validity</span>
</span><span id="__span-92-207"><a id="__codelineno-92-207" name="__codelineno-92-207" href="#__codelineno-92-207"></a>        <span class="k">if</span> <span class="n">remove_invalid</span><span class="p">:</span>
</span><span id="__span-92-208"><a id="__codelineno-92-208" name="__codelineno-92-208" href="#__codelineno-92-208"></a>            <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-209"><a id="__codelineno-92-209" name="__codelineno-92-209" href="#__codelineno-92-209"></a>            <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-92-210"><a id="__codelineno-92-210" name="__codelineno-92-210" href="#__codelineno-92-210"></a>                <span class="k">continue</span>
</span><span id="__span-92-211"><a id="__codelineno-92-211" name="__codelineno-92-211" href="#__codelineno-92-211"></a>
</span><span id="__span-92-212"><a id="__codelineno-92-212" name="__codelineno-92-212" href="#__codelineno-92-212"></a>        <span class="c1"># Check duplicates</span>
</span><span id="__span-92-213"><a id="__codelineno-92-213" name="__codelineno-92-213" href="#__codelineno-92-213"></a>        <span class="k">if</span> <span class="n">remove_duplicates</span><span class="p">:</span>
</span><span id="__span-92-214"><a id="__codelineno-92-214" name="__codelineno-92-214" href="#__codelineno-92-214"></a>            <span class="n">canonical</span> <span class="o">=</span> <span class="n">canonicalize_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-215"><a id="__codelineno-92-215" name="__codelineno-92-215" href="#__codelineno-92-215"></a>            <span class="k">if</span> <span class="n">canonical</span> <span class="ow">in</span> <span class="n">seen_canonical</span><span class="p">:</span>
</span><span id="__span-92-216"><a id="__codelineno-92-216" name="__codelineno-92-216" href="#__codelineno-92-216"></a>                <span class="k">continue</span>
</span><span id="__span-92-217"><a id="__codelineno-92-217" name="__codelineno-92-217" href="#__codelineno-92-217"></a>            <span class="n">seen_canonical</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">canonical</span><span class="p">)</span>
</span><span id="__span-92-218"><a id="__codelineno-92-218" name="__codelineno-92-218" href="#__codelineno-92-218"></a>
</span><span id="__span-92-219"><a id="__codelineno-92-219" name="__codelineno-92-219" href="#__codelineno-92-219"></a>        <span class="c1"># Check length</span>
</span><span id="__span-92-220"><a id="__codelineno-92-220" name="__codelineno-92-220" href="#__codelineno-92-220"></a>        <span class="k">if</span> <span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
</span><span id="__span-92-221"><a id="__codelineno-92-221" name="__codelineno-92-221" href="#__codelineno-92-221"></a>            <span class="k">continue</span>
</span><span id="__span-92-222"><a id="__codelineno-92-222" name="__codelineno-92-222" href="#__codelineno-92-222"></a>
</span><span id="__span-92-223"><a id="__codelineno-92-223" name="__codelineno-92-223" href="#__codelineno-92-223"></a>        <span class="c1"># Check atom count</span>
</span><span id="__span-92-224"><a id="__codelineno-92-224" name="__codelineno-92-224" href="#__codelineno-92-224"></a>        <span class="k">if</span> <span class="n">min_atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-92-225"><a id="__codelineno-92-225" name="__codelineno-92-225" href="#__codelineno-92-225"></a>            <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-226"><a id="__codelineno-92-226" name="__codelineno-92-226" href="#__codelineno-92-226"></a>            <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetNumHeavyAtoms</span><span class="p">()</span>
</span><span id="__span-92-227"><a id="__codelineno-92-227" name="__codelineno-92-227" href="#__codelineno-92-227"></a>
</span><span id="__span-92-228"><a id="__codelineno-92-228" name="__codelineno-92-228" href="#__codelineno-92-228"></a>            <span class="k">if</span> <span class="n">min_atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_atoms</span> <span class="o">&lt;</span> <span class="n">min_atoms</span><span class="p">:</span>
</span><span id="__span-92-229"><a id="__codelineno-92-229" name="__codelineno-92-229" href="#__codelineno-92-229"></a>                <span class="k">continue</span>
</span><span id="__span-92-230"><a id="__codelineno-92-230" name="__codelineno-92-230" href="#__codelineno-92-230"></a>            <span class="k">if</span> <span class="n">max_atoms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_atoms</span> <span class="o">&gt;</span> <span class="n">max_atoms</span><span class="p">:</span>
</span><span id="__span-92-231"><a id="__codelineno-92-231" name="__codelineno-92-231" href="#__codelineno-92-231"></a>                <span class="k">continue</span>
</span><span id="__span-92-232"><a id="__codelineno-92-232" name="__codelineno-92-232" href="#__codelineno-92-232"></a>
</span><span id="__span-92-233"><a id="__codelineno-92-233" name="__codelineno-92-233" href="#__codelineno-92-233"></a>        <span class="n">filtered_smiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-234"><a id="__codelineno-92-234" name="__codelineno-92-234" href="#__codelineno-92-234"></a>        <span class="n">filtered_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="__span-92-235"><a id="__codelineno-92-235" name="__codelineno-92-235" href="#__codelineno-92-235"></a>
</span><span id="__span-92-236"><a id="__codelineno-92-236" name="__codelineno-92-236" href="#__codelineno-92-236"></a>    <span class="k">return</span> <span class="n">filtered_smiles</span><span class="p">,</span> <span class="n">filtered_labels</span>
</span><span id="__span-92-237"><a id="__codelineno-92-237" name="__codelineno-92-237" href="#__codelineno-92-237"></a>
</span><span id="__span-92-238"><a id="__codelineno-92-238" name="__codelineno-92-238" href="#__codelineno-92-238"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-239"><a id="__codelineno-92-239" name="__codelineno-92-239" href="#__codelineno-92-239"></a><span class="c1"># SMILES STATISTICS</span>
</span><span id="__span-92-240"><a id="__codelineno-92-240" name="__codelineno-92-240" href="#__codelineno-92-240"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-241"><a id="__codelineno-92-241" name="__codelineno-92-241" href="#__codelineno-92-241"></a>
</span><span id="__span-92-242"><a id="__codelineno-92-242" name="__codelineno-92-242" href="#__codelineno-92-242"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_smiles_statistics</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">):</span>
</span><span id="__span-92-243"><a id="__codelineno-92-243" name="__codelineno-92-243" href="#__codelineno-92-243"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute statistics about SMILES dataset&quot;&quot;&quot;</span>
</span><span id="__span-92-244"><a id="__codelineno-92-244" name="__codelineno-92-244" href="#__codelineno-92-244"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-92-245"><a id="__codelineno-92-245" name="__codelineno-92-245" href="#__codelineno-92-245"></a>        <span class="s1">&#39;total_molecules&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">),</span>
</span><span id="__span-92-246"><a id="__codelineno-92-246" name="__codelineno-92-246" href="#__codelineno-92-246"></a>        <span class="s1">&#39;valid_molecules&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-92-247"><a id="__codelineno-92-247" name="__codelineno-92-247" href="#__codelineno-92-247"></a>        <span class="s1">&#39;length_stats&#39;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-92-248"><a id="__codelineno-92-248" name="__codelineno-92-248" href="#__codelineno-92-248"></a>        <span class="s1">&#39;atom_stats&#39;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-92-249"><a id="__codelineno-92-249" name="__codelineno-92-249" href="#__codelineno-92-249"></a>        <span class="s1">&#39;ring_stats&#39;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="__span-92-250"><a id="__codelineno-92-250" name="__codelineno-92-250" href="#__codelineno-92-250"></a>    <span class="p">}</span>
</span><span id="__span-92-251"><a id="__codelineno-92-251" name="__codelineno-92-251" href="#__codelineno-92-251"></a>
</span><span id="__span-92-252"><a id="__codelineno-92-252" name="__codelineno-92-252" href="#__codelineno-92-252"></a>    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-92-253"><a id="__codelineno-92-253" name="__codelineno-92-253" href="#__codelineno-92-253"></a>    <span class="n">atom_counts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-92-254"><a id="__codelineno-92-254" name="__codelineno-92-254" href="#__codelineno-92-254"></a>    <span class="n">ring_counts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-92-255"><a id="__codelineno-92-255" name="__codelineno-92-255" href="#__codelineno-92-255"></a>
</span><span id="__span-92-256"><a id="__codelineno-92-256" name="__codelineno-92-256" href="#__codelineno-92-256"></a>    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">smiles_list</span><span class="p">:</span>
</span><span id="__span-92-257"><a id="__codelineno-92-257" name="__codelineno-92-257" href="#__codelineno-92-257"></a>        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-258"><a id="__codelineno-92-258" name="__codelineno-92-258" href="#__codelineno-92-258"></a>        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-92-259"><a id="__codelineno-92-259" name="__codelineno-92-259" href="#__codelineno-92-259"></a>            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid_molecules&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-92-260"><a id="__codelineno-92-260" name="__codelineno-92-260" href="#__codelineno-92-260"></a>            <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">))</span>
</span><span id="__span-92-261"><a id="__codelineno-92-261" name="__codelineno-92-261" href="#__codelineno-92-261"></a>            <span class="n">atom_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumHeavyAtoms</span><span class="p">())</span>
</span><span id="__span-92-262"><a id="__codelineno-92-262" name="__codelineno-92-262" href="#__codelineno-92-262"></a>            <span class="n">ring_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">GetSSSR</span><span class="p">(</span><span class="n">mol</span><span class="p">))</span>
</span><span id="__span-92-263"><a id="__codelineno-92-263" name="__codelineno-92-263" href="#__codelineno-92-263"></a>
</span><span id="__span-92-264"><a id="__codelineno-92-264" name="__codelineno-92-264" href="#__codelineno-92-264"></a>    <span class="c1"># Length statistics</span>
</span><span id="__span-92-265"><a id="__codelineno-92-265" name="__codelineno-92-265" href="#__codelineno-92-265"></a>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;length_stats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-92-266"><a id="__codelineno-92-266" name="__codelineno-92-266" href="#__codelineno-92-266"></a>        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lengths</span><span class="p">),</span>
</span><span id="__span-92-267"><a id="__codelineno-92-267" name="__codelineno-92-267" href="#__codelineno-92-267"></a>        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lengths</span><span class="p">),</span>
</span><span id="__span-92-268"><a id="__codelineno-92-268" name="__codelineno-92-268" href="#__codelineno-92-268"></a>        <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lengths</span><span class="p">),</span>
</span><span id="__span-92-269"><a id="__codelineno-92-269" name="__codelineno-92-269" href="#__codelineno-92-269"></a>        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lengths</span><span class="p">),</span>
</span><span id="__span-92-270"><a id="__codelineno-92-270" name="__codelineno-92-270" href="#__codelineno-92-270"></a>        <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
</span><span id="__span-92-271"><a id="__codelineno-92-271" name="__codelineno-92-271" href="#__codelineno-92-271"></a>    <span class="p">}</span>
</span><span id="__span-92-272"><a id="__codelineno-92-272" name="__codelineno-92-272" href="#__codelineno-92-272"></a>
</span><span id="__span-92-273"><a id="__codelineno-92-273" name="__codelineno-92-273" href="#__codelineno-92-273"></a>    <span class="c1"># Atom statistics</span>
</span><span id="__span-92-274"><a id="__codelineno-92-274" name="__codelineno-92-274" href="#__codelineno-92-274"></a>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;atom_stats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-92-275"><a id="__codelineno-92-275" name="__codelineno-92-275" href="#__codelineno-92-275"></a>        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">atom_counts</span><span class="p">),</span>
</span><span id="__span-92-276"><a id="__codelineno-92-276" name="__codelineno-92-276" href="#__codelineno-92-276"></a>        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">atom_counts</span><span class="p">),</span>
</span><span id="__span-92-277"><a id="__codelineno-92-277" name="__codelineno-92-277" href="#__codelineno-92-277"></a>        <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">atom_counts</span><span class="p">),</span>
</span><span id="__span-92-278"><a id="__codelineno-92-278" name="__codelineno-92-278" href="#__codelineno-92-278"></a>        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">atom_counts</span><span class="p">),</span>
</span><span id="__span-92-279"><a id="__codelineno-92-279" name="__codelineno-92-279" href="#__codelineno-92-279"></a>        <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">atom_counts</span><span class="p">)</span>
</span><span id="__span-92-280"><a id="__codelineno-92-280" name="__codelineno-92-280" href="#__codelineno-92-280"></a>    <span class="p">}</span>
</span><span id="__span-92-281"><a id="__codelineno-92-281" name="__codelineno-92-281" href="#__codelineno-92-281"></a>
</span><span id="__span-92-282"><a id="__codelineno-92-282" name="__codelineno-92-282" href="#__codelineno-92-282"></a>    <span class="c1"># Ring statistics</span>
</span><span id="__span-92-283"><a id="__codelineno-92-283" name="__codelineno-92-283" href="#__codelineno-92-283"></a>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;ring_stats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-92-284"><a id="__codelineno-92-284" name="__codelineno-92-284" href="#__codelineno-92-284"></a>        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ring_counts</span><span class="p">),</span>
</span><span id="__span-92-285"><a id="__codelineno-92-285" name="__codelineno-92-285" href="#__codelineno-92-285"></a>        <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ring_counts</span><span class="p">),</span>
</span><span id="__span-92-286"><a id="__codelineno-92-286" name="__codelineno-92-286" href="#__codelineno-92-286"></a>        <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ring_counts</span><span class="p">),</span>
</span><span id="__span-92-287"><a id="__codelineno-92-287" name="__codelineno-92-287" href="#__codelineno-92-287"></a>        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ring_counts</span><span class="p">)</span>
</span><span id="__span-92-288"><a id="__codelineno-92-288" name="__codelineno-92-288" href="#__codelineno-92-288"></a>    <span class="p">}</span>
</span><span id="__span-92-289"><a id="__codelineno-92-289" name="__codelineno-92-289" href="#__codelineno-92-289"></a>
</span><span id="__span-92-290"><a id="__codelineno-92-290" name="__codelineno-92-290" href="#__codelineno-92-290"></a>    <span class="k">return</span> <span class="n">stats</span>
</span><span id="__span-92-291"><a id="__codelineno-92-291" name="__codelineno-92-291" href="#__codelineno-92-291"></a>
</span><span id="__span-92-292"><a id="__codelineno-92-292" name="__codelineno-92-292" href="#__codelineno-92-292"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-293"><a id="__codelineno-92-293" name="__codelineno-92-293" href="#__codelineno-92-293"></a><span class="c1"># EXAMPLE USAGE</span>
</span><span id="__span-92-294"><a id="__codelineno-92-294" name="__codelineno-92-294" href="#__codelineno-92-294"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-92-295"><a id="__codelineno-92-295" name="__codelineno-92-295" href="#__codelineno-92-295"></a>
</span><span id="__span-92-296"><a id="__codelineno-92-296" name="__codelineno-92-296" href="#__codelineno-92-296"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-92-297"><a id="__codelineno-92-297" name="__codelineno-92-297" href="#__codelineno-92-297"></a>    <span class="c1"># Example SMILES</span>
</span><span id="__span-92-298"><a id="__codelineno-92-298" name="__codelineno-92-298" href="#__codelineno-92-298"></a>    <span class="n">smiles_examples</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-92-299"><a id="__codelineno-92-299" name="__codelineno-92-299" href="#__codelineno-92-299"></a>        <span class="s2">&quot;CCO&quot;</span><span class="p">,</span>  <span class="c1"># Ethanol</span>
</span><span id="__span-92-300"><a id="__codelineno-92-300" name="__codelineno-92-300" href="#__codelineno-92-300"></a>        <span class="s2">&quot;CC(=O)OC1=CC=CC=C1C(=O)O&quot;</span><span class="p">,</span>  <span class="c1"># Aspirin</span>
</span><span id="__span-92-301"><a id="__codelineno-92-301" name="__codelineno-92-301" href="#__codelineno-92-301"></a>        <span class="s2">&quot;CN1C=NC2=C1C(=O)N(C(=O)N2C)C&quot;</span><span class="p">,</span>  <span class="c1"># Caffeine</span>
</span><span id="__span-92-302"><a id="__codelineno-92-302" name="__codelineno-92-302" href="#__codelineno-92-302"></a>    <span class="p">]</span>
</span><span id="__span-92-303"><a id="__codelineno-92-303" name="__codelineno-92-303" href="#__codelineno-92-303"></a>
</span><span id="__span-92-304"><a id="__codelineno-92-304" name="__codelineno-92-304" href="#__codelineno-92-304"></a>    <span class="c1"># Initialize tokenizer</span>
</span><span id="__span-92-305"><a id="__codelineno-92-305" name="__codelineno-92-305" href="#__codelineno-92-305"></a>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SMILESTokenizer</span><span class="p">()</span>
</span><span id="__span-92-306"><a id="__codelineno-92-306" name="__codelineno-92-306" href="#__codelineno-92-306"></a>
</span><span id="__span-92-307"><a id="__codelineno-92-307" name="__codelineno-92-307" href="#__codelineno-92-307"></a>    <span class="c1"># Tokenize</span>
</span><span id="__span-92-308"><a id="__codelineno-92-308" name="__codelineno-92-308" href="#__codelineno-92-308"></a>    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">smiles_examples</span><span class="p">:</span>
</span><span id="__span-92-309"><a id="__codelineno-92-309" name="__codelineno-92-309" href="#__codelineno-92-309"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
</span><span id="__span-92-310"><a id="__codelineno-92-310" name="__codelineno-92-310" href="#__codelineno-92-310"></a>        <span class="n">encoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span id="__span-92-311"><a id="__codelineno-92-311" name="__codelineno-92-311" href="#__codelineno-92-311"></a>        <span class="n">decoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
</span><span id="__span-92-312"><a id="__codelineno-92-312" name="__codelineno-92-312" href="#__codelineno-92-312"></a>
</span><span id="__span-92-313"><a id="__codelineno-92-313" name="__codelineno-92-313" href="#__codelineno-92-313"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SMILES: </span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-92-314"><a id="__codelineno-92-314" name="__codelineno-92-314" href="#__codelineno-92-314"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tokens: </span><span class="si">{</span><span class="n">tokens</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-92-315"><a id="__codelineno-92-315" name="__codelineno-92-315" href="#__codelineno-92-315"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoded: </span><span class="si">{</span><span class="n">encoded</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-92-316"><a id="__codelineno-92-316" name="__codelineno-92-316" href="#__codelineno-92-316"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decoded: </span><span class="si">{</span><span class="n">decoded</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-92-317"><a id="__codelineno-92-317" name="__codelineno-92-317" href="#__codelineno-92-317"></a>
</span><span id="__span-92-318"><a id="__codelineno-92-318" name="__codelineno-92-318" href="#__codelineno-92-318"></a>    <span class="c1"># Augmentation</span>
</span><span id="__span-92-319"><a id="__codelineno-92-319" name="__codelineno-92-319" href="#__codelineno-92-319"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">SMILES Enumeration:&quot;</span><span class="p">)</span>
</span><span id="__span-92-320"><a id="__codelineno-92-320" name="__codelineno-92-320" href="#__codelineno-92-320"></a>    <span class="n">variants</span> <span class="o">=</span> <span class="n">enumerate_smiles</span><span class="p">(</span><span class="n">smiles_examples</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_variants</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-92-321"><a id="__codelineno-92-321" name="__codelineno-92-321" href="#__codelineno-92-321"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variant</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variants</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="__span-92-322"><a id="__codelineno-92-322" name="__codelineno-92-322" href="#__codelineno-92-322"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">variant</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-92-323"><a id="__codelineno-92-323" name="__codelineno-92-323" href="#__codelineno-92-323"></a>
</span><span id="__span-92-324"><a id="__codelineno-92-324" name="__codelineno-92-324" href="#__codelineno-92-324"></a>    <span class="c1"># Statistics</span>
</span><span id="__span-92-325"><a id="__codelineno-92-325" name="__codelineno-92-325" href="#__codelineno-92-325"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Dataset Statistics:&quot;</span><span class="p">)</span>
</span><span id="__span-92-326"><a id="__codelineno-92-326" name="__codelineno-92-326" href="#__codelineno-92-326"></a>    <span class="n">stats</span> <span class="o">=</span> <span class="n">compute_smiles_statistics</span><span class="p">(</span><span class="n">smiles_examples</span><span class="p">)</span>
</span><span id="__span-92-327"><a id="__codelineno-92-327" name="__codelineno-92-327" href="#__codelineno-92-327"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total molecules: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_molecules&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-92-328"><a id="__codelineno-92-328" name="__codelineno-92-328" href="#__codelineno-92-328"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid molecules: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;valid_molecules&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-92-329"><a id="__codelineno-92-329" name="__codelineno-92-329" href="#__codelineno-92-329"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average length: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;length_stats&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-92-330"><a id="__codelineno-92-330" name="__codelineno-92-330" href="#__codelineno-92-330"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average atoms: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;atom_stats&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="appendix__c__model__evaluation__suite">Appendix C: Model Evaluation Suite<a class="headerlink" href="#appendix__c__model__evaluation__suite" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="sd">Comprehensive Model Evaluation Suite</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="sd">Tools for thorough model performance analysis</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a>
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-93-7"><a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-93-8"><a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
</span><span id="__span-93-9"><a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-93-10"><a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a>    <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span>
</span><span id="__span-93-11"><a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a>    <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">precision_recall_curve</span><span class="p">,</span>
</span><span id="__span-93-12"><a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a>    <span class="n">roc_curve</span><span class="p">,</span> <span class="n">classification_report</span>
</span><span id="__span-93-13"><a id="__codelineno-93-13" name="__codelineno-93-13" href="#__codelineno-93-13"></a><span class="p">)</span>
</span><span id="__span-93-14"><a id="__codelineno-93-14" name="__codelineno-93-14" href="#__codelineno-93-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
</span><span id="__span-93-15"><a id="__codelineno-93-15" name="__codelineno-93-15" href="#__codelineno-93-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-93-16"><a id="__codelineno-93-16" name="__codelineno-93-16" href="#__codelineno-93-16"></a>
</span><span id="__span-93-17"><a id="__codelineno-93-17" name="__codelineno-93-17" href="#__codelineno-93-17"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-93-18"><a id="__codelineno-93-18" name="__codelineno-93-18" href="#__codelineno-93-18"></a><span class="c1"># REGRESSION METRICS</span>
</span><span id="__span-93-19"><a id="__codelineno-93-19" name="__codelineno-93-19" href="#__codelineno-93-19"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-93-20"><a id="__codelineno-93-20" name="__codelineno-93-20" href="#__codelineno-93-20"></a>
</span><span id="__span-93-21"><a id="__codelineno-93-21" name="__codelineno-93-21" href="#__codelineno-93-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">RegressionEvaluator</span><span class="p">:</span>
</span><span id="__span-93-22"><a id="__codelineno-93-22" name="__codelineno-93-22" href="#__codelineno-93-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Comprehensive regression model evaluation&quot;&quot;&quot;</span>
</span><span id="__span-93-23"><a id="__codelineno-93-23" name="__codelineno-93-23" href="#__codelineno-93-23"></a>
</span><span id="__span-93-24"><a id="__codelineno-93-24" name="__codelineno-93-24" href="#__codelineno-93-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</span><span id="__span-93-25"><a id="__codelineno-93-25" name="__codelineno-93-25" href="#__codelineno-93-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-93-26"><a id="__codelineno-93-26" name="__codelineno-93-26" href="#__codelineno-93-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="__span-93-27"><a id="__codelineno-93-27" name="__codelineno-93-27" href="#__codelineno-93-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span>
</span><span id="__span-93-28"><a id="__codelineno-93-28" name="__codelineno-93-28" href="#__codelineno-93-28"></a>
</span><span id="__span-93-29"><a id="__codelineno-93-29" name="__codelineno-93-29" href="#__codelineno-93-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-93-30"><a id="__codelineno-93-30" name="__codelineno-93-30" href="#__codelineno-93-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute all regression metrics&quot;&quot;&quot;</span>
</span><span id="__span-93-31"><a id="__codelineno-93-31" name="__codelineno-93-31" href="#__codelineno-93-31"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-93-32"><a id="__codelineno-93-32" name="__codelineno-93-32" href="#__codelineno-93-32"></a>
</span><span id="__span-93-33"><a id="__codelineno-93-33" name="__codelineno-93-33" href="#__codelineno-93-33"></a>        <span class="c1"># Basic metrics</span>
</span><span id="__span-93-34"><a id="__codelineno-93-34" name="__codelineno-93-34" href="#__codelineno-93-34"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;MSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="__span-93-35"><a id="__codelineno-93-35" name="__codelineno-93-35" href="#__codelineno-93-35"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;MSE&#39;</span><span class="p">])</span>
</span><span id="__span-93-36"><a id="__codelineno-93-36" name="__codelineno-93-36" href="#__codelineno-93-36"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="__span-93-37"><a id="__codelineno-93-37" name="__codelineno-93-37" href="#__codelineno-93-37"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="__span-93-38"><a id="__codelineno-93-38" name="__codelineno-93-38" href="#__codelineno-93-38"></a>
</span><span id="__span-93-39"><a id="__codelineno-93-39" name="__codelineno-93-39" href="#__codelineno-93-39"></a>        <span class="c1"># Additional metrics</span>
</span><span id="__span-93-40"><a id="__codelineno-93-40" name="__codelineno-93-40" href="#__codelineno-93-40"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Max_Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">))</span>
</span><span id="__span-93-41"><a id="__codelineno-93-41" name="__codelineno-93-41" href="#__codelineno-93-41"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Mean_Residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">)</span>
</span><span id="__span-93-42"><a id="__codelineno-93-42" name="__codelineno-93-42" href="#__codelineno-93-42"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Std_Residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">)</span>
</span><span id="__span-93-43"><a id="__codelineno-93-43" name="__codelineno-93-43" href="#__codelineno-93-43"></a>
</span><span id="__span-93-44"><a id="__codelineno-93-44" name="__codelineno-93-44" href="#__codelineno-93-44"></a>        <span class="c1"># Relative metrics</span>
</span><span id="__span-93-45"><a id="__codelineno-93-45" name="__codelineno-93-45" href="#__codelineno-93-45"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;MAPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="__span-93-46"><a id="__codelineno-93-46" name="__codelineno-93-46" href="#__codelineno-93-46"></a>
</span><span id="__span-93-47"><a id="__codelineno-93-47" name="__codelineno-93-47" href="#__codelineno-93-47"></a>        <span class="c1"># Correlation</span>
</span><span id="__span-93-48"><a id="__codelineno-93-48" name="__codelineno-93-48" href="#__codelineno-93-48"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Pearson_r&#39;</span><span class="p">],</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Pearson_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span>
</span><span id="__span-93-49"><a id="__codelineno-93-49" name="__codelineno-93-49" href="#__codelineno-93-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span>
</span><span id="__span-93-50"><a id="__codelineno-93-50" name="__codelineno-93-50" href="#__codelineno-93-50"></a>        <span class="p">)</span>
</span><span id="__span-93-51"><a id="__codelineno-93-51" name="__codelineno-93-51" href="#__codelineno-93-51"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Spearman_r&#39;</span><span class="p">],</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Spearman_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span>
</span><span id="__span-93-52"><a id="__codelineno-93-52" name="__codelineno-93-52" href="#__codelineno-93-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span>
</span><span id="__span-93-53"><a id="__codelineno-93-53" name="__codelineno-93-53" href="#__codelineno-93-53"></a>        <span class="p">)</span>
</span><span id="__span-93-54"><a id="__codelineno-93-54" name="__codelineno-93-54" href="#__codelineno-93-54"></a>
</span><span id="__span-93-55"><a id="__codelineno-93-55" name="__codelineno-93-55" href="#__codelineno-93-55"></a>        <span class="k">return</span> <span class="n">metrics</span>
</span><span id="__span-93-56"><a id="__codelineno-93-56" name="__codelineno-93-56" href="#__codelineno-93-56"></a>
</span><span id="__span-93-57"><a id="__codelineno-93-57" name="__codelineno-93-57" href="#__codelineno-93-57"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;regression_evaluation.png&#39;</span><span class="p">):</span>
</span><span id="__span-93-58"><a id="__codelineno-93-58" name="__codelineno-93-58" href="#__codelineno-93-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create comprehensive visualization&quot;&quot;&quot;</span>
</span><span id="__span-93-59"><a id="__codelineno-93-59" name="__codelineno-93-59" href="#__codelineno-93-59"></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="__span-93-60"><a id="__codelineno-93-60" name="__codelineno-93-60" href="#__codelineno-93-60"></a>
</span><span id="__span-93-61"><a id="__codelineno-93-61" name="__codelineno-93-61" href="#__codelineno-93-61"></a>        <span class="c1"># 1. Predictions vs True</span>
</span><span id="__span-93-62"><a id="__codelineno-93-62" name="__codelineno-93-62" href="#__codelineno-93-62"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-93-63"><a id="__codelineno-93-63" name="__codelineno-93-63" href="#__codelineno-93-63"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
</span><span id="__span-93-64"><a id="__codelineno-93-64" name="__codelineno-93-64" href="#__codelineno-93-64"></a>                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
</span><span id="__span-93-65"><a id="__codelineno-93-65" name="__codelineno-93-65" href="#__codelineno-93-65"></a>                        <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-93-66"><a id="__codelineno-93-66" name="__codelineno-93-66" href="#__codelineno-93-66"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
</span><span id="__span-93-67"><a id="__codelineno-93-67" name="__codelineno-93-67" href="#__codelineno-93-67"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted Values&#39;</span><span class="p">)</span>
</span><span id="__span-93-68"><a id="__codelineno-93-68" name="__codelineno-93-68" href="#__codelineno-93-68"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predictions vs True Values&#39;</span><span class="p">)</span>
</span><span id="__span-93-69"><a id="__codelineno-93-69" name="__codelineno-93-69" href="#__codelineno-93-69"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-93-70"><a id="__codelineno-93-70" name="__codelineno-93-70" href="#__codelineno-93-70"></a>
</span><span id="__span-93-71"><a id="__codelineno-93-71" name="__codelineno-93-71" href="#__codelineno-93-71"></a>        <span class="c1"># Add R² to plot</span>
</span><span id="__span-93-72"><a id="__codelineno-93-72" name="__codelineno-93-72" href="#__codelineno-93-72"></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="__span-93-73"><a id="__codelineno-93-73" name="__codelineno-93-73" href="#__codelineno-93-73"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;R² = </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="__span-93-74"><a id="__codelineno-93-74" name="__codelineno-93-74" href="#__codelineno-93-74"></a>                        <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
</span><span id="__span-93-75"><a id="__codelineno-93-75" name="__codelineno-93-75" href="#__codelineno-93-75"></a>                        <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
</span><span id="__span-93-76"><a id="__codelineno-93-76" name="__codelineno-93-76" href="#__codelineno-93-76"></a>                        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
</span><span id="__span-93-77"><a id="__codelineno-93-77" name="__codelineno-93-77" href="#__codelineno-93-77"></a>
</span><span id="__span-93-78"><a id="__codelineno-93-78" name="__codelineno-93-78" href="#__codelineno-93-78"></a>        <span class="c1"># 2. Residuals vs Predicted</span>
</span><span id="__span-93-79"><a id="__codelineno-93-79" name="__codelineno-93-79" href="#__codelineno-93-79"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-93-80"><a id="__codelineno-93-80" name="__codelineno-93-80" href="#__codelineno-93-80"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
</span><span id="__span-93-81"><a id="__codelineno-93-81" name="__codelineno-93-81" href="#__codelineno-93-81"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted Values&#39;</span><span class="p">)</span>
</span><span id="__span-93-82"><a id="__codelineno-93-82" name="__codelineno-93-82" href="#__codelineno-93-82"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
</span><span id="__span-93-83"><a id="__codelineno-93-83" name="__codelineno-93-83" href="#__codelineno-93-83"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual Plot&#39;</span><span class="p">)</span>
</span><span id="__span-93-84"><a id="__codelineno-93-84" name="__codelineno-93-84" href="#__codelineno-93-84"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-93-85"><a id="__codelineno-93-85" name="__codelineno-93-85" href="#__codelineno-93-85"></a>
</span><span id="__span-93-86"><a id="__codelineno-93-86" name="__codelineno-93-86" href="#__codelineno-93-86"></a>        <span class="c1"># 3. Residuals Distribution</span>
</span><span id="__span-93-87"><a id="__codelineno-93-87" name="__codelineno-93-87" href="#__codelineno-93-87"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="__span-93-88"><a id="__codelineno-93-88" name="__codelineno-93-88" href="#__codelineno-93-88"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
</span><span id="__span-93-89"><a id="__codelineno-93-89" name="__codelineno-93-89" href="#__codelineno-93-89"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
</span><span id="__span-93-90"><a id="__codelineno-93-90" name="__codelineno-93-90" href="#__codelineno-93-90"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual Distribution&#39;</span><span class="p">)</span>
</span><span id="__span-93-91"><a id="__codelineno-93-91" name="__codelineno-93-91" href="#__codelineno-93-91"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
</span><span id="__span-93-92"><a id="__codelineno-93-92" name="__codelineno-93-92" href="#__codelineno-93-92"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-93-93"><a id="__codelineno-93-93" name="__codelineno-93-93" href="#__codelineno-93-93"></a>
</span><span id="__span-93-94"><a id="__codelineno-93-94" name="__codelineno-93-94" href="#__codelineno-93-94"></a>        <span class="c1"># 4. Q-Q Plot</span>
</span><span id="__span-93-95"><a id="__codelineno-93-95" name="__codelineno-93-95" href="#__codelineno-93-95"></a>        <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="__span-93-96"><a id="__codelineno-93-96" name="__codelineno-93-96" href="#__codelineno-93-96"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot&#39;</span><span class="p">)</span>
</span><span id="__span-93-97"><a id="__codelineno-93-97" name="__codelineno-93-97" href="#__codelineno-93-97"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-93-98"><a id="__codelineno-93-98" name="__codelineno-93-98" href="#__codelineno-93-98"></a>
</span><span id="__span-93-99"><a id="__codelineno-93-99" name="__codelineno-93-99" href="#__codelineno-93-99"></a>        <span class="c1"># 5. Absolute Error vs True</span>
</span><span id="__span-93-100"><a id="__codelineno-93-100" name="__codelineno-93-100" href="#__codelineno-93-100"></a>        <span class="n">abs_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">)</span>
</span><span id="__span-93-101"><a id="__codelineno-93-101" name="__codelineno-93-101" href="#__codelineno-93-101"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">abs_errors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-93-102"><a id="__codelineno-93-102" name="__codelineno-93-102" href="#__codelineno-93-102"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
</span><span id="__span-93-103"><a id="__codelineno-93-103" name="__codelineno-93-103" href="#__codelineno-93-103"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Absolute Error&#39;</span><span class="p">)</span>
</span><span id="__span-93-104"><a id="__codelineno-93-104" name="__codelineno-93-104" href="#__codelineno-93-104"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Absolute Error vs True Values&#39;</span><span class="p">)</span>
</span><span id="__span-93-105"><a id="__codelineno-93-105" name="__codelineno-93-105" href="#__codelineno-93-105"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-93-106"><a id="__codelineno-93-106" name="__codelineno-93-106" href="#__codelineno-93-106"></a>
</span><span id="__span-93-107"><a id="__codelineno-93-107" name="__codelineno-93-107" href="#__codelineno-93-107"></a>        <span class="c1"># 6. Error Distribution by Range</span>
</span><span id="__span-93-108"><a id="__codelineno-93-108" name="__codelineno-93-108" href="#__codelineno-93-108"></a>        <span class="c1"># Bin true values and compute error statistics</span>
</span><span id="__span-93-109"><a id="__codelineno-93-109" name="__codelineno-93-109" href="#__codelineno-93-109"></a>        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="__span-93-110"><a id="__codelineno-93-110" name="__codelineno-93-110" href="#__codelineno-93-110"></a>        <span class="n">bin_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
</span><span id="__span-93-111"><a id="__codelineno-93-111" name="__codelineno-93-111" href="#__codelineno-93-111"></a>
</span><span id="__span-93-112"><a id="__codelineno-93-112" name="__codelineno-93-112" href="#__codelineno-93-112"></a>        <span class="n">bin_means</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-93-113"><a id="__codelineno-93-113" name="__codelineno-93-113" href="#__codelineno-93-113"></a>        <span class="n">bin_stds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-93-114"><a id="__codelineno-93-114" name="__codelineno-93-114" href="#__codelineno-93-114"></a>        <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-93-115"><a id="__codelineno-93-115" name="__codelineno-93-115" href="#__codelineno-93-115"></a>
</span><span id="__span-93-116"><a id="__codelineno-93-116" name="__codelineno-93-116" href="#__codelineno-93-116"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)):</span>
</span><span id="__span-93-117"><a id="__codelineno-93-117" name="__codelineno-93-117" href="#__codelineno-93-117"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">bin_indices</span> <span class="o">==</span> <span class="n">i</span>
</span><span id="__span-93-118"><a id="__codelineno-93-118" name="__codelineno-93-118" href="#__codelineno-93-118"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-93-119"><a id="__codelineno-93-119" name="__codelineno-93-119" href="#__codelineno-93-119"></a>                <span class="n">bin_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">abs_errors</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
</span><span id="__span-93-120"><a id="__codelineno-93-120" name="__codelineno-93-120" href="#__codelineno-93-120"></a>                <span class="n">bin_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">abs_errors</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
</span><span id="__span-93-121"><a id="__codelineno-93-121" name="__codelineno-93-121" href="#__codelineno-93-121"></a>                <span class="n">bin_centers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-93-122"><a id="__codelineno-93-122" name="__codelineno-93-122" href="#__codelineno-93-122"></a>
</span><span id="__span-93-123"><a id="__codelineno-93-123" name="__codelineno-93-123" href="#__codelineno-93-123"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">bin_means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">bin_stds</span><span class="p">,</span>
</span><span id="__span-93-124"><a id="__codelineno-93-124" name="__codelineno-93-124" href="#__codelineno-93-124"></a>                           <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-93-125"><a id="__codelineno-93-125" name="__codelineno-93-125" href="#__codelineno-93-125"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True Value Range&#39;</span><span class="p">)</span>
</span><span id="__span-93-126"><a id="__codelineno-93-126" name="__codelineno-93-126" href="#__codelineno-93-126"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Absolute Error&#39;</span><span class="p">)</span>
</span><span id="__span-93-127"><a id="__codelineno-93-127" name="__codelineno-93-127" href="#__codelineno-93-127"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Error by Value Range&#39;</span><span class="p">)</span>
</span><span id="__span-93-128"><a id="__codelineno-93-128" name="__codelineno-93-128" href="#__codelineno-93-128"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-93-129"><a id="__codelineno-93-129" name="__codelineno-93-129" href="#__codelineno-93-129"></a>
</span><span id="__span-93-130"><a id="__codelineno-93-130" name="__codelineno-93-130" href="#__codelineno-93-130"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-93-131"><a id="__codelineno-93-131" name="__codelineno-93-131" href="#__codelineno-93-131"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="__span-93-132"><a id="__codelineno-93-132" name="__codelineno-93-132" href="#__codelineno-93-132"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-93-133"><a id="__codelineno-93-133" name="__codelineno-93-133" href="#__codelineno-93-133"></a>
</span><span id="__span-93-134"><a id="__codelineno-93-134" name="__codelineno-93-134" href="#__codelineno-93-134"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluation plots saved to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-135"><a id="__codelineno-93-135" name="__codelineno-93-135" href="#__codelineno-93-135"></a>
</span><span id="__span-93-136"><a id="__codelineno-93-136" name="__codelineno-93-136" href="#__codelineno-93-136"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-93-137"><a id="__codelineno-93-137" name="__codelineno-93-137" href="#__codelineno-93-137"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Print detailed evaluation report&quot;&quot;&quot;</span>
</span><span id="__span-93-138"><a id="__codelineno-93-138" name="__codelineno-93-138" href="#__codelineno-93-138"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_metrics</span><span class="p">()</span>
</span><span id="__span-93-139"><a id="__codelineno-93-139" name="__codelineno-93-139" href="#__codelineno-93-139"></a>
</span><span id="__span-93-140"><a id="__codelineno-93-140" name="__codelineno-93-140" href="#__codelineno-93-140"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-93-141"><a id="__codelineno-93-141" name="__codelineno-93-141" href="#__codelineno-93-141"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REGRESSION EVALUATION REPORT&quot;</span><span class="p">)</span>
</span><span id="__span-93-142"><a id="__codelineno-93-142" name="__codelineno-93-142" href="#__codelineno-93-142"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-93-143"><a id="__codelineno-93-143" name="__codelineno-93-143" href="#__codelineno-93-143"></a>
</span><span id="__span-93-144"><a id="__codelineno-93-144" name="__codelineno-93-144" href="#__codelineno-93-144"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Basic Metrics:&quot;</span><span class="p">)</span>
</span><span id="__span-93-145"><a id="__codelineno-93-145" name="__codelineno-93-145" href="#__codelineno-93-145"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   MSE:  </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;MSE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-146"><a id="__codelineno-93-146" name="__codelineno-93-146" href="#__codelineno-93-146"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   RMSE: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-147"><a id="__codelineno-93-147" name="__codelineno-93-147" href="#__codelineno-93-147"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   MAE:  </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-148"><a id="__codelineno-93-148" name="__codelineno-93-148" href="#__codelineno-93-148"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   R²:   </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-149"><a id="__codelineno-93-149" name="__codelineno-93-149" href="#__codelineno-93-149"></a>
</span><span id="__span-93-150"><a id="__codelineno-93-150" name="__codelineno-93-150" href="#__codelineno-93-150"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Error Statistics:&quot;</span><span class="p">)</span>
</span><span id="__span-93-151"><a id="__codelineno-93-151" name="__codelineno-93-151" href="#__codelineno-93-151"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Max Error:    </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Max_Error&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-152"><a id="__codelineno-93-152" name="__codelineno-93-152" href="#__codelineno-93-152"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mean Residual: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Mean_Residual&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-153"><a id="__codelineno-93-153" name="__codelineno-93-153" href="#__codelineno-93-153"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Std Residual:  </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Std_Residual&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-154"><a id="__codelineno-93-154" name="__codelineno-93-154" href="#__codelineno-93-154"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   MAPE:         </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;MAPE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="__span-93-155"><a id="__codelineno-93-155" name="__codelineno-93-155" href="#__codelineno-93-155"></a>
</span><span id="__span-93-156"><a id="__codelineno-93-156" name="__codelineno-93-156" href="#__codelineno-93-156"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Correlation:&quot;</span><span class="p">)</span>
</span><span id="__span-93-157"><a id="__codelineno-93-157" name="__codelineno-93-157" href="#__codelineno-93-157"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Pearson r:  </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Pearson_r&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (p=</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Pearson_p&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="__span-93-158"><a id="__codelineno-93-158" name="__codelineno-93-158" href="#__codelineno-93-158"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Spearman r: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Spearman_r&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (p=</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Spearman_p&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="__span-93-159"><a id="__codelineno-93-159" name="__codelineno-93-159" href="#__codelineno-93-159"></a>
</span><span id="__span-93-160"><a id="__codelineno-93-160" name="__codelineno-93-160" href="#__codelineno-93-160"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Data Statistics:&quot;</span><span class="p">)</span>
</span><span id="__span-93-161"><a id="__codelineno-93-161" name="__codelineno-93-161" href="#__codelineno-93-161"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   True values:  Mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="__span-93-162"><a id="__codelineno-93-162" name="__codelineno-93-162" href="#__codelineno-93-162"></a>              <span class="sa">f</span><span class="s2">&quot;Std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-163"><a id="__codelineno-93-163" name="__codelineno-93-163" href="#__codelineno-93-163"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Predictions:  Mean=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="__span-93-164"><a id="__codelineno-93-164" name="__codelineno-93-164" href="#__codelineno-93-164"></a>              <span class="sa">f</span><span class="s2">&quot;Std=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-165"><a id="__codelineno-93-165" name="__codelineno-93-165" href="#__codelineno-93-165"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   N samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-166"><a id="__codelineno-93-166" name="__codelineno-93-166" href="#__codelineno-93-166"></a>
</span><span id="__span-93-167"><a id="__codelineno-93-167" name="__codelineno-93-167" href="#__codelineno-93-167"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-93-168"><a id="__codelineno-93-168" name="__codelineno-93-168" href="#__codelineno-93-168"></a>
</span><span id="__span-93-169"><a id="__codelineno-93-169" name="__codelineno-93-169" href="#__codelineno-93-169"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-93-170"><a id="__codelineno-93-170" name="__codelineno-93-170" href="#__codelineno-93-170"></a><span class="c1"># MODEL COMPARISON</span>
</span><span id="__span-93-171"><a id="__codelineno-93-171" name="__codelineno-93-171" href="#__codelineno-93-171"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-93-172"><a id="__codelineno-93-172" name="__codelineno-93-172" href="#__codelineno-93-172"></a>
</span><span id="__span-93-173"><a id="__codelineno-93-173" name="__codelineno-93-173" href="#__codelineno-93-173"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_models</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;RMSE&#39;</span><span class="p">):</span>
</span><span id="__span-93-174"><a id="__codelineno-93-174" name="__codelineno-93-174" href="#__codelineno-93-174"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-93-175"><a id="__codelineno-93-175" name="__codelineno-93-175" href="#__codelineno-93-175"></a><span class="sd">    Compare multiple models</span>
</span><span id="__span-93-176"><a id="__codelineno-93-176" name="__codelineno-93-176" href="#__codelineno-93-176"></a>
</span><span id="__span-93-177"><a id="__codelineno-93-177" name="__codelineno-93-177" href="#__codelineno-93-177"></a><span class="sd">    Args:</span>
</span><span id="__span-93-178"><a id="__codelineno-93-178" name="__codelineno-93-178" href="#__codelineno-93-178"></a><span class="sd">        results_dict: Dict of {model_name: {&#39;y_true&#39;: ..., &#39;y_pred&#39;: ...}}</span>
</span><span id="__span-93-179"><a id="__codelineno-93-179" name="__codelineno-93-179" href="#__codelineno-93-179"></a><span class="sd">        metric: Metric to use for comparison</span>
</span><span id="__span-93-180"><a id="__codelineno-93-180" name="__codelineno-93-180" href="#__codelineno-93-180"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-93-181"><a id="__codelineno-93-181" name="__codelineno-93-181" href="#__codelineno-93-181"></a>    <span class="n">comparison_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-93-182"><a id="__codelineno-93-182" name="__codelineno-93-182" href="#__codelineno-93-182"></a>
</span><span id="__span-93-183"><a id="__codelineno-93-183" name="__codelineno-93-183" href="#__codelineno-93-183"></a>    <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-93-184"><a id="__codelineno-93-184" name="__codelineno-93-184" href="#__codelineno-93-184"></a>        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;y_true&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;y_pred&#39;</span><span class="p">])</span>
</span><span id="__span-93-185"><a id="__codelineno-93-185" name="__codelineno-93-185" href="#__codelineno-93-185"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">compute_metrics</span><span class="p">()</span>
</span><span id="__span-93-186"><a id="__codelineno-93-186" name="__codelineno-93-186" href="#__codelineno-93-186"></a>
</span><span id="__span-93-187"><a id="__codelineno-93-187" name="__codelineno-93-187" href="#__codelineno-93-187"></a>        <span class="n">comparison_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-93-188"><a id="__codelineno-93-188" name="__codelineno-93-188" href="#__codelineno-93-188"></a>            <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
</span><span id="__span-93-189"><a id="__codelineno-93-189" name="__codelineno-93-189" href="#__codelineno-93-189"></a>            <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">],</span>
</span><span id="__span-93-190"><a id="__codelineno-93-190" name="__codelineno-93-190" href="#__codelineno-93-190"></a>            <span class="s1">&#39;MAE&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;MAE&#39;</span><span class="p">],</span>
</span><span id="__span-93-191"><a id="__codelineno-93-191" name="__codelineno-93-191" href="#__codelineno-93-191"></a>            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;R2&#39;</span><span class="p">],</span>
</span><span id="__span-93-192"><a id="__codelineno-93-192" name="__codelineno-93-192" href="#__codelineno-93-192"></a>            <span class="s1">&#39;Pearson_r&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Pearson_r&#39;</span><span class="p">]</span>
</span><span id="__span-93-193"><a id="__codelineno-93-193" name="__codelineno-93-193" href="#__codelineno-93-193"></a>        <span class="p">})</span>
</span><span id="__span-93-194"><a id="__codelineno-93-194" name="__codelineno-93-194" href="#__codelineno-93-194"></a>
</span><span id="__span-93-195"><a id="__codelineno-93-195" name="__codelineno-93-195" href="#__codelineno-93-195"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparison_data</span><span class="p">)</span>
</span><span id="__span-93-196"><a id="__codelineno-93-196" name="__codelineno-93-196" href="#__codelineno-93-196"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span>
</span><span id="__span-93-197"><a id="__codelineno-93-197" name="__codelineno-93-197" href="#__codelineno-93-197"></a>
</span><span id="__span-93-198"><a id="__codelineno-93-198" name="__codelineno-93-198" href="#__codelineno-93-198"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-93-199"><a id="__codelineno-93-199" name="__codelineno-93-199" href="#__codelineno-93-199"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MODEL COMPARISON&quot;</span><span class="p">)</span>
</span><span id="__span-93-200"><a id="__codelineno-93-200" name="__codelineno-93-200" href="#__codelineno-93-200"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
</span><span id="__span-93-201"><a id="__codelineno-93-201" name="__codelineno-93-201" href="#__codelineno-93-201"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span><span id="__span-93-202"><a id="__codelineno-93-202" name="__codelineno-93-202" href="#__codelineno-93-202"></a>
</span><span id="__span-93-203"><a id="__codelineno-93-203" name="__codelineno-93-203" href="#__codelineno-93-203"></a>    <span class="c1"># Plot comparison</span>
</span><span id="__span-93-204"><a id="__codelineno-93-204" name="__codelineno-93-204" href="#__codelineno-93-204"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="__span-93-205"><a id="__codelineno-93-205" name="__codelineno-93-205" href="#__codelineno-93-205"></a>
</span><span id="__span-93-206"><a id="__codelineno-93-206" name="__codelineno-93-206" href="#__codelineno-93-206"></a>    <span class="n">metrics_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span> <span class="s1">&#39;MAE&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">]</span>
</span><span id="__span-93-207"><a id="__codelineno-93-207" name="__codelineno-93-207" href="#__codelineno-93-207"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics_to_plot</span><span class="p">):</span>
</span><span id="__span-93-208"><a id="__codelineno-93-208" name="__codelineno-93-208" href="#__codelineno-93-208"></a>        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>
</span><span id="__span-93-209"><a id="__codelineno-93-209" name="__codelineno-93-209" href="#__codelineno-93-209"></a>        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
</span><span id="__span-93-210"><a id="__codelineno-93-210" name="__codelineno-93-210" href="#__codelineno-93-210"></a>        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</span><span id="__span-93-211"><a id="__codelineno-93-211" name="__codelineno-93-211" href="#__codelineno-93-211"></a>        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1"> Comparison&#39;</span><span class="p">)</span>
</span><span id="__span-93-212"><a id="__codelineno-93-212" name="__codelineno-93-212" href="#__codelineno-93-212"></a>        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
</span><span id="__span-93-213"><a id="__codelineno-93-213" name="__codelineno-93-213" href="#__codelineno-93-213"></a>        <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
</span><span id="__span-93-214"><a id="__codelineno-93-214" name="__codelineno-93-214" href="#__codelineno-93-214"></a>
</span><span id="__span-93-215"><a id="__codelineno-93-215" name="__codelineno-93-215" href="#__codelineno-93-215"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-93-216"><a id="__codelineno-93-216" name="__codelineno-93-216" href="#__codelineno-93-216"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;model_comparison.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</span><span id="__span-93-217"><a id="__codelineno-93-217" name="__codelineno-93-217" href="#__codelineno-93-217"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="__span-93-218"><a id="__codelineno-93-218" name="__codelineno-93-218" href="#__codelineno-93-218"></a>
</span><span id="__span-93-219"><a id="__codelineno-93-219" name="__codelineno-93-219" href="#__codelineno-93-219"></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="__span-93-220"><a id="__codelineno-93-220" name="__codelineno-93-220" href="#__codelineno-93-220"></a>
</span><span id="__span-93-221"><a id="__codelineno-93-221" name="__codelineno-93-221" href="#__codelineno-93-221"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-93-222"><a id="__codelineno-93-222" name="__codelineno-93-222" href="#__codelineno-93-222"></a><span class="c1"># EXAMPLE USAGE</span>
</span><span id="__span-93-223"><a id="__codelineno-93-223" name="__codelineno-93-223" href="#__codelineno-93-223"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-93-224"><a id="__codelineno-93-224" name="__codelineno-93-224" href="#__codelineno-93-224"></a>
</span><span id="__span-93-225"><a id="__codelineno-93-225" name="__codelineno-93-225" href="#__codelineno-93-225"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-93-226"><a id="__codelineno-93-226" name="__codelineno-93-226" href="#__codelineno-93-226"></a>    <span class="c1"># Generate synthetic data</span>
</span><span id="__span-93-227"><a id="__codelineno-93-227" name="__codelineno-93-227" href="#__codelineno-93-227"></a>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-93-228"><a id="__codelineno-93-228" name="__codelineno-93-228" href="#__codelineno-93-228"></a>    <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="__span-93-229"><a id="__codelineno-93-229" name="__codelineno-93-229" href="#__codelineno-93-229"></a>    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="__span-93-230"><a id="__codelineno-93-230" name="__codelineno-93-230" href="#__codelineno-93-230"></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span><span id="__span-93-231"><a id="__codelineno-93-231" name="__codelineno-93-231" href="#__codelineno-93-231"></a>
</span><span id="__span-93-232"><a id="__codelineno-93-232" name="__codelineno-93-232" href="#__codelineno-93-232"></a>    <span class="c1"># Evaluate</span>
</span><span id="__span-93-233"><a id="__codelineno-93-233" name="__codelineno-93-233" href="#__codelineno-93-233"></a>    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
</span><span id="__span-93-234"><a id="__codelineno-93-234" name="__codelineno-93-234" href="#__codelineno-93-234"></a>    <span class="n">evaluator</span><span class="o">.</span><span class="n">print_report</span><span class="p">()</span>
</span><span id="__span-93-235"><a id="__codelineno-93-235" name="__codelineno-93-235" href="#__codelineno-93-235"></a>    <span class="n">evaluator</span><span class="o">.</span><span class="n">plot_results</span><span class="p">()</span>
</span><span id="__span-93-236"><a id="__codelineno-93-236" name="__codelineno-93-236" href="#__codelineno-93-236"></a>
</span><span id="__span-93-237"><a id="__codelineno-93-237" name="__codelineno-93-237" href="#__codelineno-93-237"></a>    <span class="c1"># Compare models</span>
</span><span id="__span-93-238"><a id="__codelineno-93-238" name="__codelineno-93-238" href="#__codelineno-93-238"></a>    <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-93-239"><a id="__codelineno-93-239" name="__codelineno-93-239" href="#__codelineno-93-239"></a>        <span class="s1">&#39;Model A&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;y_true&#39;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">},</span>
</span><span id="__span-93-240"><a id="__codelineno-93-240" name="__codelineno-93-240" href="#__codelineno-93-240"></a>        <span class="s1">&#39;Model B&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;y_true&#39;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_true</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">},</span>
</span><span id="__span-93-241"><a id="__codelineno-93-241" name="__codelineno-93-241" href="#__codelineno-93-241"></a>        <span class="s1">&#39;Model C&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;y_true&#39;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_true</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">},</span>
</span><span id="__span-93-242"><a id="__codelineno-93-242" name="__codelineno-93-242" href="#__codelineno-93-242"></a>    <span class="p">}</span>
</span><span id="__span-93-243"><a id="__codelineno-93-243" name="__codelineno-93-243" href="#__codelineno-93-243"></a>
</span><span id="__span-93-244"><a id="__codelineno-93-244" name="__codelineno-93-244" href="#__codelineno-93-244"></a>    <span class="n">compare_models</span><span class="p">(</span><span class="n">results_dict</span><span class="p">)</span>
</span></code></pre></div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../day1/" class="btn btn-neutral float-left" title="ML for Molecular Systems"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../day3/" class="btn btn-neutral float-right" title="Graph Neural Networks">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../day1/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../day3/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../assets/_markdown_exec_pyodide.js"></script>
      <script src="../search/main.js"></script>
      <script src="../js/open_in_new_tab.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
